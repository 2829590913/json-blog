<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>redisæ•°æ®åº“ | json'blogğŸ¥</title><meta name="keywords" content="æ•°æ®åº“,redis"><meta name="author" content="jsonğŸ¥"><meta name="copyright" content="jsonğŸ¥"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="è¿™æ˜¯ä¸€ç¯‡å…³äºredisæ•°æ®åº“çš„ç¬”è®°">
<meta property="og:type" content="article">
<meta property="og:title" content="redisæ•°æ®åº“">
<meta property="og:url" content="https://www.json25.cn/posts/2636df6a.html">
<meta property="og:site_name" content="json&#39;blogğŸ¥">
<meta property="og:description" content="è¿™æ˜¯ä¸€ç¯‡å…³äºredisæ•°æ®åº“çš„ç¬”è®°">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn-eys.pages.dev/img/dm11.webp">
<meta property="article:published_time" content="2022-03-16T15:26:57.000Z">
<meta property="article:modified_time" content="2023-03-16T16:08:20.752Z">
<meta property="article:author" content="jsonğŸ¥">
<meta property="article:tag" content="æ•°æ®åº“">
<meta property="article:tag" content="redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn-eys.pages.dev/img/dm11.webp"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://www.json25.cn/posts/2636df6a"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'redisæ•°æ®åº“',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-17 00:08:20'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="json'blogğŸ¥" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/favicon.png" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">8</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> å…³äº</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">json'blogğŸ¥</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> å…³äº</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="æ£€ç´¢ç«™å†…ä»»ä½•ä½ æƒ³è¦çš„ä¿¡æ¯"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> æœç´¢</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="ç¾åŒ–è®¾ç½®-è‡ªå®šä¹‰ä½ çš„é£æ ¼" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">redisæ•°æ®åº“</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">å‘è¡¨äº </span><time class="post-meta-date-created" datetime="2022-03-16T15:26:57.000Z" title="å‘è¡¨äº 2022-03-16 23:26:57">2022-03-16</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-03-16T16:08:20.752Z" title="æ›´æ–°äº 2023-03-17 00:08:20">2023-03-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">æ•°æ®åº“</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">7.1w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>234åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="redisæ•°æ®åº“"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>Redis</h1>
<h2 id="NoSQL">NoSQL</h2>
<h3 id="æ¦‚è¿°">æ¦‚è¿°</h3>
<p>NoSQLï¼ˆNot-Only SQLï¼‰ï¼šæ³›æŒ‡éå…³ç³»å‹çš„æ•°æ®åº“ï¼Œä½œä¸ºå…³ç³»å‹æ•°æ®åº“çš„è¡¥å……</p>
<p>MySQL æ”¯æŒ ACID ç‰¹æ€§ï¼Œä¿è¯å¯é æ€§å’ŒæŒä¹…æ€§ï¼Œè¯»å–æ€§èƒ½ä¸é«˜ï¼Œå› æ­¤éœ€è¦ç¼“å­˜çš„æ¥å‡ç¼“æ•°æ®åº“çš„è®¿é—®å‹åŠ›</p>
<p>ä½œç”¨ï¼šåº”å¯¹åŸºäºæµ·é‡ç”¨æˆ·å’Œæµ·é‡æ•°æ®å‰æä¸‹çš„æ•°æ®å¤„ç†é—®é¢˜</p>
<p>ç‰¹å¾ï¼š</p>
<ul>
<li>å¯æ‰©å®¹ï¼Œå¯ä¼¸ç¼©ï¼ŒSQL æ•°æ®å…³ç³»è¿‡äºå¤æ‚ï¼ŒNosql ä¸å­˜å…³ç³»ï¼Œåªå­˜æ•°æ®</li>
<li>å¤§æ•°æ®é‡ä¸‹é«˜æ€§èƒ½ï¼Œæ•°æ®ä¸å­˜å–åœ¨ç£ç›˜ IOï¼Œå­˜å–åœ¨å†…å­˜</li>
<li>çµæ´»çš„æ•°æ®æ¨¡å‹ï¼Œè®¾è®¡äº†ä¸€äº›æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œèƒ½ä¿è¯æ•ˆç‡ä¸Šçš„æé«˜</li>
<li>é«˜å¯ç”¨ï¼Œé›†ç¾¤</li>
</ul>
<p>å¸¸è§çš„ NoSQLï¼šRedisã€memcacheã€HBaseã€MongoDB</p>
<p>å‚è€ƒä¹¦ç±ï¼š<a target="_blank" rel="noopener" href="https://book.douban.com/subject/25900156/">https://book.douban.com/subject/25900156/</a></p>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1CJ411m7Gc">https://www.bilibili.com/video/BV1CJ411m7Gc</a></p>
<hr>
<h3 id="Redis">Redis</h3>
<p>Redis (REmote DIctionary Server) ï¼šç”¨ C è¯­è¨€å¼€å‘çš„ä¸€ä¸ªå¼€æºçš„é«˜æ€§èƒ½é”®å€¼å¯¹ï¼ˆkey-valueï¼‰æ•°æ®åº“</p>
<p>ç‰¹å¾ï¼š</p>
<ul>
<li>æ•°æ®é—´æ²¡æœ‰å¿…ç„¶çš„å…³è”å…³ç³»ï¼Œ<strong>ä¸å­˜å…³ç³»ï¼Œåªå­˜æ•°æ®</strong></li>
<li>æ•°æ®<strong>å­˜å‚¨åœ¨å†…å­˜</strong>ï¼Œå­˜å–é€Ÿåº¦å¿«ï¼Œè§£å†³äº†ç£ç›˜ IO é€Ÿåº¦æ…¢çš„é—®é¢˜</li>
<li>å†…éƒ¨é‡‡ç”¨<strong>å•çº¿ç¨‹</strong>æœºåˆ¶è¿›è¡Œå·¥ä½œ</li>
<li>é«˜æ€§èƒ½ï¼Œå®˜æ–¹æµ‹è¯•æ•°æ®ï¼Œ50 ä¸ªå¹¶å‘æ‰§è¡Œ 100000 ä¸ªè¯·æ±‚ï¼Œè¯»çš„é€Ÿåº¦æ˜¯ 110000 æ¬¡/sï¼Œå†™çš„é€Ÿåº¦æ˜¯ 81000 æ¬¡/s</li>
<li>å¤šæ•°æ®ç±»å‹æ”¯æŒ
<ul>
<li>å­—ç¬¦ä¸²ç±»å‹ï¼šstringï¼ˆStringï¼‰</li>
<li>åˆ—è¡¨ç±»å‹ï¼šlistï¼ˆLinkedListï¼‰</li>
<li>æ•£åˆ—ç±»å‹ï¼šhashï¼ˆHashMapï¼‰</li>
<li>é›†åˆç±»å‹ï¼šsetï¼ˆHashSetï¼‰</li>
<li>æœ‰åºé›†åˆç±»å‹ï¼šzset/sorted_setï¼ˆTreeSetï¼‰</li>
</ul>
</li>
<li>æ”¯æŒæŒä¹…åŒ–ï¼Œå¯ä»¥è¿›è¡Œæ•°æ®ç¾éš¾æ¢å¤</li>
</ul>
<hr>
<h3 id="å®‰è£…å¯åŠ¨">å®‰è£…å¯åŠ¨</h3>
<p>å®‰è£…ï¼š</p>
<ul>
<li>
<p>Redis 5.0 è¢«åŒ…å«åœ¨é»˜è®¤çš„ Ubuntu 20.04 è½¯ä»¶æºä¸­</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install redis-server</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ£€æŸ¥ Redis çŠ¶æ€</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status redis-server</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å¯åŠ¨ï¼š</p>
<ul>
<li>
<p>å¯åŠ¨æœåŠ¡å™¨â€”â€”å‚æ•°å¯åŠ¨</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-server [--port port]</span><br><span class="line"><span class="comment">#redis-server --port 6379</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¯åŠ¨æœåŠ¡å™¨â€”â€”é…ç½®æ–‡ä»¶å¯åŠ¨</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-server config_file_name</span><br><span class="line"><span class="comment">#redis-server /etc/redis/conf/redis-6397.conf</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¯åŠ¨å®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli [-h host] [-p port]</span><br><span class="line"><span class="comment">#redis-cli -h 192.168.2.185 -p 6397</span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šæœåŠ¡å™¨å¯åŠ¨æŒ‡å®šç«¯å£ä½¿ç”¨çš„æ˜¯â€“portï¼Œå®¢æˆ·ç«¯å¯åŠ¨æŒ‡å®šç«¯å£ä½¿ç”¨çš„æ˜¯-p</p>
</li>
</ul>
<hr>
<h3 id="åŸºæœ¬é…ç½®">åŸºæœ¬é…ç½®</h3>
<h4 id="ç³»ç»Ÿç›®å½•">ç³»ç»Ÿç›®å½•</h4>
<ol>
<li>
<p>åˆ›å»ºæ–‡ä»¶ç»“æ„</p>
<p>åˆ›å»ºé…ç½®æ–‡ä»¶å­˜å‚¨ç›®å½•</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> conf</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºæœåŠ¡å™¨æ–‡ä»¶å­˜å‚¨ç›®å½•ï¼ˆåŒ…å«æ—¥å¿—ã€æ•°æ®ã€ä¸´æ—¶é…ç½®æ–‡ä»¶ç­‰ï¼‰</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> data</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>åˆ›å»ºé…ç½®æ–‡ä»¶å‰¯æœ¬æ”¾å…¥ conf ç›®å½•ï¼ŒUbuntu ç³»ç»Ÿé…ç½®æ–‡ä»¶ redis.conf åœ¨ç›®å½• <code>/etc/redis</code> ä¸­</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> redis.conf | grep -v <span class="string">&quot;#&quot;</span> | grep -v <span class="string">&quot;^$&quot;</span> -&gt; /conf/redis-6379.conf</span><br></pre></td></tr></table></figure>
<p>å»é™¤é…ç½®æ–‡ä»¶çš„æ³¨é‡Šå’Œç©ºæ ¼ï¼Œè¾“å‡ºåˆ°æ–°çš„æ–‡ä»¶ï¼Œå‘½ä»¤æ–¹å¼é‡‡ç”¨ redis-port.conf</p>
</li>
</ol>
<hr>
<h4 id="æœåŠ¡å™¨">æœåŠ¡å™¨</h4>
<ul>
<li>
<p>è®¾ç½®æœåŠ¡å™¨ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œå…³é—­åæœåŠ¡å™¨æ§åˆ¶å°ä¸­å°†æ‰“å°æœåŠ¡å™¨è¿è¡Œä¿¡æ¯ï¼ˆåŒæ—¥å¿—å†…å®¹ç›¸åŒï¼‰ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">daemonize <span class="built_in">yes</span>|no</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç»‘å®šä¸»æœºåœ°å€ï¼Œç»‘å®šæœ¬åœ°IPåœ°å€ï¼Œå¦åˆ™SSHæ— æ³•è®¿é—®ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span> ip</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è®¾ç½®æœåŠ¡å™¨ç«¯å£ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">port port</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è®¾ç½®æœåŠ¡å™¨æ–‡ä»¶ä¿å­˜åœ°å€ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span> path</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è®¾ç½®æ•°æ®åº“çš„æ•°é‡ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">databases 16</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¤šæœåŠ¡å™¨å¿«æ·é…ç½®ï¼š</p>
<p>å¯¼å…¥å¹¶åŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶ä¿¡æ¯ï¼Œç”¨äºå¿«é€Ÿåˆ›å»º redis å…¬å…±é…ç½®è¾ƒå¤šçš„ redis å®ä¾‹é…ç½®æ–‡ä»¶ï¼Œä¾¿äºç»´æŠ¤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include /path/conf_name.conf</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="å®¢æˆ·ç«¯">å®¢æˆ·ç«¯</h4>
<ul>
<li>
<p>æœåŠ¡å™¨å…è®¸å®¢æˆ·ç«¯è¿æ¥æœ€å¤§æ•°é‡ï¼Œé»˜è®¤ 0ï¼Œè¡¨ç¤ºæ— é™åˆ¶ï¼Œå½“å®¢æˆ·ç«¯è¿æ¥åˆ°è¾¾ä¸Šé™åï¼ŒRedis ä¼šæ‹’ç»æ–°çš„è¿æ¥ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maxclients count</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å®¢æˆ·ç«¯é—²ç½®ç­‰å¾…æœ€å¤§æ—¶é•¿ï¼Œè¾¾åˆ°æœ€å¤§å€¼åå…³é—­å¯¹åº”è¿æ¥ï¼Œå¦‚éœ€å…³é—­è¯¥åŠŸèƒ½ï¼Œè®¾ç½®ä¸º 0ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">timeout</span> seconds</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="æ—¥å¿—é…ç½®">æ—¥å¿—é…ç½®</h4>
<p>è®¾ç½®æ—¥å¿—è®°å½•</p>
<ul>
<li>
<p>è®¾ç½®æœåŠ¡å™¨ä»¥æŒ‡å®šæ—¥å¿—è®°å½•çº§åˆ«</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loglevel debug|verbose|notice|warning</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ—¥å¿—è®°å½•æ–‡ä»¶å</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logfile filename</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ³¨æ„ï¼šæ—¥å¿—çº§åˆ«å¼€å‘æœŸè®¾ç½®ä¸º verbose å³å¯ï¼Œç”Ÿäº§ç¯å¢ƒä¸­é…ç½®ä¸º noticeï¼Œç®€åŒ–æ—¥å¿—è¾“å‡ºé‡ï¼Œé™ä½å†™æ—¥å¿— IO çš„é¢‘åº¦</p>
<p><strong>é…ç½®æ–‡ä»¶ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span> 192.168.2.185</span><br><span class="line">port 6379</span><br><span class="line"><span class="comment">#timeout 0</span></span><br><span class="line">daemonize no</span><br><span class="line">logfile /etc/redis/data/redis-6379.<span class="built_in">log</span></span><br><span class="line"><span class="built_in">dir</span> /etc/redis/data</span><br><span class="line">dbfilename <span class="string">&quot;dump-6379.rdb&quot;</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="åŸºæœ¬æŒ‡ä»¤">åŸºæœ¬æŒ‡ä»¤</h4>
<p>å¸®åŠ©ä¿¡æ¯ï¼š</p>
<ul>
<li>
<p>è·å–å‘½ä»¤å¸®åŠ©æ–‡æ¡£</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span> [<span class="built_in">command</span>]</span><br><span class="line"><span class="comment">#help set</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è·å–ç»„ä¸­æ‰€æœ‰å‘½ä»¤ä¿¡æ¯åç§°</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span> [@group-name]</span><br><span class="line"><span class="comment">#help @string</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>é€€å‡ºæœåŠ¡</p>
<ul>
<li>
<p>é€€å‡ºå®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">quit</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é€€å‡ºå®¢æˆ·ç«¯æœåŠ¡å™¨å¿«æ·é”®ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ctrl+C</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="æ•°æ®åº“">æ•°æ®åº“</h2>
<h3 id="æœåŠ¡å™¨-2">æœåŠ¡å™¨</h3>
<p>Redis æœåŠ¡å™¨å°†æ‰€æœ‰æ•°æ®åº“ä¿å­˜åœ¨<strong>æœåŠ¡å™¨çŠ¶æ€ redisServer ç»“æ„</strong>çš„ db æ•°ç»„ä¸­ï¼Œæ•°ç»„çš„æ¯ä¸€é¡¹éƒ½æ˜¯ redisDb ç»“æ„ï¼Œä»£è¡¨ä¸€ä¸ªæ•°æ®åº“ï¼Œæ¯ä¸ªæ•°æ®åº“ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œ**å…±ç”¨ **Redis å†…å­˜ï¼Œä¸åŒºåˆ†å¤§å°ã€‚åœ¨åˆå§‹åŒ–æœåŠ¡å™¨æ—¶ï¼Œæ ¹æ® dbnum å±æ€§å†³å®šåˆ›å»ºæ•°æ®åº“çš„æ•°é‡ï¼Œè¯¥å±æ€§ç”±æœåŠ¡å™¨é…ç½®çš„ database é€‰é¡¹å†³å®šï¼Œé»˜è®¤ 16</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="comment">// ä¿å­˜æœåŠ¡å™¨æ‰€æœ‰çš„æ•°æ®åº“</span></span><br><span class="line">    redisDB *db;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨æ•°æ®åº“çš„æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> dbnum;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æœåŠ¡å™¨æ•°æ®åº“.png" style="zoom: 67%;" />
<p><strong>åœ¨æœåŠ¡å™¨å†…éƒ¨</strong>ï¼Œå®¢æˆ·ç«¯çŠ¶æ€ redisClient ç»“æ„çš„ db å±æ€§è®°å½•äº†ç›®æ ‡æ•°æ®åº“ï¼Œæ˜¯ä¸€ä¸ªæŒ‡å‘ redisDb ç»“æ„çš„æŒ‡é’ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisClient</span> &#123;</span></span><br><span class="line">    <span class="comment">// è®°å½•å®¢æˆ·ç«¯æ­£åœ¨ä½¿ç”¨çš„æ•°æ®åº“ï¼ŒæŒ‡å‘ redisServer.db æ•°ç»„ä¸­çš„æŸä¸€ä¸ª db</span></span><br><span class="line">    redisDB *db;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ª Redis å®¢æˆ·ç«¯éƒ½æœ‰ç›®æ ‡æ•°æ®åº“ï¼Œæ‰§è¡Œæ•°æ®åº“è¯»å†™å‘½ä»¤æ—¶ç›®æ ‡æ•°æ®åº“å°±ä¼šæˆä¸ºè¿™äº›å‘½ä»¤çš„æ“ä½œå¯¹è±¡ï¼Œé»˜è®¤æƒ…å†µä¸‹ Redis å®¢æˆ·ç«¯çš„ç›®æ ‡æ•°æ®åº“ä¸º 0 å·æ•°æ®åº“ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ‰§è¡Œ SELECT å‘½ä»¤åˆ‡æ¢ç›®æ ‡æ•°æ®åº“ï¼ŒåŸç†æ˜¯é€šè¿‡ä¿®æ”¹ redisClient.db æŒ‡é’ˆæŒ‡å‘æœåŠ¡å™¨ä¸­ä¸åŒæ•°æ®åº“</p>
<p>å‘½ä»¤æ“ä½œï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select index	<span class="comment">#åˆ‡æ¢æ•°æ®åº“ï¼Œindexä»0-15å–å€¼</span></span><br><span class="line">move key db		<span class="comment">#æ•°æ®ç§»åŠ¨åˆ°æŒ‡å®šæ•°æ®åº“ï¼Œdbæ˜¯æ•°æ®åº“ç¼–å·</span></span><br><span class="line">ping			<span class="comment">#æµ‹è¯•æ•°æ®åº“æ˜¯å¦è¿æ¥æ­£å¸¸ï¼Œè¿”å›PONG</span></span><br><span class="line"><span class="built_in">echo</span> message	<span class="comment">#æ§åˆ¶å°è¾“å‡ºä¿¡æ¯</span></span><br></pre></td></tr></table></figure>
<p>Redis æ²¡æœ‰å¯ä»¥è¿”å›å®¢æˆ·ç«¯ç›®æ ‡æ•°æ®åº“çš„å‘½ä»¤ï¼Œä½†æ˜¯ redis-cli å®¢æˆ·ç«¯æ—è¾¹ä¼šæç¤ºå½“å‰æ‰€ä½¿ç”¨çš„ç›®æ ‡æ•°æ®åº“</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; SELECT 1 </span><br><span class="line">OK </span><br><span class="line">redis[1]&gt;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="é”®ç©ºé—´">é”®ç©ºé—´</h3>
<h4 id="key-space">key space</h4>
<p>Redis æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼ˆkey-value pairï¼‰æ•°æ®åº“æœåŠ¡å™¨ï¼Œæ¯ä¸ªæ•°æ®åº“éƒ½ç”±ä¸€ä¸ª redisDb ç»“æ„è¡¨ç¤ºï¼ŒredisDb.dict <strong>å­—å…¸ä¸­ä¿å­˜äº†æ•°æ®åº“çš„æ‰€æœ‰é”®å€¼å¯¹</strong>ï¼Œå°†è¿™ä¸ªå­—å…¸ç§°ä¸ºé”®ç©ºé—´ï¼ˆkey spaceï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisDB</span> &#123;</span></span><br><span class="line">    <span class="comment">// æ•°æ®åº“é”®ç©ºé—´ï¼Œä¿å­˜æ‰€æœ‰é”®å€¼å¯¹</span></span><br><span class="line">    dict *dict</span><br><span class="line">&#125; redisDB;</span><br></pre></td></tr></table></figure>
<p>é”®ç©ºé—´å’Œç”¨æˆ·æ‰€è§çš„æ•°æ®åº“æ˜¯ç›´æ¥å¯¹åº”çš„ï¼š</p>
<ul>
<li>é”®ç©ºé—´çš„é”®å°±æ˜¯æ•°æ®åº“çš„é”®ï¼Œæ¯ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡</li>
<li>é”®ç©ºé—´çš„å€¼å°±æ˜¯æ•°æ®åº“çš„å€¼ï¼Œæ¯ä¸ªå€¼å¯ä»¥æ˜¯ä»»æ„ä¸€ç§ Redis å¯¹è±¡</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E6%95%B0%E6%8D%AE%E5%BA%93%E9%94%AE%E7%A9%BA%E9%97%B4.png" alt=""></p>
<p>å½“ä½¿ç”¨ Redis å‘½ä»¤å¯¹æ•°æ®åº“è¿›è¡Œè¯»å†™æ—¶ï¼ŒæœåŠ¡å™¨ä¸ä»…ä¼šå¯¹é”®ç©ºé—´æ‰§è¡ŒæŒ‡å®šçš„è¯»å†™æ“ä½œï¼Œè¿˜ä¼š<strong>è¿›è¡Œä¸€äº›ç»´æŠ¤æ“ä½œ</strong>ï¼š</p>
<ul>
<li>åœ¨è¯»å–ä¸€ä¸ªé”®åï¼ˆè¯»æ“ä½œå’Œå†™æ“ä½œéƒ½è¦å¯¹é”®è¿›è¡Œè¯»å–ï¼‰ï¼ŒæœåŠ¡å™¨ä¼šæ ¹æ®é”®æ˜¯å¦å­˜åœ¨æ¥æ›´æ–°æœåŠ¡å™¨çš„é”®ç©ºé—´å‘½ä¸­ hit æ¬¡æ•°æˆ–é”®ç©ºé—´ä¸å‘½ä¸­ miss æ¬¡æ•°ï¼Œè¿™ä¸¤ä¸ªå€¼å¯ä»¥åœ¨ <code>INFO stats</code> å‘½ä»¤çš„ keyspace_hits å±æ€§å’Œ keyspace_misses å±æ€§ä¸­æŸ¥çœ‹</li>
<li>æ›´æ–°é”®çš„ LRUï¼ˆæœ€åä½¿ç”¨ï¼‰æ—¶é—´ï¼Œè¯¥å€¼å¯ä»¥ç”¨äºè®¡ç®—é”®çš„é—²ç½®æ—¶é—´ï¼Œä½¿ç”¨ <code>OBJECT idletime key</code> æŸ¥çœ‹é”® key çš„é—²ç½®æ—¶é—´</li>
<li>å¦‚æœåœ¨è¯»å–ä¸€ä¸ªé”®æ—¶å‘ç°è¯¥é”®å·²ç»è¿‡æœŸï¼ŒæœåŠ¡å™¨ä¼š<strong>å…ˆåˆ é™¤è¿‡æœŸé”®</strong>ï¼Œå†æ‰§è¡Œå…¶ä»–æ“ä½œ</li>
<li>å¦‚æœå®¢æˆ·ç«¯ä½¿ç”¨ WATCH å‘½ä»¤ç›‘è§†äº†æŸä¸ªé”®ï¼Œé‚£ä¹ˆæœåŠ¡å™¨åœ¨å¯¹è¢«ç›‘è§†çš„é”®è¿›è¡Œä¿®æ”¹ä¹‹åï¼Œä¼šå°†è¿™ä¸ªé”®æ ‡è®°ä¸ºè„ï¼ˆdirtyï¼‰ï¼Œä»è€Œè®©äº‹åŠ¡æ³¨æ„åˆ°è¿™ä¸ªé”®å·²ç»è¢«ä¿®æ”¹è¿‡</li>
<li>æœåŠ¡å™¨æ¯æ¬¡ä¿®æ”¹ä¸€ä¸ªé”®ä¹‹åï¼Œéƒ½ä¼šå¯¹ dirty é”®è®¡æ•°å™¨çš„å€¼å¢1ï¼Œè¯¥è®¡æ•°å™¨ä¼šè§¦å‘æœåŠ¡å™¨çš„æŒä¹…åŒ–ä»¥åŠå¤åˆ¶æ“ä½œ</li>
<li>å¦‚æœæœåŠ¡å™¨å¼€å¯äº†æ•°æ®åº“é€šçŸ¥åŠŸèƒ½ï¼Œé‚£ä¹ˆåœ¨å¯¹é”®è¿›è¡Œä¿®æ”¹ä¹‹åï¼ŒæœåŠ¡å™¨å°†æŒ‰é…ç½®å‘é€ç›¸åº”çš„æ•°æ®åº“é€šçŸ¥</li>
</ul>
<hr>
<h4 id="è¯»å†™æŒ‡ä»¤">è¯»å†™æŒ‡ä»¤</h4>
<p>å¸¸è§é”®æ“ä½œæŒ‡ä»¤ï¼š</p>
<ul>
<li>
<p>å¢åŠ æŒ‡ä»¤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> key value				<span class="comment">#æ·»åŠ ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„é”®å€¼å¯¹</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>åˆ é™¤æŒ‡ä»¤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">del key						<span class="comment">#åˆ é™¤æŒ‡å®škey</span></span><br><span class="line"><span class="built_in">unlink</span> key   				<span class="comment">#éé˜»å¡åˆ é™¤keyï¼ŒçœŸæ­£çš„åˆ é™¤ä¼šåœ¨åç»­å¼‚æ­¥æ“ä½œ</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ›´æ–°æŒ‡ä»¤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rename key newkey			<span class="comment">#æ”¹å</span></span><br><span class="line">renamenx key newkey			<span class="comment">#æ”¹å</span></span><br></pre></td></tr></table></figure>
<p>å€¼å¾—æ›´æ–°éœ€è¦å‚çœ‹å…·ä½“å¾— Redis å¯¹è±¡å¾—æ“ä½œæ–¹å¼ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²å¯¹è±¡æ‰§è¡Œ <code>SET key value</code> å°±å¯ä»¥å®Œæˆä¿®æ”¹</p>
</li>
<li>
<p>æŸ¥è¯¢æŒ‡ä»¤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exists key					<span class="comment">#è·å–keyæ˜¯å¦å­˜åœ¨</span></span><br><span class="line">randomkey					<span class="comment">#éšæœºè¿”å›ä¸€ä¸ªé”®</span></span><br><span class="line">keys pattern				<span class="comment">#æŸ¥è¯¢key</span></span><br></pre></td></tr></table></figure>
<p>KEYS å‘½ä»¤éœ€è¦<strong>éå†å­˜å‚¨çš„é”®å€¼å¯¹</strong>ï¼Œæ“ä½œå»¶æ—¶é«˜ï¼Œä¸€èˆ¬ä¸è¢«å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­</p>
<p>æŸ¥è¯¢æ¨¡å¼è§„åˆ™ï¼š* åŒ¹é…ä»»æ„æ•°é‡çš„ä»»æ„ç¬¦å·ã€? é…åˆä¸€ä¸ªä»»æ„ç¬¦å·ã€[] åŒ¹é…ä¸€ä¸ªæŒ‡å®šç¬¦å·</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">keys *						<span class="comment">#æŸ¥è¯¢æ‰€æœ‰key</span></span><br><span class="line">keys aa*					<span class="comment">#æŸ¥è¯¢æ‰€æœ‰ä»¥aaå¼€å¤´</span></span><br><span class="line">keys *bb					<span class="comment">#æŸ¥è¯¢æ‰€æœ‰ä»¥bbç»“å°¾</span></span><br><span class="line">keys ??cc					<span class="comment">#æŸ¥è¯¢æ‰€æœ‰å‰é¢ä¸¤ä¸ªå­—ç¬¦ä»»æ„ï¼Œåé¢ä»¥ccç»“å°¾ </span></span><br><span class="line">keys user:?					<span class="comment">#æŸ¥è¯¢æ‰€æœ‰ä»¥user:å¼€å¤´ï¼Œæœ€åä¸€ä¸ªå­—ç¬¦ä»»æ„</span></span><br><span class="line">keys u[st]er:1				<span class="comment">#æŸ¥è¯¢æ‰€æœ‰ä»¥uå¼€å¤´ï¼Œä»¥er:1ç»“å°¾ï¼Œä¸­é—´åŒ…å«ä¸€ä¸ªå­—æ¯ï¼Œsæˆ–t</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å…¶ä»–æŒ‡ä»¤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> key					<span class="comment">#è·å–keyçš„ç±»å‹</span></span><br><span class="line">dbsize						<span class="comment">#è·å–å½“å‰æ•°æ®åº“çš„æ•°æ®æ€»é‡ï¼Œå³keyçš„ä¸ªæ•°</span></span><br><span class="line">flushdb						<span class="comment">#æ¸…é™¤å½“å‰æ•°æ®åº“çš„æ‰€æœ‰æ•°æ®(æ…ç”¨)</span></span><br><span class="line">flushall					<span class="comment">#æ¸…é™¤æ‰€æœ‰æ•°æ®(æ…ç”¨)</span></span><br></pre></td></tr></table></figure>
<p>åœ¨æ‰§è¡Œ FLUSHDB è¿™æ ·çš„å±é™©å‘½ä»¤ä¹‹å‰ï¼Œæœ€å¥½å…ˆæ‰§è¡Œä¸€ä¸ª SELECT å‘½ä»¤ï¼Œä¿è¯å½“å‰æ‰€æ“ä½œçš„æ•°æ®åº“æ˜¯ç›®æ ‡æ•°æ®åº“</p>
</li>
</ul>
<hr>
<h4 id="æ—¶æ•ˆè®¾ç½®">æ—¶æ•ˆè®¾ç½®</h4>
<p>å®¢æˆ·ç«¯å¯ä»¥ä»¥ç§’æˆ–æ¯«ç§’çš„ç²¾åº¦ä¸ºæ•°æ®åº“ä¸­çš„æŸä¸ªé”®è®¾ç½®ç”Ÿå­˜æ—¶é—´ï¼ˆTimeTo Live, TTLï¼‰ï¼Œåœ¨ç»è¿‡æŒ‡å®šæ—¶é—´ä¹‹åï¼ŒæœåŠ¡å™¨å°±ä¼šè‡ªåŠ¨åˆ é™¤ç”Ÿå­˜æ—¶é—´ä¸º 0 çš„é”®ï¼›ä¹Ÿå¯ä»¥ä»¥ UNIX æ—¶é—´æˆ³çš„æ–¹å¼è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆexpire timeï¼‰ï¼Œå½“é”®çš„è¿‡æœŸæ—¶é—´åˆ°è¾¾ï¼ŒæœåŠ¡å™¨ä¼šè‡ªåŠ¨åˆ é™¤è¿™ä¸ªé”®</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">expire key seconds			<span class="comment">#ä¸ºæŒ‡å®škeyè®¾ç½®ç”Ÿå­˜æ—¶é—´ï¼Œå•ä½ä¸ºç§’</span></span><br><span class="line">pexpire key milliseconds	<span class="comment">#ä¸ºæŒ‡å®škeyè®¾ç½®ç”Ÿå­˜æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’</span></span><br><span class="line">expireat key timestamp		<span class="comment">#ä¸ºæŒ‡å®škeyè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºæ—¶é—´æˆ³</span></span><br><span class="line">pexpireat key mil-timestamp	<span class="comment">#ä¸ºæŒ‡å®škeyè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’æ—¶é—´æˆ³</span></span><br></pre></td></tr></table></figure>
<ul>
<li>å®é™…ä¸Š EXPIREã€EXPIREã€EXPIREAT ä¸‰ä¸ªå‘½ä»¤<strong>åº•å±‚éƒ½æ˜¯è½¬æ¢ä¸º PEXPIREAT å‘½ä»¤</strong>æ¥å®ç°çš„</li>
<li>SETEX å‘½ä»¤å¯ä»¥åœ¨è®¾ç½®ä¸€ä¸ªå­—ç¬¦ä¸²é”®çš„åŒæ—¶ä¸ºé”®è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä½†æ˜¯è¯¥å‘½ä»¤æ˜¯ä¸€ä¸ªç±»å‹é™å®šå‘½ä»¤</li>
</ul>
<p>redisDb ç»“æ„çš„ expires å­—å…¸ä¿å­˜äº†æ•°æ®åº“ä¸­æ‰€æœ‰é”®çš„è¿‡æœŸæ—¶é—´ï¼Œå­—å…¸ç§°ä¸ºè¿‡æœŸå­—å…¸ï¼š</p>
<ul>
<li>é”®æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘é”®ç©ºé—´ä¸­çš„æŸä¸ªé”®å¯¹è±¡ï¼ˆå¤ç”¨é”®ç©ºé—´çš„å¯¹è±¡ï¼Œä¸ä¼šäº§ç”Ÿå†…å­˜æµªè´¹ï¼‰</li>
<li>å€¼æ˜¯ä¸€ä¸ª long long ç±»å‹çš„æ•´æ•°ï¼Œä¿å­˜äº†é”®çš„è¿‡æœŸæ—¶é—´ï¼Œæ˜¯ä¸€ä¸ªæ¯«ç§’ç²¾åº¦çš„ UNIX æ—¶é—´æˆ³</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisDB</span> &#123;</span></span><br><span class="line">    <span class="comment">// è¿‡æœŸå­—å…¸ï¼Œä¿å­˜æ‰€æœ‰é”®çš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    dict *expires</span><br><span class="line">&#125; redisDB;</span><br></pre></td></tr></table></figure>
<p>å®¢æˆ·ç«¯æ‰§è¡Œ PEXPIREAT å‘½ä»¤ï¼ŒæœåŠ¡å™¨ä¼šåœ¨æ•°æ®åº“çš„è¿‡æœŸå­—å…¸ä¸­å…³è”ç»™å®šçš„æ•°æ®åº“é”®å’Œè¿‡æœŸæ—¶é—´ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">PEXPIREAT</span>(<span class="params">key, expire_time_in_ms</span>):</span><br><span class="line">	<span class="comment"># å¦‚æœç»™å®šçš„é”®ä¸å­˜åœ¨äºé”®ç©ºé—´ï¼Œé‚£ä¹ˆä¸èƒ½è®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br><span class="line">	<span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> redisDb.<span class="built_in">dict</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">		</span><br><span class="line">	<span class="comment"># åœ¨è¿‡æœŸå­—å…¸ä¸­å…³è”é”®å’Œè¿‡æœŸæ—¶é—´</span></span><br><span class="line">	redisDB.expires[key] = expire_time_in_ms</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># è¿‡æœŸæ—¶é—´è®¾ç½®æˆåŠŸ</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="æ—¶æ•ˆçŠ¶æ€">æ—¶æ•ˆçŠ¶æ€</h4>
<p>TTL å’Œ PTTL å‘½ä»¤é€šè¿‡è®¡ç®—é”®çš„è¿‡æœŸæ—¶é—´å’Œå½“å‰æ—¶é—´ä¹‹é—´çš„å·®ï¼Œè¿”å›è¿™ä¸ªé”®çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´</p>
<ul>
<li>è¿”å›æ­£æ•°ä»£è¡¨è¯¥æ•°æ®åœ¨å†…å­˜ä¸­è¿˜èƒ½å­˜æ´»çš„æ—¶é—´</li>
<li>è¿”å› -1 ä»£è¡¨æ°¸ä¹…æ€§ï¼Œè¿”å› -2 ä»£è¡¨é”®ä¸å­˜åœ¨</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ttl key			<span class="comment">#è·å–keyçš„å‰©ä½™æ—¶é—´ï¼Œæ¯æ¬¡è·å–ä¼šè‡ªåŠ¨å˜åŒ–(å‡å°)ï¼Œç±»ä¼¼äºå€’è®¡æ—¶</span></span><br><span class="line">pttl key		<span class="comment">#è·å–keyçš„å‰©ä½™æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œæ¯æ¬¡è·å–ä¼šè‡ªåŠ¨å˜åŒ–(å‡å°)</span></span><br></pre></td></tr></table></figure>
<p>PERSIST æ˜¯ PEXPIREAT å‘½ä»¤çš„åæ“ä½œï¼Œåœ¨è¿‡æœŸå­—å…¸ä¸­æŸ¥æ‰¾ç»™å®šçš„é”®ï¼Œå¹¶è§£é™¤é”®å’Œå€¼ï¼ˆè¿‡æœŸæ—¶é—´ï¼‰åœ¨è¿‡æœŸå­—å…¸ä¸­çš„å…³è”</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">persist key		<span class="comment">#åˆ‡æ¢keyä»æ—¶æ•ˆæ€§è½¬æ¢ä¸ºæ°¸ä¹…æ€§</span></span><br></pre></td></tr></table></figure>
<p>Redis é€šè¿‡è¿‡æœŸå­—å…¸å¯ä»¥æ£€æŸ¥ä¸€ä¸ªç»™å®šé”®æ˜¯å¦è¿‡æœŸï¼š</p>
<ul>
<li>æ£€æŸ¥ç»™å®šé”®æ˜¯å¦å­˜åœ¨äºè¿‡æœŸå­—å…¸ï¼šå¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆå–å¾—é”®çš„è¿‡æœŸæ—¶é—´</li>
<li>æ£€æŸ¥å½“å‰ UNIX æ—¶é—´æˆ³æ˜¯å¦å¤§äºé”®çš„è¿‡æœŸæ—¶é—´ï¼šå¦‚æœæ˜¯é‚£ä¹ˆé”®å·²ç»è¿‡æœŸï¼Œå¦åˆ™é”®æœªè¿‡æœŸ</li>
</ul>
<p>è¡¥å……ï¼šAOFã€RDB å’Œå¤åˆ¶åŠŸèƒ½å¯¹è¿‡æœŸé”®çš„å¤„ç†</p>
<ul>
<li>RDB ï¼š
<ul>
<li>ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œç¨‹åºä¼šå¯¹æ•°æ®åº“ä¸­çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œå·²è¿‡æœŸçš„é”®ä¸ä¼šè¢«ä¿å­˜åˆ°æ–°åˆ›å»ºçš„ RDB æ–‡ä»¶ä¸­</li>
<li>è½½å…¥ RDB æ–‡ä»¶ï¼Œå¦‚æœæœåŠ¡å™¨ä»¥ä¸»æœåŠ¡å™¨æ¨¡å¼è¿è¡Œï¼Œé‚£ä¹ˆåœ¨è½½å…¥æ—¶ä¼šå¯¹é”®è¿›è¡Œæ£€æŸ¥ï¼Œè¿‡æœŸé”®ä¼šè¢«å¿½ç•¥ï¼›å¦‚æœæœåŠ¡å™¨ä»¥ä»æœåŠ¡å™¨æ¨¡å¼è¿è¡Œï¼Œä¼šè½½å…¥æ‰€æœ‰é”®ï¼ŒåŒ…æ‹¬è¿‡æœŸé”®ï¼Œä½†æ˜¯ä¸»ä»æœåŠ¡å™¨è¿›è¡Œæ•°æ®åŒæ­¥æ—¶å°±ä¼šåˆ é™¤è¿™äº›é”®</li>
</ul>
</li>
<li>AOFï¼š
<ul>
<li>å†™å…¥ AOF æ–‡ä»¶ï¼Œå¦‚æœæ•°æ®åº“ä¸­çš„æŸä¸ªé”®å·²ç»è¿‡æœŸï¼Œä½†è¿˜æ²¡æœ‰è¢«åˆ é™¤ï¼Œé‚£ä¹ˆ AOF æ–‡ä»¶ä¸ä¼šå› ä¸ºè¿™ä¸ªè¿‡æœŸé”®è€Œäº§ç”Ÿä»»ä½•å½±å“ï¼›å½“è¯¥è¿‡æœŸé”®è¢«åˆ é™¤ï¼Œç¨‹åºä¼šå‘ AOF æ–‡ä»¶è¿½åŠ ä¸€æ¡ DEL å‘½ä»¤ï¼Œæ˜¾å¼çš„åˆ é™¤è¯¥é”®</li>
<li>AOF é‡å†™ï¼Œä¼šå¯¹æ•°æ®åº“ä¸­çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œå¿½ç•¥å·²ç»è¿‡æœŸçš„é”®</li>
</ul>
</li>
<li>å¤åˆ¶ï¼šå½“æœåŠ¡å™¨è¿è¡Œåœ¨å¤åˆ¶æ¨¡å¼ä¸‹æ—¶ï¼Œä»æœåŠ¡å™¨çš„è¿‡æœŸé”®åˆ é™¤åŠ¨ä½œç”±ä¸»æœåŠ¡å™¨æ§åˆ¶
<ul>
<li>ä¸»æœåŠ¡å™¨åœ¨åˆ é™¤ä¸€ä¸ªè¿‡æœŸé”®ä¹‹åï¼Œä¼šæ˜¾å¼åœ°å‘æ‰€æœ‰ä»æœåŠ¡å™¨å‘é€ä¸€ä¸ª DEL å‘½ä»¤ï¼Œå‘ŠçŸ¥ä»æœåŠ¡å™¨åˆ é™¤è¿™ä¸ªè¿‡æœŸé”®</li>
<li>ä»æœåŠ¡å™¨åœ¨æ‰§è¡Œå®¢æˆ·ç«¯å‘é€çš„è¯»å‘½ä»¤æ—¶ï¼Œå³ä½¿ç¢°åˆ°è¿‡æœŸé”®ä¹Ÿä¸ä¼šå°†è¿‡æœŸé”®åˆ é™¤ï¼Œä¼šå½“ä½œæœªè¿‡æœŸé”®å¤„ç†ï¼Œåªæœ‰åœ¨æ¥åˆ°ä¸»æœåŠ¡å™¨å‘æ¥çš„ DEL å‘½ä»¤ä¹‹åï¼Œæ‰ä¼šåˆ é™¤è¿‡æœŸé”®ï¼ˆæ•°æ®ä¸ä¸€è‡´ï¼‰</li>
</ul>
</li>
</ul>
<hr>
<h3 id="è¿‡æœŸåˆ é™¤">è¿‡æœŸåˆ é™¤</h3>
<h4 id="åˆ é™¤ç­–ç•¥">åˆ é™¤ç­–ç•¥</h4>
<p>åˆ é™¤ç­–ç•¥å°±æ˜¯<strong>é’ˆå¯¹å·²è¿‡æœŸæ•°æ®çš„å¤„ç†ç­–ç•¥</strong>ï¼Œå·²è¿‡æœŸçš„æ•°æ®ä¸ä¸€å®šè¢«ç«‹å³åˆ é™¤ï¼Œåœ¨ä¸åŒçš„åœºæ™¯ä¸‹ä½¿ç”¨ä¸åŒçš„åˆ é™¤æ–¹å¼ä¼šæœ‰ä¸åŒæ•ˆæœï¼Œåœ¨å†…å­˜å ç”¨ä¸ CPU å ç”¨ä¹‹é—´å¯»æ‰¾ä¸€ç§å¹³è¡¡ï¼Œé¡¾æ­¤å¤±å½¼éƒ½ä¼šé€ æˆæ•´ä½“ Redis æ€§èƒ½çš„ä¸‹é™ï¼Œç”šè‡³å¼•å‘æœåŠ¡å™¨å®•æœºæˆ–å†…å­˜æ³„éœ²</p>
<p>é’ˆå¯¹è¿‡æœŸæ•°æ®æœ‰ä¸‰ç§åˆ é™¤ç­–ç•¥ï¼š</p>
<ul>
<li>å®šæ—¶åˆ é™¤</li>
<li>æƒ°æ€§åˆ é™¤ï¼ˆè¢«åŠ¨åˆ é™¤ï¼‰</li>
<li>å®šæœŸåˆ é™¤</li>
</ul>
<p>Redis é‡‡ç”¨æƒ°æ€§åˆ é™¤å’Œå®šæœŸåˆ é™¤ç­–ç•¥çš„ç»“åˆä½¿ç”¨</p>
<hr>
<h4 id="å®šæ—¶åˆ é™¤">å®šæ—¶åˆ é™¤</h4>
<p>åœ¨è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´çš„åŒæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼ˆtimerï¼‰ï¼Œè®©å®šæ—¶å™¨åœ¨é”®çš„è¿‡æœŸæ—¶é—´åˆ°è¾¾æ—¶ï¼Œç«‹å³æ‰§è¡Œå¯¹é”®çš„åˆ é™¤æ“ä½œ</p>
<ul>
<li>ä¼˜ç‚¹ï¼šèŠ‚çº¦å†…å­˜ï¼Œåˆ°æ—¶å°±åˆ é™¤ï¼Œå¿«é€Ÿé‡Šæ”¾æ‰ä¸å¿…è¦çš„å†…å­˜å ç”¨</li>
<li>ç¼ºç‚¹ï¼šå¯¹ CPU ä¸å‹å¥½ï¼Œæ— è®º CPU æ­¤æ—¶è´Ÿè½½å¤šé«˜å‡å ç”¨ CPUï¼Œä¼šå½±å“ Redis æœåŠ¡å™¨å“åº”æ—¶é—´å’ŒæŒ‡ä»¤ååé‡</li>
<li>æ€»ç»“ï¼šç”¨å¤„ç†å™¨æ€§èƒ½æ¢å–å­˜å‚¨ç©ºé—´ï¼ˆæ‹¿æ—¶é—´æ¢ç©ºé—´ï¼‰</li>
</ul>
<p>åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨éœ€è¦ç”¨åˆ° Redis æœåŠ¡å™¨ä¸­çš„æ—¶é—´äº‹ä»¶ï¼Œè€Œæ—¶é—´äº‹ä»¶çš„å®ç°æ–¹å¼æ˜¯æ— åºé“¾è¡¨ï¼ŒæŸ¥æ‰¾ä¸€ä¸ªäº‹ä»¶çš„æ—¶é—´å¤æ‚åº¦ä¸º O(N)ï¼Œå¹¶ä¸èƒ½é«˜æ•ˆåœ°å¤„ç†å¤§é‡æ—¶é—´äº‹ä»¶ï¼Œæ‰€ä»¥é‡‡ç”¨è¿™ç§æ–¹å¼å¹¶ä¸ç°å®</p>
<hr>
<h4 id="æƒ°æ€§åˆ é™¤">æƒ°æ€§åˆ é™¤</h4>
<p>æ•°æ®åˆ°è¾¾è¿‡æœŸæ—¶é—´ä¸åšå¤„ç†ï¼Œç­‰ä¸‹æ¬¡è®¿é—®åˆ°è¯¥æ•°æ®æ—¶æ‰§è¡Œ <strong>expireIfNeeded()</strong> åˆ¤æ–­ï¼š</p>
<ul>
<li>å¦‚æœè¾“å…¥é”®å·²ç»è¿‡æœŸï¼Œé‚£ä¹ˆ expireIfNeeded å‡½æ•°å°†è¾“å…¥é”®ä»æ•°æ®åº“ä¸­åˆ é™¤ï¼Œæ¥ç€è®¿é—®å°±ä¼šè¿”å›ç©º</li>
<li>å¦‚æœè¾“å…¥é”®æœªè¿‡æœŸï¼Œé‚£ä¹ˆ expireIfNeeded å‡½æ•°ä¸åšåŠ¨ä½œ</li>
</ul>
<p>æ‰€æœ‰çš„ Redis è¯»å†™å‘½ä»¤åœ¨æ‰§è¡Œå‰éƒ½ä¼šè°ƒç”¨ expireIfNeeded å‡½æ•°è¿›è¡Œæ£€æŸ¥ï¼Œè¯¥å‡½æ•°å°±åƒä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œåœ¨å‘½ä»¤çœŸæ­£æ‰§è¡Œä¹‹å‰è¿‡æ»¤æ‰è¿‡æœŸé”®</p>
<p>æƒ°æ€§åˆ é™¤çš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ä¼˜ç‚¹ï¼šèŠ‚çº¦ CPU æ€§èƒ½ï¼Œåˆ é™¤çš„ç›®æ ‡ä»…é™äºå½“å‰å¤„ç†çš„é”®ï¼Œä¸ä¼šåœ¨åˆ é™¤å…¶ä»–æ— å…³çš„è¿‡æœŸé”®ä¸ŠèŠ±è´¹ä»»ä½• CPU æ—¶é—´</li>
<li>ç¼ºç‚¹ï¼šå†…å­˜å‹åŠ›å¾ˆå¤§ï¼Œå‡ºç°é•¿æœŸå ç”¨å†…å­˜çš„æ•°æ®ï¼Œå¦‚æœè¿‡æœŸé”®æ°¸è¿œä¸è¢«è®¿é—®ï¼Œè¿™ç§æƒ…å†µç›¸å½“äºå†…å­˜æ³„æ¼</li>
<li>æ€»ç»“ï¼šç”¨å­˜å‚¨ç©ºé—´æ¢å–å¤„ç†å™¨æ€§èƒ½ï¼ˆæ‹¿ç©ºé—´æ¢æ—¶é—´ï¼‰</li>
</ul>
<hr>
<h4 id="å®šæœŸåˆ é™¤">å®šæœŸåˆ é™¤</h4>
<p>å®šæœŸåˆ é™¤ç­–ç•¥æ˜¯æ¯éš”ä¸€æ®µæ—¶é—´æ‰§è¡Œä¸€æ¬¡åˆ é™¤è¿‡æœŸé”®æ“ä½œï¼Œå¹¶é€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡æ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹ CPU æ—¶é—´çš„å½±å“</p>
<ul>
<li>å¦‚æœåˆ é™¤æ“ä½œæ‰§è¡Œå¾—å¤ªé¢‘ç¹ï¼Œæˆ–è€…æ‰§è¡Œæ—¶é—´å¤ªé•¿ï¼Œå°±ä¼šé€€åŒ–æˆå®šæ—¶åˆ é™¤ç­–ç•¥ï¼Œå°† CPU æ—¶é—´è¿‡å¤šåœ°æ¶ˆè€—åœ¨åˆ é™¤è¿‡æœŸé”®ä¸Š</li>
<li>å¦‚æœåˆ é™¤æ“ä½œæ‰§è¡Œå¾—å¤ªå°‘ï¼Œæˆ–è€…æ‰§è¡Œæ—¶é—´å¤ªçŸ­ï¼Œå®šæœŸåˆ é™¤ç­–ç•¥åˆä¼šå’Œæƒ°æ€§åˆ é™¤ç­–ç•¥ä¸€æ ·ï¼Œå‡ºç°æµªè´¹å†…å­˜çš„æƒ…å†µ</li>
</ul>
<p>å®šæœŸåˆ é™¤æ˜¯<strong>å‘¨æœŸæ€§è½®è¯¢ Redis åº“ä¸­çš„æ—¶æ•ˆæ€§</strong>æ•°æ®ï¼Œä»è¿‡æœŸå­—å…¸ä¸­éšæœºæŠ½å–ä¸€éƒ¨åˆ†é”®æ£€æŸ¥ï¼Œåˆ©ç”¨è¿‡æœŸæ•°æ®å æ¯”çš„æ–¹å¼æ§åˆ¶åˆ é™¤é¢‘åº¦</p>
<ul>
<li>
<p>Redis å¯åŠ¨æœåŠ¡å™¨åˆå§‹åŒ–æ—¶ï¼Œè¯»å–é…ç½® server.hz çš„å€¼ï¼Œé»˜è®¤ä¸º 10ï¼Œæ‰§è¡ŒæŒ‡ä»¤ info server å¯ä»¥æŸ¥çœ‹ï¼Œæ¯ç§’é’Ÿæ‰§è¡Œ server.hz æ¬¡ <code>serverCron() â†’ activeExpireCycle()</code></p>
</li>
<li>
<p>activeExpireCycle() å¯¹æŸä¸ªæ•°æ®åº“ä¸­çš„æ¯ä¸ª expires è¿›è¡Œæ£€æµ‹ï¼Œå·¥ä½œæ¨¡å¼ï¼š</p>
<ul>
<li>
<p>è½®è¯¢æ¯ä¸ªæ•°æ®åº“ï¼Œä»æ•°æ®åº“ä¸­å–å‡ºä¸€å®šæ•°é‡çš„éšæœºé”®è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶åˆ é™¤å…¶ä¸­çš„è¿‡æœŸé”®ï¼Œå¦‚æœè¿‡æœŸ key çš„æ¯”ä¾‹è¶…è¿‡äº† 25%ï¼Œåˆ™ç»§ç»­é‡å¤æ­¤è¿‡ç¨‹ï¼Œç›´åˆ°è¿‡æœŸ key çš„æ¯”ä¾‹ä¸‹é™åˆ° 25% ä»¥ä¸‹ï¼Œæˆ–è€…è¿™æ¬¡ä»»åŠ¡çš„æ‰§è¡Œè€—æ—¶è¶…è¿‡äº† 25 æ¯«ç§’</p>
</li>
<li>
<p>å…¨å±€å˜é‡ current_db ç”¨äºè®°å½• activeExpireCycle() çš„æ£€æŸ¥è¿›åº¦ï¼ˆå“ªä¸€ä¸ªæ•°æ®åº“ï¼‰ï¼Œä¸‹ä¸€æ¬¡è°ƒç”¨æ—¶æ¥ç€è¯¥è¿›åº¦å¤„ç†</p>
</li>
<li>
<p>éšç€å‡½æ•°çš„ä¸æ–­æ‰§è¡Œï¼ŒæœåŠ¡å™¨ä¸­çš„æ‰€æœ‰æ•°æ®åº“éƒ½ä¼šè¢«æ£€æŸ¥ä¸€éï¼Œè¿™æ—¶å°† current_db é‡ç½®ä¸º 0ï¼Œç„¶åå†æ¬¡å¼€å§‹æ–°ä¸€è½®çš„æ£€æŸ¥</p>
</li>
</ul>
</li>
</ul>
<p>å®šæœŸåˆ é™¤ç‰¹ç‚¹ï¼š</p>
<ul>
<li>CPU æ€§èƒ½å ç”¨è®¾ç½®æœ‰å³°å€¼ï¼Œæ£€æµ‹é¢‘åº¦å¯è‡ªå®šä¹‰è®¾ç½®</li>
<li>å†…å­˜å‹åŠ›ä¸æ˜¯å¾ˆå¤§ï¼Œé•¿æœŸå ç”¨å†…å­˜çš„<strong>å†·æ•°æ®ä¼šè¢«æŒç»­æ¸…ç†</strong></li>
<li>å‘¨æœŸæ€§æŠ½æŸ¥å­˜å‚¨ç©ºé—´ï¼ˆéšæœºæŠ½æŸ¥ï¼Œé‡ç‚¹æŠ½æŸ¥ï¼‰</li>
</ul>
<hr>
<h3 id="æ•°æ®æ·˜æ±°">æ•°æ®æ·˜æ±°</h3>
<h4 id="é€å‡ºç®—æ³•">é€å‡ºç®—æ³•</h4>
<p>æ•°æ®æ·˜æ±°ç­–ç•¥ï¼šå½“æ–°æ•°æ®è¿›å…¥ Redis æ—¶ï¼Œåœ¨æ‰§è¡Œæ¯ä¸€ä¸ªå‘½ä»¤å‰ï¼Œä¼šè°ƒç”¨ <strong>freeMemoryIfNeeded()</strong> æ£€æµ‹å†…å­˜æ˜¯å¦å……è¶³ã€‚å¦‚æœå†…å­˜ä¸æ»¡è¶³æ–°åŠ å…¥æ•°æ®çš„æœ€ä½å­˜å‚¨è¦æ±‚ï¼ŒRedis è¦ä¸´æ—¶åˆ é™¤ä¸€äº›æ•°æ®ä¸ºå½“å‰æŒ‡ä»¤æ¸…ç†å­˜å‚¨ç©ºé—´ï¼Œæ¸…ç†æ•°æ®çš„ç­–ç•¥ç§°ä¸º<strong>é€å‡ºç®—æ³•</strong></p>
<p>é€å‡ºæ•°æ®çš„è¿‡ç¨‹ä¸æ˜¯ 100% èƒ½å¤Ÿæ¸…ç†å‡ºè¶³å¤Ÿçš„å¯ä½¿ç”¨çš„å†…å­˜ç©ºé—´ï¼Œå¦‚æœä¸æˆåŠŸåˆ™åå¤æ‰§è¡Œï¼Œå½“å¯¹æ‰€æœ‰æ•°æ®å°è¯•å®Œæ¯•ï¼Œå¦‚ä¸èƒ½è¾¾åˆ°å†…å­˜æ¸…ç†çš„è¦æ±‚ï¼Œ<strong>å‡ºç° Redis å†…å­˜æ‰“æ»¡å¼‚å¸¸</strong>ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(error) OOM <span class="built_in">command</span> not allowed when used memory &gt;<span class="string">&#x27;maxmemory&#x27;</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="ç­–ç•¥é…ç½®">ç­–ç•¥é…ç½®</h4>
<p>Redis å¦‚æœä¸è®¾ç½®æœ€å¤§å†…å­˜å¤§å°æˆ–è€…è®¾ç½®æœ€å¤§å†…å­˜å¤§å°ä¸º 0ï¼Œåœ¨ 64 ä½æ“ä½œç³»ç»Ÿä¸‹ä¸é™åˆ¶å†…å­˜å¤§å°ï¼Œåœ¨ 32 ä½æ“ä½œç³»ç»Ÿé»˜è®¤ä¸º 3GB å†…å­˜ï¼Œä¸€èˆ¬æ¨èè®¾ç½® Redis å†…å­˜ä¸ºæœ€å¤§ç‰©ç†å†…å­˜çš„å››åˆ†ä¹‹ä¸‰</p>
<p>å†…å­˜é…ç½®æ–¹å¼ï¼š</p>
<ul>
<li>
<p>é€šè¿‡ä¿®æ”¹æ–‡ä»¶é…ç½®ï¼ˆæ°¸ä¹…ç”Ÿæ•ˆï¼‰ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶ maxmemory å­—æ®µï¼Œå•ä½ä¸ºå­—èŠ‚</p>
</li>
<li>
<p>é€šè¿‡å‘½ä»¤ä¿®æ”¹ï¼ˆé‡å¯å¤±æ•ˆï¼‰ï¼š</p>
<ul>
<li>
<p><code>config set maxmemory 104857600</code>ï¼šè®¾ç½® Redis æœ€å¤§å ç”¨å†…å­˜ä¸º 100MB</p>
</li>
<li>
<p><code>config get maxmemory</code>ï¼šè·å– Redis æœ€å¤§å ç”¨å†…å­˜</p>
</li>
<li>
<p><code>info</code> ï¼šå¯ä»¥æŸ¥çœ‹ Redis å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œ<code>used_memory_human</code> å­—æ®µè¡¨ç¤ºå®é™…å·²ç»å ç”¨çš„å†…å­˜ï¼Œ<code>maxmemory</code> è¡¨ç¤ºæœ€å¤§å ç”¨å†…å­˜</p>
</li>
</ul>
</li>
</ul>
<p>å½±å“æ•°æ®æ·˜æ±°çš„ç›¸å…³é…ç½®å¦‚ä¸‹ï¼Œé…ç½® conf æ–‡ä»¶ï¼š</p>
<ul>
<li>
<p>æ¯æ¬¡é€‰å–å¾…åˆ é™¤æ•°æ®çš„ä¸ªæ•°ï¼Œé‡‡ç”¨éšæœºè·å–æ•°æ®çš„æ–¹å¼ä½œä¸ºå¾…æ£€æµ‹åˆ é™¤æ•°æ®ï¼Œé˜²æ­¢å…¨åº“æ‰«æï¼Œå¯¼è‡´ä¸¥é‡çš„æ€§èƒ½æ¶ˆè€—ï¼Œé™ä½è¯»å†™æ€§èƒ½</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maxmemory-samples count</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è¾¾åˆ°æœ€å¤§å†…å­˜åçš„ï¼Œå¯¹è¢«æŒ‘é€‰å‡ºæ¥çš„æ•°æ®è¿›è¡Œåˆ é™¤çš„ç­–ç•¥</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maxmemory-policy policy</span><br></pre></td></tr></table></figure>
<p>æ•°æ®åˆ é™¤çš„ç­–ç•¥ policyï¼š3 ç±» 8 ç§</p>
<p>ç¬¬ä¸€ç±»ï¼šæ£€æµ‹æ˜“å¤±æ•°æ®ï¼ˆå¯èƒ½ä¼šè¿‡æœŸçš„æ•°æ®é›† server.db[i].expiresï¼‰ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">volatile-lru	<span class="comment"># å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key é€‰æ‹©æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</span></span><br><span class="line">volatile-lfu	<span class="comment"># å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key é€‰æ‹©æœ€è¿‘ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„æ•°æ®æ·˜æ±°</span></span><br><span class="line">volatile-ttl	<span class="comment"># å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key é€‰æ‹©å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°</span></span><br><span class="line">volatile-random	<span class="comment"># å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key é€‰æ‹©ä»»æ„æ•°æ®æ·˜æ±°</span></span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒç±»ï¼šæ£€æµ‹å…¨åº“æ•°æ®ï¼ˆæ‰€æœ‰æ•°æ®é›† server.db[i].dict ï¼‰ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">allkeys-lru		<span class="comment"># å¯¹æ‰€æœ‰ key é€‰æ‹©æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</span></span><br><span class="line">allkeLyRs-lfu	<span class="comment"># å¯¹æ‰€æœ‰ key é€‰æ‹©æœ€è¿‘ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„æ•°æ®æ·˜æ±°</span></span><br><span class="line">allkeys-random	<span class="comment"># å¯¹æ‰€æœ‰ key é€‰æ‹©ä»»æ„æ•°æ®æ·˜æ±°ï¼Œç›¸å½“äºéšæœº</span></span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸‰ç±»ï¼šæ”¾å¼ƒæ•°æ®é©±é€</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">no-enviction	<span class="comment">#ç¦æ­¢é©±é€æ•°æ®(redis4.0ä¸­é»˜è®¤ç­–ç•¥)ï¼Œä¼šå¼•å‘OOM(Out Of Memory)</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ•°æ®æ·˜æ±°ç­–ç•¥é…ç½®ä¾æ®ï¼šä½¿ç”¨ INFO å‘½ä»¤è¾“å‡ºç›‘æ§ä¿¡æ¯ï¼ŒæŸ¥è¯¢ç¼“å­˜ hit å’Œ miss çš„æ¬¡æ•°ï¼Œæ ¹æ®éœ€æ±‚è°ƒä¼˜ Redis é…ç½®</p>
<hr>
<h3 id="æ’åºæœºåˆ¶">æ’åºæœºåˆ¶</h3>
<h4 id="åŸºæœ¬ä»‹ç»">åŸºæœ¬ä»‹ç»</h4>
<p>Redis çš„ SORT å‘½ä»¤å¯ä»¥å¯¹åˆ—è¡¨é”®ã€é›†åˆé”®æˆ–è€…æœ‰åºé›†åˆé”®çš„å€¼è¿›è¡Œæ’åºï¼Œå¹¶ä¸æ›´æ”¹é›†åˆä¸­çš„æ•°æ®ä½ç½®ï¼Œåªæ˜¯æŸ¥è¯¢</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SORT key [ASC/DESC]			<span class="comment">#å¯¹keyä¸­æ•°æ®æ’åºï¼Œé»˜è®¤å¯¹æ•°å­—æ’åºï¼Œå¹¶ä¸æ›´æ”¹é›†åˆä¸­çš„æ•°æ®ä½ç½®ï¼Œåªæ˜¯æŸ¥è¯¢</span></span><br><span class="line">SORT key ALPHA				<span class="comment">#å¯¹keyä¸­å­—æ¯æ’åºï¼ŒæŒ‰ç…§å­—å…¸åº</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="SORT">SORT</h4>
<p><code>SORT &lt;key&gt;</code> å‘½ä»¤å¯ä»¥å¯¹ä¸€ä¸ªåŒ…å«æ•°å­—å€¼çš„é”® key è¿›è¡Œæ’åº</p>
<p>å‡è®¾ <code>RPUSH numbers 3 1 2</code>ï¼Œæ‰§è¡Œ <code>SORT numbers</code> çš„è¯¦ç»†æ­¥éª¤ï¼š</p>
<ul>
<li>
<p>åˆ›å»ºä¸€ä¸ªå’Œ key åˆ—è¡¨é•¿åº¦ç›¸åŒçš„æ•°ç»„ï¼Œæ•°ç»„æ¯é¡¹éƒ½æ˜¯ redisSortObject ç»“æ„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisSortObject</span> &#123;</span></span><br><span class="line">    <span class="comment">// è¢«æ’åºé”®çš„å€¼</span></span><br><span class="line">    robj *obj;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æƒé‡</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="comment">// æ’åºæ•°å­—å€¼æ—¶ä½¿ç”¨</span></span><br><span class="line">        <span class="type">double</span> score;</span><br><span class="line">        <span class="comment">// æ’åºå¸¦æœ‰ BY é€‰é¡¹çš„å­—ç¬¦ä¸²</span></span><br><span class="line">        robj *cmpobj;</span><br><span class="line">    &#125; u;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>éå†æ•°ç»„ï¼Œå°†å„ä¸ªæ•°ç»„é¡¹çš„ obj æŒ‡é’ˆåˆ†åˆ«æŒ‡å‘ numbers åˆ—è¡¨çš„å„ä¸ªé¡¹</p>
</li>
<li>
<p>éå†æ•°ç»„ï¼Œå°† obj æŒ‡é’ˆæ‰€æŒ‡å‘çš„åˆ—è¡¨é¡¹è½¬æ¢æˆä¸€ä¸ª double ç±»å‹çš„æµ®ç‚¹æ•°ï¼Œå¹¶å°†æµ®ç‚¹æ•°ä¿å­˜åœ¨å¯¹åº”æ•°ç»„é¡¹çš„ u.score å±æ€§é‡Œ</p>
</li>
<li>
<p>æ ¹æ®æ•°ç»„é¡¹ u.score å±æ€§çš„å€¼ï¼Œå¯¹æ•°ç»„è¿›è¡Œæ•°å­—å€¼æ’åºï¼Œæ’åºåçš„æ•°ç»„é¡¹æŒ‰ u.score å±æ€§çš„å€¼<strong>ä»å°åˆ°å¤§æ’åˆ—</strong></p>
</li>
<li>
<p>éå†æ•°ç»„ï¼Œå°†å„ä¸ªæ•°ç»„é¡¹çš„ obj æŒ‡é’ˆæ‰€æŒ‡å‘çš„å€¼ä½œä¸ºæ’åºç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œç¨‹åºé¦–å…ˆè®¿é—®æ•°ç»„çš„ç´¢å¼• 0ï¼Œä¾æ¬¡å‘åè®¿é—®</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-sort%E6%8E%92%E5%BA%8F.png" alt=""></p>
<p>å¯¹äº <code>SORT key [ASC/DESC]</code> å‡½æ•°ï¼š</p>
<ul>
<li>åœ¨æ‰§è¡Œå‡åºæ’åºæ—¶ï¼Œæ’åºç®—æ³•ä½¿ç”¨çš„å¯¹æ¯”å‡½æ•°äº§ç”Ÿå‡åºå¯¹æ¯”ç»“æœ</li>
<li>åœ¨æ‰§è¡Œé™åºæ’åºæ—¶ï¼Œæ’åºç®—æ³•ä½¿ç”¨çš„å¯¹æ¯”å‡½æ•°äº§ç”Ÿé™åºå¯¹æ¯”ç»“æœ</li>
</ul>
<hr>
<h4 id="BY">BY</h4>
<p>SORT å‘½ä»¤é»˜è®¤ä½¿ç”¨è¢«æ’åºé”®ä¸­åŒ…å«çš„å…ƒç´ ä½œä¸ºæ’åºçš„æƒé‡ï¼Œå…ƒç´ æœ¬èº«å†³å®šäº†å…ƒç´ åœ¨æ’åºä¹‹åæ‰€å¤„çš„ä½ç½®ï¼Œé€šè¿‡ä½¿ç”¨ BY é€‰é¡¹ï¼ŒSORT å‘½ä»¤å¯ä»¥æŒ‡å®šæŸäº›å­—ç¬¦ä¸²é”®ï¼Œæˆ–è€…æŸä¸ªå“ˆå¸Œé”®æ‰€åŒ…å«çš„æŸäº›åŸŸï¼ˆfieldï¼‰æ¥ä½œä¸ºå…ƒç´ çš„æƒé‡ï¼Œå¯¹ä¸€ä¸ªé”®è¿›è¡Œæ’åº</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SORT &lt;key&gt; BY &lt;pattern&gt;			<span class="comment"># æ•°å€¼</span></span><br><span class="line">SORT &lt;key&gt; BY &lt;pattern&gt; ALPHA	<span class="comment"># å­—ç¬¦</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; SADD fruits <span class="string">&quot;apple&quot;</span> <span class="string">&quot;banana&quot;</span> <span class="string">&quot;cherry&quot;</span> </span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">redis&gt; SORT fruits ALPHA</span><br><span class="line">1)	<span class="string">&quot;apple&quot;</span></span><br><span class="line">2)	<span class="string">&quot;banana&quot;</span></span><br><span class="line">3)	<span class="string">&quot;cherry&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; MSET apple-price 8 banana-price 5.5 cherry-price 7 </span><br><span class="line">OK</span><br><span class="line"><span class="comment"># ä½¿ç”¨æ°´æœçš„ä»·é’±è¿›è¡Œæ’åº</span></span><br><span class="line">redis&gt; SORT fruits BY *-price</span><br><span class="line">1)	<span class="string">&quot;banana&quot;</span></span><br><span class="line">2)	<span class="string">&quot;cherry&quot;</span></span><br><span class="line">3)	<span class="string">&quot;apple&quot;</span></span><br></pre></td></tr></table></figure>
<p>å®ç°åŸç†ï¼šæ’åºæ—¶çš„ u.score å±æ€§å°±ä¼šè¢«è®¾ç½®ä¸ºå¯¹åº”çš„æƒé‡</p>
<hr>
<h4 id="LIMIT">LIMIT</h4>
<p>SORT å‘½ä»¤é»˜è®¤ä¼šå°†æ’åºåçš„æ‰€æœ‰å…ƒç´ éƒ½è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œé€šè¿‡ LIMIT é€‰é¡¹å¯ä»¥è®© SORT å‘½ä»¤åªè¿”å›å…¶ä¸­ä¸€éƒ¨åˆ†å·²æ’åºçš„å…ƒç´ </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LIMIT &lt;offset&gt; &lt;count&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>offset å‚æ•°è¡¨ç¤ºè¦è·³è¿‡çš„å·²æ’åºå…ƒç´ æ•°é‡</li>
<li>count å‚æ•°è¡¨ç¤ºè·³è¿‡ç»™å®šæ•°é‡çš„å…ƒç´ åï¼Œè¦è¿”å›çš„å·²æ’åºå…ƒç´ æ•°é‡</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯¹åº” a b c d e f  g</span></span><br><span class="line">redis&gt; SORT alphabet ALPHA LIMIT 2 3</span><br><span class="line">1) 	<span class="string">&quot;c&quot;</span></span><br><span class="line">2) 	<span class="string">&quot;d&quot;</span></span><br><span class="line">3) 	<span class="string">&quot;e&quot;</span></span><br></pre></td></tr></table></figure>
<p>å®ç°åŸç†ï¼šåœ¨æ’åºåçš„ redisSortObject ç»“æ„æ•°ç»„ä¸­ï¼Œå°†æŒ‡é’ˆç§»åŠ¨åˆ°æ•°ç»„çš„ç´¢å¼• 2 ä¸Šï¼Œä¾æ¬¡è®¿é—® array[2]ã€array[3]ã€array[4] è¿™ 3 ä¸ªæ•°ç»„é¡¹ï¼Œå¹¶å°†æ•°ç»„é¡¹çš„ obj æŒ‡é’ˆæ‰€æŒ‡å‘çš„å…ƒç´ è¿”å›ç»™å®¢æˆ·ç«¯</p>
<hr>
<h4 id="GET">GET</h4>
<p>SORT å‘½ä»¤é»˜è®¤åœ¨å¯¹é”®è¿›è¡Œæ’åºåï¼Œè¿”å›è¢«æ’åºé”®æœ¬èº«æ‰€åŒ…å«çš„å…ƒç´ ï¼Œé€šè¿‡ä½¿ç”¨ GET é€‰é¡¹ï¼Œ å¯ä»¥åœ¨å¯¹é”®è¿›è¡Œæ’åºåï¼Œæ ¹æ®è¢«æ’åºçš„å…ƒç´ ä»¥åŠ GET é€‰é¡¹æ‰€æŒ‡å®šçš„æ¨¡å¼ï¼ŒæŸ¥æ‰¾å¹¶è¿”å›æŸäº›é”®çš„å€¼</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SORT &lt;key&gt; GET &lt;pattern&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; SADD students <span class="string">&quot;tom&quot;</span> <span class="string">&quot;jack&quot;</span> <span class="string">&quot;sea&quot;</span></span><br><span class="line"><span class="comment">#è®¾ç½®å…¨å</span></span><br><span class="line">redis&gt; SET tom-name <span class="string">&quot;Tom Li&quot;</span> </span><br><span class="line">OK </span><br><span class="line">redis&gt; SET jack-name <span class="string">&quot;Jack Wang&quot;</span> </span><br><span class="line">OK </span><br><span class="line">redis&gt; SET sea-name <span class="string">&quot;Sea Zhang&quot;</span></span><br><span class="line">OK </span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; SORT students ALPHA GET *-name</span><br><span class="line">1)	<span class="string">&quot;Jack Wang&quot;</span></span><br><span class="line">2)	<span class="string">&quot;Sea Zhang&quot;</span></span><br><span class="line">3) 	<span class="string">&quot;Tom Li&quot;</span></span><br></pre></td></tr></table></figure>
<p>å®ç°åŸç†ï¼šå¯¹ students è¿›è¡Œæ’åºåï¼Œå¯¹äº jack å…ƒç´ å’Œ *-name æ¨¡å¼ï¼ŒæŸ¥æ‰¾ç¨‹åºè¿”å›é”® jack-nameï¼Œç„¶åè·å– jack-name é”®å¯¹åº”çš„å€¼</p>
<hr>
<h4 id="STORE">STORE</h4>
<p>SORT å‘½ä»¤é»˜è®¤åªå‘å®¢æˆ·ç«¯è¿”å›æ’åºç»“æœï¼Œè€Œä¸ä¿å­˜æ’åºç»“æœï¼Œé€šè¿‡ä½¿ç”¨ STORE é€‰é¡¹å¯ä»¥å°†æ’åºç»“æœä¿å­˜åœ¨æŒ‡å®šçš„é”®é‡Œé¢</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SORT &lt;key&gt; STORE &lt;sort_key&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; SADD students <span class="string">&quot;tom&quot;</span> <span class="string">&quot;jack&quot;</span> <span class="string">&quot;sea&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3 </span><br><span class="line">redis&gt; SORT students ALPHA STORE sorted_students </span><br><span class="line">(<span class="built_in">integer</span>) 3 </span><br></pre></td></tr></table></figure>
<p>å®ç°åŸç†ï¼šæ’åºåï¼Œæ£€æŸ¥ sorted_students é”®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±åˆ é™¤è¯¥é”®ï¼Œè®¾ç½® sorted_students ä¸ºç©ºç™½çš„åˆ—è¡¨é”®ï¼Œéå†æ’åºæ•°ç»„å°†å…ƒç´ ä¾æ¬¡æ”¾å…¥</p>
<hr>
<h4 id="æ‰§è¡Œé¡ºåº">æ‰§è¡Œé¡ºåº</h4>
<p>è°ƒç”¨ SORT å‘½ä»¤ï¼Œé™¤äº† GET é€‰é¡¹ä¹‹å¤–ï¼Œæ”¹å˜å…¶ä»–é€‰é¡¹çš„æ‘†æ”¾é¡ºåºå¹¶ä¸ä¼šå½±å“å‘½ä»¤æ‰§è¡Œé€‰é¡¹çš„é¡ºåº</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SORT &lt;key&gt; ALPHA [ASC/DESC] BY &lt;by-pattern&gt; LIMIT &lt;offset&gt; &lt;count&gt; GET &lt;get-pattern&gt; STORE &lt;store_key&gt;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œé¡ºåºï¼š</p>
<ul>
<li>æ’åºï¼šå‘½ä»¤ä¼šä½¿ç”¨ ALPHA ã€ASC æˆ– DESCã€BY è¿™å‡ ä¸ªé€‰é¡¹ï¼Œå¯¹è¾“å…¥é”®è¿›è¡Œæ’åºï¼Œå¹¶å¾—åˆ°ä¸€ä¸ªæ’åºç»“æœé›†</li>
<li>é™åˆ¶æ’åºç»“æœé›†çš„é•¿åº¦ï¼šä½¿ç”¨ LIMIT é€‰é¡¹ï¼Œå¯¹æ’åºç»“æœé›†çš„é•¿åº¦è¿›è¡Œé™åˆ¶</li>
<li>è·å–å¤–éƒ¨é”®ï¼šæ ¹æ®æ’åºç»“æœé›†ä¸­çš„å…ƒç´ ä»¥åŠ GET é€‰é¡¹æŒ‡å®šçš„æ¨¡å¼ï¼ŒæŸ¥æ‰¾å¹¶è·å–æŒ‡å®šé”®çš„å€¼ï¼Œå¹¶ç”¨è¿™äº›å€¼æ¥ä½œä¸ºæ–°çš„æ’åºç»“æœé›†</li>
<li>ä¿å­˜æ’åºç»“æœé›†ï¼šä½¿ç”¨ STORE é€‰é¡¹ï¼Œå°†æ’åºç»“æœé›†ä¿å­˜åˆ°æŒ‡å®šçš„é”®ä¸Šé¢å»</li>
<li>å‘å®¢æˆ·ç«¯è¿”å›æ’åºç»“æœé›†ï¼šæœ€åä¸€æ­¥å‘½ä»¤éå†æ’åºç»“æœé›†ï¼Œå¹¶ä¾æ¬¡å‘å®¢æˆ·ç«¯è¿”å›æ’åºç»“æœé›†ä¸­çš„å…ƒç´ </li>
</ul>
<hr>
<h3 id="é€šçŸ¥æœºåˆ¶">é€šçŸ¥æœºåˆ¶</h3>
<p>æ•°æ®åº“é€šçŸ¥æ˜¯å¯ä»¥è®©å®¢æˆ·ç«¯é€šè¿‡è®¢é˜…ç»™å®šçš„é¢‘é“æˆ–è€…æ¨¡å¼ï¼Œæ¥è·çŸ¥æ•°æ®åº“ä¸­é”®çš„å˜åŒ–ï¼Œä»¥åŠæ•°æ®åº“ä¸­å‘½ä»¤çš„æ‰§è¡Œæƒ…å†µ</p>
<ul>
<li>å…³æ³¨æŸä¸ªé”®æ‰§è¡Œäº†ä»€ä¹ˆå‘½ä»¤çš„é€šçŸ¥ç§°ä¸ºé”®ç©ºé—´é€šçŸ¥ï¼ˆkey-space notificationï¼‰</li>
<li>å…³æ³¨æŸä¸ªå‘½ä»¤è¢«ä»€ä¹ˆé”®æ‰§è¡Œçš„é€šçŸ¥ç§°ä¸ºé”®äº‹ä»¶é€šçŸ¥ï¼ˆkey-event notificationï¼‰</li>
</ul>
<p>å›¾ç¤ºè®¢é˜… 0 å·æ•°æ®åº“ message é”®ï¼š</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æ•°æ®åº“é€šçŸ¥.png" style="zoom: 67%;" />
<p>æœåŠ¡å™¨é…ç½®çš„ notify-keyspace-events é€‰é¡¹å†³å®šäº†æœåŠ¡å™¨æ‰€å‘é€é€šçŸ¥çš„ç±»å‹</p>
<ul>
<li>AKE ä»£è¡¨æœåŠ¡å™¨å‘é€æ‰€æœ‰ç±»å‹çš„é”®ç©ºé—´é€šçŸ¥å’Œé”®äº‹ä»¶é€šçŸ¥</li>
<li>AK ä»£è¡¨æœåŠ¡å™¨å‘é€æ‰€æœ‰ç±»å‹çš„é”®ç©ºé—´é€šçŸ¥</li>
<li>AE ä»£è¡¨æœåŠ¡å™¨å‘é€æ‰€æœ‰ç±»å‹çš„é”®äº‹ä»¶é€šçŸ¥</li>
<li>K$ ä»£è¡¨æœåŠ¡å™¨åªå‘é€å’Œå­—ç¬¦ä¸²é”®æœ‰å…³çš„é”®ç©ºé—´é€šçŸ¥</li>
<li>EL ä»£è¡¨æœåŠ¡å™¨åªå‘é€å’Œåˆ—è¡¨é”®æœ‰å…³çš„é”®äº‹ä»¶é€šçŸ¥</li>
<li>â€¦</li>
</ul>
<p>å‘é€æ•°æ®åº“é€šçŸ¥çš„åŠŸèƒ½æ˜¯ç”± notifyKeyspaceEvent å‡½æ•°å®ç°çš„ï¼š</p>
<ul>
<li>å¦‚æœç»™å®šçš„é€šçŸ¥ç±»å‹ type ä¸æ˜¯æœåŠ¡å™¨å…è®¸å‘é€çš„é€šçŸ¥ç±»å‹ï¼Œé‚£ä¹ˆå‡½æ•°ä¼šç›´æ¥è¿”å›</li>
<li>å¦‚æœç»™å®šçš„é€šçŸ¥æ˜¯æœåŠ¡å™¨å…è®¸å‘é€çš„é€šçŸ¥
<ul>
<li>æ£€æµ‹æœåŠ¡å™¨æ˜¯å¦å…è®¸å‘é€é”®ç©ºé—´é€šçŸ¥ï¼Œå…è®¸å°±ä¼šæ„å»ºå¹¶å‘é€äº‹ä»¶é€šçŸ¥</li>
<li>æ£€æµ‹æœåŠ¡å™¨æ˜¯å¦å…è®¸å‘é€é”®äº‹ä»¶é€šçŸ¥ï¼Œå…è®¸å°±ä¼šæ„å»ºå¹¶å‘é€äº‹ä»¶é€šçŸ¥</li>
</ul>
</li>
</ul>
<hr>
<h2 id="ä½“ç³»æ¶æ„">ä½“ç³»æ¶æ„</h2>
<h3 id="äº‹ä»¶é©±åŠ¨">äº‹ä»¶é©±åŠ¨</h3>
<h4 id="åŸºæœ¬ä»‹ç»-2">åŸºæœ¬ä»‹ç»</h4>
<p>Redis æœåŠ¡å™¨æ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨ç¨‹åºï¼ŒæœåŠ¡å™¨éœ€è¦å¤„ç†ä¸¤ç±»äº‹ä»¶</p>
<ul>
<li>æ–‡ä»¶äº‹ä»¶ (file event)ï¼šæœåŠ¡å™¨é€šè¿‡å¥—æ¥å­—ä¸å®¢æˆ·ç«¯ï¼ˆæˆ–å…¶ä»– Redis æœåŠ¡å™¨ï¼‰è¿›è¡Œè¿æ¥ï¼Œè€Œæ–‡ä»¶äº‹ä»¶å°±æ˜¯æœåŠ¡å™¨å¯¹å¥—æ¥å­—æ“ä½œçš„æŠ½è±¡ã€‚æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„é€šä¿¡ä¼šäº§ç”Ÿç›¸åº”çš„æ–‡ä»¶äº‹ä»¶ï¼ŒæœåŠ¡å™¨é€šè¿‡ç›‘å¬å¹¶å¤„ç†è¿™äº›äº‹ä»¶å®Œæˆä¸€ç³»åˆ—ç½‘ç»œé€šä¿¡æ“ä½œ</li>
<li>æ—¶é—´äº‹ä»¶ (time event)ï¼šRedis æœåŠ¡å™¨ä¸­çš„ä¸€äº›æ“ä½œï¼ˆæ¯”å¦‚ serverCron å‡½æ•°ï¼‰éœ€è¦åœ¨æŒ‡å®šæ—¶é—´æ‰§è¡Œï¼Œè€Œæ—¶é—´äº‹ä»¶å°±æ˜¯æœåŠ¡å™¨å¯¹è¿™ç±»å®šæ—¶æ“ä½œçš„æŠ½è±¡</li>
</ul>
<hr>
<h4 id="æ–‡ä»¶äº‹ä»¶">æ–‡ä»¶äº‹ä»¶</h4>
<h5 id="åŸºæœ¬ç»„æˆ">åŸºæœ¬ç»„æˆ</h5>
<p>Redis åŸºäº Reactor æ¨¡å¼å¼€å‘äº†ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼Œè¿™ä¸ªå¤„ç†å™¨è¢«ç§°ä¸ºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ (file event handler)</p>
<ul>
<li>
<p>ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ (multiplexing) ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œå¹¶æ ¹æ®å¥—æ¥å­—æ‰§è¡Œçš„ä»»åŠ¡æ¥ä¸ºå¥—æ¥å­—å…³è”ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨</p>
</li>
<li>
<p>å½“è¢«ç›‘å¬çš„å¥—æ¥å­—å‡†å¤‡å¥½æ‰§è¡Œè¿æ¥åº”ç­” (accept)ã€ è¯»å– (read)ã€ å†™å…¥ (write)ã€ å…³é—­ (close) ç­‰æ“ä½œæ—¶ï¼Œä¸æ“ä½œç›¸å¯¹åº”çš„æ–‡ä»¶äº‹ä»¶å°±ä¼šäº§ç”Ÿï¼Œè¿™æ—¶æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ä¼šè°ƒç”¨å¥—æ¥å­—å…³è”å¥½çš„äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†äº‹ä»¶</p>
</li>
</ul>
<p>æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨<strong>ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œ</strong>ï¼Œä½†é€šè¿‡ä½¿ç”¨  I/O å¤šè·¯å¤ç”¨ç¨‹åºæ¥ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œ æ—¢å®ç°äº†é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¨¡å‹ï¼Œåˆå¯ä»¥å¾ˆå¥½åœ°ä¸ Redis æœåŠ¡å™¨ä¸­å…¶ä»–åŒæ ·ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„æ¨¡å—è¿›è¡Œå¯¹æ¥ï¼Œä¿æŒäº† Redis å†…éƒ¨å•çº¿ç¨‹è®¾è®¡çš„ç®€å•æ€§</p>
<p>æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨çš„ç»„æˆç»“æ„ï¼š</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨.png" style="zoom:80%;" />
<p>I/O å¤šè·¯å¤ç”¨ç¨‹åºå°†æ‰€æœ‰äº§ç”Ÿäº‹ä»¶çš„å¥—æ¥å­—å¤„ç†è¯·æ±‚æ”¾å…¥ä¸€ä¸ª<strong>å•çº¿ç¨‹çš„æ‰§è¡Œé˜Ÿåˆ—</strong>ä¸­ï¼Œé€šè¿‡é˜Ÿåˆ—æœ‰åºã€åŒæ­¥çš„å‘æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ä¼ é€å¥—æ¥å­—ï¼Œä¸Šä¸€ä¸ªå¥—æ¥å­—äº§ç”Ÿçš„äº‹ä»¶å¤„ç†å®Œåï¼Œæ‰ä¼šç»§ç»­å‘åˆ†æ´¾å™¨ä¼ é€ä¸‹ä¸€ä¸ª</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-IOå¤šè·¯å¤ç”¨ç¨‹åº.png" style="zoom: 67%;" />
<p>Redis å•çº¿ç¨‹ä¹Ÿèƒ½é«˜æ•ˆçš„åŸå› ï¼š</p>
<ul>
<li>çº¯å†…å­˜æ“ä½œ</li>
<li>æ ¸å¿ƒæ˜¯åŸºäºéé˜»å¡çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå•çº¿ç¨‹å¯ä»¥é«˜æ•ˆå¤„ç†å¤šä¸ªè¯·æ±‚</li>
<li>åº•å±‚ä½¿ç”¨ C è¯­è¨€å®ç°ï¼ŒC è¯­è¨€å®ç°çš„ç¨‹åºè·ç¦»æ“ä½œç³»ç»Ÿæ›´è¿‘ï¼Œæ‰§è¡Œé€Ÿåº¦ç›¸å¯¹ä¼šæ›´å¿«</li>
<li>å•çº¿ç¨‹åŒæ—¶ä¹Ÿ<strong>é¿å…äº†å¤šçº¿ç¨‹çš„ä¸Šä¸‹æ–‡é¢‘ç¹åˆ‡æ¢é—®é¢˜</strong>ï¼Œé¢„é˜²äº†å¤šçº¿ç¨‹å¯èƒ½äº§ç”Ÿçš„ç«äº‰é—®é¢˜</li>
</ul>
<hr>
<h5 id="å¤šè·¯å¤ç”¨">å¤šè·¯å¤ç”¨</h5>
<p>Redis çš„ I/O å¤šè·¯å¤ç”¨ç¨‹åºçš„æ‰€æœ‰åŠŸèƒ½éƒ½æ˜¯é€šè¿‡åŒ…è£…å¸¸è§çš„ select ã€epollã€ evport å’Œ kqueue è¿™äº›å‡½æ•°åº“æ¥å®ç°çš„ï¼ŒRedis åœ¨ I/O å¤šè·¯å¤ç”¨ç¨‹åºçš„å®ç°æºç ä¸­ç”¨ #include å®å®šä¹‰äº†ç›¸åº”çš„è§„åˆ™ï¼Œç¼–è¯‘æ—¶è‡ªåŠ¨é€‰æ‹©ç³»ç»Ÿä¸­<strong>æ€§èƒ½æœ€é«˜çš„å¤šè·¯å¤ç”¨å‡½æ•°</strong>æ¥ä½œä¸ºåº•å±‚å®ç°</p>
<p>I/O å¤šè·¯å¤ç”¨ç¨‹åºç›‘å¬å¤šä¸ªå¥—æ¥å­—çš„ AE_READABLE äº‹ä»¶å’Œ AE_WRITABLE äº‹ä»¶ï¼Œè¿™ä¸¤ç±»äº‹ä»¶å’Œå¥—æ¥å­—æ“ä½œä¹‹é—´çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p>
<ul>
<li>å½“å¥—æ¥å­—å˜å¾—<strong>å¯è¯»</strong>æ—¶ï¼ˆå®¢æˆ·ç«¯å¯¹å¥—æ¥å­—æ‰§è¡Œ write æ“ä½œæˆ–è€… close æ“ä½œï¼‰ï¼Œæˆ–è€…æœ‰æ–°çš„<strong>å¯åº”ç­”</strong>ï¼ˆacceptableï¼‰å¥—æ¥å­—å‡ºç°æ—¶ï¼ˆå®¢æˆ·ç«¯å¯¹æœåŠ¡å™¨çš„ç›‘å¬å¥—æ¥å­—æ‰§è¡Œ connect è¿æ¥æ“ä½œï¼‰ï¼Œå¥—æ¥å­—äº§ç”Ÿ AE_READABLE äº‹ä»¶</li>
<li>å½“å¥—æ¥å­—å˜å¾—å¯å†™æ—¶ï¼ˆå®¢æˆ·ç«¯å¯¹å¥—æ¥å­—æ‰§è¡Œ read æ“ä½œï¼Œå¯¹äºæœåŠ¡å™¨æ¥è¯´å°±æ˜¯å¯ä»¥å†™äº†ï¼‰ï¼Œå¥—æ¥å­—äº§ç”Ÿ AE_WRITABLE äº‹ä»¶</li>
</ul>
<p>I/O å¤šè·¯å¤ç”¨ç¨‹åºå…è®¸æœåŠ¡å™¨åŒæ—¶ç›‘å¬å¥—æ¥å­—çš„ AE_READABLE å’Œ AE_WRITABLE äº‹ä»¶ï¼Œ å¦‚æœä¸€ä¸ªå¥—æ¥å­—åŒæ—¶äº§ç”Ÿäº†è¿™ä¸¤ç§äº‹ä»¶ï¼Œé‚£ä¹ˆæ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ä¼šä¼˜å…ˆå¤„ç† AE_READABLE  äº‹ä»¶ï¼Œ ç­‰ AE_READABLE äº‹ä»¶å¤„ç†å®Œä¹‹åæ‰å¤„ç† AE_WRITABLE äº‹ä»¶</p>
<hr>
<h5 id="å¤„ç†å™¨">å¤„ç†å™¨</h5>
<p>Redis ä¸ºæ–‡ä»¶äº‹ä»¶ç¼–å†™äº†å¤šä¸ªå¤„ç†å™¨ï¼Œè¿™äº›äº‹ä»¶å¤„ç†å™¨åˆ†åˆ«ç”¨äºå®ç°ä¸åŒçš„ç½‘ç»œé€šä¿¡éœ€æ±‚ï¼š</p>
<ul>
<li>è¿æ¥åº”ç­”å¤„ç†å™¨ï¼Œç”¨äºå¯¹è¿æ¥æœåŠ¡å™¨çš„å„ä¸ªå®¢æˆ·ç«¯è¿›è¡Œåº”ç­”ï¼ŒRedis æœåŠ¡å™¨åˆå§‹åŒ–æ—¶å°†è¯¥å¤„ç†å™¨ä¸ AE_READABLE äº‹ä»¶å…³è”</li>
<li>å‘½ä»¤è¯·æ±‚å¤„ç†å™¨ï¼Œç”¨äºæ¥æ”¶å®¢æˆ·ç«¯ä¼ æ¥çš„å‘½ä»¤è¯·æ±‚ï¼Œæ‰§è¡Œå¥—æ¥å­—çš„è¯»å…¥æ“ä½œï¼Œä¸ AE_READABLE äº‹ä»¶å…³è”</li>
<li>å‘½ä»¤å›å¤å¤„ç†å™¨ï¼Œç”¨äºå‘å®¢æˆ·ç«¯è¿”å›å‘½ä»¤çš„æ‰§è¡Œç»“æœï¼Œæ‰§è¡Œå¥—æ¥å­—çš„å†™å…¥æ“ä½œï¼Œä¸ AE_WRITABLE äº‹ä»¶å…³è”</li>
<li>å¤åˆ¶å¤„ç†å™¨ï¼Œå½“ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨è¿›è¡Œå¤åˆ¶æ“ä½œæ—¶ï¼Œä¸»ä»æœåŠ¡å™¨éƒ½éœ€è¦å…³è”è¯¥å¤„ç†å™¨</li>
</ul>
<p>Redis å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨è¿›è¡Œè¿æ¥å¹¶å‘é€å‘½ä»¤çš„æ•´ä¸ªè¿‡ç¨‹ï¼š</p>
<ul>
<li>Redis æœåŠ¡å™¨æ­£åœ¨è¿ä½œç›‘å¬å¥—æ¥å­—çš„ AE_READABLE äº‹ä»¶ï¼Œå…³è”è¿æ¥åº”ç­”å¤„ç†å™¨</li>
<li>å½“ Redis å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘èµ·è¿æ¥ï¼Œç›‘å¬å¥—æ¥å­—å°†äº§ç”Ÿ AE_READABLE äº‹ä»¶ï¼Œè§¦å‘è¿æ¥åº”ç­”å¤„ç†å™¨æ‰§è¡Œï¼Œå¯¹å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚è¿›è¡Œåº”ç­”ï¼Œåˆ›å»ºå®¢æˆ·ç«¯å¥—æ¥å­—ä»¥åŠå®¢æˆ·ç«¯çŠ¶æ€ï¼Œå¹¶å°†å®¢æˆ·ç«¯å¥—æ¥å­—çš„ <strong>AE_READABLE äº‹ä»¶ä¸å‘½ä»¤è¯·æ±‚å¤„ç†å™¨</strong>è¿›è¡Œå…³è”</li>
<li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€å‘½ä»¤è¯·æ±‚ï¼Œå®¢æˆ·ç«¯å¥—æ¥å­—äº§ç”Ÿ AE_READABLE äº‹ä»¶ï¼Œå¼•å‘å‘½ä»¤è¯·æ±‚å¤„ç†å™¨æ‰§è¡Œï¼Œè¯»å–å®¢æˆ·ç«¯çš„å‘½ä»¤å†…å®¹ä¼ ç»™ç›¸å…³ç¨‹åºå»æ‰§è¡Œ</li>
<li>æ‰§è¡Œå‘½ä»¤ä¼šäº§ç”Ÿç›¸åº”çš„å‘½ä»¤å›å¤ï¼Œä¸ºäº†å°†è¿™äº›å‘½ä»¤å›å¤ä¼ é€å›å®¢æˆ·ç«¯ï¼ŒæœåŠ¡å™¨ä¼šå°†å®¢æˆ·ç«¯å¥—æ¥å­—çš„ <strong>AE_WRITABLE äº‹ä»¶ä¸å‘½ä»¤å›å¤å¤„ç†å™¨</strong>è¿›è¡Œå…³è”</li>
<li>å½“å®¢æˆ·ç«¯å°è¯•è¯»å–å‘½ä»¤å›å¤æ—¶ï¼Œå®¢æˆ·ç«¯å¥—æ¥å­—äº§ç”Ÿ AE_WRITABLE äº‹ä»¶ï¼Œè§¦å‘å‘½ä»¤å›å¤å¤„ç†å™¨æ‰§è¡Œï¼Œåœ¨å‘½ä»¤å›å¤å…¨éƒ¨å†™å…¥å¥—æ¥å­—åï¼ŒæœåŠ¡å™¨å°±ä¼šè§£é™¤å®¢æˆ·ç«¯å¥—æ¥å­—çš„ AE_WRITABLE äº‹ä»¶ä¸å‘½ä»¤å›å¤å¤„ç†å™¨ä¹‹é—´çš„å…³è”</li>
</ul>
<hr>
<h4 id="æ—¶é—´äº‹ä»¶">æ—¶é—´äº‹ä»¶</h4>
<p>Redis çš„æ—¶é—´äº‹ä»¶åˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»ï¼š</p>
<ul>
<li>å®šæ—¶äº‹ä»¶ï¼šåœ¨æŒ‡å®šçš„æ—¶é—´ä¹‹åæ‰§è¡Œä¸€æ¬¡ï¼ˆRedis ä¸­æš‚æ—¶æœªä½¿ç”¨ï¼‰</li>
<li>å‘¨æœŸäº‹ä»¶ï¼šæ¯éš”æŒ‡å®šæ—¶é—´å°±æ‰§è¡Œä¸€æ¬¡</li>
</ul>
<p>ä¸€ä¸ªæ—¶é—´äº‹ä»¶ä¸»è¦ç”±ä»¥ä¸‹ä¸‰ä¸ªå±æ€§ç»„æˆï¼š</p>
<ul>
<li>idï¼šæœåŠ¡å™¨ä¸ºæ—¶é—´äº‹ä»¶åˆ›å»ºçš„å…¨å±€å”¯ä¸€ IDï¼ˆæ ‡è¯†å·ï¼‰ï¼Œä»å°åˆ°å¤§é¡ºåºé€’å¢ï¼Œæ–°äº‹ä»¶çš„ ID æ¯”æ—§äº‹ä»¶çš„ ID å·è¦å¤§</li>
<li>whenï¼šæ¯«ç§’ç²¾åº¦çš„ UNIX æ—¶é—´æˆ³ï¼Œè®°å½•äº†æ—¶é—´äº‹ä»¶çš„åˆ°è¾¾ï¼ˆarriveï¼‰æ—¶é—´</li>
<li>timeProcï¼šæ—¶é—´äº‹ä»¶å¤„ç†å™¨ï¼Œå½“æ—¶é—´äº‹ä»¶åˆ°è¾¾æ—¶ï¼ŒæœåŠ¡å™¨å°±ä¼šè°ƒç”¨ç›¸åº”çš„å¤„ç†å™¨æ¥å¤„ç†äº‹ä»¶</li>
</ul>
<p>æ—¶é—´äº‹ä»¶æ˜¯å®šæ—¶äº‹ä»¶è¿˜æ˜¯å‘¨æœŸæ€§äº‹ä»¶å–å†³äºæ—¶é—´äº‹ä»¶å¤„ç†å™¨çš„è¿”å›å€¼ï¼š</p>
<ul>
<li>å®šæ—¶äº‹ä»¶ï¼šäº‹ä»¶å¤„ç†å™¨è¿”å› AE_NOMOREï¼Œè¯¥äº‹ä»¶åœ¨åˆ°è¾¾ä¸€æ¬¡åå°±ä¼šè¢«åˆ é™¤</li>
<li>å‘¨æœŸäº‹ä»¶ï¼šäº‹ä»¶å¤„ç†å™¨è¿”å›é AE_NOMORE çš„æ•´æ•°å€¼ï¼ŒæœåŠ¡å™¨æ ¹æ®è¯¥å€¼å¯¹äº‹ä»¶çš„ when å±æ€§æ›´æ–°ï¼Œè®©è¯¥äº‹ä»¶åœ¨ä¸€æ®µæ—¶é—´åå†æ¬¡äº¤ä»˜</li>
</ul>
<p>æœåŠ¡å™¨å°†æ‰€æœ‰æ—¶é—´äº‹ä»¶éƒ½æ”¾åœ¨ä¸€ä¸ª<strong>æ— åºé“¾è¡¨</strong>ä¸­ï¼Œæ–°çš„æ—¶é—´äº‹ä»¶æ’å…¥åˆ°é“¾è¡¨çš„è¡¨å¤´ï¼š</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æ—¶é—´äº‹ä»¶.png" style="zoom:67%;" />
<p>æ— åºé“¾è¡¨æŒ‡æ˜¯é“¾è¡¨ä¸æŒ‰ when å±æ€§çš„å¤§å°æ’åºï¼Œæ¯å½“æ—¶é—´äº‹ä»¶æ‰§è¡Œå™¨è¿è¡Œæ—¶å°±å¿…é¡»éå†æ•´ä¸ªé“¾è¡¨ï¼ŒæŸ¥æ‰¾æ‰€æœ‰å·²åˆ°è¾¾çš„æ—¶é—´äº‹ä»¶ï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨å¤„ç†</p>
<p>æ— åºé“¾è¡¨å¹¶ä¸å½±å“æ—¶é—´äº‹ä»¶å¤„ç†å™¨çš„æ€§èƒ½ï¼Œå› ä¸ºæ­£å¸¸æ¨¡å¼ä¸‹çš„ Redis æœåŠ¡å™¨<strong>åªä½¿ç”¨ serverCron ä¸€ä¸ªæ—¶é—´äº‹ä»¶</strong>ï¼Œåœ¨ benchmark æ¨¡å¼ä¸‹æœåŠ¡å™¨ä¹Ÿåªä½¿ç”¨ä¸¤ä¸ªæ—¶é—´äº‹ä»¶ï¼Œæ‰€ä»¥æ— åºé“¾è¡¨ä¸ä¼šå½±å“æœåŠ¡å™¨çš„æ€§èƒ½ï¼Œå‡ ä¹å¯ä»¥æŒ‰ç…§ä¸€ä¸ªæŒ‡é’ˆå¤„ç†</p>
<hr>
<h4 id="äº‹ä»¶è°ƒåº¦">äº‹ä»¶è°ƒåº¦</h4>
<p>æœåŠ¡å™¨ä¸­åŒæ—¶å­˜åœ¨æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶ä¸¤ç§äº‹ä»¶ç±»å‹ï¼Œè°ƒåº¦ä¼ªä»£ç ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># äº‹ä»¶è°ƒåº¦ä¼ªä»£ç </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aeProcessEvents</span>():</span><br><span class="line">	<span class="comment"># è·å–åˆ°è¾¾æ—¶é—´ç¦»å½“å‰æ—¶é—´æœ€æ¥è¿‘çš„æ—¶é—´äº‹ä»¶ </span></span><br><span class="line">    time_event = aeSearchNearestTime()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è®¡ç®—æœ€æ¥è¿‘çš„æ—¶é—´äº‹ä»¶è·ç¦»åˆ°è¾¾è¿˜æœ‰å¤šå°‘äº³ç§’</span></span><br><span class="line">    remaind_ms = time_event.when - unix_ts_now()</span><br><span class="line">    <span class="comment"># å¦‚æœäº‹ä»¶å·²åˆ°è¾¾ï¼Œé‚£ä¹ˆ remaind_ms çš„å€¼å¯èƒ½ä¸ºè´Ÿæ•°ï¼Œè®¾ç½®ä¸º 0</span></span><br><span class="line">    <span class="keyword">if</span> remaind_ms &lt; <span class="number">0</span>:</span><br><span class="line">        remaind_ms = <span class="number">0</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment"># æ ¹æ® remaind_ms çš„å€¼ï¼Œåˆ›å»º timeval ç»“æ„</span></span><br><span class="line">	timeval = create_timeval_with_ms(remaind_ms) </span><br><span class="line">    <span class="comment"># ã€é˜»å¡å¹¶ç­‰å¾…æ–‡ä»¶äº‹ä»¶ã€‘äº§ç”Ÿï¼Œæœ€å¤§é˜»å¡æ—¶é—´ç”±ä¼ å…¥çš„timevalç»“æ„å†³å®šï¼Œremaind_msçš„å€¼ä¸º0æ—¶è°ƒç”¨åé©¬ä¸Šè¿”å›ï¼Œä¸é˜»å¡</span></span><br><span class="line">    aeApiPoll(timeval)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¤„ç†æ‰€æœ‰å·²äº§ç”Ÿçš„æ–‡ä»¶äº‹ä»¶</span></span><br><span class="line">	processFileEvents() </span><br><span class="line">	<span class="comment"># å¤„ç†æ‰€æœ‰å·²åˆ°è¾¾çš„æ—¶é—´äº‹ä»¶</span></span><br><span class="line">	processTimeEvents()</span><br></pre></td></tr></table></figure>
<p>äº‹ä»¶çš„è°ƒåº¦å’Œæ‰§è¡Œè§„åˆ™ï¼š</p>
<ul>
<li>aeApiPoll å‡½æ•°çš„æœ€å¤§é˜»å¡æ—¶é—´ç”±åˆ°è¾¾æ—¶é—´æœ€æ¥è¿‘å½“å‰æ—¶é—´çš„æ—¶é—´äº‹ä»¶å†³å®šï¼Œå¯ä»¥é¿å…æœåŠ¡å™¨å¯¹æ—¶é—´äº‹ä»¶è¿›è¡Œé¢‘ç¹çš„è½®è¯¢ï¼ˆå¿™ç­‰å¾…ï¼‰ï¼Œä¹Ÿå¯ä»¥ç¡®ä¿ aeApiPoll å‡½æ•°ä¸ä¼šé˜»å¡è¿‡é•¿æ—¶é—´</li>
<li>å¯¹æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶çš„å¤„ç†éƒ½æ˜¯<strong>åŒæ­¥ã€æœ‰åºã€åŸå­åœ°æ‰§è¡Œ</strong>ï¼ŒæœåŠ¡å™¨ä¸ä¼šä¸­é€”ä¸­æ–­äº‹ä»¶å¤„ç†ï¼Œä¹Ÿä¸ä¼šå¯¹äº‹ä»¶è¿›è¡ŒæŠ¢å ï¼Œæ‰€ä»¥ä¸¤ç§å¤„ç†å™¨éƒ½è¦å°½å¯åœ°å‡å°‘ç¨‹åºçš„é˜»å¡æ—¶é—´ï¼Œå¹¶åœ¨æœ‰éœ€è¦æ—¶<strong>ä¸»åŠ¨è®©å‡ºæ‰§è¡Œæƒ</strong>ï¼Œä»è€Œé™ä½äº‹ä»¶é¥¥é¥¿çš„å¯èƒ½æ€§
<ul>
<li>å‘½ä»¤å›å¤å¤„ç†å™¨åœ¨å†™å…¥å­—èŠ‚æ•°è¶…è¿‡äº†æŸä¸ªé¢„è®¾å¸¸é‡ï¼Œå°±ä¼šä¸»åŠ¨ç”¨ break è·³å‡ºå†™å…¥å¾ªç¯ï¼Œå°†ä½™ä¸‹çš„æ•°æ®ç•™åˆ°ä¸‹æ¬¡å†å†™</li>
<li>æ—¶é—´äº‹ä»¶ä¹Ÿä¼šå°†éå¸¸è€—æ—¶çš„æŒä¹…åŒ–æ“ä½œæ”¾åˆ°å­çº¿ç¨‹æˆ–è€…å­è¿›ç¨‹æ‰§è¡Œ</li>
</ul>
</li>
<li>æ—¶é—´äº‹ä»¶åœ¨æ–‡ä»¶äº‹ä»¶ä¹‹åæ‰§è¡Œï¼Œå¹¶ä¸”äº‹ä»¶ä¹‹é—´ä¸ä¼šå‡ºç°æŠ¢å ï¼Œæ‰€ä»¥æ—¶é—´äº‹ä»¶çš„å®é™…å¤„ç†æ—¶é—´é€šå¸¸ä¼šæ¯”è®¾å®šçš„åˆ°è¾¾æ—¶é—´ç¨æ™š</li>
</ul>
<hr>
<h4 id="å¤šçº¿ç¨‹">å¤šçº¿ç¨‹</h4>
<p>Redis6.0 å¼•å…¥å¤šçº¿ç¨‹ä¸»è¦æ˜¯ä¸ºäº†æé«˜ç½‘ç»œ IO è¯»å†™æ€§èƒ½ï¼Œå› ä¸ºè¿™æ˜¯ Redis çš„ä¸€ä¸ªæ€§èƒ½ç“¶é¢ˆï¼ˆRedis çš„ç“¶é¢ˆä¸»è¦å—é™äºå†…å­˜å’Œç½‘ç»œï¼‰ï¼Œå¤šçº¿ç¨‹åªæ˜¯ç”¨æ¥<strong>å¤„ç†ç½‘ç»œæ•°æ®çš„è¯»å†™å’Œåè®®è§£æ</strong>ï¼Œ æ‰§è¡Œå‘½ä»¤ä»ç„¶æ˜¯å•çº¿ç¨‹é¡ºåºæ‰§è¡Œï¼Œå› æ­¤ä¸éœ€è¦æ‹…å¿ƒçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p>
<p>Redis6.0 çš„å¤šçº¿ç¨‹é»˜è®¤æ˜¯ç¦ç”¨çš„ï¼Œåªä½¿ç”¨ä¸»çº¿ç¨‹ã€‚å¦‚éœ€å¼€å¯éœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ <code>redis.conf</code> ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">io-threads-do-reads yesCopy to clipboardErrorCopied</span><br></pre></td></tr></table></figure>
<p>å¼€å¯å¤šçº¿ç¨‹åï¼Œè¿˜éœ€è¦è®¾ç½®çº¿ç¨‹æ•°ï¼Œå¦åˆ™æ˜¯ä¸ç”Ÿæ•ˆçš„ï¼ŒåŒæ ·éœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ :</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">io-threads 4 <span class="comment">#å®˜ç½‘å»ºè®®4æ ¸çš„æœºå™¨å»ºè®®è®¾ç½®ä¸º2æˆ–3ä¸ªçº¿ç¨‹ï¼Œ8æ ¸çš„å»ºè®®è®¾ç½®ä¸º6ä¸ªçº¿ç¨‹</span></span><br></pre></td></tr></table></figure>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å¤šçº¿ç¨‹.png" style="zoom:80%;" />
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/dqmiR0ECf4lB6Y2OyK-dyA">https://mp.weixin.qq.com/s/dqmiR0ECf4lB6Y2OyK-dyA</a></p>
<hr>
<h3 id="å®¢æˆ·ç«¯-2">å®¢æˆ·ç«¯</h3>
<h4 id="åŸºæœ¬ä»‹ç»-3">åŸºæœ¬ä»‹ç»</h4>
<p>Redis æœåŠ¡å™¨æ˜¯å…¸å‹çš„ä¸€å¯¹å¤šç¨‹åºï¼Œä¸€ä¸ªæœåŠ¡å™¨å¯ä»¥ä¸å¤šä¸ªå®¢æˆ·ç«¯å»ºç«‹ç½‘ç»œè¿æ¥ï¼ŒæœåŠ¡å™¨å¯¹æ¯ä¸ªè¿æ¥çš„å®¢æˆ·ç«¯å»ºç«‹äº†ç›¸åº”çš„ redisClient ç»“æ„ï¼ˆå®¢æˆ·ç«¯çŠ¶æ€ï¼Œ<strong>åœ¨æœåŠ¡å™¨ç«¯çš„å­˜å‚¨ç»“æ„</strong>ï¼‰ï¼Œä¿å­˜äº†å®¢æˆ·ç«¯å½“å‰çš„çŠ¶æ€ä¿¡æ¯ï¼Œä»¥åŠæ‰§è¡Œç›¸å…³åŠŸèƒ½æ—¶éœ€è¦ç”¨åˆ°çš„æ•°æ®ç»“æ„</p>
<p>Redis æœåŠ¡å™¨çŠ¶æ€ç»“æ„çš„ clients å±æ€§æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨ä¿å­˜äº†æ‰€æœ‰ä¸æœåŠ¡å™¨è¿æ¥çš„å®¢æˆ·ç«¯çš„çŠ¶æ€ç»“æ„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="comment">// ä¸€ä¸ªé“¾è¡¨ï¼Œä¿å­˜äº†æ‰€æœ‰å®¢æˆ·ç«¯çŠ¶æ€</span></span><br><span class="line">    <span class="built_in">list</span> *clients;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E6%9C%8D%E5%8A%A1%E5%99%A8clients%E9%93%BE%E8%A1%A8.png" alt=""></p>
<hr>
<h4 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h4>
<h5 id="redisClient">redisClient</h5>
<p>å®¢æˆ·ç«¯çš„æ•°æ®ç»“æ„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisClient</span> &#123;</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¥—æ¥å­—</span></span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="comment">// åå­—</span></span><br><span class="line">    robj *name;</span><br><span class="line">    <span class="comment">// æ ‡å¿—</span></span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¾“å…¥ç¼“å†²åŒº</span></span><br><span class="line">    sds querybuf;</span><br><span class="line">    <span class="comment">// è¾“å‡ºç¼“å†²åŒº buf æ•°ç»„</span></span><br><span class="line">    <span class="type">char</span> buf[REDIS_REPLY_CHUNK_BYTES];</span><br><span class="line">    <span class="comment">// è®°å½•äº† buf æ•°ç»„ç›®å‰å·²ä½¿ç”¨çš„å­—èŠ‚æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> bufpos; </span><br><span class="line">    <span class="comment">// å¯å˜å¤§å°çš„è¾“å‡ºç¼“å†²åŒºï¼Œé“¾è¡¨ + å­—ç¬¦ä¸²å¯¹è±¡</span></span><br><span class="line">    <span class="built_in">list</span> *reply;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘½ä»¤æ•°ç»„</span></span><br><span class="line">    rboj **argv;</span><br><span class="line">    <span class="comment">// å‘½ä»¤æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">   	<span class="type">int</span> argc;</span><br><span class="line">    <span class="comment">// å‘½ä»¤çš„ä¿¡æ¯</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">redisCommand</span>  *<span class="title">cmd</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦é€šè¿‡èº«ä»½éªŒè¯</span></span><br><span class="line">    <span class="type">int</span> authenticated;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºå®¢æˆ·ç«¯çš„æ—¶é—´</span></span><br><span class="line">    <span class="type">time_t</span> ctime;</span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨æœ€åä¸€æ¬¡è¿›è¡Œäº¤äº’çš„æ—¶é—´</span></span><br><span class="line">    <span class="type">time_t</span> lastinteraction;</span><br><span class="line">    <span class="comment">// è¾“å‡ºç¼“å†²åŒºç¬¬ä¸€æ¬¡åˆ°è¾¾è½¯æ€§é™åˆ¶ (soft limit) çš„æ—¶é—´</span></span><br><span class="line">    <span class="type">time_t</span> obuf_soft_limit_reached_time;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®¢æˆ·ç«¯çŠ¶æ€åŒ…æ‹¬ä¸¤ç±»å±æ€§</p>
<ul>
<li>ä¸€ç±»æ˜¯æ¯”è¾ƒé€šç”¨çš„å±æ€§ï¼Œè¿™äº›å±æ€§å¾ˆå°‘ä¸ç‰¹å®šåŠŸèƒ½ç›¸å…³ï¼Œæ— è®ºå®¢æˆ·ç«¯æ‰§è¡Œçš„æ˜¯ä»€ä¹ˆå·¥ä½œï¼Œéƒ½è¦ç”¨åˆ°è¿™äº›å±æ€§</li>
<li>å¦ä¸€ç±»æ˜¯å’Œç‰¹å®šåŠŸèƒ½ç›¸å…³çš„å±æ€§ï¼Œæ¯”å¦‚æ“ä½œæ•°æ®åº“æ—¶ç”¨åˆ°çš„ db å±æ€§å’Œ dict id å±æ€§ï¼Œæ‰§è¡Œäº‹åŠ¡æ—¶ç”¨åˆ°çš„ mstate å±æ€§ï¼Œä»¥åŠæ‰§è¡Œ WATCH å‘½ä»¤æ—¶ç”¨åˆ°çš„ watched_keys å±æ€§ç­‰ï¼Œä»£ç ä¸­æ²¡æœ‰åˆ—å‡º</li>
</ul>
<hr>
<h5 id="å¥—æ¥å­—">å¥—æ¥å­—</h5>
<p>å®¢æˆ·ç«¯çŠ¶æ€çš„ fd å±æ€§è®°å½•äº†å®¢æˆ·ç«¯æ­£åœ¨ä½¿ç”¨çš„å¥—æ¥å­—æè¿°ç¬¦ï¼Œæ ¹æ®å®¢æˆ·ç«¯ç±»å‹çš„ä¸åŒï¼Œfd å±æ€§çš„å€¼å¯ä»¥æ˜¯ -1 æˆ–è€…å¤§äº -1 çš„æ•´æ•°ï¼š</p>
<ul>
<li>ä¼ªå®¢æˆ·ç«¯ (fake client) çš„ fd å±æ€§çš„å€¼ä¸º -1ï¼Œå‘½ä»¤è¯·æ±‚æ¥æºäº AOF æ–‡ä»¶æˆ–è€… Lua è„šæœ¬ï¼Œè€Œä¸æ˜¯ç½‘ç»œï¼Œæ‰€ä»¥ä¸éœ€è¦å¥—æ¥å­—è¿æ¥</li>
<li>æ™®é€šå®¢æˆ·ç«¯çš„ fd å±æ€§çš„å€¼ä¸ºå¤§äº -1 çš„æ•´æ•°ï¼Œå› ä¸ºåˆæ³•çš„å¥—æ¥å­—æè¿°ç¬¦ä¸èƒ½æ˜¯ -1</li>
</ul>
<p>æ‰§è¡Œ <code>CLIENT list</code> å‘½ä»¤å¯ä»¥åˆ—å‡ºç›®å‰æ‰€æœ‰è¿æ¥åˆ°æœåŠ¡å™¨çš„æ™®é€šå®¢æˆ·ç«¯ï¼Œä¸åŒ…æ‹¬ä¼ªå®¢æˆ·ç«¯</p>
<hr>
<h5 id="åå­—">åå­—</h5>
<p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯æ˜¯æ²¡æœ‰åå­—çš„ï¼Œä½¿ç”¨ <code>CLIENT setname</code> å‘½ä»¤å¯ä»¥ä¸ºå®¢æˆ·ç«¯è®¾ç½®ä¸€ä¸ªåå­—</p>
<hr>
<h5 id="æ ‡å¿—">æ ‡å¿—</h5>
<p>å®¢æˆ·ç«¯çš„æ ‡å¿—å±æ€§ flags è®°å½•äº†å®¢æˆ·ç«¯çš„è§’è‰²ä»¥åŠå®¢æˆ·ç«¯ç›®å‰æ‰€å¤„çš„çŠ¶æ€ï¼Œæ¯ä¸ªæ ‡å¿—ä½¿ç”¨ä¸€ä¸ªå¸¸é‡è¡¨ç¤º</p>
<ul>
<li>flags çš„å€¼å¯ä»¥æ˜¯å•ä¸ªæ ‡å¿—ï¼š<code>flags = &lt;flag&gt; </code></li>
<li>flags çš„å€¼å¯ä»¥æ˜¯å¤šä¸ªæ ‡å¿—çš„äºŒè¿›åˆ¶ï¼š<code>flags = &lt;flagl&gt; | &lt;flag2&gt; | ... </code></li>
</ul>
<p>ä¸€éƒ¨åˆ†æ ‡å¿—è®°å½•<strong>å®¢æˆ·ç«¯çš„è§’è‰²</strong>ï¼š</p>
<ul>
<li>REDIS_MASTER è¡¨ç¤ºå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªä»æœåŠ¡å™¨ï¼ŒREDIS_SLAVE è¡¨ç¤ºå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªä»æœåŠ¡å™¨ï¼Œåœ¨ä¸»ä»å¤åˆ¶æ—¶ä½¿ç”¨</li>
<li>REDIS_PRE_PSYNC è¡¨ç¤ºå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªç‰ˆæœ¬ä½äº Redis2.8 çš„ä»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨ä¸èƒ½ä½¿ç”¨ PSYNC å‘½ä»¤ä¸è¯¥ä»æœåŠ¡å™¨è¿›è¡ŒåŒæ­¥ï¼Œè¿™ä¸ªæ ‡å¿—åªèƒ½åœ¨ REDIS_ SLAVE æ ‡å¿—å¤„äºæ‰“å¼€çŠ¶æ€æ—¶ä½¿ç”¨</li>
<li>REDIS_LUA_CLIENT è¡¨ç¤ºå®¢æˆ·ç«¯æ˜¯ä¸“é—¨ç”¨äºå¤„ç† Lua è„šæœ¬é‡Œé¢åŒ…å«çš„ Redis å‘½ä»¤çš„ä¼ªå®¢æˆ·ç«¯</li>
</ul>
<p>ä¸€éƒ¨åˆ†æ ‡å¿—è®°å½•ç›®å‰<strong>å®¢æˆ·ç«¯æ‰€å¤„çš„çŠ¶æ€</strong>ï¼š</p>
<ul>
<li>REDIS_UNIX_SOCKET è¡¨ç¤ºæœåŠ¡å™¨ä½¿ç”¨ UNIX å¥—æ¥å­—æ¥è¿æ¥å®¢æˆ·ç«¯</li>
<li>REDIS_BLOCKED è¡¨ç¤ºå®¢æˆ·ç«¯æ­£åœ¨è¢« BRPOPã€BLPOP ç­‰å‘½ä»¤é˜»å¡</li>
<li>REDIS_UNBLOCKED è¡¨ç¤ºå®¢æˆ·ç«¯å·²ç»ä» REDIS_BLOCKED æ‰€è¡¨ç¤ºçš„é˜»å¡çŠ¶æ€è„±ç¦»ï¼Œåœ¨ REDIS_BLOCKED æ ‡å¿—æ‰“å¼€çš„æƒ…å†µä¸‹ä½¿ç”¨</li>
<li>REDIS_MULTI æ ‡å¿—è¡¨ç¤ºå®¢æˆ·ç«¯æ­£åœ¨æ‰§è¡Œäº‹åŠ¡</li>
<li>REDIS_DIRTY_CAS è¡¨ç¤ºäº‹åŠ¡ä½¿ç”¨ WATCH å‘½ä»¤ç›‘è§†çš„æ•°æ®åº“é”®å·²ç»è¢«ä¿®æ”¹</li>
<li>â€¦</li>
</ul>
<hr>
<h5 id="ç¼“å†²åŒº">ç¼“å†²åŒº</h5>
<p>å®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å…¥ç¼“å†²åŒºç”¨äºä¿å­˜å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤è¯·æ±‚ï¼Œè¾“å…¥ç¼“å†²åŒºçš„å¤§å°ä¼šæ ¹æ®è¾“å…¥å†…å®¹åŠ¨æ€åœ°ç¼©å°æˆ–è€…æ‰©å¤§ï¼Œä½†æœ€å¤§å¤§å°ä¸èƒ½è¶…è¿‡ 1GBï¼Œå¦åˆ™æœåŠ¡å™¨å°†å…³é—­è¿™ä¸ªå®¢æˆ·ç«¯ï¼Œæ¯”å¦‚æ‰§è¡Œ <code>SET key value </code>ï¼Œé‚£ä¹ˆç¼“å†²åŒº querybuf çš„å†…å®¹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*3\r\n<span class="variable">$3</span>\r\nSET\r\n<span class="variable">$3</span>\r\nkey\r\n<span class="variable">$5</span>\r\nvalue\r\n <span class="comment"># </span></span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç¼“å†²åŒºæ˜¯æœåŠ¡å™¨ç”¨äºä¿å­˜æ‰§è¡Œå®¢æˆ·ç«¯å‘½ä»¤æ‰€å¾—çš„å‘½ä»¤å›å¤ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯éƒ½æœ‰ä¸¤ä¸ªè¾“å‡ºç¼“å†²åŒºå¯ç”¨ï¼š</p>
<ul>
<li>ä¸€ä¸ªæ˜¯å›ºå®šå¤§å°çš„ç¼“å†²åŒºï¼Œä¿å­˜é•¿åº¦æ¯”è¾ƒå°çš„å›å¤ï¼Œæ¯”å¦‚ OKã€ç®€çŸ­çš„å­—ç¬¦ä¸²å€¼ã€æ•´æ•°å€¼ã€é”™è¯¯å›å¤ç­‰</li>
<li>ä¸€ä¸ªæ˜¯å¯å˜å¤§å°çš„ç¼“å†²åŒºï¼Œä¿å­˜é‚£äº›é•¿åº¦æ¯”è¾ƒå¤§çš„å›å¤ï¼Œ æ¯”å¦‚ä¸€ä¸ªéå¸¸é•¿çš„å­—ç¬¦ä¸²å€¼æˆ–è€…ä¸€ä¸ªåŒ…å«äº†å¾ˆå¤šå…ƒç´ çš„é›†åˆç­‰</li>
</ul>
<p>buf æ˜¯ä¸€ä¸ªå¤§å°ä¸º REDIS_REPLY_CHUNK_BYTES (å¸¸é‡é»˜è®¤ 16*1024 = 16KB) å­—èŠ‚çš„å­—èŠ‚æ•°ç»„ï¼Œbufpos å±æ€§è®°å½•äº† buf æ•°ç»„ç›®å‰å·²ä½¿ç”¨çš„å­—èŠ‚æ•°é‡ï¼Œå½“ buf æ•°ç»„çš„ç©ºé—´å·²ç»ç”¨å®Œæˆ–è€…å›å¤æ•°æ®å¤ªå¤§æ— æ³•æ”¾è¿› buf æ•°ç»„é‡Œï¼ŒæœåŠ¡å™¨å°±ä¼šå¼€å§‹ä½¿ç”¨å¯å˜å¤§å°çš„ç¼“å†²åŒº</p>
<p>é€šè¿‡ä½¿ç”¨ reply é“¾è¡¨è¿æ¥å¤šä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¯ä»¥ä¸ºå®¢æˆ·ç«¯ä¿å­˜ä¸€ä¸ªéå¸¸é•¿çš„å‘½ä»¤å›å¤ï¼Œè€Œä¸å¿…å—åˆ°å›ºå®šå¤§å°ç¼“å†²åŒº 16KB å¤§å°çš„é™åˆ¶</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%8F%AF%E5%8F%98%E8%BE%93%E5%87%BA%E7%BC%93%E5%86%B2%E5%8C%BA.png" alt=""></p>
<hr>
<h5 id="å‘½ä»¤">å‘½ä»¤</h5>
<p>æœåŠ¡å™¨å¯¹ querybuf ä¸­çš„å‘½ä»¤è¯·æ±‚çš„å†…å®¹è¿›è¡Œåˆ†æï¼Œå¾—å‡ºçš„å‘½ä»¤å‚æ•°ä»¥åŠå‚æ•°çš„æ•°é‡åˆ†åˆ«ä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„ argv å’Œ argc å±æ€§</p>
<ul>
<li>argv å±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯é¡¹éƒ½æ˜¯å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå…¶ä¸­ argv[0] æ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œè€Œä¹‹åçš„å…¶ä»–é¡¹åˆ™æ˜¯å‘½ä»¤çš„å‚æ•°</li>
<li>argc å±æ€§è´Ÿè´£è®°å½• argv æ•°ç»„çš„é•¿åº¦</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‘½ä»¤æ•°ç»„.png" style="zoom: 67%;" />
<p>æœåŠ¡å™¨å°†æ ¹æ®é¡¹ argv[0] çš„å€¼ï¼Œåœ¨å‘½ä»¤è¡¨ä¸­æŸ¥æ‰¾å‘½ä»¤æ‰€å¯¹åº”çš„å‘½ä»¤çš„ redisCommandï¼Œå°†å®¢æˆ·ç«¯çŠ¶æ€çš„ cmd æŒ‡å‘è¯¥ç»“æ„</p>
<p>å‘½ä»¤è¡¨æ˜¯ä¸€ä¸ªå­—å…¸ç»“æ„ï¼Œé”®æ˜¯ SDS ç»“æ„ä¿å­˜å‘½ä»¤çš„åå­—ï¼›å€¼æ˜¯å‘½ä»¤æ‰€å¯¹åº”çš„ redisCommand ç»“æ„ï¼Œä¿å­˜äº†å‘½ä»¤çš„å®ç°å‡½æ•°ã€å‘½ä»¤æ ‡å¿—ã€ å‘½ä»¤åº”è¯¥ç»™å®šçš„å‚æ•°ä¸ªæ•°ã€å‘½ä»¤çš„æ€»æ‰§è¡Œæ¬¡æ•°å’Œæ€»æ¶ˆè€—æ—¶é•¿ç­‰ç»Ÿè®¡ä¿¡æ¯</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‘½ä»¤æŸ¥æ‰¾.png" style="zoom:67%;" />
<hr>
<h5 id="éªŒè¯">éªŒè¯</h5>
<p>å®¢æˆ·ç«¯çŠ¶æ€çš„ authenticated å±æ€§ç”¨äºè®°å½•å®¢æˆ·ç«¯æ˜¯å¦é€šè¿‡äº†èº«ä»½éªŒè¯</p>
<ul>
<li>authenticated å€¼ä¸º 0ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯æœªé€šè¿‡èº«ä»½éªŒè¯</li>
<li>authenticated å€¼ä¸º 1ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯å·²é€šè¿‡èº«ä»½éªŒè¯</li>
</ul>
<p>å½“å®¢æˆ·ç«¯ authenticated = 0 æ—¶ï¼Œé™¤äº† AUTH å‘½ä»¤ä¹‹å¤–ï¼Œ å®¢æˆ·ç«¯å‘é€çš„æ‰€æœ‰å…¶ä»–å‘½ä»¤éƒ½ä¼šè¢«æœåŠ¡å™¨æ‹’ç»æ‰§è¡Œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; PING </span><br><span class="line">(error) NOAUTH Authentication required.</span><br><span class="line">redis&gt; AUTH 123321 </span><br><span class="line">OK</span><br><span class="line">redis&gt; PING </span><br><span class="line">PONG </span><br></pre></td></tr></table></figure>
<hr>
<h5 id="æ—¶é—´">æ—¶é—´</h5>
<p>ctime å±æ€§è®°å½•äº†åˆ›å»ºå®¢æˆ·ç«¯çš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´å¯ä»¥ç”¨æ¥è®¡ç®—å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å·²ç»è¿æ¥äº†å¤šå°‘ç§’ï¼Œ<code>CLIENT list</code> å‘½ä»¤çš„ age åŸŸè®°å½•äº†è¿™ä¸ªç§’æ•°</p>
<p>lastinteraction å±æ€§è®°å½•äº†å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨æœ€åä¸€æ¬¡è¿›è¡Œäº’åŠ¨ (interaction) çš„æ—¶é—´ï¼Œäº’åŠ¨å¯ä»¥æ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€å‘½ä»¤è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€å‘½ä»¤å›å¤ã€‚è¯¥å±æ€§å¯ä»¥ç”¨æ¥è®¡ç®—å®¢æˆ·ç«¯çš„ç©ºè½¬ (idle) æ—¶é•¿ï¼Œ å°±æ˜¯è·ç¦»å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨æœ€åä¸€æ¬¡è¿›è¡Œäº’åŠ¨å·²ç»è¿‡å»äº†å¤šå°‘ç§’ï¼Œ<code>CLIENT list</code> å‘½ä»¤çš„ idle åŸŸè®°å½•äº†è¿™ä¸ªç§’æ•°</p>
<p>obuf_soft_limit_reached_time å±æ€§è®°å½•äº†<strong>è¾“å‡ºç¼“å†²åŒºç¬¬ä¸€æ¬¡åˆ°è¾¾è½¯æ€§é™åˆ¶</strong> (soft limit) çš„æ—¶é—´</p>
<h4 id="ç”Ÿå‘½å‘¨æœŸ">ç”Ÿå‘½å‘¨æœŸ</h4>
<h5 id="åˆ›å»º">åˆ›å»º</h5>
<p>æœåŠ¡å™¨ä½¿ç”¨ä¸åŒçš„æ–¹å¼æ¥åˆ›å»ºå’Œå…³é—­ä¸åŒç±»å‹çš„å®¢æˆ·ç«¯</p>
<p>å¦‚æœå®¢æˆ·ç«¯æ˜¯é€šè¿‡ç½‘ç»œè¿æ¥ä¸æœåŠ¡å™¨è¿›è¡Œè¿æ¥çš„æ™®é€šå®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆåœ¨å®¢æˆ·ç«¯ä½¿ç”¨ connect å‡½æ•°è¿æ¥åˆ°æœåŠ¡å™¨æ—¶ï¼ŒæœåŠ¡å™¨å°±ä¼šè°ƒç”¨è¿æ¥åº”ç­”å¤„ç†å™¨ä¸ºå®¢æˆ·ç«¯åˆ›å»ºç›¸åº”çš„å®¢æˆ·ç«¯çŠ¶æ€ï¼Œå¹¶å°†è¿™ä¸ªæ–°çš„å®¢æˆ·ç«¯çŠ¶æ€æ·»åŠ åˆ°æœåŠ¡å™¨çŠ¶æ€ç»“æ„ clients é“¾è¡¨çš„æœ«å°¾</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E6%9C%8D%E5%8A%A1%E5%99%A8clients%E9%93%BE%E8%A1%A8.png" alt=""></p>
<p>æœåŠ¡å™¨ä¼šåœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºè´Ÿè´£æ‰§è¡Œ Lua è„šæœ¬ä¸­åŒ…å«çš„ Redis å‘½ä»¤çš„ä¼ªå®¢æˆ·ç«¯ï¼Œå¹¶å°†ä¼ªå®¢æˆ·ç«¯å…³è”åœ¨æœåŠ¡å™¨çŠ¶æ€çš„ lua_client å±æ€§</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼ªå®¢æˆ·ç«¯</span></span><br><span class="line">    redisClient *lua_clientï¼›</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>lua_client ä¼ªå®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨è¿è¡Œçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¼šä¸€ç›´å­˜åœ¨ï¼Œåªæœ‰æœåŠ¡å™¨è¢«å…³é—­æ—¶ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯æ‰ä¼šè¢«å…³é—­</p>
<p>è½½å…¥ AOF æ–‡ä»¶æ—¶ï¼Œ æœåŠ¡å™¨ä¼šåˆ›å»ºç”¨äºæ‰§è¡Œ AOF æ–‡ä»¶åŒ…å«çš„ Redis å‘½ä»¤çš„ä¼ªå®¢æˆ·ç«¯ï¼Œå¹¶åœ¨è½½å…¥å®Œæˆä¹‹åï¼Œå…³é—­è¿™ä¸ªä¼ªå®¢æˆ·ç«¯</p>
<hr>
<h5 id="å…³é—­">å…³é—­</h5>
<p>ä¸€ä¸ªæ™®é€šå®¢æˆ·ç«¯å¯ä»¥å› ä¸ºå¤šç§åŸå› è€Œè¢«å…³é—­ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯è¿›ç¨‹é€€å‡ºæˆ–è€…è¢«æ€æ­»ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œè¿æ¥å°†è¢«å…³é—­ï¼Œä»è€Œé€ æˆå®¢æˆ·ç«¯è¢«å…³é—­</li>
<li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€äº†å¸¦æœ‰ä¸ç¬¦åˆåè®®æ ¼å¼çš„å‘½ä»¤è¯·æ±‚ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¢æˆ·ç«¯ä¼š<strong>è¢«æœåŠ¡å™¨å…³é—­</strong></li>
<li>å®¢æˆ·ç«¯æ˜¯ <code>CLIENT KILL</code> å‘½ä»¤çš„ç›®æ ‡</li>
<li>å¦‚æœç”¨æˆ·ä¸ºæœåŠ¡å™¨è®¾ç½®äº† timeout é…ç½®é€‰é¡¹ï¼Œé‚£ä¹ˆå½“å®¢æˆ·ç«¯çš„ç©ºè½¬æ—¶é—´è¶…è¿‡è¯¥å€¼æ—¶å°†è¢«å…³é—­ï¼Œç‰¹æ®Šæƒ…å†µä¸ä¼šè¢«å…³é—­ï¼š
<ul>
<li>å®¢æˆ·ç«¯æ˜¯ä¸»æœåŠ¡å™¨ï¼ˆREDIS_MASTER ï¼‰æˆ–è€…ä»æœåŠ¡å™¨ï¼ˆæ‰“å¼€äº† REDIS_SLAVE æ ‡å¿—ï¼‰</li>
<li>æ­£åœ¨è¢« BLPOP ç­‰å‘½ä»¤é˜»å¡ï¼ˆREDIS_BLOCKEDï¼‰</li>
<li>æ­£åœ¨æ‰§è¡Œ SUBSCRIBEã€PSUBSCRIBE ç­‰è®¢é˜…å‘½ä»¤</li>
</ul>
</li>
<li>å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤è¯·æ±‚çš„å¤§å°è¶…è¿‡äº†è¾“å…¥ç¼“å†²åŒºçš„é™åˆ¶å¤§å°ï¼ˆé»˜è®¤ä¸º 1GBï¼‰</li>
<li>å‘é€ç»™å®¢æˆ·ç«¯çš„å‘½ä»¤å›å¤çš„å¤§å°è¶…è¿‡äº†è¾“å‡ºç¼“å†²åŒºçš„é™åˆ¶å¤§å°</li>
</ul>
<p>ç†è®ºä¸Šæ¥è¯´ï¼Œå¯å˜ç¼“å†²åŒºå¯ä»¥ä¿å­˜ä»»æ„é•¿çš„å‘½ä»¤å›å¤ï¼Œä½†æ˜¯ä¸ºäº†å›å¤è¿‡å¤§å ç”¨è¿‡å¤šçš„æœåŠ¡å™¨èµ„æºï¼ŒæœåŠ¡å™¨ä¼šæ—¶åˆ»æ£€æŸ¥å®¢æˆ·ç«¯çš„è¾“å‡ºç¼“å†²åŒºçš„å¤§å°ï¼Œå¹¶åœ¨ç¼“å†²åŒºçš„å¤§å°è¶…å‡ºèŒƒå›´æ—¶ï¼Œæ‰§è¡Œç›¸åº”çš„é™åˆ¶æ“ä½œï¼š</p>
<ul>
<li>ç¡¬æ€§é™åˆ¶ (hard limit)ï¼šè¾“å‡ºç¼“å†²åŒºçš„å¤§å°è¶…è¿‡äº†ç¡¬æ€§é™åˆ¶æ‰€è®¾ç½®çš„å¤§å°ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šå…³é—­å®¢æˆ·ç«¯ï¼ˆserverCron å‡½æ•°ä¸­æ‰§è¡Œï¼‰ï¼Œç§¯å­˜åœ¨è¾“å‡ºç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹ä¼šè¢«<strong>ç›´æ¥é‡Šæ”¾</strong>ï¼Œä¸ä¼šè¿”å›ç»™å®¢æˆ·ç«¯</li>
<li>è½¯æ€§é™åˆ¶ (soft limit)ï¼šè¾“å‡ºç¼“å†²åŒºçš„å¤§å°è¶…è¿‡äº†è½¯æ€§é™åˆ¶æ‰€è®¾ç½®çš„å¤§å°ï¼Œå°äºç¡¬æ€§é™åˆ¶çš„å¤§å°ï¼ŒæœåŠ¡å™¨çš„æ“ä½œï¼š
<ul>
<li>ç”¨å±æ€§ obuf_soft_limit_reached_time è®°å½•ä¸‹å®¢æˆ·ç«¯åˆ°è¾¾è½¯æ€§é™åˆ¶çš„èµ·å§‹æ—¶é—´ï¼Œç»§ç»­ç›‘è§†å®¢æˆ·ç«¯</li>
<li>å¦‚æœè¾“å‡ºç¼“å†²åŒºçš„å¤§å°ä¸€ç›´è¶…å‡ºè½¯æ€§é™åˆ¶ï¼Œå¹¶ä¸”æŒç»­æ—¶é—´è¶…è¿‡æœåŠ¡å™¨è®¾å®šçš„æ—¶é•¿ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°†å…³é—­å®¢æˆ·ç«¯</li>
<li>å¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…ä¸å†è¶…å‡ºè½¯æ€§é™åˆ¶ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å°±ä¸ä¼šè¢«å…³é—­ï¼Œå¹¶ä¸” o_s_l_r_t å±æ€§æ¸…é›¶</li>
</ul>
</li>
</ul>
<p>ä½¿ç”¨ client-output-buffer-limit é€‰é¡¹å¯ä»¥ä¸ºæ™®é€šå®¢æˆ·ç«¯ã€ä»æœåŠ¡å™¨å®¢æˆ·ç«¯ã€æ‰§è¡Œå‘å¸ƒä¸è®¢é˜…åŠŸèƒ½çš„å®¢æˆ·ç«¯åˆ†åˆ«è®¾ç½®ä¸åŒçš„è½¯æ€§é™åˆ¶å’Œç¡¬æ€§é™åˆ¶ï¼Œæ ¼å¼ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">client-output-buffer-limit &lt;class&gt; &lt;hard <span class="built_in">limit</span>&gt; &lt;soft <span class="built_in">limit</span>&gt; &lt;soft seconds&gt;</span><br><span class="line"></span><br><span class="line">client-output-buffer-limit normal 0 0 0 </span><br><span class="line">client-output-buffer-limit slave 256mb 64mb 60 </span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br></pre></td></tr></table></figure>
<ul>
<li>ç¬¬ä¸€è¡Œï¼šå°†æ™®é€šå®¢æˆ·ç«¯çš„ç¡¬æ€§é™åˆ¶å’Œè½¯æ€§é™åˆ¶éƒ½è®¾ç½®ä¸º 0ï¼Œè¡¨ç¤ºä¸é™åˆ¶å®¢æˆ·ç«¯çš„è¾“å‡ºç¼“å†²åŒºå¤§å°</li>
<li>ç¬¬äºŒè¡Œï¼šå°†ä»æœåŠ¡å™¨å®¢æˆ·ç«¯çš„ç¡¬æ€§é™åˆ¶è®¾ç½®ä¸º 256MBï¼Œè½¯æ€§é™åˆ¶è®¾ç½®ä¸º 64MBï¼Œè½¯æ€§é™åˆ¶çš„æ—¶é•¿ä¸º 60 ç§’</li>
<li>ç¬¬ä¸‰è¡Œï¼šå°†æ‰§è¡Œå‘å¸ƒä¸è®¢é˜…åŠŸèƒ½çš„å®¢æˆ·ç«¯çš„ç¡¬æ€§é™åˆ¶è®¾ç½®ä¸º 32MBï¼Œè½¯æ€§é™åˆ¶è®¾ç½®ä¸º 8MBï¼Œè½¯æ€§é™åˆ¶çš„æ—¶é•¿ä¸º 60 ç§’</li>
</ul>
<hr>
<h3 id="æœåŠ¡å™¨-3">æœåŠ¡å™¨</h3>
<h4 id="æ‰§è¡Œæµç¨‹">æ‰§è¡Œæµç¨‹</h4>
<p>Redis æœåŠ¡å™¨ä¸å¤šä¸ªå®¢æˆ·ç«¯å»ºç«‹ç½‘ç»œè¿æ¥ï¼Œå¤„ç†å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤è¯·æ±‚ï¼Œåœ¨æ•°æ®åº“ä¸­ä¿å­˜å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤æ‰€äº§ç”Ÿçš„æ•°æ®ï¼Œå¹¶é€šè¿‡èµ„æºç®¡ç†æ¥ç»´æŒæœåŠ¡å™¨è‡ªèº«çš„è¿è½¬ï¼Œæ‰€ä»¥ä¸€ä¸ªå‘½ä»¤è¯·æ±‚ä»å‘é€åˆ°è·å¾—å›å¤çš„è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éœ€è¦å®Œæˆä¸€ç³»åˆ—æ“ä½œ</p>
<h5 id="å‘½ä»¤è¯·æ±‚">å‘½ä»¤è¯·æ±‚</h5>
<p>Redis æœåŠ¡å™¨çš„å‘½ä»¤è¯·æ±‚æ¥è‡ª Redis å®¢æˆ·ç«¯ï¼Œå½“ç”¨æˆ·åœ¨å®¢æˆ·ç«¯ä¸­é”®å…¥ä¸€ä¸ªå‘½ä»¤è¯·æ±‚æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šå°†è¿™ä¸ªå‘½ä»¤è¯·æ±‚è½¬æ¢æˆåè®®æ ¼å¼ï¼Œé€šè¿‡è¿æ¥åˆ°æœåŠ¡å™¨çš„å¥—æ¥å­—ï¼Œå°†åè®®æ ¼å¼çš„å‘½ä»¤è¯·æ±‚å‘é€ç»™æœåŠ¡å™¨</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET KEY VALUE -&gt;	<span class="comment"># å‘½ä»¤</span></span><br><span class="line">*3\r\nS3\r\nSET\r\n<span class="variable">$3</span>\r\nKEY\r\n<span class="variable">$5</span>\r\nVALUE\r\n	<span class="comment"># åè®®æ ¼å¼</span></span><br></pre></td></tr></table></figure>
<p>å½“å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å¥—æ¥å­—å› ä¸ºå®¢æˆ·ç«¯çš„å†™å…¥è€Œå˜å¾—å¯è¯»ï¼ŒæœåŠ¡å™¨è°ƒç”¨<strong>å‘½ä»¤è¯·æ±‚å¤„ç†å™¨</strong>æ¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ul>
<li>è¯»å–å¥—æ¥å­—ä¸­åè®®æ ¼å¼çš„å‘½ä»¤è¯·æ±‚ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å…¥ç¼“å†²åŒºé‡Œé¢</li>
<li>å¯¹è¾“å…¥ç¼“å†²åŒºä¸­çš„å‘½ä»¤è¯·æ±‚è¿›è¡Œåˆ†æï¼Œæå–å‡ºå‘½ä»¤è¯·æ±‚ä¸­åŒ…å«çš„å‘½ä»¤å‚æ•°ä»¥åŠå‘½ä»¤å‚æ•°çš„ä¸ªæ•°ï¼Œç„¶ååˆ†åˆ«å°†å‚æ•°å’Œå‚æ•°ä¸ªæ•°ä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„ argv å±æ€§å’Œ argc å±æ€§é‡Œ</li>
<li>è°ƒç”¨å‘½ä»¤æ‰§è¡Œå™¨ï¼Œæ‰§è¡Œå®¢æˆ·ç«¯æŒ‡å®šçš„å‘½ä»¤</li>
</ul>
<p>æœ€åå®¢æˆ·ç«¯æ¥æ”¶åˆ°åè®®æ ¼å¼çš„å‘½ä»¤å›å¤ä¹‹åï¼Œä¼šå°†è¿™äº›å›å¤è½¬æ¢æˆç”¨æˆ·å¯è¯»çš„æ ¼å¼æ‰“å°ç»™ç”¨æˆ·è§‚çœ‹ï¼Œè‡³æ­¤æ•´ä½“æµç¨‹ç»“æŸ</p>
<hr>
<h5 id="å‘½ä»¤æ‰§è¡Œ">å‘½ä»¤æ‰§è¡Œ</h5>
<p>å‘½ä»¤æ‰§è¡Œå™¨å¼€å§‹å¯¹å‘½ä»¤æ“ä½œï¼š</p>
<ul>
<li>
<p>æŸ¥æ‰¾å‘½ä»¤ï¼šé¦–å…ˆæ ¹æ®å®¢æˆ·ç«¯çŠ¶æ€çš„ argv[0] å‚æ•°ï¼Œåœ¨<strong>å‘½ä»¤è¡¨ (command table)</strong> ä¸­æŸ¥æ‰¾å‚æ•°æ‰€æŒ‡å®šçš„å‘½ä»¤ï¼Œå¹¶å°†æ‰¾åˆ°çš„å‘½ä»¤ä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„ cmd å±æ€§é‡Œé¢ï¼Œæ˜¯ä¸€ä¸ª redisCommand ç»“æ„</p>
<p>å‘½ä»¤æŸ¥æ‰¾ç®—æ³•ä¸å­—æ¯çš„å¤§å°å†™æ— å…³ï¼Œæ‰€ä»¥å‘½ä»¤åå­—çš„å¤§å°å†™ä¸å½±å“å‘½ä»¤è¡¨çš„æŸ¥æ‰¾ç»“æœ</p>
</li>
<li>
<p>æ‰§è¡Œé¢„å¤‡æ“ä½œï¼š</p>
<ul>
<li>æ£€æŸ¥å®¢æˆ·ç«¯çŠ¶æ€çš„ cmd æŒ‡é’ˆæ˜¯å¦æŒ‡å‘ NULLï¼Œæ ¹æ® redisCommand æ£€æŸ¥è¯·æ±‚å‚æ•°çš„æ•°é‡æ˜¯å¦æ­£ç¡®</li>
<li>æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦é€šè¿‡èº«ä»½éªŒè¯</li>
<li>å¦‚æœæœåŠ¡å™¨æ‰“å¼€äº† maxmemory åŠŸèƒ½ï¼Œæ‰§è¡Œå‘½ä»¤ä¹‹å‰è¦å…ˆæ£€æŸ¥æœåŠ¡å™¨çš„å†…å­˜å ç”¨ï¼Œåœ¨æœ‰éœ€è¦æ—¶è¿›è¡Œå†…å­˜å›æ”¶ï¼ˆ<strong>é€å‡ºç®—æ³•</strong>ï¼‰</li>
<li>å¦‚æœæœåŠ¡å™¨ä¸Šä¸€æ¬¡æ‰§è¡Œ BGSAVE å‘½ä»¤å‡ºé”™ï¼Œå¹¶ä¸”æœåŠ¡å™¨æ‰“å¼€äº† stop-writes-on-bgsave-error åŠŸèƒ½ï¼Œé‚£ä¹ˆå¦‚æœæœ¬æ¬¡æ‰§è¡Œçš„æ˜¯å†™å‘½ä»¤ï¼ŒæœåŠ¡ä¼šæ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›é”™è¯¯</li>
<li>å¦‚æœå®¢æˆ·ç«¯å½“å‰æ­£åœ¨ç”¨ SUBSCRIBE æˆ– PSUBSCRIBE å‘½ä»¤è®¢é˜…é¢‘é“ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šæ‹’ç»é™¤äº† SUBSCRIBEã€SUBSCRIBEã€ UNSUBSCRIBEã€PUNSUBSCRIBE ä¹‹å¤–çš„å…¶ä»–å‘½ä»¤</li>
<li>å¦‚æœæœåŠ¡å™¨æ­£åœ¨è¿›è¡Œè½½å…¥æ•°æ®ï¼Œåªæœ‰ sflags å¸¦æœ‰ 1 æ ‡è¯†ï¼ˆæ¯”å¦‚ INFOã€SHUTDOWNã€PUBLISHç­‰ï¼‰çš„å‘½ä»¤æ‰ä¼šè¢«æ‰§è¡Œ</li>
<li>å¦‚æœæœåŠ¡å™¨æ‰§è¡Œ Lua è„šæœ¬è€Œè¶…æ—¶å¹¶è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œé‚£ä¹ˆåªä¼šæ‰§è¡Œå®¢æˆ·ç«¯å‘æ¥çš„ SHUTDOWN nosave å’Œ SCRIPT KILL å‘½ä»¤</li>
<li>å¦‚æœå®¢æˆ·ç«¯æ­£åœ¨æ‰§è¡Œäº‹åŠ¡ï¼Œé‚£ä¹ˆæœåŠ¡å™¨åªä¼šæ‰§è¡Œå®¢æˆ·ç«¯å‘æ¥çš„ EXECã€DISCARDã€MULTIã€WATCH å››ä¸ªå‘½ä»¤ï¼Œå…¶ä»–å‘½ä»¤éƒ½ä¼šè¢«<strong>æ”¾è¿›äº‹åŠ¡é˜Ÿåˆ—</strong>ä¸­</li>
<li>å¦‚æœæœåŠ¡å™¨æ‰“å¼€äº†ç›‘è§†å™¨åŠŸèƒ½ï¼Œé‚£ä¹ˆä¼šå°†è¦æ‰§è¡Œçš„å‘½ä»¤å’Œå‚æ•°ç­‰ä¿¡æ¯å‘é€ç»™ç›‘è§†å™¨</li>
</ul>
</li>
<li>
<p>è°ƒç”¨å‘½ä»¤çš„å®ç°å‡½æ•°ï¼šè¢«è°ƒç”¨çš„å‡½æ•°ä¼šæ‰§è¡ŒæŒ‡å®šçš„æ“ä½œå¹¶äº§ç”Ÿç›¸åº”çš„å‘½ä»¤å›å¤ï¼Œå›å¤ä¼šè¢«ä¿å­˜åœ¨å®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å‡ºç¼“å†²åŒºé‡Œé¢ï¼ˆbuf å’Œ reply å±æ€§ï¼‰ï¼Œç„¶åå®ç°å‡½æ•°è¿˜ä¼š<strong>ä¸ºå®¢æˆ·ç«¯çš„å¥—æ¥å­—å…³è”å‘½ä»¤å›å¤å¤„ç†å™¨</strong>ï¼Œè¿™ä¸ªå¤„ç†å™¨è´Ÿè´£å°†å‘½ä»¤å›å¤è¿”å›ç»™å®¢æˆ·ç«¯</p>
</li>
<li>
<p>æ‰§è¡Œåç»­å·¥ä½œï¼š</p>
<ul>
<li>å¦‚æœæœåŠ¡å™¨å¼€å¯äº†æ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½ï¼Œé‚£ä¹ˆæ…¢æŸ¥è¯¢æ—¥å¿—æ¨¡å—ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦ä¸ºåˆšåˆšæ‰§è¡Œå®Œçš„å‘½ä»¤è¯·æ±‚æ·»åŠ ä¸€æ¡æ–°çš„æ…¢æŸ¥è¯¢æ—¥å¿—</li>
<li>æ ¹æ®æ‰§è¡Œå‘½ä»¤æ‰€è€—è´¹çš„æ—¶é•¿ï¼Œæ›´æ–°å‘½ä»¤çš„ redisCommand ç»“æ„çš„ milliseconds å±æ€§ï¼Œå¹¶å°†å‘½ä»¤ calls è®¡æ•°å™¨çš„å€¼å¢ä¸€</li>
<li>å¦‚æœæœåŠ¡å™¨å¼€å¯äº† AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£ä¹ˆ AOF æŒä¹…åŒ–æ¨¡å—ä¼šå°†æ‰§è¡Œçš„å‘½ä»¤è¯·æ±‚å†™å…¥åˆ° AOF ç¼“å†²åŒºé‡Œé¢</li>
<li>å¦‚æœæœ‰å…¶ä»–ä»æœåŠ¡å™¨æ­£åœ¨å¤åˆ¶å½“å‰è¿™ä¸ªæœåŠ¡å™¨ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šå°†æ‰§è¡Œçš„å‘½ä»¤ä¼ æ’­ç»™æ‰€æœ‰ä»æœåŠ¡å™¨</li>
</ul>
</li>
<li>
<p>å°†å‘½ä»¤å›å¤å‘é€ç»™å®¢æˆ·ç«¯ï¼šå®¢æˆ·ç«¯<strong>å¥—æ¥å­—å˜ä¸ºå¯å†™çŠ¶æ€</strong>æ—¶ï¼ŒæœåŠ¡å™¨å°±ä¼šæ‰§è¡Œå‘½ä»¤å›å¤å¤„ç†å™¨ï¼Œå°†å®¢æˆ·ç«¯è¾“å‡ºç¼“å†²åŒºä¸­çš„å‘½ä»¤å›å¤å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå‘é€å®Œæ¯•ä¹‹åå›å¤å¤„ç†å™¨ä¼šæ¸…ç©ºå®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å‡ºç¼“å†²åŒºï¼Œä¸ºå¤„ç†ä¸‹ä¸€ä¸ªå‘½ä»¤è¯·æ±‚åšå¥½å‡†å¤‡</p>
</li>
</ul>
<hr>
<h5 id="Command">Command</h5>
<p>æ¯ä¸ª redisCommand ç»“æ„è®°å½•äº†ä¸€ä¸ªRedis å‘½ä»¤çš„å®ç°ä¿¡æ¯ï¼Œä¸»è¦å±æ€§</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisCommand</span> &#123;</span></span><br><span class="line">    <span class="comment">// å‘½ä»¤çš„åå­—ï¼Œæ¯”å¦‚&quot;set&quot;</span></span><br><span class="line">    <span class="type">char</span> *name;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘å‘½ä»¤çš„å®ç°å‡½æ•°ï¼Œæ¯”å¦‚setCommand</span></span><br><span class="line">    <span class="comment">// redisCommandProc ç±»å‹çš„å®šä¹‰ä¸º typedef void redisCommandProc(redisClient *c)</span></span><br><span class="line">    redisCommandProc *proc;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘½ä»¤å‚æ•°çš„ä¸ªæ•°ï¼Œç”¨äºæ£€æŸ¥å‘½ä»¤è¯·æ±‚çš„æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚å¦‚æœè¿™ä¸ªå€¼ä¸ºè´Ÿæ•°-N, é‚£ä¹ˆè¡¨ç¤ºå‚æ•°çš„æ•°é‡å¤§äºç­‰äºNã€‚</span></span><br><span class="line">    <span class="comment">// æ³¨æ„å‘½ä»¤çš„åå­—æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå‚æ•°ï¼Œæ¯”å¦‚ SET msg &quot;hello&quot;ï¼Œå‘½ä»¤çš„å‚æ•°æ˜¯&quot;SET&quot;ã€&quot;msg&quot;ã€&quot;hello&quot; ä¸‰ä¸ª</span></span><br><span class="line">	<span class="type">int</span> arity;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å­—ç¬¦ä¸²å½¢å¼çš„æ ‡è¯†å€¼ï¼Œè¿™ä¸ªå€¼è®°å½•äº†å‘½ä»¤çš„å±æ€§ï¼Œï¼Œ</span></span><br><span class="line">    <span class="comment">// æ¯”å¦‚è¿™ä¸ªå‘½ä»¤æ˜¯å†™å‘½ä»¤è¿˜æ˜¯è¯»å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤æ˜¯å¦å…è®¸åœ¨è½½å…¥æ•°æ®æ—¶ä½¿ç”¨ï¼Œæ˜¯å¦å…è®¸åœ¨Luaè„šæœ¬ä¸­ä½¿ç”¨ç­‰ç­‰</span></span><br><span class="line">    <span class="type">char</span> *sflags;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¯¹sflagsæ ‡è¯†è¿›è¡Œåˆ†æå¾—å‡ºçš„äºŒè¿›åˆ¶æ ‡è¯†ï¼Œç”±ç¨‹åºè‡ªåŠ¨ç”Ÿæˆã€‚æœåŠ¡å™¨å¯¹å‘½ä»¤æ ‡è¯†è¿›è¡Œæ£€æŸ¥æ—¶ä½¿ç”¨çš„éƒ½æ˜¯ flags å±æ€§</span></span><br><span class="line">    <span class="comment">// è€Œä¸æ˜¯sflagså±æ€§ï¼Œå› ä¸ºå¯¹äºŒè¿›åˆ¶æ ‡è¯†çš„æ£€æŸ¥å¯ä»¥æ–¹ä¾¿åœ°é€šè¿‡&amp; ^ ~ ç­‰æ“ä½œæ¥å®Œæˆ</span></span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨æ€»å…±æ‰§è¡Œäº†å¤šå°‘æ¬¡è¿™ä¸ªå‘½ä»¤</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> calls;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨æ‰§è¡Œè¿™ä¸ªå‘½ä»¤æ‰€è€—è´¹çš„æ€»æ—¶é•¿</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> milliseconds;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="serverCron">serverCron</h4>
<h5 id="åŸºæœ¬ä»‹ç»-4">åŸºæœ¬ä»‹ç»</h5>
<p>Redis æœåŠ¡å™¨ä»¥å‘¨æœŸæ€§äº‹ä»¶çš„æ–¹å¼æ¥è¿è¡Œ serverCron å‡½æ•°ï¼ŒæœåŠ¡å™¨åˆå§‹åŒ–æ—¶è¯»å–é…ç½® server.hz çš„å€¼ï¼Œé»˜è®¤ä¸º 10ï¼Œä»£è¡¨æ¯ç§’é’Ÿæ‰§è¡Œ 10 æ¬¡ï¼Œå³<strong>æ¯éš” 100 æ¯«ç§’æ‰§è¡Œä¸€æ¬¡</strong>ï¼Œæ‰§è¡ŒæŒ‡ä»¤ info server å¯ä»¥æŸ¥çœ‹</p>
<p>serverCron å‡½æ•°è´Ÿè´£å®šæœŸå¯¹è‡ªèº«çš„èµ„æºå’ŒçŠ¶æ€è¿›è¡Œæ£€æŸ¥å’Œè°ƒæ•´ï¼Œä»è€Œç¡®ä¿æœåŠ¡å™¨å¯ä»¥é•¿æœŸã€ç¨³å®šåœ°è¿è¡Œ</p>
<ul>
<li>æ›´æ–°æœåŠ¡å™¨çš„å„ç±»ç»Ÿè®¡ä¿¡æ¯ï¼Œæ¯”å¦‚æ—¶é—´ã€å†…å­˜å ç”¨ã€ æ•°æ®åº“å ç”¨æƒ…å†µç­‰</li>
<li>æ¸…ç†æ•°æ®åº“ä¸­çš„è¿‡æœŸé”®å€¼å¯¹</li>
<li>å…³é—­å’Œæ¸…ç†è¿æ¥å¤±æ•ˆçš„å®¢æˆ·ç«¯</li>
<li>è¿›è¡Œ AOF æˆ– RDB æŒä¹…åŒ–æ“ä½œ</li>
<li>å¦‚æœæœåŠ¡å™¨æ˜¯ä¸»æœåŠ¡å™¨ï¼Œé‚£ä¹ˆå¯¹ä»æœåŠ¡å™¨è¿›è¡Œå®šæœŸåŒæ­¥</li>
<li>å¦‚æœå¤„äºé›†ç¾¤æ¨¡å¼ï¼Œå¯¹é›†ç¾¤è¿›è¡Œå®šæœŸåŒæ­¥å’Œè¿æ¥æµ‹è¯•</li>
</ul>
<hr>
<h5 id="æ—¶é—´ç¼“å­˜">æ—¶é—´ç¼“å­˜</h5>
<p>Redis æœåŠ¡å™¨ä¸­æœ‰å¾ˆå¤šåŠŸèƒ½éœ€è¦è·å–ç³»ç»Ÿçš„å½“å‰æ—¶é—´ï¼Œè€Œæ¯æ¬¡è·å–ç³»ç»Ÿçš„å½“å‰æ—¶é—´éƒ½éœ€è¦æ‰§è¡Œä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œä¸ºäº†å‡å°‘ç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œæ¬¡æ•°ï¼ŒæœåŠ¡å™¨çŠ¶æ€ä¸­çš„ unixtime å±æ€§å’Œ mstime å±æ€§è¢«ç”¨ä½œå½“å‰æ—¶é—´çš„ç¼“å­˜</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="comment">// ä¿å­˜äº†ç§’çº§ç²¾åº¦çš„ç³»ç»Ÿå½“å‰UNIXæ—¶é—´æˆ³</span></span><br><span class="line">    <span class="type">time_t</span> unixtime;</span><br><span class="line">	<span class="comment">// ä¿å­˜äº†æ¯«ç§’çº§ç²¾åº¦çš„ç³»ç»Ÿå½“å‰UNIXæ—¶é—´æˆ³ </span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> mstime;</span><br><span class="line">    </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>serverCron å‡½æ•°é»˜è®¤ä»¥æ¯ 100 æ¯«ç§’ä¸€æ¬¡çš„é¢‘ç‡æ›´æ–°ä¸¤ä¸ªå±æ€§ï¼Œæ‰€ä»¥å±æ€§è®°å½•çš„æ—¶é—´çš„ç²¾ç¡®åº¦å¹¶ä¸é«˜</p>
<ul>
<li>æœåŠ¡å™¨åªä¼šåœ¨æ‰“å°æ—¥å¿—ã€æ›´æ–°æœåŠ¡å™¨çš„ LRU æ—¶é’Ÿã€å†³å®šæ˜¯å¦æ‰§è¡ŒæŒä¹…åŒ–ä»»åŠ¡ã€è®¡ç®—æœåŠ¡å™¨ä¸Šçº¿æ—¶é—´ï¼ˆuptimeï¼‰è¿™ç±»å¯¹æ—¶é—´ç²¾ç¡®åº¦è¦æ±‚ä¸é«˜çš„åŠŸèƒ½ä¸Š</li>
<li>å¯¹äºä¸ºé”®è®¾ç½®è¿‡æœŸæ—¶é—´ã€æ·»åŠ æ…¢æŸ¥è¯¢æ—¥å¿—è¿™ç§éœ€è¦é«˜ç²¾ç¡®åº¦æ—¶é—´çš„åŠŸèƒ½æ¥è¯´ï¼ŒæœåŠ¡å™¨è¿˜æ˜¯ä¼šå†æ¬¡æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä»è€Œè·å¾—æœ€å‡†ç¡®çš„ç³»ç»Ÿå½“å‰æ—¶é—´</li>
</ul>
<hr>
<h5 id="LRU-æ—¶é’Ÿ">LRU æ—¶é’Ÿ</h5>
<p>æœåŠ¡å™¨çŠ¶æ€ä¸­çš„ lruclock å±æ€§ä¿å­˜äº†æœåŠ¡å™¨çš„ LRU æ—¶é’Ÿ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="comment">// é»˜è®¤æ¯10ç§’æ›´æ–°ä¸€æ¬¡çš„æ—¶é’Ÿç¼“å­˜ï¼Œç”¨äºè®¡ç®—é”®çš„ç©ºè½¬(idle)æ—¶é•¿ã€‚ </span></span><br><span class="line">    <span class="type">unsigned</span> lruclock:<span class="number">22</span>; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ª Redis å¯¹è±¡éƒ½ä¼šæœ‰ä¸€ä¸ª lru å±æ€§ï¼Œ è¿™ä¸ª lru å±æ€§ä¿å­˜äº†å¯¹è±¡æœ€åä¸€æ¬¡è¢«å‘½ä»¤è®¿é—®çš„æ—¶é—´</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObiect</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> lru:<span class="number">22</span>; </span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure>
<p>å½“æœåŠ¡å™¨è¦è®¡ç®—ä¸€ä¸ªæ•°æ®åº“é”®çš„ç©ºè½¬æ—¶é—´ï¼ˆå³æ•°æ®åº“é”®å¯¹åº”çš„å€¼å¯¹è±¡çš„ç©ºè½¬æ—¶é—´ï¼‰ï¼Œç¨‹åºä¼šç”¨æœåŠ¡å™¨çš„ lruclock å±æ€§è®°å½•çš„æ—¶é—´å‡å»å¯¹è±¡çš„ lru å±æ€§è®°å½•çš„æ—¶é—´</p>
<p>serverCron å‡½æ•°é»˜è®¤ä»¥æ¯ 100 æ¯«ç§’ä¸€æ¬¡çš„é¢‘ç‡æ›´æ–°è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥å¾—å‡ºçš„ç©ºè½¬æ—¶é—´ä¹Ÿæ˜¯æ¨¡ç³Šçš„</p>
<hr>
<h5 id="å‘½ä»¤æ¬¡æ•°">å‘½ä»¤æ¬¡æ•°</h5>
<p>serverCron ä¸­çš„ trackOperationsPerSecond å‡½æ•°ä»¥æ¯ 100 æ¯«ç§’ä¸€æ¬¡çš„é¢‘ç‡æ‰§è¡Œï¼Œå‡½æ•°åŠŸèƒ½æ˜¯ä»¥<strong>æŠ½æ ·è®¡ç®—</strong>çš„æ–¹å¼ï¼Œä¼°ç®—å¹¶è®°å½•æœåŠ¡å™¨åœ¨æœ€è¿‘ä¸€ç§’é’Ÿå¤„ç†çš„å‘½ä»¤è¯·æ±‚æ•°é‡ï¼Œè¿™ä¸ªå€¼å¯ä»¥é€šè¿‡ INFO status å‘½ä»¤çš„ instantaneous_ops_per_sec åŸŸæŸ¥çœ‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; INFO stats</span><br><span class="line"><span class="comment"># Stats </span></span><br><span class="line">instantaneous_ops_per_sec:6</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®ä¸Šä¸€æ¬¡æŠ½æ ·æ—¶é—´ ops_sec_last_sample_time å’Œå½“å‰ç³»ç»Ÿæ—¶é—´ï¼Œä»¥åŠä¸Šä¸€æ¬¡å·²æ‰§è¡Œçš„å‘½ä»¤æ•° ops_sec_last_sample_ops å’ŒæœåŠ¡å™¨å½“å‰å·²ç»æ‰§è¡Œçš„å‘½ä»¤æ•°ï¼Œè®¡ç®—å‡ºä¸¤æ¬¡å‡½æ•°è°ƒç”¨æœŸé—´ï¼ŒæœåŠ¡å™¨å¹³å‡æ¯æ¯«ç§’å¤„ç†äº†å¤šå°‘ä¸ªå‘½ä»¤è¯·æ±‚ï¼Œè¯¥å€¼ä¹˜ä»¥ 1000 å¾—åˆ°æ¯ç§’å†…çš„æ‰§è¡Œå‘½ä»¤çš„ä¼°è®¡å€¼ï¼Œæ”¾å…¥ ops_sec_samples ç¯å½¢æ•°ç»„é‡Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="comment">// ä¸Šä¸€æ¬¡è¿›è¡ŒæŠ½æ ·çš„æ—¶é—´</span></span><br><span class="line">	<span class="type">long</span> <span class="type">long</span> ops_sec_last_sample_time;</span><br><span class="line">    <span class="comment">// ä¸Šä¸€æ¬¡æŠ½æ ·æ—¶ï¼ŒæœåŠ¡å™¨å·²æ‰§è¡Œå‘½ä»¤çš„æ•°é‡ </span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> ops_sec_last_sample_ops;</span><br><span class="line">    <span class="comment">// REDIS_OPS_SEC_SAMPLES å¤§å°ï¼ˆé»˜è®¤å€¼ä¸º16)çš„ç¯å½¢æ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸€é¡¹è®°å½•ä¸€æ¬¡çš„æŠ½æ ·ç»“æœ</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> ops_sec_samples[REDIS_OPS_SEC_SAMPLES];</span><br><span class="line">    <span class="comment">// ops_sec_samplesæ•°ç»„çš„ç´¢å¼•å€¼ï¼Œæ¯æ¬¡æŠ½æ ·åå°†å€¼è‡ªå¢ä¸€ï¼Œå€¼ä¸º16æ—¶é‡ç½®ä¸º0ï¼Œè®©æ•°ç»„æˆä¸ºä¸€ä¸ªç¯å½¢æ•°ç»„</span></span><br><span class="line">    <span class="type">int</span> ops_sec_idx;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="å†…å­˜å³°å€¼">å†…å­˜å³°å€¼</h5>
<p>æœåŠ¡å™¨çŠ¶æ€é‡Œçš„ stat_peak_memory å±æ€§è®°å½•äº†æœåŠ¡å™¨å†…å­˜å³°å€¼å¤§å°ï¼Œå¾ªç¯å‡½æ•°æ¯æ¬¡æ‰§è¡Œæ—¶éƒ½ä¼šæŸ¥çœ‹æœåŠ¡å™¨å½“å‰ä½¿ç”¨çš„å†…å­˜æ•°é‡ï¼Œå¹¶ä¸ stat_peak_memory ä¿å­˜çš„æ•°å€¼è¿›è¡Œæ¯”è¾ƒï¼Œè®¾ç½®ä¸ºè¾ƒå¤§çš„å€¼</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="comment">// å·²ä½¿ç”¨å†…å­˜å³°å€¼</span></span><br><span class="line">    <span class="type">size_t</span> stat_peak_memory;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>INFO memory å‘½ä»¤çš„ used_memory_peak å’Œ used_memory_peak_human ä¸¤ä¸ªåŸŸåˆ†åˆ«ä»¥ä¸¤ç§æ ¼å¼è®°å½•äº†æœåŠ¡å™¨çš„å†…å­˜å³°å€¼ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; INFO memory </span><br><span class="line"><span class="comment"># Memory </span></span><br><span class="line">...</span><br><span class="line">used_memory_peak:501824 </span><br><span class="line">used_memory_peak_human:490.06K</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="SIGTERM">SIGTERM</h5>
<p>æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼ŒRedis ä¼šä¸ºæœåŠ¡å™¨è¿›ç¨‹çš„ SIGTERM ä¿¡å·å…³è”å¤„ç†å™¨ sigtermHandler å‡½æ•°ï¼Œè¯¥ä¿¡å·å¤„ç†å™¨è´Ÿè´£åœ¨æœåŠ¡å™¨æ¥åˆ° SIGTERM ä¿¡å·æ—¶ï¼Œæ‰“å¼€æœåŠ¡å™¨çŠ¶æ€çš„ shutdown_asap æ ‡è¯†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="comment">// å…³é—­æœåŠ¡å™¨çš„æ ‡è¯†ï¼šå€¼ä¸º1æ—¶å…³é—­æœåŠ¡å™¨ï¼Œå€¼ä¸º0æ—¶ä¸åšæ“ä½œ</span></span><br><span class="line">    <span class="type">int</span> shutdown_asap;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ¯æ¬¡ serverCron å‡½æ•°è¿è¡Œæ—¶ï¼Œç¨‹åºéƒ½ä¼šå¯¹æœåŠ¡å™¨çŠ¶æ€çš„ shutdown_asap å±æ€§è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶æ ¹æ®å±æ€§çš„å€¼å†³å®šæ˜¯å¦å…³é—­æœåŠ¡å™¨</p>
<p>æœåŠ¡å™¨åœ¨æ¥åˆ° SIGTERM ä¿¡å·ä¹‹åï¼Œå…³é—­æœåŠ¡å™¨å¹¶æ‰“å°ç›¸å…³æ—¥å¿—çš„è¿‡ç¨‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[6794 | signal handler] (1384435690) Received SIGTERM, scheduling shutdown ... </span><br><span class="line">[6794] 14 Nov 21:28:10.108 <span class="comment"># User requested shutdown ... </span></span><br><span class="line">[6794] 14 Nov 21:28:10.108 * Saving the final RDB snapshot before exiting. </span><br><span class="line">[6794) 14 Nov 21:28:10.161 * DB saved on disk </span><br><span class="line">[6794) 14 Nov 21:28:10.161 <span class="comment"># Redisis now ready to exit, bye bye ... </span></span><br></pre></td></tr></table></figure>
<hr>
<h5 id="ç®¡ç†èµ„æº">ç®¡ç†èµ„æº</h5>
<p>serverCron å‡½æ•°æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šè°ƒç”¨ clientsCron å’Œ databasesCron å‡½æ•°ï¼Œè¿›è¡Œç®¡ç†å®¢æˆ·ç«¯èµ„æºå’Œæ•°æ®åº“èµ„æº</p>
<p>clientsCron å‡½æ•°å¯¹ä¸€å®šæ•°é‡çš„å®¢æˆ·ç«¯è¿›è¡Œä»¥ä¸‹ä¸¤ä¸ªæ£€æŸ¥ï¼š</p>
<ul>
<li>å¦‚æœå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å·³ç»è¶…æ—¶ï¼ˆå¾ˆé•¿ä¸€æ®µæ—¶é—´å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½æ²¡æœ‰äº’åŠ¨ï¼‰ï¼Œé‚£ä¹ˆç¨‹åºé‡Šæ”¾è¿™ä¸ªå®¢æˆ·ç«¯</li>
<li>å¦‚æœå®¢æˆ·ç«¯åœ¨ä¸Šä¸€æ¬¡æ‰§è¡Œå‘½ä»¤è¯·æ±‚ä¹‹åï¼Œè¾“å…¥ç¼“å†²åŒºçš„å¤§å°è¶…è¿‡äº†ä¸€å®šçš„é•¿åº¦ï¼Œé‚£ä¹ˆç¨‹åºä¼šé‡Šæ”¾å®¢æˆ·ç«¯å½“å‰çš„è¾“å…¥ç¼“å†²åŒºï¼Œå¹¶é‡æ–°åˆ›å»ºä¸€ä¸ªé»˜è®¤å¤§å°çš„è¾“å…¥ç¼“å†²åŒºï¼Œä»è€Œé˜²æ­¢å®¢æˆ·ç«¯çš„è¾“å…¥ç¼“å†²åŒºè€—è´¹äº†è¿‡å¤šçš„å†…å­˜</li>
</ul>
<p>databasesCron å‡½æ•°ä¼šå¯¹æœåŠ¡å™¨ä¸­çš„ä¸€éƒ¨åˆ†æ•°æ®åº“è¿›è¡Œæ£€æŸ¥ï¼Œåˆ é™¤å…¶ä¸­çš„è¿‡æœŸé”®ï¼Œå¹¶åœ¨æœ‰éœ€è¦æ—¶å¯¹å­—å…¸è¿›è¡Œæ”¶ç¼©æ“ä½œ</p>
<hr>
<h5 id="æŒä¹…çŠ¶æ€">æŒä¹…çŠ¶æ€</h5>
<p>æœåŠ¡å™¨çŠ¶æ€ä¸­è®°å½•æ‰§è¡Œ BGSAVE å‘½ä»¤å’Œ BGREWRITEAOF å‘½ä»¤çš„å­è¿›ç¨‹çš„ ID</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="comment">// è®°å½•æ‰§è¡ŒBGSAVEå‘½ä»¤çš„å­è¿›ç¨‹çš„IDï¼Œå¦‚æœæœåŠ¡å™¨æ²¡æœ‰åœ¨æ‰§è¡ŒBGSAVEï¼Œé‚£ä¹ˆè¿™ä¸ªå±æ€§çš„å€¼ä¸º-1</span></span><br><span class="line">    <span class="type">pid_t</span> rdb_child_pid;</span><br><span class="line">    <span class="comment">// è®°å½•æ‰§è¡ŒBGREWRITEAOFå‘½ä»¤çš„å­è¿›ç¨‹çš„IDï¼Œå¦‚æœæœåŠ¡å™¨æ²¡æœ‰åœ¨æ‰§è¡Œé‚£ä¹ˆè¿™ä¸ªå±æ€§çš„å€¼ä¸º-1</span></span><br><span class="line">    <span class="type">pid_t</span> aof_child_pid</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>serverCron å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šæ£€æŸ¥ä¸¤ä¸ªå±æ€§çš„å€¼ï¼Œåªè¦å…¶ä¸­ä¸€ä¸ªå±æ€§çš„å€¼ä¸ä¸º -1ï¼Œç¨‹åºå°±ä¼šæ‰§è¡Œä¸€æ¬¡ wait3 å‡½æ•°ï¼Œæ£€æŸ¥å­è¿›ç¨‹æ˜¯å¦æœ‰ä¿¡å·å‘æ¥æœåŠ¡å™¨è¿›ç¨‹ï¼š</p>
<ul>
<li>å¦‚æœæœ‰ä¿¡å·åˆ°è¾¾ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ–°çš„ RDB æ–‡ä»¶å·²ç»ç”Ÿæˆæˆ–è€… AOF é‡å†™å®Œæ¯•ï¼ŒæœåŠ¡å™¨éœ€è¦è¿›è¡Œç›¸åº”å‘½ä»¤çš„åç»­æ“ä½œï¼Œæ¯”å¦‚ç”¨æ–°çš„ RDB æ–‡ä»¶æ›¿æ¢ç°æœ‰çš„ RDB æ–‡ä»¶ï¼Œç”¨é‡å†™åçš„ AOF æ–‡ä»¶æ›¿æ¢ç°æœ‰çš„ AOF æ–‡ä»¶</li>
<li>å¦‚æœæ²¡æœ‰ä¿¡å·åˆ°è¾¾ï¼Œé‚£ä¹ˆè¡¨ç¤ºæŒä¹…åŒ–æ“ä½œæœªå®Œæˆï¼Œç¨‹åºä¸åšåŠ¨ä½œ</li>
</ul>
<p>å¦‚æœä¸¤ä¸ªå±æ€§çš„å€¼éƒ½ä¸º -1ï¼Œè¡¨ç¤ºæœåŠ¡å™¨æ²¡æœ‰è¿›è¡ŒæŒä¹…åŒ–æ“ä½œ</p>
<ul>
<li>
<p>æŸ¥çœ‹æ˜¯å¦æœ‰ BGREWRITEAOF è¢«å»¶è¿Ÿï¼Œç„¶åæ‰§è¡Œ AOF åå°é‡å†™</p>
</li>
<li>
<p>æŸ¥çœ‹æœåŠ¡å™¨çš„è‡ªåŠ¨ä¿å­˜æ¡ä»¶æ˜¯å¦å·²ç»è¢«æ»¡è¶³ï¼Œå¹¶ä¸”æœåŠ¡å™¨æ²¡æœ‰åœ¨è¿›è¡ŒæŒä¹…åŒ–ï¼Œå°±å¼€å§‹ä¸€æ¬¡æ–°çš„ BGSAVE æ“ä½œ</p>
<p>å› ä¸ºæ¡ä»¶ 1 å¯èƒ½ä¼šå¼•å‘ä¸€æ¬¡ AOFï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªæ£€æŸ¥ä¸­ä¼šå†æ¬¡ç¡®è®¤æœåŠ¡å™¨æ˜¯å¦å·²ç»åœ¨æ‰§è¡ŒæŒä¹…åŒ–æ“ä½œ</p>
</li>
<li>
<p>æ£€æŸ¥æœåŠ¡å™¨è®¾ç½®çš„ AOF é‡å†™æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œæ¡ä»¶æ»¡è¶³å¹¶ä¸”æœåŠ¡å™¨æ²¡æœ‰è¿›è¡ŒæŒä¹…åŒ–ï¼Œå°±è¿›è¡Œä¸€æ¬¡ AOF é‡å†™</p>
</li>
</ul>
<p>å¦‚æœæœåŠ¡å™¨å¼€å¯äº† AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œå¹¶ä¸” AOF ç¼“å†²åŒºé‡Œè¿˜æœ‰å¾…å†™å…¥çš„æ•°æ®ï¼Œ é‚£ä¹ˆ serverCron å‡½æ•°ä¼šè°ƒç”¨ç›¸åº”çš„ç¨‹åºï¼Œå°† AOF ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥åˆ° AOF æ–‡ä»¶é‡Œ</p>
<hr>
<h5 id="å»¶è¿Ÿæ‰§è¡Œ">å»¶è¿Ÿæ‰§è¡Œ</h5>
<p>åœ¨æœåŠ¡å™¨æ‰§è¡Œ BGSAVE å‘½ä»¤çš„æœŸé—´ï¼Œå¦‚æœå®¢æˆ·ç«¯å‘é€ BGREWRITEAOF å‘½ä»¤ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šå°† BGREWRITEAOF å‘½ä»¤çš„æ‰§è¡Œæ—¶é—´å»¶è¿Ÿåˆ° BGSAVE å‘½ä»¤æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œç”¨æœåŠ¡å™¨çŠ¶æ€çš„ aof_rewrite_scheduled å±æ€§æ ‡è¯†å»¶è¿Ÿä¸å¦</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="comment">// å¦‚æœå€¼ä¸º1ï¼Œé‚£ä¹ˆè¡¨ç¤ºæœ‰ BGREWRITEAOFå‘½ä»¤è¢«å»¶è¿Ÿäº†</span></span><br><span class="line">    <span class="type">int</span> aof_rewrite_scheduled;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>serverCron å‡½æ•°ä¼šæ£€æŸ¥ BGSAVE æˆ–è€… BGREWRITEAOF å‘½ä»¤æ˜¯å¦æ­£åœ¨æ‰§è¡Œï¼Œå¦‚æœè¿™ä¸¤ä¸ªå‘½ä»¤éƒ½æ²¡åœ¨æ‰§è¡Œï¼Œå¹¶ä¸” aof_rewrite_scheduled å±æ€§çš„å€¼ä¸º 1ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°±ä¼šæ‰§è¡Œä¹‹å‰è¢«æ¨å»¶çš„ BGREWRITEAOF å‘½ä»¤</p>
<hr>
<h5 id="æ‰§è¡Œæ¬¡æ•°">æ‰§è¡Œæ¬¡æ•°</h5>
<p>æœåŠ¡å™¨çŠ¶æ€çš„ cronloops å±æ€§è®°å½•äº† serverCron å‡½æ•°æ‰§è¡Œçš„æ¬¡æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="comment">// serverCron å‡½æ•°æ¯æ‰§è¡Œä¸€æ¬¡ï¼Œè¿™ä¸ªå±æ€§çš„å€¼å°±å¢ 1</span></span><br><span class="line">    <span class="type">int</span> cronloops;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="ç¼“å†²é™åˆ¶">ç¼“å†²é™åˆ¶</h5>
<p>æœåŠ¡å™¨ä¼šå…³é—­é‚£äº›è¾“å…¥æˆ–è€…è¾“å‡º<strong>ç¼“å†²åŒºå¤§å°è¶…å‡ºé™åˆ¶</strong>çš„å®¢æˆ·ç«¯</p>
<hr>
<h4 id="åˆå§‹åŒ–">åˆå§‹åŒ–</h4>
<h5 id="åˆå§‹ç»“æ„">åˆå§‹ç»“æ„</h5>
<p>ä¸€ä¸ª Redis æœåŠ¡å™¨ä»å¯åŠ¨åˆ°èƒ½å¤Ÿæ¥å—å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ï¼Œéœ€è¦ç»è¿‡ä¸€ç³»åˆ—çš„åˆå§‹åŒ–å’Œè®¾ç½®è¿‡ç¨‹</p>
<p>ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºä¸€ä¸ª redisServer ç±»å‹çš„å®ä¾‹å˜é‡ server ä½œä¸ºæœåŠ¡å™¨çš„çŠ¶æ€ï¼Œå¹¶ä¸ºç»“æ„ä¸­çš„å„ä¸ªå±æ€§è®¾ç½®é»˜è®¤å€¼ï¼Œç”± initServerConfig å‡½æ•°è¿›è¡Œåˆå§‹åŒ–ä¸€èˆ¬å±æ€§ï¼š</p>
<ul>
<li>è®¾ç½®æœåŠ¡å™¨çš„è¿è¡Œ IDã€é»˜è®¤è¿è¡Œé¢‘ç‡ã€é»˜è®¤é…ç½®æ–‡ä»¶è·¯å¾„ã€é»˜è®¤ç«¯å£å·ã€é»˜è®¤ RDB æŒä¹…åŒ–æ¡ä»¶å’Œ AOF æŒä¹…åŒ–æ¡ä»¶</li>
<li>åˆå§‹åŒ–æœåŠ¡å™¨çš„ LRU æ—¶é’Ÿï¼Œåˆ›å»ºå‘½ä»¤è¡¨</li>
</ul>
<p>ç¬¬äºŒæ­¥ï¼šè½½å…¥é…ç½®é€‰é¡¹ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç»™å®šé…ç½®å‚æ•°æˆ–è€…æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œå¯¹ server å˜é‡ç›¸å…³å±æ€§çš„é»˜è®¤å€¼è¿›è¡Œä¿®æ”¹</p>
<p>ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ–æœåŠ¡å™¨æ•°æ®ç»“æ„ï¼ˆé™¤äº†å‘½ä»¤è¡¨ä¹‹å¤–ï¼‰ï¼Œå› ä¸ºæœåŠ¡å™¨<strong>å¿…é¡»å…ˆè½½å…¥ç”¨æˆ·æŒ‡å®šçš„é…ç½®é€‰é¡¹æ‰èƒ½æ­£ç¡®åœ°å¯¹æ•°æ®ç»“æ„è¿›è¡Œåˆå§‹åŒ–</strong>ï¼Œæ‰€ä»¥è½½å…¥é…ç½®å®Œæˆåæ‰è¿›æ€§æ•°æ®ç»“æ„çš„åˆå§‹åŒ–ï¼ŒæœåŠ¡å™¨å°†è°ƒç”¨ initServer å‡½æ•°ï¼š</p>
<ul>
<li>server.clients é“¾è¡¨ï¼Œè®°å½•äº†çš„å®¢æˆ·ç«¯çš„çŠ¶æ€ç»“æ„ï¼›server.db æ•°ç»„ï¼ŒåŒ…å«äº†æœåŠ¡å™¨çš„æ‰€æœ‰æ•°æ®åº“</li>
<li>ç”¨äºä¿å­˜é¢‘é“è®¢é˜…ä¿¡æ¯çš„ server.pubsub_channels å­—å…¸ï¼Œ ä»¥åŠä¿å­˜æ¨¡å¼è®¢é˜…ä¿¡æ¯çš„ server.pubsub_patterns é“¾è¡¨</li>
<li>ç”¨äºæ‰§è¡Œ Lua è„šæœ¬çš„ Lua ç¯å¢ƒ server.lua</li>
<li>ä¿å­˜æ…¢æŸ¥è¯¢æ—¥å¿—çš„ server.slowlog å±æ€§</li>
</ul>
<p>initServer è¿˜è¿›è¡Œäº†éå¸¸é‡è¦çš„è®¾ç½®æ“ä½œï¼š</p>
<ul>
<li>ä¸ºæœåŠ¡å™¨è®¾ç½®è¿›ç¨‹ä¿¡å·å¤„ç†å™¨</li>
<li>åˆ›å»ºå…±äº«å¯¹è±¡ï¼ŒåŒ…å« OKã€ERRã€<strong>æ•´æ•° 1 åˆ° 10000 çš„å­—ç¬¦ä¸²å¯¹è±¡</strong>ç­‰</li>
<li><strong>æ‰“å¼€æœåŠ¡å™¨çš„ç›‘å¬ç«¯å£</strong></li>
<li><strong>ä¸º serverCron å‡½æ•°åˆ›å»ºæ—¶é—´äº‹ä»¶</strong>ï¼Œ ç­‰å¾…æœåŠ¡å™¨æ­£å¼è¿è¡Œæ—¶æ‰§è¡Œ serverCron å‡½æ•°</li>
<li>å¦‚æœ AOF æŒä¹…åŒ–åŠŸèƒ½å·²ç»æ‰“å¼€ï¼Œé‚£ä¹ˆæ‰“å¼€ç°æœ‰çš„ AOF æ–‡ä»¶ï¼Œå¦‚æœ AOF æ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåˆ›å»ºå¹¶æ‰“å¼€ä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶ ï¼Œä¸º AOF å†™å…¥åšå¥½å‡†å¤‡</li>
<li><strong>åˆå§‹åŒ–æœåŠ¡å™¨çš„åå° I/O æ¨¡å—</strong>ï¼ˆBIOï¼‰, ä¸ºå°†æ¥çš„ I/O æ“ä½œåšå¥½å‡†å¤‡</li>
</ul>
<p>å½“ initServer å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ æœåŠ¡å™¨å°†ç”¨ ASCII å­—ç¬¦åœ¨æ—¥å¿—ä¸­æ‰“å°å‡º Redis çš„å›¾æ ‡ï¼Œ ä»¥åŠ Redis çš„ç‰ˆæœ¬å·ä¿¡æ¯</p>
<hr>
<h5 id="è¿˜åŸçŠ¶æ€">è¿˜åŸçŠ¶æ€</h5>
<p>åœ¨å®Œæˆäº†å¯¹æœåŠ¡å™¨çŠ¶æ€çš„åˆå§‹åŒ–ä¹‹åï¼ŒæœåŠ¡å™¨éœ€è¦è½½å…¥RDBæ–‡ä»¶æˆ–è€…AOF æ–‡ä»¶ï¼Œ å¹¶æ ¹æ®æ–‡ä»¶è®°å½•çš„å†…å®¹æ¥è¿˜åŸæœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€ï¼š</p>
<ul>
<li>å¦‚æœæœåŠ¡å™¨å¯ç”¨äº† AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä½¿ç”¨ AOF æ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€</li>
<li>å¦‚æœæœåŠ¡å™¨æ²¡æœ‰å¯ç”¨ AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä½¿ç”¨ RDB æ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€</li>
</ul>
<p>å½“æœåŠ¡å™¨å®Œæˆæ•°æ®åº“çŠ¶æ€è¿˜åŸå·¥ä½œä¹‹åï¼ŒæœåŠ¡å™¨å°†åœ¨æ—¥å¿—ä¸­æ‰“å°å‡ºè½½å…¥æ–‡ä»¶å¹¶è¿˜åŸæ•°æ®åº“çŠ¶æ€æ‰€è€—è´¹çš„æ—¶é•¿</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[7171] 22 Nov 22:43:49.084 * DB loaded from disk: 0.071 seconds </span><br></pre></td></tr></table></figure>
<hr>
<h5 id="é©±åŠ¨å¾ªç¯">é©±åŠ¨å¾ªç¯</h5>
<p>åœ¨åˆå§‹åŒ–çš„æœ€åä¸€æ­¥ï¼ŒæœåŠ¡å™¨å°†æ‰“å°å‡ºä»¥ä¸‹æ—¥å¿—ï¼Œå¹¶å¼€å§‹<strong>æ‰§è¡ŒæœåŠ¡å™¨çš„äº‹ä»¶å¾ªç¯</strong>ï¼ˆloopï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">7171</span>] <span class="number">22</span> Nov <span class="number">22</span>:<span class="number">43</span>:<span class="number">49.084</span> * The server is now ready to accept connections on pert <span class="number">6379</span></span><br></pre></td></tr></table></figure>
<p>æœåŠ¡å™¨ç°åœ¨å¼€å§‹å¯ä»¥æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶å¤„ç†å®¢æˆ·ç«¯å‘æ¥çš„å‘½ä»¤è¯·æ±‚äº†</p>
<hr>
<h3 id="æ…¢æ—¥å¿—">æ…¢æ—¥å¿—</h3>
<h4 id="åŸºæœ¬ä»‹ç»-5">åŸºæœ¬ä»‹ç»</h4>
<p>Redis çš„æ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½ç”¨äºè®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡ç»™å®šæ—¶é•¿çš„å‘½ä»¤è¯·æ±‚ï¼Œé€šè¿‡äº§ç”Ÿçš„æ—¥å¿—æ¥ç›‘è§†å’Œä¼˜åŒ–æŸ¥è¯¢é€Ÿåº¦</p>
<p>æœåŠ¡å™¨é…ç½®æœ‰ä¸¤ä¸ªå’Œæ…¢æŸ¥è¯¢æ—¥å¿—ç›¸å…³çš„é€‰é¡¹ï¼š</p>
<ul>
<li>slowlog-log-slower-than é€‰é¡¹æŒ‡å®šæ‰§è¡Œæ—¶é—´è¶…è¿‡å¤šå°‘å¾®ç§’çš„å‘½ä»¤è¯·æ±‚ä¼šè¢«è®°å½•åˆ°æ—¥å¿—ä¸Š</li>
<li>slowlog-max-len é€‰é¡¹æŒ‡å®šæœåŠ¡å™¨æœ€å¤šä¿å­˜å¤šå°‘æ¡æ…¢æŸ¥è¯¢æ—¥å¿—</li>
</ul>
<p>æœåŠ¡å™¨ä½¿ç”¨å…ˆè¿›å…ˆå‡º FIFO çš„æ–¹å¼ä¿å­˜å¤šæ¡æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå½“æœåŠ¡å™¨å­˜å‚¨çš„æ…¢æŸ¥è¯¢æ—¥å¿—æ•°é‡ç­‰äº slowlog-max-len é€‰é¡¹çš„å€¼æ—¶ï¼Œåœ¨æ·»åŠ ä¸€æ¡æ–°çš„æ…¢æŸ¥è¯¢æ—¥å¿—ä¹‹å‰ï¼Œä¼šå…ˆå°†æœ€æ—§çš„ä¸€æ¡æ…¢æŸ¥è¯¢æ—¥å¿—åˆ é™¤</p>
<p>é…ç½®é€‰é¡¹å¯ä»¥é€šè¿‡ CONFIG SET option value å‘½ä»¤è¿›è¡Œè®¾ç½®</p>
<p>å¸¸ç”¨å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SLOWLOG GET [n]	<span class="comment"># æŸ¥çœ‹ n æ¡æœåŠ¡å™¨ä¿å­˜çš„æ…¢æ—¥å¿—</span></span><br><span class="line">SLOWLOG LEN		<span class="comment"># æŸ¥çœ‹æ—¥å¿—æ•°é‡</span></span><br><span class="line">SLOWLOG RESET	<span class="comment"># æ¸…é™¤æ‰€æœ‰æ…¢æŸ¥è¯¢æ—¥å¿—</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="æ—¥å¿—ä¿å­˜">æ—¥å¿—ä¿å­˜</h4>
<p>æœåŠ¡å™¨çŠ¶æ€ä¸­åŒ…å«äº†æ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½æœ‰å…³çš„å±æ€§ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">	<span class="comment">// ä¸‹ä¸€æ¡æ…¢æŸ¥è¯¢æ—¥å¿—çš„ID</span></span><br><span class="line">	<span class="type">long</span> <span class="type">long</span> slowlog_entry_id;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// ä¿å­˜äº†æ‰€æœ‰æ…¢æŸ¥è¯¢æ—¥å¿—çš„é“¾è¡¨</span></span><br><span class="line">	<span class="built_in">list</span> *slowlog;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// æœåŠ¡å™¨é…ç½®é€‰é¡¹çš„å€¼ </span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> slowlog-<span class="built_in">log</span>-slower-than;</span><br><span class="line">	<span class="comment">// æœåŠ¡å™¨é…ç½®é€‰é¡¹çš„å€¼</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> slowlog_max_len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>slowlog_entry_id å±æ€§çš„åˆå§‹å€¼ä¸º 0ï¼Œæ¯å½“åˆ›å»ºä¸€æ¡æ–°çš„æ…¢æŸ¥è¯¢æ—¥å¿—æ—¶ï¼Œè¿™ä¸ªå±æ€§å°±ä¼šç”¨ä½œæ–°æ—¥å¿—çš„ id å€¼ï¼Œä¹‹åè¯¥å±æ€§å¢ä¸€</p>
<p>slowlog é“¾è¡¨ä¿å­˜äº†æœåŠ¡å™¨ä¸­çš„æ‰€æœ‰æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œé“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ª slowlogEntry ç»“æ„ï¼Œ ä»£è¡¨ä¸€æ¡æ…¢æŸ¥è¯¢æ—¥å¿—ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">slowlogEntry</span> &#123;</span></span><br><span class="line">    <span class="comment">// å”¯ä¸€æ ‡è¯†ç¬¦</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> id;</span><br><span class="line">   	<span class="comment">// å‘½ä»¤æ‰§è¡Œæ—¶çš„æ—¶é—´ï¼Œæ ¼å¼ä¸ºUNIXæ—¶é—´æˆ³</span></span><br><span class="line">    <span class="type">time_t</span> time;</span><br><span class="line">	<span class="comment">// æ‰§è¡Œå‘½ä»¤æ¶ˆè€—çš„æ—¶é—´ï¼Œä»¥å¾®ç§’ä¸ºå•ä½ </span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> duration;</span><br><span class="line">	<span class="comment">// å‘½ä»¤ä¸å‘½ä»¤å‚æ•°</span></span><br><span class="line">	robj **argv;</span><br><span class="line">	<span class="comment">// å‘½ä»¤ä¸å‘½ä»¤å‚æ•°çš„æ•°é‡</span></span><br><span class="line">	<span class="type">int</span> argc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="æ·»åŠ æ—¥å¿—">æ·»åŠ æ—¥å¿—</h4>
<p>åœ¨æ¯æ¬¡æ‰§è¡Œå‘½ä»¤çš„å‰åï¼Œç¨‹åºéƒ½ä¼šè®°å½•å¾®ç§’æ ¼å¼çš„å½“å‰ UNIX æ—¶é—´æˆ³ï¼Œä¸¤ä¸ªæ—¶é—´ä¹‹å·®å°±æ˜¯æ‰§è¡Œå‘½ä»¤æ‰€è€—è´¹çš„æ—¶é•¿ï¼Œå‡½æ•°ä¼šæ£€æŸ¥å‘½ä»¤çš„æ‰§è¡Œæ—¶é•¿æ˜¯å¦è¶…è¿‡ slowlog-log-slower-than é€‰é¡¹æ‰€è®¾ç½®ï¼š</p>
<ul>
<li>
<p>å¦‚æœæ˜¯çš„è¯ï¼Œå°±ä¸ºå‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—ï¼Œå¹¶å°†æ–°æ—¥å¿—æ·»åŠ åˆ° slowlog é“¾è¡¨çš„è¡¨å¤´</p>
</li>
<li>
<p>æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—çš„é•¿åº¦æ˜¯å¦è¶…è¿‡ slowlog-max-len é€‰é¡¹æ‰€è®¾ç½®çš„é•¿åº¦ï¼Œå¦‚æœæ˜¯å°†å¤šå‡ºæ¥çš„æ—¥å¿—ä» slowlog é“¾è¡¨ä¸­åˆ é™¤æ‰</p>
</li>
<li>
<p>å°† redisServer. slowlog_entry_id çš„å€¼å¢ 1</p>
</li>
</ul>
<hr>
<h2 id="æ•°æ®ç»“æ„-2">æ•°æ®ç»“æ„</h2>
<h3 id="å­—ç¬¦ä¸²">å­—ç¬¦ä¸²</h3>
<h4 id="SDS">SDS</h4>
<p>Redis æ„å»ºäº†ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰çš„æ•°æ®ç±»å‹ï¼Œä½œä¸º Redis çš„é»˜è®¤å­—ç¬¦ä¸²è¡¨ç¤ºï¼ŒåŒ…å«å­—ç¬¦ä¸²çš„é”®å€¼å¯¹åœ¨åº•å±‚éƒ½æ˜¯ç”± SDS å®ç°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sdshdr</span> &#123;</span></span><br><span class="line">    <span class="comment">// è®°å½•bufæ•°ç»„ä¸­å·²ä½¿ç”¨å­—èŠ‚çš„æ•°é‡ï¼Œç­‰äº SDS æ‰€ä¿å­˜å­—ç¬¦ä¸²çš„é•¿åº¦</span></span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// è®°å½•bufæ•°ç»„ä¸­æœªä½¿ç”¨å­—èŠ‚çš„æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> <span class="built_in">free</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ã€å­—èŠ‚ã€‘æ•°ç»„ï¼Œç”¨äºä¿å­˜å­—ç¬¦ä¸²ï¼ˆä¸æ˜¯å­—ç¬¦æ•°ç»„ï¼‰</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>SDS éµå¾ª C å­—ç¬¦ä¸²<strong>ä»¥ç©ºå­—ç¬¦ç»“å°¾</strong>çš„æƒ¯ä¾‹ï¼Œä¿å­˜ç©ºå­—ç¬¦çš„ 1 å­—èŠ‚ä¸è®¡ç®—åœ¨ len å±æ€§ï¼ŒSDS ä¼šè‡ªåŠ¨ä¸ºç©ºå­—ç¬¦åˆ†é…é¢å¤–çš„ 1 å­—èŠ‚ç©ºé—´å’Œæ·»åŠ ç©ºå­—ç¬¦åˆ°å­—ç¬¦ä¸²æœ«å°¾ï¼Œæ‰€ä»¥ç©ºå­—ç¬¦å¯¹äº SDS çš„ä½¿ç”¨è€…æ¥è¯´æ˜¯å®Œå…¨é€æ˜çš„</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-SDS%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84.png" alt=""></p>
<hr>
<h4 id="å¯¹æ¯”">å¯¹æ¯”</h4>
<p>å¸¸æ•°å¤æ‚åº¦è·å–å­—ç¬¦ä¸²é•¿åº¦ï¼š</p>
<ul>
<li>C å­—ç¬¦ä¸²ä¸è®°å½•è‡ªèº«çš„é•¿åº¦ï¼Œè·å–æ—¶éœ€è¦éå†æ•´ä¸ªå­—ç¬¦ä¸²ï¼Œé‡åˆ°ç©ºå­—ç¬¦ä¸²ä¸ºæ­¢ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(N)</li>
<li>SDS è·å–å­—ç¬¦ä¸²é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œè®¾ç½®å’Œæ›´æ–° SDS é•¿åº¦ç”±å‡½æ•°åº•å±‚è‡ªåŠ¨å®Œæˆ</li>
</ul>
<p>æœç»ç¼“å†²åŒºæº¢å‡ºï¼š</p>
<ul>
<li>
<p>C å­—ç¬¦ä¸²è°ƒç”¨ strcat å‡½æ•°æ‹¼æ¥å­—ç¬¦ä¸²æ—¶ï¼Œå¦‚æœå­—ç¬¦ä¸²å†…å­˜ä¸å¤Ÿå®¹çº³ç›®æ ‡å­—ç¬¦ä¸²ï¼Œå°±ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºï¼ˆBuffer Overflowï¼‰</p>
<p>s1 å’Œ s2 æ˜¯å†…å­˜ä¸­ç›¸é‚»çš„å­—ç¬¦ä¸²ï¼Œæ‰§è¡Œ <code>strcat(s1, &quot; Cluster&quot;)</code>ï¼ˆæœ‰ç©ºæ ¼ï¼‰ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA%E9%97%AE%E9%A2%98.png" alt=""></p>
</li>
<li>
<p>SDS ç©ºé—´åˆ†é…ç­–ç•¥ï¼šå½“å¯¹ SDS è¿›è¡Œä¿®æ”¹æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥ SDS çš„ç©ºé—´æ˜¯å¦æ»¡è¶³ä¿®æ”¹æ‰€éœ€çš„è¦æ±‚ï¼Œ å¦‚æœä¸æ»¡è¶³ä¼šè‡ªåŠ¨å°† SDS çš„ç©ºé—´æ‰©å±•è‡³æ‰§è¡Œä¿®æ”¹æ‰€éœ€çš„å¤§å°ï¼Œç„¶åæ‰§è¡Œå®é™…çš„ä¿®æ”¹æ“ä½œï¼Œ é¿å…äº†ç¼“å†²åŒºæº¢å‡ºçš„é—®é¢˜</p>
</li>
</ul>
<p>äºŒè¿›åˆ¶å®‰å…¨ï¼š</p>
<ul>
<li>C å­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦å¿…é¡»ç¬¦åˆæŸç§ç¼–ç ï¼ˆæ¯”å¦‚ ASCIIï¼‰æ–¹å¼ï¼Œé™¤äº†å­—ç¬¦ä¸²æœ«å°¾ä»¥å¤–å…¶ä»–ä½ç½®ä¸èƒ½åŒ…å«ç©ºå­—ç¬¦ï¼Œå¦åˆ™ä¼šè¢«è¯¯è®¤ä¸ºæ˜¯å­—ç¬¦ä¸²çš„ç»“å°¾ï¼Œæ‰€ä»¥åªèƒ½ä¿å­˜æ–‡æœ¬æ•°æ®</li>
<li>SDS çš„ API éƒ½æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œä½¿ç”¨å­—èŠ‚æ•°ç»„ buf ä¿å­˜ä¸€ç³»åˆ—çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œ<strong>ä½¿ç”¨ len å±æ€§æ¥åˆ¤æ–­æ•°æ®çš„ç»“å°¾</strong>ï¼Œæ‰€ä»¥å¯ä»¥ä¿å­˜å›¾ç‰‡ã€è§†é¢‘ã€å‹ç¼©æ–‡ä»¶ç­‰äºŒè¿›åˆ¶æ•°æ®</li>
</ul>
<p>å…¼å®¹ C å­—ç¬¦ä¸²çš„å‡½æ•°ï¼šSDS ä¼šåœ¨ä¸º buf æ•°ç»„åˆ†é…ç©ºé—´æ—¶å¤šåˆ†é…ä¸€ä¸ªå­—èŠ‚æ¥ä¿å­˜ç©ºå­—ç¬¦ï¼Œæ‰€ä»¥å¯ä»¥é‡ç”¨ä¸€éƒ¨åˆ† C å­—ç¬¦ä¸²å‡½æ•°åº“çš„å‡½æ•°</p>
<hr>
<h4 id="å†…å­˜">å†…å­˜</h4>
<p>C å­—ç¬¦ä¸²<strong>æ¯æ¬¡</strong>å¢é•¿æˆ–è€…ç¼©çŸ­éƒ½ä¼šè¿›è¡Œä¸€æ¬¡å†…å­˜é‡åˆ†é…ï¼Œæ‹¼æ¥æ“ä½œé€šè¿‡é‡åˆ†é…æ‰©å±•åº•å±‚æ•°ç»„ç©ºé—´ï¼Œæˆªæ–­æ“ä½œé€šè¿‡é‡åˆ†é…é‡Šæ”¾ä¸ä½¿ç”¨çš„å†…å­˜ç©ºé—´ï¼Œé˜²æ­¢å‡ºç°å†…å­˜æ³„éœ²</p>
<p>SDS é€šè¿‡æœªä½¿ç”¨ç©ºé—´è§£é™¤äº†å­—ç¬¦ä¸²é•¿åº¦å’Œåº•å±‚æ•°ç»„é•¿åº¦ä¹‹é—´çš„å…³è”ï¼Œåœ¨ SDS ä¸­ buf æ•°ç»„çš„é•¿åº¦ä¸ä¸€å®šå°±æ˜¯å­—ç¬¦æ•°é‡åŠ ä¸€ï¼Œ æ•°ç»„é‡Œé¢å¯ä»¥åŒ…å«æœªä½¿ç”¨çš„å­—èŠ‚ï¼Œå­—èŠ‚çš„æ•°é‡ç”± free å±æ€§è®°å½•</p>
<p>å†…å­˜é‡åˆ†é…æ¶‰åŠå¤æ‚çš„ç®—æ³•ï¼Œéœ€è¦æ‰§è¡Œ<strong>ç³»ç»Ÿè°ƒç”¨</strong>ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼ŒSDS çš„ä¸¤ç§ä¼˜åŒ–ç­–ç•¥ï¼š</p>
<ul>
<li>
<p>ç©ºé—´é¢„åˆ†é…ï¼šå½“ SDS éœ€è¦è¿›è¡Œç©ºé—´æ‰©å±•æ—¶ï¼Œç¨‹åºä¸ä»…ä¼šä¸º SDS åˆ†é…ä¿®æ”¹æ‰€å¿…éœ€çš„ç©ºé—´ï¼Œ è¿˜ä¼šä¸º SDS åˆ†é…é¢å¤–çš„æœªä½¿ç”¨ç©ºé—´</p>
<ul>
<li>
<p>å¯¹ SDS ä¿®æ”¹ä¹‹åï¼ŒSDS çš„é•¿åº¦ï¼ˆlen å±æ€§ï¼‰å°äº 1MBï¼Œç¨‹åºåˆ†é…å’Œ len å±æ€§åŒæ ·å¤§å°çš„æœªä½¿ç”¨ç©ºé—´ï¼Œæ­¤æ—¶ len å’Œ free ç›¸ç­‰</p>
<p>s ä¸º Redisï¼Œæ‰§è¡Œ <code>sdscat(s, &quot; Cluster&quot;)</code> åï¼Œlen å˜ä¸º 13 å­—èŠ‚ï¼Œæ‰€ä»¥ä¹Ÿåˆ†é…äº† 13 å­—èŠ‚çš„ free ç©ºé—´ï¼Œæ€»é•¿åº¦å˜ä¸º 27 å­—èŠ‚ï¼ˆé¢å¤–çš„ä¸€å­—èŠ‚ä¿å­˜ç©ºå­—ç¬¦ï¼Œ13 + 13 + 1 = 27ï¼‰</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-SDS%E5%86%85%E5%AD%98%E9%A2%84%E5%88%86%E9%85%8D.png" alt=""></p>
</li>
<li>
<p>å¯¹ SDS ä¿®æ”¹ä¹‹åï¼ŒSDS çš„é•¿åº¦å¤§äºç­‰äº 1MBï¼Œç¨‹åºä¼šåˆ†é… 1MB çš„æœªä½¿ç”¨ç©ºé—´</p>
</li>
</ul>
<p>åœ¨æ‰©å±• SDS ç©ºé—´å‰ï¼ŒAPI ä¼šå…ˆæ£€æŸ¥ free ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœè¶³å¤Ÿå°±æ— éœ€æ‰§è¡Œå†…å­˜é‡åˆ†é…ï¼Œæ‰€ä»¥é€šè¿‡é¢„åˆ†é…ç­–ç•¥ï¼ŒSDS å°†è¿ç»­å¢é•¿ N æ¬¡å­—ç¬¦ä¸²æ‰€éœ€å†…å­˜çš„é‡åˆ†é…æ¬¡æ•°ä»<strong>å¿…å®š N æ¬¡é™ä½ä¸ºæœ€å¤š N æ¬¡</strong></p>
</li>
<li>
<p>æƒ°æ€§ç©ºé—´é‡Šæ”¾ï¼šå½“ SDS ç¼©çŸ­å­—ç¬¦ä¸²æ—¶ï¼Œç¨‹åºå¹¶ä¸ç«‹å³ä½¿ç”¨å†…å­˜é‡åˆ†é…æ¥å›æ”¶ç¼©çŸ­åå¤šå‡ºæ¥çš„å­—èŠ‚ï¼Œè€Œæ˜¯ä½¿ç”¨ free å±æ€§å°†è¿™äº›å­—èŠ‚çš„æ•°é‡è®°å½•èµ·æ¥ï¼Œå¹¶ç­‰å¾…å°†æ¥å¤ç”¨</p>
<p>SDS æä¾›äº†ç›¸åº”çš„ API æ¥çœŸæ­£é‡Šæ”¾ SDS çš„æœªä½¿ç”¨ç©ºé—´ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒç©ºé—´æƒ°æ€§é‡Šæ”¾ç­–ç•¥é€ æˆçš„å†…å­˜æµªè´¹é—®é¢˜</p>
</li>
</ul>
<hr>
<h3 id="é“¾è¡¨">é“¾è¡¨</h3>
<p>é“¾è¡¨æä¾›äº†é«˜æ•ˆçš„èŠ‚ç‚¹é‡æ’èƒ½åŠ›ï¼ŒC è¯­è¨€å¹¶æ²¡æœ‰å†…ç½®è¿™ç§æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥ Redis æ„å»ºäº†é“¾è¡¨æ•°æ®ç±»å‹</p>
<p>é“¾è¡¨èŠ‚ç‚¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> &#123;</span></span><br><span class="line">    <span class="comment">// å‰ç½®èŠ‚ç‚¹</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> *<span class="title">prev</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åç½®èŠ‚ç‚¹</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> *<span class="title">next</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">    <span class="type">void</span> *value</span><br><span class="line">&#125; listNode;</span><br></pre></td></tr></table></figure>
<p>å¤šä¸ª listNode é€šè¿‡ prev å’Œ next æŒ‡é’ˆç»„æˆ<strong>åŒç«¯é“¾è¡¨</strong>ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E9%93%BE%E8%A1%A8%E8%8A%82%E7%82%B9%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84.png" alt=""></p>
<p>list é“¾è¡¨ç»“æ„ï¼šæä¾›äº†è¡¨å¤´æŒ‡é’ˆ head ã€è¡¨å°¾æŒ‡é’ˆ tail ä»¥åŠé“¾è¡¨é•¿åº¦è®¡æ•°å™¨ len</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">list</span> &#123;</span></span><br><span class="line">    <span class="comment">// è¡¨å¤´èŠ‚ç‚¹</span></span><br><span class="line">    listNode *head;</span><br><span class="line">    <span class="comment">// è¡¨å°¾èŠ‚ç‚¹</span></span><br><span class="line">    listNode *tail;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é“¾è¡¨æ‰€åŒ…å«çš„èŠ‚ç‚¹æ•°é‡</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> len;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹å€¼å¤åˆ¶å‡½æ•°ï¼Œç”¨äºå¤åˆ¶é“¾è¡¨èŠ‚ç‚¹æ‰€ä¿å­˜çš„å€¼</span></span><br><span class="line">    <span class="type">void</span> *(*dup) (<span class="type">void</span> *ptr);</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹å€¼é‡Šæ”¾å‡½æ•°ï¼Œç”¨äºé‡Šæ”¾é“¾è¡¨èŠ‚ç‚¹æ‰€ä¿å­˜çš„å€¼</span></span><br><span class="line">    <span class="type">void</span> (*<span class="built_in">free</span>) (<span class="type">void</span> *ptr);</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹å€¼å¯¹æ¯”å‡½æ•°ï¼Œç”¨äºå¯¹æ¯”é“¾è¡¨èŠ‚ç‚¹æ‰€ä¿å­˜çš„å€¼å’Œå¦ä¸€ä¸ªè¾“å…¥å€¼æ˜¯å¦ç›¸ç­‰</span></span><br><span class="line">    <span class="type">int</span> (*match) (<span class="type">void</span> *ptr, <span class="type">void</span> *key);</span><br><span class="line">&#125; <span class="built_in">list</span>;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E9%93%BE%E8%A1%A8%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84.png" alt=""></p>
<p>Redis é“¾è¡¨çš„ç‰¹æ€§ï¼š</p>
<ul>
<li>åŒç«¯ï¼šé“¾è¡¨èŠ‚ç‚¹å¸¦æœ‰ prev å’Œ next æŒ‡é’ˆï¼Œè·å–æŸä¸ªèŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹å’Œåç½®èŠ‚ç‚¹çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(1)</li>
<li>æ— ç¯ï¼šè¡¨å¤´èŠ‚ç‚¹çš„ prev æŒ‡é’ˆå’Œè¡¨å°¾èŠ‚ç‚¹çš„ next æŒ‡é’ˆéƒ½æŒ‡å‘ NULLï¼Œå¯¹é“¾è¡¨çš„è®¿é—®ä»¥ NULL ä¸ºç»ˆç‚¹</li>
<li>å¸¦è¡¨å¤´æŒ‡é’ˆå’Œè¡¨å°¾æŒ‡é’ˆï¼š é€šè¿‡ list ç»“æ„çš„ head æŒ‡é’ˆå’Œ tail æŒ‡é’ˆï¼Œè·å–é“¾è¡¨çš„è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)</li>
<li>å¸¦é“¾è¡¨é•¿åº¦è®¡æ•°å™¨ï¼šä½¿ç”¨ len å±æ€§æ¥å¯¹ list æŒæœ‰çš„é“¾è¡¨èŠ‚ç‚¹è¿›è¡Œè®¡æ•°ï¼Œè·å–é“¾è¡¨ä¸­èŠ‚ç‚¹æ•°é‡çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)</li>
<li>å¤šæ€ï¼šé“¾è¡¨èŠ‚ç‚¹ä½¿ç”¨ void * æŒ‡é’ˆæ¥ä¿å­˜èŠ‚ç‚¹å€¼ï¼Œ å¹¶ä¸”å¯ä»¥é€šè¿‡ dupã€free ã€match ä¸‰ä¸ªå±æ€§ä¸ºèŠ‚ç‚¹å€¼è®¾ç½®ç±»å‹ç‰¹å®šå‡½æ•°ï¼Œæ‰€ä»¥é“¾è¡¨å¯ä»¥ä¿å­˜å„ç§<strong>ä¸åŒç±»å‹çš„å€¼</strong></li>
</ul>
<hr>
<h3 id="å­—å…¸">å­—å…¸</h3>
<h4 id="å“ˆå¸Œè¡¨">å“ˆå¸Œè¡¨</h4>
<p>Redis å­—å…¸ä½¿ç”¨çš„å“ˆå¸Œè¡¨ç»“æ„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictht</span> &#123;</span></span><br><span class="line">    <span class="comment">// å“ˆå¸Œè¡¨æ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ æŒ‡å‘ dictEntry ç»“æ„</span></span><br><span class="line">	dictEntry **table;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// å“ˆå¸Œè¡¨å¤§å°ï¼Œæ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> size;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// å“ˆå¸Œè¡¨å¤§å°æ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•å€¼ï¼Œæ€»æ˜¯ç­‰äº ã€size-1ã€‘</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> sizemask;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// è¯¥å“ˆå¸Œè¡¨å·²æœ‰èŠ‚ç‚¹çš„æ•°é‡ </span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> used;</span><br><span class="line">&#125; dictht;</span><br></pre></td></tr></table></figure>
<p>å“ˆå¸Œè¡¨èŠ‚ç‚¹ç»“æ„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> &#123;</span></span><br><span class="line">    <span class="comment">// é”®</span></span><br><span class="line">	<span class="type">void</span> *key;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// å€¼ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæˆ–è€…æ•´æ•°</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="type">void</span> *val;	<span class="comment">// æŒ‡é’ˆ</span></span><br><span class="line">        <span class="type">uint64_t</span> u64;</span><br><span class="line">        <span class="type">int64_t</span> s64;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// æŒ‡å‘ä¸‹ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œå½¢æˆé“¾è¡¨ï¼Œç”¨æ¥è§£å†³å†²çªé—®é¢˜</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; dictEntry;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%93%88%E5%B8%8C%E8%A1%A8%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84.png" alt=""></p>
<hr>
<h4 id="å­—å…¸ç»“æ„">å­—å…¸ç»“æ„</h4>
<p>å­—å…¸ï¼Œåˆç§°ä¸ºç¬¦å·è¡¨ã€å…³è”æ•°ç»„ã€æ˜ å°„ï¼ˆMapï¼‰ï¼Œç”¨äºä¿å­˜é”®å€¼å¯¹çš„æ•°æ®ç»“æ„ï¼Œå­—å…¸ä¸­çš„æ¯ä¸ªé”®éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ã€‚åº•å±‚é‡‡ç”¨å“ˆå¸Œè¡¨å®ç°ï¼Œä¸€ä¸ªå“ˆå¸Œè¡¨åŒ…å«å¤šä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¿å­˜ä¸€ä¸ªé”®å€¼å¯¹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dict</span> &#123;</span></span><br><span class="line">    <span class="comment">// ç±»å‹ç‰¹å®šå‡½æ•°</span></span><br><span class="line">    dictType *type;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç§æœ‰æ•°æ®</span></span><br><span class="line">    <span class="type">void</span> *privdata;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å“ˆå¸Œè¡¨ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ªdicthtå“ˆå¸Œè¡¨ï¼Œ</span></span><br><span class="line">    <span class="comment">// ä¸€èˆ¬æƒ…å†µä¸‹å­—å…¸åªä½¿ç”¨ ht[0] å“ˆå¸Œè¡¨ï¼Œ ht[1] å“ˆå¸Œè¡¨åªä¼šåœ¨å¯¹ ht[0] å“ˆå¸Œè¡¨è¿›è¡Œ rehash æ—¶ä½¿ç”¨</span></span><br><span class="line">    dictht ht[<span class="number">2</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// rehash ç´¢å¼•ï¼Œå½“ rehash ä¸åœ¨è¿›è¡Œæ—¶ï¼Œå€¼ä¸º -1</span></span><br><span class="line">    <span class="type">int</span> rehashidx;</span><br><span class="line">&#125; dict;</span><br></pre></td></tr></table></figure>
<p>type å±æ€§å’Œ privdata å±æ€§æ˜¯é’ˆå¯¹ä¸åŒç±»å‹çš„é”®å€¼å¯¹ï¼Œ ä¸ºåˆ›å»ºå¤šæ€å­—å…¸è€Œè®¾ç½®çš„ï¼š</p>
<ul>
<li>type å±æ€§æ˜¯æŒ‡å‘ dictType ç»“æ„çš„æŒ‡é’ˆï¼Œ æ¯ä¸ª dictType ç»“æ„ä¿å­˜äº†ä¸€ç°‡ç”¨äºæ“ä½œç‰¹å®šç±»å‹é”®å€¼å¯¹çš„å‡½æ•°ï¼Œ Redis ä¼šä¸ºç”¨é€”ä¸åŒçš„å­—å…¸è®¾ç½®ä¸åŒçš„ç±»å‹ç‰¹å®šå‡½æ•°</li>
<li>privdata å±æ€§ä¿å­˜äº†éœ€è¦ä¼ ç»™é‚£äº›ç±»å‹ç‰¹å®šå‡½æ•°çš„å¯é€‰å‚æ•°</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%AD%97%E5%85%B8%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84.png" alt=""></p>
<hr>
<h4 id="å“ˆå¸Œå†²çª">å“ˆå¸Œå†²çª</h4>
<p>Redis ä½¿ç”¨ MurmurHash ç®—æ³•æ¥è®¡ç®—é”®çš„å“ˆå¸Œå€¼ï¼Œè¿™ç§ç®—æ³•çš„ä¼˜ç‚¹åœ¨äºï¼Œå³ä½¿è¾“å…¥çš„é”®æ˜¯æœ‰è§„å¾‹çš„ï¼Œç®—æ³•ä»èƒ½ç»™å‡ºä¸€ä¸ªå¾ˆå¥½çš„éšæœºåˆ†å¸ƒæ€§ï¼Œå¹¶ä¸”ç®—æ³•çš„è®¡ç®—é€Ÿåº¦ä¹Ÿéå¸¸å¿«</p>
<p>å°†ä¸€ä¸ªæ–°çš„é”®å€¼å¯¹æ·»åŠ åˆ°å­—å…¸é‡Œï¼Œéœ€è¦å…ˆæ ¹æ®é”® key è®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œç„¶åè¿›è¡Œå–æ¨¡è¿ç®—ï¼ˆå–ä½™ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index = hash &amp; dict-&gt;ht[x].sizemask</span><br></pre></td></tr></table></figure>
<p>å½“æœ‰ä¸¤ä¸ªæˆ–ä»¥ä¸Šæ•°é‡çš„é”®è¢«åˆ†é…åˆ°äº†å“ˆå¸Œè¡¨æ•°ç»„çš„åŒä¸€ä¸ªç´¢å¼•ä¸Šæ—¶ï¼Œå°±ç§°è¿™äº›é”®å‘ç”Ÿäº†å“ˆå¸Œå†²çªï¼ˆcollisionï¼‰</p>
<p>Redis çš„å“ˆå¸Œè¡¨ä½¿ç”¨é“¾åœ°å€æ³•ï¼ˆseparate chainingï¼‰æ¥è§£å†³é”®å“ˆå¸Œå†²çªï¼Œ æ¯ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ª next æŒ‡é’ˆï¼Œå¤šä¸ªèŠ‚ç‚¹é€šè¿‡ next æŒ‡é’ˆæ„æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œè¢«åˆ†é…åˆ°åŒä¸€ä¸ªç´¢å¼•ä¸Šçš„å¤šä¸ªèŠ‚ç‚¹å¯ä»¥ç”¨è¿™ä¸ªå•å‘é“¾è¡¨è¿æ¥èµ·æ¥ï¼Œè¿™å°±è§£å†³äº†é”®å†²çªçš„é—®é¢˜</p>
<p>dictEntry èŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨æ²¡æœ‰æŒ‡å‘é“¾è¡¨è¡¨å°¾çš„æŒ‡é’ˆï¼Œä¸ºäº†é€Ÿåº¦è€ƒè™‘ï¼Œç¨‹åºæ€»æ˜¯å°†æ–°èŠ‚ç‚¹æ·»åŠ åˆ°é“¾è¡¨çš„è¡¨å¤´ä½ç½®ï¼ˆ<strong>å¤´æ’æ³•</strong>ï¼‰ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%AD%97%E5%85%B8%E8%A7%A3%E5%86%B3%E5%93%88%E5%B8%8C%E5%86%B2%E7%AA%81.png" alt=""></p>
<hr>
<h4 id="è´Ÿè½½å› å­">è´Ÿè½½å› å­</h4>
<p>è´Ÿè½½å› å­çš„è®¡ç®—æ–¹å¼ï¼šå“ˆå¸Œè¡¨ä¸­çš„<strong>èŠ‚ç‚¹æ•°é‡</strong> / å“ˆå¸Œè¡¨çš„å¤§å°ï¼ˆ<strong>é•¿åº¦</strong>ï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load_factor = ht[<span class="number">0</span>].used / ht[<span class="number">0</span>].size</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†è®©å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­ï¼ˆload factorï¼‰ç»´æŒåœ¨ä¸€ä¸ªåˆç†çš„èŒƒå›´ä¹‹å†…ï¼Œå½“å“ˆå¸Œè¡¨ä¿å­˜çš„é”®å€¼å¯¹æ•°é‡å¤ªå¤šæˆ–è€…å¤ªå°‘æ—¶ ï¼Œç¨‹åºä¼šè‡ªåŠ¨å¯¹å“ˆå¸Œè¡¨çš„å¤§å°è¿›è¡Œç›¸åº”çš„æ‰©å±•æˆ–è€…æ”¶ç¼©</p>
<p>å“ˆå¸Œè¡¨æ‰§è¡Œæ‰©å®¹çš„æ¡ä»¶ï¼š</p>
<ul>
<li>
<p>æœåŠ¡å™¨æ²¡æœ‰æ‰§è¡Œ BGSAVE æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº 1</p>
</li>
<li>
<p>æœåŠ¡å™¨æ­£åœ¨æ‰§è¡Œ BGSAVE æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº 5</p>
<p>åŸå› ï¼šæ‰§è¡Œè¯¥å‘½ä»¤çš„è¿‡ç¨‹ä¸­ï¼ŒRedis éœ€è¦åˆ›å»ºå½“å‰æœåŠ¡å™¨è¿›ç¨‹çš„å­è¿›ç¨‹ï¼Œè€Œå¤§å¤šæ•°æ“ä½œç³»ç»Ÿéƒ½é‡‡ç”¨å†™æ—¶å¤åˆ¶ï¼ˆcopy-onÂ­-writeï¼‰æŠ€æœ¯æ¥ä¼˜åŒ–å­è¿›ç¨‹çš„ä½¿ç”¨æ•ˆç‡ï¼Œé€šè¿‡æé«˜æ‰§è¡Œæ‰©å±•æ“ä½œçš„è´Ÿè½½å› å­ï¼Œå°½å¯èƒ½åœ°é¿å…åœ¨å­è¿›ç¨‹å­˜åœ¨æœŸé—´è¿›è¡Œå“ˆå¸Œè¡¨æ‰©å±•æ“ä½œï¼Œå¯ä»¥é¿å…ä¸å¿…è¦çš„å†…å­˜å†™å…¥æ“ä½œï¼Œæœ€å¤§é™åº¦åœ°èŠ‚çº¦å†…å­˜</p>
</li>
</ul>
<p>å“ˆå¸Œè¡¨æ‰§è¡Œæ”¶ç¼©çš„æ¡ä»¶ï¼šè´Ÿè½½å› å­å°äº 0.1ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼ŒservreCron ä¸­æ£€æµ‹ï¼‰</p>
<hr>
<h4 id="é‡æ–°æ•£åˆ—">é‡æ–°æ•£åˆ—</h4>
<p>æ‰©å±•å’Œæ”¶ç¼©å“ˆå¸Œè¡¨çš„æ“ä½œé€šè¿‡ rehashï¼ˆé‡æ–°æ•£åˆ—ï¼‰æ¥å®Œæˆï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¸ºå­—å…¸çš„ ht[1] å“ˆå¸Œè¡¨åˆ†é…ç©ºé—´ï¼Œç©ºé—´å¤§å°çš„åˆ†é…æƒ…å†µï¼š
<ul>
<li>å¦‚æœæ‰§è¡Œçš„æ˜¯æ‰©å±•æ“ä½œï¼Œht[1] çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äº $ht[0].used * 2$ çš„ $2^n$</li>
<li>å¦‚æœæ‰§è¡Œçš„æ˜¯æ”¶ç¼©æ“ä½œï¼Œht[1] çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äº $ht[0].used$ çš„ $2^n$</li>
</ul>
</li>
<li>å°†ä¿å­˜åœ¨ ht[0] ä¸­æ‰€æœ‰çš„é”®å€¼å¯¹é‡æ–°è®¡ç®—å“ˆå¸Œå€¼å’Œç´¢å¼•å€¼ï¼Œè¿ç§»åˆ° ht[1] ä¸Š</li>
<li>å½“ ht[0] åŒ…å«çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½è¿ç§»åˆ°äº† ht[1] ä¹‹åï¼ˆht[0] å˜ä¸ºç©ºè¡¨ï¼‰ï¼Œé‡Šæ”¾ ht[0]ï¼Œå°† ht[1] è®¾ç½®ä¸º ht[0]ï¼Œå¹¶åœ¨ ht[1] åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºç™½å“ˆå¸Œè¡¨ï¼Œä¸ºä¸‹ä¸€æ¬¡ rehash åšå‡†å¤‡</li>
</ul>
<p>å¦‚æœå“ˆå¸Œè¡¨é‡Œä¿å­˜çš„é”®å€¼å¯¹æ•°é‡å¾ˆå°‘ï¼Œrehash å°±å¯ä»¥åœ¨ç¬é—´å®Œæˆï¼Œä½†æ˜¯å¦‚æœå“ˆå¸Œè¡¨é‡Œæ•°æ®å¾ˆå¤šï¼Œé‚£ä¹ˆè¦ä¸€æ¬¡æ€§å°†è¿™äº›é”®å€¼å¯¹å…¨éƒ¨ rehash åˆ° ht[1] éœ€è¦å¤§é‡è®¡ç®—ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨åœ¨ä¸€æ®µæ—¶é—´å†…åœæ­¢æœåŠ¡</p>
<p>Redis å¯¹ rehash åšäº†ä¼˜åŒ–ï¼Œä½¿ rehash çš„åŠ¨ä½œå¹¶ä¸æ˜¯ä¸€æ¬¡æ€§ã€é›†ä¸­å¼çš„å®Œæˆï¼Œè€Œæ˜¯åˆ†å¤šæ¬¡ï¼Œæ¸è¿›å¼çš„å®Œæˆï¼Œåˆå«<strong>æ¸è¿›å¼ rehash</strong></p>
<ul>
<li>ä¸º ht[1] åˆ†é…ç©ºé—´ï¼Œæ­¤æ—¶å­—å…¸åŒæ—¶æŒæœ‰ ht[0] å’Œ ht[1] ä¸¤ä¸ªå“ˆå¸Œè¡¨</li>
<li>åœ¨å­—å…¸ä¸­ç»´æŠ¤äº†ä¸€ä¸ªç´¢å¼•è®¡æ•°å™¨å˜é‡ rehashidxï¼Œå¹¶å°†å˜é‡çš„å€¼è®¾ä¸º 0ï¼Œè¡¨ç¤º rehash æ­£å¼å¼€å§‹</li>
<li>åœ¨ rehash è¿›è¡ŒæœŸé—´ï¼Œæ¯æ¬¡å¯¹å­—å…¸æ‰§è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œæ—¶ï¼Œç¨‹åºé™¤äº†æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œä»¥å¤–ï¼Œè¿˜ä¼šé¡ºå¸¦å°† ht[0] å“ˆå¸Œè¡¨åœ¨ rehashidx ç´¢å¼•ä¸Šçš„æ‰€æœ‰é”®å€¼å¯¹ rehash åˆ° ht[1]ï¼Œrehash å®Œæˆä¹‹å<strong>å°† rehashidx å±æ€§çš„å€¼å¢ä¸€</strong></li>
<li>éšç€å­—å…¸æ“ä½œçš„ä¸æ–­æ‰§è¡Œï¼Œæœ€ç»ˆåœ¨æŸä¸ªæ—¶é—´ç‚¹ ht[0] çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½è¢« rehash è‡³ ht[1]ï¼Œå°† rehashidx å±æ€§çš„å€¼è®¾ä¸º -1</li>
</ul>
<p>æ¸è¿›å¼ rehash é‡‡ç”¨<strong>åˆ†è€Œæ²»ä¹‹</strong>çš„æ–¹å¼ï¼Œå°† rehash é”®å€¼å¯¹æ‰€éœ€çš„è®¡ç®—å·¥ä½œå‡æ‘Šåˆ°å¯¹å­—å…¸çš„æ¯ä¸ªæ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾å’Œæ›´æ–°æ“ä½œä¸Šï¼Œä»è€Œé¿å…äº†é›†ä¸­å¼ rehash å¸¦æ¥çš„åºå¤§è®¡ç®—é‡</p>
<p>æ¸è¿›å¼ rehash æœŸé—´çš„å“ˆå¸Œè¡¨æ“ä½œï¼š</p>
<ul>
<li>å­—å…¸çš„æŸ¥æ‰¾ã€åˆ é™¤ã€æ›´æ–°æ“ä½œä¼šåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ä¸Šè¿›è¡Œï¼Œæ¯”å¦‚æŸ¥æ‰¾ä¸€ä¸ªé”®ä¼šå…ˆåœ¨ ht[0] ä¸ŠæŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾ä¸åˆ°å°±å» ht[1] ç»§ç»­æŸ¥æ‰¾</li>
<li>å­—å…¸çš„æ·»åŠ æ“ä½œä¼šç›´æ¥åœ¨ ht[1] ä¸Šæ·»åŠ ï¼Œä¸åœ¨ ht[0] ä¸Šè¿›è¡Œä»»ä½•æ·»åŠ </li>
</ul>
<hr>
<h3 id="è·³è·ƒè¡¨">è·³è·ƒè¡¨</h3>
<h4 id="åº•å±‚ç»“æ„">åº•å±‚ç»“æ„</h4>
<p>è·³è·ƒè¡¨ï¼ˆskiplistï¼‰æ˜¯ä¸€ç§æœ‰åºï¼ˆ<strong>é»˜è®¤å‡åº</strong>ï¼‰çš„æ•°æ®ç»“æ„ï¼Œåœ¨é“¾è¡¨çš„åŸºç¡€ä¸Š<strong>å¢åŠ äº†å¤šçº§ç´¢å¼•ä»¥æå‡æŸ¥æ‰¾çš„æ•ˆç‡</strong>ï¼Œç´¢å¼•æ˜¯å å†…å­˜çš„ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ª<strong>ç©ºé—´æ¢æ—¶é—´</strong>çš„æ–¹æ¡ˆï¼Œè·³è¡¨å¹³å‡ O(logN)ã€æœ€å O(N) å¤æ‚åº¦çš„èŠ‚ç‚¹æŸ¥æ‰¾ï¼Œæ•ˆç‡ä¸å¹³è¡¡æ ‘ç›¸å½“ä½†æ˜¯å®ç°æ›´ç®€å•</p>
<p>åŸå§‹é“¾è¡¨ä¸­å­˜å‚¨çš„æœ‰å¯èƒ½æ˜¯å¾ˆå¤§çš„å¯¹è±¡ï¼Œè€Œç´¢å¼•ç»“ç‚¹åªéœ€è¦å­˜å‚¨å…³é”®å€¼å’Œå‡ ä¸ªæŒ‡é’ˆï¼Œå¹¶ä¸éœ€è¦å­˜å‚¨å¯¹è±¡ï¼Œå› æ­¤å½“èŠ‚ç‚¹æœ¬èº«æ¯”è¾ƒå¤§æˆ–è€…å…ƒç´ æ•°é‡æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œå…¶ä¼˜åŠ¿å¯ä»¥è¢«æ”¾å¤§ï¼Œè€Œç¼ºç‚¹ï¼ˆå å†…å­˜ï¼‰åˆ™å¯ä»¥å¿½ç•¥</p>
<p>Redis åªåœ¨ä¸¤ä¸ªåœ°æ–¹åº”ç”¨äº†è·³è·ƒè¡¨ï¼Œä¸€ä¸ªæ˜¯å®ç°æœ‰åºé›†åˆé”®ï¼Œå¦ä¸€ä¸ªæ˜¯åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸­ç”¨ä½œå†…éƒ¨æ•°æ®ç»“æ„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplist</span> &#123;</span></span><br><span class="line">    <span class="comment">// è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹ï¼ŒO(1) çš„æ—¶é—´å¤æ‚åº¦å®šä½å¤´å°¾èŠ‚ç‚¹</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">skiplistNode</span> *<span class="title">head</span>, *<span class="title">tail</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¡¨çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¡¨å†…çš„èŠ‚ç‚¹æ•°é‡ (è¡¨å¤´èŠ‚ç‚¹ä¸è®¡ç®—åœ¨å†…)</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> length;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¡¨ä¸­å±‚æ•°æœ€å¤§çš„èŠ‚ç‚¹çš„å±‚æ•° (è¡¨å¤´èŠ‚ç‚¹çš„å±‚é«˜ä¸è®¡ç®—åœ¨å†…)</span></span><br><span class="line">    <span class="type">int</span> level</span><br><span class="line">&#125; zskiplist;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> &#123;</span></span><br><span class="line">    <span class="comment">// å±‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistLevel</span> &#123;</span></span><br><span class="line">        <span class="comment">// å‰è¿›æŒ‡é’ˆ</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">forward</span>;</span></span><br><span class="line">        <span class="comment">// è·¨åº¦</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> span;</span><br><span class="line">    &#125; level[];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åé€€æŒ‡é’ˆ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">backward</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ†å€¼</span></span><br><span class="line">    <span class="type">double</span> score;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æˆå‘˜å¯¹è±¡</span></span><br><span class="line">    robj *obj;</span><br><span class="line">&#125; zskiplistNode;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E8%B7%B3%E8%A1%A8%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84.png" alt=""></p>
<hr>
<h4 id="å±æ€§åˆ†æ">å±æ€§åˆ†æ</h4>
<p>å±‚ï¼šlevel æ•°ç»„åŒ…å«å¤šä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«æŒ‡å‘å…¶ä»–èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚æ ¹æ®å¹•æ¬¡å®šå¾‹ï¼ˆpower lawï¼Œè¶Šå¤§çš„æ•°å‡ºç°çš„æ¦‚ç‡è¶Šå°ï¼‰<strong>éšæœº</strong>ç”Ÿæˆä¸€ä¸ªä»‹äº 1 å’Œ 32 ä¹‹é—´çš„å€¼ï¼ˆRedis5 ä¹‹åæœ€å¤§ä¸º 64ï¼‰ä½œä¸º level æ•°ç»„çš„å¤§å°ï¼Œè¿™ä¸ªå¤§å°å°±æ˜¯å±‚çš„é«˜åº¦ï¼ŒèŠ‚ç‚¹çš„ç¬¬ä¸€å±‚æ˜¯ level[0] = L1</p>
<p>å‰è¿›æŒ‡é’ˆï¼šforward ç”¨äºä»è¡¨å¤´åˆ°è¡¨å°¾æ–¹å‘<strong>æ­£åºï¼ˆå‡åºï¼‰éå†èŠ‚ç‚¹</strong>ï¼Œé‡åˆ° NULL åœæ­¢éå†</p>
<p>è·¨åº¦ï¼šspan ç”¨äºè®°å½•ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»ï¼Œç”¨æ¥è®¡ç®—æ’ä½ï¼ˆrankï¼‰ï¼š</p>
<ul>
<li>
<p>ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è·¨åº¦è¶Šå¤§ç›¸è·çš„å°±è¶Šè¿œï¼ŒæŒ‡å‘ NULL çš„æ‰€æœ‰å‰è¿›æŒ‡é’ˆçš„è·¨åº¦éƒ½ä¸º 0</p>
</li>
<li>
<p>åœ¨æŸ¥æ‰¾æŸä¸ªèŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­ï¼Œ<strong>å°†æ²¿é€”è®¿é—®è¿‡çš„æ‰€æœ‰å±‚çš„è·¨åº¦ç´¯è®¡èµ·æ¥ï¼Œç»“æœå°±æ˜¯ç›®æ ‡èŠ‚ç‚¹åœ¨è·³è·ƒè¡¨ä¸­çš„æ’ä½</strong>ï¼ŒæŒ‰ç…§ä¸Šå›¾æ‰€ç¤ºï¼š</p>
<p>æŸ¥æ‰¾åˆ†å€¼ä¸º 3.0 çš„èŠ‚ç‚¹ï¼Œæ²¿é€”ç»å†çš„å±‚ï¼šæŸ¥æ‰¾çš„è¿‡ç¨‹åªç»è¿‡äº†ä¸€ä¸ªå±‚ï¼Œå¹¶ä¸”å±‚çš„è·¨åº¦ä¸º 3ï¼Œæ‰€ä»¥ç›®æ ‡èŠ‚ç‚¹åœ¨è·³è·ƒè¡¨ä¸­çš„æ’ä½ä¸º 3</p>
<p>æŸ¥æ‰¾åˆ†å€¼ä¸º 2.0 çš„èŠ‚ç‚¹ï¼Œæ²¿é€”ç»å†çš„å±‚ï¼šç»è¿‡äº†ä¸¤ä¸ªè·¨åº¦ä¸º 1 çš„èŠ‚ç‚¹ï¼Œå› æ­¤å¯ä»¥è®¡ç®—å‡ºç›®æ ‡èŠ‚ç‚¹åœ¨è·³è·ƒè¡¨ä¸­çš„æ’ä½ä¸º 2</p>
</li>
</ul>
<p>åé€€æŒ‡é’ˆï¼šbackward ç”¨äºä»è¡¨å°¾åˆ°è¡¨å¤´æ–¹å‘<strong>é€†åºï¼ˆé™åºï¼‰éå†èŠ‚ç‚¹</strong></p>
<p>åˆ†å€¼ï¼šscore å±æ€§ä¸€ä¸ª double ç±»å‹çš„æµ®ç‚¹æ•°ï¼Œè·³è·ƒè¡¨ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½æŒ‰åˆ†å€¼ä»å°åˆ°å¤§æ¥æ’åº</p>
<p>æˆå‘˜å¯¹è±¡ï¼šobj å±æ€§æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª SDS å­—ç¬¦ä¸²å¯¹è±¡ã€‚åŒä¸€ä¸ªè·³è·ƒè¡¨ä¸­ï¼Œå„ä¸ªèŠ‚ç‚¹ä¿å­˜çš„<strong>æˆå‘˜å¯¹è±¡å¿…é¡»æ˜¯å”¯ä¸€çš„</strong>ï¼Œä½†æ˜¯å¤šä¸ªèŠ‚ç‚¹ä¿å­˜çš„åˆ†å€¼å¯ä»¥æ˜¯ç›¸åŒçš„ï¼Œåˆ†å€¼ç›¸åŒçš„èŠ‚ç‚¹å°†æŒ‰ç…§æˆå‘˜å¯¹è±¡åœ¨å­—å…¸åºä¸­çš„å¤§å°æ¥è¿›è¡Œæ’åºï¼ˆä»å°åˆ°å¤§ï¼‰</p>
<p>ä¸ªäººç¬”è®°ï¼šJUC â†’ å¹¶å‘åŒ… â†’ ConcurrentSkipListMap è¯¦è§£è·³è·ƒè¡¨</p>
<hr>
<h3 id="æ•´æ•°é›†åˆ">æ•´æ•°é›†åˆ</h3>
<h4 id="åº•å±‚ç»“æ„-2">åº•å±‚ç»“æ„</h4>
<p>æ•´æ•°é›†åˆï¼ˆintsetï¼‰æ˜¯ç”¨äºä¿å­˜æ•´æ•°å€¼çš„é›†åˆæ•°æ®ç»“æ„ï¼Œæ˜¯ Redis é›†åˆé”®çš„åº•å±‚å®ç°ä¹‹ä¸€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">intset</span> &#123;</span></span><br><span class="line">	<span class="comment">// ç¼–ç æ–¹å¼</span></span><br><span class="line">	<span class="type">uint32_t</span> encoding;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// é›†åˆåŒ…å«çš„å…ƒç´ æ•°é‡ï¼Œä¹Ÿå°±æ˜¯ contents æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">	<span class="type">uint32_t</span> length;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// ä¿å­˜å…ƒç´ çš„æ•°ç»„</span></span><br><span class="line">    <span class="type">int8_t</span> contents[];</span><br><span class="line">&#125; intset;</span><br></pre></td></tr></table></figure>
<p>encoding å–å€¼ä¸ºä¸‰ç§ï¼šINTSET_ENC_INT16ã€INTSET_ENC_INT32ã€INTSET_ENC_INT64</p>
<p>æ•´æ•°é›†åˆçš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ contents æ•°ç»„çš„ä¸€ä¸ªæ•°ç»„é¡¹ï¼ˆitemï¼‰ï¼Œåœ¨æ•°ç»„ä¸­æŒ‰å€¼çš„å¤§å°ä»å°åˆ°å¤§<strong>æœ‰åºæ’åˆ—</strong>ï¼Œå¹¶ä¸”æ•°ç»„ä¸­<strong>ä¸åŒ…å«ä»»ä½•é‡å¤é¡¹</strong>ã€‚è™½ç„¶ contents å±æ€§å£°æ˜ä¸º int8_t ç±»å‹ï¼Œä½†å®é™…ä¸Šæ•°ç»„å¹¶ä¸ä¿å­˜ä»»ä½• int8_t ç±»å‹çš„å€¼ï¼Œ çœŸæ­£ç±»å‹å–å†³äº encoding å±æ€§</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84.png" alt=""></p>
<p>è¯´æ˜ï¼šåº•å±‚å­˜å‚¨ç»“æ„æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯æœ‰åºæ€§å’Œä¸é‡å¤æ€§ï¼Œæ¯æ¬¡æ·»åŠ ä¸€ä¸ªå…ƒç´ çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(N)</p>
<hr>
<h4 id="ç±»å‹å‡çº§">ç±»å‹å‡çº§</h4>
<p>æ•´æ•°é›†åˆæ·»åŠ çš„æ–°å…ƒç´ çš„ç±»å‹æ¯”é›†åˆç°æœ‰æ‰€æœ‰å…ƒç´ çš„ç±»å‹éƒ½è¦é•¿æ—¶ï¼Œéœ€è¦å…ˆè¿›è¡Œå‡çº§ï¼ˆupgradeï¼‰ï¼Œå‡çº§æµç¨‹ï¼š</p>
<ul>
<li>
<p>æ ¹æ®æ–°å…ƒç´ çš„ç±»å‹é•¿åº¦ä»¥åŠé›†åˆå…ƒç´ çš„æ•°é‡ï¼ˆåŒ…æ‹¬æ–°å…ƒç´ åœ¨å†…ï¼‰ï¼Œæ‰©å±•æ•´æ•°é›†åˆåº•å±‚æ•°ç»„çš„ç©ºé—´å¤§å°</p>
</li>
<li>
<p>å°†åº•å±‚æ•°ç»„ç°æœ‰çš„æ‰€æœ‰å…ƒç´ éƒ½è½¬æ¢æˆä¸æ–°å…ƒç´ ç›¸åŒçš„ç±»å‹ï¼Œå¹¶å°†è½¬æ¢åçš„å…ƒç´ æ”¾å…¥æ­£ç¡®çš„ä½ç½®ï¼Œæ”¾ç½®è¿‡ç¨‹ä¿è¯æ•°ç»„çš„æœ‰åºæ€§</p>
<p>å›¾ç¤º 32 * 4 = 128 ä½ï¼Œé¦–å…ˆå°† 3 æ”¾å…¥ç´¢å¼• 2ï¼ˆ64 ä½ - 95 ä½ï¼‰ï¼Œç„¶åå°† 2 æ”¾ç½®ç´¢å¼• 1ï¼Œå°† 1 æ”¾ç½®åœ¨ç´¢å¼• 0ï¼Œä»åå‘å‰ä¾æ¬¡æ”¾ç½®åœ¨å¯¹åº”çš„åŒºé—´ï¼Œæœ€åæ”¾ç½® 65535 å…ƒç´ åˆ°ç´¢å¼• 3ï¼ˆ96 ä½- 127 ä½ï¼‰ï¼Œä¿®æ”¹ length å±æ€§ä¸º 4</p>
</li>
<li>
<p>å°†æ–°å…ƒç´ æ·»åŠ åˆ°åº•å±‚æ•°ç»„é‡Œ</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88%E5%8D%87%E7%BA%A7.png" alt=""></p>
<p>æ¯æ¬¡å‘æ•´æ•°é›†åˆæ·»åŠ æ–°å…ƒç´ éƒ½å¯èƒ½ä¼šå¼•èµ·å‡çº§ï¼Œè€Œæ¯æ¬¡å‡çº§éƒ½éœ€è¦å¯¹åº•å±‚æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ è¿›è¡Œç±»å‹è½¬æ¢ï¼Œæ‰€ä»¥å‘æ•´æ•°é›†åˆæ·»åŠ æ–°å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ä¸º O(N)</p>
<p>å¼•å‘å‡çº§çš„æ–°å…ƒç´ çš„é•¿åº¦æ€»æ˜¯æ¯”æ•´æ•°é›†åˆç°æœ‰æ‰€æœ‰å…ƒç´ çš„é•¿åº¦éƒ½å¤§ï¼Œæ‰€ä»¥è¿™ä¸ªæ–°å…ƒç´ çš„å€¼è¦ä¹ˆå°±å¤§äºæ‰€æœ‰ç°æœ‰å…ƒç´ ï¼Œè¦ä¹ˆå°±å°äºæ‰€æœ‰ç°æœ‰å…ƒç´ ï¼Œå‡çº§ä¹‹åæ–°å…ƒç´ çš„æ‘†æ”¾ä½ç½®ï¼š</p>
<ul>
<li>åœ¨æ–°å…ƒç´ å°äºæ‰€æœ‰ç°æœ‰å…ƒç´ çš„æƒ…å†µä¸‹ï¼Œæ–°å…ƒç´ ä¼šè¢«æ”¾ç½®åœ¨åº•å±‚æ•°ç»„çš„æœ€å¼€å¤´ï¼ˆç´¢å¼• 0ï¼‰</li>
<li>åœ¨æ–°å…ƒç´ å¤§äºæ‰€æœ‰ç°æœ‰å…ƒç´ çš„æƒ…å†µä¸‹ï¼Œæ–°å…ƒç´ ä¼šè¢«æ”¾ç½®åœ¨åº•å±‚æ•°ç»„çš„æœ€æœ«å°¾ï¼ˆç´¢å¼• length-1ï¼‰</li>
</ul>
<p>æ•´æ•°é›†åˆå‡çº§ç­–ç•¥çš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li>
<p>æå‡æ•´æ•°é›†åˆçš„çµæ´»æ€§ï¼šC è¯­è¨€æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œä¸ºäº†é¿å…ç±»å‹é”™è¯¯é€šå¸¸ä¸ä¼šå°†ä¸¤ç§ä¸åŒç±»å‹çš„å€¼æ”¾åœ¨åŒä¸€ä¸ªæ•°æ®ç»“æ„é‡Œé¢ï¼Œæ•´æ•°é›†åˆå¯ä»¥è‡ªåŠ¨å‡çº§åº•å±‚æ•°ç»„æ¥é€‚åº”æ–°å…ƒç´ ï¼Œæ‰€ä»¥å¯ä»¥éšæ„çš„æ·»åŠ æ•´æ•°</p>
</li>
<li>
<p>èŠ‚çº¦å†…å­˜ï¼šè¦è®©æ•°ç»„å¯ä»¥åŒæ—¶ä¿å­˜ int16ã€int32ã€int64 ä¸‰ç§ç±»å‹çš„å€¼ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ int64_t ç±»å‹çš„æ•°ç»„ä½œä¸ºæ•´æ•°é›†åˆçš„åº•å±‚å®ç°ï¼Œä½†æ˜¯ä¼šé€ æˆå†…å­˜æµªè´¹ï¼Œæ•´æ•°é›†åˆå¯ä»¥ç¡®ä¿å‡çº§æ“ä½œåªä¼šåœ¨æœ‰éœ€è¦çš„æ—¶å€™è¿›è¡Œï¼Œå°½é‡èŠ‚çœå†…å­˜</p>
</li>
</ul>
<p>æ•´æ•°é›†åˆ<strong>ä¸æ”¯æŒé™çº§æ“ä½œ</strong>ï¼Œä¸€æ—¦å¯¹æ•°ç»„è¿›è¡Œäº†å‡çº§ï¼Œç¼–ç å°±ä¼šä¸€ç›´ä¿æŒå‡çº§åçš„çŠ¶æ€</p>
<hr>
<h3 id="å‹ç¼©åˆ—è¡¨">å‹ç¼©åˆ—è¡¨</h3>
<h4 id="åº•å±‚ç»“æ„-3">åº•å±‚ç»“æ„</h4>
<p>å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰æ˜¯ Redis ä¸ºäº†èŠ‚çº¦å†…å­˜è€Œå¼€å‘çš„ï¼Œæ˜¯åˆ—è¡¨é”®å’Œå“ˆå¸Œé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ã€‚æ˜¯ç”±ä¸€ç³»åˆ—ç‰¹æ®Šç¼–ç çš„è¿ç»­å†…å­˜å—ç»„æˆçš„é¡ºåºå‹ï¼ˆsequentialï¼‰æ•°æ®ç»“æ„ï¼Œä¸€ä¸ªå‹ç¼©åˆ—è¡¨å¯ä»¥åŒ…å«ä»»æ„å¤šä¸ªèŠ‚ç‚¹ï¼ˆentryï¼‰ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ä¿å­˜ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…ä¸€ä¸ªæ•´æ•°å€¼</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84.png" alt=""></p>
<ul>
<li>zlbytesï¼šuint32_t ç±»å‹ 4 å­—èŠ‚ï¼Œè®°å½•æ•´ä¸ªå‹ç¼©åˆ—è¡¨å ç”¨çš„å†…å­˜å­—èŠ‚æ•°ï¼Œåœ¨å¯¹å‹ç¼©åˆ—è¡¨è¿›è¡Œå†…å­˜é‡åˆ†é…æˆ–è€…è®¡ç®— zlend çš„ä½ç½®æ—¶ä½¿ç”¨</li>
<li>zltailï¼šuint32_t ç±»å‹ 4 å­—èŠ‚ï¼Œè®°å½•å‹ç¼©åˆ—è¡¨è¡¨å°¾èŠ‚ç‚¹è·ç¦»èµ·å§‹åœ°å€æœ‰å¤šå°‘å­—èŠ‚ï¼Œé€šè¿‡è¿™ä¸ªåç§»é‡ç¨‹åºæ— é¡»éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨å°±å¯ä»¥ç¡®å®šè¡¨å°¾èŠ‚ç‚¹çš„åœ°å€</li>
<li>zllenï¼šuint16_t ç±»å‹ 2 å­—èŠ‚ï¼Œè®°å½•äº†å‹ç¼©åˆ—è¡¨åŒ…å«çš„èŠ‚ç‚¹æ•°é‡ï¼Œå½“è¯¥å±æ€§çš„å€¼å°äº UINT16_MAX (65535) æ—¶ï¼Œè¯¥å€¼å°±æ˜¯å‹ç¼©åˆ—è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡ï¼›å½“è¿™ä¸ªå€¼ç­‰äº UINT16_MAX æ—¶èŠ‚ç‚¹çš„çœŸå®æ•°é‡éœ€è¦éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨æ‰èƒ½è®¡ç®—å¾—å‡º</li>
<li>entryXï¼šåˆ—è¡¨èŠ‚ç‚¹ï¼Œå‹ç¼©åˆ—è¡¨ä¸­çš„å„ä¸ªèŠ‚ç‚¹ï¼Œ<strong>èŠ‚ç‚¹çš„é•¿åº¦ç”±èŠ‚ç‚¹ä¿å­˜çš„å†…å®¹å†³å®š</strong></li>
<li>zlendï¼šuint8_t ç±»å‹ 1 å­—èŠ‚ï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šå€¼ 0xFF (255)ï¼Œç”¨äºæ ‡è®°å‹ç¼©åˆ—è¡¨çš„æœ«ç«¯</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E7%A4%BA%E4%BE%8B.png" alt=""></p>
<p>åˆ—è¡¨ zlbytes å±æ€§çš„å€¼ä¸º 0x50 (åè¿›åˆ¶ 80)ï¼Œè¡¨ç¤ºå‹ç¼©åˆ—è¡¨çš„æ€»é•¿ä¸º 80 å­—èŠ‚ï¼Œåˆ—è¡¨ zltail å±æ€§çš„å€¼ä¸º 0x3c (åè¿›åˆ¶ 60)ï¼Œå‡è®¾è¡¨çš„èµ·å§‹åœ°å€ä¸º pï¼Œè®¡ç®—å¾—å‡ºè¡¨å°¾èŠ‚ç‚¹ entry3 çš„åœ°å€ p + 60</p>
<hr>
<h4 id="åˆ—è¡¨èŠ‚ç‚¹">åˆ—è¡¨èŠ‚ç‚¹</h4>
<p>åˆ—è¡¨èŠ‚ç‚¹ entry çš„æ•°æ®ç»“æ„ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E8%8A%82%E7%82%B9.png" alt=""></p>
<p>previous_entry_lengthï¼šä»¥å­—èŠ‚ä¸ºå•ä½è®°å½•äº†å‹ç¼©åˆ—è¡¨ä¸­å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ï¼Œç¨‹åºå¯ä»¥é€šè¿‡æŒ‡é’ˆè¿ç®—ï¼Œæ ¹æ®å½“å‰èŠ‚ç‚¹çš„èµ·å§‹åœ°å€æ¥è®¡ç®—å‡ºå‰ä¸€ä¸ªèŠ‚ç‚¹çš„èµ·å§‹åœ°å€ï¼Œå®Œæˆ<strong>ä»è¡¨å°¾å‘è¡¨å¤´éå†</strong>æ“ä½œ</p>
<ul>
<li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°äº 254 å­—èŠ‚ï¼Œè¯¥å±æ€§çš„é•¿åº¦ä¸º 1 å­—èŠ‚ï¼Œå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°±ä¿å­˜åœ¨è¿™ä¸€ä¸ªå­—èŠ‚é‡Œ</li>
<li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å¤§äºç­‰äº 254 å­—èŠ‚ï¼Œè¯¥å±æ€§çš„é•¿åº¦ä¸º 5 å­—èŠ‚ï¼Œå…¶ä¸­ç¬¬ä¸€å­—èŠ‚ä¼šè¢«è®¾ç½®ä¸º 0xFEï¼ˆåè¿›åˆ¶ 254ï¼‰ï¼Œä¹‹åçš„å››ä¸ªå­—èŠ‚åˆ™ç”¨äºä¿å­˜å‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦</li>
</ul>
<p>encodingï¼šè®°å½•äº†èŠ‚ç‚¹çš„ content å±æ€§æ‰€ä¿å­˜çš„æ•°æ®ç±»å‹å’Œé•¿åº¦</p>
<ul>
<li>
<p><strong>é•¿åº¦ä¸º 1 å­—èŠ‚ã€2 å­—èŠ‚æˆ–è€… 5 å­—èŠ‚</strong>ï¼Œå€¼çš„æœ€é«˜ä½ä¸º 00ã€01 æˆ–è€… 10 çš„æ˜¯å­—èŠ‚æ•°ç»„ç¼–ç ï¼Œæ•°ç»„çš„é•¿åº¦ç”±ç¼–ç é™¤å»æœ€é«˜ä¸¤ä½ä¹‹åçš„å…¶ä»–ä½è®°å½•ï¼Œä¸‹åˆ’çº¿ <code>_</code> è¡¨ç¤ºç•™ç©ºï¼Œè€Œ <code>b</code>ã€<code>x</code> ç­‰å˜é‡åˆ™ä»£è¡¨å®é™…çš„äºŒè¿›åˆ¶æ•°æ®</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E5%AD%97%E8%8A%82%E6%95%B0%E7%BB%84%E7%BC%96%E7%A0%81.png" alt=""></p>
</li>
<li>
<p>é•¿åº¦ä¸º 1 å­—èŠ‚ï¼Œå€¼çš„æœ€é«˜ä½ä¸º 11 çš„æ˜¯æ•´æ•°ç¼–ç ï¼Œæ•´æ•°å€¼çš„ç±»å‹å’Œé•¿åº¦ç”±ç¼–ç é™¤å»æœ€é«˜ä¸¤ä½ä¹‹åçš„å…¶ä»–ä½è®°å½•</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E6%95%B4%E6%95%B0%E7%BC%96%E7%A0%81.png" alt=""></p>
</li>
</ul>
<p>contentï¼šæ¯ä¸ªå‹ç¼©åˆ—è¡¨èŠ‚ç‚¹å¯ä»¥ä¿å­˜ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…ä¸€ä¸ªæ•´æ•°å€¼</p>
<ul>
<li>
<p>å­—èŠ‚æ•°ç»„å¯ä»¥æ˜¯ä»¥ä¸‹ä¸‰ç§é•¿åº¦çš„å…¶ä¸­ä¸€ç§ï¼š</p>
<ul>
<li>
<p>é•¿åº¦å°äºç­‰äº $63 (2^6-1)$ å­—èŠ‚çš„å­—èŠ‚æ•°ç»„</p>
</li>
<li>
<p>é•¿åº¦å°äºç­‰äº $16383(2^{14}-1)$ å­—èŠ‚çš„å­—èŠ‚æ•°ç»„</p>
</li>
<li>
<p>é•¿åº¦å°äºç­‰äº $4294967295(2^{32}-1)$ å­—èŠ‚çš„å­—èŠ‚æ•°ç»„</p>
</li>
</ul>
</li>
<li>
<p>æ•´æ•°å€¼åˆ™å¯ä»¥æ˜¯ä»¥ä¸‹å…­ç§é•¿åº¦çš„å…¶ä¸­ä¸€ç§ï¼š</p>
<ul>
<li>
<p>4 ä½é•¿ï¼Œä»‹äº 0 è‡³ 12 ä¹‹é—´çš„æ— ç¬¦å·æ•´æ•°</p>
</li>
<li>
<p>1 å­—èŠ‚é•¿çš„æœ‰ç¬¦å·æ•´æ•°</p>
</li>
<li>
<p>3 å­—èŠ‚é•¿çš„æœ‰ç¬¦å·æ•´æ•°</p>
</li>
<li>
<p>int16_t ç±»å‹æ•´æ•°</p>
</li>
<li>
<p>int32_t ç±»å‹æ•´æ•°</p>
</li>
<li>
<p>int64_t ç±»å‹æ•´æ•°</p>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="è¿é”æ›´æ–°">è¿é”æ›´æ–°</h4>
<p>Redis å°†åœ¨ç‰¹æ®Šæƒ…å†µä¸‹äº§ç”Ÿçš„è¿ç»­å¤šæ¬¡ç©ºé—´æ‰©å±•æ“ä½œç§°ä¹‹ä¸ºè¿é”æ›´æ–°ï¼ˆcascade updateï¼‰</p>
<p>å‡è®¾åœ¨ä¸€ä¸ªå‹ç¼©åˆ—è¡¨ä¸­ï¼Œæœ‰å¤šä¸ªè¿ç»­çš„ã€é•¿åº¦ä»‹äº 250 åˆ° 253 å­—èŠ‚ä¹‹é—´çš„èŠ‚ç‚¹ e1 è‡³ eNã€‚å°†ä¸€ä¸ªé•¿åº¦å¤§äºç­‰äº 254 å­—èŠ‚çš„æ–°èŠ‚ç‚¹ new è®¾ç½®ä¸ºå‹ç¼©åˆ—è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œnew å°±æˆä¸º e1 çš„å‰ç½®èŠ‚ç‚¹ã€‚e1 çš„ previous_entry_length å±æ€§ä»…ä¸º 1 å­—èŠ‚ï¼Œæ— æ³•ä¿å­˜æ–°èŠ‚ç‚¹ new çš„é•¿åº¦ï¼Œæ‰€ä»¥è¦å¯¹å‹ç¼©åˆ—è¡¨æ‰§è¡Œç©ºé—´é‡åˆ†é…æ“ä½œï¼Œå¹¶å°† e1 èŠ‚ç‚¹çš„ previous_entry_length å±æ€§ä» 1 å­—èŠ‚é•¿æ‰©å±•ä¸º 5 å­—èŠ‚é•¿ã€‚ç”±äº e1 åŸæœ¬çš„é•¿åº¦ä»‹äº 250 è‡³ 253 å­—èŠ‚ä¹‹é—´ï¼Œæ‰€ä»¥æ‰©å±•å e1 çš„é•¿åº¦å°±å˜æˆäº† 254 è‡³ 257 å­—èŠ‚ä¹‹é—´ï¼Œå¯¼è‡´ e2 çš„  previous_entry_length å±æ€§æ— æ³•ä¿å­˜ e1 çš„é•¿åº¦ï¼Œç¨‹åºéœ€è¦ä¸æ–­åœ°å¯¹å‹ç¼©åˆ—è¡¨æ‰§è¡Œç©ºé—´é‡åˆ†é…æ“ä½œï¼Œç›´åˆ° eN ä¸ºæ­¢</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E8%BF%9E%E9%94%81%E6%9B%B4%E6%96%B01.png" alt=""></p>
<p>åˆ é™¤èŠ‚ç‚¹ä¹Ÿå¯èƒ½ä¼šå¼•å‘è¿é”æ›´æ–°ï¼Œbig.length &gt;= 254ï¼Œsmall.length &lt; 254ï¼Œåˆ é™¤ small èŠ‚ç‚¹</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E8%BF%9E%E9%94%81%E6%9B%B4%E6%96%B02.png" alt=""></p>
<p>è¿é”æ›´æ–°åœ¨æœ€åæƒ…å†µä¸‹éœ€è¦å¯¹å‹ç¼©åˆ—è¡¨æ‰§è¡Œ N æ¬¡ç©ºé—´é‡åˆ†é…ï¼Œæ¯æ¬¡é‡åˆ†é…çš„æœ€åå¤æ‚åº¦ä¸º O(N)ï¼Œæ‰€ä»¥è¿é”æ›´æ–°çš„æœ€åå¤æ‚åº¦ä¸º O(N^2)</p>
<p>è¯´æ˜ï¼šå°½ç®¡è¿é”æ›´æ–°çš„å¤æ‚åº¦è¾ƒé«˜ï¼Œä½†å‡ºç°çš„è®°å½•æ˜¯éå¸¸ä½çš„ï¼Œå³ä½¿å‡ºç°åªè¦è¢«æ›´æ–°çš„èŠ‚ç‚¹æ•°é‡ä¸å¤šï¼Œå°±ä¸ä¼šå¯¹æ€§èƒ½é€ æˆå½±å“</p>
<hr>
<h2 id="æ•°æ®ç±»å‹">æ•°æ®ç±»å‹</h2>
<h3 id="redisObj">redisObj</h3>
<h4 id="å¯¹è±¡ç³»ç»Ÿ">å¯¹è±¡ç³»ç»Ÿ</h4>
<p>Redis ä½¿ç”¨å¯¹è±¡æ¥è¡¨ç¤ºæ•°æ®åº“ä¸­çš„é”®å’Œå€¼ï¼Œå½“åœ¨ Redis æ•°æ®åº“ä¸­æ–°åˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹æ—¶è‡³å°‘ä¼šåˆ›å»ºä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªå¯¹è±¡ç”¨ä½œé”®å€¼å¯¹çš„é”®ï¼ˆ<strong>é”®å¯¹è±¡</strong>ï¼‰ï¼Œå¦ä¸€ä¸ªå¯¹è±¡ç”¨ä½œé”®å€¼å¯¹çš„å€¼ï¼ˆ<strong>å€¼å¯¹è±¡</strong>ï¼‰</p>
<p>Redis ä¸­å¯¹è±¡ç”±ä¸€ä¸ª redisObject ç»“æ„è¡¨ç¤ºï¼Œè¯¥ç»“æ„ä¸­å’Œä¿å­˜æ•°æ®æœ‰å…³çš„ä¸‰ä¸ªå±æ€§åˆ†åˆ«æ˜¯ typeã€ encodingã€ptrï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObiect</span> &#123;</span></span><br><span class="line">	<span class="comment">// ç±»å‹</span></span><br><span class="line">	<span class="type">unsigned</span> type:<span class="number">4</span>;</span><br><span class="line">	<span class="comment">// ç¼–ç </span></span><br><span class="line">	<span class="type">unsigned</span> encoding:<span class="number">4</span>;</span><br><span class="line">	<span class="comment">// æŒ‡å‘åº•å±‚æ•°æ®ç»“æ„çš„æŒ‡é’ˆ</span></span><br><span class="line">	<span class="type">void</span> *ptr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure>
<p>Redis å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨æ•°æ®ç»“æ„æ¥å®ç°é”®å€¼å¯¹æ•°æ®åº“ï¼Œè€Œæ˜¯åŸºäºè¿™äº›æ•°æ®ç»“æ„åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ç³»ç»Ÿï¼ŒåŒ…å«å­—ç¬¦ä¸²å¯¹è±¡ã€åˆ—è¡¨å¯¹è±¡ã€å“ˆå¸Œå¯¹è±¡ã€é›†åˆå¯¹è±¡å’Œæœ‰åºé›†åˆå¯¹è±¡è¿™äº”ç§ç±»å‹çš„å¯¹è±¡ï¼Œè€Œæ¯ç§å¯¹è±¡åˆé€šè¿‡ä¸åŒçš„ç¼–ç æ˜ å°„åˆ°ä¸åŒçš„åº•å±‚æ•°æ®ç»“æ„</p>
<p>Redis æ˜¯ä¸€ä¸ª Map ç±»å‹ï¼Œå…¶ä¸­æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯é‡‡ç”¨ key : value çš„å½¢å¼å­˜å‚¨ï¼Œ<strong>é”®å¯¹è±¡éƒ½æ˜¯å­—ç¬¦ä¸²å¯¹è±¡</strong>ï¼Œè€Œå€¼å¯¹è±¡æœ‰äº”ç§åŸºæœ¬ç±»å‹å’Œä¸‰ç§é«˜çº§ç±»å‹å¯¹è±¡</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A0%81.png" alt=""></p>
<ul>
<li>å¯¹ä¸€ä¸ªæ•°æ®åº“é”®æ‰§è¡Œ TYPE å‘½ä»¤ï¼Œè¿”å›çš„ç»“æœä¸ºæ•°æ®åº“é”®å¯¹åº”çš„å€¼å¯¹è±¡çš„ç±»å‹ï¼Œè€Œä¸æ˜¯é”®å¯¹è±¡çš„ç±»å‹</li>
<li>å¯¹ä¸€ä¸ªæ•°æ®åº“é”®æ‰§è¡Œ OBJECT ENCODING å‘½ä»¤ï¼ŒæŸ¥çœ‹æ•°æ®åº“é”®å¯¹åº”çš„å€¼å¯¹è±¡çš„ç¼–ç </li>
</ul>
<hr>
<h4 id="å‘½ä»¤å¤šæ€">å‘½ä»¤å¤šæ€</h4>
<p>Redis ä¸­ç”¨äºæ“ä½œé”®çš„å‘½ä»¤åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š</p>
<ul>
<li>ä¸€ç§å‘½ä»¤å¯ä»¥å¯¹ä»»ä½•ç±»å‹çš„é”®æ‰§è¡Œï¼Œæ¯”å¦‚è¯´ DEL ã€EXPIREã€RENAMEã€ TYPE ç­‰ï¼ˆåŸºäºç±»å‹çš„å¤šæ€ï¼‰</li>
<li>åªèƒ½å¯¹ç‰¹å®šç±»å‹çš„é”®æ‰§è¡Œï¼Œæ¯”å¦‚ SET åªèƒ½å¯¹å­—ç¬¦ä¸²é”®æ‰§è¡Œã€HSET å¯¹å“ˆå¸Œé”®æ‰§è¡Œã€SADD å¯¹é›†åˆé”®æ‰§è¡Œï¼Œå¦‚æœç±»å‹æ­¥åŒ¹é…ä¼šæŠ¥ç±»å‹é”™è¯¯ï¼š <code>(error) WRONGTYPE Operation against a key holding the wrong kind of value</code></li>
</ul>
<p>Redis ä¸ºäº†ç¡®ä¿åªæœ‰æŒ‡å®šç±»å‹çš„é”®å¯ä»¥æ‰§è¡ŒæŸäº›ç‰¹å®šçš„å‘½ä»¤ï¼Œåœ¨æ‰§è¡Œç±»å‹ç‰¹å®šçš„å‘½ä»¤ä¹‹å‰ï¼Œå…ˆé€šè¿‡å€¼å¯¹è±¡ redisObject ç»“æ„ type å±æ€§æ£€æŸ¥æ“ä½œç±»å‹æ˜¯å¦æ­£ç¡®ï¼Œç„¶åå†å†³å®šæ˜¯å¦æ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤</p>
<p>å¯¹äºå¤šæ€å‘½ä»¤ï¼Œæ¯”å¦‚åˆ—è¡¨å¯¹è±¡æœ‰ ziplist å’Œ linkedlist ä¸¤ç§å®ç°æ–¹å¼ï¼Œé€šè¿‡ redisObject ç»“æ„ encoding å±æ€§ç¡®å®šå…·ä½“çš„ç¼–ç ç±»å‹ï¼Œåº•å±‚è°ƒç”¨å¯¹åº”çš„ API å®ç°å…·ä½“çš„æ“ä½œï¼ˆåŸºäºç¼–ç çš„å¤šæ€ï¼‰</p>
<hr>
<h4 id="å†…å­˜å›æ”¶">å†…å­˜å›æ”¶</h4>
<p>å¯¹è±¡çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå¯ä»¥åˆ’åˆ†ä¸ºåˆ›å»ºå¯¹è±¡ã€ æ“ä½œå¯¹è±¡ã€ é‡Šæ”¾å¯¹è±¡ä¸‰ä¸ªé˜¶æ®µ</p>
<p>C è¯­è¨€æ²¡æœ‰è‡ªåŠ¨å›æ”¶å†…å­˜çš„åŠŸèƒ½ï¼Œæ‰€ä»¥ Redis åœ¨å¯¹è±¡ç³»ç»Ÿä¸­æ„å»ºäº†å¼•ç”¨è®¡æ•°ï¼ˆreference countingï¼‰æŠ€æœ¯å®ç°çš„å†…å­˜å›æ”¶æœºåˆ¶ï¼Œç¨‹åºå¯ä»¥è·Ÿè¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¿¡æ¯ï¼Œåœ¨é€‚å½“çš„æ—¶å€™è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡å¹¶è¿›è¡Œå†…å­˜å›æ”¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObiect</span> &#123;</span></span><br><span class="line">	<span class="comment">// å¼•ç”¨è®¡æ•°</span></span><br><span class="line">	<span class="type">int</span> refcount;</span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure>
<p>å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¿¡æ¯ä¼šéšç€å¯¹è±¡çš„ä½¿ç”¨çŠ¶æ€è€Œä¸æ–­å˜åŒ–ï¼Œåˆ›å»ºæ—¶å¼•ç”¨è®¡æ•° refcount åˆå§‹åŒ–ä¸º 1ï¼Œæ¯æ¬¡è¢«ä¸€ä¸ªæ–°ç¨‹åºä½¿ç”¨æ—¶å¼•ç”¨è®¡æ•°åŠ  1ï¼Œå½“å¯¹è±¡ä¸å†è¢«ä¸€ä¸ªç¨‹åºä½¿ç”¨æ—¶å¼•ç”¨è®¡æ•°å€¼ä¼šè¢«å‡ 1ï¼Œå½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å€¼å˜ä¸º 0 æ—¶ï¼Œå¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ä¼šè¢«é‡Šæ”¾</p>
<hr>
<h4 id="å¯¹è±¡å…±äº«">å¯¹è±¡å…±äº«</h4>
<p>å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å±æ€§å¸¦æœ‰å¯¹è±¡å…±äº«çš„ä½œç”¨ï¼Œå…±äº«å¯¹è±¡æœºåˆ¶æ›´èŠ‚çº¦å†…å­˜ï¼Œæ•°æ®åº“ä¸­ä¿å­˜çš„ç›¸åŒå€¼å¯¹è±¡è¶Šå¤šï¼ŒèŠ‚çº¦çš„å†…å­˜å°±è¶Šå¤š</p>
<p>è®©å¤šä¸ªé”®å…±äº«ä¸€ä¸ªå¯¹è±¡çš„æ­¥éª¤ï¼š</p>
<ul>
<li>
<p>å°†æ•°æ®åº“é”®çš„å€¼æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªç°æœ‰çš„å€¼å¯¹è±¡</p>
</li>
<li>
<p>å°†è¢«å…±äº«çš„å€¼å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å¢ä¸€</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å¯¹è±¡å…±äº«.png" style="zoom:67%;" />
</li>
</ul>
<p>Redis åœ¨åˆå§‹åŒ–æœåŠ¡å™¨æ—¶åˆ›å»ºä¸€ä¸‡ä¸ªï¼ˆé…ç½®æ–‡ä»¶å¯ä»¥ä¿®æ”¹ï¼‰å­—ç¬¦ä¸²å¯¹è±¡ï¼ŒåŒ…å«äº†<strong>ä» 0 åˆ° 9999 çš„æ‰€æœ‰æ•´æ•°å€¼</strong>ï¼Œå½“æœåŠ¡å™¨éœ€è¦ç”¨åˆ°å€¼ä¸º 0 åˆ° 9999 çš„å­—ç¬¦ä¸²å¯¹è±¡æ—¶ï¼ŒæœåŠ¡å™¨å°±ä¼šä½¿ç”¨è¿™äº›å…±äº«å¯¹è±¡ï¼Œè€Œä¸æ˜¯æ–°åˆ›å»ºå¯¹è±¡</p>
<p>æ¯”å¦‚åˆ›å»ºä¸€ä¸ªå€¼ä¸º 100 çš„é”® Aï¼Œå¹¶ä½¿ç”¨ OBJECT REFCOUNT å‘½ä»¤æŸ¥çœ‹é”® A çš„å€¼å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œä¼šå‘ç°å€¼å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º 2ï¼Œå¼•ç”¨è¿™ä¸ªå€¼å¯¹è±¡çš„ä¸¤ä¸ªç¨‹åºåˆ†åˆ«æ˜¯æŒæœ‰è¿™ä¸ªå€¼å¯¹è±¡çš„æœåŠ¡å™¨ç¨‹åºï¼Œä»¥åŠå…±äº«è¿™ä¸ªå€¼å¯¹è±¡çš„é”® A</p>
<p>å…±äº«å¯¹è±¡åœ¨åµŒå¥—äº†å­—ç¬¦ä¸²å¯¹è±¡çš„å¯¹è±¡ï¼ˆlinkedlist ç¼–ç çš„åˆ—è¡¨ã€hashtable ç¼–ç çš„å“ˆå¸Œã€zset ç¼–ç çš„æœ‰åºé›†åˆï¼‰ä¸­ä¹Ÿèƒ½ä½¿ç”¨</p>
<p>Redis ä¸å…±äº«åŒ…å«å­—ç¬¦ä¸²å¯¹è±¡çš„åŸå› ï¼šéªŒè¯å…±äº«å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡æ˜¯å¦ç›¸åŒçš„å¤æ‚åº¦è¶Šé«˜ï¼Œæ¶ˆè€—çš„ CPU æ—¶é—´ä¹Ÿä¼šè¶Šå¤š</p>
<ul>
<li>æ•´æ•°å€¼çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œ éªŒè¯æ“ä½œçš„å¤æ‚åº¦ä¸º O(1)</li>
<li>å­—ç¬¦ä¸²å€¼çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œ éªŒè¯æ“ä½œçš„å¤æ‚åº¦ä¸º O(N)</li>
<li>å¦‚æœå…±äº«å¯¹è±¡æ˜¯åŒ…å«äº†å¤šä¸ªå€¼ï¼ˆæˆ–è€…å¯¹è±¡çš„ï¼‰å¯¹è±¡ï¼Œæ¯”å¦‚åˆ—è¡¨å¯¹è±¡æˆ–è€…å“ˆå¸Œå¯¹è±¡ï¼ŒéªŒè¯æ“ä½œçš„å¤æ‚åº¦ä¸º O(N^2)</li>
</ul>
<hr>
<h4 id="ç©ºè½¬æ—¶é•¿">ç©ºè½¬æ—¶é•¿</h4>
<p>redisObject ç»“æ„åŒ…å«ä¸€ä¸ª lru å±æ€§ï¼Œè¯¥å±æ€§è®°å½•äº†å¯¹è±¡æœ€åä¸€æ¬¡è¢«å‘½ä»¤ç¨‹åºè®¿é—®çš„æ—¶é—´</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObiect</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> lru:<span class="number">22</span>; </span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure>
<p>OBJECT IDLETIME å‘½ä»¤å¯ä»¥æ‰“å°å‡ºç»™å®šé”®çš„ç©ºè½¬æ—¶é•¿ï¼Œè¯¥å€¼å°±æ˜¯é€šè¿‡å°†å½“å‰æ—¶é—´å‡å»é”®çš„å€¼å¯¹è±¡çš„ lru æ—¶é—´è®¡ç®—å¾—å‡ºçš„ï¼Œè¿™ä¸ªå‘½ä»¤åœ¨è®¿é—®é”®çš„å€¼å¯¹è±¡æ—¶ï¼Œä¸ä¼šä¿®æ”¹å€¼å¯¹è±¡çš„ lru å±æ€§</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; OBJECT IDLETIME msg</span><br><span class="line">(<span class="built_in">integer</span>) 10</span><br><span class="line"><span class="comment"># ç­‰å¾…ä¸€åˆ†é’Ÿ</span></span><br><span class="line">redis&gt; OBJECT IDLETIME msg</span><br><span class="line">(<span class="built_in">integer</span>) 70</span><br><span class="line"><span class="comment"># è®¿é—® msg</span></span><br><span class="line">redis&gt; GET msg</span><br><span class="line"><span class="string">&quot;hello world&quot;</span></span><br><span class="line"><span class="comment"># é”®å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œç©ºè½¬æ—¶é•¿ä¸º 0</span></span><br><span class="line">redis&gt; OBJECT IDLETIME msg</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure>
<p>ç©ºè½¬æ—¶é•¿çš„ä½œç”¨ï¼šå¦‚æœæœåŠ¡å™¨å¼€å¯ maxmemory é€‰é¡¹ï¼Œå¹¶ä¸”å›æ”¶å†…å­˜çš„ç®—æ³•ä¸º volatile-lru æˆ–è€… allkeys-lruï¼Œé‚£ä¹ˆå½“æœåŠ¡å™¨å ç”¨çš„å†…å­˜æ•°è¶…è¿‡äº† maxmemory æ‰€è®¾ç½®çš„ä¸Šé™å€¼æ—¶ï¼Œç©ºè½¬æ—¶é•¿è¾ƒé«˜çš„é‚£éƒ¨åˆ†é”®ä¼šä¼˜å…ˆè¢«æœåŠ¡å™¨é‡Šæ”¾ï¼Œä»è€Œå›æ”¶å†…å­˜ï¼ˆLRU ç®—æ³•ï¼‰</p>
<hr>
<h3 id="string">string</h3>
<h4 id="ç®€ä»‹">ç®€ä»‹</h4>
<p>å­˜å‚¨çš„æ•°æ®ï¼šå•ä¸ªæ•°æ®ï¼Œæœ€ç®€å•çš„æ•°æ®å­˜å‚¨ç±»å‹ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„æ•°æ®å­˜å‚¨ç±»å‹ï¼Œå®è´¨ä¸Šæ˜¯å­˜ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œstring ç±»å‹æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œå¯ä»¥åŒ…å«ä»»ä½•æ•°æ®ï¼Œæ¯”å¦‚å›¾ç‰‡æˆ–è€…åºåˆ—åŒ–çš„å¯¹è±¡</p>
<p>å­˜å‚¨æ•°æ®çš„æ ¼å¼ï¼šä¸€ä¸ªå­˜å‚¨ç©ºé—´ä¿å­˜ä¸€ä¸ªæ•°æ®ï¼Œæ¯ä¸€ä¸ªç©ºé—´ä¸­åªèƒ½ä¿å­˜ä¸€ä¸ªå­—ç¬¦ä¸²ä¿¡æ¯</p>
<p>å­˜å‚¨å†…å®¹ï¼šé€šå¸¸ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œå¦‚æœå­—ç¬¦ä¸²ä»¥æ•´æ•°çš„å½¢å¼å±•ç¤ºï¼Œå¯ä»¥ä½œä¸ºæ•°å­—æ“ä½œä½¿ç”¨</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-stringç»“æ„å›¾.png" style="zoom:50%;" />
<p>Redis æ‰€æœ‰æ“ä½œéƒ½æ˜¯<strong>åŸå­æ€§</strong>çš„ï¼Œé‡‡ç”¨<strong>å•çº¿ç¨‹</strong>æœºåˆ¶ï¼Œå‘½ä»¤æ˜¯å•ä¸ªé¡ºåºæ‰§è¡Œï¼Œæ— éœ€è€ƒè™‘å¹¶å‘å¸¦æ¥å½±å“ï¼ŒåŸå­æ€§å°±æ˜¯æœ‰ä¸€ä¸ªå¤±è´¥åˆ™éƒ½å¤±è´¥</p>
<p>å­—ç¬¦ä¸²å¯¹è±¡å¯ä»¥æ˜¯ intã€rawã€embstr ä¸‰ç§å®ç°æ–¹å¼</p>
<hr>
<h4 id="æ“ä½œ">æ“ä½œ</h4>
<p>æŒ‡ä»¤æ“ä½œï¼š</p>
<ul>
<li>
<p>æ•°æ®æ“ä½œï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> key value			<span class="comment">#æ·»åŠ /ä¿®æ”¹æ•°æ®æ·»åŠ /ä¿®æ”¹æ•°æ®</span></span><br><span class="line">del key					<span class="comment">#åˆ é™¤æ•°æ®</span></span><br><span class="line">setnx key value			<span class="comment">#åˆ¤å®šæ€§æ·»åŠ æ•°æ®ï¼Œé”®å€¼ä¸ºç©ºåˆ™è®¾æ·»åŠ </span></span><br><span class="line">mset k1 v1 k2 v2...		<span class="comment">#æ·»åŠ /ä¿®æ”¹å¤šä¸ªæ•°æ®ï¼Œmï¼šMultiple</span></span><br><span class="line">append key value		<span class="comment">#è¿½åŠ ä¿¡æ¯åˆ°åŸå§‹ä¿¡æ¯åéƒ¨ï¼ˆå¦‚æœåŸå§‹ä¿¡æ¯å­˜åœ¨å°±è¿½åŠ ï¼Œå¦åˆ™æ–°å»ºï¼‰</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æŸ¥è¯¢æ“ä½œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">get key					<span class="comment">#è·å–æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œè¿”å›ç©ºï¼ˆnilï¼‰</span></span><br><span class="line">mget key1 key2...		<span class="comment">#è·å–å¤šä¸ªæ•°æ®</span></span><br><span class="line">strlen key				<span class="comment">#è·å–æ•°æ®å­—ç¬¦ä¸ªæ•°ï¼ˆå­—ç¬¦ä¸²é•¿åº¦ï¼‰</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è®¾ç½®æ•°å€¼æ•°æ®å¢åŠ /å‡å°‘æŒ‡å®šèŒƒå›´çš„å€¼</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">incr key					<span class="comment">#key++</span></span><br><span class="line">incrby key increment		<span class="comment">#key+increment</span></span><br><span class="line">incrbyfloat key increment	<span class="comment">#å¯¹å°æ•°æ“ä½œ</span></span><br><span class="line">decr key					<span class="comment">#key--</span></span><br><span class="line">decrby key increment		<span class="comment">#key-increment</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è®¾ç½®æ•°æ®å…·æœ‰æŒ‡å®šçš„ç”Ÿå‘½å‘¨æœŸ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setex key seconds value  		<span class="comment">#è®¾ç½®key-valueå­˜æ´»æ—¶é—´ï¼Œsecondså•ä½æ˜¯ç§’</span></span><br><span class="line">psetex key milliseconds value	<span class="comment">#æ¯«ç§’çº§</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ³¨æ„äº‹é¡¹ï¼š</p>
<ol>
<li>
<p>æ•°æ®æ“ä½œä¸æˆåŠŸçš„åé¦ˆä¸æ•°æ®æ­£å¸¸æ“ä½œä¹‹é—´çš„å·®å¼‚</p>
<ul>
<li>
<p>è¡¨ç¤ºè¿è¡Œç»“æœæ˜¯å¦æˆåŠŸ</p>
<ul>
<li>
<p>(integer) 0  â†’ false ï¼Œå¤±è´¥</p>
</li>
<li>
<p>(integer) 1  â†’ trueï¼ŒæˆåŠŸ</p>
</li>
</ul>
</li>
<li>
<p>è¡¨ç¤ºè¿è¡Œç»“æœå€¼</p>
<ul>
<li>
<p>(integer) 3  â†’ 3 ä¸ª</p>
</li>
<li>
<p>(integer) 1  â†’ 1 ä¸ª</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>æ•°æ®æœªè·å–åˆ°æ—¶ï¼Œå¯¹åº”çš„æ•°æ®ä¸ºï¼ˆnilï¼‰ï¼Œç­‰åŒäºnull</p>
</li>
<li>
<p><strong>æ•°æ®æœ€å¤§å­˜å‚¨é‡</strong>ï¼š512MB</p>
</li>
<li>
<p>string åœ¨ Redis å†…éƒ¨å­˜å‚¨é»˜è®¤å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå½“é‡åˆ°å¢å‡ç±»æ“ä½œ incrï¼Œdecr æ—¶<strong>ä¼šè½¬æˆæ•°å€¼å‹</strong>è¿›è¡Œè®¡ç®—</p>
</li>
<li>
<p>æŒ‰æ•°å€¼è¿›è¡Œæ“ä½œçš„æ•°æ®ï¼Œå¦‚æœåŸå§‹æ•°æ®ä¸èƒ½è½¬æˆæ•°å€¼ï¼Œæˆ–è¶…è¶Šäº†Redis æ•°å€¼ä¸Šé™èŒƒå›´ï¼Œå°†æŠ¥é”™<br>
9223372036854775807ï¼ˆjava ä¸­ Long å‹æ•°æ®æœ€å¤§å€¼ï¼ŒLong.MAX_VALUEï¼‰</p>
</li>
<li>
<p>Redis å¯ç”¨äºæ§åˆ¶æ•°æ®åº“è¡¨ä¸»é”® IDï¼Œä¸ºæ•°æ®åº“è¡¨ä¸»é”®æä¾›ç”Ÿæˆç­–ç•¥ï¼Œä¿éšœæ•°æ®åº“è¡¨çš„ä¸»é”®å”¯ä¸€æ€§</p>
</li>
</ol>
<p>å•æ•°æ®å’Œå¤šæ•°æ®çš„é€‰æ‹©ï¼š</p>
<ul>
<li>å•æ•°æ®æ‰§è¡Œ 3 æ¡æŒ‡ä»¤çš„è¿‡ç¨‹ï¼š3 æ¬¡å‘é€ + 3 æ¬¡å¤„ç† + 3 æ¬¡è¿”å›</li>
<li>å¤šæ•°æ®æ‰§è¡Œ 1 æ¡æŒ‡ä»¤çš„è¿‡ç¨‹ï¼š1 æ¬¡å‘é€ + 3 æ¬¡å¤„ç† + 1 æ¬¡è¿”å›ï¼ˆå‘é€å’Œè¿”å›çš„äº‹ä»¶ç•¥é«˜äºå•æ•°æ®ï¼‰</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/stringå•æ•°æ®ä¸å¤šæ•°æ®æ“ä½œ.png" style="zoom: 33%;" />
<hr>
<h4 id="å®ç°">å®ç°</h4>
<p>å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ intã€rawã€embstr ä¸‰ç§</p>
<ul>
<li>
<p>intï¼šå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯<strong>æ•´æ•°å€¼</strong>ï¼Œå¹¶ä¸”æ•´æ•°å€¼å¯ä»¥ç”¨ long ç±»å‹æ¥è¡¨ç¤ºï¼Œé‚£ä¹ˆå¯¹è±¡ä¼šå°†æ•´æ•°å€¼ä¿å­˜åœ¨å­—ç¬¦ä¸²å¯¹è±¡ç»“æ„çš„ ptr å±æ€§é¢ï¼ˆå°† void * è½¬æ¢æˆ long)ï¼Œå¹¶å°†å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º intï¼ˆæµ®ç‚¹æ•°ç”¨å¦å¤–ä¸¤ç§æ–¹å¼ï¼‰</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å­—ç¬¦ä¸²å¯¹è±¡intç¼–ç .png" style="zoom:67%;" />
</li>
<li>
<p>rawï¼šå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¹¶ä¸”å€¼çš„é•¿åº¦å¤§äº 39 å­—èŠ‚ï¼Œé‚£ä¹ˆå¯¹è±¡å°†ä½¿ç”¨ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰æ¥ä¿å­˜è¯¥å€¼ï¼Œå¹¶å°†å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º raw</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1raw%E7%BC%96%E7%A0%81.png" alt=""></p>
</li>
<li>
<p>embstrï¼šå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¹¶ä¸”å€¼çš„é•¿åº¦å°äºç­‰äº 39 å­—èŠ‚ï¼Œé‚£ä¹ˆå¯¹è±¡å°†ä½¿ç”¨ embstr ç¼–ç çš„æ–¹å¼æ¥ä¿å­˜è¿™ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¹¶å°†å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º embstr</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1embstr%E7%BC%96%E7%A0%81.png" alt=""></p>
<p>ä¸Šå›¾æ‰€ç¤ºï¼Œembstr ä¸ raw éƒ½ä½¿ç”¨äº† redisObject å’Œ sdshdr æ¥è¡¨ç¤ºå­—ç¬¦ä¸²å¯¹è±¡ï¼Œä½†æ˜¯ raw éœ€è¦è°ƒç”¨ä¸¤æ¬¡å†…å­˜åˆ†é…å‡½æ•°åˆ†åˆ«åˆ›å»ºä¸¤ç§ç»“æ„ï¼Œembstr åªéœ€è¦ä¸€æ¬¡å†…å­˜åˆ†é…æ¥åˆ†é…ä¸€å—<strong>è¿ç»­çš„ç©ºé—´</strong></p>
</li>
</ul>
<p>embstr æ˜¯ç”¨äºä¿å­˜çŸ­å­—ç¬¦ä¸²çš„ä¸€ç§ç¼–ç æ–¹å¼ï¼Œå¯¹æ¯” raw çš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å†…å­˜åˆ†é…æ¬¡æ•°ä»ä¸¤æ¬¡é™ä½ä¸ºä¸€æ¬¡ï¼ŒåŒæ ·é‡Šæ”¾å†…å­˜çš„æ¬¡æ•°ä¹Ÿä»ä¸¤æ¬¡å˜ä¸ºä¸€æ¬¡</li>
<li>embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡çš„æ•°æ®éƒ½ä¿å­˜åœ¨åŒä¸€å—è¿ç»­å†…å­˜ï¼Œæ‰€ä»¥æ¯” raw ç¼–ç èƒ½å¤Ÿæ›´å¥½åœ°åˆ©ç”¨ç¼“å­˜ä¼˜åŠ¿ï¼ˆå±€éƒ¨æ€§åŸç†ï¼‰</li>
</ul>
<p>int å’Œ embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡åœ¨æ¡ä»¶æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œä¼šè¢«è½¬æ¢ä¸º raw ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼š</p>
<ul>
<li>int ç¼–ç çš„æ•´æ•°å€¼ï¼Œæ‰§è¡Œ APPEND å‘½ä»¤è¿½åŠ ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå…ˆå°†æ•´æ•°å€¼è½¬ä¸ºå­—ç¬¦ä¸²ç„¶åè¿½åŠ ï¼Œæœ€åå¾—åˆ°ä¸€ä¸ª raw ç¼–ç çš„å¯¹è±¡</li>
<li>Redis æ²¡æœ‰ä¸º embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ç¼–å†™ä»»ä½•ç›¸åº”çš„ä¿®æ”¹ç¨‹åºï¼Œæ‰€ä»¥ embstr å¯¹è±¡å®é™…ä¸Š<strong>æ˜¯åªè¯»çš„</strong>ï¼Œæ‰§è¡Œä¿®æ”¹å‘½ä»¤ä¼šå°†å¯¹è±¡çš„ç¼–ç ä» embstr è½¬æ¢æˆ rawï¼Œæ“ä½œå®Œæˆåå¾—åˆ°ä¸€ä¸ª raw ç¼–ç çš„å¯¹è±¡</li>
</ul>
<p>æŸäº›æƒ…å†µä¸‹ï¼Œç¨‹åºä¼šå°†å­—ç¬¦ä¸²å¯¹è±¡é‡Œé¢çš„å­—ç¬¦ä¸²å€¼è½¬æ¢å›æµ®ç‚¹æ•°å€¼ï¼Œæ‰§è¡ŒæŸäº›æ“ä½œåå†å°†æµ®ç‚¹æ•°å€¼è½¬æ¢å›å­—ç¬¦ä¸²å€¼ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; SET pi 3.14 </span><br><span class="line">OK </span><br><span class="line">redis&gt; OBJECT ENCODING pi</span><br><span class="line"><span class="string">&quot;embstr&quot;</span> </span><br><span class="line">redis&gt; INCRBYFLOAT pi 2.0 <span class="comment"># è½¬ä¸ºæµ®ç‚¹æ•°æ‰§è¡Œå¢åŠ çš„æ“ä½œ</span></span><br><span class="line"><span class="string">&quot;5. 14&quot;</span> </span><br><span class="line">redis&gt; OBJECT ENCODING pi </span><br><span class="line"><span class="string">&quot;embstr&quot;</span> </span><br></pre></td></tr></table></figure>
<hr>
<h4 id="åº”ç”¨">åº”ç”¨</h4>
<p>ä¸»é¡µé«˜é¢‘è®¿é—®ä¿¡æ¯æ˜¾ç¤ºæ§åˆ¶ï¼Œä¾‹å¦‚æ–°æµªå¾®åšå¤§ V ä¸»é¡µæ˜¾ç¤ºç²‰ä¸æ•°ä¸å¾®åšæ•°é‡</p>
<ul>
<li>
<p>åœ¨ Redis ä¸­ä¸ºå¤§ V ç”¨æˆ·è®¾å®šç”¨æˆ·ä¿¡æ¯ï¼Œä»¥ç”¨æˆ·ä¸»é”®å’Œå±æ€§å€¼ä½œä¸º keyï¼Œåå°è®¾å®šå®šæ—¶åˆ·æ–°ç­–ç•¥</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> user:<span class="built_in">id</span>:3506728370:fans 12210947</span><br><span class="line"><span class="built_in">set</span> user:<span class="built_in">id</span>:3506728370:blogs 6164</span><br><span class="line"><span class="built_in">set</span> user:<span class="built_in">id</span>:3506728370:focuses 83</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½¿ç”¨ JSON æ ¼å¼ä¿å­˜æ•°æ®</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user:<span class="built_in">id</span>:3506728370 â†’ &#123;<span class="string">&quot;fans&quot;</span>:12210947,<span class="string">&quot;blogs&quot;</span>:6164,<span class="string">&quot;focuses&quot;</span>:83&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>keyçš„è®¾ç½®çº¦å®šï¼šè¡¨å : ä¸»é”®å : ä¸»é”®å€¼ : å­—æ®µå</p>
<table>
<thead>
<tr>
<th>è¡¨å</th>
<th>ä¸»é”®å</th>
<th>ä¸»é”®å€¼</th>
<th>å­—æ®µå</th>
</tr>
</thead>
<tbody>
<tr>
<td>order</td>
<td>id</td>
<td>29437595</td>
<td>name</td>
</tr>
<tr>
<td>equip</td>
<td>id</td>
<td>390472345</td>
<td>type</td>
</tr>
<tr>
<td>news</td>
<td>id</td>
<td>202004150</td>
<td>title</td>
</tr>
</tbody>
</table>
</li>
</ul>
<hr>
<h3 id="hash">hash</h3>
<h4 id="ç®€ä»‹-2">ç®€ä»‹</h4>
<p>æ•°æ®å­˜å‚¨éœ€æ±‚ï¼šå¯¹ä¸€ç³»åˆ—å­˜å‚¨çš„æ•°æ®è¿›è¡Œç¼–ç»„ï¼Œæ–¹ä¾¿ç®¡ç†ï¼Œå…¸å‹åº”ç”¨å­˜å‚¨å¯¹è±¡ä¿¡æ¯</p>
<p>æ•°æ®å­˜å‚¨ç»“æ„ï¼šä¸€ä¸ªå­˜å‚¨ç©ºé—´ä¿å­˜å¤šä¸ªé”®å€¼å¯¹æ•°æ®</p>
<p>hash ç±»å‹ï¼šåº•å±‚ä½¿ç”¨<strong>å“ˆå¸Œè¡¨</strong>ç»“æ„å®ç°æ•°æ®å­˜å‚¨</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/hashç»“æ„å›¾.png" style="zoom: 33%;" />
<p>Redis ä¸­çš„ hash ç±»ä¼¼äº Java ä¸­çš„  <code>Map&lt;String, Map&lt;Object,object&gt;&gt;</code>ï¼Œå·¦è¾¹æ˜¯ keyï¼Œå³è¾¹æ˜¯å€¼ï¼Œä¸­é—´å« field å­—æ®µï¼Œæœ¬è´¨ä¸Š <strong>hash å­˜äº†ä¸€ä¸ª key-value çš„å­˜å‚¨ç©ºé—´</strong></p>
<p>hash æ˜¯æŒ‡çš„ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªæ•°æ®</p>
<ul>
<li>å¦‚æœ field æ•°é‡è¾ƒå°‘ï¼Œå­˜å‚¨ç»“æ„ä¼˜åŒ–ä¸º<strong>å‹ç¼©åˆ—è¡¨ç»“æ„</strong>ï¼ˆæœ‰åºï¼‰</li>
<li>å¦‚æœ field æ•°é‡è¾ƒå¤šï¼Œå­˜å‚¨ç»“æ„ä½¿ç”¨ HashMap ç»“æ„ï¼ˆæ— åºï¼‰</li>
</ul>
<hr>
<h4 id="æ“ä½œ-2">æ“ä½œ</h4>
<p>æŒ‡ä»¤æ“ä½œï¼š</p>
<ul>
<li>
<p>æ•°æ®æ“ä½œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hset key field value		<span class="comment">#æ·»åŠ /ä¿®æ”¹æ•°æ®</span></span><br><span class="line">hdel key field1 [field2]	<span class="comment">#åˆ é™¤æ•°æ®ï¼Œ[]ä»£è¡¨å¯é€‰</span></span><br><span class="line">hsetnx key field value		<span class="comment">#è®¾ç½®fieldçš„å€¼ï¼Œå¦‚æœè¯¥fieldå­˜åœ¨åˆ™ä¸åšä»»ä½•æ“ä½œ</span></span><br><span class="line">hmset key f1 v1 f2 v2...	<span class="comment">#æ·»åŠ /ä¿®æ”¹å¤šä¸ªæ•°æ®</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æŸ¥è¯¢æ“ä½œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hget key field				<span class="comment">#è·å–æŒ‡å®šfieldå¯¹åº”æ•°æ®</span></span><br><span class="line">hgetall key					<span class="comment">#è·å–æŒ‡å®škeyæ‰€æœ‰æ•°æ®</span></span><br><span class="line">hmget key field1 field2...	<span class="comment">#è·å–å¤šä¸ªæ•°æ®</span></span><br><span class="line">hexists key field			<span class="comment">#è·å–å“ˆå¸Œè¡¨ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„å­—æ®µ</span></span><br><span class="line">hlen key					<span class="comment">#è·å–å“ˆå¸Œè¡¨ä¸­å­—æ®µçš„æ•°é‡</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è·å–å“ˆå¸Œè¡¨ä¸­æ‰€æœ‰çš„å­—æ®µåæˆ–å­—æ®µå€¼</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hkeys key					<span class="comment">#è·å–æ‰€æœ‰çš„field	</span></span><br><span class="line">hvals key					<span class="comment">#è·å–æ‰€æœ‰çš„value</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è®¾ç½®æŒ‡å®šå­—æ®µçš„æ•°å€¼æ•°æ®å¢åŠ æŒ‡å®šèŒƒå›´çš„å€¼</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hincrby key field increment		<span class="comment">#æŒ‡å®šå­—æ®µçš„æ•°å€¼æ•°æ®å¢åŠ æŒ‡å®šçš„å€¼ï¼Œincrementä¸ºè´Ÿæ•°åˆ™å‡å°‘</span></span><br><span class="line">hincrbyfloat key field increment<span class="comment">#æ“ä½œå°æ•°</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ³¨æ„äº‹é¡¹</p>
<ol>
<li>hash ç±»å‹ä¸­ value åªèƒ½å­˜å‚¨å­—ç¬¦ä¸²ï¼Œä¸å…è®¸å­˜å‚¨å…¶ä»–æ•°æ®ç±»å‹ï¼Œä¸å­˜åœ¨åµŒå¥—ç°è±¡ï¼Œå¦‚æœæ•°æ®æœªè·å–åˆ°ï¼Œå¯¹åº”çš„å€¼ä¸ºï¼ˆnilï¼‰</li>
<li>æ¯ä¸ª hash å¯ä»¥å­˜å‚¨ 2^32 - 1 ä¸ªé”®å€¼å¯¹</li>
<li>hash ç±»å‹å’Œå¯¹è±¡çš„æ•°æ®å­˜å‚¨å½¢å¼ç›¸ä¼¼ï¼Œå¹¶ä¸”å¯ä»¥çµæ´»æ·»åŠ åˆ é™¤å¯¹è±¡å±æ€§ã€‚ä½† hash è®¾è®¡åˆè¡·ä¸æ˜¯ä¸ºäº†å­˜å‚¨å¤§é‡å¯¹è±¡è€Œè®¾è®¡çš„ï¼Œä¸å¯æ»¥ç”¨ï¼Œä¸å¯å°† hash ä½œä¸ºå¯¹è±¡åˆ—è¡¨ä½¿ç”¨</li>
<li>hgetall æ“ä½œå¯ä»¥è·å–å…¨éƒ¨å±æ€§ï¼Œå¦‚æœå†…éƒ¨ field è¿‡å¤šï¼Œéå†æ•´ä½“æ•°æ®æ•ˆç‡å°±å¾ˆä¼šä½ï¼Œæœ‰å¯èƒ½æˆä¸ºæ•°æ®è®¿é—®ç“¶é¢ˆ</li>
</ol>
<hr>
<h4 id="å®ç°-2">å®ç°</h4>
<p>å“ˆå¸Œå¯¹è±¡çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼šziplistï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰ã€hashtableï¼ˆå“ˆå¸Œè¡¨ã€å­—å…¸ï¼‰</p>
<ul>
<li>
<p>å‹ç¼©åˆ—è¡¨å®ç°å“ˆå¸Œå¯¹è±¡ï¼šåŒä¸€é”®å€¼å¯¹çš„èŠ‚ç‚¹æ€»æ˜¯æŒ¨åœ¨ä¸€èµ·ï¼Œä¿å­˜é”®çš„èŠ‚ç‚¹åœ¨å‰ï¼Œä¿å­˜å€¼çš„èŠ‚ç‚¹åœ¨å</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%93%88%E5%B8%8C%E5%AF%B9%E8%B1%A1ziplist.png" alt=""></p>
</li>
<li>
<p>å­—å…¸å®ç°å“ˆå¸Œå¯¹è±¡ï¼šå­—å…¸çš„æ¯ä¸€ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œæ¯ä¸ªå€¼ä¹Ÿæ˜¯</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å“ˆå¸Œå¯¹è±¡dict.png" style="zoom:67%;" />
</li>
</ul>
<p>å½“å­˜å‚¨çš„æ•°æ®é‡æ¯”è¾ƒå°çš„æƒ…å†µä¸‹ï¼ŒRedis æ‰ä½¿ç”¨å‹ç¼©åˆ—è¡¨æ¥å®ç°å­—å…¸ç±»å‹ï¼Œå…·ä½“éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>å½“é”®å€¼å¯¹æ•°é‡å°äº hash-max-ziplist-entries é…ç½®ï¼ˆé»˜è®¤ 512 ä¸ªï¼‰</li>
<li>æ‰€æœ‰é”®å’Œå€¼çš„é•¿åº¦éƒ½å°äº hash-max-ziplist-value é…ç½®ï¼ˆé»˜è®¤ 64 å­—èŠ‚ï¼‰</li>
</ul>
<p>ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼æ˜¯å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹çš„ï¼Œå½“ä¸¤ä¸ªæ¡ä»¶çš„ä»»æ„ä¸€ä¸ªä¸èƒ½è¢«æ»¡è¶³æ—¶ï¼Œå¯¹è±¡çš„ç¼–ç è½¬æ¢æ“ä½œå°±ä¼šè¢«æ‰§è¡Œ</p>
<p>ziplist ä½¿ç”¨æ›´åŠ ç´§å‡‘çš„ç»“æ„å®ç°å¤šä¸ªå…ƒç´ çš„è¿ç»­å­˜å‚¨ï¼Œæ‰€ä»¥åœ¨èŠ‚çœå†…å­˜æ–¹é¢æ¯” hashtable æ›´åŠ ä¼˜ç§€ï¼Œå½“ ziplist æ— æ³•æ»¡è¶³å“ˆå¸Œç±»å‹æ—¶ï¼ŒRedis ä¼šä½¿ç”¨ hashtable ä½œä¸ºå“ˆå¸Œçš„å†…éƒ¨å®ç°ï¼Œå› ä¸ºæ­¤æ—¶ ziplist çš„è¯»å†™æ•ˆç‡ä¼šä¸‹é™ï¼Œè€Œ hashtable çš„è¯»å†™æ—¶é—´å¤æ‚åº¦ä¸º O(1)</p>
<hr>
<h4 id="åº”ç”¨-2">åº”ç”¨</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user:<span class="built_in">id</span>:3506728370 â†’ &#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;æ˜¥æ™š&quot;</span>,<span class="string">&quot;fans&quot;</span>:12210862,<span class="string">&quot;blogs&quot;</span>:83&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºä»¥ä¸Šæ•°æ®ï¼Œä½¿ç”¨å•æ¡å»å­˜çš„è¯ï¼Œå­˜çš„æ¡æ•°ä¼šå¾ˆå¤šã€‚ä½†å¦‚æœç”¨ json æ ¼å¼ï¼Œå­˜ä¸€æ¡æ•°æ®å°±å¤Ÿäº†ã€‚</p>
<p>å‡å¦‚ç°åœ¨ç²‰ä¸æ•°é‡å‘ç”Ÿäº†å˜åŒ–ï¼Œè¦æŠŠæ•´ä¸ªå€¼éƒ½æ”¹å˜ï¼Œä½†æ˜¯ç”¨å•æ¡å­˜å°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œåªéœ€è¦æ”¹å…¶ä¸­ä¸€ä¸ªå°±å¯ä»¥</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/hashåº”ç”¨åœºæ™¯ç»“æ„å›¾.png" style="zoom: 33%;" />
<p>å¯ä»¥å®ç°è´­ç‰©è½¦çš„åŠŸèƒ½ï¼Œkey å¯¹åº”ç€æ¯ä¸ªç”¨æˆ·ï¼Œå­˜å‚¨ç©ºé—´å­˜å‚¨è´­ç‰©è½¦çš„ä¿¡æ¯</p>
<hr>
<h3 id="list">list</h3>
<h4 id="ç®€ä»‹-3">ç®€ä»‹</h4>
<p>æ•°æ®å­˜å‚¨éœ€æ±‚ï¼šå­˜å‚¨å¤šä¸ªæ•°æ®ï¼Œå¹¶å¯¹æ•°æ®è¿›å…¥å­˜å‚¨ç©ºé—´çš„é¡ºåºè¿›è¡ŒåŒºåˆ†</p>
<p>æ•°æ®å­˜å‚¨ç»“æ„ï¼šä¸€ä¸ªå­˜å‚¨ç©ºé—´ä¿å­˜å¤šä¸ªæ•°æ®ï¼Œä¸”é€šè¿‡æ•°æ®å¯ä»¥ä½“ç°è¿›å…¥é¡ºåºï¼Œå…è®¸é‡å¤å…ƒç´ </p>
<p>list ç±»å‹ï¼šä¿å­˜å¤šä¸ªæ•°æ®ï¼Œåº•å±‚ä½¿ç”¨<strong>åŒå‘é“¾è¡¨</strong>å­˜å‚¨ç»“æ„å®ç°ï¼Œç±»ä¼¼äº LinkedList</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/listç»“æ„å›¾.png" style="zoom:33%;" />
<p>å¦‚æœä¸¤ç«¯éƒ½èƒ½å­˜å–æ•°æ®çš„è¯ï¼Œè¿™å°±æ˜¯åŒç«¯é˜Ÿåˆ—ï¼Œå¦‚æœåªèƒ½ä»ä¸€ç«¯è¿›ä¸€ç«¯å‡ºï¼Œè¿™ä¸ªæ¨¡å‹å«æ ˆ</p>
<hr>
<h4 id="æ“ä½œ-3">æ“ä½œ</h4>
<p>æŒ‡ä»¤æ“ä½œï¼š</p>
<ul>
<li>
<p>æ•°æ®æ“ä½œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lpush key value1 [value2]...<span class="comment">#ä»å·¦è¾¹æ·»åŠ /ä¿®æ”¹æ•°æ®(è¡¨å¤´)</span></span><br><span class="line">rpush key value1 [value2]...<span class="comment">#ä»å³è¾¹æ·»åŠ /ä¿®æ”¹æ•°æ®(è¡¨å°¾)</span></span><br><span class="line">lpop key					<span class="comment">#ä»å·¦è¾¹è·å–å¹¶ç§»é™¤ç¬¬ä¸€ä¸ªæ•°æ®ï¼Œç±»ä¼¼äºå‡ºæ ˆ/å‡ºé˜Ÿ</span></span><br><span class="line">rpop key					<span class="comment">#ä»å³è¾¹è·å–å¹¶ç§»é™¤ç¬¬ä¸€ä¸ªæ•°æ®</span></span><br><span class="line">lrem key count value		<span class="comment">#åˆ é™¤æŒ‡å®šæ•°æ®ï¼Œcount=2åˆ é™¤2ä¸ªï¼Œè¯¥valueå¯èƒ½æœ‰å¤šä¸ª(é‡å¤æ•°æ®)</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æŸ¥è¯¢æ“ä½œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lrange key start stop		<span class="comment">#ä»å·¦è¾¹éå†æ•°æ®å¹¶æŒ‡å®šå¼€å§‹å’Œç»“æŸç´¢å¼•ï¼Œ0æ˜¯ç¬¬ä¸€ä¸ªç´¢å¼•ï¼Œ-1æ˜¯ç»ˆç´¢å¼•</span></span><br><span class="line">lindex key index			<span class="comment">#è·å–æŒ‡å®šç´¢å¼•æ•°æ®ï¼Œæ²¡æœ‰åˆ™ä¸ºnilï¼Œæ²¡æœ‰ç´¢å¼•è¶Šç•Œ</span></span><br><span class="line">llen key					<span class="comment">#listä¸­æ•°æ®é•¿åº¦/ä¸ªæ•°</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è§„å®šæ—¶é—´å†…è·å–å¹¶ç§»é™¤æ•°æ®</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">b							<span class="comment">#ä»£è¡¨é˜»å¡</span></span><br><span class="line">blpop key1 [key2] <span class="built_in">timeout</span>	<span class="comment">#åœ¨æŒ‡å®šæ—¶é—´å†…è·å–æŒ‡å®škey(å¯ä»¥å¤šä¸ª)çš„æ•°æ®ï¼Œè¶…æ—¶åˆ™ä¸º(nil)</span></span><br><span class="line">							<span class="comment">#å¯ä»¥ä»å…¶ä»–å®¢æˆ·ç«¯å†™æ•°æ®ï¼Œå½“å‰å®¢æˆ·ç«¯é˜»å¡è¯»å–æ•°æ®</span></span><br><span class="line">brpop key1 [key2] <span class="built_in">timeout</span>	<span class="comment">#ä»å³è¾¹æ“ä½œ</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¤åˆ¶æ“ä½œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brpoplpush <span class="built_in">source</span> destination <span class="built_in">timeout</span>	<span class="comment">#ä»sourceè·å–æ•°æ®æ”¾å…¥destinationï¼Œå‡å¦‚åœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰ä»»ä½•å…ƒç´ è¢«å¼¹å‡ºï¼Œåˆ™è¿”å›ä¸€ä¸ªnilå’Œç­‰å¾…æ—¶é•¿ã€‚åä¹‹ï¼Œè¿”å›ä¸€ä¸ªå«æœ‰ä¸¤ä¸ªå…ƒç´ çš„åˆ—è¡¨ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯è¢«å¼¹å‡ºå…ƒç´ çš„å€¼ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯ç­‰å¾…æ—¶é•¿</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ³¨æ„äº‹é¡¹</p>
<ol>
<li>list ä¸­ä¿å­˜çš„æ•°æ®éƒ½æ˜¯ string ç±»å‹çš„ï¼Œæ•°æ®æ€»å®¹é‡æ˜¯æœ‰é™çš„ï¼Œæœ€å¤š 2^32 - 1 ä¸ªå…ƒç´ ï¼ˆ4294967295ï¼‰</li>
<li>list å…·æœ‰ç´¢å¼•çš„æ¦‚å¿µï¼Œä½†æ“ä½œæ•°æ®æ—¶é€šå¸¸ä»¥é˜Ÿåˆ—çš„å½¢å¼è¿›è¡Œå…¥é˜Ÿå‡ºé˜Ÿï¼Œæˆ–ä»¥æ ˆçš„å½¢å¼è¿›è¡Œå…¥æ ˆå‡ºæ ˆ</li>
<li>è·å–å…¨éƒ¨æ•°æ®æ“ä½œç»“æŸç´¢å¼•è®¾ç½®ä¸º -1</li>
<li>list å¯ä»¥å¯¹æ•°æ®è¿›è¡Œåˆ†é¡µæ“ä½œï¼Œé€šå¸¸ç¬¬ä¸€é¡µçš„ä¿¡æ¯æ¥è‡ªäº listï¼Œç¬¬ 2 é¡µåŠæ›´å¤šçš„ä¿¡æ¯é€šè¿‡æ•°æ®åº“çš„å½¢å¼åŠ è½½</li>
</ol>
<hr>
<h4 id="å®ç°-3">å®ç°</h4>
<p>åœ¨ Redis3.2 ç‰ˆæœ¬ä»¥å‰åˆ—è¡¨å¯¹è±¡çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼šziplistï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰å’Œ linkedlistï¼ˆé“¾è¡¨ï¼‰</p>
<ul>
<li>
<p>å‹ç¼©åˆ—è¡¨å®ç°çš„åˆ—è¡¨å¯¹è±¡ï¼šPUSH 1ã€threeã€5 ä¸‰ä¸ªå…ƒç´ </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%88%97%E8%A1%A8%E5%AF%B9%E8%B1%A1ziplist.png" alt=""></p>
</li>
<li>
<p>é“¾è¡¨å®ç°çš„åˆ—è¡¨å¯¹è±¡ï¼šä¸ºäº†ç®€åŒ–å­—ç¬¦ä¸²å¯¹è±¡çš„è¡¨ç¤ºï¼Œä½¿ç”¨äº† StringObject çš„ç»“æ„ï¼Œåº•å±‚å…¶å®æ˜¯ sdshdr ç»“æ„</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%88%97%E8%A1%A8%E5%AF%B9%E8%B1%A1linkedlist.png" alt=""></p>
</li>
</ul>
<p>åˆ—è¡¨ä¸­å­˜å‚¨çš„æ•°æ®é‡æ¯”è¾ƒå°çš„æ—¶å€™ï¼Œåˆ—è¡¨å°±ä¼šä½¿ç”¨ä¸€å—è¿ç»­çš„å†…å­˜å­˜å‚¨ï¼Œé‡‡ç”¨å‹ç¼©åˆ—è¡¨çš„æ–¹å¼å®ç°çš„æ¡ä»¶ï¼š</p>
<ul>
<li>åˆ—è¡¨å¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å­—ç¬¦ä¸²å…ƒç´ çš„é•¿åº¦éƒ½å°äº 64 å­—èŠ‚</li>
<li>åˆ—è¡¨å¯¹è±¡ä¿å­˜çš„å…ƒç´ æ•°é‡å°äº 512 ä¸ª</li>
</ul>
<p>ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼æ˜¯å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹çš„ï¼Œå½“ä¸¤ä¸ªæ¡ä»¶çš„ä»»æ„ä¸€ä¸ªä¸èƒ½è¢«æ»¡è¶³æ—¶ï¼Œå¯¹è±¡çš„ç¼–ç è½¬æ¢æ“ä½œå°±ä¼šè¢«æ‰§è¡Œ</p>
<p>åœ¨ Redis3.2 ç‰ˆæœ¬ ä»¥åå¯¹åˆ—è¡¨æ•°æ®ç»“æ„è¿›è¡Œäº†æ”¹é€ ï¼Œä½¿ç”¨ **quicklistï¼ˆå¿«é€Ÿåˆ—è¡¨ï¼‰**ä»£æ›¿äº† linkedlistï¼Œquicklist å®é™…ä¸Šæ˜¯ ziplist å’Œ linkedlist çš„æ··åˆä½“ï¼Œå°† linkedlist æŒ‰æ®µåˆ‡åˆ†ï¼Œæ¯ä¸€æ®µä½¿ç”¨ ziplist æ¥ç´§å‡‘å­˜å‚¨ï¼Œå¤šä¸ª ziplist ä¹‹é—´ä½¿ç”¨åŒå‘æŒ‡é’ˆä¸²æ¥èµ·æ¥ï¼Œæ—¢æ»¡è¶³äº†å¿«é€Ÿçš„æ’å…¥åˆ é™¤æ€§èƒ½ï¼Œåˆä¸ä¼šå‡ºç°å¤ªå¤§çš„ç©ºé—´å†—ä½™</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å¿«é€Ÿåˆ—è¡¨æ•°æ®ç»“æ„.png" style="zoom: 50%;" />
<hr>
<h4 id="åº”ç”¨-3">åº”ç”¨</h4>
<p>ä¼ä¸šè¿è¥è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿå°†äº§ç”Ÿå‡ºå¤§é‡çš„è¿è¥æ•°æ®ï¼Œå¦‚ä½•ä¿éšœå¤šå°æœåŠ¡å™¨æ“ä½œæ—¥å¿—çš„ç»Ÿä¸€é¡ºåºè¾“å‡ºï¼Ÿ</p>
<ul>
<li>ä¾èµ– list çš„æ•°æ®å…·æœ‰é¡ºåºçš„ç‰¹å¾å¯¹ä¿¡æ¯è¿›è¡Œç®¡ç†ï¼Œå³è¿›å·¦æŸ¥æˆ–è€…å·¦è¿‘å·¦æŸ¥</li>
<li>ä½¿ç”¨é˜Ÿåˆ—æ¨¡å‹è§£å†³å¤šè·¯ä¿¡æ¯æ±‡æ€»åˆå¹¶çš„é—®é¢˜</li>
<li>ä½¿ç”¨æ ˆæ¨¡å‹è§£å†³æœ€æ–°æ¶ˆæ¯çš„é—®é¢˜</li>
</ul>
<p>å¾®ä¿¡æ–‡ç« è®¢é˜…å…¬ä¼—å·ï¼š</p>
<ul>
<li>æ¯”å¦‚è®¢é˜…äº†ä¸¤ä¸ªå…¬ä¼—å·ï¼Œå®ƒä»¬å‘å¸ƒäº†ä¸¤ç¯‡æ–‡ç« ï¼Œæ–‡ç«  ID åˆ†åˆ«ä¸º 666 å’Œ 888ï¼Œå¯ä»¥é€šè¿‡æ‰§è¡Œ <code>LPUSH key 666 888</code> å‘½ä»¤æ¨é€ç»™æˆ‘</li>
</ul>
<hr>
<h3 id="set">set</h3>
<h4 id="ç®€ä»‹-4">ç®€ä»‹</h4>
<p>æ•°æ®å­˜å‚¨éœ€æ±‚ï¼šå­˜å‚¨å¤§é‡çš„æ•°æ®ï¼Œåœ¨æŸ¥è¯¢æ–¹é¢æä¾›æ›´é«˜çš„æ•ˆç‡</p>
<p>æ•°æ®å­˜å‚¨ç»“æ„ï¼šèƒ½å¤Ÿä¿å­˜å¤§é‡çš„æ•°æ®ï¼Œé«˜æ•ˆçš„å†…éƒ¨å­˜å‚¨æœºåˆ¶ï¼Œä¾¿äºæŸ¥è¯¢</p>
<p>set ç±»å‹ï¼šä¸ hash å­˜å‚¨ç»“æ„å“ˆå¸Œè¡¨å®Œå…¨ç›¸åŒï¼Œåªæ˜¯ä»…å­˜å‚¨é”®ä¸å­˜å‚¨å€¼ï¼ˆnilï¼‰ï¼Œæ‰€ä»¥æ·»åŠ ï¼Œåˆ é™¤ï¼ŒæŸ¥æ‰¾çš„å¤æ‚åº¦éƒ½æ˜¯ O(1)ï¼Œå¹¶ä¸”<strong>å€¼æ˜¯ä¸å…è®¸é‡å¤ä¸”æ— åºçš„</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/setç»“æ„å›¾.png" style="zoom: 33%;" />
<hr>
<h4 id="æ“ä½œ-4">æ“ä½œ</h4>
<p>æŒ‡ä»¤æ“ä½œï¼š</p>
<ul>
<li>
<p>æ•°æ®æ“ä½œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sadd key member1 [member2]	<span class="comment">#æ·»åŠ æ•°æ®</span></span><br><span class="line">srem key member1 [member2]	<span class="comment">#åˆ é™¤æ•°æ®</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æŸ¥è¯¢æ“ä½œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">smembers key				<span class="comment">#è·å–å…¨éƒ¨æ•°æ®</span></span><br><span class="line">scard key					<span class="comment">#è·å–é›†åˆæ•°æ®æ€»é‡</span></span><br><span class="line">sismember key member		<span class="comment">#åˆ¤æ–­é›†åˆä¸­æ˜¯å¦åŒ…å«æŒ‡å®šæ•°æ®</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>éšæœºæ“ä½œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spop key [count]			<span class="comment">#éšæœºè·å–é›†ä¸­çš„æŸä¸ªæ•°æ®å¹¶å°†è¯¥æ•°æ®ç§»é™¤é›†åˆ</span></span><br><span class="line">srandmember key [count]		<span class="comment">#éšæœºè·å–é›†åˆä¸­æŒ‡å®š(æ•°é‡)çš„æ•°æ®</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é›†åˆçš„äº¤ã€å¹¶ã€å·®</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sinter key1 [key2...]  					<span class="comment">#ä¸¤ä¸ªé›†åˆçš„äº¤é›†ï¼Œä¸å­˜åœ¨ä¸º(empty list or set)</span></span><br><span class="line">sunion key1 [key2...]  					<span class="comment">#ä¸¤ä¸ªé›†åˆçš„å¹¶é›†</span></span><br><span class="line">sdiff key1 [key2...]					<span class="comment">#ä¸¤ä¸ªé›†åˆçš„å·®é›†</span></span><br><span class="line"></span><br><span class="line">sinterstore destination key1 [key2...]	<span class="comment">#ä¸¤ä¸ªé›†åˆçš„äº¤é›†å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆä¸­</span></span><br><span class="line">sunionstore destination key1 [key2...]	<span class="comment">#ä¸¤ä¸ªé›†åˆçš„å¹¶é›†å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆä¸­</span></span><br><span class="line">sdiffstore destination key1 [key2...]	<span class="comment">#ä¸¤ä¸ªé›†åˆçš„å·®é›†å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆä¸­</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¤åˆ¶</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smove <span class="built_in">source</span> destination member			<span class="comment">#å°†æŒ‡å®šæ•°æ®ä»åŸå§‹é›†åˆä¸­ç§»åŠ¨åˆ°ç›®æ ‡é›†åˆä¸­</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ³¨æ„äº‹é¡¹</p>
<ol>
<li>set ç±»å‹ä¸å…è®¸æ•°æ®é‡å¤ï¼Œå¦‚æœæ·»åŠ çš„æ•°æ®åœ¨ set ä¸­å·²ç»å­˜åœ¨ï¼Œå°†åªä¿ç•™ä¸€ä»½</li>
<li>set è™½ç„¶ä¸ hash çš„å­˜å‚¨ç»“æ„ç›¸åŒï¼Œä½†æ˜¯æ— æ³•å¯ç”¨ hash ä¸­å­˜å‚¨å€¼çš„ç©ºé—´</li>
</ol>
<hr>
<h4 id="å®ç°-4">å®ç°</h4>
<p>é›†åˆå¯¹è±¡çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼šintsetï¼ˆæ•´æ•°é›†åˆï¼‰ã€hashtableï¼ˆå“ˆå¸Œè¡¨ã€å­—å…¸ï¼‰</p>
<ul>
<li>
<p>æ•´æ•°é›†åˆå®ç°çš„é›†åˆå¯¹è±¡ï¼š</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-é›†åˆå¯¹è±¡intset.png" style="zoom:67%;" />
</li>
<li>
<p>å­—å…¸å®ç°çš„é›†åˆå¯¹è±¡ï¼šé”®å€¼å¯¹çš„å€¼ä¸º NULL</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-é›†åˆå¯¹è±¡dict.png" style="zoom:80%;" />
</li>
</ul>
<p>å½“é›†åˆå¯¹è±¡å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œå¯¹è±¡ä½¿ç”¨ intset ç¼–ç ï¼š</p>
<ul>
<li>é›†åˆä¸­çš„å…ƒç´ éƒ½æ˜¯æ•´æ•°å€¼</li>
<li>é›†åˆä¸­çš„å…ƒç´ æ•°é‡å°äº set-maxintset-entriesé…ç½®ï¼ˆé»˜è®¤ 512 ä¸ªï¼‰</li>
</ul>
<p>ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼æ˜¯å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹çš„</p>
<hr>
<h4 id="åº”ç”¨-4">åº”ç”¨</h4>
<p>åº”ç”¨åœºæ™¯ï¼š</p>
<ol>
<li>
<p>é»‘åå•ï¼šèµ„è®¯ç±»ä¿¡æ¯ç±»ç½‘ç«™è¿½æ±‚é«˜è®¿é—®é‡ï¼Œä½†æ˜¯ç”±äºå…¶ä¿¡æ¯çš„ä»·å€¼ï¼Œå¾€å¾€å®¹æ˜“è¢«ä¸æ³•åˆ†å­åˆ©ç”¨ï¼Œé€šè¿‡çˆ¬è™«æŠ€æœ¯ï¼Œå¿«é€Ÿè·å–ä¿¡æ¯ï¼Œä¸ªåˆ«ç‰¹ç§è¡Œä¸šç½‘ç«™ä¿¡æ¯é€šè¿‡çˆ¬è™«è·å–åˆ†æåï¼Œå¯ä»¥è½¬æ¢æˆå•†ä¸šæœºå¯†ã€‚</p>
<p>æ³¨æ„ï¼šçˆ¬è™«ä¸ä¸€å®šåšæ‘§æ¯æ€§çš„å·¥ä½œï¼Œæœ‰äº›å°å‹ç½‘ç«™éœ€è¦çˆ¬è™«ä¸ºå…¶å¸¦æ¥ä¸€äº›æµé‡ã€‚</p>
</li>
<li>
<p>ç™½åå•ï¼šå¯¹äºå®‰å…¨æ€§æ›´é«˜çš„åº”ç”¨è®¿é—®ï¼Œä»…ä»…é é»‘åå•æ˜¯ä¸èƒ½è§£å†³å®‰å…¨é—®é¢˜çš„ï¼Œæ­¤æ—¶éœ€è¦è®¾å®šå¯è®¿é—®çš„ç”¨æˆ·ç¾¤ä½“ï¼Œ ä¾èµ–ç™½åå•åšæ›´ä¸ºè‹›åˆ»çš„è®¿é—®éªŒè¯</p>
</li>
<li>
<p>éšæœºæ“ä½œå¯ä»¥å®ç°æŠ½å¥–åŠŸèƒ½</p>
</li>
<li>
<p>é›†åˆçš„äº¤å¹¶è¡¥å¯ä»¥å®ç°å¾®åšå…±åŒå…³æ³¨çš„æŸ¥çœ‹ï¼Œå¯ä»¥æ ¹æ®å…±åŒå…³æ³¨æˆ–è€…å…±åŒå–œæ¬¢æ¨èç›¸å…³å†…å®¹</p>
</li>
</ol>
<hr>
<h3 id="zset">zset</h3>
<h4 id="ç®€ä»‹-5">ç®€ä»‹</h4>
<p>æ•°æ®å­˜å‚¨éœ€æ±‚ï¼šæ•°æ®æ’åºæœ‰åˆ©äºæ•°æ®çš„æœ‰æ•ˆå±•ç¤ºï¼Œéœ€è¦æä¾›ä¸€ç§å¯ä»¥æ ¹æ®è‡ªèº«ç‰¹å¾è¿›è¡Œæ’åºçš„æ–¹å¼</p>
<p>æ•°æ®å­˜å‚¨ç»“æ„ï¼šæ–°çš„å­˜å‚¨æ¨¡å‹ï¼Œå¯ä»¥ä¿å­˜å¯æ’åºçš„æ•°æ®</p>
<hr>
<h4 id="æ“ä½œ-5">æ“ä½œ</h4>
<p>æŒ‡ä»¤æ“ä½œï¼š</p>
<ul>
<li>
<p>æ•°æ®æ“ä½œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zadd key score1 member1 [score2 member2]	<span class="comment">#æ·»åŠ æ•°æ®</span></span><br><span class="line">zrem key member [member ...]				<span class="comment">#åˆ é™¤æ•°æ®</span></span><br><span class="line">zremrangebyrank key start stop 				<span class="comment">#åˆ é™¤æŒ‡å®šç´¢å¼•èŒƒå›´çš„æ•°æ®</span></span><br><span class="line">zremrangebyscore key min max				<span class="comment">#åˆ é™¤æŒ‡å®šåˆ†æ•°åŒºé—´å†…çš„æ•°æ®</span></span><br><span class="line">zscore key member							<span class="comment">#è·å–æŒ‡å®šå€¼çš„åˆ†æ•°</span></span><br><span class="line">zincrby key increment member				<span class="comment">#æŒ‡å®šå€¼çš„åˆ†æ•°å¢åŠ increment</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æŸ¥è¯¢æ“ä½œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">zrange key start stop [WITHSCORES]		<span class="comment">#è·å–æŒ‡å®šèŒƒå›´çš„æ•°æ®ï¼Œå‡åºï¼ŒWITHSCORES ä»£è¡¨æ˜¾ç¤ºåˆ†æ•°</span></span><br><span class="line">zrevrange key start stop [WITHSCORES]	<span class="comment">#è·å–æŒ‡å®šèŒƒå›´çš„æ•°æ®ï¼Œé™åº</span></span><br><span class="line"></span><br><span class="line">zrangebyscore key min max [WITHSCORES] [LIMIT offset count]	<span class="comment">#æŒ‰æ¡ä»¶è·å–æ•°æ®ï¼Œä»å°åˆ°å¤§</span></span><br><span class="line">zrevrangebyscore key max min [WITHSCORES] [...]				<span class="comment">#ä»å¤§åˆ°å°</span></span><br><span class="line"></span><br><span class="line">zcard key										<span class="comment">#è·å–é›†åˆæ•°æ®çš„æ€»é‡</span></span><br><span class="line">zcount key min max								<span class="comment">#è·å–æŒ‡å®šåˆ†æ•°åŒºé—´å†…çš„æ•°æ®æ€»é‡</span></span><br><span class="line">zrank key member								<span class="comment">#è·å–æ•°æ®å¯¹åº”çš„ç´¢å¼•ï¼ˆæ’åï¼‰å‡åº</span></span><br><span class="line">zrevrank key member								<span class="comment">#è·å–æ•°æ®å¯¹åº”çš„ç´¢å¼•ï¼ˆæ’åï¼‰é™åº</span></span><br></pre></td></tr></table></figure>
<ul>
<li>min ä¸ max ç”¨äºé™å®šæœç´¢æŸ¥è¯¢çš„æ¡ä»¶</li>
<li>start ä¸ stop ç”¨äºé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œä½œç”¨äºç´¢å¼•ï¼Œè¡¨ç¤ºå¼€å§‹å’Œç»“æŸç´¢å¼•</li>
<li>offset ä¸ count ç”¨äºé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œä½œç”¨äºæŸ¥è¯¢ç»“æœï¼Œè¡¨ç¤ºå¼€å§‹ä½ç½®å’Œæ•°æ®æ€»é‡</li>
</ul>
</li>
<li>
<p>é›†åˆçš„äº¤ã€å¹¶æ“ä½œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zinterstore destination numkeys key [key ...]	<span class="comment">#ä¸¤ä¸ªé›†åˆçš„äº¤é›†å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆä¸­</span></span><br><span class="line">zunionstore destination numkeys key [key ...]	<span class="comment">#ä¸¤ä¸ªé›†åˆçš„å¹¶é›†å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆä¸­</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ³¨æ„äº‹é¡¹ï¼š</p>
<ol>
<li>score ä¿å­˜çš„æ•°æ®å­˜å‚¨ç©ºé—´æ˜¯ 64 ä½ï¼Œå¦‚æœæ˜¯æ•´æ•°èŒƒå›´æ˜¯ -9007199254740992~9007199254740992</li>
<li>score ä¿å­˜çš„æ•°æ®ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªåŒç²¾åº¦çš„ double å€¼ï¼ŒåŸºäºåŒç²¾åº¦æµ®ç‚¹æ•°çš„ç‰¹å¾å¯èƒ½ä¼šä¸¢å¤±ç²¾åº¦ï¼Œæ…é‡ä½¿ç”¨</li>
<li>sorted_set åº•å±‚å­˜å‚¨è¿˜æ˜¯åŸºäº set ç»“æ„çš„ï¼Œå› æ­¤æ•°æ®ä¸èƒ½é‡å¤ï¼Œå¦‚æœé‡å¤æ·»åŠ ç›¸åŒçš„æ•°æ®ï¼Œscore å€¼å°†è¢«åå¤è¦†ç›–ï¼Œä¿ç•™æœ€åä¸€æ¬¡ä¿®æ”¹çš„ç»“æœ</li>
</ol>
<hr>
<h4 id="å®ç°-5">å®ç°</h4>
<p>æœ‰åºé›†åˆå¯¹è±¡çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼šziplistï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰å’Œ skiplistï¼ˆè·³è·ƒè¡¨ï¼‰</p>
<ul>
<li>
<p>å‹ç¼©åˆ—è¡¨å®ç°æœ‰åºé›†åˆå¯¹è±¡ï¼šziplist æœ¬èº«æ˜¯æœ‰åºã€ä¸å¯é‡å¤çš„ï¼Œç¬¦åˆæœ‰åºé›†åˆçš„ç‰¹æ€§</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%E5%AF%B9%E8%B1%A1ziplist.png" alt=""></p>
</li>
<li>
<p>è·³è·ƒè¡¨å®ç°æœ‰åºé›†åˆå¯¹è±¡ï¼š<strong>åº•å±‚æ˜¯ zset ç»“æ„ï¼Œzset åŒæ—¶åŒ…å«å­—å…¸å’Œè·³è·ƒè¡¨çš„ç»“æ„</strong>ï¼Œå›¾ç¤ºå­—å…¸å’Œè·³è·ƒè¡¨ä¸­é‡å¤å±•ç¤ºäº†å„ä¸ªå…ƒç´ çš„æˆå‘˜å’Œåˆ†å€¼ï¼Œä½†å®é™…ä¸Šä¸¤è€…ä¼š<strong>é€šè¿‡æŒ‡é’ˆæ¥å…±äº«ç›¸åŒå…ƒç´ çš„æˆå‘˜å’Œåˆ†å€¼</strong>ï¼Œä¸ä¼šäº§ç”Ÿç©ºé—´æµªè´¹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zset</span> &#123;</span></span><br><span class="line">    zskiplist *zsl;</span><br><span class="line">    dict *dict;</span><br><span class="line">&#125; zset;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%E5%AF%B9%E8%B1%A1zset.png" alt=""></p>
</li>
</ul>
<p>ä½¿ç”¨å­—å…¸åŠ è·³è·ƒè¡¨çš„ä¼˜åŠ¿ï¼š</p>
<ul>
<li>å­—å…¸ä¸ºæœ‰åºé›†åˆåˆ›å»ºäº†ä¸€ä¸ª<strong>ä»æˆå‘˜åˆ°åˆ†å€¼çš„æ˜ å°„</strong>ï¼Œç”¨ O(1) å¤æ‚åº¦æŸ¥æ‰¾ç»™å®šæˆå‘˜çš„åˆ†å€¼</li>
<li><strong>æ’åºæ“ä½œä½¿ç”¨è·³è·ƒè¡¨å®Œæˆ</strong>ï¼ŒèŠ‚çœæ¯æ¬¡é‡æ–°æ’åºå¸¦æ¥çš„æ—¶é—´æˆæœ¬å’Œç©ºé—´æˆæœ¬</li>
</ul>
<p>ä½¿ç”¨ ziplist æ ¼å¼å­˜å‚¨éœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>æœ‰åºé›†åˆä¿å­˜çš„å…ƒç´ ä¸ªæ•°è¦å°äº 128 ä¸ªï¼›</li>
<li>æœ‰åºé›†åˆä¿å­˜çš„æ‰€æœ‰å…ƒç´ å¤§å°éƒ½å°äº 64 å­—èŠ‚</li>
</ul>
<p>å½“å…ƒç´ æ¯”è¾ƒå¤šæ—¶ï¼Œæ­¤æ—¶ ziplist çš„è¯»å†™æ•ˆç‡ä¼šä¸‹é™ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ï¼Œè·³è¡¨çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(logn)</p>
<p>ä¸ºä»€ä¹ˆç”¨è·³è¡¨è€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ</p>
<ul>
<li>åœ¨åšèŒƒå›´æŸ¥æ‰¾çš„æ—¶å€™ï¼Œè·³è¡¨æ“ä½œç®€å•ï¼ˆå‰è¿›æŒ‡é’ˆæˆ–åé€€æŒ‡é’ˆï¼‰ï¼Œå¹³è¡¡æ ‘éœ€è¦å›æ—‹æŸ¥æ‰¾</li>
<li>è·³è¡¨æ¯”å¹³è¡¡æ ‘å®ç°ç®€å•ï¼Œå¹³è¡¡æ ‘çš„æ’å…¥å’Œåˆ é™¤æ“ä½œå¯èƒ½å¼•å‘å­æ ‘çš„æ—‹è½¬è°ƒæ•´ï¼Œè€Œè·³è¡¨çš„æ’å…¥å’Œåˆ é™¤åªéœ€è¦ä¿®æ”¹ç›¸é‚»èŠ‚ç‚¹çš„æŒ‡é’ˆ</li>
</ul>
<hr>
<h4 id="åº”ç”¨-5">åº”ç”¨</h4>
<ul>
<li>æ’è¡Œæ¦œ</li>
<li>å¯¹äºåŸºäºæ—¶é—´çº¿é™å®šçš„ä»»åŠ¡å¤„ç†ï¼Œå°†å¤„ç†æ—¶é—´è®°å½•ä¸º score å€¼ï¼Œåˆ©ç”¨æ’åºåŠŸèƒ½åŒºåˆ†å¤„ç†çš„å…ˆåé¡ºåº</li>
<li>å½“ä»»åŠ¡æˆ–è€…æ¶ˆæ¯å¾…å¤„ç†ï¼Œå½¢æˆäº†ä»»åŠ¡é˜Ÿåˆ—æˆ–æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œå¯¹äºé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡è¦ä¿éšœå¯¹å…¶ä¼˜å…ˆå¤„ç†ï¼Œé‡‡ç”¨ score è®°å½•æƒé‡</li>
</ul>
<hr>
<h3 id="Bitmaps">Bitmaps</h3>
<h4 id="åŸºæœ¬æ“ä½œ">åŸºæœ¬æ“ä½œ</h4>
<p>Bitmaps æ˜¯äºŒè¿›åˆ¶ä½æ•°ç»„ï¼ˆbit arrayï¼‰ï¼Œåº•å±‚ä½¿ç”¨ SDS å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œå› ä¸º SDS æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E4%BD%8D%E6%95%B0%E7%BB%84%E7%BB%93%E6%9E%84.png" alt=""></p>
<p>buf æ•°ç»„çš„æ¯ä¸ªå­—èŠ‚ç”¨ä¸€è¡Œè¡¨ç¤ºï¼Œbuf[1] æ˜¯ <code>'\0'</code>ï¼Œä¿å­˜ä½æ•°ç»„çš„é¡ºåºå’Œä¹¦å†™ä½æ•°ç»„çš„é¡ºåºæ˜¯å®Œå…¨ç›¸åçš„ï¼Œå›¾ç¤ºçš„ä½æ•°ç»„ 0100 1101</p>
<p>æ•°æ®ç»“æ„çš„è¯¦è§£æŸ¥çœ‹ Java â†’ Algorithm â†’ ä½å›¾</p>
<h4 id="å‘½ä»¤å®ç°">å‘½ä»¤å®ç°</h4>
<h5 id="GETBIT">GETBIT</h5>
<p>GETBIT å‘½ä»¤è·å–ä½æ•°ç»„ bitarray åœ¨ offset åç§»é‡ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GETBIT &lt;bitarray&gt; &lt;offset&gt;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œè¿‡ç¨‹ï¼š</p>
<ul>
<li>è®¡ç®— <code>byte = offset/8</code>ï¼ˆå‘ä¸‹å–æ•´ï¼‰, byte å€¼è®°å½•æ•°æ®ä¿å­˜åœ¨ä½æ•°ç»„ä¸­çš„ç´¢å¼•</li>
<li>è®¡ç®— <code>bit = (offset mod 8) + 1</code>ï¼Œbit å€¼è®°å½•æ•°æ®åœ¨ä½æ•°ç»„ä¸­çš„ç¬¬å‡ ä¸ªäºŒè¿›åˆ¶ä½</li>
<li>æ ¹æ® byte å’Œ bit å€¼ï¼Œåœ¨ä½æ•°ç»„ bitarray ä¸­å®šä½ offset åç§»é‡æŒ‡å®šçš„äºŒè¿›åˆ¶ä½ï¼Œå¹¶è¿”å›è¿™ä¸ªä½çš„å€¼</li>
</ul>
<p>GETBIT å‘½ä»¤æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œéƒ½å¯ä»¥åœ¨å¸¸æ•°æ—¶é—´å†…å®Œæˆï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦ä¸º O(1)</p>
<hr>
<h5 id="SETBIT">SETBIT</h5>
<p>SETBIT å°†ä½æ•°ç»„ bitarray åœ¨ offset åç§»é‡ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼è®¾ç½®ä¸º valueï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›äºŒè¿›åˆ¶ä½çš„æ—§å€¼</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SETBIT &lt;bitarray&gt; &lt;offset&gt; &lt;value&gt; </span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œè¿‡ç¨‹ï¼š</p>
<ul>
<li>è®¡ç®— <code>len = offset/8 + 1</code>ï¼Œlen å€¼è®°å½•äº†ä¿å­˜è¯¥æ•°æ®è‡³å°‘éœ€è¦å¤šå°‘ä¸ªå­—èŠ‚</li>
<li>æ£€æŸ¥ bitarray é”®ä¿å­˜çš„ä½æ•°ç»„çš„é•¿åº¦æ˜¯å¦å°äº lenï¼Œæˆç«‹å°±ä¼šå°† SDS æ‰©å±•ä¸º len å­—èŠ‚ï¼ˆæ³¨æ„ç©ºé—´é¢„åˆ†é…æœºåˆ¶ï¼‰ï¼Œæ‰€æœ‰æ–°æ‰©å±•ç©ºé—´çš„äºŒè¿›åˆ¶ä½çš„å€¼ç½®ä¸º 0</li>
<li>è®¡ç®— <code>byte = offset/8</code>ï¼ˆå‘ä¸‹å–æ•´ï¼‰, byte å€¼è®°å½•æ•°æ®ä¿å­˜åœ¨ä½æ•°ç»„ä¸­çš„ç´¢å¼•</li>
<li>è®¡ç®— <code>bit = (offset mod 8) + 1</code>ï¼Œbit å€¼è®°å½•æ•°æ®åœ¨ä½æ•°ç»„ä¸­çš„ç¬¬å‡ ä¸ªäºŒè¿›åˆ¶ä½</li>
<li>æ ¹æ® byte å’Œ bit å€¼ï¼Œåœ¨ä½æ•°ç»„ bitarray ä¸­å®šä½ offset åç§»é‡æŒ‡å®šçš„äºŒè¿›åˆ¶ä½ï¼Œé¦–å…ˆå°†æŒ‡å®šä½ç°å­˜çš„å€¼ä¿å­˜åœ¨ oldvalue å˜é‡ï¼Œç„¶åå°†æ–°å€¼ value è®¾ç½®ä¸ºè¿™ä¸ªäºŒè¿›åˆ¶ä½çš„å€¼</li>
<li>å‘å®¢æˆ·ç«¯è¿”å› oldvalue å˜é‡çš„å€¼</li>
</ul>
<hr>
<h5 id="BITCOUNT">BITCOUNT</h5>
<p>BITCOUNT å‘½ä»¤ç”¨äºç»Ÿè®¡ç»™å®šä½æ•°ç»„ä¸­ï¼Œå€¼ä¸º 1 çš„äºŒè¿›åˆ¶ä½çš„æ•°é‡</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BITCOUNT &lt;bitarray&gt; [start end]</span><br></pre></td></tr></table></figure>
<p>äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼š</p>
<ul>
<li>éå†æ³•ï¼šéå†ä½æ•°ç»„ä¸­çš„æ¯ä¸ªäºŒè¿›åˆ¶ä½</li>
<li>æŸ¥è¡¨ç®—æ³•ï¼šè¯»å–æ¯ä¸ªå­—èŠ‚ï¼ˆ8 ä½ï¼‰çš„æ•°æ®ï¼ŒæŸ¥è¡¨è·å–æ•°å€¼å¯¹åº”çš„äºŒè¿›åˆ¶ä¸­æœ‰å‡ ä¸ª 1</li>
<li>variable-precision SWARç®—æ³•ï¼šè®¡ç®—æ±‰æ˜è·ç¦»</li>
<li>Redis å®ç°ï¼š
<ul>
<li>å¦‚æœäºŒè¿›åˆ¶ä½çš„æ•°é‡å¤§äºç­‰äº 128 ä½ï¼Œ é‚£ä¹ˆä½¿ç”¨ variable-precision SWAR ç®—æ³•æ¥è®¡ç®—äºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡</li>
<li>å¦‚æœäºŒè¿›åˆ¶ä½çš„æ•°é‡å°äº 128 ä½ï¼Œé‚£ä¹ˆä½¿ç”¨æŸ¥è¡¨ç®—æ³•æ¥è®¡ç®—äºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡</li>
</ul>
</li>
</ul>
<hr>
<h5 id="BITOP">BITOP</h5>
<p>BITOP å‘½ä»¤å¯¹æŒ‡å®š key æŒ‰ä½è¿›è¡Œäº¤ã€å¹¶ã€éã€å¼‚æˆ–æ“ä½œï¼Œå¹¶å°†ç»“æœä¿å­˜åˆ°æŒ‡å®šçš„é”®ä¸­</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BITOP OPTION destKey key1 [key2...]</span><br></pre></td></tr></table></figure>
<p>OPTION æœ‰ ANDï¼ˆä¸ï¼‰ã€ORï¼ˆæˆ–ï¼‰ã€ XORï¼ˆå¼‚æˆ–ï¼‰å’Œ NOTï¼ˆéï¼‰å››ä¸ªé€‰é¡¹</p>
<p>ANDã€ORã€XOR ä¸‰ä¸ªå‘½ä»¤å¯ä»¥æ¥å—å¤šä¸ªä½æ•°ç»„ä½œä¸ºè¾“å…¥ï¼Œéœ€è¦éå†è¾“å…¥çš„æ¯ä¸ªä½æ•°ç»„çš„æ¯ä¸ªå­—èŠ‚æ¥è¿›è¡Œè®¡ç®—ï¼Œæ‰€ä»¥å‘½ä»¤çš„å¤æ‚åº¦ä¸º O(n^2)ï¼›ä¸æ­¤ç›¸åï¼ŒNOT å‘½ä»¤åªæ¥å—ä¸€ä¸ªä½æ•°ç»„è¾“å…¥ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦ä¸º O(n)</p>
<hr>
<h4 id="åº”ç”¨åœºæ™¯">åº”ç”¨åœºæ™¯</h4>
<ul>
<li>
<p><strong>è§£å†³ Redis ç¼“å­˜ç©¿é€</strong>ï¼Œåˆ¤æ–­ç»™å®šæ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œ é˜²æ­¢ç¼“å­˜ç©¿é€</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-Bitmapsåº”ç”¨ä¹‹ç¼“å­˜ç©¿é€.png" style="zoom: 67%;" />
</li>
<li>
<p>åƒåœ¾é‚®ä»¶è¿‡æ»¤ï¼Œå¯¹æ¯ä¸€ä¸ªå‘é€é‚®ä»¶çš„åœ°å€è¿›è¡Œåˆ¤æ–­æ˜¯å¦åœ¨å¸ƒéš†çš„é»‘åå•ä¸­ï¼Œå¦‚æœåœ¨å°±åˆ¤æ–­ä¸ºåƒåœ¾é‚®ä»¶</p>
</li>
<li>
<p>çˆ¬è™«å»é‡ï¼Œçˆ¬ç»™å®šç½‘å€çš„æ—¶å€™å¯¹å·²ç»çˆ¬å–è¿‡çš„ URL å»é‡</p>
</li>
<li>
<p>ä¿¡æ¯çŠ¶æ€ç»Ÿè®¡</p>
</li>
</ul>
<hr>
<h3 id="Hyper">Hyper</h3>
<p>åŸºæ•°æ˜¯æ•°æ®é›†å»é‡åå…ƒç´ ä¸ªæ•°ï¼ŒHyperLogLog æ˜¯ç”¨æ¥åšåŸºæ•°ç»Ÿè®¡çš„ï¼Œè¿ç”¨äº† LogLog çš„ç®—æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">8</span>&#125; 	åŸºæ•°é›†ï¼š &#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span> ,<span class="number">7</span>, <span class="number">8</span>&#125; 	åŸºæ•°ï¼š<span class="number">5</span></span><br><span class="line">&#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">1</span>&#125; 	åŸºæ•°é›†ï¼š &#123;<span class="number">1</span>,<span class="number">7</span>&#125; 				åŸºæ•°ï¼š<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>ç›¸å…³æŒ‡ä»¤ï¼š</p>
<ul>
<li>
<p>æ·»åŠ æ•°æ®</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pfadd key element [element ...]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç»Ÿè®¡æ•°æ®</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pfcount key [key ...]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>åˆå¹¶æ•°æ®</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pfmerge destkey sourcekey [sourcekey...]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>ç”¨äºè¿›è¡ŒåŸºæ•°ç»Ÿè®¡ï¼Œä¸æ˜¯é›†åˆä¸ä¿å­˜æ•°æ®ï¼Œåªè®°å½•æ•°é‡è€Œä¸æ˜¯å…·ä½“æ•°æ®ï¼Œæ¯”å¦‚ç½‘ç«™çš„è®¿é—®é‡</li>
<li>æ ¸å¿ƒæ˜¯åŸºæ•°ä¼°ç®—ç®—æ³•ï¼Œæœ€ç»ˆæ•°å€¼å­˜åœ¨ä¸€å®šè¯¯å·®</li>
<li>è¯¯å·®èŒƒå›´ï¼šåŸºæ•°ä¼°è®¡çš„ç»“æœæ˜¯ä¸€ä¸ªå¸¦æœ‰ 0.81% æ ‡å‡†é”™è¯¯çš„è¿‘ä¼¼å€¼</li>
<li>è€—ç©ºé—´æå°ï¼Œæ¯ä¸ª hyperloglog key å ç”¨äº†12Kçš„å†…å­˜ç”¨äºæ ‡è®°åŸºæ•°</li>
<li>pfadd å‘½ä»¤ä¸æ˜¯ä¸€æ¬¡æ€§åˆ†é…12Kå†…å­˜ä½¿ç”¨ï¼Œä¼šéšç€åŸºæ•°çš„å¢åŠ å†…å­˜é€æ¸å¢å¤§</li>
<li>Pfmerge å‘½ä»¤åˆå¹¶åå ç”¨çš„å­˜å‚¨ç©ºé—´ä¸º12Kï¼Œæ— è®ºåˆå¹¶ä¹‹å‰æ•°æ®é‡å¤šå°‘</li>
</ul>
<hr>
<h3 id="GEO">GEO</h3>
<p>GeoHash æ˜¯ä¸€ç§åœ°å€ç¼–ç æ–¹æ³•ï¼ŒæŠŠäºŒç»´çš„ç©ºé—´ç»çº¬åº¦æ•°æ®ç¼–ç æˆä¸€ä¸ªå­—ç¬¦ä¸²</p>
<ul>
<li>
<p>æ·»åŠ åæ ‡ç‚¹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">geoadd key longitude latitude member [longitude latitude member ...]</span><br><span class="line">georadius key longitude latitude radius m|km|ft|mi [withcoord] [withdist] [withhash] [count count]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è·å–åæ ‡ç‚¹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">geopos key member [member ...]</span><br><span class="line">georadiusbymember key member radius m|km|ft|mi [withcoord] [withdist] [withhash] [count count]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è®¡ç®—è·ç¦»</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">geodist key member1 member2 [unit]	<span class="comment">#è®¡ç®—åæ ‡ç‚¹è·ç¦»</span></span><br><span class="line">geohash key member [member ...]		<span class="comment">#è®¡ç®—ç»çº¬åº¦</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Redis åº”ç”¨äºåœ°ç†ä½ç½®è®¡ç®—</p>
<hr>
<h2 id="æŒä¹…æœºåˆ¶">æŒä¹…æœºåˆ¶</h2>
<h3 id="æ¦‚è¿°-2">æ¦‚è¿°</h3>
<p>æŒä¹…åŒ–ï¼šåˆ©ç”¨æ°¸ä¹…æ€§å­˜å‚¨ä»‹è´¨å°†æ•°æ®è¿›è¡Œä¿å­˜ï¼Œåœ¨ç‰¹å®šçš„æ—¶é—´å°†ä¿å­˜çš„æ•°æ®è¿›è¡Œæ¢å¤çš„å·¥ä½œæœºåˆ¶ç§°ä¸ºæŒä¹…åŒ–</p>
<p>ä½œç”¨ï¼šæŒä¹…åŒ–ç”¨äºé˜²æ­¢æ•°æ®çš„æ„å¤–ä¸¢å¤±ï¼Œç¡®ä¿æ•°æ®å®‰å…¨æ€§ï¼Œå› ä¸º Redis æ˜¯å†…å­˜çº§ï¼Œæ‰€ä»¥éœ€è¦æŒä¹…åŒ–åˆ°ç£ç›˜</p>
<p>è®¡ç®—æœºä¸­çš„æ•°æ®å…¨éƒ¨éƒ½æ˜¯äºŒè¿›åˆ¶ï¼Œä¿å­˜ä¸€ç»„æ•°æ®æœ‰ä¸¤ç§æ–¹å¼<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æŒä¹…åŒ–çš„ä¸¤ç§æ–¹å¼.png" style="zoom: 33%;" /></p>
<p>RDBï¼šå°†å½“å‰æ•°æ®çŠ¶æ€è¿›è¡Œä¿å­˜ï¼Œå¿«ç…§å½¢å¼ï¼Œå­˜å‚¨æ•°æ®ç»“æœï¼Œå­˜å‚¨æ ¼å¼ç®€å•</p>
<p>AOFï¼šå°†æ•°æ®çš„æ“ä½œè¿‡ç¨‹è¿›è¡Œä¿å­˜ï¼Œæ—¥å¿—å½¢å¼ï¼Œå­˜å‚¨æ“ä½œè¿‡ç¨‹ï¼Œå­˜å‚¨æ ¼å¼å¤æ‚</p>
<hr>
<h3 id="RDB">RDB</h3>
<h4 id="æ–‡ä»¶åˆ›å»º">æ–‡ä»¶åˆ›å»º</h4>
<p>RDB æŒä¹…åŒ–åŠŸèƒ½æ‰€ç”Ÿæˆçš„ RDB æ–‡ä»¶æ˜¯ä¸€ä¸ªç»è¿‡å‹ç¼©çš„ç´§å‡‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé€šè¿‡è¯¥æ–‡ä»¶å¯ä»¥è¿˜åŸç”Ÿæˆ RDB æ–‡ä»¶æ—¶çš„æ•°æ®åº“çŠ¶æ€ï¼Œæœ‰ä¸¤ä¸ª Redis å‘½ä»¤å¯ä»¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯ SAVEï¼Œå¦ä¸€ä¸ªæ˜¯ BGSAVE</p>
<h5 id="SAVE">SAVE</h5>
<p>SAVE æŒ‡ä»¤ï¼šæ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡ä¿å­˜æ“ä½œï¼Œè¯¥æŒ‡ä»¤çš„æ‰§è¡Œä¼šé˜»å¡å½“å‰ Redis æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯å‘é€çš„æ‰€æœ‰å‘½ä»¤è¯·æ±‚éƒ½ä¼šè¢«æ‹’ç»ï¼Œç›´åˆ°å½“å‰ RDB è¿‡ç¨‹å®Œæˆä¸ºæ­¢ï¼Œæœ‰å¯èƒ½ä¼šé€ æˆé•¿æ—¶é—´é˜»å¡ï¼Œçº¿ä¸Šç¯å¢ƒä¸å»ºè®®ä½¿ç”¨</p>
<p>å·¥ä½œåŸç†ï¼šRedis æ˜¯ä¸ª<strong>å•çº¿ç¨‹çš„å·¥ä½œæ¨¡å¼</strong>ï¼Œä¼šåˆ›å»ºä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œæ‰€æœ‰çš„å‘½ä»¤éƒ½ä¼šè¿›åˆ°è¿™ä¸ªé˜Ÿåˆ—æ’é˜Ÿæ‰§è¡Œã€‚å½“æŸä¸ªæŒ‡ä»¤åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œé˜Ÿåˆ—åé¢çš„æŒ‡ä»¤éƒ½è¦ç­‰å¾…ï¼Œæ‰€ä»¥è¿™ç§æ‰§è¡Œæ–¹å¼ä¼šéå¸¸è€—æ—¶</p>
<p>é…ç½® redis.confï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span> path				<span class="comment">#è®¾ç½®å­˜å‚¨.rdbæ–‡ä»¶çš„è·¯å¾„ï¼Œé€šå¸¸è®¾ç½®æˆå­˜å‚¨ç©ºé—´è¾ƒå¤§çš„ç›®å½•ä¸­ï¼Œç›®å½•åç§°data</span></span><br><span class="line">dbfilename <span class="string">&quot;x.rdb&quot;</span>		<span class="comment">#è®¾ç½®æœ¬åœ°æ•°æ®åº“æ–‡ä»¶åï¼Œé»˜è®¤å€¼ä¸ºdump.rdbï¼Œé€šå¸¸è®¾ç½®ä¸ºdump-ç«¯å£å·.rdb</span></span><br><span class="line">rdbcompression <span class="built_in">yes</span>|no	<span class="comment">#è®¾ç½®å­˜å‚¨è‡³æœ¬åœ°æ•°æ®åº“æ—¶æ˜¯å¦å‹ç¼©æ•°æ®ï¼Œé»˜è®¤yesï¼Œè®¾ç½®ä¸ºnoèŠ‚çœCPUè¿è¡Œæ—¶é—´</span></span><br><span class="line">rdbchecksum <span class="built_in">yes</span>|no		<span class="comment">#è®¾ç½®è¯»å†™æ–‡ä»¶è¿‡ç¨‹æ˜¯å¦è¿›è¡ŒRDBæ ¼å¼æ ¡éªŒï¼Œé»˜è®¤yes</span></span><br></pre></td></tr></table></figure>
<hr>
<h5 id="BGSAVE">BGSAVE</h5>
<p>BGSAVEï¼šbg æ˜¯ backgroundï¼Œä»£è¡¨åå°æ‰§è¡Œï¼Œå‘½ä»¤çš„å®Œæˆéœ€è¦ä¸¤ä¸ªè¿›ç¨‹ï¼Œ<strong>è¿›ç¨‹ä¹‹é—´ä¸ç›¸äº’å½±å“</strong>ï¼Œæ‰€ä»¥æŒä¹…åŒ–æœŸé—´ Redis æ­£å¸¸å·¥ä½œ</p>
<p>å·¥ä½œåŸç†ï¼š</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-bgsaveå·¥ä½œåŸç†.png" style="zoom:67%;" />
<p>æµç¨‹ï¼šå®¢æˆ·ç«¯å‘å‡º BGSAVE æŒ‡ä»¤ï¼ŒRedis æœåŠ¡å™¨ä½¿ç”¨ fork å‡½æ•°åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶åå“åº”åå°å·²ç»å¼€å§‹æ‰§è¡Œçš„ä¿¡æ¯ç»™å®¢æˆ·ç«¯ã€‚å­è¿›ç¨‹ä¼šå¼‚æ­¥æ‰§è¡ŒæŒä¹…åŒ–çš„æ“ä½œï¼ŒæŒä¹…åŒ–è¿‡ç¨‹æ˜¯å…ˆå°†æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼ŒæŒä¹…åŒ–æ“ä½œç»“æŸå†ç”¨è¿™ä¸ªä¸´æ—¶æ–‡ä»¶<strong>æ›¿æ¢</strong>ä¸Šæ¬¡æŒä¹…åŒ–çš„æ–‡ä»¶</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºå­è¿›ç¨‹</span></span><br><span class="line">pid = fork()</span><br><span class="line"><span class="keyword">if</span> pid == <span class="number">0</span>:</span><br><span class="line">    <span class="comment"># å­è¿›ç¨‹è´Ÿè´£åˆ›å»º RDB æ–‡ä»¶</span></span><br><span class="line">    rdbSave()</span><br><span class="line">    <span class="comment"># å®Œæˆä¹‹åå‘çˆ¶è¿›ç¨‹å‘é€ä¿¡å·</span></span><br><span class="line">    signal_parent()</span><br><span class="line"><span class="keyword">elif</span> pid &gt; <span class="number">0</span>:</span><br><span class="line">    <span class="comment"># çˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ï¼Œå¹¶é€šè¿‡è½®è¯¢ç­‰å¾…å­è¿›ç¨‹çš„ä¿¡å·</span></span><br><span class="line">    handle_request_and_wait_signal()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># å¤„ç†å‡ºé”™æƒå†µ</span></span><br><span class="line">    handle_fork_error() </span><br></pre></td></tr></table></figure>
<p>é…ç½® redis.conf</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">stop-writes-on-bgsave-error <span class="built_in">yes</span>|no	<span class="comment">#åå°å­˜å‚¨è¿‡ç¨‹ä¸­å¦‚æœå‡ºç°é”™è¯¯ï¼Œæ˜¯å¦åœæ­¢ä¿å­˜æ“ä½œï¼Œé»˜è®¤yes</span></span><br><span class="line">dbfilename filename  </span><br><span class="line"><span class="built_in">dir</span> path  </span><br><span class="line">rdbcompression <span class="built_in">yes</span>|no  </span><br><span class="line">rdbchecksum <span class="built_in">yes</span>|no</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šBGSAVE å‘½ä»¤æ˜¯é’ˆå¯¹ SAVE é˜»å¡é—®é¢˜åšçš„ä¼˜åŒ–ï¼ŒRedis å†…éƒ¨æ‰€æœ‰æ¶‰åŠåˆ° RDB æ“ä½œéƒ½é‡‡ç”¨ BGSAVE çš„æ–¹å¼ï¼ŒSAVE å‘½ä»¤æ”¾å¼ƒä½¿ç”¨</p>
<p>åœ¨ BGSAVE å‘½ä»¤æ‰§è¡ŒæœŸé—´ï¼ŒæœåŠ¡å™¨å¤„ç† SAVEã€BGSAVEã€BGREWRITEAOF ä¸‰ä¸ªå‘½ä»¤çš„æ–¹å¼ä¼šå’Œå¹³æ—¶æœ‰æ‰€ä¸åŒ</p>
<ul>
<li>SAVE å‘½ä»¤ä¼šè¢«æœåŠ¡å™¨æ‹’ç»ï¼ŒæœåŠ¡å™¨ç¦æ­¢ SAVE å’Œ BGSAVE å‘½ä»¤åŒæ—¶æ‰§è¡Œæ˜¯ä¸ºäº†é¿å…çˆ¶è¿›ç¨‹ï¼ˆæœåŠ¡å™¨è¿›ç¨‹ï¼‰å’Œå­è¿›ç¨‹åŒæ—¶æ‰§è¡Œä¸¤ä¸ª rdbSave è°ƒç”¨ï¼Œäº§ç”Ÿç«äº‰æ¡ä»¶</li>
<li>BGSAVE å‘½ä»¤ä¹Ÿä¼šè¢«æœåŠ¡å™¨æ‹’ç»ï¼Œä¹Ÿä¼šäº§ç”Ÿç«äº‰æ¡ä»¶</li>
<li>BGREWRITEAOF å’Œ BGSAVE ä¸¤ä¸ªå‘½ä»¤ä¸èƒ½åŒæ—¶æ‰§è¡Œ
<ul>
<li>å¦‚æœ BGSAVE å‘½ä»¤æ­£åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆ BGREWRITEAOF å‘½ä»¤ä¼šè¢«<strong>å»¶è¿Ÿ</strong>åˆ° BGSAVE å‘½ä»¤æ‰§è¡Œå®Œæ¯•ä¹‹åæ‰§è¡Œ</li>
<li>å¦‚æœ BGREWRITEAOF å‘½ä»¤æ­£åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆ BGSAVE å‘½ä»¤ä¼šè¢«æœåŠ¡å™¨æ‹’ç»</li>
</ul>
</li>
</ul>
<hr>
<h5 id="ç‰¹æ®ŠæŒ‡ä»¤">ç‰¹æ®ŠæŒ‡ä»¤</h5>
<p>RDB ç‰¹æ®Šå¯åŠ¨å½¢å¼çš„æŒ‡ä»¤ï¼ˆå®¢æˆ·ç«¯è¾“å…¥ï¼‰</p>
<ul>
<li>
<p>æœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­é‡å¯</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug reload</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å…³é—­æœåŠ¡å™¨æ—¶æŒ‡å®šä¿å­˜æ•°æ®</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown save</span><br></pre></td></tr></table></figure>
<p>é»˜è®¤æƒ…å†µä¸‹æ‰§è¡Œ shutdown å‘½ä»¤æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œ bgsaveï¼ˆå¦‚æœæ²¡æœ‰å¼€å¯ AOF æŒä¹…åŒ–åŠŸèƒ½ï¼‰</p>
</li>
<li>
<p>å…¨é‡å¤åˆ¶ï¼šä¸»ä»å¤åˆ¶éƒ¨åˆ†è¯¦è§£</p>
</li>
</ul>
<hr>
<h4 id="æ–‡ä»¶è½½å…¥">æ–‡ä»¶è½½å…¥</h4>
<p>RDB æ–‡ä»¶çš„è½½å…¥å·¥ä½œæ˜¯åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œï¼ŒæœŸé—´ Redis ä¼šä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œç›´åˆ°è½½å…¥å®Œæˆ</p>
<p>Redis å¹¶æ²¡æœ‰ä¸“é—¨ç”¨äºè½½å…¥ RDB æ–‡ä»¶çš„å‘½ä»¤ï¼Œåªè¦æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶æ£€æµ‹åˆ° RDB æ–‡ä»¶å­˜åœ¨ï¼Œå°±ä¼šè‡ªåŠ¨è½½å…¥ RDB æ–‡ä»¶</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[7379] 30 Aug 21:07:01.289 * DB loaded from disk: 0.018 seconds  <span class="comment"># æœåŠ¡å™¨åœ¨æˆåŠŸè½½å…¥ RDB æ–‡ä»¶ä¹‹åæ‰“å°</span></span><br></pre></td></tr></table></figure>
<p>AOF æ–‡ä»¶çš„æ›´æ–°é¢‘ç‡é€šå¸¸æ¯” RDB æ–‡ä»¶çš„æ›´æ–°é¢‘ç‡é«˜ï¼š</p>
<ul>
<li>å¦‚æœæœåŠ¡å™¨å¼€å¯äº† AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£ä¹ˆä¼šä¼˜å…ˆä½¿ç”¨ AOF æ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€</li>
<li>åªæœ‰åœ¨ AOF æŒä¹…åŒ–åŠŸèƒ½å¤„äºå…³é—­çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨æ‰ä¼šä½¿ç”¨ RDB æ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€</li>
</ul>
<hr>
<h4 id="è‡ªåŠ¨ä¿å­˜">è‡ªåŠ¨ä¿å­˜</h4>
<h5 id="é…ç½®æ–‡ä»¶">é…ç½®æ–‡ä»¶</h5>
<p>Redis æ”¯æŒé€šè¿‡é…ç½®æœåŠ¡å™¨çš„ save é€‰é¡¹ï¼Œè®©æœåŠ¡å™¨æ¯éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡ BGSAVE å‘½ä»¤</p>
<p>é…ç½® redis.confï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">save second changes <span class="comment">#è®¾ç½®è‡ªåŠ¨æŒä¹…åŒ–æ¡ä»¶ï¼Œæ»¡è¶³é™å®šæ—¶é—´èŒƒå›´å†…keyçš„å˜åŒ–æ•°é‡å°±è¿›è¡ŒæŒä¹…åŒ–(bgsave)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>secondï¼šç›‘æ§æ—¶é—´èŒƒå›´</li>
<li>changesï¼šç›‘æ§ key çš„å˜åŒ–é‡</li>
</ul>
<p>é»˜è®¤ä¸‰ä¸ªæ¡ä»¶ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">save 900 1		<span class="comment"># 900så†…1ä¸ªkeyå‘ç”Ÿå˜åŒ–å°±è¿›è¡ŒæŒä¹…åŒ–</span></span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure>
<p>åˆ¤å®š key å˜åŒ–çš„ä¾æ®ï¼š</p>
<ul>
<li>å¯¹æ•°æ®äº§ç”Ÿäº†å½±å“ï¼Œä¸åŒ…æ‹¬æŸ¥è¯¢</li>
<li>ä¸è¿›è¡Œæ•°æ®æ¯”å¯¹ï¼Œæ¯”å¦‚ name é”®å­˜åœ¨ï¼Œé‡æ–° set name seazean ä¹Ÿç®—ä¸€æ¬¡å˜åŒ–</li>
</ul>
<p>save é…ç½®è¦æ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µè¿›è¡Œè®¾ç½®ï¼Œé¢‘åº¦è¿‡é«˜æˆ–è¿‡ä½éƒ½ä¼šå‡ºç°æ€§èƒ½é—®é¢˜ï¼Œç»“æœå¯èƒ½æ˜¯ç¾éš¾æ€§çš„</p>
<hr>
<h5 id="è‡ªåŠ¨åŸç†">è‡ªåŠ¨åŸç†</h5>
<p>æœåŠ¡å™¨çŠ¶æ€ç›¸å…³çš„å±æ€§ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="comment">// è®°å½•äº†ä¿å­˜æ¡ä»¶çš„æ•°ç»„</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">saveparam</span> *<span class="title">saveparams</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¿®æ”¹è®¡æ•°å™¨</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> dirty;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸Šä¸€æ¬¡æ‰§è¡Œä¿å­˜çš„æ—¶é—´ </span></span><br><span class="line">    <span class="type">time_t</span> lastsave;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>Redis æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®šé…ç½®æ–‡ä»¶æˆ–è€…ä¼ å…¥å¯åŠ¨å‚æ•°çš„æ–¹å¼è®¾ç½® save é€‰é¡¹ï¼Œ å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰å°±è®¾ç½®ä¸ºä¸‰ä¸ªé»˜è®¤å€¼ï¼ˆä¸ŠèŠ‚æåŠï¼‰ï¼Œè®¾ç½®æœåŠ¡å™¨çŠ¶æ€ redisServe.saveparams å±æ€§ï¼Œè¯¥æ•°ç»„æ¯ä¸€é¡¹ä¸ºä¸€ä¸ª saveparam ç»“æ„ï¼Œä»£è¡¨ save çš„é€‰é¡¹è®¾ç½®</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">saveparam</span> &#123;</span></span><br><span class="line">    <span class="comment">// ç§’æ•°</span></span><br><span class="line">    <span class="type">time_t</span> seconds</span><br><span class="line">    <span class="comment">// ä¿®æ”¹æ•°</span></span><br><span class="line">    <span class="type">int</span> changes;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>dirty è®¡æ•°å™¨è®°å½•è·ç¦»ä¸Šä¸€æ¬¡æˆåŠŸæ‰§è¡Œ SAVE æˆ–è€… BGSAVE å‘½ä»¤ä¹‹åï¼ŒæœåŠ¡å™¨ä¸­çš„æ‰€æœ‰æ•°æ®åº“è¿›è¡Œäº†å¤šå°‘æ¬¡ä¿®æ”¹ï¼ˆåŒ…æ‹¬å†™å…¥ã€åˆ é™¤ã€æ›´æ–°ç­‰æ“ä½œï¼‰ï¼Œå½“æœåŠ¡å™¨æˆåŠŸæ‰§è¡Œä¸€ä¸ªä¿®æ”¹æŒ‡ä»¤ï¼Œè¯¥å‘½ä»¤ä¿®æ”¹äº†å¤šå°‘æ¬¡æ•°æ®åº“ï¼Œ dirty çš„å€¼å°±å¢åŠ å¤šå°‘</p>
</li>
<li>
<p>lastsave å±æ€§æ˜¯ä¸€ä¸ª UNIX æ—¶é—´æˆ³ï¼Œè®°å½•äº†æœåŠ¡å™¨ä¸Šä¸€æ¬¡æˆåŠŸæ‰§è¡Œ SAVE æˆ–è€… BGSAVE å‘½ä»¤çš„æ—¶é—´</p>
</li>
</ul>
<p>Redis çš„æœåŠ¡å™¨å‘¨æœŸæ€§æ“ä½œå‡½æ•° serverCron é»˜è®¤æ¯éš” 100 æ¯«ç§’å°±ä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œè¯¥å‡½æ•°ç”¨äºå¯¹æ­£åœ¨è¿è¡Œçš„æœåŠ¡å™¨è¿›è¡Œç»´æŠ¤</p>
<p>serverCron å‡½æ•°çš„å…¶ä¸­ä¸€é¡¹å·¥ä½œæ˜¯æ£€æŸ¥ save é€‰é¡¹æ‰€è®¾ç½®çš„ä¿å­˜æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œä¼šéå† saveparams æ•°ç»„ä¸­çš„<strong>æ‰€æœ‰ä¿å­˜æ¡ä»¶</strong>ï¼Œåªè¦æœ‰ä»»æ„ä¸€ä¸ªæ¡ä»¶è¢«æ»¡è¶³æœåŠ¡å™¨å°±ä¼šæ‰§è¡Œ BGSAVE å‘½ä»¤</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-BGSAVE%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86.png" alt=""></p>
<hr>
<h4 id="æ–‡ä»¶ç»“æ„">æ–‡ä»¶ç»“æ„</h4>
<p>RDB çš„å­˜å‚¨ç»“æ„ï¼šå›¾ç¤ºå…¨å¤§å†™å•è¯æ ‡ç¤ºå¸¸é‡ï¼Œç”¨å…¨å°å†™å•è¯æ ‡ç¤ºå˜é‡å’Œæ•°æ®</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-RDB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.png" alt=""></p>
<ul>
<li>REDISï¼šé•¿åº¦ä¸º 5 å­—èŠ‚ï¼Œä¿å­˜ç€ <code>REDIS</code> äº”ä¸ªå­—ç¬¦ï¼Œæ˜¯ RDB æ–‡ä»¶çš„å¼€å¤´ï¼Œåœ¨è½½å…¥æ–‡ä»¶æ—¶å¯ä»¥å¿«é€Ÿæ£€æŸ¥æ‰€è½½å…¥çš„æ–‡ä»¶æ˜¯å¦ RDB æ–‡ä»¶</li>
<li>db_versionï¼šé•¿åº¦ä¸º 4 å­—èŠ‚ï¼Œæ˜¯ä¸€ä¸ªç”¨å­—ç¬¦ä¸²è¡¨ç¤ºçš„æ•´æ•°ï¼Œè®°å½• RDB çš„ç‰ˆæœ¬å·</li>
<li>databaseï¼šåŒ…å«ç€é›¶ä¸ªæˆ–ä»»æ„å¤šä¸ªæ•°æ®åº“ï¼Œä»¥åŠå„ä¸ªæ•°æ®åº“ä¸­çš„é”®å€¼å¯¹æ•°æ®</li>
<li>EOFï¼šé•¿åº¦ä¸º 1 å­—èŠ‚çš„å¸¸é‡ï¼Œæ ‡å¿—ç€ RDB æ–‡ä»¶æ­£æ–‡å†…å®¹çš„ç»“æŸï¼Œå½“è¯»å…¥é‡åˆ°è¿™ä¸ªå€¼æ—¶ï¼Œä»£è¡¨æ‰€æœ‰æ•°æ®åº“çš„é”®å€¼å¯¹éƒ½å·²ç»è½½å…¥å®Œæ¯•</li>
<li>check_sumï¼šé•¿åº¦ä¸º 8 å­—èŠ‚çš„æ— ç¬¦å·æ•´æ•°ï¼Œä¿å­˜ç€ä¸€ä¸ªæ ¡éªŒå’Œï¼Œè¯¥å€¼æ˜¯é€šè¿‡ REDISã€db_versionã€databasesã€EOF å››ä¸ªéƒ¨åˆ†çš„å†…å®¹è¿›è¡Œè®¡ç®—å¾—å‡ºã€‚æœåŠ¡å™¨åœ¨è½½å…¥ RDB æ–‡ä»¶æ—¶ï¼Œä¼šå°†è½½å…¥æ•°æ®æ‰€è®¡ç®—å‡ºçš„æ ¡éªŒå’Œä¸ check_sum æ‰€è®°å½•çš„æ ¡éªŒå’Œè¿›è¡Œå¯¹æ¯”ï¼Œæ¥æ£€æŸ¥ RDB æ–‡ä»¶æ˜¯å¦æœ‰å‡ºé”™æˆ–è€…æŸå</li>
</ul>
<p>Redis æœ¬èº«å¸¦æœ‰ RDB æ–‡ä»¶æ£€æŸ¥å·¥å…· redis-check-dump</p>
<hr>
<h3 id="AOF">AOF</h3>
<h4 id="åŸºæœ¬æ¦‚è¿°">åŸºæœ¬æ¦‚è¿°</h4>
<p>AOFï¼ˆappend only fileï¼‰æŒä¹…åŒ–ï¼šä»¥ç‹¬ç«‹æ—¥å¿—çš„æ–¹å¼è®°å½•æ¯æ¬¡å†™å‘½ä»¤ï¼ˆä¸è®°å½•è¯»ï¼‰æ¥è®°å½•æ•°æ®åº“çŠ¶æ€ï¼Œ<strong>å¢é‡ä¿å­˜</strong>åªè®¸è¿½åŠ æ–‡ä»¶ä½†ä¸å¯ä»¥æ”¹å†™æ–‡ä»¶ï¼Œ<strong>ä¸ RDB ç›¸æ¯”å¯ä»¥ç†è§£ä¸ºç”±è®°å½•æ•°æ®æ”¹ä¸ºè®°å½•æ•°æ®çš„å˜åŒ–</strong></p>
<p>AOF ä¸»è¦ä½œç”¨æ˜¯è§£å†³äº†<strong>æ•°æ®æŒä¹…åŒ–çš„å®æ—¶æ€§</strong>ï¼Œç›®å‰å·²ç»æ˜¯ Redis æŒä¹…åŒ–çš„ä¸»æµæ–¹å¼</p>
<p>AOF å†™æ•°æ®è¿‡ç¨‹ï¼š</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-AOFå·¥ä½œåŸç†.png" style="zoom:67%;" />
<p>Redis åªä¼šå°†å¯¹æ•°æ®åº“è¿›è¡Œäº†ä¿®æ”¹çš„å‘½ä»¤å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œå¹¶å¤åˆ¶åˆ°å„ä¸ªä»æœåŠ¡å™¨ï¼Œä½†æ˜¯ PUBSUB å’Œ SCRIPT LOAD å‘½ä»¤ä¾‹å¤–ï¼š</p>
<ul>
<li>PUBSUB å‘½ä»¤è™½ç„¶æ²¡æœ‰ä¿®æ”¹æ•°æ®åº“ï¼Œä½† PUBSUB å‘½ä»¤å‘é¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…å‘é€æ¶ˆæ¯è¿™ä¸€è¡Œä¸ºå¸¦æœ‰å‰¯ä½œç”¨ï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯çš„æ‰€æœ‰å®¢æˆ·ç«¯çš„çŠ¶æ€éƒ½ä¼šå› ä¸ºè¿™ä¸ªå‘½ä»¤è€Œæ”¹å˜ï¼Œæ‰€ä»¥æœåŠ¡å™¨éœ€è¦ä½¿ç”¨ REDIS_FORCE_AOF æ ‡å¿—å¼ºåˆ¶å°†è¿™ä¸ªå‘½ä»¤å†™å…¥ AOF æ–‡ä»¶ã€‚è¿™æ ·åœ¨å°†æ¥è½½å…¥ AOF æ–‡ä»¶æ—¶ï¼ŒæœåŠ¡å™¨å°±å¯ä»¥å†æ¬¡æ‰§è¡Œç›¸åŒçš„ PUBSUB å‘½ä»¤ï¼Œå¹¶äº§ç”Ÿç›¸åŒçš„å‰¯ä½œç”¨</li>
<li>SCRIPT LOAD  å‘½ä»¤è™½ç„¶æ²¡æœ‰ä¿®æ”¹æ•°æ®åº“ï¼Œä½†å®ƒä¿®æ”¹äº†æœåŠ¡å™¨çŠ¶æ€ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ä¸€ä¸ªå¸¦æœ‰å‰¯ä½œç”¨çš„å‘½ä»¤ï¼Œéœ€è¦ä½¿ç”¨ REDIS_FORCE_AOF</li>
</ul>
<hr>
<h4 id="æŒä¹…å®ç°">æŒä¹…å®ç°</h4>
<p>AOF æŒä¹…åŒ–åŠŸèƒ½çš„å®ç°å¯ä»¥åˆ†ä¸ºå‘½ä»¤è¿½åŠ ï¼ˆappendï¼‰ã€æ–‡ä»¶å†™å…¥ã€æ–‡ä»¶åŒæ­¥ï¼ˆsyncï¼‰ä¸‰ä¸ªæ­¥éª¤</p>
<h5 id="å‘½ä»¤è¿½åŠ ">å‘½ä»¤è¿½åŠ </h5>
<p>å¯åŠ¨ AOF çš„åŸºæœ¬é…ç½®ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">appendonly <span class="built_in">yes</span>|no				<span class="comment">#å¼€å¯AOFæŒä¹…åŒ–åŠŸèƒ½ï¼Œé»˜è®¤noï¼Œå³ä¸å¼€å¯çŠ¶æ€</span></span><br><span class="line">appendfilename filename			<span class="comment">#AOFæŒä¹…åŒ–æ–‡ä»¶åï¼Œé»˜è®¤appendonly.aofï¼Œå»ºè®®è®¾ç½®appendonly-ç«¯å£å·.aof</span></span><br><span class="line"><span class="built_in">dir</span>								<span class="comment">#AOFæŒä¹…åŒ–æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼Œä¸RDBæŒä¹…åŒ–æ–‡ä»¶è·¯å¾„ä¿æŒä¸€è‡´å³å¯</span></span><br></pre></td></tr></table></figure>
<p>å½“ AOF æŒä¹…åŒ–åŠŸèƒ½å¤„äºæ‰“å¼€çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ä¹‹åï¼Œä¼šä»¥åè®®æ ¼å¼å°†è¢«æ‰§è¡Œçš„å†™å‘½ä»¤<strong>è¿½åŠ </strong>åˆ°æœåŠ¡å™¨çŠ¶æ€çš„ aof_buf ç¼“å†²åŒºçš„æœ«å°¾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="comment">// AOF ç¼“å†²åŒº</span></span><br><span class="line">    sds aof_buf;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="æ–‡ä»¶å†™å…¥">æ–‡ä»¶å†™å…¥</h5>
<p>æœåŠ¡å™¨åœ¨å¤„ç†æ–‡ä»¶äº‹ä»¶æ—¶ä¼šæ‰§è¡Œ<strong>å†™å‘½ä»¤ï¼Œè¿½åŠ ä¸€äº›å†…å®¹åˆ° aof_buf ç¼“å†²åŒº</strong>é‡Œï¼Œæ‰€ä»¥æœåŠ¡å™¨æ¯æ¬¡ç»“æŸä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¹‹å‰ï¼Œå°±ä¼šæ‰§è¡Œ flushAppendOnlyFile å‡½æ•°ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦<strong>å°† aof_buf ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥å’Œä¿å­˜åˆ° AOF æ–‡ä»¶</strong>é‡Œ</p>
<p>flushAppendOnlyFile å‡½æ•°çš„è¡Œä¸ºç”±æœåŠ¡å™¨é…ç½®çš„ appendfsync é€‰é¡¹çš„å€¼æ¥å†³å®š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appendfsync always|everysec|no	<span class="comment">#AOFå†™æ•°æ®ç­–ç•¥ï¼šé»˜è®¤ä¸ºeverysec</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>alwaysï¼šæ¯æ¬¡å†™å…¥æ“ä½œéƒ½å°† aof_buf ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹<strong>å†™å…¥å¹¶åŒæ­¥</strong>åˆ° AOF æ–‡ä»¶</p>
<p>ç‰¹ç‚¹ï¼šå®‰å…¨æ€§æœ€é«˜ï¼Œæ•°æ®é›¶è¯¯å·®ï¼Œä½†æ˜¯æ€§èƒ½è¾ƒä½ï¼Œä¸å»ºè®®ä½¿ç”¨</p>
</li>
<li>
<p>everysecï¼šå…ˆå°† aof_buf ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥åˆ°æ“ä½œç³»ç»Ÿç¼“å­˜ï¼Œåˆ¤æ–­ä¸Šæ¬¡åŒæ­¥ AOF æ–‡ä»¶çš„æ—¶é—´è·ç¦»ç°åœ¨è¶…è¿‡ä¸€ç§’é’Ÿï¼Œå†æ¬¡è¿›è¡ŒåŒæ­¥ fsyncï¼Œè¿™ä¸ªåŒæ­¥æ“ä½œæ˜¯ç”±ä¸€ä¸ªï¼ˆå­ï¼‰çº¿ç¨‹ä¸“é—¨è´Ÿè´£æ‰§è¡Œçš„</p>
<p>ç‰¹ç‚¹ï¼šåœ¨ç³»ç»Ÿçªç„¶å®•æœºçš„æƒ…å†µä¸‹ä¸¢å¤± 1 ç§’å†…çš„æ•°æ®ï¼Œå‡†ç¡®æ€§è¾ƒé«˜ï¼Œæ€§èƒ½è¾ƒé«˜ï¼Œå»ºè®®ä½¿ç”¨ï¼Œä¹Ÿæ˜¯é»˜è®¤é…ç½®</p>
</li>
<li>
<p>noï¼šå°† aof_buf ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥åˆ°æ“ä½œç³»ç»Ÿç¼“å­˜ï¼Œä½†å¹¶ä¸è¿›è¡ŒåŒæ­¥ï¼Œä½•æ—¶åŒæ­¥ç”±æ“ä½œç³»ç»Ÿæ¥å†³å®š</p>
<p>ç‰¹ç‚¹ï¼š<strong>æ•´ä½“ä¸å¯æ§</strong>ï¼ŒæœåŠ¡å™¨å®•æœºä¼šä¸¢å¤±ä¸Šæ¬¡åŒæ­¥ AOF åçš„æ‰€æœ‰å†™æŒ‡ä»¤</p>
</li>
</ul>
<hr>
<h5 id="æ–‡ä»¶åŒæ­¥">æ–‡ä»¶åŒæ­¥</h5>
<p>åœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œå½“ç”¨æˆ·è°ƒç”¨ write å‡½æ•°å°†æ•°æ®å†™å…¥æ–‡ä»¶æ—¶ï¼Œæ“ä½œç³»ç»Ÿé€šå¸¸ä¼šå°†å†™å…¥æ•°æ®æš‚æ—¶ä¿å­˜åœ¨ä¸€ä¸ªå†…å­˜ç¼“å†²åŒºç©ºé—´ï¼Œç­‰åˆ°ç¼“å†²åŒº<strong>å†™æ»¡æˆ–è€…åˆ°è¾¾ç‰¹å®šæ—¶é—´å‘¨æœŸ</strong>ï¼Œæ‰çœŸæ­£åœ°å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°ç£ç›˜é‡Œé¢ï¼ˆåˆ·è„ï¼‰</p>
<ul>
<li>ä¼˜ç‚¹ï¼šæé«˜æ–‡ä»¶çš„å†™å…¥æ•ˆç‡</li>
<li>ç¼ºç‚¹ï¼šä¸ºå†™å…¥æ•°æ®å¸¦æ¥äº†å®‰å…¨é—®é¢˜ï¼Œå¦‚æœè®¡ç®—æœºå‘ç”Ÿåœæœºï¼Œé‚£ä¹ˆä¿å­˜åœ¨å†…å­˜ç¼“å†²åŒºé‡Œé¢çš„å†™å…¥æ•°æ®å°†ä¼šä¸¢å¤±</li>
</ul>
<p>ç³»ç»Ÿæä¾›äº† fsync å’Œ fdatasync ä¸¤ä¸ªåŒæ­¥å‡½æ•°åš<strong>å¼ºåˆ¶ç¡¬ç›˜åŒæ­¥</strong>ï¼Œå¯ä»¥è®©æ“ä½œç³»ç»Ÿç«‹å³å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°ç¡¬ç›˜é‡Œé¢ï¼Œå‡½æ•°ä¼šé˜»å¡åˆ°å†™å…¥ç¡¬ç›˜å®Œæˆåè¿”å›ï¼Œä¿è¯äº†æ•°æ®æŒä¹…åŒ–</p>
<p>å¼‚å¸¸æ¢å¤ï¼šAOF æ–‡ä»¶æŸåï¼Œé€šè¿‡ redis-check-aofâ€“fix appendonly.aof è¿›è¡Œæ¢å¤ï¼Œé‡å¯ Redisï¼Œç„¶åé‡æ–°åŠ è½½</p>
<hr>
<h4 id="æ–‡ä»¶è½½å…¥-2">æ–‡ä»¶è½½å…¥</h4>
<p>AOF æ–‡ä»¶é‡ŒåŒ…å«äº†é‡å»ºæ•°æ®åº“çŠ¶æ€æ‰€éœ€çš„æ‰€æœ‰å†™å‘½ä»¤ï¼Œæ‰€ä»¥æœåŠ¡å™¨åªè¦è¯»å…¥å¹¶é‡æ–°æ‰§è¡Œä¸€é AOF æ–‡ä»¶é‡Œçš„å‘½ä»¤ï¼Œå°±è¿˜åŸæœåŠ¡å™¨å…³é—­ä¹‹å‰çš„æ•°æ®åº“çŠ¶æ€ï¼ŒæœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶ï¼Œè¿˜åŸæ•°æ®åº“çŠ¶æ€æ‰“å°çš„æ—¥å¿—ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[8321] 05 Sep 11:58:50.449 * DB loaded from append only file: 0.000 seconds </span><br></pre></td></tr></table></figure>
<p>AOF æ–‡ä»¶é‡Œé¢é™¤äº†ç”¨äºæŒ‡å®šæ•°æ®åº“çš„ SELECT å‘½ä»¤æ˜¯æœåŠ¡å™¨è‡ªåŠ¨æ·»åŠ çš„ï¼Œå…¶ä»–éƒ½æ˜¯é€šè¿‡å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 2\r\n<span class="variable">$6</span>\r\nSELECT\r\n<span class="variable">$1</span>\r\n0\r\n	<span class="comment"># æœåŠ¡å™¨è‡ªåŠ¨æ·»åŠ </span></span><br><span class="line">* 3\r\n<span class="variable">$3</span>\r\nSET\r\n<span class="variable">$3</span>\r\nmsg\r\n<span class="variable">$5</span>\r\nhello\r\n</span><br><span class="line">* 5\r\n<span class="variable">$4</span>\r\nSADD\r\n<span class="variable">$6</span>\r\nfruits\r\n<span class="variable">$5</span>\r\napple\r\n<span class="variable">$6</span>\r\nbanana\r\n<span class="variable">$6</span>\r\ncherry\r\n</span><br></pre></td></tr></table></figure>
<p>Redis è¯»å– AOF æ–‡ä»¶å¹¶è¿˜åŸæ•°æ®åº“çŠ¶æ€çš„æ­¥éª¤ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ª<strong>ä¸å¸¦ç½‘ç»œè¿æ¥çš„ä¼ªå®¢æˆ·ç«¯</strong>ï¼ˆfake clientï¼‰æ‰§è¡Œå‘½ä»¤ï¼Œå› ä¸º Redis çš„å‘½ä»¤åªèƒ½åœ¨å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œ è€Œè½½å…¥ AOF æ–‡ä»¶æ—¶æ‰€ä½¿ç”¨çš„å‘½ä»¤æ¥æºäºæœ¬åœ° AOF æ–‡ä»¶è€Œä¸æ˜¯ç½‘ç»œè¿æ¥</li>
<li>ä» AOF æ–‡ä»¶åˆ†æå¹¶è¯»å–ä¸€æ¡å†™å‘½ä»¤</li>
<li>ä½¿ç”¨ä¼ªå®¢æˆ·ç«¯æ‰§è¡Œè¢«è¯»å‡ºçš„å†™å‘½ä»¤ï¼Œç„¶åé‡å¤ä¸Šè¿°æ­¥éª¤</li>
</ul>
<hr>
<h4 id="é‡å†™å®ç°">é‡å†™å®ç°</h4>
<h5 id="é‡å†™ç­–ç•¥">é‡å†™ç­–ç•¥</h5>
<p>AOF é‡å†™ï¼šè¯»å–æœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€ï¼Œ<strong>ç”Ÿæˆæ–° AOF æ–‡ä»¶æ¥æ›¿æ¢æ—§ AOF æ–‡ä»¶</strong>ï¼Œä¸ä¼šå¯¹ç°æœ‰çš„ AOF æ–‡ä»¶è¿›è¡Œä»»ä½•è¯»å–ã€åˆ†ææˆ–è€…å†™å…¥æ“ä½œï¼Œè€Œæ˜¯ç›´æ¥åŸå­æ›¿æ¢ã€‚æ–° AOF æ–‡ä»¶ä¸ä¼šåŒ…å«ä»»ä½•æµªè´¹ç©ºé—´çš„å†—ä½™å‘½ä»¤ï¼Œæ‰€ä»¥ä½“ç§¯é€šå¸¸ä¼šæ¯”æ—§ AOF æ–‡ä»¶å°å¾—å¤š</p>
<p>AOF é‡å†™è§„åˆ™ï¼š</p>
<ul>
<li>
<p>è¿›ç¨‹å†…å…·æœ‰æ—¶æ•ˆæ€§çš„æ•°æ®ï¼Œå¹¶ä¸”æ•°æ®å·²è¶…æ—¶å°†ä¸å†å†™å…¥æ–‡ä»¶</p>
</li>
<li>
<p>å¯¹åŒä¸€æ•°æ®çš„å¤šæ¡å†™å‘½ä»¤åˆå¹¶ä¸ºä¸€æ¡å‘½ä»¤ï¼Œå› ä¸ºä¼šè¯»å–å½“å‰çš„çŠ¶æ€ï¼Œæ‰€ä»¥ç›´æ¥å°†å½“å‰çŠ¶æ€è½¬æ¢ä¸ºä¸€æ¡å‘½ä»¤å³å¯ã€‚ä¸ºé˜²æ­¢æ•°æ®é‡è¿‡å¤§é€ æˆå®¢æˆ·ç«¯ç¼“å†²åŒºæº¢å‡ºï¼Œå¯¹ listã€setã€hashã€zset ç­‰é›†åˆç±»å‹ï¼Œ<strong>å•æ¡æŒ‡ä»¤</strong>æœ€å¤šå†™å…¥ 64 ä¸ªå…ƒç´ </p>
<p>å¦‚ lpushlist1 aã€lpush list1 bã€lpush list1 c å¯ä»¥è½¬åŒ–ä¸ºï¼šlpush list1 a b c</p>
</li>
<li>
<p>éå†™å…¥ç±»çš„æ— æ•ˆæŒ‡ä»¤å°†è¢«å¿½ç•¥ï¼Œåªä¿ç•™æœ€ç»ˆæ•°æ®çš„å†™å…¥å‘½ä»¤ï¼Œä½†æ˜¯ select æŒ‡ä»¤è™½ç„¶ä¸æ›´æ”¹æ•°æ®ï¼Œä½†æ˜¯æ›´æ”¹äº†æ•°æ®çš„å­˜å‚¨ä½ç½®ï¼Œæ­¤ç±»å‘½ä»¤åŒæ ·éœ€è¦è®°å½•</p>
</li>
</ul>
<p>AOF é‡å†™ä½œç”¨ï¼š</p>
<ul>
<li>é™ä½ç£ç›˜å ç”¨é‡ï¼Œæé«˜ç£ç›˜åˆ©ç”¨ç‡</li>
<li>æé«˜æŒä¹…åŒ–æ•ˆç‡ï¼Œé™ä½æŒä¹…åŒ–å†™æ—¶é—´ï¼Œæé«˜ IO æ€§èƒ½</li>
<li>é™ä½æ•°æ®æ¢å¤çš„ç”¨æ—¶ï¼Œæé«˜æ•°æ®æ¢å¤æ•ˆç‡</li>
</ul>
<hr>
<h5 id="é‡å†™åŸç†">é‡å†™åŸç†</h5>
<p>AOF é‡å†™ç¨‹åº aof_rewrite å‡½æ•°å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–° AOF æ–‡ä»¶ï¼Œ ä½†æ˜¯è¯¥å‡½æ•°ä¼šè¿›è¡Œå¤§é‡çš„å†™å…¥æ“ä½œï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°çš„çº¿ç¨‹å°†è¢«é•¿æ—¶é—´é˜»å¡ï¼Œæ‰€ä»¥ Redis å°† AOF é‡å†™ç¨‹åºæ”¾åˆ° fork çš„å­è¿›ç¨‹é‡Œæ‰§è¡Œï¼Œä¸ä¼šé˜»å¡çˆ¶è¿›ç¨‹ï¼Œé‡å†™å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bgrewriteaof</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>å­è¿›ç¨‹è¿›è¡Œ AOF é‡å†™æœŸé—´ï¼ŒæœåŠ¡å™¨è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰å¯ä»¥ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚</p>
</li>
<li>
<p>å­è¿›ç¨‹å¸¦æœ‰æœåŠ¡å™¨è¿›ç¨‹çš„æ•°æ®å‰¯æœ¬ï¼Œä½¿ç”¨å­è¿›ç¨‹è€Œä¸æ˜¯çº¿ç¨‹ï¼Œå¯ä»¥åœ¨é¿å…ä½¿ç”¨é”çš„æƒ…å†µä¸‹ï¼Œ ä¿è¯æ•°æ®å®‰å…¨æ€§</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-AOF%E6%89%8B%E5%8A%A8%E9%87%8D%E5%86%99%E5%8E%9F%E7%90%86.png" alt=""></p>
</li>
</ul>
<p>å­è¿›ç¨‹åœ¨è¿›è¡Œ AOF é‡å†™æœŸé—´ï¼ŒæœåŠ¡å™¨è¿›ç¨‹è¿˜éœ€è¦ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ï¼Œè€Œæ–°å‘½ä»¤å¯èƒ½ä¼šå¯¹ç°æœ‰çš„æ•°æ®åº“çŠ¶æ€è¿›è¡Œä¿®æ”¹ï¼Œä»è€Œä½¿å¾—æœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€å’Œé‡å†™åçš„ AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸ä¸€è‡´ï¼Œæ‰€ä»¥ Redis è®¾ç½®äº† AOF é‡å†™ç¼“å†²åŒº</p>
<p>å·¥ä½œæµç¨‹ï¼š</p>
<ul>
<li>Redis æœåŠ¡å™¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ï¼Œä¼šåŒæ—¶å°†è¯¥å‘½ä»¤è¿½åŠ åˆ° AOF ç¼“å†²åŒºå’Œ AOF é‡å†™ç¼“å†²åŒºï¼ˆä»åˆ›å»ºå­è¿›ç¨‹åæ‰å¼€å§‹å†™å…¥ï¼‰</li>
<li>å½“å­è¿›ç¨‹å®Œæˆ AOF é‡å†™å·¥ä½œä¹‹åï¼Œä¼šå‘çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·ï¼Œçˆ¶è¿›ç¨‹åœ¨æ¥åˆ°è¯¥ä¿¡å·ä¹‹åï¼Œ ä¼šè°ƒç”¨ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°æ‰§è¡Œæ—¶ä¼š<strong>å¯¹æœåŠ¡å™¨è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰é€ æˆé˜»å¡</strong>ï¼ˆå½±å“å¾ˆå°ï¼Œç±»ä¼¼ JVM STWï¼‰ï¼Œä¸»è¦å·¥ä½œï¼š
<ul>
<li>å°† AOF é‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹å†™å…¥åˆ°æ–° AOF æ–‡ä»¶ä¸­ï¼Œ è¿™æ—¶æ–° AOF æ–‡ä»¶æ‰€ä¿å­˜çš„çŠ¶æ€å°†å’ŒæœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´</li>
<li>å¯¹æ–°çš„ AOF æ–‡ä»¶è¿›è¡Œæ”¹åï¼Œ<strong>åŸå­åœ°ï¼ˆatomicï¼‰è¦†ç›–</strong>ç°æœ‰çš„ AOF æ–‡ä»¶ï¼Œå®Œæˆæ–°æ—§ä¸¤ä¸ª AOF æ–‡ä»¶çš„æ›¿æ¢</li>
</ul>
</li>
</ul>
<hr>
<h5 id="è‡ªåŠ¨é‡å†™">è‡ªåŠ¨é‡å†™</h5>
<p>è§¦å‘æ—¶æœºï¼šRedis ä¼šè®°å½•ä¸Šæ¬¡é‡å†™æ—¶çš„ AOF å¤§å°ï¼Œé»˜è®¤é…ç½®æ˜¯å½“ AOF æ–‡ä»¶å¤§å°æ˜¯ä¸Šæ¬¡é‡å†™åå¤§å°çš„ä¸€å€ä¸”æ–‡ä»¶å¤§äº 64M æ—¶è§¦å‘</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auto-aof-rewrite-min-size size		<span class="comment">#è®¾ç½®é‡å†™çš„åŸºå‡†å€¼ï¼Œæœ€å°æ–‡ä»¶ 64MBï¼Œè¾¾åˆ°è¿™ä¸ªå€¼å¼€å§‹é‡å†™</span></span><br><span class="line">auto-aof-rewrite-percentage percent	<span class="comment">#è§¦å‘AOFæ–‡ä»¶æ‰§è¡Œé‡å†™çš„å¢é•¿ç‡ï¼Œå½“å‰AOFæ–‡ä»¶å¤§å°è¶…è¿‡ä¸Šä¸€æ¬¡é‡å†™çš„AOFæ–‡ä»¶å¤§å°çš„ç™¾åˆ†ä¹‹å¤šå°‘æ‰ä¼šé‡å†™ï¼Œæ¯”å¦‚æ–‡ä»¶è¾¾åˆ° 100% æ—¶å¼€å§‹é‡å†™å°±æ˜¯ä¸¤å€æ—¶è§¦å‘</span></span><br></pre></td></tr></table></figure>
<p>è‡ªåŠ¨é‡å†™è§¦å‘æ¯”å¯¹å‚æ•°ï¼ˆ è¿è¡ŒæŒ‡ä»¤ <code>info Persistence</code> è·å–å…·ä½“ä¿¡æ¯ ï¼‰ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aof_current_size					<span class="comment">#AOFæ–‡ä»¶å½“å‰å°ºå¯¸å¤§å°ï¼ˆå•ä½:å­—èŠ‚ï¼‰</span></span><br><span class="line">aof_base_size						<span class="comment">#AOFæ–‡ä»¶ä¸Šæ¬¡å¯åŠ¨å’Œé‡å†™æ—¶çš„å°ºå¯¸å¤§å°ï¼ˆå•ä½:å­—èŠ‚ï¼‰</span></span><br></pre></td></tr></table></figure>
<p>è‡ªåŠ¨é‡å†™è§¦å‘æ¡ä»¶å…¬å¼ï¼š</p>
<ul>
<li>aof_current_size &gt; auto-aof-rewrite-min-size</li>
<li>(aof_current_size - aof_base_size) / aof_base_size &gt;= auto-aof-rewrite-percentage</li>
</ul>
<hr>
<h3 id="å¯¹æ¯”-2">å¯¹æ¯”</h3>
<p>RDB çš„ç‰¹ç‚¹</p>
<ul>
<li>
<p>RDB ä¼˜ç‚¹ï¼š</p>
<ul>
<li>RDB æ˜¯ä¸€ä¸ªç´§å‡‘å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå­˜å‚¨æ•ˆç‡è¾ƒé«˜ï¼Œä½†å­˜å‚¨æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå­˜å‚¨æ•ˆç‡è¾ƒä½</li>
<li>RDB å†…éƒ¨å­˜å‚¨çš„æ˜¯ Redis åœ¨æŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ®å¿«ç…§ï¼Œéå¸¸<strong>é€‚åˆç”¨äºæ•°æ®å¤‡ä»½ï¼Œå…¨é‡å¤åˆ¶ã€ç¾éš¾æ¢å¤</strong></li>
<li>RDB æ¢å¤æ•°æ®çš„é€Ÿåº¦è¦æ¯” AOF å¿«å¾ˆå¤šï¼Œå› ä¸ºæ˜¯å¿«ç…§ï¼Œç›´æ¥æ¢å¤</li>
</ul>
</li>
<li>
<p>RDB ç¼ºç‚¹ï¼š</p>
<ul>
<li>BGSAVE æŒ‡ä»¤æ¯æ¬¡è¿è¡Œè¦æ‰§è¡Œ fork æ“ä½œåˆ›å»ºå­è¿›ç¨‹ï¼Œä¼šç‰ºç‰²ä¸€äº›æ€§èƒ½</li>
<li>RDB æ–¹å¼æ— è®ºæ˜¯æ‰§è¡ŒæŒ‡ä»¤è¿˜æ˜¯åˆ©ç”¨é…ç½®ï¼Œæ— æ³•åšåˆ°å®æ—¶æŒä¹…åŒ–ï¼Œå…·æœ‰ä¸¢å¤±æ•°æ®çš„å¯èƒ½æ€§ï¼Œæœ€åä¸€æ¬¡æŒä¹…åŒ–åçš„æ•°æ®å¯èƒ½ä¸¢å¤±</li>
<li>Redis çš„ä¼—å¤šç‰ˆæœ¬ä¸­æœªè¿›è¡Œ RDB æ–‡ä»¶æ ¼å¼çš„ç‰ˆæœ¬ç»Ÿä¸€ï¼Œå¯èƒ½å‡ºç°å„ç‰ˆæœ¬ä¹‹é—´æ•°æ®æ ¼å¼æ— æ³•å…¼å®¹</li>
</ul>
</li>
</ul>
<p>AOF ç‰¹ç‚¹ï¼š</p>
<ul>
<li>AOF çš„ä¼˜ç‚¹ï¼šæ•°æ®æŒä¹…åŒ–æœ‰<strong>è¾ƒå¥½çš„å®æ—¶æ€§</strong>ï¼Œé€šè¿‡ AOF é‡å†™å¯ä»¥é™ä½æ–‡ä»¶çš„ä½“ç§¯</li>
<li>AOF çš„ç¼ºç‚¹ï¼šæ–‡ä»¶è¾ƒå¤§æ—¶æ¢å¤è¾ƒæ…¢</li>
</ul>
<p>AOF å’Œ RDB åŒæ—¶å¼€å¯ï¼Œç³»ç»Ÿé»˜è®¤å– AOF çš„æ•°æ®ï¼ˆæ•°æ®ä¸ä¼šå­˜åœ¨ä¸¢å¤±ï¼‰</p>
<p>åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>
<p>å¯¹æ•°æ®<strong>éå¸¸æ•æ„Ÿ</strong>ï¼Œå»ºè®®ä½¿ç”¨é»˜è®¤çš„ AOF æŒä¹…åŒ–æ–¹æ¡ˆï¼ŒAOF æŒä¹…åŒ–ç­–ç•¥ä½¿ç”¨ everysecondï¼Œæ¯ç§’é’Ÿ fsync ä¸€æ¬¡ï¼Œè¯¥ç­–ç•¥ Redis ä»å¯ä»¥ä¿æŒå¾ˆå¥½çš„å¤„ç†æ€§èƒ½</p>
<p>æ³¨æ„ï¼šAOF æ–‡ä»¶å­˜å‚¨ä½“ç§¯è¾ƒå¤§ï¼Œæ¢å¤é€Ÿåº¦è¾ƒæ…¢ï¼Œå› ä¸ºè¦æ‰§è¡Œæ¯æ¡æŒ‡ä»¤</p>
</li>
<li>
<p>æ•°æ®å‘ˆç°<strong>é˜¶æ®µæœ‰æ•ˆæ€§</strong>ï¼Œå»ºè®®ä½¿ç”¨ RDB æŒä¹…åŒ–æ–¹æ¡ˆï¼Œå¯ä»¥åšåˆ°é˜¶æ®µå†…æ— ä¸¢å¤±ï¼Œä¸”æ¢å¤é€Ÿåº¦è¾ƒå¿«</p>
<p>æ³¨æ„ï¼šåˆ©ç”¨ RDB å®ç°ç´§å‡‘çš„æ•°æ®æŒä¹…åŒ–ï¼Œå­˜å‚¨æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå­˜å‚¨æ•ˆç‡è¾ƒä½</p>
</li>
</ul>
<p>ç»¼åˆå¯¹æ¯”ï¼š</p>
<ul>
<li>RDB ä¸ AOF çš„é€‰æ‹©å®é™…ä¸Šæ˜¯åœ¨åšä¸€ç§æƒè¡¡ï¼Œæ¯ç§éƒ½æœ‰åˆ©æœ‰å¼Š</li>
<li>ç¾éš¾æ¢å¤é€‰ç”¨ RDB</li>
<li>å¦‚ä¸èƒ½æ‰¿å—æ•°åˆ†é’Ÿä»¥å†…çš„æ•°æ®ä¸¢å¤±ï¼Œå¯¹ä¸šåŠ¡æ•°æ®éå¸¸æ•æ„Ÿï¼Œé€‰ç”¨ AOFï¼›å¦‚èƒ½æ‰¿å—æ•°åˆ†é’Ÿä»¥å†…çš„æ•°æ®ä¸¢å¤±ï¼Œä¸”è¿½æ±‚å¤§æ•°æ®é›†çš„æ¢å¤é€Ÿåº¦ï¼Œé€‰ç”¨ RDB</li>
<li>åŒä¿é™©ç­–ç•¥ï¼ŒåŒæ—¶å¼€å¯ RDB å’Œ AOFï¼Œé‡å¯å Redis ä¼˜å…ˆä½¿ç”¨ AOF æ¥æ¢å¤æ•°æ®ï¼Œé™ä½ä¸¢å¤±æ•°æ®çš„é‡</li>
<li>ä¸å»ºè®®å•ç‹¬ç”¨ AOFï¼Œå› ä¸ºå¯èƒ½ä¼šå‡ºç° Bugï¼Œå¦‚æœåªæ˜¯åšçº¯å†…å­˜ç¼“å­˜ï¼Œå¯ä»¥éƒ½ä¸ç”¨</li>
</ul>
<hr>
<h3 id="fork">fork</h3>
<h4 id="ä»‹ç»">ä»‹ç»</h4>
<p>fork() å‡½æ•°åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å‡ ä¹æ˜¯å®Œå…¨ç›¸åŒçš„è¿›ç¨‹ï¼Œç³»ç»Ÿå…ˆç»™å­è¿›ç¨‹åˆ†é…èµ„æºï¼Œç„¶åæŠŠçˆ¶è¿›ç¨‹çš„æ‰€æœ‰æ•°æ®éƒ½å¤åˆ¶åˆ°å­è¿›ç¨‹ä¸­ï¼Œåªæœ‰å°‘æ•°å€¼ä¸çˆ¶è¿›ç¨‹çš„å€¼ä¸åŒï¼Œç›¸å½“äºå…‹éš†äº†ä¸€ä¸ªè¿›ç¨‹</p>
<p>åœ¨å®Œæˆå¯¹å…¶è°ƒç”¨ä¹‹åï¼Œä¼šäº§ç”Ÿ 2 ä¸ªè¿›ç¨‹ï¼Œä¸”æ¯ä¸ªè¿›ç¨‹éƒ½ä¼š<strong>ä» fork() çš„è¿”å›å¤„å¼€å§‹æ‰§è¡Œ</strong>ï¼Œè¿™ä¸¤ä¸ªè¿›ç¨‹å°†æ‰§è¡Œç›¸åŒçš„ç¨‹åºæ®µï¼Œä½†æ˜¯æ‹¥æœ‰å„è‡ªä¸åŒçš„å †æ®µï¼Œæ ˆæ®µï¼Œæ•°æ®æ®µï¼Œæ¯ä¸ªå­è¿›ç¨‹éƒ½å¯ä¿®æ”¹å„è‡ªçš„æ•°æ®æ®µï¼Œå †æ®µï¼Œå’Œæ ˆæ®µ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="comment">// çˆ¶è¿›ç¨‹è¿”å›å­è¿›ç¨‹çš„pidï¼Œå­è¿›ç¨‹è¿”å›0ï¼Œé”™è¯¯è¿”å›è´Ÿå€¼ï¼Œæ ¹æ®è¿”å›å€¼çš„ä¸åŒè¿›è¡Œå¯¹åº”çš„é€»è¾‘å¤„ç†</span></span><br></pre></td></tr></table></figure>
<p>fork è°ƒç”¨ä¸€æ¬¡ï¼Œå´èƒ½å¤Ÿ<strong>è¿”å›ä¸¤æ¬¡</strong>ï¼Œå¯èƒ½æœ‰ä¸‰ç§ä¸åŒçš„è¿”å›å€¼ï¼š</p>
<ul>
<li>åœ¨çˆ¶è¿›ç¨‹ä¸­ï¼Œfork è¿”å›æ–°åˆ›å»ºå­è¿›ç¨‹çš„è¿›ç¨‹ ID</li>
<li>åœ¨å­è¿›ç¨‹ä¸­ï¼Œfork è¿”å› 0</li>
<li>å¦‚æœå‡ºç°é”™è¯¯ï¼Œfork è¿”å›ä¸€ä¸ªè´Ÿå€¼ï¼Œé”™è¯¯åŸå› ï¼š
<ul>
<li>å½“å‰çš„è¿›ç¨‹æ•°å·²ç»è¾¾åˆ°äº†ç³»ç»Ÿè§„å®šçš„ä¸Šé™ï¼Œè¿™æ—¶ errno çš„å€¼è¢«è®¾ç½®ä¸º EAGAIN</li>
<li>ç³»ç»Ÿå†…å­˜ä¸è¶³ï¼Œè¿™æ—¶ errno çš„å€¼è¢«è®¾ç½®ä¸º ENOMEM</li>
</ul>
</li>
</ul>
<p>fpid çš„å€¼åœ¨çˆ¶å­è¿›ç¨‹ä¸­ä¸åŒï¼šè¿›ç¨‹å½¢æˆäº†é“¾è¡¨ï¼Œçˆ¶è¿›ç¨‹çš„ fpid æŒ‡å‘å­è¿›ç¨‹çš„è¿›ç¨‹ idï¼Œå› ä¸ºå­è¿›ç¨‹æ²¡æœ‰å­è¿›ç¨‹ï¼Œæ‰€ä»¥å…¶ fpid ä¸º0</p>
<p>åˆ›å»ºæ–°è¿›ç¨‹æˆåŠŸåï¼Œç³»ç»Ÿä¸­å‡ºç°ä¸¤ä¸ªåŸºæœ¬å®Œå…¨ç›¸åŒçš„è¿›ç¨‹ï¼Œè¿™ä¸¤ä¸ªè¿›ç¨‹æ‰§è¡Œæ²¡æœ‰å›ºå®šçš„å…ˆåé¡ºåºï¼Œå“ªä¸ªè¿›ç¨‹å…ˆæ‰§è¡Œè¦çœ‹ç³»ç»Ÿçš„è°ƒåº¦ç­–ç•¥</p>
<p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªç‹¬ç‰¹ï¼ˆäº’ä¸ç›¸åŒï¼‰çš„è¿›ç¨‹æ ‡è¯†ç¬¦ process IDï¼Œå¯ä»¥é€šè¿‡ getpid() å‡½æ•°è·å¾—ï¼›è¿˜æœ‰ä¸€ä¸ªè®°å½•çˆ¶è¿›ç¨‹ pid çš„å˜é‡ï¼Œå¯ä»¥é€šè¿‡ getppid() å‡½æ•°è·å¾—å˜é‡çš„å€¼</p>
<hr>
<h4 id="ä½¿ç”¨">ä½¿ç”¨</h4>
<p>åŸºæœ¬ä½¿ç”¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>   </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">()</span>   </span><br><span class="line">&#123;   </span><br><span class="line">    <span class="type">pid_t</span> fpid; <span class="comment">// fpidè¡¨ç¤ºforkå‡½æ•°è¿”å›çš„å€¼  </span></span><br><span class="line">    <span class="type">int</span> count = <span class="number">0</span>;  </span><br><span class="line">    fpid = fork();   </span><br><span class="line">    <span class="keyword">if</span> (fpid &lt; <span class="number">0</span>)   </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;error in fork!&quot;</span>);   </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (fpid == <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;i am the child process, my process id is %d/n&quot;</span>, getpid());    </span><br><span class="line">        count++;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;i am the parent process, my process id is %d/n&quot;</span>, getpid());   </span><br><span class="line">        count++;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;count: %d/n&quot;</span>,count);<span class="comment">// 1  </span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">/* è¾“å‡ºå†…å®¹ï¼š</span></span><br><span class="line"><span class="comment">    i am the child process, my process id is 5574</span></span><br><span class="line"><span class="comment">    count: 1</span></span><br><span class="line"><span class="comment">    i am the parent process, my process id is 5573</span></span><br><span class="line"><span class="comment">    count: 1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>è¿›é˜¶ä½¿ç”¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>  </span><br><span class="line">&#123;  </span><br><span class="line">   <span class="type">int</span> i = <span class="number">0</span>;  </span><br><span class="line">   <span class="comment">// ppid æŒ‡å½“å‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹pid  </span></span><br><span class="line">   <span class="comment">// pid æŒ‡å½“å‰è¿›ç¨‹çš„pid,  </span></span><br><span class="line">   <span class="comment">// fpid æŒ‡forkè¿”å›ç»™å½“å‰è¿›ç¨‹çš„å€¼ï¼Œåœ¨è¿™å¯ä»¥è¡¨ç¤ºå­è¿›ç¨‹</span></span><br><span class="line">   <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)&#123;  </span><br><span class="line">       <span class="type">pid_t</span> fpid = fork();  </span><br><span class="line">       <span class="keyword">if</span>(fpid == <span class="number">0</span>)  </span><br><span class="line">           <span class="built_in">printf</span>(<span class="string">&quot;%d child  %4d %4d %4d/n&quot;</span>,i, getppid(), getpid(), fpid);  </span><br><span class="line">       <span class="keyword">else</span>  </span><br><span class="line">           <span class="built_in">printf</span>(<span class="string">&quot;%d parent %4d %4d %4d/n&quot;</span>,i, getppid(), getpid(),fpid);  </span><br><span class="line">   &#125;  </span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/*è¾“å‡ºå†…å®¹ï¼š</span></span><br><span class="line"><span class="comment">	i        çˆ¶id  id  å­id</span></span><br><span class="line"><span class="comment">	0 parent 2043 3224 3225</span></span><br><span class="line"><span class="comment">    0 child  3224 3225    0</span></span><br><span class="line"><span class="comment">    1 parent 2043 3224 3226</span></span><br><span class="line"><span class="comment">    1 parent 3224 3225 3227</span></span><br><span class="line"><span class="comment">    1 child     1 3227    0</span></span><br><span class="line"><span class="comment">    1 child     1 3226    0 </span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-forkå‡½æ•°ä½¿ç”¨æ¼”ç¤º.png" style="zoom: 80%;" />
<p>åœ¨ p3224 å’Œ p3225 æ‰§è¡Œå®Œç¬¬äºŒä¸ªå¾ªç¯åï¼Œmain å‡½æ•°é€€å‡ºï¼Œè¿›ç¨‹æ­»äº¡ã€‚æ‰€ä»¥ p3226ï¼Œp3227 å°±æ²¡æœ‰çˆ¶è¿›ç¨‹äº†ï¼Œæˆä¸ºå­¤å„¿è¿›ç¨‹ï¼Œæ‰€ä»¥ p3226 å’Œ p3227 çš„çˆ¶è¿›ç¨‹å°±è¢«ç½®ä¸º ID ä¸º 1 çš„ init è¿›ç¨‹ï¼ˆç¬”è®° Tool â†’ Linux â†’ è¿›ç¨‹ç®¡ç†è¯¦è§£ï¼‰</p>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/love_gaohz/article/details/41727415">https://blog.csdn.net/love_gaohz/article/details/41727415</a></p>
<hr>
<h4 id="å†…å­˜-2">å†…å­˜</h4>
<p>fork() è°ƒç”¨ä¹‹åçˆ¶å­è¿›ç¨‹çš„å†…å­˜å…³ç³»</p>
<p>æ—©æœŸ Linux çš„ fork() å®ç°æ—¶ï¼Œå°±æ˜¯å…¨éƒ¨å¤åˆ¶ï¼Œè¿™ç§æ–¹æ³•æ•ˆç‡å¤ªä½ï¼Œè€Œä¸”é€ æˆäº†å¾ˆå¤§çš„å†…å­˜æµªè´¹ï¼Œç°åœ¨ Linux å®ç°é‡‡ç”¨äº†ä¸¤ç§æ–¹æ³•ï¼š</p>
<ul>
<li>
<p>çˆ¶å­è¿›ç¨‹çš„ä»£ç æ®µæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥ä»£ç æ®µæ˜¯æ²¡å¿…è¦å¤åˆ¶çš„ï¼Œåªéœ€å†…æ ¸å°†ä»£ç æ®µæ ‡è®°ä¸ºåªè¯»ï¼Œçˆ¶å­è¿›ç¨‹å°±å…±äº«æ­¤ä»£ç æ®µã€‚fork() ä¹‹ååœ¨è¿›ç¨‹åˆ›å»ºä»£ç æ®µæ—¶ï¼Œå­è¿›ç¨‹çš„è¿›ç¨‹çº§é¡µè¡¨é¡¹éƒ½æŒ‡å‘å’Œçˆ¶è¿›ç¨‹ç›¸åŒçš„ç‰©ç†é¡µå¸§</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-forkä»¥åå†…å­˜å…³ç³»1.png" style="zoom: 67%;" />
</li>
<li>
<p>å¯¹äºçˆ¶è¿›ç¨‹çš„æ•°æ®æ®µï¼Œå †æ®µï¼Œæ ˆæ®µä¸­çš„å„é¡µï¼Œç”±äºçˆ¶å­è¿›ç¨‹ç›¸äº’ç‹¬ç«‹ï¼Œé‡‡ç”¨<strong>å†™æ—¶å¤åˆ¶ COW</strong> çš„æŠ€æœ¯ï¼Œæ¥æé«˜å†…å­˜ä»¥åŠå†…æ ¸çš„åˆ©ç”¨ç‡</p>
<p>åœ¨ fork ä¹‹åä¸¤ä¸ªè¿›ç¨‹ç”¨çš„æ˜¯ç›¸åŒçš„ç‰©ç†ç©ºé—´ï¼ˆå†…å­˜åŒºï¼‰ï¼Œå­è¿›ç¨‹çš„ä»£ç æ®µã€æ•°æ®æ®µã€å †æ ˆéƒ½æ˜¯æŒ‡å‘çˆ¶è¿›ç¨‹çš„ç‰©ç†ç©ºé—´ï¼Œ<strong>ä¸¤è€…çš„è™šæ‹Ÿç©ºé—´ä¸åŒï¼Œä½†å…¶å¯¹åº”çš„ç‰©ç†ç©ºé—´æ˜¯åŒä¸€ä¸ª</strong>ï¼Œå½“çˆ¶å­è¿›ç¨‹ä¸­æœ‰æ›´æ”¹ç›¸åº”æ®µçš„è¡Œä¸ºå‘ç”Ÿæ—¶ï¼Œå†ä¸ºå­è¿›ç¨‹ç›¸åº”çš„æ®µåˆ†é…ç‰©ç†ç©ºé—´ã€‚å¦‚æœä¸¤è€…çš„ä»£ç å®Œå…¨ç›¸åŒï¼Œä»£ç æ®µç»§ç»­å…±äº«çˆ¶è¿›ç¨‹çš„ç‰©ç†ç©ºé—´ï¼›è€Œå¦‚æœä¸¤è€…æ‰§è¡Œçš„ä»£ç ä¸åŒï¼Œå­è¿›ç¨‹çš„ä»£ç æ®µä¹Ÿä¼šåˆ†é…å•ç‹¬çš„ç‰©ç†ç©ºé—´ã€‚</p>
<p>fork ä¹‹åå†…æ ¸ä¼šå°†å­è¿›ç¨‹æ”¾åœ¨é˜Ÿåˆ—çš„å‰é¢ï¼Œè®©å­è¿›ç¨‹å…ˆæ‰§è¡Œï¼Œä»¥å…çˆ¶è¿›ç¨‹æ‰§è¡Œå¯¼è‡´å†™æ—¶å¤åˆ¶ï¼Œè€Œåå­è¿›ç¨‹å†æ‰§è¡Œï¼Œå› æ— æ„ä¹‰çš„å¤åˆ¶è€Œé€ æˆæ•ˆç‡çš„ä¸‹é™</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-forkä»¥åå†…å­˜å…³ç³»2.png" style="zoom:67%;" />
</li>
</ul>
<p>è¡¥å……çŸ¥è¯†ï¼š</p>
<p>vforkï¼ˆè™šæ‹Ÿå†…å­˜ fork virtual memory forkï¼‰ï¼šè°ƒç”¨ vfork() çˆ¶è¿›ç¨‹è¢«æŒ‚èµ·ï¼Œå­è¿›ç¨‹ä½¿ç”¨çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚ä¸é‡‡ç”¨å†™æ—¶å¤åˆ¶ï¼Œå¦‚æœå­è¿›ç¨‹ä¿®æ”¹çˆ¶åœ°å€ç©ºé—´çš„ä»»ä½•é¡µé¢ï¼Œè¿™äº›ä¿®æ”¹è¿‡çš„é¡µé¢å¯¹äºæ¢å¤çš„çˆ¶è¿›ç¨‹æ˜¯å¯è§çš„</p>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/Shreck66/article/details/47039937">https://blog.csdn.net/Shreck66/article/details/47039937</a></p>
<hr>
<h2 id="äº‹åŠ¡æœºåˆ¶">äº‹åŠ¡æœºåˆ¶</h2>
<h3 id="äº‹åŠ¡ç‰¹å¾">äº‹åŠ¡ç‰¹å¾</h3>
<p>Redis äº‹åŠ¡å°±æ˜¯å°†å¤šä¸ªå‘½ä»¤è¯·æ±‚æ‰“åŒ…ï¼Œç„¶å<strong>ä¸€æ¬¡æ€§ã€æŒ‰é¡ºåº</strong>åœ°æ‰§è¡Œå¤šä¸ªå‘½ä»¤çš„æœºåˆ¶ï¼Œå¹¶ä¸”åœ¨äº‹åŠ¡æ‰§è¡ŒæœŸé—´ï¼ŒæœåŠ¡å™¨ä¸ä¼šä¸­æ–­äº‹åŠ¡å»æ‰§è¡Œå…¶ä»–çš„å‘½ä»¤è¯·æ±‚ï¼Œä¼šå°†äº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œç„¶åæ‰å»å¤„ç†å…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ï¼ŒRedis äº‹åŠ¡çš„ç‰¹æ€§ï¼š</p>
<ul>
<li>Redis äº‹åŠ¡<strong>æ²¡æœ‰éš”ç¦»çº§åˆ«</strong>çš„æ¦‚å¿µï¼Œé˜Ÿåˆ—ä¸­çš„å‘½ä»¤åœ¨äº‹åŠ¡æ²¡æœ‰æäº¤ä¹‹å‰éƒ½ä¸ä¼šå®é™…è¢«æ‰§è¡Œ</li>
<li>Redis å•æ¡å‘½ä»¤å¼ä¿å­˜åŸå­æ€§çš„ï¼Œä½†æ˜¯äº‹åŠ¡<strong>ä¸ä¿è¯åŸå­æ€§</strong>ï¼Œäº‹åŠ¡ä¸­å¦‚æœæœ‰ä¸€æ¡å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå…¶åçš„å‘½ä»¤ä»ç„¶ä¼šè¢«æ‰§è¡Œï¼Œæ²¡æœ‰å›æ»š</li>
</ul>
<hr>
<h3 id="å·¥ä½œæµç¨‹">å·¥ä½œæµç¨‹</h3>
<p>äº‹åŠ¡çš„æ‰§è¡Œæµç¨‹åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p>
<ul>
<li>
<p>äº‹åŠ¡å¼€å§‹ï¼šMULTI å‘½ä»¤çš„æ‰§è¡Œæ ‡å¿—ç€äº‹åŠ¡çš„å¼€å§‹ï¼Œé€šè¿‡åœ¨å®¢æˆ·ç«¯çŠ¶æ€çš„ flags å±æ€§ä¸­æ‰“å¼€ REDIS_MULTI æ ‡è¯†ï¼Œå°†æ‰§è¡Œè¯¥å‘½ä»¤çš„å®¢æˆ·ç«¯ä»éäº‹åŠ¡çŠ¶æ€åˆ‡æ¢è‡³äº‹åŠ¡çŠ¶æ€</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MULTI	<span class="comment"># è®¾å®šäº‹åŠ¡çš„å¼€å¯ä½ç½®ï¼Œæ­¤æŒ‡ä»¤æ‰§è¡Œåï¼Œåç»­çš„æ‰€æœ‰æŒ‡ä»¤å‡åŠ å…¥åˆ°äº‹åŠ¡ä¸­</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å‘½ä»¤å…¥é˜Ÿï¼šäº‹åŠ¡é˜Ÿåˆ—ä»¥å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„æ–¹å¼ä¿å­˜å…¥é˜Ÿçš„å‘½ä»¤ï¼Œæ¯ä¸ª Redis å®¢æˆ·ç«¯éƒ½æœ‰äº‹åŠ¡çŠ¶æ€ï¼ŒåŒ…å«ç€äº‹åŠ¡é˜Ÿåˆ—ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisClient</span> &#123;</span></span><br><span class="line">	<span class="comment">// äº‹åŠ¡çŠ¶æ€</span></span><br><span class="line">    multiState mstate;	<span class="comment">/* MULTI/EXEC state */</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">multiState</span> &#123;</span></span><br><span class="line">    <span class="comment">// äº‹åŠ¡é˜Ÿåˆ—ï¼ŒFIFOé¡ºåº</span></span><br><span class="line">    multiCmd *commands; </span><br><span class="line">    </span><br><span class="line">   	<span class="comment">// å·²å…¥é˜Ÿå‘½ä»¤è®¡æ•°</span></span><br><span class="line">    <span class="type">int</span> countï¼›</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœå‘½ä»¤ä¸º EXECã€DISCARDã€WATCHã€MULTI å››ä¸ªå‘½ä¸­çš„ä¸€ä¸ªï¼Œé‚£ä¹ˆæœåŠ¡å™¨ç«‹å³æ‰§è¡Œè¿™ä¸ªå‘½ä»¤</li>
<li>å…¶ä»–å‘½ä»¤æœåŠ¡å™¨ä¸æ‰§è¡Œï¼Œè€Œæ˜¯å°†å‘½ä»¤æ”¾å…¥ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—é‡Œé¢ï¼Œç„¶åå‘å®¢æˆ·ç«¯è¿”å› QUEUED å›å¤</li>
</ul>
</li>
<li>
<p>äº‹åŠ¡æ‰§è¡Œï¼šEXEC æäº¤äº‹åŠ¡ç»™æœåŠ¡å™¨æ‰§è¡Œï¼ŒæœåŠ¡å™¨ä¼šéå†è¿™ä¸ªå®¢æˆ·ç«¯çš„äº‹åŠ¡é˜Ÿåˆ—ï¼Œæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„å‘½ä»¤å¹¶å°†æ‰§è¡Œç»“æœè¿”å›</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXEC	<span class="comment"># Commit æäº¤ï¼Œæ‰§è¡Œäº‹åŠ¡ï¼Œä¸multiæˆå¯¹å‡ºç°ï¼Œæˆå¯¹ä½¿ç”¨</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>äº‹åŠ¡å–æ¶ˆçš„æ–¹æ³•ï¼š</p>
<ul>
<li>
<p>å–æ¶ˆäº‹åŠ¡ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DISCARD	<span class="comment"># ç»ˆæ­¢å½“å‰äº‹åŠ¡çš„å®šä¹‰ï¼Œå‘ç”Ÿåœ¨multiä¹‹åï¼Œexecä¹‹å‰</span></span><br></pre></td></tr></table></figure>
<p>ä¸€èˆ¬ç”¨äºäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­è¾“å…¥äº†é”™è¯¯çš„æŒ‡ä»¤ï¼Œç›´æ¥å–æ¶ˆè¿™æ¬¡äº‹åŠ¡ï¼Œç±»ä¼¼äºå›æ»š</p>
</li>
</ul>
<hr>
<h3 id="WATCH">WATCH</h3>
<h4 id="ç›‘è§†æœºåˆ¶">ç›‘è§†æœºåˆ¶</h4>
<p>WATCH å‘½ä»¤æ˜¯ä¸€ä¸ªä¹è§‚é”ï¼ˆoptimistic lockingï¼‰ï¼Œå¯ä»¥åœ¨ EXEC å‘½ä»¤æ‰§è¡Œä¹‹å‰ï¼Œç›‘è§†ä»»æ„æ•°é‡çš„æ•°æ®åº“é”®ï¼Œå¹¶åœ¨ EXEC å‘½ä»¤æ‰§è¡Œæ—¶ï¼Œæ£€æŸ¥è¢«ç›‘è§†çš„é”®æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªå·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œå¦‚æœæ˜¯æœåŠ¡å™¨å°†æ‹’ç»æ‰§è¡Œäº‹åŠ¡ï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›ä»£è¡¨äº‹åŠ¡æ‰§è¡Œå¤±è´¥çš„ç©ºå›å¤</p>
<ul>
<li>
<p>æ·»åŠ ç›‘æ§é”</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WATCH key1 [key2â€¦â€¦]	<span class="comment">#å¯ä»¥ç›‘æ§ä¸€ä¸ªæˆ–è€…å¤šä¸ªkey</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å–æ¶ˆå¯¹æ‰€æœ‰ key çš„ç›‘è§†</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UNWATCH</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="å®ç°åŸç†">å®ç°åŸç†</h4>
<p>æ¯ä¸ª Redis æ•°æ®åº“éƒ½ä¿å­˜ç€ä¸€ä¸ª watched_keys å­—å…¸ï¼Œé”®æ˜¯æŸä¸ªè¢« WATCH ç›‘è§†çš„æ•°æ®åº“é”®ï¼Œå€¼åˆ™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè®°å½•äº†æ‰€æœ‰ç›‘è§†ç›¸åº”æ•°æ®åº“é”®çš„å®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisDb</span> &#123;</span></span><br><span class="line">	<span class="comment">// æ­£åœ¨è¢« WATCH å‘½ä»¤ç›‘è§†çš„é”®</span></span><br><span class="line">    dict *watched_keys;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œä¿®æ”¹çš„å‘½ä»¤ï¼Œåœ¨æ‰§è¡Œåéƒ½ä¼šè°ƒç”¨ <code>multi.c/touchWatchKey</code> å‡½æ•°å¯¹ watched_keys å­—å…¸è¿›è¡Œæ£€æŸ¥ï¼Œæ˜¯å¦æœ‰å®¢æˆ·ç«¯æ­£åœ¨ç›‘è§†åˆšè¢«å‘½ä»¤ä¿®æ”¹è¿‡çš„æ•°æ®åº“é”®ï¼Œå¦‚æœæœ‰çš„è¯å‡½æ•°ä¼šå°†ç›‘è§†è¢«ä¿®æ”¹é”®çš„å®¢æˆ·ç«¯çš„ REDIS_DIRTY_CAS æ ‡è¯†æ‰“å¼€ï¼Œè¡¨ç¤ºè¯¥å®¢æˆ·ç«¯çš„äº‹åŠ¡å®‰å…¨æ€§å·²ç»è¢«ç ´å</p>
<p>æœåŠ¡å™¨æ¥æ”¶åˆ°ä¸ªå®¢æˆ·ç«¯ EXEC å‘½ä»¤æ—¶ï¼Œä¼šæ ¹æ®è¿™ä¸ªå®¢æˆ·ç«¯æ˜¯å¦æ‰“å¼€äº† REDIS_DIRTY_CAS æ ‡è¯†ï¼Œå¦‚æœæ‰“å¼€äº†è¯´æ˜å®¢æˆ·ç«¯æäº¤äº‹åŠ¡ä¸å®‰å…¨ï¼ŒæœåŠ¡å™¨ä¼šæ‹’ç»æ‰§è¡Œ</p>
<hr>
<h3 id="ACID">ACID</h3>
<h4 id="åŸå­æ€§">åŸå­æ€§</h4>
<p>äº‹åŠ¡å…·æœ‰åŸå­æ€§ï¼ˆAtomicityï¼‰ã€ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€éš”ç¦»æ€§ï¼ˆIsolationï¼‰ã€æŒä¹…æ€§ï¼ˆDurabilityï¼‰</p>
<p>åŸå­æ€§æŒ‡äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„å‘½ä»¤è¦ä¹ˆå°±å…¨éƒ¨éƒ½æ‰§è¡Œï¼Œè¦ä¹ˆä¸€ä¸ªéƒ½ä¸æ‰§è¡Œï¼Œä½†æ˜¯åœ¨å‘½ä»¤æ‰§è¡Œå‡ºé”™æ—¶ï¼Œä¸ä¼šä¿è¯åŸå­æ€§ï¼ˆä¸‹ä¸€èŠ‚è¯¦è§£ï¼‰</p>
<p>Redis ä¸æ”¯æŒäº‹åŠ¡å›æ»šæœºåˆ¶ï¼ˆrollbackï¼‰ï¼Œå³ä½¿äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æŸä¸ªå‘½ä»¤åœ¨æ‰§è¡ŒæœŸé—´å‡ºç°äº†é”™è¯¯ï¼Œæ•´ä¸ªäº‹åŠ¡ä¹Ÿä¼šç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œç›´åˆ°å°†äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½æ‰§è¡Œå®Œæ¯•ä¸ºæ­¢</p>
<p>å›æ»šéœ€è¦ç¨‹åºå‘˜åœ¨ä»£ç ä¸­å®ç°ï¼Œåº”è¯¥å°½å¯èƒ½é¿å…ï¼š</p>
<ul>
<li>
<p>äº‹åŠ¡æ“ä½œä¹‹å‰è®°å½•æ•°æ®çš„çŠ¶æ€</p>
<ul>
<li>
<p>å•æ•°æ®ï¼šstring</p>
</li>
<li>
<p>å¤šæ•°æ®ï¼šhashã€listã€setã€zset</p>
</li>
</ul>
</li>
<li>
<p>è®¾ç½®æŒ‡ä»¤æ¢å¤æ‰€æœ‰çš„è¢«ä¿®æ”¹çš„é¡¹</p>
<ul>
<li>
<p>å•æ•°æ®ï¼šç›´æ¥ setï¼ˆæ³¨æ„å‘¨è¾¹å±æ€§ï¼Œä¾‹å¦‚æ—¶æ•ˆï¼‰</p>
</li>
<li>
<p>å¤šæ•°æ®ï¼šä¿®æ”¹å¯¹åº”å€¼æˆ–æ•´ä½“å…‹éš†å¤åˆ¶</p>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="ä¸€è‡´æ€§">ä¸€è‡´æ€§</h4>
<p>äº‹åŠ¡å…·æœ‰ä¸€è‡´æ€§æŒ‡çš„æ˜¯ï¼Œæ•°æ®åº“åœ¨æ‰§è¡Œäº‹åŠ¡ä¹‹å‰æ˜¯ä¸€è‡´çš„ï¼Œé‚£ä¹ˆåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹åï¼Œæ— è®ºäº‹åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œæ•°æ®åº“ä¹Ÿåº”è¯¥ä»ç„¶æ˜¯ä¸€è‡´çš„</p>
<p>ä¸€è‡´æ˜¯æ•°æ®ç¬¦åˆæ•°æ®åº“çš„å®šä¹‰å’Œè¦æ±‚ï¼Œæ²¡æœ‰åŒ…å«éæ³•æˆ–è€…æ— æ•ˆçš„é”™è¯¯æ•°æ®ï¼ŒRedis é€šè¿‡é”™è¯¯æ£€æµ‹å’Œç®€å•çš„è®¾è®¡æ¥ä¿è¯äº‹åŠ¡çš„ä¸€è‡´æ€§ï¼š</p>
<ul>
<li>
<p>å…¥é˜Ÿé”™è¯¯ï¼šå‘½ä»¤æ ¼å¼è¾“å…¥é”™è¯¯ï¼Œå‡ºç°è¯­æ³•é”™è¯¯é€ æˆï¼Œ<strong>æ•´ä½“äº‹åŠ¡ä¸­æ‰€æœ‰å‘½ä»¤å‡ä¸ä¼šæ‰§è¡Œ</strong>ï¼ŒåŒ…æ‹¬é‚£äº›è¯­æ³•æ­£ç¡®çš„å‘½ä»¤</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‘½ä»¤çš„è¯­æ³•é”™è¯¯.png" style="zoom:80%;" />
</li>
<li>
<p>æ‰§è¡Œé”™è¯¯ï¼šå‘½ä»¤æ‰§è¡Œå‡ºç°é”™è¯¯ï¼Œä¾‹å¦‚å¯¹å­—ç¬¦ä¸²è¿›è¡Œ incr æ“ä½œï¼Œäº‹åŠ¡ä¸­æ­£ç¡®çš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œè¿è¡Œé”™è¯¯çš„å‘½ä»¤ä¸ä¼šè¢«æ‰§è¡Œ</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-äº‹åŠ¡ä¸­æ‰§è¡Œé”™è¯¯.png" style="zoom:80%;" />
</li>
<li>
<p>æœåŠ¡å™¨åœæœºï¼š</p>
<ul>
<li>å¦‚æœæœåŠ¡å™¨è¿è¡Œåœ¨æ— æŒä¹…åŒ–çš„å†…å­˜æ¨¡å¼ä¸‹ï¼Œé‚£ä¹ˆé‡å¯ä¹‹åçš„æ•°æ®åº“å°†æ˜¯ç©ºç™½çš„ï¼Œå› æ­¤æ•°æ®åº“æ˜¯ä¸€è‡´çš„</li>
<li>å¦‚æœæœåŠ¡å™¨è¿è¡Œåœ¨æŒä¹…åŒ–æ¨¡å¼ä¸‹ï¼Œé‡å¯ä¹‹åå°†æ•°æ®åº“è¿˜åŸåˆ°ä¸€è‡´çš„çŠ¶æ€</li>
</ul>
</li>
</ul>
<hr>
<h4 id="éš”ç¦»æ€§">éš”ç¦»æ€§</h4>
<p>Redis æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ‰§è¡ŒåŸç†ï¼Œæ‰€ä»¥å¯¹äºéš”ç¦»æ€§ï¼Œåˆ†ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>å¹¶å‘æ“ä½œåœ¨ EXEC å‘½ä»¤å‰æ‰§è¡Œï¼Œéš”ç¦»æ€§çš„ä¿è¯è¦ä½¿ç”¨ WATCH æœºåˆ¶æ¥å®ç°ï¼Œå¦åˆ™éš”ç¦»æ€§æ— æ³•ä¿è¯</li>
<li>å¹¶å‘æ“ä½œåœ¨ EXEC å‘½ä»¤åæ‰§è¡Œï¼Œéš”ç¦»æ€§å¯ä»¥ä¿è¯</li>
</ul>
<hr>
<h4 id="æŒä¹…æ€§">æŒä¹…æ€§</h4>
<p>Redis å¹¶æ²¡æœ‰ä¸ºäº‹åŠ¡æä¾›ä»»ä½•é¢å¤–çš„æŒä¹…åŒ–åŠŸèƒ½ï¼Œäº‹åŠ¡çš„æŒä¹…æ€§ç”± Redis æ‰€ä½¿ç”¨çš„æŒä¹…åŒ–æ¨¡å¼å†³å®š</p>
<p>é…ç½®é€‰é¡¹ <code>no-appendfsync-on-rewrite</code> å¯ä»¥é…åˆ appendfsync é€‰é¡¹åœ¨ AOF æŒä¹…åŒ–æ¨¡å¼ä½¿ç”¨ï¼š</p>
<ul>
<li>é€‰é¡¹æ‰“å¼€æ—¶åœ¨æ‰§è¡Œ BGSAVE æˆ–è€… BGREWRITEAOF æœŸé—´ï¼ŒæœåŠ¡å™¨ä¼šæš‚æ—¶åœæ­¢å¯¹ AOF æ–‡ä»¶è¿›è¡ŒåŒæ­¥ï¼Œä»è€Œå°½å¯èƒ½åœ°å‡å°‘ I/O é˜»å¡</li>
<li>é€‰é¡¹æ‰“å¼€æ—¶è¿è¡Œåœ¨ always æ¨¡å¼çš„ AOF æŒä¹…åŒ–ï¼Œäº‹åŠ¡ä¹Ÿä¸å…·æœ‰æŒä¹…æ€§ï¼Œæ‰€ä»¥è¯¥é€‰é¡¹é»˜è®¤å…³é—­</li>
</ul>
<p>åœ¨ä¸€ä¸ªäº‹åŠ¡çš„æœ€ååŠ ä¸Š SAVE å‘½ä»¤æ€»å¯ä»¥ä¿è¯äº‹åŠ¡çš„è€ä¹…æ€§</p>
<hr>
<h2 id="Lua-è„šæœ¬">Lua è„šæœ¬</h2>
<h3 id="ç¯å¢ƒåˆ›å»º">ç¯å¢ƒåˆ›å»º</h3>
<h4 id="åŸºæœ¬ä»‹ç»-6">åŸºæœ¬ä»‹ç»</h4>
<p>Redis å¯¹ Lua è„šæœ¬æ”¯æŒï¼Œé€šè¿‡åœ¨æœåŠ¡å™¨ä¸­åµŒå…¥ Lua ç¯å¢ƒï¼Œå®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨ Lua è„šæœ¬ç›´æ¥åœ¨æœåŠ¡å™¨ç«¯<strong>åŸå­åœ°æ‰§è¡Œ</strong>å¤šä¸ªå‘½ä»¤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EVAL &lt;script&gt; &lt;numkeys&gt; [key ...] [arg ...]</span><br><span class="line">EVALSHA &lt;sha1&gt; &lt;numkeys&gt; [key ...] [arg ...]</span><br></pre></td></tr></table></figure>
<p>EVAL å‘½ä»¤å¯ä»¥ç›´æ¥å¯¹è¾“å…¥çš„è„šæœ¬è®¡ç®—ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; EVAL <span class="string">&quot;return 1 + 1&quot;</span> 0	<span class="comment"># 0ä»£è¡¨éœ€è¦çš„å‚æ•°</span></span><br><span class="line">(<span class="built_in">integer</span>) 2 </span><br></pre></td></tr></table></figure>
<p>EVALSHA å‘½ä»¤æ ¹æ®è„šæœ¬çš„ SHA1 æ ¡éªŒå’Œæ¥å¯¹è„šæœ¬è®¡ç®—ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; EVALSHA <span class="string">&quot;2f3lba2bb6d6a0f42ccl59d2e2dad55440778de3&quot;</span> 0</span><br><span class="line">(<span class="built_in">integer</span>) 2 </span><br></pre></td></tr></table></figure>
<p>åº”ç”¨åœºæ™¯ï¼šRedis åªä¿è¯å•æ¡å‘½ä»¤çš„åŸå­æ€§ï¼Œæ‰€ä»¥ä¸ºäº†å®ç°åŸå­æ“ä½œï¼Œå°†å¤šæ¡çš„å¯¹ Redis çš„æ“ä½œæ•´åˆåˆ°ä¸€ä¸ªè„šæœ¬é‡Œï¼Œä½†æ˜¯é¿å…æŠŠä¸éœ€è¦åšå¹¶å‘æ§åˆ¶çš„æ“ä½œå†™å…¥è„šæœ¬ä¸­</p>
<p>Lua è¯­æ³•ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å£°æ˜å˜é‡çš„æ—¶å€™æ— éœ€æŒ‡å®šæ•°æ®ç±»å‹ï¼Œè€Œæ˜¯ç”¨ local æ¥å£°æ˜å˜é‡ä¸ºå±€éƒ¨å˜é‡</li>
<li>æ•°ç»„ä¸‹æ ‡æ˜¯ä» 1 å¼€å§‹</li>
</ul>
<hr>
<h4 id="åˆ›å»ºè¿‡ç¨‹">åˆ›å»ºè¿‡ç¨‹</h4>
<p>Redis æœåŠ¡å™¨åˆ›å»ºå¹¶ä¿®æ”¹ Lua ç¯å¢ƒçš„æ•´ä¸ªè¿‡ç¨‹ï¼š</p>
<ul>
<li>
<p>åˆ›å»ºä¸€ä¸ªåŸºç¡€çš„ Lua ç¯å¢ƒï¼Œè°ƒç”¨ Lua çš„ API å‡½æ•° lua_open</p>
</li>
<li>
<p>è½½å…¥å¤šä¸ªå‡½æ•°åº“åˆ° Lua ç¯å¢ƒé‡Œé¢ï¼Œè®© Lua è„šæœ¬å¯ä»¥ä½¿ç”¨è¿™äº›å‡½æ•°åº“æ¥è¿›è¡Œæ•°æ®æ“ä½œï¼ŒåŒ…æ‹¬åŸºç¡€æ ¸å¿ƒå‡½æ•°</p>
</li>
<li>
<p>åˆ›å»ºå…¨å±€å˜é‡ redis è¡¨æ ¼ï¼Œè¡¨æ ¼åŒ…å«ä»¥ä¸‹å‡½æ•°ï¼š</p>
<ul>
<li>æ‰§è¡Œ Redis å‘½ä»¤çš„ redis.call å’Œ redis.pcall å‡½æ•°</li>
<li>è®°å½• Redis æ—¥å¿—çš„ redis.log å‡½æ•°ï¼Œä»¥åŠç›¸åº”çš„æ—¥å¿—çº§åˆ« (level) å¸¸é‡ redis.LOG_DEBUG ç­‰</li>
<li>è®¡ç®— SHAl æ ¡éªŒå’Œçš„ redis.shalhex å‡½æ•°</li>
<li>è¿”å›é”™è¯¯ä¿¡æ¯çš„ redis.error_reply å‡½æ•°å’Œ redis.status_reply å‡½æ•°</li>
</ul>
</li>
<li>
<p>ä½¿ç”¨ Redis è‡ªåˆ¶çš„éšæœºå‡½æ•°æ¥æ›¿æ¢ Lua åŸæœ‰çš„å¸¦æœ‰å‰¯ä½œç”¨çš„éšæœºå‡½æ•°ï¼Œä»è€Œé¿å…åœ¨è„šæœ¬ä¸­å¼•å…¥å‰¯ä½œç”¨</p>
<p>Redis è¦æ±‚æ‰€æœ‰ä¼ å…¥æœåŠ¡å™¨çš„ Lua è„šæœ¬ï¼Œä»¥åŠ Lua ç¯å¢ƒä¸­çš„æ‰€æœ‰å‡½æ•°ï¼Œéƒ½å¿…é¡»æ˜¯æ— å‰¯ä½œç”¨ï¼ˆside effectï¼‰çš„çº¯å‡½æ•°ï¼ˆpure functionï¼‰ï¼Œæ‰€ä»¥å¯¹æœ‰å‰¯ä½œç”¨çš„éšæœºå‡½æ•° <code>math.random</code> å’Œ <code>math.randornseed</code> è¿›è¡Œæ›¿æ¢</p>
</li>
<li>
<p>åˆ›å»ºæ’åºè¾…åŠ©å‡½æ•° <code> _redis_compare_helper</code>ï¼Œä½¿ç”¨è¾…åŠ©å‡½æ•°æ¥å¯¹ä¸€éƒ¨åˆ† Redis å‘½ä»¤çš„ç»“æœè¿›è¡Œæ’åºï¼Œä»è€Œæ¶ˆé™¤å‘½ä»¤çš„ä¸ç¡®å®šæ€§</p>
<p>æ¯”å¦‚é›†åˆå…ƒç´ çš„æ’åˆ—æ˜¯æ— åºçš„ï¼Œ æ‰€ä»¥å³ä½¿ä¸¤ä¸ªé›†åˆçš„å…ƒç´ å®Œå…¨ç›¸åŒï¼Œè¾“å‡ºç»“æœä¹Ÿä¸ä¸€å®šç›¸åŒï¼ŒRedis å°† SMEMBERS è¿™ç±»åœ¨ç›¸åŒæ•°æ®é›†ä¸Šäº§ç”Ÿä¸åŒè¾“å‡ºçš„å‘½ä»¤ç§°ä¸ºå¸¦æœ‰ä¸ç¡®å®šæ€§çš„å‘½ä»¤</p>
</li>
<li>
<p>åˆ›å»º redis.pcall å‡½æ•°çš„é”™è¯¯æŠ¥å‘Šè¾…åŠ©å‡½æ•° <code>_redis_err_handler </code>ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥æ‰“å°å‡ºé”™ä»£ç çš„æ¥æºå’Œå‘ç”Ÿé”™è¯¯çš„è¡Œæ•°</p>
</li>
<li>
<p>å¯¹ Lua ç¯å¢ƒä¸­çš„å…¨å±€ç¯å¢ƒè¿›è¡Œä¿æŠ¤ï¼Œç¡®ä¿ä¼ å…¥æœåŠ¡å™¨çš„è„šæœ¬ä¸ä¼šå› å¿˜è®°ä½¿ç”¨ local å…³é”®å­—ï¼Œè€Œå°†é¢å¤–çš„å…¨å±€å˜é‡æ·»åŠ åˆ° Lua ç¯å¢ƒ</p>
</li>
<li>
<p>å°†å®Œæˆä¿®æ”¹çš„ Lua ç¯å¢ƒä¿å­˜åˆ°æœåŠ¡å™¨çŠ¶æ€çš„ lua å±æ€§ä¸­ï¼Œç­‰å¾…æ‰§è¡ŒæœåŠ¡å™¨ä¼ æ¥çš„ Lua è„šæœ¬</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    Lua *lua;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Redis ä½¿ç”¨ä¸²è¡ŒåŒ–çš„æ–¹å¼æ¥æ‰§è¡Œ Redis å‘½ä»¤ï¼Œæ‰€ä»¥åœ¨ä»»ä½•æ—¶é—´é‡Œæœ€å¤šéƒ½åªä¼šæœ‰ä¸€ä¸ªè„šæœ¬èƒ½å¤Ÿè¢«æ”¾è¿› Lua ç¯å¢ƒé‡Œé¢è¿è¡Œï¼Œå› æ­¤æ•´ä¸ª Redis æœåŠ¡å™¨åªéœ€è¦åˆ›å»ºä¸€ä¸ª Lua ç¯å¢ƒå³å¯</p>
<hr>
<h3 id="åä½œç»„ä»¶">åä½œç»„ä»¶</h3>
<h4 id="ä¼ªå®¢æˆ·ç«¯">ä¼ªå®¢æˆ·ç«¯</h4>
<p>Redis æœåŠ¡å™¨ä¸º Lua ç¯å¢ƒåˆ›å»ºäº†ä¸€ä¸ªä¼ªå®¢æˆ·ç«¯è´Ÿè´£å¤„ç† Lua è„šæœ¬ä¸­åŒ…å«çš„æ‰€æœ‰ Redis å‘½ä»¤ï¼Œå·¥ä½œæµç¨‹ï¼š</p>
<ul>
<li>Lua ç¯å¢ƒå°† redis.call æˆ–è€… redis.pcall å‡½æ•°æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤ä¼ ç»™ä¼ªå®¢æˆ·ç«¯</li>
<li>ä¼ªå®¢æˆ·ç«¯å°†å‘½ä»¤ä¼ ç»™å‘½ä»¤æ‰§è¡Œå™¨</li>
<li>å‘½ä»¤æ‰§è¡Œå™¨æ‰§è¡Œå‘½ä»¤å¹¶å°†å‘½ä»¤çš„æ‰§è¡Œç»“æœè¿”å›ç»™ä¼ªå®¢æˆ·ç«¯</li>
<li>ä¼ªå®¢æˆ·ç«¯æ¥æ”¶å‘½ä»¤æ‰§è¡Œå™¨è¿”å›çš„å‘½ä»¤ç»“æœï¼Œå¹¶å°†ç»“æœè¿”å›ç»™ Lua ç¯å¢ƒ</li>
<li>Lua å°†å‘½ä»¤ç»“æœè¿”å›ç»™ redis.call å‡½æ•°æˆ–è€… redis.pcall å‡½æ•°</li>
<li>redis.call å‡½æ•°æˆ–è€… redis.pcall å‡½æ•°ä¼šå°†å‘½ä»¤ç»“æœä½œä¸ºè¿”å›å€¼è¿”å›ç»™è„šæœ¬çš„è°ƒç”¨è€…</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-Lua%E4%BC%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%89%A7%E8%A1%8C.png" alt=""></p>
<hr>
<h4 id="è„šæœ¬å­—å…¸">è„šæœ¬å­—å…¸</h4>
<p>Redis æœåŠ¡å™¨ä¸º Lua ç¯å¢ƒåˆ›å»º lua_scripts å­—å…¸ï¼Œé”®ä¸ºæŸä¸ª Lua è„šæœ¬çš„ SHA1 æ ¡éªŒå’Œï¼ˆchecksumï¼‰ï¼Œå€¼åˆ™æ˜¯æ ¡éªŒå’Œå¯¹åº”çš„ Lua è„šæœ¬</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    dict *lua_scripts;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æœåŠ¡å™¨ä¼šå°†æ‰€æœ‰è¢« EVAL å‘½ä»¤æ‰§è¡Œè¿‡çš„ Lua è„šæœ¬ï¼Œä»¥åŠæ‰€æœ‰è¢« SCRIPT LOAD å‘½ä»¤è½½å…¥è¿‡çš„ Lua è„šæœ¬éƒ½ä¿å­˜åˆ° lua_scripts å­—å…¸</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; SCRIPT LOAD <span class="string">&quot;return &#x27;hi&#x27;&quot;</span></span><br><span class="line"><span class="string">&quot;2f3lba2bb6d6a0f42ccl59d2e2dad55440778de3&quot;</span> <span class="comment"># å­—å…¸çš„é”®ï¼ŒSHA1 æ ¡éªŒå’Œ</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="å‘½ä»¤å®ç°-2">å‘½ä»¤å®ç°</h3>
<h4 id="è„šæœ¬å‡½æ•°">è„šæœ¬å‡½æ•°</h4>
<p>EVAL å‘½ä»¤çš„æ‰§è¡Œçš„ç¬¬ä¸€æ­¥æ˜¯ä¸ºä¼ å…¥çš„è„šæœ¬å®šä¹‰ä¸€ä¸ªç›¸å¯¹åº”çš„ Lua å‡½æ•°ï¼ŒLua å‡½æ•°çš„åå­—ç”± f_ å‰ç¼€åŠ ä¸Šè„šæœ¬çš„ SHA1 æ ¡éªŒå’Œï¼ˆå››åä¸ªå­—ç¬¦é•¿ï¼‰ç»„æˆï¼Œè€Œå‡½æ•°çš„ä½“ï¼ˆbodyï¼‰åˆ™æ˜¯è„šæœ¬æœ¬èº«</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">EVAL <span class="string">&quot;return &#x27;hello world&#x27;&quot;</span> 0 </span><br><span class="line"><span class="comment"># å‘½ä»¤å°†ä¼šå®šä¹‰ä»¥ä¸‹çš„å‡½æ•°</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">f_533203lc6b470dc5a0dd9b4bf2030dea6d65de91</span></span>() &#123;</span><br><span class="line">	<span class="built_in">return</span> <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨å‡½æ•°æ¥ä¿å­˜å®¢æˆ·ç«¯ä¼ å…¥çš„è„šæœ¬æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p>
<ul>
<li>é€šè¿‡å‡½æ•°çš„å±€éƒ¨æ€§æ¥è®© Lua ç¯å¢ƒä¿æŒæ¸…æ´ï¼Œå‡å°‘äº†åƒåœ¾å›æ”¶çš„å·¥ä½œæœ€ï¼Œ å¹¶ä¸”é¿å…äº†ä½¿ç”¨å…¨å±€å˜é‡</li>
<li>å¦‚æœæŸä¸ªè„šæœ¬åœ¨ Lua ç¯å¢ƒä¸­è¢«å®šä¹‰è¿‡è‡³å°‘ä¸€æ¬¡ï¼Œé‚£ä¹ˆåªéœ€è¦ SHA1 æ ¡éªŒå’Œï¼ŒæœåŠ¡å™¨å°±å¯ä»¥åœ¨ä¸çŸ¥é“è„šæœ¬æœ¬èº«çš„æƒ…å†µä¸‹ï¼Œç›´æ¥é€šè¿‡è°ƒç”¨ Lua å‡½æ•°æ¥æ‰§è¡Œè„šæœ¬</li>
</ul>
<p>EVAL å‘½ä»¤ç¬¬äºŒæ­¥æ˜¯å°†å®¢æˆ·ç«¯ä¼ å…¥çš„è„šæœ¬ä¿å­˜åˆ°æœåŠ¡å™¨çš„ lua_scripts å­—å…¸é‡Œï¼Œåœ¨å­—å…¸ä¸­æ–°æ·»åŠ ä¸€ä¸ªé”®å€¼å¯¹</p>
<hr>
<h4 id="æ‰§è¡Œå‡½æ•°">æ‰§è¡Œå‡½æ•°</h4>
<p>EVAL å‘½ä»¤ç¬¬ä¸‰æ­¥æ˜¯æ‰§è¡Œè„šæœ¬å‡½æ•°</p>
<ul>
<li>
<p>å°† EVAL å‘½ä»¤ä¸­ä¼ å…¥çš„<strong>é”®åå‚æ•°å’Œè„šæœ¬å‚æ•°</strong>åˆ†åˆ«ä¿å­˜åˆ° KEYS æ•°ç»„å’Œ ARGV æ•°ç»„ï¼Œå°†è¿™ä¸¤ä¸ªæ•°ç»„ä½œä¸º<strong>å…¨å±€å˜é‡</strong>ä¼ å…¥åˆ° Lua ç¯å¢ƒ</p>
</li>
<li>
<p>ä¸º Lua ç¯å¢ƒè£…è½½è¶…æ—¶å¤„ç†é’©å­ï¼ˆhookï¼‰ï¼Œè¿™ä¸ªé’©å­å¯ä»¥åœ¨è„šæœ¬å‡ºç°è¶…æ—¶è¿è¡Œæƒ…å†µæ—¶ï¼Œè®©å®¢æˆ·ç«¯é€šè¿‡ <code>SCRIPT KILL</code> å‘½ä»¤åœæ­¢è„šæœ¬ï¼Œæˆ–è€…é€šè¿‡ SHUTDOWN å‘½ä»¤ç›´æ¥å…³é—­æœåŠ¡å™¨</p>
<p>å› ä¸º Redis æ˜¯å•çº¿ç¨‹çš„æ‰§è¡Œå‘½ä»¤ï¼Œå½“ Lua è„šæœ¬é˜»å¡æ—¶éœ€è¦å…œåº•ç­–ç•¥ï¼Œå¯ä»¥ä¸­æ–­æ‰§è¡Œ</p>
</li>
<li>
<p>æ‰§è¡Œè„šæœ¬å‡½æ•°</p>
</li>
<li>
<p>ç§»é™¤ä¹‹å‰è£…è½½çš„è¶…æ—¶é’©å­</p>
</li>
<li>
<p>å°†æ‰§è¡Œè„šæœ¬å‡½æ•°çš„ç»“æœä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å‡ºç¼“å†²åŒºé‡Œï¼Œç­‰å¾…æœåŠ¡å™¨å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯</p>
</li>
</ul>
<hr>
<h4 id="EVALSHA">EVALSHA</h4>
<p>EVALSHA å‘½ä»¤çš„å®ç°åŸç†å°±æ˜¯æ ¹æ®è„šæœ¬çš„ SHA1 æ ¡éªŒå’Œæ¥è°ƒç”¨<strong>è„šæœ¬å¯¹åº”çš„å‡½æ•°</strong>ï¼Œå¦‚æœå‡½æ•°åœ¨ Lua ç¯å¢ƒä¸­ä¸å­˜åœ¨ï¼Œæ‰¾ä¸åˆ° f_ å¼€å¤´çš„å‡½æ•°ï¼Œå°±ä¼šè¿”å› <code>SCRIPT NOT FOUND</code></p>
<hr>
<h3 id="ç®¡ç†å‘½ä»¤">ç®¡ç†å‘½ä»¤</h3>
<p>Redis ä¸­ä¸ Lua è„šæœ¬æœ‰å…³çš„ç®¡ç†å‘½ä»¤æœ‰å››ä¸ªï¼š</p>
<ul>
<li>
<p>SCRIPT FLUSHï¼šç”¨äºæ¸…é™¤æœåŠ¡å™¨ä¸­æ‰€æœ‰å’Œ Lua è„šæœ¬æœ‰å…³çš„ä¿¡æ¯ï¼Œä¼šé‡Šæ”¾å¹¶é‡å»º lua_scripts å­—å…¸ï¼Œå…³é—­ç°æœ‰çš„ Lua ç¯å¢ƒå¹¶é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ Lua ç¯å¢ƒ</p>
</li>
<li>
<p>SCRIPT EXISTSï¼šæ ¹æ®è¾“å…¥çš„ SHA1 æ ¡éªŒå’Œï¼ˆå…è®¸ä¸€æ¬¡ä¼ å…¥å¤šä¸ªæ ¡éªŒå’Œï¼‰ï¼Œæ£€æŸ¥æ ¡éªŒå’Œå¯¹åº”çš„è„šæœ¬æ˜¯å¦å­˜åœ¨äºæœåŠ¡å™¨ä¸­ï¼Œé€šè¿‡æ£€æŸ¥ lua_scripts å­—å…¸å®ç°</p>
</li>
<li>
<p>SCRIPT LOADï¼šåœ¨ Lua ç¯å¢ƒä¸­ä¸ºè„šæœ¬åˆ›å»ºç›¸å¯¹åº”çš„å‡½æ•°ï¼Œç„¶åå°†è„šæœ¬ä¿å­˜åˆ° lua_scriptså­—å…¸é‡Œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; SCRIPT LOAD <span class="string">&quot;return &#x27;hi&#x27;&quot;</span></span><br><span class="line"><span class="string">&quot;2f3lba2bb6d6a0f42ccl59d2e2dad55440778de3&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>SCRIPT KILLï¼šåœæ­¢è„šæœ¬</p>
</li>
</ul>
<p>å¦‚æœæœåŠ¡å™¨é…ç½®äº† lua-time-liÂ­mit é€‰é¡¹ï¼Œé‚£ä¹ˆåœ¨æ¯æ¬¡æ‰§è¡Œ Lua è„šæœ¬ä¹‹å‰ï¼Œéƒ½ä¼šè®¾ç½®ä¸€ä¸ªè¶…æ—¶å¤„ç†çš„é’©å­ã€‚é’©å­ä¼šåœ¨è„šæœ¬è¿è¡ŒæœŸé—´ä¼šå®šæœŸæ£€æŸ¥è¿è¡Œæ—¶é—´æ˜¯å¦è¶…è¿‡é…ç½®æ—¶é—´ï¼Œå¦‚æœè¶…æ—¶é’©å­å°†å®šæœŸåœ¨è„šæœ¬è¿è¡Œçš„é—´éš™ä¸­ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ SCRIPT KILL æˆ–è€… SHUTDOWN åˆ°è¾¾ï¼š</p>
<ul>
<li>å¦‚æœè¶…æ—¶è¿è¡Œçš„è„šæœ¬æ²¡æœ‰æ‰§è¡Œè¿‡å†™å…¥æ“ä½œï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ SCRIPT KILL æ¥åœæ­¢è¿™ä¸ªè„šæœ¬</li>
<li>å¦‚æœæ‰§è¡Œè¿‡å†™å…¥æ“ä½œï¼Œå®¢æˆ·ç«¯åªèƒ½ç”¨ SHUTDOWN nosave å‘½ä»¤æ¥åœæ­¢æœåŠ¡å™¨ï¼Œé˜²æ­¢ä¸åˆæ³•çš„æ•°æ®è¢«å†™å…¥æ•°æ®åº“ä¸­</li>
</ul>
<hr>
<h3 id="è„šæœ¬å¤åˆ¶">è„šæœ¬å¤åˆ¶</h3>
<h4 id="å‘½ä»¤å¤åˆ¶">å‘½ä»¤å¤åˆ¶</h4>
<p>å½“æœåŠ¡å™¨è¿è¡Œåœ¨å¤åˆ¶æ¨¡å¼æ—¶ï¼Œå…·æœ‰å†™æ€§è´¨çš„è„šæœ¬å‘½ä»¤ä¹Ÿä¼šè¢«å¤åˆ¶åˆ°ä»æœåŠ¡å™¨ï¼ŒåŒ…æ‹¬ EVALã€EVALSHAã€SCRIPT FLUSHï¼Œä»¥åŠ SCRIPT LOAD å‘½ä»¤</p>
<p>Redis å¤åˆ¶ EVALã€SCRIPT FLUSHã€SCRIPT LOAD ä¸‰ä¸ªå‘½ä»¤çš„æ–¹æ³•å’Œå¤åˆ¶æ™®é€š Redis å‘½ä»¤çš„æ–¹æ³•ä¸€æ ·ï¼Œå½“ä¸»æœåŠ¡å™¨æ‰§è¡Œå®Œä»¥ä¸Šä¸‰ä¸ªå‘½ä»¤çš„å…¶ä¸­ä¸€ä¸ªæ—¶ï¼Œä¼šç›´æ¥å°†è¢«æ‰§è¡Œçš„å‘½ä»¤ä¼ æ’­ï¼ˆpropagateï¼‰ç»™æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œåœ¨ä»æœåŠ¡å™¨ä¸­äº§ç”Ÿç›¸åŒçš„æ•ˆæœ</p>
<hr>
<h4 id="EVALSHA-2">EVALSHA</h4>
<p>EVALSHA å‘½ä»¤çš„å¤åˆ¶æ“ä½œç›¸å¯¹å¤æ‚ï¼Œå› ä¸ºå¤šä¸ªä»æœåŠ¡å™¨ä¹‹é—´è½½å…¥ Lua è„šæœ¬çš„æ¸…å†µå„æœ‰ä¸åŒï¼Œä¸€ä¸ªåœ¨ä¸»æœåŠ¡å™¨è¢«æˆåŠŸæ‰§è¡Œçš„ EVALSHA å‘½ä»¤ï¼Œåœ¨ä»æœåŠ¡å™¨æ‰§è¡Œæ—¶å¯èƒ½ä¼šå‡ºç°è„šæœ¬æœªæ‰¾åˆ°ï¼ˆnot foundï¼‰é”™è¯¯</p>
<p>Redis è¦æ±‚ä¸»æœåŠ¡å™¨åœ¨ä¼ æ’­ EVALSHA å‘½ä»¤æ—¶ï¼Œå¿…é¡»ç¡®ä¿ EVALSHA å‘½ä»¤è¦æ‰§è¡Œçš„è„šæœ¬å·²ç»è¢«æ‰€æœ‰ä»æœåŠ¡å™¨è½½å…¥è¿‡ï¼Œå¦‚æœä¸èƒ½ç¡®ä¿ä¸»æœåŠ¡å™¨ä¼š<strong>å°† EVALSHA å‘½ä»¤è½¬æ¢æˆä¸€ä¸ªç­‰ä»·çš„ EVAL å‘½ä»¤</strong>ï¼Œç„¶åé€šè¿‡ä¼ æ’­ EVAL å‘½ä»¤æ¥ä»£æ›¿ EVALSHA å‘½ä»¤</p>
<p>ä¸»æœåŠ¡å™¨ä½¿ç”¨æœåŠ¡å™¨çŠ¶æ€çš„ repl_scriptcache_dict å­—å…¸è®°å½•å·²ç»å°†å“ªäº›è„šæœ¬ä¼ æ’­ç»™äº†<strong>æ‰€æœ‰ä»æœåŠ¡å™¨</strong>ï¼Œå½“ä¸€ä¸ªæ ¡éªŒå’Œå‡ºç°åœ¨å­—å…¸æ—¶ï¼Œè¯´æ˜æ ¡éªŒå’Œå¯¹åº”çš„ Lua è„šæœ¬å·²ç»ä¼ æ’­ç»™äº†æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨å¯ä»¥ç›´æ¥ä¼ æ’­ EVALSHA å‘½ä»¤</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="comment">// é”®æ˜¯ä¸€ä¸ªä¸ª Lua è„šæœ¬çš„ SHA1 æ ¡éªŒå’Œï¼Œå€¼åˆ™å…¨éƒ¨éƒ½æ˜¯ NULL</span></span><br><span class="line">    dict *repl_scriptcache_dict;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šæ¯å½“ä¸»æœåŠ¡å™¨æ·»åŠ ä¸€ä¸ªæ–°çš„ä»æœåŠ¡å™¨æ—¶ï¼Œéƒ½ä¼šæ¸…ç©º repl_scriptcache_dict å­—å…¸ï¼Œå› ä¸ºå­—å…¸é‡Œé¢è®°å½•çš„è„šæœ¬å·²ç»ä¸å†è¢«æ‰€æœ‰ä»æœåŠ¡å™¨è½½å…¥è¿‡ï¼Œæ‰€ä»¥æœåŠ¡å™¨ä»¥æ¸…ç©ºå­—å…¸çš„æ–¹å¼ï¼Œå¼ºåˆ¶é‡æ–°å‘æ‰€æœ‰ä»æœåŠ¡å™¨ä¼ æ’­è„šæœ¬</p>
<p>é€šè¿‡ä½¿ç”¨ EVALSHA å‘½ä»¤æŒ‡å®šçš„ SHA1 æ ¡éªŒå’Œï¼Œä»¥åŠ lua_scripts å­—å…¸ä¿å­˜çš„ Lua è„šæœ¬ï¼Œå¯ä»¥å°†ä¸€ä¸ª EVALSHA å‘½ä»¤è½¬åŒ–ä¸º EVAL å‘½ä»¤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EVALSHA <span class="string">&quot;533203lc6b470dc5a0dd9b4bf2030dea6d65de91&quot;</span> 0 </span><br><span class="line"><span class="comment"># -&gt; è½¬æ¢</span></span><br><span class="line">EVAL <span class="string">&quot;return&#x27;hello world&#x27;&quot;</span> 0 </span><br></pre></td></tr></table></figure>
<p>è„šæœ¬å†…å®¹ <code>&quot;return'hello world'&quot;</code> æ¥æºäº lua_scripts å­—å…¸ 533203lc6b470dc5a0dd9b4bf2030dea6d65de91 é”®çš„å€¼</p>
<hr>
<h2 id="åˆ†å¸ƒå¼é”">åˆ†å¸ƒå¼é”</h2>
<h3 id="åŸºæœ¬æ“ä½œ-2">åŸºæœ¬æ“ä½œ</h3>
<p>åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œé”å˜é‡éœ€è¦ç”±ä¸€ä¸ªå…±äº«å­˜å‚¨ç³»ç»Ÿæ¥ç»´æŠ¤ï¼Œå¤šä¸ªå®¢æˆ·ç«¯æ‰å¯ä»¥é€šè¿‡è®¿é—®å…±äº«å­˜å‚¨ç³»ç»Ÿæ¥è®¿é—®é”å˜é‡ï¼ŒåŠ é”å’Œé‡Šæ”¾é”çš„æ“ä½œå°±å˜æˆäº†è¯»å–ã€åˆ¤æ–­å’Œè®¾ç½®å…±äº«å­˜å‚¨ç³»ç»Ÿä¸­çš„é”å˜é‡å€¼å¤šæ­¥æ“ä½œ</p>
<p>Redis åˆ†å¸ƒå¼é”çš„åŸºæœ¬ä½¿ç”¨ï¼Œæ‚²è§‚é”</p>
<ul>
<li>
<p>ä½¿ç”¨ SETNX è®¾ç½®ä¸€ä¸ªå…¬å…±é”</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SETNX lock-key value	<span class="comment"># valueä»»æ„æ•°ï¼Œè¿”å›ä¸º1è®¾ç½®æˆåŠŸï¼Œè¿”å›ä¸º0è®¾ç½®å¤±è´¥</span></span><br></pre></td></tr></table></figure>
<p><code>NX</code>ï¼šåªåœ¨é”®ä¸å­˜åœ¨æ—¶ï¼Œæ‰å¯¹é”®è¿›è¡Œè®¾ç½®æ“ä½œï¼Œ<code>SET key value NX</code> æ•ˆæœç­‰åŒäº <code>SETNX key value</code></p>
<p><code>XX</code>ï¼šåªåœ¨é”®å·²ç»å­˜åœ¨æ—¶ï¼Œæ‰å¯¹é”®è¿›è¡Œè®¾ç½®æ“ä½œ</p>
<p><code>EX</code>ï¼šè®¾ç½®é”® key çš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ—¶ç§’</p>
<p><code>PX</code>ï¼šè®¾ç½®é”® key çš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ—¶æ¯«ç§’</p>
<p>è¯´æ˜ï¼šç”±äº <code>SET</code> å‘½ä»¤åŠ ä¸Šé€‰é¡¹å·²ç»å¯ä»¥å®Œå…¨å–ä»£ SETNXã€SETEXã€PSETEX çš„åŠŸèƒ½ï¼ŒRedis ä¸æ¨èä½¿ç”¨è¿™å‡ ä¸ªå‘½ä»¤</p>
</li>
<li>
<p>æ“ä½œå®Œæ¯•é€šè¿‡ DEL æ“ä½œé‡Šæ”¾é”</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEL lock-key </span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½¿ç”¨ EXPIRE ä¸ºé” key æ·»åŠ å­˜æ´»ï¼ˆæŒæœ‰ï¼‰æ—¶é—´ï¼Œè¿‡æœŸè‡ªåŠ¨åˆ é™¤ï¼ˆæ”¾å¼ƒï¼‰é”ï¼Œé˜²æ­¢çº¿ç¨‹å‡ºç°å¼‚å¸¸ï¼Œæ— æ³•é‡Šæ”¾é”</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EXPIRE lock-key second </span><br><span class="line">PEXPIRE lock-key milliseconds</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ EXPIRE è®¾ç½®è¿‡æœŸæ—¶é—´ç¼ºä¹åŸå­æ€§ï¼Œå¦‚æœåœ¨ SETNX å’Œ EXPIRE ä¹‹é—´å‡ºç°å¼‚å¸¸ï¼Œé”ä¹Ÿæ— æ³•é‡Šæ”¾</p>
</li>
<li>
<p>åœ¨ SET æ—¶æŒ‡å®šè¿‡æœŸæ—¶é—´ï¼Œä¿è¯åŸå­æ€§</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET key value NX [EX seconds | PX milliseconds]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="é˜²è¯¯åˆ ">é˜²è¯¯åˆ </h3>
<p>åœºæ™¯æè¿°ï¼šçº¿ç¨‹ A æ­£åœ¨æ‰§è¡Œï¼Œä½†æ˜¯ä¸šåŠ¡é˜»å¡ï¼Œåœ¨é”çš„è¿‡æœŸæ—¶é—´å†…æœªæ‰§è¡Œå®Œæˆï¼Œè¿‡æœŸåˆ é™¤åçº¿ç¨‹ B é‡æ–°è·å–åˆ°é”ï¼Œæ­¤æ—¶çº¿ç¨‹ A æ‰§è¡Œå®Œæˆï¼Œåˆ é™¤é”ï¼Œå¯¼è‡´çº¿ç¨‹ B çš„é”è¢«çº¿ç¨‹ A è¯¯åˆ </p>
<p>SETNX è·å–é”æ—¶ï¼Œè®¾ç½®ä¸€ä¸ªæŒ‡å®šçš„å”¯ä¸€å€¼ï¼ˆUUIDï¼‰ï¼Œé‡Šæ”¾å‰è·å–è¿™ä¸ªå€¼ï¼Œåˆ¤æ–­æ˜¯å¦è‡ªå·±çš„é”ï¼Œé˜²æ­¢å‡ºç°çº¿ç¨‹ä¹‹é—´è¯¯åˆ äº†å…¶ä»–çº¿ç¨‹çš„é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŠ é”, unique_valueä½œä¸ºå®¢æˆ·ç«¯å”¯ä¸€æ€§çš„æ ‡è¯†ï¼Œ</span></span><br><span class="line"><span class="comment">// PX 10000 åˆ™è¡¨ç¤º lock_key ä¼šåœ¨ 10s åè¿‡æœŸï¼Œä»¥å…å®¢æˆ·ç«¯åœ¨è¿™æœŸé—´å‘ç”Ÿå¼‚å¸¸è€Œæ— æ³•é‡Šæ”¾é”</span></span><br><span class="line">SET lock_key unique_value NX PX <span class="number">10000</span></span><br></pre></td></tr></table></figure>
<p>Lua è„šæœ¬ï¼ˆunlock.scriptï¼‰å®ç°çš„é‡Šæ”¾é”æ“ä½œçš„ä¼ªä»£ç ï¼škey ç±»å‹å‚æ•°ä¼šæ”¾å…¥ KEYS æ•°ç»„ï¼Œå…¶å®ƒå‚æ•°ä¼šæ”¾å…¥ ARGV æ•°ç»„ï¼Œåœ¨è„šæœ¬ä¸­é€šè¿‡ KEYS å’Œ ARGV ä¼ é€’å‚æ•°ï¼Œ<strong>ä¿è¯åˆ¤æ–­æ ‡è¯†å’Œé‡Šæ”¾é”è¿™ä¸¤ä¸ªæ“ä½œçš„åŸå­æ€§</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EVAL <span class="string">&quot;return redis.call(&#x27;set&#x27;, KEYS[1], ARGV[1])&quot;</span> 1 lock_key unique_value <span class="comment"># 1 ä»£è¡¨éœ€è¦ä¸€ä¸ªå‚æ•°</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é‡Šæ”¾é”ï¼ŒKEYS[1] å°±æ˜¯é”çš„ keyï¼ŒARGV[1] å°±æ˜¯æ ‡è¯†å€¼ï¼Œé¿å…è¯¯é‡Šæ”¾</span></span><br><span class="line"><span class="comment">// è·å–æ ‡è¯†å€¼ï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´</span></span><br><span class="line"><span class="keyword">if</span> redis.call(<span class="string">&quot;get&quot;</span>, KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>] then</span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">&quot;del&quot;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="ä¼˜åŒ–é”">ä¼˜åŒ–é”</h3>
<h4 id="ä¸å¯é‡å…¥">ä¸å¯é‡å…¥</h4>
<p>ä¸å¯é‡å…¥ï¼šåŒä¸€ä¸ªçº¿ç¨‹æ— æ³•å¤šæ¬¡è·å–åŒä¸€æŠŠé”</p>
<p>ä½¿ç”¨ hash é”®ï¼Œfiled æ˜¯åŠ é”çš„çº¿ç¨‹æ ‡è¯†ï¼Œ value æ˜¯<strong>é”é‡å…¥æ¬¡æ•°</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">|</span>    key    <span class="operator">|</span>       <span class="keyword">value</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="operator">|</span>  filed  <span class="operator">|</span>  <span class="keyword">value</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="comment">-------------------------------|</span></span><br><span class="line"><span class="operator">|</span>  lock_key <span class="operator">|</span> thread1 <span class="operator">|</span>    <span class="number">1</span>    <span class="operator">|</span></span><br></pre></td></tr></table></figure>
<p>é”é‡å…¥ï¼š</p>
<ul>
<li>åŠ é”æ—¶åˆ¤æ–­é”çš„ filed å±æ€§æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯å°† value åŠ  1</li>
<li>è§£é”æ—¶åˆ¤æ–­é”çš„ filed å±æ€§æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Œé¦–å…ˆå°† value å‡ä¸€ï¼Œå¦‚æœ value ä¸º 0 ç›´æ¥é‡Šæ”¾é”</li>
</ul>
<p>ä½¿ç”¨ Lua è„šæœ¬ä¿è¯å¤šæ¡å‘½ä»¤çš„åŸå­æ€§</p>
<hr>
<h4 id="ä¸å¯é‡è¯•">ä¸å¯é‡è¯•</h4>
<p>ä¸å¯é‡è¯•ï¼šè·å–é”åªå°è¯•ä¸€æ¬¡å°±è¿”å› falseï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶</p>
<ul>
<li>åˆ©ç”¨ Lua è„šæœ¬å°è¯•è·å–é”ï¼Œè·å–å¤±è´¥è·å–é”çš„å‰©ä½™è¶…æ—¶æ—¶é—´ ttlï¼Œæˆ–è€…é€šè¿‡å‚æ•°ä¼ å…¥çº¿ç¨‹æŠ¢é”å…è®¸ç­‰å¾…çš„æ—¶é—´</li>
<li>åˆ©ç”¨è®¢é˜…åŠŸèƒ½è®¢é˜…é”é‡Šæ”¾çš„ä¿¡æ¯ï¼Œç„¶åçº¿ç¨‹æŒ‚èµ·ç­‰å¾… ttl æ—¶é—´</li>
<li>åˆ©ç”¨ Lua è„šæœ¬åœ¨é‡Šæ”¾é”æ—¶ï¼Œå‘å¸ƒä¸€æ¡é”é‡Šæ”¾çš„æ¶ˆæ¯</li>
</ul>
<hr>
<h4 id="è¶…æ—¶é‡Šæ”¾">è¶…æ—¶é‡Šæ”¾</h4>
<p>è¶…æ—¶é‡Šæ”¾ï¼šé”è¶…æ—¶é‡Šæ”¾å¯ä»¥é¿å…æ­»é”ï¼Œä½†å¦‚æœæ˜¯ä¸šåŠ¡æ‰§è¡Œè€—æ—¶è¾ƒé•¿ï¼Œéœ€è¦è¿›è¡Œé”ç»­æ—¶ï¼Œé˜²æ­¢ä¸šåŠ¡æœªæ‰§è¡Œå®Œæå‰é‡Šæ”¾é”</p>
<p>çœ‹é—¨ç‹— Watch Dog æœºåˆ¶ï¼š</p>
<ul>
<li>è·å–é”æˆåŠŸåï¼Œæäº¤å‘¨æœŸä»»åŠ¡ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆRedisson ä¸­é»˜è®¤ä¸ºè¿‡æœŸæ—¶é—´ / 3ï¼‰ï¼Œé‡ç½®ä¸€æ¬¡è¶…æ—¶æ—¶é—´</li>
<li>å¦‚æœæœåŠ¡å®•æœºï¼ŒWatch Dog æœºåˆ¶çº¿ç¨‹å°±åœæ­¢ï¼Œå°±ä¸ä¼šå†å»¶é•¿ key çš„è¿‡æœŸæ—¶é—´</li>
<li>é‡Šæ”¾é”åï¼Œç»ˆæ­¢å‘¨æœŸä»»åŠ¡</li>
</ul>
<hr>
<h4 id="ä¸»ä»ä¸€è‡´">ä¸»ä»ä¸€è‡´</h4>
<p>ä¸»ä»ä¸€è‡´æ€§ï¼šé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä¸»ä»åŒæ­¥å­˜åœ¨å»¶è¿Ÿï¼Œå½“åŠ é”åä¸»æœåŠ¡å™¨å®•æœºæ—¶ï¼Œä»æœåŠ¡å™¨è¿˜æ²¡åŒæ­¥ä¸»æœåŠ¡å™¨ä¸­çš„é”æ•°æ®ï¼Œæ­¤æ—¶ä»æœåŠ¡å™¨å‡çº§ä¸ºä¸»æœåŠ¡å™¨ï¼Œå…¶ä»–çº¿ç¨‹åˆå¯ä»¥è·å–åˆ°é”</p>
<p>å°†æœåŠ¡å™¨å‡çº§ä¸ºå¤šä¸»å¤šä»ï¼š</p>
<ul>
<li>è·å–é”éœ€è¦ä»æ‰€æœ‰ä¸»æœåŠ¡å™¨ SET æˆåŠŸæ‰ç®—è·å–æˆåŠŸ</li>
<li>æŸä¸ª master å®•æœºï¼Œslave è¿˜æ²¡æœ‰åŒæ­¥é”æ•°æ®å°±å‡çº§ä¸º masterï¼Œå…¶ä»–çº¿ç¨‹å°è¯•åŠ é”ä¼šåŠ é”å¤±è´¥ï¼Œå› ä¸ºå…¶ä»– master ä¸Šå·²ç»å­˜åœ¨è¯¥é”</li>
</ul>
<hr>
<h2 id="ä¸»ä»å¤åˆ¶">ä¸»ä»å¤åˆ¶</h2>
<h3 id="åŸºæœ¬æ“ä½œ-3">åŸºæœ¬æ“ä½œ</h3>
<h4 id="ä¸»ä»ä»‹ç»">ä¸»ä»ä»‹ç»</h4>
<p>ä¸»ä»å¤åˆ¶ï¼šä¸€ä¸ªæœåŠ¡å™¨å»å¤åˆ¶å¦ä¸€ä¸ªæœåŠ¡å™¨ï¼Œè¢«å¤åˆ¶çš„æœåŠ¡å™¨ä¸ºä¸»æœåŠ¡å™¨ masterï¼Œå¤åˆ¶çš„æœåŠ¡å™¨ä¸ºä»æœåŠ¡å™¨ slave</p>
<ul>
<li>master ç”¨æ¥<strong>å†™æ•°æ®</strong>ï¼Œæ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œå°†å‡ºç°å˜åŒ–çš„æ•°æ®è‡ªåŠ¨åŒæ­¥åˆ° slaveï¼Œå¾ˆå°‘ä¼šè¿›è¡Œè¯»å–æ“ä½œ</li>
<li>slave ç”¨æ¥è¯»æ•°æ®ï¼Œç¦æ­¢åœ¨ slave æœåŠ¡å™¨ä¸Šè¿›è¡Œè¯»æ“ä½œ</li>
</ul>
<p>è¿›è¡Œå¤åˆ¶ä¸­çš„ä¸»ä»æœåŠ¡å™¨åŒæ–¹çš„æ•°æ®åº“å°†ä¿å­˜ç›¸åŒçš„æ•°æ®ï¼Œå°†è¿™ç§ç°è±¡ç§°ä½œ<strong>æ•°æ®åº“çŠ¶æ€ä¸€è‡´</strong></p>
<p>ä¸»ä»å¤åˆ¶çš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>
<p><strong>è–ªç«ç›¸ä¼ </strong>ï¼šä¸€ä¸ª slave å¯ä»¥æ˜¯ä¸‹ä¸€ä¸ª slave çš„ masterï¼Œslave åŒæ ·å¯ä»¥æ¥æ”¶å…¶ä»– slave çš„è¿æ¥å’ŒåŒæ­¥è¯·æ±‚ï¼Œé‚£ä¹ˆè¯¥ slave ä½œä¸ºäº†é“¾æ¡ä¸­ä¸‹ä¸€ä¸ªçš„ masterï¼Œå¯ä»¥æœ‰æ•ˆå‡è½» master çš„å†™å‹åŠ›ï¼Œå»ä¸­å¿ƒåŒ–é™ä½é£é™©</p>
<p>æ³¨æ„ï¼šä¸»æœºæŒ‚äº†ï¼Œä»æœºè¿˜æ˜¯ä»æœºï¼Œæ— æ³•å†™æ•°æ®äº†</p>
</li>
<li>
<p><strong>åå®¢ä¸ºä¸»</strong>ï¼šå½“ä¸€ä¸ª master å®•æœºåï¼Œåé¢çš„ slave å¯ä»¥ç«‹åˆ»å‡ä¸º masterï¼Œå…¶åé¢çš„ slave ä¸åšä»»ä½•ä¿®æ”¹</p>
</li>
</ul>
<p>ä¸»ä»å¤åˆ¶çš„ä½œç”¨ï¼š</p>
<ul>
<li><strong>è¯»å†™åˆ†ç¦»</strong>ï¼šmaster å†™ã€slave è¯»ï¼Œæé«˜æœåŠ¡å™¨çš„è¯»å†™è´Ÿè½½èƒ½åŠ›</li>
<li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šåŸºäºä¸»ä»ç»“æ„ï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œç”± slave åˆ†æ‹… master è´Ÿè½½ï¼Œå¹¶æ ¹æ®éœ€æ±‚çš„å˜åŒ–ï¼Œæ”¹å˜ slave çš„æ•°é‡ï¼Œé€šè¿‡å¤šä¸ªä»èŠ‚ç‚¹åˆ†æ‹…æ•°æ®è¯»å–è´Ÿè½½ï¼Œå¤§å¤§æé«˜ Redis æœåŠ¡å™¨å¹¶å‘é‡ä¸æ•°æ®ååé‡</li>
<li>æ•…éšœæ¢å¤ï¼šå½“ master å‡ºç°é—®é¢˜æ—¶ï¼Œç”± slave æä¾›æœåŠ¡ï¼Œå®ç°å¿«é€Ÿçš„æ•…éšœæ¢å¤</li>
<li>æ•°æ®å†—ä½™ï¼šå®ç°æ•°æ®çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„ä¸€ç§æ•°æ®å†—ä½™æ–¹å¼</li>
<li>é«˜å¯ç”¨åŸºçŸ³ï¼šåŸºäºä¸»ä»å¤åˆ¶ï¼Œæ„å»ºå“¨å…µæ¨¡å¼ä¸é›†ç¾¤ï¼Œå®ç° Redis çš„é«˜å¯ç”¨æ–¹æ¡ˆ</li>
</ul>
<p><strong>ä¸‰é«˜</strong>æ¶æ„ï¼š</p>
<ul>
<li>
<p>é«˜å¹¶å‘ï¼šåº”ç”¨æä¾›æŸä¸€ä¸šåŠ¡è¦èƒ½æ”¯æŒå¾ˆå¤šå®¢æˆ·ç«¯åŒæ—¶è®¿é—®çš„èƒ½åŠ›ï¼Œç§°ä¸ºå¹¶å‘</p>
</li>
<li>
<p>é«˜æ€§èƒ½ï¼šæ€§èƒ½æœ€ç›´è§‚çš„æ„Ÿå—å°±æ˜¯é€Ÿåº¦å¿«ï¼Œæ—¶é—´çŸ­</p>
</li>
<li>
<p>é«˜å¯ç”¨ï¼š</p>
<ul>
<li>å¯ç”¨æ€§ï¼šåº”ç”¨æœåŠ¡åœ¨å…¨å¹´å®•æœºçš„æ—¶é—´åŠ åœ¨ä¸€èµ·å°±æ˜¯å…¨å¹´åº”ç”¨æœåŠ¡ä¸å¯ç”¨çš„æ—¶é—´</li>
<li>ä¸šç•Œå¯ç”¨æ€§ç›®æ ‡ 5 ä¸ª 9ï¼Œå³ 99.999%ï¼Œå³æœåŠ¡å™¨å¹´å®•æœºæ—¶é•¿ä½äº 315 ç§’ï¼Œçº¦ 5.25 åˆ†é’Ÿ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="æ“ä½œæŒ‡ä»¤">æ“ä½œæŒ‡ä»¤</h4>
<p>ç³»ç»ŸçŠ¶æ€æŒ‡ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INFO replication</span><br></pre></td></tr></table></figure>
<p>master å’Œ slave äº’è¿ï¼š</p>
<ul>
<li>
<p>æ–¹å¼ä¸€ï¼šå®¢æˆ·ç«¯å‘é€å‘½ä»¤ï¼Œè®¾ç½® slaveof é€‰é¡¹ï¼Œäº§ç”Ÿä¸»ä»ç»“æ„</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaveof masterip masterport</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ–¹å¼äºŒï¼šæœåŠ¡å™¨å¸¦å‚å¯åŠ¨</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server --slaveof masterip masterport</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ–¹å¼ä¸‰ï¼šæœåŠ¡å™¨é…ç½®ï¼ˆä¸»æµæ–¹å¼ï¼‰</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaveof masterip masterport</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>ä¸»ä»æ–­å¼€è¿æ¥ï¼š</p>
<ul>
<li>
<p>slave æ–­å¼€è¿æ¥åï¼Œä¸ä¼šåˆ é™¤å·²æœ‰æ•°æ®ï¼Œåªæ˜¯ä¸å†æ¥å— master å‘é€çš„æ•°æ®ï¼Œå¯ä»¥ä½œ<strong>ä¸ºä»æœåŠ¡å™¨å‡çº§ä¸ºä¸»æœåŠ¡å™¨çš„æŒ‡ä»¤</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaveof no one	</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æˆæƒè®¿é—®ï¼šmaster æœ‰æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œslave ä¹Ÿæœ‰æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œä¸ä»…æœåŠ¡ç«¯ä¹‹é—´å¯ä»¥å‘å‘½ä»¤ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥</p>
<ul>
<li>
<p>master å®¢æˆ·ç«¯å‘é€å‘½ä»¤è®¾ç½®å¯†ç ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requirepass password</span><br></pre></td></tr></table></figure>
<p>master é…ç½®æ–‡ä»¶è®¾ç½®å¯†ç ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config <span class="built_in">set</span> requirepass password</span><br><span class="line">config get requirepass</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>slave å®¢æˆ·ç«¯å‘é€å‘½ä»¤è®¾ç½®å¯†ç ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth password</span><br></pre></td></tr></table></figure>
<p>slave é…ç½®æ–‡ä»¶è®¾ç½®å¯†ç ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">masterauth password</span><br></pre></td></tr></table></figure>
<p>slave å¯åŠ¨æœåŠ¡å™¨è®¾ç½®å¯†ç ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server â€“a password</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="å¤åˆ¶æµç¨‹">å¤åˆ¶æµç¨‹</h3>
<h4 id="æ—§ç‰ˆå¤åˆ¶">æ—§ç‰ˆå¤åˆ¶</h4>
<p>Redis çš„å¤åˆ¶åŠŸèƒ½åˆ†ä¸ºåŒæ­¥ï¼ˆsyncï¼‰å’Œå‘½ä»¤ä¼ æ’­ï¼ˆcommand propagateï¼‰ä¸¤ä¸ªæ“ä½œï¼Œä¸»ä»åº“é—´çš„å¤åˆ¶æ˜¯<strong>å¼‚æ­¥è¿›è¡Œçš„</strong></p>
<p>åŒæ­¥æ“ä½œç”¨äºå°†ä»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€æ›´æ–°è‡³ä¸»æœåŠ¡å™¨å½“å‰æ‰€å¤„çš„æ•°æ®åº“çŠ¶æ€ï¼Œè¯¥è¿‡ç¨‹åˆå«å…¨é‡å¤åˆ¶ï¼š</p>
<ul>
<li>ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€ SYNC å‘½ä»¤æ¥è¿›è¡ŒåŒæ­¥</li>
<li>æ”¶åˆ° SYNC çš„ä¸»æœåŠ¡å™¨æ‰§è¡Œ BGSAVE å‘½ä»¤ï¼Œåœ¨åå°ç”Ÿæˆä¸€ä¸ª RDB æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ª<strong>ç¼“å†²åŒº</strong>è®°å½•ä»ç°åœ¨å¼€å§‹æ‰§è¡Œçš„æ‰€æœ‰<strong>å†™å‘½ä»¤</strong></li>
<li>å½“ BGSAVE å‘½ä»¤æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œä¸»æœåŠ¡å™¨ä¼šå°† RDB æ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨</li>
<li>ä»æœåŠ¡æ¥æ”¶å¹¶è½½å…¥ RDB æ–‡ä»¶ï¼ˆä»æœåŠ¡å™¨ä¼š<strong>æ¸…ç©ºåŸæœ‰æ•°æ®</strong>ï¼‰</li>
<li>ç¼“å†²åŒºè®°å½•äº† RDB æ–‡ä»¶æ‰€åœ¨çŠ¶æ€åçš„æ‰€æœ‰å†™å‘½ä»¤ï¼Œä¸»æœåŠ¡å™¨å°†åœ¨ç¼“å†²åŒºçš„æ‰€æœ‰å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨æ‰§è¡Œè¿™äº›å†™å‘½ä»¤</li>
<li>è‡³æ­¤ä»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€å’Œä¸»æœåŠ¡å™¨ä¸€è‡´</li>
</ul>
<p>å‘½ä»¤ä¼ æ’­ç”¨äºåœ¨ä¸»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€è¢«ä¿®æ”¹ï¼Œå¯¼è‡´ä¸»ä»æ•°æ®åº“çŠ¶æ€å‡ºç°ä¸ä¸€è‡´æ—¶ï¼Œ è®©ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®åº“é‡æ–°å›åˆ°ä¸€è‡´çŠ¶æ€</p>
<ul>
<li>ä¸»æœåŠ¡å™¨ä¼šå°†è‡ªå·±æ‰§è¡Œçš„å†™å‘½ä»¤ï¼Œä¹Ÿå³æ˜¯é€ æˆä¸»ä»æœåŠ¡å™¨ä¸ä¸€è‡´çš„é‚£æ¡å†™å‘½ä»¤ï¼Œå‘é€ç»™ä»æœåŠ¡å™¨</li>
<li>ä»æœåŠ¡å™¨æ¥å—å‘½ä»¤å¹¶æ‰§è¡Œï¼Œä¸»ä»æœåŠ¡å™¨å°†å†æ¬¡å›åˆ°ä¸€è‡´çŠ¶æ€</li>
</ul>
<hr>
<h4 id="åŠŸèƒ½ç¼ºé™·">åŠŸèƒ½ç¼ºé™·</h4>
<p>SYNC æœ¬èº«å°±æ˜¯ä¸€ä¸ªéå¸¸æ¶ˆè€—èµ„æºçš„æ“ä½œï¼Œæ¯æ¬¡æ‰§è¡Œ SYNC å‘½ä»¤ï¼Œéƒ½éœ€è¦æ‰§è¡Œä»¥ä¸‹åŠ¨ä½œï¼š</p>
<ul>
<li>ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œè€—è´¹ä¸»æœåŠ¡å™¨å¤§é‡ CPU ã€å†…å­˜å’Œç£ç›˜ I/O èµ„æº</li>
<li>RDB æ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œè€—è´¹ä¸»ä»æœåŠ¡å™¨å¤§é‡çš„ç½‘ç»œèµ„æºï¼ˆå¸¦å®½å’Œæµé‡ï¼‰ï¼Œå¹¶å¯¹ä¸»æœåŠ¡å™¨å“åº”å‘½ä»¤è¯·æ±‚çš„æ—¶é—´äº§ç”Ÿå½±å“</li>
<li>ä»æœåŠ¡å™¨è½½å…¥ RDB æ–‡ä»¶ï¼ŒæœŸé—´ä¼šå› ä¸ºé˜»å¡è€Œæ²¡åŠæ³•å¤„ç†å‘½ä»¤è¯·æ±‚</li>
</ul>
<p>SYNC å‘½ä»¤ä¸‹çš„ä»æœåŠ¡å™¨å¯¹ä¸»æœåŠ¡å™¨çš„å¤åˆ¶åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>åˆæ¬¡å¤åˆ¶ï¼šä»æœåŠ¡å™¨æ²¡æœ‰å¤åˆ¶è¿‡ä»»ä½•ä¸»æœåŠ¡å™¨ï¼Œæˆ–è€…ä»æœåŠ¡å™¨å½“å‰è¦å¤åˆ¶çš„ä¸»æœåŠ¡å™¨å’Œä¸Šä¸€æ¬¡å¤åˆ¶çš„ä¸»æœåŠ¡å™¨ä¸åŒ</li>
<li>æ–­çº¿åé‡å¤åˆ¶ï¼šå¤„äºå‘½ä»¤ä¼ æ’­é˜¶æ®µçš„ä¸»ä»æœåŠ¡å™¨å› ä¸ºç½‘ç»œåŸå› è€Œä¸­æ–­äº†å¤åˆ¶ï¼Œè‡ªåŠ¨é‡è¿åå¹¶ç»§ç»­å¤åˆ¶ä¸»æœåŠ¡å™¨</li>
</ul>
<p>æ—§ç‰ˆå¤åˆ¶åœ¨æ–­çº¿åé‡å¤åˆ¶æ—¶ï¼Œä¹Ÿä¼šåˆ›å»º RDB æ–‡ä»¶è¿›è¡Œ<strong>å…¨é‡å¤åˆ¶</strong>ï¼Œä½†æ˜¯ä»æœåŠ¡å™¨åªéœ€è¦æ–­çº¿æ—¶é—´å†…çš„è¿™éƒ¨åˆ†æ•°æ®ï¼Œæ‰€ä»¥æ—§ç‰ˆå¤åˆ¶çš„å®ç°æ–¹å¼éå¸¸æµªè´¹èµ„æº</p>
<hr>
<h4 id="æ–°ç‰ˆå¤åˆ¶">æ–°ç‰ˆå¤åˆ¶</h4>
<p>Redis ä» 2.8 ç‰ˆæœ¬å¼€å§‹ï¼Œä½¿ç”¨ PSYNC å‘½ä»¤ä»£æ›¿ SYNC å‘½ä»¤æ¥æ‰§è¡Œå¤åˆ¶æ—¶çš„<strong>åŒæ­¥æ“ä½œ</strong>ï¼ˆå‘½ä»¤ä¼ æ’­é˜¶æ®µç›¸åŒï¼‰ï¼Œè§£å†³äº†æ—§ç‰ˆå¤åˆ¶åœ¨å¤„ç†æ–­çº¿é‡å¤åˆ¶æƒ…å†µçš„ä½æ•ˆé—®é¢˜</p>
<p>PSYNC å‘½ä»¤å…·æœ‰å®Œæ•´é‡åŒæ­¥ï¼ˆfull resynchronizationï¼‰å’Œ<strong>éƒ¨åˆ†é‡åŒæ­¥</strong>ï¼ˆpartial resynchronizationï¼‰ä¸¤ç§æ¨¡å¼ï¼š</p>
<ul>
<li>å®Œæ•´é‡åŒæ­¥ï¼šå¤„ç†åˆæ¬¡å¤åˆ¶æƒ…å†µï¼Œæ‰§è¡Œæ­¥éª¤å’Œ SYNCå‘½ä»¤åŸºæœ¬ä¸€æ ·</li>
<li>éƒ¨åˆ†é‡åŒæ­¥ï¼šå¤„ç†æ–­çº¿åé‡å¤åˆ¶æƒ…å†µï¼Œä¸»æœåŠ¡å™¨å¯ä»¥å°†ä¸»ä»è¿æ¥æ–­å¼€æœŸé—´æ‰§è¡Œçš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨åªè¦æ¥æ”¶å¹¶æ‰§è¡Œè¿™äº›å†™å‘½ä»¤ï¼Œå°±å¯ä»¥å°†æ•°æ®åº“æ›´æ–°è‡³ä¸»æœåŠ¡å™¨å½“å‰æ‰€å¤„çš„çŠ¶æ€ï¼Œè¯¥è¿‡ç¨‹åˆå«<strong>éƒ¨åˆ†å¤åˆ¶</strong></li>
</ul>
<hr>
<h3 id="éƒ¨åˆ†åŒæ­¥">éƒ¨åˆ†åŒæ­¥</h3>
<p>éƒ¨åˆ†é‡åŒæ­¥åŠŸèƒ½ç”±ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†æ„æˆï¼š</p>
<ul>
<li>ä¸»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡ï¼ˆreplication offsetï¼‰å’Œä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡</li>
<li>ä¸»æœåŠ¡å™¨çš„å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼ˆreplication backlogï¼‰</li>
<li>æœåŠ¡å™¨çš„è¿è¡Œ ID (run ID)</li>
</ul>
<h4 id="åç§»é‡">åç§»é‡</h4>
<p>ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨ä¼šåˆ†åˆ«ç»´æŠ¤ä¸€ä¸ªå¤åˆ¶åç§»é‡ï¼š</p>
<ul>
<li>
<p>ä¸»æœåŠ¡å™¨æ¯æ¬¡å‘ä»æœåŠ¡å™¨ä¼ æ’­ N ä¸ªå­—èŠ‚çš„æ•°æ®æ—¶ï¼Œå°±å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡çš„å€¼åŠ ä¸Š N</p>
</li>
<li>
<p>ä»æœåŠ¡å™¨æ¯æ¬¡æ”¶åˆ°ä¸»æœåŠ¡å™¨ä¼ æ’­æ¥çš„ N ä¸ªå­—èŠ‚çš„æ•°æ®æ—¶ï¼Œå°±å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡çš„å€¼åŠ ä¸Š N</p>
</li>
</ul>
<p>é€šè¿‡å¯¹æ¯”ä¸»ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡ï¼Œå¯ä»¥åˆ¤æ–­ä¸»ä»æœåŠ¡å™¨æ˜¯å¦å¤„äºä¸€è‡´çŠ¶æ€</p>
<ul>
<li>ä¸»ä»æœåŠ¡å™¨çš„åç§»é‡æ˜¯ç›¸åŒçš„ï¼Œè¯´æ˜ä¸»ä»æœåŠ¡å™¨å¤„äºä¸€è‡´çŠ¶æ€</li>
<li>ä¸»ä»æœåŠ¡å™¨çš„åç§»é‡æ˜¯ä¸åŒçš„ï¼Œè¯´æ˜ä¸»ä»æœåŠ¡å™¨å¤„äºä¸ä¸€è‡´çŠ¶æ€</li>
</ul>
<hr>
<h4 id="ç¼“å†²åŒº-2">ç¼“å†²åŒº</h4>
<p>å¤åˆ¶ç§¯å‹ç¼“å†²åŒºæ˜¯ç”±ä¸»æœåŠ¡å™¨ç»´æŠ¤çš„ä¸€ä¸ªå›ºå®šé•¿åº¦ï¼ˆfixed-sizeï¼‰å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰é˜Ÿåˆ—ï¼Œé»˜è®¤å¤§å°ä¸º 1MB</p>
<ul>
<li>å‡ºé˜Ÿè§„åˆ™è·Ÿæ™®é€šçš„å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ä¸€æ ·</li>
<li>å…¥é˜Ÿè§„åˆ™æ˜¯å½“å…¥é˜Ÿå…ƒç´ çš„æ•°é‡å¤§äºé˜Ÿåˆ—é•¿åº¦æ—¶ï¼Œæœ€å…ˆå…¥é˜Ÿçš„å…ƒç´ ä¼šè¢«å¼¹å‡ºï¼Œç„¶åæ–°å…ƒç´ æ‰ä¼šè¢«æ”¾å…¥é˜Ÿåˆ—</li>
</ul>
<p>å½“ä¸»æœåŠ¡å™¨è¿›è¡Œ<strong>å‘½ä»¤ä¼ æ’­æ—¶ï¼Œä¸ä»…ä¼šå°†å†™å‘½ä»¤å‘é€ç»™æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œè¿˜ä¼šå°†å†™å‘½ä»¤å…¥é˜Ÿåˆ°å¤åˆ¶ç§¯å‹ç¼“å†²åŒº</strong>ï¼Œç¼“å†²åŒºä¼šä¿å­˜ç€ä¸€éƒ¨åˆ†æœ€è¿‘ä¼ æ’­çš„å†™å‘½ä»¤ï¼Œå¹¶ä¸”ç¼“å†²åŒºä¼šä¸ºé˜Ÿåˆ—ä¸­çš„æ¯ä¸ªå­—èŠ‚è®°å½•ç›¸åº”çš„å¤åˆ¶åç§»é‡</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%A4%8D%E5%88%B6%E7%A7%AF%E5%8E%8B%E7%BC%93%E5%86%B2%E5%8C%BA.png" alt=""></p>
<p>ä»æœåŠ¡å™¨ä¼šé€šè¿‡ PSYNC å‘½ä»¤å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡ offset å‘é€ç»™ä¸»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨ä¼šæ ¹æ®è¿™ä¸ªå¤åˆ¶åç§»é‡æ¥å†³å®šå¯¹ä»æœåŠ¡å™¨æ‰§è¡Œä½•ç§åŒæ­¥æ“ä½œï¼š</p>
<ul>
<li>offset ä¹‹åçš„æ•°æ®ï¼ˆå³ offset+1ï¼‰ä»ç„¶å­˜åœ¨äºå¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å°†å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥æ“ä½œ</li>
<li>offset ä¹‹åçš„æ•°æ®å·²ç»ä¸åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼Œè¯´æ˜éƒ¨åˆ†æ•°æ®å·²ç»ä¸¢å¤±ï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å°†å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œ</li>
</ul>
<p>å¤åˆ¶ç¼“å†²åŒºå¤§å°è®¾å®šä¸åˆç†ï¼Œä¼šå¯¼è‡´<strong>æ•°æ®æº¢å‡º</strong>ã€‚æ¯”å¦‚ä¸»æœåŠ¡å™¨éœ€è¦æ‰§è¡Œå¤§é‡å†™å‘½ä»¤ï¼Œåˆæˆ–è€…ä¸»ä»æœåŠ¡å™¨æ–­çº¿åé‡è¿æ¥æ‰€éœ€çš„æ—¶é—´è¾ƒé•¿ï¼Œå¯¼è‡´ç¼“å†²åŒºä¸­çš„æ•°æ®å·²ç»ä¸¢å¤±ï¼Œåˆ™å¿…é¡»è¿›è¡Œå®Œæ•´é‡åŒæ­¥</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repl-backlog-size ?mb</span><br></pre></td></tr></table></figure>
<p>å»ºè®®è®¾ç½®å¦‚ä¸‹ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ç»å¤§éƒ¨åˆ†æ–­çº¿æƒ…å†µéƒ½èƒ½ç”¨éƒ¨åˆ†é‡åŒæ­¥æ¥å¤„ç†ï¼š</p>
<ul>
<li>ä»æœåŠ¡å™¨æ–­çº¿åé‡æ–°è¿æ¥ä¸Šä¸»æœåŠ¡å™¨æ‰€éœ€çš„å¹³å‡æ—¶é—´ second</li>
<li>è·å– master å¹³å‡æ¯ç§’äº§ç”Ÿå†™å‘½ä»¤æ•°æ®æ€»é‡ write_size_per_second</li>
<li>æœ€ä¼˜å¤åˆ¶ç¼“å†²åŒºç©ºé—´ = 2 * second * write_size_per_second</li>
</ul>
<hr>
<h4 id="è¿è¡ŒID">è¿è¡ŒID</h4>
<p>æœåŠ¡å™¨è¿è¡Œ IDï¼ˆrun IDï¼‰ï¼šæ˜¯æ¯ä¸€å°æœåŠ¡å™¨æ¯æ¬¡è¿è¡Œçš„èº«ä»½è¯†åˆ«ç ï¼Œåœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆï¼Œç”± 40 ä½éšæœºçš„åå…­è¿›åˆ¶å­—ç¬¦ç»„æˆï¼Œä¸€å°æœåŠ¡å™¨å¤šæ¬¡è¿è¡Œå¯ä»¥ç”Ÿæˆå¤šä¸ªè¿è¡Œ ID</p>
<p>ä½œç”¨ï¼šæœåŠ¡å™¨é—´è¿›è¡Œä¼ è¾“è¯†åˆ«èº«ä»½ï¼Œå¦‚æœæƒ³ä¸¤æ¬¡æ“ä½œå‡å¯¹åŒä¸€å°æœåŠ¡å™¨è¿›è¡Œï¼Œ<strong>æ¯æ¬¡å¿…é¡»æ“ä½œæºå¸¦å¯¹åº”çš„è¿è¡Œ ID</strong>ï¼Œç”¨äºå¯¹æ–¹è¯†åˆ«</p>
<p>ä»æœåŠ¡å™¨å¯¹ä¸»æœåŠ¡å™¨è¿›è¡Œåˆæ¬¡å¤åˆ¶æ—¶ï¼Œä¸»æœåŠ¡å™¨å°†è‡ªå·±çš„è¿è¡Œ ID ä¼ é€ç»™ä»æœåŠ¡å™¨ï¼Œç„¶åä»æœåŠ¡å™¨ä¼šå°†è¯¥è¿è¡Œ ID ä¿å­˜ã€‚å½“ä»æœåŠ¡å™¨æ–­çº¿å¹¶é‡æ–°è¿ä¸Šä¸€ä¸ªä¸»æœåŠ¡å™¨æ—¶ï¼Œä¼šå‘å½“å‰è¿æ¥çš„ä¸»æœåŠ¡å™¨å‘é€ä¹‹å‰ä¿å­˜çš„è¿è¡Œ IDï¼š</p>
<ul>
<li>å¦‚æœè¿è¡Œ ID å’Œå½“å‰è¿æ¥çš„ä¸»æœåŠ¡å™¨çš„è¿è¡Œ ID ç›¸åŒï¼Œè¯´æ˜ä»æœåŠ¡å™¨æ–­çº¿ä¹‹å‰å¤åˆ¶çš„å°±æ˜¯å½“å‰è¿æ¥çš„è¿™ä¸ªä¸»æœåŠ¡å™¨ï¼Œæ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥</li>
<li>å¦‚æœä¸åŒï¼Œéœ€è¦æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œ</li>
</ul>
<hr>
<h4 id="PSYNC">PSYNC</h4>
<p>PSYNC å‘½ä»¤çš„è°ƒç”¨æ–¹æ³•æœ‰ä¸¤ç§</p>
<ul>
<li>å¦‚æœä»æœåŠ¡å™¨ä¹‹å‰æ²¡æœ‰å¤åˆ¶è¿‡ä»»ä½•ä¸»æœåŠ¡å™¨ï¼Œæˆ–è€…æ‰§è¡Œäº† <code>SLAVEOF no one</code>ï¼Œå¼€å§‹ä¸€æ¬¡æ–°çš„å¤åˆ¶æ—¶å°†å‘ä¸»æœåŠ¡å™¨å‘é€ <code>PSYNC ? -1</code> å‘½ä»¤ï¼Œä¸»åŠ¨è¯·æ±‚ä¸»æœåŠ¡å™¨è¿›è¡Œå®Œæ•´é‡åŒæ­¥</li>
<li>å¦‚æœä»æœåŠ¡å™¨å·²ç»å¤åˆ¶è¿‡æŸä¸ªä¸»æœåŠ¡å™¨ï¼Œé‚£ä¹ˆä»æœåŠ¡å™¨åœ¨å¼€å§‹ä¸€æ¬¡æ–°çš„å¤åˆ¶æ—¶å°†å‘ä¸»æœåŠ¡å™¨å‘é€ <code>PSYNC &lt;runid&gt; &lt;offset&gt;</code> å‘½ä»¤ï¼Œrunid æ˜¯ä¸Šä¸€æ¬¡å¤åˆ¶çš„ä¸»æœåŠ¡å™¨çš„è¿è¡Œ IDï¼Œoffset æ˜¯å¤åˆ¶çš„åç§»é‡</li>
</ul>
<p>æ¥æ”¶åˆ° PSYNC å‘½ä»¤çš„ä¸»æœåŠ¡å™¨ä¼šå‘ä»æœåŠ¡å™¨è¿”å›ä»¥ä¸‹ä¸‰ç§å›å¤çš„å…¶ä¸­ä¸€ç§ï¼š</p>
<ul>
<li>æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œï¼šè¿”å› <code>+FULLRESYNC &lt;runid&gt; &lt;offset&gt;</code>ï¼Œrunid æ˜¯ä¸»æœåŠ¡å™¨çš„è¿è¡Œ IDï¼Œoffset æ˜¯ä¸»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡</li>
<li>æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥æ“ä½œï¼šè¿”å› <code>+CONTINUE</code>ï¼Œä»æœåŠ¡å™¨æ”¶åˆ°è¯¥å›å¤è¯´æ˜åªéœ€è¦ç­‰å¾…ä¸»æœåŠ¡å™¨å‘é€ç¼ºå¤±çš„éƒ¨åˆ†æ•°æ®å³å¯</li>
<li>ä¸»æœåŠ¡å™¨çš„ç‰ˆæœ¬ä½äº Redis2.8ï¼šè¿”å› <code>-ERR</code>ï¼Œç‰ˆæœ¬è¿‡ä½è¯†åˆ«ä¸äº† PSYNCï¼Œä»æœåŠ¡å™¨å°†å‘ä¸»æœåŠ¡å™¨å‘é€ SYNC å‘½ä»¤</li>
</ul>
<hr>
<h3 id="å¤åˆ¶å®ç°">å¤åˆ¶å®ç°</h3>
<h4 id="å®ç°æµç¨‹">å®ç°æµç¨‹</h4>
<p>é€šè¿‡å‘ä»æœåŠ¡å™¨å‘é€ SLAVEOF å‘½ä»¤ï¼Œå¯ä»¥è®©ä»æœåŠ¡å™¨å»å¤åˆ¶ä¸€ä¸ªä¸»æœåŠ¡å™¨</p>
<ul>
<li>
<p>è®¾ç½®ä¸»æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£ï¼šå°† SLAVEOF å‘½ä»¤æŒ‡å®šçš„ ip å’Œ port ä¿å­˜åˆ°æœåŠ¡å™¨çŠ¶æ€ redisServer</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">	<span class="comment">// ä¸»æœåŠ¡å™¨çš„åœ°å€ </span></span><br><span class="line">    <span class="type">char</span> *masterhost; </span><br><span class="line">	 <span class="comment">//ä¸»æœåŠ¡å™¨çš„ç«¯å£ </span></span><br><span class="line">    <span class="type">int</span> masterport; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>SLAVEOF å‘½ä»¤æ˜¯ä¸€ä¸ª<strong>å¼‚æ­¥å‘½ä»¤</strong>ï¼Œåœ¨å®Œæˆå±æ€§çš„è®¾ç½®åæœåŠ¡å™¨ç›´æ¥è¿”å› OKï¼Œè€Œå®é™…çš„å¤åˆ¶å·¥ä½œå°†åœ¨ OK è¿”å›ä¹‹åæ‰çœŸæ­£å¼€å§‹æ‰§è¡Œ</p>
</li>
<li>
<p>å»ºç«‹å¥—æ¥å­—è¿æ¥ï¼š</p>
<ul>
<li>ä»æœåŠ¡å™¨ connect ä¸»æœåŠ¡å™¨å»ºç«‹å¥—æ¥å­—è¿æ¥ï¼ŒæˆåŠŸåä»æœåŠ¡å™¨å°†ä¸ºè¿™ä¸ªå¥—æ¥å­—å…³è”ä¸€ä¸ªç”¨äºå¤åˆ¶å·¥ä½œçš„æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼Œè´Ÿè´£æ‰§è¡Œåç»­çš„å¤åˆ¶å·¥ä½œï¼Œå¦‚æ¥æ”¶ RDB æ–‡ä»¶ã€æ¥æ”¶ä¸»æœåŠ¡å™¨ä¼ æ’­æ¥çš„å†™å‘½ä»¤ç­‰</li>
<li>ä¸»æœåŠ¡å™¨åœ¨æ¥å— accept ä»åŠ¡å™¨çš„å¥—æ¥å­—è¿æ¥åï¼Œå°†ä¸ºè¯¥å¥—æ¥å­—åˆ›å»ºç›¸åº”çš„å®¢æˆ·ç«¯çŠ¶æ€ï¼Œå°†ä»æœåŠ¡å™¨çœ‹ä½œä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä»æœåŠ¡å™¨å°†åŒæ—¶å…·æœ‰ server å’Œ clientï¼ˆå¯ä»¥å‘å‘½ä»¤ï¼‰ä¸¤ä¸ªèº«ä»½</li>
</ul>
</li>
<li>
<p>å‘é€ PING å‘½ä»¤ï¼šä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€ä¸€ä¸ª PING å‘½ä»¤ï¼Œæ£€æŸ¥ä¸»ä»ä¹‹é—´çš„é€šä¿¡æ˜¯å¦æ­£å¸¸ã€ä¸»æœåŠ¡å™¨å¤„ç†å‘½ä»¤çš„èƒ½åŠ›æ˜¯å¦æ­£å¸¸</p>
<ul>
<li>è¿”å›é”™è¯¯ï¼Œè¡¨ç¤ºä¸»æœåŠ¡å™¨æ— æ³•å¤„ç†ä»æœåŠ¡å™¨çš„å‘½ä»¤è¯·æ±‚ï¼ˆå¿™ç¢Œï¼‰ï¼Œä»æœåŠ¡å™¨æ–­å¼€å¹¶é‡æ–°åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„å¥—æ¥å­—</li>
<li>è¿”å›å‘½ä»¤å›å¤ï¼Œä½†ä»æœåŠ¡å™¨ä¸èƒ½åœ¨è§„å®šçš„æ—¶é—´å†…è¯»å–å‡ºå‘½ä»¤å›å¤çš„å†…å®¹ï¼Œè¡¨ç¤ºä¸»ä»ä¹‹é—´çš„ç½‘ç»œçŠ¶æ€ä¸ä½³ï¼Œéœ€è¦æ–­å¼€é‡è¿</li>
<li>è¯»å–åˆ° PONGï¼Œè¡¨ç¤ºä¸€åˆ‡çŠ¶æ€æ­£å¸¸ï¼Œå¯ä»¥æ‰§è¡Œå¤åˆ¶</li>
</ul>
</li>
<li>
<p>èº«ä»½éªŒè¯ï¼šå¦‚æœä»æœåŠ¡å™¨è®¾ç½®äº† masterauth é€‰é¡¹å°±è¿›è¡Œèº«ä»½éªŒè¯ï¼Œå°†å‘ä¸»æœåŠ¡å™¨å‘é€ä¸€æ¡ AUTH å‘½ä»¤ï¼Œå‘½ä»¤å‚æ•°ä¸ºä»æœåŠ¡å™¨ masterauth é€‰é¡¹çš„å€¼ï¼Œå¦‚æœä¸»ä»è®¾ç½®çš„å¯†ç ä¸ç›¸åŒï¼Œé‚£ä¹ˆä¸»å°†è¿”å›ä¸€ä¸ª invalid password é”™è¯¯</p>
</li>
<li>
<p>å‘é€ç«¯å£ä¿¡æ¯ï¼šèº«ä»½éªŒè¯å</p>
<ul>
<li>ä»æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤ <code>REPLCONF listening-port &lt;portÂ­number&gt;</code>ï¼Œ å‘ä¸»æœåŠ¡å™¨å‘é€ä»æœåŠ¡å™¨çš„ç›‘å¬ç«¯å£å·</li>
<li>ä¸»æœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œä¼šå°†ç«¯å£å·è®°å½•åœ¨å¯¹åº”çš„å®¢æˆ·ç«¯çŠ¶æ€ redisClient.slave_listening_port å±æ€§ä¸­ï¼š</li>
</ul>
</li>
<li>
<p>åŒæ­¥ï¼šä»æœåŠ¡å™¨å°†å‘ä¸»æœåŠ¡å™¨å‘é€ PSYNC å‘½ä»¤ï¼Œåœ¨åŒæ­¥æ“ä½œæ‰§è¡Œä¹‹åï¼Œ<strong>ä¸»ä»æœåŠ¡å™¨åŒæ–¹éƒ½æ˜¯å¯¹æ–¹çš„å®¢æˆ·ç«¯</strong>ï¼Œå¯ä»¥ç›¸äº’å‘é€å‘½ä»¤</p>
<ul>
<li>
<p>å®Œæ•´é‡åŒæ­¥ï¼šä¸»æœåŠ¡å™¨éœ€è¦æˆä¸ºä»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ï¼Œæ‰èƒ½å°†ä¿å­˜åœ¨ç¼“å†²åŒºé‡Œé¢çš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨æ‰§è¡Œ</p>
</li>
<li>
<p>éƒ¨åˆ†é‡åŒæ­¥ï¼šä¸»æœåŠ¡å™¨éœ€è¦æˆä¸ºä»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ï¼Œæ‰èƒ½å‘ä»æœåŠ¡å™¨å‘é€ä¿å­˜åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œé¢çš„å†™å‘½ä»¤</p>
</li>
</ul>
</li>
<li>
<p>å‘½ä»¤ä¼ æ’­ï¼šä¸»æœåŠ¡å™¨å°†å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä¿æŒæ•°æ®åº“çš„çŠ¶æ€ä¸€è‡´</p>
</li>
</ul>
<hr>
<h4 id="å¤åˆ¶å›¾ç¤º">å¤åˆ¶å›¾ç¤º</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%B5%81%E7%A8%8B%E6%9B%B4%E6%96%B0.png" alt=""></p>
<hr>
<h3 id="å¿ƒè·³æ£€æµ‹">å¿ƒè·³æ£€æµ‹</h3>
<h4 id="å¿ƒè·³æœºåˆ¶">å¿ƒè·³æœºåˆ¶</h4>
<p>å¿ƒè·³æœºåˆ¶ï¼šè¿›å…¥å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œ<strong>ä»æœåŠ¡å™¨</strong>é»˜è®¤ä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œ<strong>å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤</strong>ï¼š<code>REPLCONF ACK &lt;replication_offset&gt;</code>ï¼Œreplication_offset æ˜¯ä»æœåŠ¡å™¨å½“å‰çš„å¤åˆ¶åç§»é‡</p>
<p>å¿ƒè·³çš„ä½œç”¨ï¼š</p>
<ul>
<li>æ£€æµ‹ä¸»ä»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥çŠ¶æ€</li>
<li>è¾…åŠ©å®ç° min-slaves é€‰é¡¹</li>
<li>æ£€æµ‹å‘½ä»¤ä¸¢å¤±</li>
</ul>
<hr>
<h4 id="ç½‘ç»œçŠ¶æ€">ç½‘ç»œçŠ¶æ€</h4>
<p>å¦‚æœä¸»æœåŠ¡å™¨è¶…è¿‡ä¸€ç§’é’Ÿæ²¡æœ‰æ”¶åˆ°ä»æœåŠ¡å™¨å‘æ¥çš„ REPLCONF ACK å‘½ä»¤ï¼Œä¸»æœåŠ¡å°±è®¤ä¸ºä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å‡ºç°é—®é¢˜</p>
<p>å‘ä¸»æœåŠ¡å™¨å‘é€ <code>INFO replication</code> å‘½ä»¤ï¼Œlag ä¸€æ è¡¨ç¤ºä»æœåŠ¡å™¨æœ€åä¸€æ¬¡å‘ä¸»æœåŠ¡å™¨å‘é€ ACK å‘½ä»¤è·ç¦»ç°åœ¨å¤šå°‘ç§’ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; INFO replication </span><br><span class="line"><span class="comment"># Replication </span></span><br><span class="line">role:master </span><br><span class="line">connected_slaves:2 </span><br><span class="line">slave0: ip=127.0.0.1,port=11111,state=online,offset=123,lag=0 <span class="comment"># åˆšåˆšå‘é€è¿‡ REPLCONF ACK </span></span><br><span class="line">slavel: ip=127.0.0.1,port=22222,state=online,offset=456,lag=3 <span class="comment"># 3ç§’ä¹‹å‰å‘é€è¿‡REPLCONF ACK </span></span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œlag çš„å€¼åº”è¯¥åœ¨ 0 æˆ–è€… 1 ç§’ä¹‹é—´è·³åŠ¨ï¼Œå¦‚æœè¶…è¿‡ 1 ç§’è¯´æ˜ä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å‡ºç°äº†æ•…éšœ</p>
<hr>
<h4 id="é…ç½®é€‰é¡¹">é…ç½®é€‰é¡¹</h4>
<p>Redis çš„ min-slaves-to-write å’Œ min-slaves-max-lag ä¸¤ä¸ªé€‰é¡¹å¯ä»¥é˜²æ­¢ä¸»æœåŠ¡å™¨åœ¨<strong>ä¸å®‰å…¨çš„æƒ…å†µä¸‹</strong>æ‹’ç»æ‰§è¡Œå†™å‘½ä»¤</p>
<p>æ¯”å¦‚å‘ä¸»æœåŠ¡å™¨è®¾ç½®ï¼š</p>
<ul>
<li>min-slaves-to-writeï¼šä¸»åº“æœ€å°‘æœ‰ N ä¸ªå¥åº·çš„ä»åº“å­˜æ´»æ‰èƒ½æ‰§è¡Œå†™å‘½ä»¤ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„ä»åº“ç›´æ¥æ‹’ç»å†™å…¥</li>
<li>min-slaves-max-lagï¼šä»åº“å’Œä¸»åº“è¿›è¡Œæ•°æ®å¤åˆ¶æ—¶çš„ ACK æ¶ˆæ¯å»¶è¿Ÿçš„æœ€å¤§æ—¶é—´</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">min-slaves-to-write 5</span><br><span class="line">min-slaves-max-lag 10</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆåœ¨ä»æœåŠ¡å™¨çš„æ•°å°‘äº 5 ä¸ªï¼Œæˆ–è€… 5 ä¸ªä»æœåŠ¡å™¨çš„å»¶è¿Ÿï¼ˆlagï¼‰å€¼éƒ½å¤§äºæˆ–ç­‰äº10 ç§’æ—¶ï¼Œä¸»æœåŠ¡å™¨å°†æ‹’ç»æ‰§è¡Œå†™å‘½ä»¤</p>
<hr>
<h4 id="å‘½ä»¤ä¸¢å¤±">å‘½ä»¤ä¸¢å¤±</h4>
<p>æ£€æµ‹å‘½ä»¤ä¸¢å¤±ï¼šç”±äºç½‘ç»œæˆ–è€…å…¶ä»–åŸå› ï¼Œä¸»æœåŠ¡å™¨ä¼ æ’­ç»™ä»æœåŠ¡å™¨çš„å†™å‘½ä»¤ä¸¢å¤±ï¼Œé‚£ä¹ˆå½“ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€ REPLCONF ACK å‘½ä»¤æ—¶ï¼Œä¸»æœåŠ¡å™¨ä¼šæ£€æŸ¥ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡æ˜¯å¦å°äºè‡ªå·±çš„ï¼Œç„¶ååœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œæ‰¾åˆ°ä»æœåŠ¡å™¨ç¼ºå°‘çš„æ•°æ®ï¼Œå¹¶å°†è¿™äº›æ•°æ®é‡æ–°å‘é€ç»™ä»æœåŠ¡å™¨</p>
<p>è¯´æ˜ï¼šREPLCONF ACK å‘½ä»¤å’Œå¤åˆ¶ç§¯å‹ç¼“å†²åŒºéƒ½æ˜¯ Redis 2.8 ç‰ˆæœ¬æ–°å¢çš„ï¼Œåœ¨ Redis 2.8 ç‰ˆæœ¬ä»¥å‰ï¼Œå³ä½¿å‘½ä»¤åœ¨ä¼ æ’­è¿‡ç¨‹ä¸­ä¸¢å¤±ï¼Œä¸»ä»æœåŠ¡å™¨éƒ½ä¸ä¼šæ³¨æ„åˆ°ï¼Œä¹Ÿä¸ä¼šå‘ä»æœåŠ¡å™¨è¡¥å‘ä¸¢å¤±çš„æ•°æ®ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯<strong>ä¸»ä»å¤åˆ¶çš„æ•°æ®ä¸€è‡´æ€§</strong>ï¼Œæœ€å¥½ä½¿ç”¨ 2.8 æˆ–ä»¥ä¸Šç‰ˆæœ¬çš„ Redis</p>
<hr>
<h3 id="å¸¸è§é—®é¢˜">å¸¸è§é—®é¢˜</h3>
<h4 id="é‡å¯æ¢å¤">é‡å¯æ¢å¤</h4>
<p>ç³»ç»Ÿä¸æ–­è¿è¡Œï¼Œmaster çš„æ•°æ®é‡ä¼šè¶Šæ¥è¶Šå¤§ï¼Œä¸€æ—¦ <strong>master é‡å¯</strong>ï¼Œrunid å°†å‘ç”Ÿå˜åŒ–ï¼Œä¼šå¯¼è‡´å…¨éƒ¨ slave çš„å…¨é‡å¤åˆ¶æ“ä½œ</p>
<p>è§£å†³æ–¹æ³•ï¼šæœ¬æœºä¿å­˜ä¸Šæ¬¡ runidï¼Œé‡å¯åæ¢å¤è¯¥å€¼ï¼Œä½¿æ‰€æœ‰ slave è®¤ä¸ºè¿˜æ˜¯ä¹‹å‰çš„ master</p>
<p>ä¼˜åŒ–æ–¹æ¡ˆï¼š</p>
<ul>
<li>
<p>master å†…éƒ¨åˆ›å»º master_replid å˜é‡ï¼Œä½¿ç”¨ runid ç›¸åŒçš„ç­–ç•¥ç”Ÿæˆï¼Œå¹¶å‘é€ç»™æ‰€æœ‰ slave</p>
</li>
<li>
<p>åœ¨ master å…³é—­æ—¶æ‰§è¡Œå‘½ä»¤ <code>shutdown save</code>ï¼Œè¿›è¡Œ RDB æŒä¹…åŒ–ï¼Œå°† runid ä¸ offset ä¿å­˜åˆ° RDB æ–‡ä»¶ä¸­</p>
<p><code>redis-check-rdb dump.rdb</code> å‘½ä»¤å¯ä»¥æŸ¥çœ‹è¯¥ä¿¡æ¯ï¼Œä¿å­˜ä¸º repl-id å’Œ repl-offset</p>
</li>
<li>
<p>master é‡å¯ååŠ è½½ RDB æ–‡ä»¶ï¼Œæ¢å¤æ•°æ®ï¼Œå°† RDB æ–‡ä»¶ä¸­ä¿å­˜çš„ repl-id ä¸ repl-offset åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œmaster_repl_id = repl-idï¼Œmaster_repl_offset = repl-offset</p>
</li>
<li>
<p>é€šè¿‡ info å‘½ä»¤å¯ä»¥æŸ¥çœ‹è¯¥ä¿¡æ¯</p>
</li>
</ul>
<hr>
<h4 id="ç½‘ç»œä¸­æ–­">ç½‘ç»œä¸­æ–­</h4>
<p>master çš„ CPU å ç”¨è¿‡é«˜æˆ– slave é¢‘ç¹æ–­å¼€è¿æ¥</p>
<ul>
<li>
<p>å‡ºç°çš„åŸå› ï¼š</p>
<ul>
<li>slave æ¯ 1 ç§’å‘é€ REPLCONF ACK å‘½ä»¤åˆ° master</li>
<li>å½“ slave æ¥åˆ°äº†æ…¢æŸ¥è¯¢æ—¶ï¼ˆkeys * ï¼Œhgetall ç­‰ï¼‰ï¼Œä¼šå¤§é‡å ç”¨ CPU æ€§èƒ½</li>
<li>master æ¯ 1 ç§’è°ƒç”¨å¤åˆ¶å®šæ—¶å‡½æ•° replicationCron()ï¼Œæ¯”å¯¹ slave å‘ç°é•¿æ—¶é—´æ²¡æœ‰è¿›è¡Œå“åº”</li>
</ul>
<p>æœ€ç»ˆå¯¼è‡´ master å„ç§èµ„æºï¼ˆè¾“å‡ºç¼“å†²åŒºã€å¸¦å®½ã€è¿æ¥ç­‰ï¼‰è¢«ä¸¥é‡å ç”¨</p>
</li>
<li>
<p>è§£å†³æ–¹æ³•ï¼šé€šè¿‡è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œç¡®è®¤æ˜¯å¦é‡Šæ”¾ slave</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repl-timeout	<span class="comment"># è¯¥å‚æ•°å®šä¹‰äº†è¶…æ—¶æ—¶é—´çš„é˜ˆå€¼ï¼ˆé»˜è®¤60ç§’ï¼‰ï¼Œè¶…è¿‡è¯¥å€¼ï¼Œé‡Šæ”¾slave</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>slave ä¸ master è¿æ¥æ–­å¼€</p>
<ul>
<li>
<p>å‡ºç°çš„åŸå› ï¼š</p>
<ul>
<li>master å‘é€ ping æŒ‡ä»¤é¢‘åº¦è¾ƒä½</li>
<li>master è®¾å®šè¶…æ—¶æ—¶é—´è¾ƒçŸ­</li>
<li>ping æŒ‡ä»¤åœ¨ç½‘ç»œä¸­å­˜åœ¨ä¸¢åŒ…</li>
</ul>
</li>
<li>
<p>è§£å†³æ–¹æ³•ï¼šæé«˜ ping æŒ‡ä»¤å‘é€çš„é¢‘åº¦</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repl-ping-slave-period	</span><br></pre></td></tr></table></figure>
<p>è¶…æ—¶æ—¶é—´ repl-time çš„æ—¶é—´è‡³å°‘æ˜¯ ping æŒ‡ä»¤é¢‘åº¦çš„5åˆ°10å€ï¼Œå¦åˆ™ slave å¾ˆå®¹æ˜“åˆ¤å®šè¶…æ—¶</p>
</li>
</ul>
<hr>
<h4 id="ä¸€è‡´æ€§-2">ä¸€è‡´æ€§</h4>
<p>ç½‘ç»œä¿¡æ¯ä¸åŒæ­¥ï¼Œæ•°æ®å‘é€æœ‰å»¶è¿Ÿï¼Œå¯¼è‡´å¤šä¸ª slave è·å–ç›¸åŒæ•°æ®ä¸åŒæ­¥</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li>
<p><strong>ä¼˜åŒ–ä¸»ä»é—´çš„ç½‘ç»œç¯å¢ƒ</strong>ï¼Œé€šå¸¸æ”¾ç½®åœ¨åŒä¸€ä¸ªæœºæˆ¿éƒ¨ç½²ï¼Œå¦‚ä½¿ç”¨é˜¿é‡Œäº‘ç­‰äº‘æœåŠ¡å™¨æ—¶è¦æ³¨æ„æ­¤ç°è±¡</p>
</li>
<li>
<p>ç›‘æ§ä¸»ä»èŠ‚ç‚¹å»¶è¿Ÿï¼ˆé€šè¿‡offsetï¼‰åˆ¤æ–­ï¼Œå¦‚æœ slave å»¶è¿Ÿè¿‡å¤§ï¼Œ<strong>æš‚æ—¶å±è”½ç¨‹åºå¯¹è¯¥ slave çš„æ•°æ®è®¿é—®</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slave-serve-stale-data <span class="built_in">yes</span>|no</span><br></pre></td></tr></table></figure>
<p>å¼€å¯åä»…å“åº” infoã€slaveof ç­‰å°‘æ•°å‘½ä»¤ï¼ˆæ…ç”¨ï¼Œé™¤éå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜ï¼‰</p>
</li>
<li>
<p>å¤šä¸ª slave åŒæ—¶å¯¹ master è¯·æ±‚æ•°æ®åŒæ­¥ï¼Œmaster å‘é€çš„ RDB æ–‡ä»¶å¢å¤šï¼Œä¼šå¯¹å¸¦å®½é€ æˆå·¨å¤§å†²å‡»ï¼Œé€ æˆ master å¸¦å®½ä¸è¶³ï¼Œå› æ­¤æ•°æ®åŒæ­¥éœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œé€‚é‡é”™å³°</p>
</li>
</ul>
<hr>
<h2 id="å“¨å…µæ¨¡å¼">å“¨å…µæ¨¡å¼</h2>
<h3 id="å“¨å…µæ¦‚è¿°">å“¨å…µæ¦‚è¿°</h3>
<p>Sentinelï¼ˆå“¨å…µï¼‰æ˜¯ Redis çš„é«˜å¯ç”¨æ€§ï¼ˆhigh availabilityï¼‰è§£å†³æ–¹æ¡ˆï¼Œç”±ä¸€ä¸ªæˆ–å¤šä¸ª Sentinel å®ä¾‹ instance ç»„æˆçš„ Sentinel ç³»ç»Ÿå¯ä»¥ç›‘è§†ä»»æ„å¤šä¸ªä¸»æœåŠ¡å™¨ï¼Œä»¥åŠè¿™äº›ä¸»æœåŠ¡å™¨çš„æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œå¹¶åœ¨è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨ä¸‹çº¿æ—¶è¿›è¡Œæ•…éšœè½¬ç§»</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å“¨å…µç³»ç»Ÿ.png" style="zoom:67%;" />
<ul>
<li>åŒç¯å›¾æ¡ˆè¡¨ç¤ºä¸»æœåŠ¡å™¨</li>
<li>å•ç¯å›¾æ¡ˆè¡¨ç¤ºä¸‰ä¸ªä»æœåŠ¡å™¨</li>
</ul>
<p>å“¨å…µçš„ä½œç”¨ï¼š</p>
<ul>
<li>
<p>ç›‘æ§ï¼šç›‘æ§ master å’Œ slaveï¼Œä¸æ–­çš„æ£€æŸ¥ master å’Œ slave æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œmaster å­˜æ´»æ£€æµ‹ã€master ä¸ slave è¿è¡Œæƒ…å†µæ£€æµ‹</p>
</li>
<li>
<p>é€šçŸ¥ï¼šå½“è¢«ç›‘æ§çš„æœåŠ¡å™¨å‡ºç°é—®é¢˜æ—¶ï¼Œå‘å…¶ä»–å“¨å…µå‘é€é€šçŸ¥</p>
</li>
<li>
<p>è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼šæ–­å¼€ master ä¸ slave è¿æ¥ï¼Œé€‰å–ä¸€ä¸ª slave ä½œä¸º masterï¼Œå°†å…¶ä»– slave è¿æ¥æ–°çš„ masterï¼Œå¹¶å‘ŠçŸ¥å®¢æˆ·ç«¯æ–°çš„æœåŠ¡å™¨åœ°å€</p>
</li>
</ul>
<hr>
<h3 id="å¯ç”¨å“¨å…µ">å¯ç”¨å“¨å…µ</h3>
<h4 id="é…ç½®æ–¹å¼">é…ç½®æ–¹å¼</h4>
<p>é…ç½®ä¸‰ä¸ªå“¨å…µ sentinel.confï¼šä¸€èˆ¬å¤šä¸ªå“¨å…µé…ç½®ç›¸åŒã€ç«¯å£ä¸åŒï¼Œç‰¹æ®Šéœ€æ±‚å¯ä»¥é…ç½®ä¸åŒçš„å±æ€§</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">port 26401</span><br><span class="line"><span class="built_in">dir</span> <span class="string">&quot;/redis/data&quot;</span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6401 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 5000</span><br><span class="line">sentinel failover-timeout mymaster 20000</span><br><span class="line">sentinel parallel-sync mymaster 1</span><br><span class="line">sentinel deny-scripts-reconfig <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>
<p>é…ç½®è¯´æ˜ï¼š</p>
<ul>
<li>
<p>è®¾ç½®å“¨å…µç›‘å¬çš„ä¸»æœåŠ¡å™¨ä¿¡æ¯ï¼Œåˆ¤æ–­ä¸»è§‚ä¸‹çº¿æ‰€éœ€è¦çš„ç¥¨æ•°</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel monitor &lt;master-name&gt; &lt;master_ip&gt; &lt;master_port&gt; &lt;quorum&gt;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æŒ‡å®šå“¨å…µåœ¨ç›‘æ§ Redis æœåŠ¡æ—¶ï¼Œè®¾ç½®åˆ¤å®šæœåŠ¡å™¨å®•æœºçš„æ—¶é•¿ï¼Œè¯¥è®¾ç½®æ§åˆ¶æ˜¯å¦è¿›è¡Œä¸»ä»åˆ‡æ¢</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel down-after-milliseconds &lt;master-name&gt; &lt;million_seconds&gt;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å‡ºç°æ•…éšœåï¼Œæ•…éšœåˆ‡æ¢çš„æœ€å¤§è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡è¯¥å€¼ï¼Œè®¤å®šåˆ‡æ¢å¤±è´¥ï¼Œé»˜è®¤ 3 åˆ†é’Ÿ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel failover-timeout &lt;master_name&gt; &lt;million_seconds&gt;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ•…éšœè½¬ç§»æ—¶ï¼ŒåŒæ—¶è¿›è¡Œä¸»ä»åŒæ­¥çš„ slave æ•°é‡ï¼Œæ•°å€¼è¶Šå¤§ï¼Œè¦æ±‚ç½‘ç»œèµ„æºè¶Šé«˜</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel parallel-syncs &lt;master_name&gt; &lt;sync_slave_number&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å¯åŠ¨å“¨å…µï¼šæœåŠ¡ç«¯å‘½ä»¤ï¼ˆLinux å‘½ä»¤ï¼‰</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel filename</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="åˆå§‹åŒ–-2">åˆå§‹åŒ–</h4>
<p>Sentinel æœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ç‰¹æ®Šæ¨¡å¼ä¸‹çš„ Redis æœåŠ¡å™¨ï¼Œå½“ä¸€ä¸ª Sentinel å¯åŠ¨æ—¶ï¼Œé¦–å…ˆåˆå§‹åŒ– Redis æœåŠ¡å™¨ï¼Œä½†æ˜¯åˆå§‹åŒ–è¿‡ç¨‹å’Œæ™®é€š Redis æœåŠ¡å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹å¹¶ä¸å®Œå…¨ç›¸åŒï¼Œå“¨å…µ<strong>ä¸æä¾›æ•°æ®ç›¸å…³æœåŠ¡</strong>ï¼Œæ‰€ä»¥ä¸ä¼šè½½å…¥ RDBã€AOF æ–‡ä»¶</p>
<p>æ•´ä½“æµç¨‹ï¼š</p>
<ul>
<li>
<p>åˆå§‹åŒ–æœåŠ¡å™¨</p>
</li>
<li>
<p>å°†æ™®é€š Redis æœåŠ¡å™¨ä½¿ç”¨çš„ä»£ç æ›¿æ¢æˆ Sentinel ä¸“ç”¨ä»£ç </p>
</li>
<li>
<p>åˆå§‹åŒ– Sentinel çŠ¶æ€</p>
</li>
<li>
<p>æ ¹æ®ç»™å®šçš„é…ç½®æ–‡ä»¶ï¼Œåˆå§‹åŒ– Sentinel çš„ç›‘è§†ä¸»æœåŠ¡å™¨åˆ—è¡¨</p>
</li>
<li>
<p>åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥</p>
</li>
</ul>
<hr>
<h4 id="ä»£ç æ›¿æ¢">ä»£ç æ›¿æ¢</h4>
<p>å°†ä¸€éƒ¨åˆ†æ™®é€š Redis æœåŠ¡å™¨ä½¿ç”¨çš„ä»£ç æ›¿æ¢æˆ Sentinel ä¸“ç”¨ä»£ç </p>
<p>Redis æœåŠ¡å™¨ç«¯å£ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> REDIS_SERVERPORT 6379 		<span class="comment">// æ™®é€šæœåŠ¡å™¨ç«¯å£</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> REDIS_SENTINEL_PORT 26379 	<span class="comment">// å“¨å…µç«¯å£</span></span></span><br></pre></td></tr></table></figure>
<p>æœåŠ¡å™¨çš„å‘½ä»¤è¡¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ™®é€š Redis æœåŠ¡å™¨</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisCommand</span> <span class="title">redisCommandTable</span>[] =</span> &#123;</span><br><span class="line">    &#123;<span class="string">&quot;get&quot;</span>, getCommand, <span class="number">2</span>, <span class="string">&quot;r&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;set&quot;</span>, setCommand, <span class="number">-3</span>, <span class="string">&quot;wm&quot;</span>, <span class="number">0</span>, noPreloadGetKeys, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å“¨å…µ</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisCommand</span> <span class="title">sentinelcmds</span>[] =</span> &#123;</span><br><span class="line">    &#123;<span class="string">&quot;ping&quot;</span>, pingCommand, <span class="number">1</span>, <span class="string">&quot;&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;sentinel&quot;</span>, sentinelCommand, <span class="number">-2</span>,<span class="string">&quot;&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;subscribe&quot;</span>,...&#125;, &#123;<span class="string">&quot;unsubscribe&quot;</span>,...O&#125;, &#123;<span class="string">&quot;psubscribe&quot;</span>,...&#125;, &#123;<span class="string">&quot;punsubscribe&quot;</span>,...&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;info&quot;</span>,...&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°è¡¨æ˜¯å“¨å…µæ¨¡å¼ä¸‹å®¢æˆ·ç«¯å¯ä»¥æ‰§è¡Œçš„å‘½ä»¤ï¼Œæ‰€ä»¥å¯¹äº GETã€SET ç­‰å‘½ä»¤ï¼ŒæœåŠ¡å™¨æ ¹æœ¬å°±æ²¡æœ‰è½½å…¥</p>
<hr>
<h4 id="å“¨å…µçŠ¶æ€">å“¨å…µçŠ¶æ€</h4>
<p>æœåŠ¡å™¨ä¼šåˆå§‹åŒ–ä¸€ä¸ª sentinelState ç»“æ„ï¼Œåˆå« Sentinel çŠ¶æ€ï¼Œç»“æ„ä¿å­˜äº†æœåŠ¡å™¨ä¸­æ‰€æœ‰å’Œ Sentinel åŠŸèƒ½æœ‰å…³çš„çŠ¶æ€ï¼ˆæœåŠ¡å™¨çš„ä¸€èˆ¬çŠ¶æ€ä»ç„¶ç”± redisServer ç»“æ„ä¿å­˜ï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sentinelState</span> &#123;</span></span><br><span class="line">    <span class="comment">// å½“å‰çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§»</span></span><br><span class="line">    <span class="type">uint64_t</span> current_epoch; </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ã€ä¿å­˜äº†æ‰€æœ‰è¢«è¿™ä¸ªsentinelç›‘è§†çš„ä¸»æœåŠ¡å™¨ã€‘</span></span><br><span class="line">    dict *masters;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯å¦è¿›å…¥äº† TILT æ¨¡å¼</span></span><br><span class="line">    <span class="type">int</span> tilt;</span><br><span class="line">    <span class="comment">// è¿›å…¥ TILT æ¨¡å¼çš„æ—¶é—´</span></span><br><span class="line">    <span class="type">mstime_t</span> tilt_start_time;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœ€åä¸€æ¬¡æ‰§è¡Œæ—¶é—´å¤„ç†çš„äº‹ä»¶</span></span><br><span class="line">    <span class="type">mstime_t</span> previous_time;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç›®å‰æ­£åœ¨æ‰§è¡Œçš„è„šæœ¬æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> running_scripts;</span><br><span class="line">    <span class="comment">// ä¸€ä¸ªFIFOé˜Ÿåˆ—ï¼ŒåŒ…å«äº†æ‰€æœ‰éœ€è¦æ‰§è¡Œçš„ç”¨æˆ·è„šæœ¬</span></span><br><span class="line">    <span class="built_in">list</span> *scripts_queue;</span><br><span class="line">    </span><br><span class="line">&#125; sentinel;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="ç›‘æ§åˆ—è¡¨">ç›‘æ§åˆ—è¡¨</h4>
<p>Sentinel çŠ¶æ€çš„åˆå§‹åŒ–å°† masters å­—å…¸çš„åˆå§‹åŒ–ï¼Œæ ¹æ®è¢«è½½å…¥çš„ Sentinel é…ç½®æ–‡ä»¶ conf æ¥è¿›è¡Œå±æ€§èµ‹å€¼</p>
<p>Sentinel çŠ¶æ€ä¸­çš„ masters å­—å…¸è®°å½•äº†æ‰€æœ‰è¢« Sentinel ç›‘è§†çš„<strong>ä¸»æœåŠ¡å™¨çš„ç›¸å…³ä¿¡æ¯</strong>ï¼Œå­—å…¸çš„é”®æ˜¯è¢«ç›‘è§†ä¸»æœåŠ¡å™¨çš„åå­—ï¼Œå€¼æ˜¯ä¸»æœåŠ¡å™¨å¯¹åº”çš„å®ä¾‹ç»“æ„</p>
<p>å®ä¾‹ç»“æ„æ˜¯ä¸€ä¸ª sentinelRedisinstance æ•°æ®ç±»å‹ï¼Œä»£è¡¨è¢« Sentinel ç›‘è§†çš„å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹å¯ä»¥æ˜¯ä¸»ã€ä»æœåŠ¡å™¨ï¼Œæˆ–è€…å…¶ä»– Sentinel</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">sentinelRedisinstance</span> &#123;</span></span><br><span class="line">    <span class="comment">// æ ‡è¯†å€¼ï¼Œè®°å½•äº†å®ä¾‹çš„ç±»å‹ï¼Œä»¥åŠè¯¥å®ä¾‹çš„å½“å‰çŠ¶æ€</span></span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å®ä¾‹çš„åå­—ï¼Œä¸»æœåŠ¡å™¨çš„åå­—ç”±ç”¨æˆ·åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼Œ</span></span><br><span class="line">    <span class="comment">// ä»æœåŠ¡å™¨å’Œå“¨å…µçš„åå­—ç”± Sentinel è‡ªåŠ¨è®¾ç½®ï¼Œæ ¼å¼ä¸º ip:portï¼Œä¾‹å¦‚ 127.0.0.1:6379</span></span><br><span class="line">    <span class="type">char</span> *name;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å®ä¾‹è¿è¡Œçš„ ID</span></span><br><span class="line">    <span class="type">char</span> *runid;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é…ç½®çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§»</span></span><br><span class="line">    <span class="type">uint64_t</span> config_epoch;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å®ä¾‹åœ°å€</span></span><br><span class="line">    sentinelAddr *addr; </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰å®ä¾‹æ—¶ä¸»æœåŠ¡å™¨ï¼Œè¯¥å­—æ®µä¿å­˜ä»æœåŠ¡å™¨ä¿¡æ¯ï¼Œé”®æ˜¯åå­—æ ¼å¼ä¸º ip:portï¼Œå€¼æ˜¯å®ä¾‹ç»“æ„</span></span><br><span class="line">    dict *slaves;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰€æœ‰ç›‘è§†å½“å‰æœåŠ¡å™¨çš„ Sentinel å®ä¾‹ï¼Œé”®æ˜¯åå­—æ ¼å¼ä¸º ip:portï¼Œå€¼æ˜¯å®ä¾‹ç»“æ„</span></span><br><span class="line">    dict *sentinels;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// sentinel down-after-milliseconds çš„å€¼ï¼Œè¡¨ç¤ºå®ä¾‹æ— å“åº”å¤šå°‘æ¯«ç§’åä¼šè¢«åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿(subjectively down) </span></span><br><span class="line">    <span class="type">mstime_t</span> down_after_period;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// sentinel monitor é€‰é¡¹ä¸­çš„quorumå‚æ•°ï¼Œåˆ¤æ–­è¿™ä¸ªå®ä¾‹ä¸ºå®¢è§‚ä¸‹çº¿(objectively down)æ‰€éœ€çš„æ”¯æŒæŠ•ç¥¨æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> quorum;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// sentinel parallel-syncs çš„å€¼ï¼Œåœ¨æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œæ—¶ï¼Œå¯ä»¥åŒæ—¶å¯¹æ–°çš„ä¸»æœåŠ¡å™¨è¿›è¡ŒåŒæ­¥çš„ä»æœåŠ¡å™¨æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> parallel-syncs;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// sentinel failover-timeoutçš„å€¼ï¼Œåˆ·æ–°æ•…éšœè¿ç§»çŠ¶æ€çš„æœ€å¤§æ—¶é™</span></span><br><span class="line">    <span class="type">mstime_t</span> failover_timeout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>addr å±æ€§æ˜¯ä¸€ä¸ªæŒ‡å‘ sentinelAddr çš„æŒ‡é’ˆï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">sentinelAddr</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> *ip;</span><br><span class="line">    <span class="type">int</span> port;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="ç½‘ç»œè¿æ¥">ç½‘ç»œè¿æ¥</h4>
<p>åˆå§‹åŒ– Sentinel çš„æœ€åä¸€æ­¥æ˜¯åˆ›å»ºè¿å‘è¢«ç›‘è§†ä¸»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥ï¼ŒSentinel å°†æˆä¸ºä¸»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ï¼Œå¯ä»¥å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼Œå¹¶ä»å‘½ä»¤å›å¤ä¸­è·å–ç›¸å…³çš„ä¿¡æ¯</p>
<p>æ¯ä¸ªè¢« Sentinel ç›‘è§†çš„ä¸»æœåŠ¡å™¨ï¼ŒSentinel ä¼šåˆ›å»ºä¸¤ä¸ªè¿å‘ä¸»æœåŠ¡å™¨çš„<strong>å¼‚æ­¥ç½‘ç»œè¿æ¥</strong>ï¼š</p>
<ul>
<li>å‘½ä»¤è¿æ¥ï¼šç”¨äºå‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼Œå¹¶æ¥æ”¶å‘½ä»¤å›å¤</li>
<li>è®¢é˜…è¿æ¥ï¼šç”¨äºè®¢é˜…ä¸»æœåŠ¡å™¨çš„ <code>_sentinel_:hello</code> é¢‘é“</li>
</ul>
<p>å»ºç«‹ä¸¤ä¸ªè¿æ¥çš„åŸå› ï¼š</p>
<ul>
<li>
<p>åœ¨ Redis ç›®å‰çš„å‘å¸ƒä¸è®¢é˜…åŠŸèƒ½ä¸­ï¼Œè¢«å‘é€çš„ä¿¡æ¯éƒ½ä¸ä¼šä¿å­˜åœ¨ Redis æœåŠ¡å™¨é‡Œï¼Œ å¦‚æœåœ¨ä¿¡æ¯å‘é€æ—¶æ¥æ”¶ä¿¡æ¯çš„å®¢æˆ·ç«¯ç¦»çº¿æˆ–æ–­çº¿ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¢æˆ·ç«¯å°±ä¼šä¸¢å¤±è¿™æ¡ä¿¡æ¯ï¼Œä¸ºäº†ä¸ä¸¢å¤± hello é¢‘é“çš„ä»»ä½•ä¿¡æ¯ï¼ŒSentinel å¿…é¡»ç”¨ä¸€ä¸ªè®¢é˜…è¿æ¥æ¥æ¥æ”¶è¯¥é¢‘é“çš„ä¿¡æ¯</p>
</li>
<li>
<p>Sentinel è¿˜å¿…é¡»å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼Œä»¥æ­¤æ¥ä¸ä¸»æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œæ‰€ä»¥ Sentinel è¿˜å¿…é¡»å‘ä¸»æœåŠ¡å™¨åˆ›å»ºå‘½ä»¤è¿æ¥</p>
</li>
</ul>
<p>è¯´æ˜ï¼šæ–­çº¿çš„æ„æ€å°±æ˜¯ç½‘ç»œè¿æ¥æ–­å¼€</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%93%A8%E5%85%B5%E7%B3%BB%E7%BB%9F%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5.png" alt=""></p>
<hr>
<h3 id="ä¿¡æ¯äº¤äº’">ä¿¡æ¯äº¤äº’</h3>
<h4 id="è·å–ä¿¡æ¯">è·å–ä¿¡æ¯</h4>
<h5 id="ä¸»æœåŠ¡å™¨">ä¸»æœåŠ¡å™¨</h5>
<p>Sentinel é»˜è®¤ä¼šä»¥æ¯åç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œé€šè¿‡å‘½ä»¤è¿æ¥å‘è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨å‘é€ INFO å‘½ä»¤ï¼Œæ¥è·å–ä¸»æœåŠ¡å™¨çš„ä¿¡æ¯</p>
<ul>
<li>ä¸€éƒ¨åˆ†æ˜¯ä¸»æœåŠ¡å™¨æœ¬èº«çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ runid åŸŸè®°å½•çš„æœåŠ¡å™¨è¿è¡Œ IDï¼Œä»¥åŠ role åŸŸè®°å½•çš„æœåŠ¡å™¨è§’è‰²</li>
<li>å¦ä¸€éƒ¨åˆ†æ˜¯æœåŠ¡å™¨å±ä¸‹æ‰€æœ‰ä»æœåŠ¡å™¨çš„ä¿¡æ¯ï¼Œæ¯ä¸ªä»æœåŠ¡å™¨éƒ½ç”±ä¸€ä¸ª slave å­—ç¬¦ä¸²å¼€å¤´çš„è¡Œè®°å½•ï¼Œæ ¹æ®è¿™äº› IP åœ°å€å’Œç«¯å£å·ï¼ŒSentinel æ— é¡»ç”¨æˆ·æä¾›ä»æœåŠ¡å™¨çš„åœ°å€ä¿¡æ¯ï¼Œå°±å¯ä»¥<strong>è‡ªåŠ¨å‘ç°ä»æœåŠ¡å™¨</strong></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Server </span></span><br><span class="line">run_id:76llc59dc3a29aa6fa0609f84lbb6al019008a9c</span><br><span class="line">...</span><br><span class="line"><span class="comment"># Replication </span></span><br><span class="line">role:master </span><br><span class="line">...</span><br><span class="line">slave0: ip=l27.0.0.1, port=11111, state=online, offset=22, lag=0</span><br><span class="line">slave1: ip=l27.0.0.1, port=22222, state=online, offset=22, lag=0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>æ ¹æ® run_id å’Œ role è®°å½•çš„ä¿¡æ¯ Sentinel å°†å¯¹ä¸»æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ›´æ–°ï¼Œæ¯”å¦‚ä¸»æœåŠ¡å™¨é‡å¯ä¹‹åï¼Œè¿è¡Œ ID å°±ä¼šå’Œå®ä¾‹ç»“æ„ä¹‹å‰ä¿å­˜çš„è¿è¡Œ ID ä¸åŒï¼Œå“¨å…µæ£€æµ‹åˆ°è¿™ä¸€æƒ…å†µä¹‹åå°±ä¼šå¯¹å®ä¾‹ç»“æ„çš„è¿è¡Œ ID è¿›è¡Œæ›´æ–°</p>
<p>å¯¹äºä¸»æœåŠ¡å™¨è¿”å›çš„ä»æœåŠ¡å™¨ä¿¡æ¯ï¼Œç”¨å®ä¾‹ç»“æ„çš„ slaves å­—å…¸è®°å½•äº†ä»æœåŠ¡å™¨çš„ä¿¡æ¯ï¼š</p>
<ul>
<li>å¦‚æœä»æœåŠ¡å™¨å¯¹åº”çš„å®ä¾‹ç»“æ„å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆ Sentinel å¯¹ä»æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ›´æ–°</li>
<li>å¦‚æœä¸å­˜åœ¨ï¼Œä¸ºè¿™ä¸ªä»æœåŠ¡å™¨æ–°åˆ›å»ºä¸€ä¸ªå®ä¾‹ç»“æ„åŠ å…¥å­—å…¸ï¼Œå­—å…¸é”®ä¸º <code>ip:port</code></li>
</ul>
<hr>
<h5 id="ä»æœåŠ¡å™¨">ä»æœåŠ¡å™¨</h5>
<p>å½“ Sentinel å‘ç°ä¸»æœåŠ¡å™¨æœ‰æ–°çš„ä»æœåŠ¡å™¨å‡ºç°æ—¶ï¼Œä¼šä¸ºè¿™ä¸ªæ–°çš„ä»æœåŠ¡å™¨åˆ›å»ºç›¸åº”çš„å®ä¾‹ç»“æ„ï¼Œè¿˜ä¼š<strong>åˆ›å»ºåˆ°ä»æœåŠ¡å™¨çš„å‘½ä»¤è¿æ¥å’Œè®¢é˜…è¿æ¥</strong>ï¼Œæ‰€ä»¥ Sentinel å¯¹æ‰€æœ‰çš„ä»æœåŠ¡å™¨ä¹‹é—´éƒ½å¯ä»¥è¿›è¡Œå‘½ä»¤æ“ä½œ</p>
<p>Sentinel é»˜è®¤ä¼šä»¥æ¯åç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œå‘ä»æœåŠ¡å™¨å‘é€ INFO å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Server </span></span><br><span class="line">run_id:76llc59dc3a29aa6fa0609f84lbb6al019008a9c	<span class="comment">#ä»æœåŠ¡å™¨çš„è¿è¡Œ id</span></span><br><span class="line">...</span><br><span class="line"><span class="comment"># Replication </span></span><br><span class="line">role:slave 				<span class="comment"># ä»æœåŠ¡å™¨è§’è‰²</span></span><br><span class="line">...</span><br><span class="line">master_host:127.0.0.1 	<span class="comment"># ä¸»æœåŠ¡å™¨çš„ ip</span></span><br><span class="line">master_port:6379 		<span class="comment"># ä¸»æœåŠ¡å™¨çš„ port</span></span><br><span class="line">master_link_status:up 	<span class="comment"># ä¸»ä»æœåŠ¡å™¨çš„è¿æ¥çŠ¶æ€</span></span><br><span class="line">slave_repl_offset:11111	<span class="comment"># ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»èœ‡</span></span><br><span class="line">slave_priority:100 		<span class="comment"># ä»æœåŠ¡å™¨çš„ä¼˜å…ˆçº§</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ä¼˜å…ˆçº§å±æ€§</strong>åœ¨æ•…éšœè½¬ç§»æ—¶ä¼šç”¨åˆ°</li>
</ul>
<p>æ ¹æ®è¿™äº›ä¿¡æ¯ï¼ŒSentinel ä¼šå¯¹ä»æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ›´æ–°</p>
<hr>
<h4 id="å‘é€ä¿¡æ¯">å‘é€ä¿¡æ¯</h4>
<p>Sentinel åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šä»¥æ¯ä¸¤ç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œé€šè¿‡å‘½ä»¤è¿æ¥å‘æ‰€æœ‰è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨å‘é€ä»¥ä¸‹æ ¼å¼çš„å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUBLISH _sentinel_:hello <span class="string">&quot;&lt;s_ip&gt;, &lt;s_port&gt;, &lt;s_runid&gt;, &lt;s_epoch&gt;, &lt;m_name&gt;, &lt;m_ip&gt;, &lt;m_port&gt;, &lt;m_epoch&gt;</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ¡å‘½ä»¤å‘æœåŠ¡å™¨çš„ <code>_sentinel_:hello</code> é¢‘é“å‘é€äº†ä¸€æ¡ä¿¡æ¯ï¼Œä¿¡æ¯çš„å†…å®¹ç”±å¤šä¸ªå‚æ•°ç»„æˆï¼š</p>
<ul>
<li>ä»¥ s_ å¼€å¤´çš„å‚æ•°è®°å½•çš„æ˜¯ Sentinel æœ¬èº«çš„ä¿¡æ¯</li>
<li>ä»¥ m_ å¼€å¤´çš„å‚æ•°è®°å½•çš„åˆ™æ˜¯ä¸»æœåŠ¡å™¨çš„ä¿¡æ¯</li>
</ul>
<p>è¯´æ˜ï¼š<strong>é€šè¿‡å‘½ä»¤è¿æ¥å‘é€çš„é¢‘é“ä¿¡æ¯</strong></p>
<hr>
<h4 id="æ¥å—ä¿¡æ¯">æ¥å—ä¿¡æ¯</h4>
<h5 id="è®¢é˜…é¢‘é“">è®¢é˜…é¢‘é“</h5>
<p>Sentinel ä¸ä¸€ä¸ªä¸»æˆ–ä»æœåŠ¡å™¨å»ºç«‹èµ·è®¢é˜…è¿æ¥ä¹‹åï¼Œå°±ä¼šé€šè¿‡è®¢é˜…è¿æ¥å‘æœåŠ¡å™¨å‘é€è®¢é˜…å‘½ä»¤ï¼Œé¢‘é“çš„è®¢é˜…ä¼šä¸€ç›´æŒç»­åˆ° Sentinel ä¸æœåŠ¡å™¨çš„è¿æ¥æ–­å¼€ä¸ºæ­¢</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SUBSCRIBE _sentinel_:hello</span><br></pre></td></tr></table></figure>
<p>è®¢é˜…æˆåŠŸåï¼ŒSentinel å°±å¯ä»¥é€šè¿‡è®¢é˜…è¿æ¥ä»æœåŠ¡å™¨çš„ <code>_sentinel_:hello</code> é¢‘é“æ¥æ”¶ä¿¡æ¯ï¼Œå¯¹æ¶ˆæ¯åˆ†æï¼š</p>
<ul>
<li>å¦‚æœä¿¡æ¯ä¸­è®°å½•çš„ Sentinel è¿è¡Œ ID ä¸è‡ªå·±çš„ç›¸åŒï¼Œä¸åšè¿›ä¸€æ­¥å¤„ç†</li>
<li>å¦‚æœä¸åŒï¼Œå°†æ ¹æ®ä¿¡æ¯ä¸­çš„å„ä¸ªå‚æ•°ï¼Œå¯¹ç›¸åº”ä¸»æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ›´æ–°</li>
</ul>
<p>Sentinel ä¸ºä¸»æœåŠ¡å™¨åˆ›å»ºçš„å®ä¾‹ç»“æ„çš„ sentinels å­—å…¸ä¿å­˜æ‰€æœ‰åŒæ ·ç›‘è§†è¿™ä¸ª<strong>ä¸»æœåŠ¡å™¨çš„ Sentinel ä¿¡æ¯</strong>ï¼ˆåŒ…æ‹¬ Sentinel è‡ªå·±ï¼‰ï¼Œå­—å…¸çš„é”®æ˜¯ Sentinel çš„åå­—ï¼Œæ ¼å¼ä¸º <code>ip:port</code>ï¼Œå€¼æ˜¯é”®æ‰€å¯¹åº” Sentinel çš„å®ä¾‹ç»“æ„</p>
<p>ç›‘è§†åŒä¸€ä¸ªæœåŠ¡å™¨çš„ Sentinel è®¢é˜…çš„é¢‘é“ç›¸åŒï¼ŒSentinel å‘é€çš„ä¿¡æ¯ä¼šè¢«å…¶ä»– Sentinel æ¥æ”¶åˆ°ï¼ˆå‘é€ä¿¡æ¯çš„ä¸ºæº Sentinelï¼Œæ¥æ”¶ä¿¡æ¯çš„ä¸ºç›®æ ‡ Sentinelï¼‰ï¼Œç›®æ ‡ Sentinel åœ¨è‡ªå·±çš„ sentinelState.masters ä¸­æŸ¥æ‰¾æº Sentinel æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ·»åŠ æˆ–æ›´æ–°</p>
<p>å› ä¸º Sentinel å¯ä»¥æ¥æ”¶åˆ°çš„é¢‘é“ä¿¡æ¯æ¥æ„ŸçŸ¥å…¶ä»– Sentinel çš„å­˜åœ¨ï¼Œå¹¶é€šè¿‡å‘é€é¢‘é“ä¿¡æ¯æ¥è®©å…¶ä»– Sentinel çŸ¥é“è‡ªå·±çš„å­˜åœ¨ï¼Œæ‰€ä»¥ç”¨æˆ·åœ¨ä½¿ç”¨ Sentinel æ—¶å¹¶ä¸éœ€è¦æä¾›å„ä¸ª Sentinel çš„åœ°å€ä¿¡æ¯ï¼Œ<strong>ç›‘è§†åŒä¸€ä¸ªä¸»æœåŠ¡å™¨çš„å¤šä¸ª Sentinel å¯ä»¥ç›¸äº’å‘ç°å¯¹æ–¹</strong></p>
<p>å“¨å…µå®ä¾‹ä¹‹é—´å¯ä»¥ç›¸äº’å‘ç°ï¼Œè¦å½’åŠŸäº Redis æä¾›å‘å¸ƒè®¢é˜…æœºåˆ¶</p>
<hr>
<h5 id="å‘½ä»¤è¿æ¥">å‘½ä»¤è¿æ¥</h5>
<p>Sentinel é€šè¿‡é¢‘é“ä¿¡æ¯å‘ç°æ–°çš„ Sentinelï¼Œé™¤äº†åˆ›å»ºå®ä¾‹ç»“æ„ï¼Œè¿˜ä¼šåˆ›å»ºä¸€ä¸ªè¿å‘æ–° Sentinel çš„å‘½ä»¤è¿æ¥ï¼Œè€Œæ–° Sentinel ä¹ŸåŒæ ·ä¼šåˆ›å»ºè¿å‘è¿™ä¸ª Sentinel çš„å‘½ä»¤è¿æ¥ï¼Œæœ€ç»ˆç›‘è§†åŒä¸€ä¸»æœåŠ¡å™¨çš„å¤šä¸ª Sentinel å°†å½¢æˆç›¸äº’è¿æ¥çš„ç½‘ç»œ</p>
<p>ä½œç”¨ï¼š<strong>é€šè¿‡å‘½ä»¤è¿æ¥ç›¸è¿çš„å„ä¸ª Sentinel</strong> å¯ä»¥å‘å…¶ä»– Sentinel å‘é€å‘½ä»¤è¯·æ±‚æ¥è¿›è¡Œä¿¡æ¯äº¤æ¢</p>
<p>Sentinel ä¹‹é—´ä¸ä¼šåˆ›å»ºè®¢é˜…è¿æ¥ï¼š</p>
<ul>
<li>Sentinel éœ€è¦é€šè¿‡æ¥æ”¶ä¸»æœåŠ¡å™¨æˆ–è€…ä»æœåŠ¡å™¨å‘æ¥çš„é¢‘é“ä¿¡æ¯æ¥å‘ç°æœªçŸ¥çš„æ–° Sentinelï¼Œæ‰€ä»¥æ‰åˆ›å»ºè®¢é˜…è¿æ¥</li>
<li>ç›¸äº’å·²çŸ¥çš„ Sentinel åªè¦ä½¿ç”¨å‘½ä»¤è¿æ¥æ¥è¿›è¡Œé€šä¿¡å°±è¶³å¤Ÿäº†</li>
</ul>
<hr>
<h3 id="ä¸‹çº¿æ£€æµ‹">ä¸‹çº¿æ£€æµ‹</h3>
<h4 id="ä¸»è§‚ä¸‹çº¿">ä¸»è§‚ä¸‹çº¿</h4>
<p>Sentinel åœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡å‘æ‰€æœ‰ä¸å®ƒåˆ›å»ºäº†å‘½ä»¤è¿æ¥çš„å®ä¾‹ï¼ˆåŒ…æ‹¬ä¸»ä»æœåŠ¡å™¨ã€å…¶ä»– Sentinelï¼‰å‘é€ PING å‘½ä»¤ï¼Œé€šè¿‡å®ä¾‹è¿”å›çš„ PING å‘½ä»¤å›å¤æ¥åˆ¤æ–­å®ä¾‹æ˜¯å¦åœ¨çº¿</p>
<ul>
<li>æœ‰æ•ˆå›å¤ï¼šå®ä¾‹è¿”å› +PONGã€-LOADINGã€-MASTERDOWN ä¸‰ç§å›å¤çš„å…¶ä¸­ä¸€ç§</li>
<li>æ— æ•ˆå›å¤ï¼šå®ä¾‹è¿”å›é™¤ä¸Šè¿°ä¸‰ç§ä»¥å¤–çš„ä»»ä½•æ•°æ®</li>
</ul>
<p>Sentinel é…ç½®æ–‡ä»¶ä¸­ down-after-milliseconds é€‰é¡¹æŒ‡å®šäº†åˆ¤æ–­å®ä¾‹è¿›å…¥ä¸»è§‚ä¸‹çº¿æ‰€éœ€çš„æ—¶é•¿ï¼Œå¦‚æœä¸»æœåŠ¡å™¨åœ¨è¯¥æ—¶é—´å†…ä¸€ç›´å‘ Sentinel è¿”å›æ— æ•ˆå›å¤ï¼ŒSentinel å°±ä¼šåœ¨è¯¥æœåŠ¡å™¨å¯¹åº”å®ä¾‹ç»“æ„çš„ flags å±æ€§æ‰“å¼€ SRI_S_DOWN æ ‡è¯†ï¼Œè¡¨ç¤ºè¯¥ä¸»æœåŠ¡å™¨è¿›å…¥ä¸»è§‚ä¸‹çº¿çŠ¶æ€</p>
<p>é…ç½®çš„ down-after-milliseconds å€¼ä¸ä»…é€‚ç”¨äºä¸»æœåŠ¡å™¨ï¼Œè¿˜ä¼šè¢«ç”¨äºå½“å‰ Sentinel åˆ¤æ–­ä¸»æœåŠ¡å™¨å±ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œä»¥åŠæ‰€æœ‰åŒæ ·ç›‘è§†è¿™ä¸ªä¸»æœåŠ¡å™¨çš„å…¶ä»– Sentinel çš„ä¸»è§‚ä¸‹çº¿çŠ¶æ€</p>
<p>æ³¨æ„ï¼šå¯¹äºç›‘è§†åŒä¸€ä¸ªä¸»æœåŠ¡å™¨çš„å¤šä¸ª Sentinel æ¥è¯´ï¼Œè®¾ç½®çš„ down-after-milliseconds é€‰é¡¹çš„å€¼å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥å½“ä¸€ä¸ª Sentinel å°†ä¸»æœåŠ¡å™¨åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿æ—¶ï¼Œå…¶ä»– Sentinel å¯èƒ½ä»ç„¶ä¼šè®¤ä¸ºä¸»æœåŠ¡å™¨å¤„äºåœ¨çº¿çŠ¶æ€</p>
<hr>
<h4 id="å®¢è§‚ä¸‹çº¿">å®¢è§‚ä¸‹çº¿</h4>
<p>å½“ Sentinel å°†ä¸€ä¸ªä¸»æœåŠ¡å™¨åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿ä¹‹åï¼Œä¼šå‘åŒæ ·ç›‘è§†è¿™ä¸€ä¸»æœåŠ¡å™¨çš„å…¶ä»– Sentinel è¿›è¡Œè¯¢é—®</p>
<p>Sentinel ä½¿ç”¨å‘½ä»¤è¯¢é—®å…¶ä»– Sentinel æ˜¯å¦åŒæ„ä¸»æœåŠ¡å™¨å·²ä¸‹çº¿ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SENTINEL is-master-down-by-addr &lt;ip&gt; &lt;port&gt; &lt;current_epoch&gt; &lt;runid&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>ipï¼šè¢« Sentinel åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨çš„ IP åœ°å€</li>
<li>portï¼šè¢« Sentinel åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨çš„ç«¯å£å·</li>
<li>current_epochï¼šSentinel å½“å‰çš„é…ç½®çºªå…ƒï¼Œç”¨äºé€‰ä¸¾é¢†å¤´ Sentinel</li>
<li>runidï¼šå–å€¼ä¸º * ç¬¦å·ä»£è¡¨å‘½ä»¤ä»…ä»…ç”¨äºæ£€æµ‹ä¸»æœåŠ¡å™¨çš„å®¢è§‚ä¸‹çº¿çŠ¶æ€ï¼›å–å€¼ä¸º Sentinel çš„è¿è¡Œ ID åˆ™ç”¨äºé€‰ä¸¾é¢†å¤´ Sentinel</li>
</ul>
<p>ç›®æ ‡ Sentinel æ¥æ”¶åˆ°æº Sentinel çš„å‘½ä»¤æ—¶ï¼Œä¼šæ ¹æ®å‚æ•°çš„ lP å’Œç«¯å£å·ï¼Œæ£€æŸ¥ä¸»æœåŠ¡å™¨æ˜¯å¦å·²ä¸‹çº¿ï¼Œç„¶åè¿”å›ä¸€æ¡åŒ…å«ä¸‰ä¸ªå‚æ•°çš„ Multi Bulk å›å¤ï¼š</p>
<ul>
<li>down_stateï¼šè¿”å›ç›®æ ‡ Sentinel å¯¹æœåŠ¡å™¨çš„æ£€æŸ¥ç»“æœï¼Œ1 ä»£è¡¨ä¸»æœåŠ¡å™¨å·²ä¸‹çº¿ï¼Œ0 ä»£è¡¨æœªä¸‹çº¿</li>
<li>leader_runidï¼šå–å€¼ä¸º * ç¬¦å·ä»£è¡¨å‘½ä»¤ä»…ç”¨äºæ£€æµ‹æœåŠ¡å™¨çš„ä¸‹çº¿çŠ¶æ€ï¼›è€Œå±€éƒ¨é¢†å¤´ Sentinel çš„è¿è¡Œ ID åˆ™ç”¨äºé€‰ä¸¾é¢†å¤´ Sentinel</li>
<li>leader_epochï¼šç›®æ ‡ Sentinel çš„å±€éƒ¨é¢†å¤´ Sentinel çš„é…ç½®çºªå…ƒ</li>
</ul>
<p>æº Sentinel å°†ç»Ÿè®¡å…¶ä»– Sentinel åŒæ„ä¸»æœåŠ¡å™¨å·²ä¸‹çº¿çš„æ•°é‡ï¼Œå½“è¿™ä¸€æ•°é‡è¾¾åˆ°é…ç½®æŒ‡å®šçš„åˆ¤æ–­å®¢è§‚ä¸‹çº¿æ‰€éœ€çš„æ•°é‡ï¼ˆquorumï¼‰æ—¶ï¼ŒSentinel ä¼šå°†ä¸»æœåŠ¡å™¨å¯¹åº”å®ä¾‹ç»“æ„ flags å±æ€§çš„ SRI_O_DOWN æ ‡è¯†æ‰“å¼€ï¼Œä»£è¡¨å®¢è§‚ä¸‹çº¿ï¼Œå¹¶å¯¹ä¸»æœåŠ¡å™¨æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œ</p>
<p>æ³¨æ„ï¼š<strong>ä¸åŒ Sentinel åˆ¤æ–­å®¢è§‚ä¸‹çº¿çš„æ¡ä»¶å¯èƒ½ä¸åŒ</strong>ï¼Œå› ä¸ºè½½å…¥çš„é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§ quorum å¯èƒ½ä¸åŒ</p>
<hr>
<h3 id="é¢†å¤´é€‰ä¸¾">é¢†å¤´é€‰ä¸¾</h3>
<p>ä¸»æœåŠ¡å™¨è¢«åˆ¤æ–­ä¸ºå®¢è§‚ä¸‹çº¿æ—¶ï¼Œ<strong>ç›‘è§†è¯¥ä¸»æœåŠ¡å™¨çš„å„ä¸ª Sentinel ä¼šè¿›è¡Œåå•†</strong>ï¼Œé€‰ä¸¾å‡ºä¸€ä¸ªé¢†å¤´ Sentinel å¯¹ä¸‹çº¿æœåŠ¡å™¨æ‰§è¡Œæ•…éšœè½¬ç§»</p>
<p>Redis é€‰ä¸¾é¢†å¤´ Sentinel çš„è§„åˆ™ï¼š</p>
<ul>
<li>
<p>æ‰€æœ‰åœ¨çº¿çš„ Sentinel éƒ½æœ‰è¢«é€‰ä¸ºé¢†å¤´ Sentinel çš„èµ„æ ¼</p>
</li>
<li>
<p>æ¯ä¸ªå‘ç°ä¸»æœåŠ¡å™¨è¿›å…¥å®¢è§‚ä¸‹çº¿çš„ Sentinel éƒ½ä¼šè¦æ±‚å…¶ä»– Sentinel å°†è‡ªå·±è®¾ç½®ä¸ºå±€éƒ¨é¢†å¤´ Sentinel</p>
</li>
<li>
<p>åœ¨ä¸€ä¸ªé…ç½®çºªå…ƒé‡Œï¼Œæ‰€æœ‰ Sentinel éƒ½åªæœ‰ä¸€æ¬¡å°†æŸä¸ª Sentinel è®¾ç½®ä¸ºå±€éƒ¨é¢†å¤´ Sentinel çš„æœºä¼šï¼Œå¹¶ä¸”å±€éƒ¨é¢†å¤´ä¸€æ—¦è®¾ç½®ï¼Œåœ¨è¿™ä¸ªé…ç½®çºªå…ƒé‡Œå°±ä¸èƒ½å†æ›´æ”¹</p>
</li>
<li>
<p>Sentinel è®¾ç½®å±€éƒ¨é¢†å¤´ Sentinel çš„è§„åˆ™æ˜¯å…ˆåˆ°å…ˆå¾—ï¼Œæœ€å…ˆå‘ç›®æ ‡ Sentinel å‘é€è®¾ç½®è¦æ±‚çš„æº Sentinel å°†æˆä¸ºç›®æ ‡ Sentinel çš„å±€éƒ¨é¢†å¤´ Sentinelï¼Œä¹‹åæ¥æ”¶åˆ°çš„æ‰€æœ‰è®¾ç½®è¦æ±‚éƒ½ä¼šè¢«ç›®æ ‡ Sentinel æ‹’ç»</p>
</li>
<li>
<p>é¢†å¤´ Sentinel çš„äº§ç”Ÿ<strong>éœ€è¦åŠæ•°ä»¥ä¸Š Sentinel çš„æ”¯æŒ</strong>ï¼Œå¹¶ä¸”æ¯ä¸ª Sentinel åªæœ‰ä¸€ç¥¨ï¼Œæ‰€ä»¥ä¸€ä¸ªé…ç½®çºªå…ƒåªä¼šå‡ºç°ä¸€ä¸ªé¢†å¤´ Sentinelï¼Œæ¯”å¦‚ 10 ä¸ª Sentinel çš„ç³»ç»Ÿä¸­ï¼Œè‡³å°‘éœ€è¦ <code>10/2 + 1 = 6</code> ç¥¨</p>
</li>
</ul>
<p>é€‰ä¸¾è¿‡ç¨‹ï¼š</p>
<ul>
<li>ä¸€ä¸ª Sentinel å‘ç›®æ ‡ Sentinel å‘é€ <code>SENTINEL is-master-down-by-addr</code> å‘½ä»¤ï¼Œå‘½ä»¤ä¸­çš„ runid å‚æ•°ä¸æ˜¯ï¼Šç¬¦å·è€Œæ˜¯æº Sentinel çš„è¿è¡Œ IDï¼Œè¡¨ç¤ºæº Sentinel è¦æ±‚ç›®æ ‡ Sentinel å°†è‡ªå·±è®¾ç½®ä¸ºå®ƒçš„å±€éƒ¨é¢†å¤´ Sentinel</li>
<li>ç›®æ ‡ Sentinel æ¥å—å‘½ä»¤å¤„ç†å®Œæˆåï¼Œå°†è¿”å›ä¸€æ¡å‘½ä»¤å›å¤ï¼Œå›å¤ä¸­çš„ leader_runid å’Œ leader_epoch å‚æ•°åˆ†åˆ«è®°å½•äº†ç›®æ ‡ Sentinel çš„å±€éƒ¨é¢†å¤´ Sentinel çš„è¿è¡Œ ID å’Œé…ç½®çºªå…ƒ</li>
<li>æº Sentinel æ¥æ”¶ç›®æ ‡ Sentinel å‘½ä»¤å›å¤ä¹‹åï¼Œä¼šåˆ¤æ–­ leader_epoch æ˜¯å¦å’Œè‡ªå·±çš„ç›¸åŒï¼Œç›¸åŒå°±ç»§ç»­åˆ¤æ–­ leader_runid æ˜¯å¦å’Œè‡ªå·±çš„è¿è¡Œ ID ä¸€è‡´ï¼Œæˆç«‹è¡¨ç¤ºç›®æ ‡ Sentinel å°†æº Sentinel è®¾ç½®æˆäº†å±€éƒ¨é¢†å¤´ Sentinelï¼Œå³è·å¾—ä¸€ç¥¨</li>
<li>å¦‚æœæŸä¸ª Sentinel è¢«åŠæ•°ä»¥ä¸Šçš„ Sentinel è®¾ç½®æˆäº†å±€éƒ¨é¢†å¤´ Sentinelï¼Œé‚£ä¹ˆè¿™ä¸ª Sentinel æˆä¸ºé¢†å¤´ Sentinel</li>
<li>å¦‚æœåœ¨ç»™å®šæ—¶é™å†…ï¼Œæ²¡æœ‰ä¸€ä¸ª Sentinel è¢«é€‰ä¸¾ä¸ºé¢†å¤´ Sentinelï¼Œé‚£ä¹ˆå„ä¸ª Sentinel å°†åœ¨ä¸€æ®µæ—¶é—´å<strong>å†æ¬¡é€‰ä¸¾</strong>ï¼Œç›´åˆ°é€‰å‡ºé¢†å¤´</li>
<li>æ¯æ¬¡è¿›è¡Œé¢†å¤´ Sentinel é€‰ä¸¾ä¹‹åï¼Œä¸è®ºé€‰ä¸¾æ˜¯å¦æˆåŠŸï¼Œæ‰€æœ‰ Sentinel çš„é…ç½®çºªå…ƒï¼ˆconfiguration epochï¼‰éƒ½è¦è‡ªå¢ä¸€æ¬¡</li>
</ul>
<p>Sentinel é›†ç¾¤è‡³å°‘ 3 ä¸ªèŠ‚ç‚¹çš„åŸå› ï¼š</p>
<ul>
<li>å¦‚æœ Sentinel é›†ç¾¤åªæœ‰ 2 ä¸ª Sentinel èŠ‚ç‚¹ï¼Œåˆ™é¢†å¤´é€‰ä¸¾éœ€è¦ <code>2/2 + 1 = 2</code> ç¥¨ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œé‚£å°±æ°¸è¿œé€‰ä¸å‡ºé¢†å¤´</li>
<li>Sentinel é›†ç¾¤å…è®¸ 1 ä¸ª Sentinel èŠ‚ç‚¹æ•…éšœåˆ™éœ€è¦ 3 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œå…è®¸ 2 ä¸ªèŠ‚ç‚¹æ•…éšœåˆ™éœ€è¦ 5 ä¸ªèŠ‚ç‚¹é›†ç¾¤</li>
</ul>
<p><strong>å¦‚ä½•è·å–å“¨å…µèŠ‚ç‚¹çš„åŠæ•°æ•°é‡</strong>ï¼Ÿ</p>
<ul>
<li>å®¢è§‚ä¸‹çº¿æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶è·å–çš„æ•°é‡ï¼Œè¾¾åˆ°  quorum å°±å®¢è§‚ä¸‹çº¿</li>
<li>å“¨å…µæ•°é‡æ˜¯é€šè¿‡ä¸»èŠ‚ç‚¹æ˜¯å®ä¾‹ç»“æ„ä¸­ï¼Œä¿å­˜ç€ç›‘è§†è¯¥ä¸»èŠ‚ç‚¹çš„æ‰€æœ‰å“¨å…µä¿¡æ¯ï¼Œä»è€Œè·å–å¾—åˆ°</li>
</ul>
<h3 id="æ•…éšœè½¬ç§»">æ•…éšœè½¬ç§»</h3>
<h4 id="æ‰§è¡Œæµç¨‹-2">æ‰§è¡Œæµç¨‹</h4>
<p>é¢†å¤´ Sentinel å°†å¯¹å·²ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œï¼Œè¯¥æ“ä½œåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤</p>
<ul>
<li>
<p>ä»ä¸‹çº¿ä¸»æœåŠ¡å™¨å±ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨é‡Œé¢ï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ªä»æœåŠ¡å™¨ï¼Œæ‰§è¡Œ <code>SLAVEOF no one</code>ï¼Œå°†ä»æœåŠ¡å™¨å‡çº§ä¸ºä¸»æœåŠ¡å™¨</p>
<p>åœ¨å‘é€ SLAVEOF no one å‘½ä»¤åï¼Œé¢†å¤´ Sentinel ä¼šä»¥<strong>æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡</strong>ï¼ˆä¸€èˆ¬æ˜¯ 10s/æ¬¡ï¼‰å‘è¢«å‡çº§çš„ä»æœåŠ¡å™¨å‘é€ INFO å‘½ä»¤ï¼Œè§‚å¯Ÿå‘½ä»¤å›å¤ä¸­çš„è§’è‰²ä¿¡æ¯ï¼Œå½“è¢«å‡çº§æœåŠ¡å™¨çš„ role ä» slave å˜ä¸º master æ—¶ï¼Œè¯´æ˜ä»æœåŠ¡å™¨å·²ç»é¡ºåˆ©å‡çº§ä¸ºä¸»æœåŠ¡å™¨</p>
</li>
<li>
<p>å°†å·²ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨çš„æ‰€æœ‰ä»æœåŠ¡å™¨æ”¹ä¸ºå¤åˆ¶æ–°çš„ä¸»æœåŠ¡å™¨ï¼Œé€šè¿‡å‘ä»æœåŠ¡å™¨å‘é€ SLAVEOF å‘½ä»¤å®ç°</p>
</li>
<li>
<p>å°†å·²ç»ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨è®¾ç½®ä¸ºæ–°çš„ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ï¼Œè®¾ç½®æ˜¯ä¿å­˜åœ¨æœåŠ¡å™¨å¯¹åº”çš„å®ä¾‹ç»“æ„ä¸­ï¼Œå½“æ—§çš„ä¸»æœåŠ¡å™¨é‡æ–°ä¸Šçº¿æ—¶ï¼ŒSentinel å°±ä¼šå‘å®ƒå‘é€ SLAVEOF å‘½ä»¤ï¼Œæˆä¸ºæ–°çš„ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨</p>
</li>
</ul>
<p>ç¤ºä¾‹ï¼šsever1 æ˜¯ä¸»ï¼Œsever2ã€sever3ã€sever4 æ˜¯ä»æœåŠ¡å™¨ï¼Œsever1 æ•…éšœåé€‰ä¸­ sever2 å‡çº§</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%93%A8%E5%85%B5%E6%89%A7%E8%A1%8C%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB.png" alt=""></p>
<hr>
<h4 id="é€‰æ‹©ç®—æ³•">é€‰æ‹©ç®—æ³•</h4>
<p>é¢†å¤´ Sentinel ä¼šå°†å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨çš„æ‰€æœ‰ä»æœåŠ¡å™¨ä¿å­˜åˆ°ä¸€ä¸ªåˆ—è¡¨é‡Œï¼Œç„¶åæŒ‰ç…§ä»¥ä¸‹è§„åˆ™å¯¹åˆ—è¡¨è¿›è¡Œè¿‡æ»¤ï¼Œæœ€åæŒ‘é€‰å‡ºä¸€ä¸ª<strong>çŠ¶æ€è‰¯å¥½ã€æ•°æ®å®Œæ•´</strong>çš„ä»æœåŠ¡å™¨</p>
<ul>
<li>
<p>åˆ é™¤åˆ—è¡¨ä¸­æ‰€æœ‰å¤„äºä¸‹çº¿æˆ–è€…æ–­çº¿çŠ¶æ€çš„ä»æœåŠ¡å™¨ï¼Œä¿è¯åˆ—è¡¨ä¸­çš„ä»æœåŠ¡å™¨éƒ½æ˜¯æ­£å¸¸åœ¨çº¿çš„</p>
</li>
<li>
<p>åˆ é™¤åˆ—è¡¨ä¸­æ‰€æœ‰æœ€è¿‘äº”ç§’å†…æ²¡æœ‰å›å¤è¿‡é¢†å¤´ Sentinel çš„ INFO å‘½ä»¤çš„ä»æœåŠ¡å™¨ï¼Œä¿è¯åˆ—è¡¨ä¸­çš„ä»æœåŠ¡å™¨æœ€è¿‘æˆåŠŸè¿›è¡Œè¿‡é€šä¿¡</p>
</li>
<li>
<p>åˆ é™¤æ‰€æœ‰ä¸å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨è¿æ¥æ–­å¼€è¶…è¿‡ <code>down-after-milliseconds * 10</code> æ¯«ç§’çš„ä»æœåŠ¡å™¨ï¼Œä¿è¯åˆ—è¡¨ä¸­å‰©ä½™çš„ä»æœåŠ¡å™¨éƒ½æ²¡æœ‰è¿‡æ—©åœ°ä¸ä¸»æœåŠ¡å™¨æ–­å¼€è¿æ¥ï¼Œä¿å­˜çš„æ•°æ®éƒ½æ˜¯æ¯”è¾ƒæ–°çš„</p>
<p>down-after-milliseconds æ—¶é—´ç”¨æ¥åˆ¤æ–­æ˜¯å¦ä¸»è§‚ä¸‹çº¿ï¼Œå…¶ä½™çš„æ—¶é—´å®Œå…¨å¯ä»¥å®Œæˆå®¢è§‚ä¸‹çº¿å’Œé¢†å¤´é€‰ä¸¾</p>
</li>
<li>
<p>æ ¹æ®ä»æœåŠ¡å™¨çš„ä¼˜å…ˆçº§ï¼Œå¯¹åˆ—è¡¨ä¸­å‰©ä½™çš„ä»æœåŠ¡å™¨è¿›è¡Œæ’åºï¼Œå¹¶é€‰å‡ºå…¶ä¸­<strong>ä¼˜å…ˆçº§æœ€é«˜</strong>çš„ä»æœåŠ¡å™¨</p>
</li>
<li>
<p>å¦‚æœæœ‰å¤šä¸ªå…·æœ‰ç›¸åŒæœ€é«˜ä¼˜å…ˆçº§çš„ä»æœåŠ¡å™¨ï¼Œé¢†å¤´ Sentinel å°†å¯¹è¿™äº›ç›¸åŒä¼˜å…ˆçº§çš„æœåŠ¡å™¨æŒ‰ç…§å¤åˆ¶åç§»é‡è¿›è¡Œæ’åºï¼Œé€‰å‡ºå…¶ä¸­åç§»é‡æœ€å¤§çš„ä»æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯ä¿å­˜ç€æœ€æ–°æ•°æ®çš„ä»æœåŠ¡å™¨</p>
</li>
<li>
<p>å¦‚æœè¿˜æ²¡é€‰å‡ºæ¥ï¼Œå°±æŒ‰ç…§è¿è¡Œ ID å¯¹è¿™äº›ä»æœåŠ¡å™¨è¿›è¡Œæ’åºï¼Œå¹¶é€‰å‡ºå…¶ä¸­è¿è¡Œ ID æœ€å°çš„ä»æœåŠ¡å™¨</p>
</li>
</ul>
<hr>
<h2 id="é›†ç¾¤æ¨¡å¼">é›†ç¾¤æ¨¡å¼</h2>
<h3 id="é›†ç¾¤èŠ‚ç‚¹">é›†ç¾¤èŠ‚ç‚¹</h3>
<h4 id="èŠ‚ç‚¹æ¦‚è¿°">èŠ‚ç‚¹æ¦‚è¿°</h4>
<p>Redis é›†ç¾¤æ˜¯ Redis æä¾›çš„åˆ†å¸ƒå¼æ•°æ®åº“æ–¹æ¡ˆï¼Œé›†ç¾¤é€šè¿‡åˆ†ç‰‡ï¼ˆshardingï¼‰æ¥è¿›è¡Œæ•°æ®å…±äº«ï¼Œ å¹¶æä¾›å¤åˆ¶å’Œæ•…éšœè½¬ç§»åŠŸèƒ½ï¼Œä¸€ä¸ª Redis é›†ç¾¤é€šå¸¸ç”±å¤šä¸ªèŠ‚ç‚¹ï¼ˆnodeï¼‰ç»„æˆï¼Œå°†å„ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹è¿æ¥èµ·æ¥ï¼Œæ„æˆä¸€ä¸ªåŒ…å«å¤šèŠ‚ç‚¹çš„é›†ç¾¤</p>
<p>ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ª<strong>è¿è¡Œåœ¨é›†ç¾¤æ¨¡å¼ä¸‹çš„ Redis æœåŠ¡å™¨</strong>ï¼ŒRedis åœ¨å¯åŠ¨æ—¶ä¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„ <code>cluster-enabled</code> é…ç½®é€‰é¡¹æ˜¯å¦ä¸º yes æ¥å†³å®šæ˜¯å¦å¼€å¯æœåŠ¡å™¨çš„é›†ç¾¤æ¨¡å¼</p>
<p>èŠ‚ç‚¹ä¼šç»§ç»­ä½¿ç”¨æ‰€æœ‰åœ¨å•æœºæ¨¡å¼ä¸­ä½¿ç”¨çš„æœåŠ¡å™¨ç»„ä»¶ï¼Œä½¿ç”¨ redisServer ç»“æ„æ¥ä¿å­˜æœåŠ¡å™¨çš„çŠ¶æ€ï¼Œä½¿ç”¨ redisClient ç»“æ„æ¥ä¿å­˜å®¢æˆ·ç«¯çš„çŠ¶æ€ï¼Œä¹Ÿæœ‰é›†ç¾¤ç‰¹æœ‰çš„æ•°æ®ç»“æ„</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F.png" alt=""></p>
<hr>
<h4 id="æ•°æ®ç»“æ„-3">æ•°æ®ç»“æ„</h4>
<p>æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜ç€ä¸€ä¸ªé›†ç¾¤çŠ¶æ€ clusterState ç»“æ„ï¼Œè¿™ä¸ªç»“æ„è®°å½•äº†åœ¨å½“å‰èŠ‚ç‚¹çš„è§†è§’ä¸‹ï¼Œé›†ç¾¤ç›®å‰æ‰€å¤„çš„çŠ¶æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">clusterState</span> &#123;</span></span><br><span class="line">    <span class="comment">// æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„æŒ‡é’ˆ</span></span><br><span class="line">	clusterNode *myself;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// é›†ç¾¤å½“å‰çš„é…ç½®çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§»</span></span><br><span class="line">	<span class="type">uint64_t</span> currentEpoch;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// é›†ç¾¤å½“å‰çš„çŠ¶æ€ï¼Œæ˜¯åœ¨çº¿è¿˜æ˜¯ä¸‹çº¿</span></span><br><span class="line">	<span class="type">int</span> state;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// é›†ç¾¤ä¸­è‡³å°‘å¤„ç†ç€ä¸€ä¸ªæ§½çš„ï¼ˆä¸»ï¼‰èŠ‚ç‚¹çš„æ•°é‡ï¼Œä¸º0è¡¨ç¤ºé›†ç¾¤ç›®å‰æ²¡æœ‰ä»»ä½•èŠ‚ç‚¹åœ¨å¤„ç†æ§½</span></span><br><span class="line">    <span class="comment">// ã€é€‰ä¸¾æ—¶æŠ•ç¥¨æ•°é‡è¶…è¿‡åŠæ•°ï¼Œä»è¿™é‡Œè·å–çš„ã€‘</span></span><br><span class="line">	<span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é›†ç¾¤èŠ‚ç‚¹åå•ï¼ˆåŒ…æ‹¬ myself èŠ‚ç‚¹ï¼‰ï¼Œå­—å…¸çš„é”®ä¸ºèŠ‚ç‚¹çš„åå­—ï¼Œå­—å…¸çš„å€¼ä¸ºèŠ‚ç‚¹å¯¹åº”çš„clusterNodeç»“æ„ </span></span><br><span class="line">    dict *nodes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šä½¿ç”¨ clusterNode ç»“æ„è®°å½•å½“å‰çŠ¶æ€ï¼Œå¹¶ä¸ºé›†ç¾¤ä¸­çš„æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ï¼‰éƒ½åˆ›å»ºä¸€ä¸ªç›¸åº”çš„ clusterNode ç»“æ„ï¼Œä»¥æ­¤æ¥è®°å½•å…¶ä»–èŠ‚ç‚¹çš„çŠ¶æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">clusterNode</span> &#123;</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºèŠ‚ç‚¹çš„æ—¶é—´</span></span><br><span class="line">    <span class="type">mstime_t</span> ctime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹çš„åå­—ï¼Œç”± 40 ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ç»„æˆ</span></span><br><span class="line">    <span class="type">char</span> name[REDIS_CLUSTER_NAMELEN];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹æ ‡è¯†ï¼Œä½¿ç”¨å„ç§ä¸åŒçš„æ ‡è¯†å€¼è®°å½•èŠ‚ç‚¹çš„è§’è‰²ï¼ˆæ¯”å¦‚ä¸»èŠ‚ç‚¹æˆ–è€…ä»èŠ‚ç‚¹ï¼‰ä»¥åŠèŠ‚ç‚¹ç›®å‰æ‰€å¤„çš„çŠ¶æ€ï¼ˆæ¯”å¦‚åœ¨çº¿æˆ–è€…ä¸‹çº¿ï¼‰</span></span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹å½“å‰çš„é…ç½®çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§»</span></span><br><span class="line">    <span class="type">uint64_t</span> configEpoch;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹çš„IPåœ°å€</span></span><br><span class="line">    <span class="type">char</span> ip[REDIS_IP_STR_LEN];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹çš„ç«¯å£å·</span></span><br><span class="line">    <span class="type">int</span> port;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¿å­˜è¿æ¥èŠ‚ç‚¹æ‰€éœ€çš„æœ‰å…³ä¿¡æ¯</span></span><br><span class="line">    clusterLink *link;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>clusterNode ç»“æ„çš„ link å±æ€§æ˜¯ä¸€ä¸ª clusterLink ç»“æ„ï¼Œè¯¥ç»“æ„ä¿å­˜äº†è¿æ¥èŠ‚ç‚¹æ‰€éœ€çš„æœ‰å…³ä¿¡æ¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">clusterLink</span> &#123;</span></span><br><span class="line">    <span class="comment">// è¿æ¥çš„åˆ›å»ºæ—¶é—´ </span></span><br><span class="line">    <span class="type">mstime_t</span> ctime;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// TCPå¥—æ¥å­—æè¿°ç¬¦</span></span><br><span class="line">	<span class="type">int</span> fd;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// è¾“å‡ºç¼“å†²åŒºï¼Œä¿å­˜ç€ç­‰å¾…å‘é€ç»™å…¶ä»–èŠ‚ç‚¹çš„æ¶ˆæ¯(message)ã€‚ </span></span><br><span class="line">    sds sndbuf;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// è¾“å…¥ç¼“å†²åŒºï¼Œä¿å­˜ç€ä»å…¶ä»–èŠ‚ç‚¹æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚</span></span><br><span class="line">	sds rcvbuf;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// ä¸è¿™ä¸ªè¿æ¥ç›¸å…³è”çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å°±ä¸ºNULL</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">clusterNode</span> *<span class="title">node</span>;</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>redisClient ç»“æ„ä¸­çš„å¥—æ¥å®‡å’Œç¼“å†²åŒºæ˜¯ç”¨äºè¿æ¥å®¢æˆ·ç«¯çš„</li>
<li>clusterLink ç»“æ„ä¸­çš„å¥—æ¥å®‡å’Œç¼“å†²åŒºåˆ™æ˜¯ç”¨äºè¿æ¥èŠ‚ç‚¹çš„</li>
</ul>
<hr>
<h4 id="MEET">MEET</h4>
<p>CLUSTER MEET å‘½ä»¤ç”¨æ¥å°† ip å’Œ port æ‰€æŒ‡å®šçš„èŠ‚ç‚¹æ·»åŠ åˆ°æ¥å—å‘½ä»¤çš„èŠ‚ç‚¹æ‰€åœ¨çš„é›†ç¾¤ä¸­</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CLUSTER MEET &lt;ip&gt; &lt;port&gt; </span><br></pre></td></tr></table></figure>
<p>å‡è®¾å‘èŠ‚ç‚¹ A å‘é€ CLUSTER MEET å‘½ä»¤ï¼Œè®©èŠ‚ç‚¹ A å°†å¦ä¸€ä¸ªèŠ‚ç‚¹ B æ·»åŠ åˆ°èŠ‚ç‚¹ A å½“å‰æ‰€åœ¨çš„é›†ç¾¤é‡Œï¼Œæ”¶åˆ°å‘½ä»¤çš„èŠ‚ç‚¹ A å°†ä¸æ ¹æ® ip å’Œ port å‘èŠ‚ç‚¹ B è¿›è¡Œæ¡æ‰‹ï¼ˆhandshakeï¼‰ï¼š</p>
<ul>
<li>èŠ‚ç‚¹ A ä¼šä¸ºèŠ‚ç‚¹ B åˆ›å»ºä¸€ä¸ª clusterNode ç»“æ„ï¼Œå¹¶å°†è¯¥ç»“æ„æ·»åŠ åˆ°è‡ªå·±çš„ clusterState.nodes å­—å…¸é‡Œï¼Œç„¶åèŠ‚ç‚¹ A å‘èŠ‚ç‚¹ B <strong>å‘é€ MEET æ¶ˆæ¯</strong>ï¼ˆmessageï¼‰</li>
<li>èŠ‚ç‚¹ B æ”¶åˆ° MEET æ¶ˆæ¯åï¼ŒèŠ‚ç‚¹ B ä¼šä¸ºèŠ‚ç‚¹ A åˆ›å»ºä¸€ä¸ª clusterNode ç»“æ„ï¼Œå¹¶å°†è¯¥ç»“æ„æ·»åŠ åˆ°è‡ªå·±çš„ clusterState.nodes å­—å…¸é‡Œï¼Œä¹‹åèŠ‚ç‚¹ B å°†å‘èŠ‚ç‚¹ A <strong>è¿”å›ä¸€æ¡ PONG æ¶ˆæ¯</strong></li>
<li>èŠ‚ç‚¹ A æ”¶åˆ° PONG æ¶ˆæ¯åï¼Œä»£è¡¨èŠ‚ç‚¹ A å¯ä»¥çŸ¥é“èŠ‚ç‚¹ B å·²ç»æˆåŠŸåœ°æ¥æ”¶åˆ°äº†è‡ªå·²å‘é€çš„ MEET æ¶ˆæ¯ï¼Œæ­¤æ—¶èŠ‚ç‚¹ A å°†å‘èŠ‚ç‚¹ B <strong>è¿”å›ä¸€æ¡ PING æ¶ˆæ¯</strong></li>
<li>èŠ‚ç‚¹ B æ”¶åˆ° PING æ¶ˆæ¯åï¼Œ ä»£è¡¨èŠ‚ç‚¹ B å¯ä»¥çŸ¥é“èŠ‚ç‚¹ A å·²ç»æˆåŠŸåœ°æ¥æ”¶åˆ°äº†è‡ªå·±è¿”å›çš„ PONG æ¶ˆæ¯ï¼Œæ¡æ‰‹å®Œæˆ</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E6%8F%A1%E6%89%8B.png" alt=""></p>
<p>èŠ‚ç‚¹ A ä¼šå°†èŠ‚ç‚¹ B çš„ä¿¡æ¯é€šè¿‡ Gossip åè®®ä¼ æ’­ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œè®©å…¶ä»–èŠ‚ç‚¹ä¹Ÿä¸èŠ‚ç‚¹ B è¿›è¡Œæ¡æ‰‹ï¼Œæœ€ç»ˆç»è¿‡ä¸€æ®µæ—¶é—´ä¹‹åï¼ŒèŠ‚ç‚¹ B ä¼šè¢«é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹è®¤è¯†</p>
<hr>
<h3 id="æ§½æŒ‡æ´¾">æ§½æŒ‡æ´¾</h3>
<h4 id="åŸºæœ¬æ“ä½œ-4">åŸºæœ¬æ“ä½œ</h4>
<p>Redis é›†ç¾¤é€šè¿‡åˆ†ç‰‡çš„æ–¹å¼æ¥ä¿å­˜æ•°æ®åº“ä¸­çš„é”®å€¼å¯¹ï¼Œé›†ç¾¤çš„æ•´ä¸ªæ•°æ®åº“è¢«åˆ†ä¸º 16384 ä¸ªæ§½ï¼ˆslotï¼‰ï¼Œæ•°æ®åº“ä¸­çš„æ¯ä¸ªé”®éƒ½å±äº 16384 ä¸ªæ§½ä¸­çš„ä¸€ä¸ªï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥å¤„ç† 0 ä¸ªæˆ–æœ€å¤š 16384 ä¸ªæ§½ï¼ˆ<strong>æ¯ä¸ªä¸»èŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®å¹¶ä¸ä¸€æ ·</strong>ï¼‰</p>
<ul>
<li>å½“æ•°æ®åº“ä¸­çš„ 16384 ä¸ªæ§½éƒ½æœ‰èŠ‚ç‚¹åœ¨å¤„ç†æ—¶ï¼Œé›†ç¾¤å¤„äºä¸Šçº¿çŠ¶æ€ï¼ˆokï¼‰</li>
<li>å¦‚æœæ•°æ®åº“ä¸­æœ‰ä»»ä½•ä¸€ä¸ªæ§½å¾—åˆ°å¤„ç†ï¼Œé‚£ä¹ˆé›†ç¾¤å¤„äºä¸‹çº¿çŠ¶æ€ï¼ˆfailï¼‰</li>
</ul>
<p>é€šè¿‡å‘èŠ‚ç‚¹å‘é€ CLUSTER ADDSLOTS å‘½ä»¤ï¼Œå¯ä»¥å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ§½æŒ‡æ´¾ï¼ˆassignï¼‰ç»™èŠ‚ç‚¹è´Ÿè´£</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CLUSTER ADDSLOTS &lt;slot&gt; [slot ... ] </span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:7000&gt; CLUSTER ADDSLOTS 0 1 2 3 4 ... 5000 <span class="comment"># å°†æ§½0è‡³æ§½5000æŒ‡æ´¾ç»™èŠ‚ç‚¹7000è´Ÿè´£</span></span><br><span class="line">OK </span><br></pre></td></tr></table></figure>
<p>å‘½ä»¤æ‰§è¡Œç»†èŠ‚ï¼š</p>
<ul>
<li>å¦‚æœå‘½ä»¤å‚æ•°ä¸­æœ‰ä¸€ä¸ªæ§½å·²ç»è¢«æŒ‡æ´¾ç»™äº†æŸä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¼šå‘å®¢æˆ·ç«¯è¿”å›é”™è¯¯ï¼Œå¹¶ç»ˆæ­¢å‘½ä»¤æ‰§è¡Œ</li>
<li>å°† slots æ•°ç»„ä¸­çš„ç´¢å¼• i ä¸Šçš„äºŒè¿›åˆ¶ä½è®¾ç½®ä¸º 1ï¼Œå°±ä»£è¡¨æŒ‡æ´¾æˆåŠŸ</li>
</ul>
<hr>
<h4 id="èŠ‚ç‚¹æŒ‡æ´¾">èŠ‚ç‚¹æŒ‡æ´¾</h4>
<p>clusterNode ç»“æ„çš„ slots å±æ€§å’Œ numslot å±æ€§è®°å½•äº†èŠ‚ç‚¹è´Ÿè´£å¤„ç†å“ªäº›æ§½ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">clusterNode</span> &#123;</span></span><br><span class="line">    <span class="comment">// å¤„ç†ä¿¡æ¯ï¼Œä¸€å­—èŠ‚ç­‰äº 8 ä½</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> slots[l6384/<span class="number">8</span>];</span><br><span class="line">    <span class="comment">// è®°å½•èŠ‚ç‚¹è´Ÿè´£å¤„ç†çš„æ§½çš„æ•°é‡ï¼Œå°±æ˜¯ slots æ•°ç»„ä¸­å€¼ä¸º 1 çš„äºŒè¿›åˆ¶ä½æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> numslots;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>slots æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶ä½æ•°ç»„ï¼ˆbit arrayï¼‰ï¼Œé•¿åº¦ä¸º <code>16384/8 = 2048</code> ä¸ªå­—èŠ‚ï¼ŒåŒ…å« 16384 ä¸ªäºŒè¿›åˆ¶ä½ï¼ŒRedis ä»¥ 0 ä¸ºèµ·å§‹ç´¢å¼•ï¼Œ16383 ä¸ºç»ˆæ­¢ç´¢å¼•ï¼Œå¯¹ slots æ•°ç»„çš„ 16384 ä¸ªäºŒè¿›åˆ¶ä½è¿›è¡Œç¼–å·ï¼Œå¹¶æ ¹æ®ç´¢å¼• i ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼æ¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦è´Ÿè´£å¤„ç†æ§½ iï¼š</p>
<ul>
<li>åœ¨ç´¢å¼• i ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼ä¸º 1ï¼Œé‚£ä¹ˆè¡¨ç¤ºèŠ‚ç‚¹è´Ÿè´£å¤„ç†æ§½ i</li>
<li>åœ¨ç´¢å¼• i ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼ä¸º 0ï¼Œé‚£ä¹ˆè¡¨ç¤ºèŠ‚ç‚¹ä¸è´Ÿè´£å¤„ç†æ§½ i</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E9%9B%86%E7%BE%A4%E6%A7%BD%E6%8C%87%E6%B4%BE%E4%BF%A1%E6%81%AF.png" alt=""></p>
<p>å–å‡ºå’Œè®¾ç½® slots æ•°ç»„ä¸­çš„ä»»æ„ä¸€ä¸ªäºŒè¿›åˆ¶ä½çš„å€¼çš„<strong>å¤æ‚åº¦ä»…ä¸º O(1)</strong>ï¼Œæ‰€ä»¥å¯¹äºä¸€ä¸ªç»™å®šèŠ‚ç‚¹çš„ slots æ•°ç»„æ¥è¯´ï¼Œæ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦è´Ÿè´£å¤„ç†æŸä¸ªæ§½æˆ–è€…å°†æŸä¸ªæ§½æŒ‡æ´¾ç»™èŠ‚ç‚¹è´Ÿè´£ï¼Œè¿™ä¸¤ä¸ªåŠ¨ä½œçš„å¤æ‚åº¦éƒ½æ˜¯ O(1)</p>
<p><strong>ä¼ æ’­èŠ‚ç‚¹çš„æ§½æŒ‡æ´¾ä¿¡æ¯</strong>ï¼šä¸€ä¸ªèŠ‚ç‚¹é™¤äº†ä¼šå°†è‡ªå·±è´Ÿè´£å¤„ç†çš„æ§½è®°å½•åœ¨ clusterNode ä¸­ï¼Œè¿˜ä¼šå°†è‡ªå·±çš„ slots æ•°ç»„é€šè¿‡æ¶ˆæ¯å‘é€ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œæ¯ä¸ªæ¥æ”¶åˆ° slots æ•°ç»„çš„èŠ‚ç‚¹éƒ½ä¼šå°†æ•°ç»„ä¿å­˜åˆ°ç›¸åº”èŠ‚ç‚¹çš„ clusterNode ç»“æ„é‡Œé¢ï¼Œå› æ­¤é›†ç¾¤ä¸­çš„<strong>æ¯ä¸ªèŠ‚ç‚¹</strong>éƒ½ä¼šçŸ¥é“æ•°æ®åº“ä¸­çš„ 16384 ä¸ªæ§½åˆ†åˆ«è¢«æŒ‡æ´¾ç»™äº†é›†ç¾¤ä¸­çš„å“ªäº›èŠ‚ç‚¹</p>
<hr>
<h4 id="é›†ç¾¤æŒ‡æ´¾">é›†ç¾¤æŒ‡æ´¾</h4>
<p>é›†ç¾¤çŠ¶æ€ clusterState ç»“æ„ä¸­çš„ slots æ•°ç»„è®°å½•äº†é›†ç¾¤ä¸­æ‰€æœ‰ 16384 ä¸ªæ§½çš„æŒ‡æ´¾ä¿¡æ¯ï¼Œæ•°ç»„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘ clusterNode çš„æŒ‡é’ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">clusterState</span> &#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    clusterNode *slots[<span class="number">16384</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœ slots[i] æŒ‡é’ˆæŒ‡å‘ NULLï¼Œé‚£ä¹ˆè¡¨ç¤ºæ§½ i å°šæœªæŒ‡æ´¾ç»™ä»»ä½•èŠ‚ç‚¹</li>
<li>å¦‚æœ slots[i] æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ª clusterNode ç»“æ„ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ§½ i å·²ç»æŒ‡æ´¾ç»™è¯¥èŠ‚ç‚¹æ‰€ä»£è¡¨çš„èŠ‚ç‚¹</li>
</ul>
<p>é€šè¿‡è¯¥èŠ‚ç‚¹ï¼Œç¨‹åºæ£€æŸ¥æ§½ i æ˜¯å¦å·²ç»è¢«æŒ‡æ´¾æˆ–è€…å–å¾—è´Ÿè´£å¤„ç†æ§½ i çš„èŠ‚ç‚¹ï¼Œåªéœ€è¦è®¿é—® clusterState. slots[i] å³å¯ï¼Œæ—¶é—´å¤æ‚åº¦ä»…ä¸º O(1)</p>
<hr>
<h4 id="é›†ç¾¤æ•°æ®">é›†ç¾¤æ•°æ®</h4>
<p>é›†ç¾¤èŠ‚ç‚¹ä¿å­˜é”®å€¼å¯¹ä»¥åŠé”®å€¼å¯¹è¿‡æœŸæ—¶é—´çš„æ–¹å¼ï¼Œä¸å•æœº Redis æœåŠ¡å™¨ä¿å­˜é”®å€¼å¯¹ä»¥åŠé”®å€¼å¯¹è¿‡æœŸæ—¶é—´çš„æ–¹å¼å®Œå…¨ç›¸åŒï¼Œä½†æ˜¯<strong>é›†ç¾¤èŠ‚ç‚¹åªèƒ½ä½¿ç”¨ 0 å·æ•°æ®åº“</strong>ï¼Œå•æœºæœåŠ¡å™¨å¯ä»¥ä»»æ„ä½¿ç”¨</p>
<p>é™¤äº†å°†é”®å€¼å¯¹ä¿å­˜åœ¨æ•°æ®åº“é‡Œé¢ä¹‹å¤–ï¼ŒèŠ‚ç‚¹è¿˜ä¼šç”¨ clusterState ç»“æ„ä¸­çš„ slots_to_keys è·³è·ƒè¡¨æ¥<strong>ä¿å­˜æ§½å’Œé”®ä¹‹é—´çš„å…³ç³»</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">clusterState</span> &#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    zskiplist *slots_to_keys;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>slots_to_keys è·³è·ƒè¡¨æ¯ä¸ªèŠ‚ç‚¹çš„åˆ†å€¼ï¼ˆscoreï¼‰éƒ½æ˜¯ä¸€ä¸ªæ§½å·ï¼Œè€Œæ¯ä¸ªèŠ‚ç‚¹çš„æˆå‘˜ï¼ˆmemberï¼‰éƒ½æ˜¯ä¸€ä¸ªæ•°æ®åº“é”®ï¼ˆæŒ‰æ§½å·å‡åºï¼‰</p>
<ul>
<li>å½“èŠ‚ç‚¹å¾€æ•°æ®åº“ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„é”®å€¼å¯¹æ—¶ï¼ŒèŠ‚ç‚¹å°±ä¼šå°†è¿™ä¸ªé”®ä»¥åŠé”®çš„æ§½å·å…³è”åˆ° slots_to_keys è·³è·ƒè¡¨</li>
<li>å½“èŠ‚ç‚¹åˆ é™¤æ•°æ®åº“ä¸­çš„æŸä¸ªé”®å€¼å¯¹æ—¶ï¼ŒèŠ‚ç‚¹å°±ä¼šåœ¨ slots_to_keys è·³è·ƒè¡¨è§£é™¤è¢«åˆ é™¤é”®ä¸æ§½å·çš„å…³è”</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E6%A7%BD%E5%92%8C%E9%94%AE%E8%B7%B3%E8%B7%83%E8%A1%A8.png" alt=""></p>
<p>é€šè¿‡åœ¨ slots_to_keys è·³è·ƒè¡¨ä¸­è®°å½•å„ä¸ªæ•°æ®åº“é”®æ‰€å±çš„æ§½ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹å±äºæŸä¸ªæˆ–æŸäº›æ§½çš„æ‰€æœ‰æ•°æ®åº“é”®è¿›è¡Œæ‰¹é‡æ“ä½œï¼Œæ¯”å¦‚ <code>CLUSTER GETKEYSINSLOT &lt;slot&gt; &lt;count&gt;</code> å‘½ä»¤è¿”å›æœ€å¤š count ä¸ªå±äºæ§½ slot çš„æ•°æ®åº“é”®ï¼Œå°±æ˜¯é€šè¿‡è¯¥è·³è¡¨å®ç°</p>
<hr>
<h3 id="é›†ç¾¤å‘½ä»¤">é›†ç¾¤å‘½ä»¤</h3>
<h4 id="æ‰§è¡Œå‘½ä»¤">æ‰§è¡Œå‘½ä»¤</h4>
<p>é›†ç¾¤å¤„äºä¸Šçº¿çŠ¶æ€ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥å‘é›†ç¾¤ä¸­çš„èŠ‚ç‚¹å‘é€å‘½ä»¤ï¼ˆ16384 ä¸ªæ§½å…¨éƒ¨æŒ‡æ´¾å°±è¿›å…¥ä¸Šçº¿çŠ¶æ€ï¼‰</p>
<p>å½“å®¢æˆ·ç«¯å‘èŠ‚ç‚¹å‘é€ä¸æ•°æ®åº“é”®æœ‰å…³çš„å‘½ä»¤æ—¶ï¼Œæ¥æ”¶å‘½ä»¤çš„èŠ‚ç‚¹ä¼šè®¡ç®—å‡ºå‘½ä»¤è¯¥é”®å±äºå“ªä¸ªæ§½ï¼Œå¹¶æ£€æŸ¥è¿™ä¸ªæ§½æ˜¯å¦æŒ‡æ´¾ç»™äº†è‡ªå·±</p>
<ul>
<li>å¦‚æœé”®æ‰€åœ¨çš„æ§½æ­£å¥½å°±æŒ‡æ´¾ç»™äº†å½“å‰èŠ‚ç‚¹ï¼Œé‚£ä¹ˆèŠ‚ç‚¹ç›´æ¥æ‰§è¡Œè¿™ä¸ªå‘½ä»¤</li>
<li>åä¹‹ï¼ŒèŠ‚ç‚¹ä¼šå‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ª MOVED é”™è¯¯ï¼ŒæŒ‡å¼•å®¢æˆ·ç«¯è½¬å‘ï¼ˆredirectï¼‰è‡³æ­£ç¡®çš„èŠ‚ç‚¹ï¼Œå†æ¬¡å‘é€è¯¥å‘½ä»¤</li>
</ul>
<p>è®¡ç®—é”®å½’å±å“ªä¸ªæ§½çš„<strong>å¯»å€ç®—æ³•</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">slot_number</span><span class="params">(key)</span>: 			<span class="comment">// CRC16(key) è¯­å¥è®¡ç®—é”® key çš„ CRC-16 æ ¡éªŒå’Œ</span></span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">CRC16</span><span class="params">(key)</span> &amp; 16383;	<span class="comment">// å–æ¨¡ï¼Œåè¿›åˆ¶å¯¹16384çš„å–ä½™</span></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ <code>CLUSTER KEYSLOT &lt;key&gt;</code> å‘½ä»¤å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªç»™å®šé”®å±äºå“ªä¸ªæ§½ï¼Œåº•å±‚å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">CLUSTER_KEYSLOT</span><span class="params">(key)</span>:</span><br><span class="line">	<span class="comment">// è®¡ç®—æ§½å·</span></span><br><span class="line">	slot = slot_number(key);</span><br><span class="line">	<span class="comment">// å°†æ§½å·è¿”å›ç»™å®¢æˆ·ç«¯</span></span><br><span class="line">	reply_client(slot);</span><br></pre></td></tr></table></figure>
<p>åˆ¤æ–­æ§½æ˜¯å¦ç”±å½“å‰èŠ‚ç‚¹è´Ÿè´£å¤„ç†ï¼šå¦‚æœ clusterState.slots[i] ä¸ç­‰äº clusterState.myselfï¼Œé‚£ä¹ˆè¯´æ˜æ§½ i å¹¶éç”±å½“å‰èŠ‚ç‚¹è´Ÿè´£ï¼ŒèŠ‚ç‚¹ä¼šæ ¹æ® clusterState.slots[i] æŒ‡å‘çš„ clusterNode ç»“æ„æ‰€è®°å½•çš„èŠ‚ç‚¹ IP å’Œç«¯å£å·ï¼Œå‘å®¢æˆ·ç«¯è¿”å› MOVED é”™è¯¯</p>
<hr>
<h4 id="MOVED">MOVED</h4>
<p>MOVED é”™è¯¯çš„æ ¼å¼ä¸ºï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOVED &lt;slot&gt; &lt;ip&gt;:&lt;portï¼</span><br></pre></td></tr></table></figure>
<p>å‚æ•° slot ä¸ºé”®æ‰€åœ¨çš„æ§½ï¼Œip å’Œ port æ˜¯è´Ÿè´£å¤„ç†æ§½ slot çš„èŠ‚ç‚¹çš„ ip åœ°å€å’Œç«¯å£å·</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOVED 12345 127.0.0.1:6380 <span class="comment"># è¡¨ç¤ºæ§½ 12345 æ­£ç”± IPåœ°å€ä¸º 127.0.0.1, ç«¯å£å·ä¸º 6380 çš„èŠ‚ç‚¹è´Ÿè´£</span></span><br></pre></td></tr></table></figure>
<p>å½“å®¢æˆ·ç«¯æ¥æ”¶åˆ°èŠ‚ç‚¹è¿”å›çš„ MOVED é”™è¯¯æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šæ ¹æ® MOVED é”™è¯¯ä¸­æä¾›çš„ IP åœ°å€å’Œç«¯å£å·ï¼Œè½¬è‡³è´Ÿè´£å¤„ç†æ§½ slot çš„èŠ‚ç‚¹é‡æ–°å‘é€æ‰§è¡Œçš„å‘½ä»¤</p>
<ul>
<li>
<p>ä¸€ä¸ªé›†ç¾¤å®¢æˆ·ç«¯é€šå¸¸ä¼šä¸é›†ç¾¤ä¸­çš„å¤šä¸ªèŠ‚ç‚¹åˆ›å»ºå¥—æ¥å­—è¿æ¥ï¼ŒèŠ‚ç‚¹è½¬å‘å®é™…ä¸Šå°±æ˜¯æ¢ä¸€ä¸ªå¥—æ¥å­—æ¥å‘é€å‘½ä»¤</p>
</li>
<li>
<p>å¦‚æœå®¢æˆ·ç«¯å°šæœªä¸è½¬å‘çš„èŠ‚ç‚¹åˆ›å»ºå¥—æ¥å­—è¿æ¥ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šå…ˆæ ¹æ® IP åœ°å€å’Œç«¯å£å·æ¥è¿æ¥èŠ‚ç‚¹ï¼Œç„¶åå†è¿›è¡Œè½¬å‘</p>
</li>
</ul>
<p>é›†ç¾¤æ¨¡å¼çš„ redis-cli åœ¨æ¥æ”¶åˆ° MOVED é”™è¯¯æ—¶ï¼Œå¹¶ä¸ä¼šæ‰“å°å‡º MOVED é”™è¯¯ï¼Œè€Œæ˜¯æ ¹æ®é”™è¯¯<strong>è‡ªåŠ¨è¿›è¡ŒèŠ‚ç‚¹è½¬å‘</strong>ï¼Œå¹¶æ‰“å°å‡ºè½¬å‘ä¿¡æ¯ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -c -p 6379 	<span class="comment">#é›†ç¾¤æ¨¡å¼</span></span><br><span class="line">127.0.0.1:6379&gt; SET msg <span class="string">&quot;happy&quot;</span> </span><br><span class="line">-&gt; Redirected to slot [6257] located at 127.0.0.1:6380</span><br><span class="line">OK </span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨å•æœºï¼ˆstand aloneï¼‰æ¨¡å¼çš„ redis-cli ä¼šæ‰“å°é”™è¯¯ï¼Œå› ä¸ºå•æœºæ¨¡å¼å®¢æˆ·ç«¯ä¸æ¸…æ¥š MOVED é”™è¯¯çš„ä½œç”¨ï¼Œä¸ä¼šè¿›è¡Œè‡ªåŠ¨è½¬å‘ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -c -p 6379 	<span class="comment">#é›†ç¾¤æ¨¡å¼</span></span><br><span class="line">127.0.0.1:6379&gt; SET msg <span class="string">&quot;happy&quot;</span> </span><br><span class="line">(error) MOVED 6257 127.0.0.1:6380</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="é‡æ–°åˆ†ç‰‡">é‡æ–°åˆ†ç‰‡</h3>
<h4 id="å®ç°åŸç†-2">å®ç°åŸç†</h4>
<p>Redis é›†ç¾¤çš„é‡æ–°åˆ†ç‰‡æ“ä½œå¯ä»¥å°†ä»»æ„æ•°é‡å·²ç»æŒ‡æ´¾ç»™æŸä¸ªèŠ‚ç‚¹ï¼ˆæºèŠ‚ç‚¹ï¼‰çš„æ§½æ”¹ä¸ºæŒ‡æ´¾ç»™å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆç›®æ ‡èŠ‚ç‚¹ï¼‰ï¼Œå¹¶ä¸”ç›¸å…³æ§½çš„é”®å€¼å¯¹ä¹Ÿä¼šä»æºèŠ‚ç‚¹è¢«ç§»åŠ¨åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œè¯¥æ“ä½œæ˜¯å¯ä»¥åœ¨çº¿ï¼ˆonlineï¼‰è¿›è¡Œï¼Œåœ¨é‡æ–°åˆ†ç‰‡çš„è¿‡ç¨‹ä¸­æºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹éƒ½å¯ä»¥å¤„ç†å‘½ä»¤è¯·æ±‚</p>
<p>Redis çš„é›†ç¾¤ç®¡ç†è½¯ä»¶ redis-trib è´Ÿè´£æ‰§è¡Œé‡æ–°åˆ†ç‰‡æ“ä½œï¼Œredis-trib é€šè¿‡å‘æºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹å‘é€å‘½ä»¤æ¥è¿›è¡Œé‡æ–°åˆ†ç‰‡æ“ä½œ</p>
<ul>
<li>å‘ç›®æ ‡èŠ‚ç‚¹å‘é€ <code>CLUSTER SETSLOT &lt;slot&gt; IMPORTING &lt;source_id&gt;</code> å‘½ä»¤ï¼Œå‡†å¤‡å¥½ä»æºèŠ‚ç‚¹å¯¼å…¥å±äºæ§½ slot çš„é”®å€¼å¯¹</li>
<li>å‘æºèŠ‚ç‚¹å‘é€ <code>CLUSTER SETSLOT &lt;slot&gt; MIGRATING &lt;target_id&gt;</code> å‘½ä»¤ï¼Œè®©æºèŠ‚ç‚¹å‡†å¤‡å¥½å°†å±äºæ§½ slot çš„é”®å€¼å¯¹è¿ç§»</li>
<li>redis-trib å‘æºèŠ‚ç‚¹å‘é€ <code>CLUSTER GETKEYSINSLOT &lt;slot&gt; &lt;count&gt;</code> å‘½ä»¤ï¼Œè·å¾—æœ€å¤š count ä¸ªå±äºæ§½ slot çš„é”®å€¼å¯¹çš„é”®å</li>
<li>å¯¹äºæ¯ä¸ª keyï¼Œredis-trib éƒ½å‘æºèŠ‚ç‚¹å‘é€ä¸€ä¸ª <code>MIGRATE &lt;target_ip&gt; &lt;target_port&gt; &lt;key_name&gt; 0 &lt;timeoutï¼</code> å‘½ä»¤ï¼Œå°†è¢«é€‰ä¸­çš„é”®<strong>åŸå­åœ°</strong>ä»æºèŠ‚ç‚¹è¿ç§»è‡³ç›®æ ‡èŠ‚ç‚¹</li>
<li>é‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œç›´åˆ°æºèŠ‚ç‚¹ä¿å­˜çš„æ‰€æœ‰æ§½ slot çš„é”®å€¼å¯¹éƒ½è¢«è¿ç§»è‡³ç›®æ ‡èŠ‚ç‚¹ä¸ºæ­¢</li>
<li>redis-trib å‘é›†ç¾¤ä¸­çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹å‘é€ <code>CLUSTER SETSLOT &lt;slot&gt; NODE &lt;target _id&gt;</code> å‘½ä»¤ï¼Œå°†æ§½ slot æŒ‡æ´¾ç»™ç›®æ ‡èŠ‚ç‚¹ï¼Œè¿™ä¸€æŒ‡æ´¾ä¿¡æ¯ä¼šé€šè¿‡æ¶ˆæ¯ä¼ æ’­è‡³æ•´ä¸ªé›†ç¾¤ï¼Œæœ€ç»ˆé›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ç›´åˆ°æ§½ slot å·²ç»æŒ‡æ´¾ç»™äº†ç›®æ ‡èŠ‚ç‚¹</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E9%9B%86%E7%BE%A4%E9%87%8D%E6%96%B0%E5%88%86%E7%89%87.png" alt=""></p>
<p>å¦‚æœé‡æ–°åˆ†ç‰‡æ¶‰åŠå¤šä¸ªæ§½ï¼Œé‚£ä¹ˆ redis-trib å°†å¯¹æ¯ä¸ªç»™å®šçš„æ§½åˆ†åˆ«æ‰§è¡Œä¸Šé¢ç»™å‡ºçš„æ­¥éª¤</p>
<hr>
<h4 id="å‘½ä»¤åŸç†">å‘½ä»¤åŸç†</h4>
<p>clusterState ç»“æ„çš„ importing_slots_from æ•°ç»„è®°å½•äº†å½“å‰èŠ‚ç‚¹æ­£åœ¨ä»å…¶ä»–èŠ‚ç‚¹å¯¼å…¥çš„æ§½ï¼Œmigrating_slots_to æ•°ç»„è®°å½•äº†å½“å‰èŠ‚ç‚¹æ­£åœ¨è¿ç§»è‡³å…¶ä»–èŠ‚ç‚¹çš„æ§½ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">clusterState</span> &#123;</span></span><br><span class="line">    <span class="comment">// å¦‚æœ importing_slots_from[i] çš„å€¼ä¸ä¸º NULLï¼Œè€Œæ˜¯æŒ‡å‘ä¸€ä¸ª clusterNode ç»“æ„ï¼Œ</span></span><br><span class="line">    <span class="comment">// é‚£ä¹ˆè¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ­£åœ¨ä» clusterNode æ‰€ä»£è¡¨çš„èŠ‚ç‚¹å¯¼å…¥æ§½ i</span></span><br><span class="line">    clusterNode *importing_slots_from[<span class="number">16384</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ­£åœ¨å°†æ§½ i è¿ç§»è‡³ clusterNode æ‰€ä»£è¡¨çš„èŠ‚ç‚¹</span></span><br><span class="line">    clusterNode *migrating_slots_to[<span class="number">16384</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CLUSTER SETSLOT &lt;slot&gt; IMPORTING &lt;source_id&gt;</code> å‘½ä»¤ï¼šå°†ç›®æ ‡èŠ‚ç‚¹ <code>clusterState.importing_slots_from[slot]</code> çš„å€¼è®¾ç½®ä¸º  source_id æ‰€ä»£è¡¨èŠ‚ç‚¹çš„ clusterNode ç»“æ„</p>
<p><code>CLUSTER SETSLOT &lt;slot&gt; MIGRATING &lt;target_id&gt;</code> å‘½ä»¤ï¼šå°†æºèŠ‚ç‚¹ <code>clusterState.migrating_slots_to[slot]</code> çš„å€¼è®¾ç½®ä¸ºtarget_id æ‰€ä»£è¡¨èŠ‚ç‚¹çš„ clusterNode ç»“æ„</p>
<hr>
<h4 id="ASK-é”™è¯¯">ASK é”™è¯¯</h4>
<p>é‡æ–°åˆ†ç‰‡æœŸé—´ï¼ŒæºèŠ‚ç‚¹å‘ç›®æ ‡èŠ‚ç‚¹è¿ç§»ä¸€ä¸ªæ§½çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å‡ºç°è¢«è¿ç§»æ§½çš„ä¸€éƒ¨åˆ†é”®å€¼å¯¹ä¿å­˜åœ¨æºèŠ‚ç‚¹ï¼Œå¦ä¸€éƒ¨åˆ†ä¿å­˜åœ¨ç›®æ ‡èŠ‚ç‚¹</p>
<p>å®¢æˆ·ç«¯å‘æºèŠ‚ç‚¹å‘é€å‘½ä»¤è¯·æ±‚ï¼Œå¹¶ä¸”å‘½ä»¤è¦å¤„ç†çš„æ•°æ®åº“é”®å±äºè¢«è¿ç§»çš„æ§½ï¼š</p>
<ul>
<li>
<p>æºèŠ‚ç‚¹ä¼šå…ˆåœ¨æ•°æ®åº“é‡Œé¢æŸ¥æ‰¾æŒ‡å®šé”®ï¼Œå¦‚æœæ‰¾åˆ°çš„è¯ï¼Œå°±ç›´æ¥æ‰§è¡Œå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤</p>
</li>
<li>
<p>æœªæ‰¾åˆ°ä¼šæ£€æŸ¥ clusterState.migrating_slots_to[slot]ï¼Œçœ‹é”® key æ‰€å±çš„æ§½ slot æ˜¯å¦æ­£åœ¨è¿›è¡Œè¿ç§»</p>
</li>
<li>
<p>æ§½ slot æ­£åœ¨è¿ç§»åˆ™æºèŠ‚ç‚¹å°†å‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ª ASK é”™è¯¯ï¼ŒæŒ‡å¼•å®¢æˆ·ç«¯è½¬å‘æ­£åœ¨å¯¼å…¥æ§½çš„ç›®æ ‡èŠ‚ç‚¹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ASK &lt;slot&gt; &lt;ip:port&gt;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ¥åˆ° ASK é”™è¯¯çš„å®¢æˆ·ç«¯ï¼Œä¼šæ ¹æ®é”™è¯¯æä¾›çš„ IP åœ°å€å’Œç«¯å£å·è½¬å‘ç›®æ ‡èŠ‚ç‚¹ï¼Œé¦–å…ˆå‘ç›®æ ‡èŠ‚ç‚¹å‘é€ä¸€ä¸ª ASKING å‘½ä»¤ï¼Œå†é‡æ–°å‘é€åŸæœ¬æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤</p>
</li>
</ul>
<p>å’Œ MOVED é”™è¯¯æƒ…å†µç±»ä¼¼ï¼Œé›†ç¾¤æ¨¡å¼çš„ redis-cli åœ¨æ¥åˆ° ASK é”™è¯¯æ—¶ä¸ä¼šæ‰“å°é”™è¯¯è¿›è¡Œè‡ªåŠ¨è½¬å‘ï¼›å•æœºæ¨¡å¼çš„ redis-cli ä¼šæ‰“å°é”™è¯¯</p>
<p>å¯¹æ¯” MOVED é”™è¯¯ï¼š</p>
<ul>
<li>
<p>MOVED é”™è¯¯ä»£è¡¨æ§½çš„è´Ÿè´£æƒå·²ç»ä»ä¸€ä¸ªèŠ‚ç‚¹è½¬ç§»åˆ°äº†å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè½¬å‘æ˜¯ä¸€ç§æŒä¹…æ€§çš„è½¬å‘</p>
</li>
<li>
<p>ASK é”™è¯¯åªæ˜¯ä¸¤ä¸ªèŠ‚ç‚¹åœ¨è¿ç§»æ§½çš„è¿‡ç¨‹ä¸­ä½¿ç”¨çš„ä¸€ç§ä¸´æ—¶æªæ–½ï¼ŒASK çš„è½¬å‘ä¸ä¼šå¯¹å®¢æˆ·ç«¯ä»Šåå‘é€å…³äºæ§½ slot çš„å‘½ä»¤è¯·æ±‚äº§ç”Ÿä»»ä½•å½±å“ï¼Œå®¢æˆ·ç«¯ä»ç„¶ä¼šå°†æ§½ slot çš„å‘½ä»¤è¯·æ±‚å‘é€è‡³ç›®å‰è´Ÿè´£å¤„ç†æ§½ slot çš„èŠ‚ç‚¹ï¼Œé™¤é ASK é”™è¯¯å†æ¬¡å‡ºç°</p>
</li>
</ul>
<hr>
<h4 id="ASKING">ASKING</h4>
<p>å®¢æˆ·ç«¯ä¸å‘é€ ASKING å‘½ä»¤ï¼Œè€Œæ˜¯ç›´æ¥å‘é€æ‰§è¡Œçš„å‘½ä»¤ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤å°†è¢«èŠ‚ç‚¹æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å› MOVED é”™è¯¯</p>
<p>ASKING å‘½ä»¤ä½œç”¨æ˜¯æ‰“å¼€å‘é€è¯¥å‘½ä»¤çš„å®¢æˆ·ç«¯çš„ REDIS_ASKING æ ‡è¯†ï¼Œè¯¥å‘½ä»¤çš„ä¼ªä»£ç å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">ASKING</span> <span class="params">()</span>:</span><br><span class="line">    <span class="comment">// æ‰“å¼€æ ‡è¯†</span></span><br><span class="line">    client.flags |= REDIS_ASKING </span><br><span class="line">    <span class="comment">// å‘å®¢æˆ·ç«¯è¿”å›OKå›å¤</span></span><br><span class="line">    reply(<span class="string">&quot;OK&quot;</span>) </span><br></pre></td></tr></table></figure>
<p>å½“å‰èŠ‚ç‚¹æ­£åœ¨å¯¼å…¥æ§½ slotï¼Œå¹¶ä¸”å‘é€å‘½ä»¤çš„å®¢æˆ·ç«¯å¸¦æœ‰ REDIS_ASKING æ ‡è¯†ï¼Œé‚£ä¹ˆèŠ‚ç‚¹å°†ç ´ä¾‹æ‰§è¡Œè¿™ä¸ªå…³äºæ§½ slot çš„å‘½ä»¤ä¸€æ¬¡</p>
<p>å®¢æˆ·ç«¯çš„ REDIS_ASKING æ ‡è¯†æ˜¯ä¸€æ¬¡æ€§æ ‡è¯†ï¼Œå½“èŠ‚ç‚¹æ‰§è¡Œäº†ä¸€ä¸ªå¸¦æœ‰ REDIS_ASKING æ ‡è¯†çš„å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤ä¹‹åï¼Œè¯¥å®¢æˆ·ç«¯çš„ REDIS_ASKING æ ‡è¯†å°±ä¼šè¢«ç§»é™¤</p>
<hr>
<h3 id="é«˜å¯ç”¨">é«˜å¯ç”¨</h3>
<h4 id="èŠ‚ç‚¹å¤åˆ¶">èŠ‚ç‚¹å¤åˆ¶</h4>
<p>Redis é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åˆ†ä¸ºä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰å’Œä»èŠ‚ç‚¹ï¼ˆslaveï¼‰ï¼Œå…¶ä¸­ä¸»èŠ‚ç‚¹ç”¨äºå¤„ç†æ§½ï¼Œè€Œä»èŠ‚ç‚¹åˆ™ç”¨äºå¤åˆ¶ä¸»èŠ‚ç‚¹ï¼Œå¹¶åœ¨è¢«å¤åˆ¶çš„ä¸»èŠ‚ç‚¹ä¸‹çº¿æ—¶ï¼Œä»£æ›¿ä¸‹çº¿ä¸»èŠ‚ç‚¹ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CLUSTER REPLICATE &lt;node_id&gt; </span><br></pre></td></tr></table></figure>
<p>å‘ä¸€ä¸ªèŠ‚ç‚¹å‘é€å‘½ä»¤å¯ä»¥è®©æ¥æ”¶å‘½ä»¤çš„èŠ‚ç‚¹æˆä¸º node_id æ‰€æŒ‡å®šèŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼Œå¹¶å¼€å§‹å¯¹ä¸»èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶</p>
<ul>
<li>
<p>æ¥å—å‘½ä»¤çš„èŠ‚ç‚¹é¦–å…ˆä¼šåœ¨çš„ clusterState.nodes å­—å…¸ä¸­æ‰¾åˆ° node_id æ‰€å¯¹åº”èŠ‚ç‚¹çš„ clusterNode ç»“æ„ï¼Œå¹¶å°†è‡ªå·±çš„èŠ‚ç‚¹ä¸­çš„ clusterState.myself.slaveof æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªç»“æ„ï¼Œè®°å½•è¿™ä¸ªèŠ‚ç‚¹æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹</p>
</li>
<li>
<p>èŠ‚ç‚¹ä¼šä¿®æ”¹ clusterState.myself.flags ä¸­çš„å±æ€§ï¼Œå…³é—­ REDIS_NODE_MASTER æ ‡è¯†ï¼Œæ‰“å¼€ REDIS_NODE_SLAVE æ ‡è¯†</p>
</li>
<li>
<p>èŠ‚ç‚¹ä¼šè°ƒç”¨å¤åˆ¶ä»£ç ï¼Œå¯¹ä¸»èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶ï¼ˆèŠ‚ç‚¹çš„å¤åˆ¶åŠŸèƒ½å’Œå•æœº Redis æœåŠ¡å™¨çš„ä½¿ç”¨äº†ç›¸åŒçš„ä»£ç ï¼‰</p>
</li>
</ul>
<p>ä¸€ä¸ªèŠ‚ç‚¹æˆä¸ºä»èŠ‚ç‚¹ï¼Œå¹¶å¼€å§‹å¤åˆ¶æŸä¸ªä¸»èŠ‚ç‚¹è¿™ä¸€ä¿¡æ¯ä¼šé€šè¿‡æ¶ˆæ¯å‘é€ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œæœ€ç»ˆé›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šçŸ¥é“æŸä¸ªä»èŠ‚ç‚¹æ­£åœ¨å¤åˆ¶æŸä¸ªä¸»èŠ‚ç‚¹</p>
<p>ä¸»èŠ‚ç‚¹çš„ clusterNode ç»“æ„çš„ slaves å±æ€§å’Œ numslaves å±æ€§ä¸­è®°å½•æ­£åœ¨å¤åˆ¶è¿™ä¸ªä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹åå•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">clusterNode</span> &#123;</span></span><br><span class="line">    <span class="comment">// æ­£åœ¨å¤åˆ¶è¿™ä¸ªä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> numslaves;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ•°ç»„é¡¹æŒ‡å‘ä¸€ä¸ªæ­£åœ¨å¤åˆ¶è¿™ä¸ªä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹çš„clusterNodeç»“æ„</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">clusterNode</span> **<span class="title">slaves</span>;</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="æ•…éšœæ£€æµ‹">æ•…éšœæ£€æµ‹</h4>
<p>é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå®šæœŸåœ°å‘é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹å‘é€ PING æ¶ˆæ¯ï¼Œæ¥æ£€æµ‹å¯¹æ–¹æ˜¯å¦åœ¨çº¿ï¼Œå¦‚æœæ¥æ”¶ PING çš„èŠ‚ç‚¹æ²¡æœ‰åœ¨è§„å®šçš„æ—¶é—´å†…è¿”å› PONG æ¶ˆæ¯ï¼Œé‚£ä¹ˆå‘é€æ¶ˆæ¯èŠ‚ç‚¹å°±ä¼šå°†æ¥æ”¶èŠ‚ç‚¹æ ‡è®°ä¸º<strong>ç–‘ä¼¼ä¸‹çº¿</strong>ï¼ˆprobable failï¼‰</p>
<p>é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä¼šäº’ç›¸å‘é€æ¶ˆæ¯ï¼Œæ¥<strong>äº¤æ¢é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯</strong>ï¼Œå½“ä¸€ä¸ªä¸»èŠ‚ç‚¹ A é€šè¿‡æ¶ˆæ¯å¾—çŸ¥ä¸»èŠ‚ç‚¹ B è®¤ä¸ºä¸»èŠ‚ç‚¹ C è¿›å…¥äº†ç–‘ä¼¼ä¸‹çº¿çŠ¶æ€æ—¶ï¼Œä¸»èŠ‚ç‚¹ A ä¼šåœ¨ clusterState.nodes å­—å…¸ä¸­æ‰¾åˆ°ä¸»èŠ‚ç‚¹ C æ‰€å¯¹åº”çš„èŠ‚ç‚¹ï¼Œå¹¶å°†ä¸»èŠ‚ç‚¹ B çš„ä¸‹çº¿æŠ¥å‘Šï¼ˆfailure reportï¼‰æ·»åŠ åˆ° clusterNode.fail_reports é“¾è¡¨é‡Œé¢</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">clusterNode</span> &#123;</span></span><br><span class="line">    <span class="comment">// ä¸€ä¸ªé“¾è¡¨ï¼Œè®°å½•äº†æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹å¯¹è¯¥èŠ‚ç‚¹çš„ä¸‹çº¿æŠ¥å‘Š </span></span><br><span class="line">    <span class="built_in">list</span> *fail_reports;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ¯ä¸ªä¸‹çº¿æŠ¥å‘Šç”±ä¸€ä¸ª clusterNodeFailReport ç»“æ„è¡¨ç¤º</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">clusterNodeFailReport</span> &#123;</span></span><br><span class="line">    <span class="comment">// æŠ¥å‘Šç›®æ ‡èŠ‚ç‚¹å·³ç»ä¸‹çº¿çš„èŠ‚ç‚¹ </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">clusterNode</span> *<span class="title">node</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœ€åä¸€æ¬¡ä»nodeèŠ‚ç‚¹æ”¶åˆ°ä¸‹çº¿æŠ¥å‘Šçš„æ—¶é—´</span></span><br><span class="line">    <span class="comment">// ç¨‹åºä½¿ç”¨è¿™ä¸ªæ—¶é—´æˆ³æ¥æ£€æŸ¥ä¸‹çº¿æŠ¥å‘Šæ˜¯å¦è¿‡æœŸï¼Œä¸å½“å‰æ—¶é—´ç›¸å·®å¤ªä¹…çš„ä¸‹çº¿æŠ¥å‘Šä¼šè¢«åˆ é™¤ </span></span><br><span class="line">    <span class="type">mstime_t</span> time; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>é›†ç¾¤é‡Œ<strong>åŠæ•°ä»¥ä¸Š</strong>è´Ÿè´£å¤„ç†æ§½çš„ä¸»èŠ‚ç‚¹éƒ½å°†æŸä¸ªä¸»èŠ‚ç‚¹ X æŠ¥å‘Šä¸ºç–‘ä¼¼ä¸‹çº¿ï¼Œé‚£ä¹ˆ X å°†è¢«æ ‡è®°ä¸º<strong>å·²ä¸‹çº¿</strong>ï¼ˆFAILï¼‰ï¼Œå°† X æ ‡è®°ä¸ºå·²ä¸‹çº¿çš„èŠ‚ç‚¹ä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡å…³äºä¸»èŠ‚ç‚¹ X çš„ FAIL æ¶ˆæ¯ï¼Œæ‰€æœ‰æ”¶åˆ°æ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šå°† X æ ‡è®°ä¸ºå·²ä¸‹çº¿</p>
<hr>
<h4 id="æ•…éšœè½¬ç§»-2">æ•…éšœè½¬ç§»</h4>
<p>å½“ä¸€ä¸ªä»èŠ‚ç‚¹å‘ç°æ‰€å±çš„ä¸»èŠ‚ç‚¹è¿›å…¥äº†å·²ä¸‹çº¿çŠ¶æ€ï¼Œä»èŠ‚ç‚¹å°†å¼€å§‹å¯¹ä¸‹çº¿ä¸»èŠ‚ç‚¹è¿›è¡Œæ•…éšœè½¬ç§»ï¼Œæ‰§è¡Œæ­¥éª¤ï¼š</p>
<ul>
<li>ä¸‹å±çš„ä»èŠ‚ç‚¹é€šè¿‡é€‰ä¸¾äº§ç”Ÿä¸€ä¸ªèŠ‚ç‚¹</li>
<li>è¢«é€‰ä¸­çš„ä»èŠ‚ç‚¹ä¼šæ‰§è¡Œ <code>SLAVEOF no one</code> å‘½ä»¤ï¼Œæˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹</li>
<li>æ–°çš„ä¸»èŠ‚ç‚¹ä¼š<strong>æ’¤é”€æ‰€æœ‰å¯¹å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„æ§½æŒ‡æ´¾</strong>ï¼Œå¹¶å°†è¿™äº›æ§½å…¨éƒ¨æŒ‡æ´¾ç»™è‡ªå·±</li>
<li>æ–°çš„ä¸»èŠ‚ç‚¹å‘é›†ç¾¤å¹¿æ’­ä¸€æ¡ PONG æ¶ˆæ¯ï¼Œè®©é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹çŸ¥é“å½“å‰èŠ‚ç‚¹å˜æˆäº†ä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ¥ç®¡äº†ä¸‹çº¿èŠ‚ç‚¹è´Ÿè´£å¤„ç†çš„æ§½</li>
<li>æ–°çš„ä¸»èŠ‚ç‚¹å¼€å§‹æ¥æ”¶æœ‰å…³çš„å‘½ä»¤è¯·æ±‚ï¼Œæ•…éšœè½¬ç§»å®Œæˆ</li>
</ul>
<hr>
<h4 id="é€‰ä¸¾ç®—æ³•">é€‰ä¸¾ç®—æ³•</h4>
<p>é›†ç¾¤é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹çš„è§„åˆ™ï¼š</p>
<ul>
<li>é›†ç¾¤çš„é…ç½®çºªå…ƒæ˜¯ä¸€ä¸ªè‡ªå¢çš„è®¡æ•°å™¨ï¼Œåˆå§‹å€¼ä¸º 0</li>
<li>å½“é›†ç¾¤é‡ŒæŸä¸ªèŠ‚ç‚¹å¼€å§‹ä¸€æ¬¡æ•…éšœè½¬ç§»ï¼Œé›†ç¾¤çš„é…ç½®çºªå…ƒå°±æ˜¯å¢åŠ ä¸€</li>
<li>æ¯ä¸ªé…ç½®çºªå…ƒé‡Œï¼Œé›†ç¾¤ä¸­æ¯ä¸ªä¸»èŠ‚ç‚¹éƒ½æœ‰ä¸€æ¬¡æŠ•ç¥¨çš„æœºä¼šï¼Œè€Œç¬¬ä¸€ä¸ªå‘ä¸»èŠ‚ç‚¹è¦æ±‚æŠ•ç¥¨çš„ä»èŠ‚ç‚¹å°†è·å¾—è¯¥ä¸»èŠ‚ç‚¹çš„æŠ•ç¥¨</li>
<li>å…·æœ‰æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹æ˜¯å¿…é¡»å…·æœ‰æ­£åœ¨å¤„ç†çš„æ§½</li>
<li>é›†ç¾¤é‡Œæœ‰ N ä¸ªå…·æœ‰æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå½“ä¸€ä¸ªä»èŠ‚ç‚¹æ”¶é›†åˆ°å¤§äºç­‰äº <code>N/2+1</code> å¼ æ”¯æŒç¥¨æ—¶ï¼Œä»èŠ‚ç‚¹å°±ä¼šå½“é€‰</li>
<li>æ¯ä¸ªé…ç½®çºªå…ƒé‡Œï¼Œå…·æœ‰æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹åªèƒ½æŠ•ä¸€æ¬¡ç¥¨ï¼Œæ‰€ä»¥è·å¾—ä¸€åŠä»¥ä¸Šç¥¨çš„èŠ‚ç‚¹åªä¼šæœ‰ä¸€ä¸ª</li>
</ul>
<p>é€‰ä¸¾æµç¨‹ï¼š</p>
<ul>
<li>å½“æŸä¸ªä»èŠ‚ç‚¹å‘ç°æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹è¿›å…¥å·²ä¸‹çº¿çŠ¶æ€æ—¶ï¼Œä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡ <code>CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST</code> æ¶ˆæ¯ï¼Œè¦æ±‚æ‰€æœ‰æ”¶åˆ°è¿™æ¡æ¶ˆæ¯ã€å¹¶ä¸”å…·æœ‰æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹å‘è¿™ä¸ªä»èŠ‚ç‚¹æŠ•ç¥¨</li>
<li>å¦‚æœä¸»èŠ‚ç‚¹å°šæœªæŠ•ç¥¨ç»™å…¶ä»–ä»èŠ‚ç‚¹ï¼Œå°†å‘è¦æ±‚æŠ•ç¥¨çš„ä»èŠ‚ç‚¹è¿”å›ä¸€æ¡ <code>CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK</code> æ¶ˆæ¯ï¼Œè¡¨ç¤ºè¿™ä¸ªä¸»èŠ‚ç‚¹æ”¯æŒä»èŠ‚ç‚¹æˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹</li>
<li>å¦‚æœä»èŠ‚ç‚¹è·å–åˆ°äº†åŠæ•°ä»¥ä¸Šçš„é€‰ç¥¨ï¼Œåˆ™ä¼šå½“é€‰æ–°çš„ä¸»èŠ‚ç‚¹</li>
<li>å¦‚æœä¸€ä¸ªé…ç½®çºªå…ƒé‡Œæ²¡æœ‰ä»èŠ‚ç‚¹èƒ½æ”¶é›†åˆ°è¶³å¤Ÿå¤šçš„æ”¯å¾…ç¥¨ï¼Œé‚£ä¹ˆé›†ç¾¤è¿›å…¥ä¸€ä¸ªæ–°çš„é…ç½®çºªå…ƒï¼Œå¹¶å†æ¬¡è¿›è¡Œé€‰ä¸¾ï¼Œç›´åˆ°é€‰å‡ºæ–°çš„ä¸»èŠ‚ç‚¹</li>
</ul>
<p>é€‰ä¸¾æ–°ä¸»èŠ‚ç‚¹çš„æ–¹æ³•å’Œé€‰ä¸¾é¢†å¤´ Sentinel çš„æ–¹æ³•éå¸¸ç›¸ä¼¼ï¼Œä¸¤è€…éƒ½æ˜¯åŸºäº Raft ç®—æ³•çš„é¢†å¤´é€‰ä¸¾ï¼ˆleader electionï¼‰æ–¹æ³•å®ç°çš„</p>
<hr>
<h3 id="æ¶ˆæ¯æœºåˆ¶">æ¶ˆæ¯æœºåˆ¶</h3>
<h4 id="æ¶ˆæ¯ç»“æ„">æ¶ˆæ¯ç»“æ„</h4>
<p>é›†ç¾¤ä¸­çš„å„ä¸ªèŠ‚ç‚¹é€šè¿‡å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼ˆmessageï¼‰æ¥è¿›è¡Œé€šä¿¡ï¼Œå°†å‘é€æ¶ˆæ¯çš„èŠ‚ç‚¹ç§°ä¸ºå‘é€è€…ï¼ˆsenderï¼‰ï¼Œæ¥æ”¶æ¶ˆæ¯çš„èŠ‚ç‚¹ç§°ä¸ºæ¥æ”¶è€…ï¼ˆreceiverï¼‰</p>
<p>èŠ‚ç‚¹å‘é€çš„æ¶ˆæ¯ä¸»è¦æœ‰ï¼š</p>
<ul>
<li>
<p>MEET æ¶ˆæ¯ï¼šå½“å‘é€è€…æ¥åˆ°å®¢æˆ·ç«¯å‘é€çš„ CLUSTER MEET å‘½ä»¤æ—¶ï¼Œä¼šå‘æ¥æ”¶è€…å‘é€ MEET æ¶ˆæ¯ï¼Œè¯·æ±‚æ¥æ”¶è€…åŠ å…¥åˆ°å‘é€è€…å½“å‰æ‰€å¤„çš„é›†ç¾¤é‡Œ</p>
</li>
<li>
<p>PING æ¶ˆæ¯ï¼šé›†ç¾¤é‡Œçš„æ¯ä¸ªèŠ‚ç‚¹é»˜è®¤æ¯éš”ä¸€ç§’é’Ÿå°±ä¼šä»å·²çŸ¥èŠ‚ç‚¹åˆ—è¡¨ä¸­éšæœºé€‰å‡ºäº”ä¸ªï¼Œç„¶åå¯¹è¿™äº”ä¸ªèŠ‚ç‚¹ä¸­æœ€é•¿æ—¶é—´æ²¡æœ‰å‘é€è¿‡ PING æ¶ˆæ¯çš„èŠ‚ç‚¹å‘é€ PINGï¼Œä»¥æ­¤æ¥<strong>éšæœºæ£€æµ‹</strong>è¢«é€‰ä¸­çš„èŠ‚ç‚¹æ˜¯å¦åœ¨çº¿</p>
<p>å¦‚æœèŠ‚ç‚¹ A æœ€åä¸€æ¬¡æ”¶åˆ°èŠ‚ç‚¹ B å‘é€çš„ PONG æ¶ˆæ¯çš„æ—¶é—´ï¼Œè·ç¦»å½“å‰å·²ç»è¶…è¿‡äº†èŠ‚ç‚¹ A çš„ cluster-nodeÂ­-timeout è®¾ç½®æ—¶é•¿çš„ä¸€åŠï¼Œé‚£ä¹ˆ A ä¹Ÿä¼šå‘ B å‘é€ PING æ¶ˆæ¯ï¼Œé˜²æ­¢ A å› ä¸ºé•¿æ—¶é—´æ²¡æœ‰éšæœºé€‰ä¸­ B å‘é€ PINGï¼Œè€Œå¯¼è‡´å¯¹èŠ‚ç‚¹ B çš„ä¿¡æ¯æ›´æ–°æ»å</p>
</li>
<li>
<p>PONG æ¶ˆæ¯ï¼šå½“æ¥æ”¶è€…æ”¶åˆ° MEET æ¶ˆæ¯æˆ–è€… PING æ¶ˆæ¯æ—¶ï¼Œä¸ºäº†è®©å‘é€è€…ç¡®è®¤å·²ç»æˆåŠŸæ¥æ”¶æ¶ˆæ¯ï¼Œä¼šå‘å‘é€è€…è¿”å›ä¸€æ¡ PONGï¼›èŠ‚ç‚¹ä¹Ÿå¯ä»¥é€šè¿‡å‘é›†ç¾¤å¹¿æ’­ PONG æ¶ˆæ¯æ¥è®©é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ç«‹å³åˆ·æ–°å…³äºè¿™ä¸ªèŠ‚ç‚¹çš„è®¤è¯†ï¼ˆä»å‡çº§ä¸ºä¸»ï¼‰</p>
</li>
<li>
<p>FAIL æ¶ˆæ¯ï¼šå½“ä¸€ä¸ªä¸»èŠ‚ç‚¹ A åˆ¤æ–­å¦ä¸€ä¸ªä¸»èŠ‚ç‚¹ B å·²ç»è¿›å…¥ FAIL çŠ¶æ€æ—¶ï¼ŒèŠ‚ç‚¹ A ä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡ B èŠ‚ç‚¹çš„ FAIL ä¿¡æ¯</p>
</li>
<li>
<p>PUBLISH æ¶ˆæ¯ï¼šå½“èŠ‚ç‚¹æ¥æ”¶åˆ°ä¸€ä¸ª PUBLISH å‘½ä»¤æ—¶ï¼ŒèŠ‚ç‚¹ä¼šæ‰§è¡Œè¿™ä¸ªå‘½ä»¤å¹¶å‘é›†ç¾¤å¹¿æ’­ä¸€æ¡ PUBLISH æ¶ˆæ¯ï¼Œæ¥æ”¶åˆ° PUBLISH æ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šæ‰§è¡Œç›¸åŒçš„ PUBLISH å‘½ä»¤</p>
</li>
</ul>
<hr>
<h4 id="æ¶ˆæ¯å¤´">æ¶ˆæ¯å¤´</h4>
<p>èŠ‚ç‚¹å‘é€çš„æ‰€æœ‰æ¶ˆæ¯éƒ½ç”±ä¸€ä¸ªæ¶ˆæ¯å¤´åŒ…è£¹ï¼Œæ¶ˆæ¯å¤´é™¤äº†åŒ…å«æ¶ˆæ¯æ­£æ–‡ä¹‹å¤–ï¼Œè¿˜è®°å½•äº†æ¶ˆæ¯å‘é€è€…è‡ªèº«çš„ä¸€äº›ä¿¡æ¯</p>
<p>æ¶ˆæ¯å¤´ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">clusterMsg</span> &#123;</span></span><br><span class="line">    <span class="comment">// æ¶ˆæ¯çš„é•¿åº¦ï¼ˆåŒ…æ‹¬è¿™ä¸ªæ¶ˆæ¯å¤´çš„é•¿åº¦å’Œæ¶ˆæ¯æ­£æ–‡çš„é•¿åº¦ï¼‰</span></span><br><span class="line">	<span class="type">uint32_t</span> totlen;</span><br><span class="line">	<span class="comment">// æ¶ˆæ¯çš„ç±»å‹</span></span><br><span class="line">	<span class="type">uint16_t</span> type;</span><br><span class="line">    <span class="comment">// æ¶ˆæ¯æ­£æ–‡åŒ…å«çš„èŠ‚ç‚¹ä¿¡æ¯æ•°é‡ï¼Œåªåœ¨å‘é€MEETã€PINGã€PONGè¿™ä¸‰ç§Gossipåè®®æ¶ˆæ¯æ—¶ä½¿ç”¨ </span></span><br><span class="line">    <span class="type">uint16_t</span> count;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘é€è€…æ‰€å¤„çš„é…ç½®çºªå…ƒ</span></span><br><span class="line">    <span class="type">uint64_t</span> currentEpoch;</span><br><span class="line">    <span class="comment">// å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯å‘é€è€…çš„é…ç½®çºªå…ƒ</span></span><br><span class="line">    <span class="comment">// å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯å‘é€è€…æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹çš„é…ç½®çºªå…ƒ</span></span><br><span class="line">    <span class="type">uint64_t</span> configEpoch;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘é€è€…çš„åå­—(ID)</span></span><br><span class="line">	<span class="type">char</span> sender[REDIS CLUSTER NAMELEN];</span><br><span class="line">	<span class="comment">// å‘é€è€…ç›®å‰çš„æ§½æŒ‡æ´¾ä¿¡æ¯</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> myslots[REDIS_CLUSTER_SLOTS/<span class="number">8</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯å‘é€è€…æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹çš„åå­—</span></span><br><span class="line">    <span class="comment">// å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯ REDIS_NODE_NULL_NAMEï¼Œä¸€ä¸ª 40 å®‡èŠ‚é•¿å€¼å…¨ä¸º 0 çš„å­—èŠ‚æ•°ç»„</span></span><br><span class="line">    <span class="type">char</span> slaveof[REDIS_CLUSTER_NAMELEN];</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// å‘é€è€…çš„ç«¯å£å·</span></span><br><span class="line">	<span class="type">uint16_t</span> port;</span><br><span class="line">	<span class="comment">// å‘é€è€…çš„æ ‡è¯†å€¼</span></span><br><span class="line">    <span class="type">uint16_t</span> flags; </span><br><span class="line">	<span class="comment">//å‘é€è€…æ‰€å¤„é›†ç¾¤çš„çŠ¶æ€</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> state;</span><br><span class="line">	<span class="comment">// æ¶ˆæ¯çš„æ­£æ–‡ï¼ˆæˆ–è€…è¯´ï¼Œ å†…å®¹ï¼‰ </span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">clusterMsgData</span> <span class="title">data</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>clusterMsg ç»“æ„çš„ currentEpochã€senderã€myslots ç­‰å±æ€§è®°å½•äº†å‘é€è€…çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œæ¥æ”¶è€…ä¼šæ ¹æ®è¿™äº›ä¿¡æ¯åœ¨ clusterState.nodes å­—å…¸é‡Œæ‰¾åˆ°å‘é€è€…å¯¹åº”çš„ clusterNode ç»“æ„ï¼Œå¹¶å¯¹ç»“æ„è¿›è¡Œæ›´æ–°ï¼Œæ¯”å¦‚<strong>ä¼ æ’­èŠ‚ç‚¹çš„æ§½æŒ‡æ´¾ä¿¡æ¯</strong></p>
<p>æ¶ˆæ¯æ­£æ–‡ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">clusterMsgData</span> &#123;</span></span><br><span class="line">    <span class="comment">// MEETã€PINGã€PONG æ¶ˆæ¯çš„æ­£æ–‡</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="comment">// æ¯æ¡ MEETã€PINGã€PONG æ¶ˆæ¯éƒ½åŒ…å«ä¸¤ä¸ª clusterMsgDataGossip ç»“æ„</span></span><br><span class="line">        clusterMsgDataGossip gossip[<span class="number">1</span>];</span><br><span class="line">    &#125; ping;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// FAIL æ¶ˆæ¯çš„æ­£æ–‡</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span> </span><br><span class="line">		clusterMsgDataFail about;</span><br><span class="line">    &#125; fail;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PUBLISH æ¶ˆæ¯çš„æ­£æ–‡</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    	clusterMsgDataPublish msg;</span><br><span class="line">    &#125; publish;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…¶ä»–æ¶ˆæ¯æ­£æ–‡...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="Gossip">Gossip</h4>
<p>Redis é›†ç¾¤ä¸­çš„å„ä¸ªèŠ‚ç‚¹é€šè¿‡ Gossip åè®®æ¥äº¤æ¢å„è‡ªå…³äºä¸åŒèŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯ï¼Œå…¶ä¸­ Gossip åè®®ç”± MEETã€PINGã€PONG æ¶ˆæ¯å®ç°ï¼Œä¸‰ç§æ¶ˆæ¯ä½¿ç”¨ç›¸åŒçš„æ¶ˆæ¯æ­£æ–‡ï¼Œæ‰€ä»¥èŠ‚ç‚¹é€šè¿‡æ¶ˆæ¯å¤´çš„ type å±æ€§æ¥åˆ¤æ–­æ¶ˆæ¯çš„å…·ä½“ç±»å‹</p>
<p>å‘é€è€…å‘é€è¿™ä¸‰ç§æ¶ˆæ¯æ—¶ï¼Œä¼šä»å·²çŸ¥èŠ‚ç‚¹åˆ—è¡¨ä¸­<strong>éšæœºé€‰å‡ºä¸¤ä¸ªèŠ‚ç‚¹</strong>ï¼ˆä¸»ä»éƒ½å¯ä»¥ï¼‰ï¼Œå°†ä¸¤ä¸ªè¢«é€‰ä¸­èŠ‚ç‚¹ä¿¡æ¯ä¿å­˜åˆ°ä¸¤ä¸ª Gossip ç»“æ„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">clusterMsgDataGossip</span> &#123;</span></span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹çš„åå­—</span></span><br><span class="line">	<span class="type">char</span> nodename[REDIS CLUSTER NAMELEN];</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// æœ€åä¸€æ¬¡å‘è¯¥èŠ‚ç‚¹å‘é€PINGæ¶ˆæ¯çš„æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="type">uint32_t</span> ping_sent;</span><br><span class="line">	<span class="comment">// æœ€åä¸€æ¬¡ä»è¯¥èŠ‚ç‚¹æ¥æ”¶åˆ°PONGæ¶ˆæ¯çš„æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="type">uint32_t</span> pong_received;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// èŠ‚ç‚¹çš„IPåœ°å€</span></span><br><span class="line">	<span class="type">char</span> ip[<span class="number">16</span>];</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹çš„ç«¯å£å·</span></span><br><span class="line">    <span class="type">uint16_t</span> port;</span><br><span class="line">	<span class="comment">// èŠ‚ç‚¹çš„æ ‡è¯†å€¼</span></span><br><span class="line">    <span class="type">uint16_t</span> flags;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“æ¥æ”¶è€…æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œä¼šè®¿é—®æ¶ˆæ¯æ­£æ–‡ä¸­çš„ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼Œæ¥è¿›è¡Œç›¸å…³æ“ä½œ</p>
<ul>
<li>å¦‚æœè¢«é€‰ä¸­èŠ‚ç‚¹ä¸å­˜åœ¨äºæ¥æ”¶è€…çš„å·²çŸ¥èŠ‚ç‚¹åˆ—è¡¨ï¼Œæ¥æ”¶è€…å°†æ ¹æ®ç»“æ„ä¸­è®°å½•çš„ IP åœ°å€å’Œç«¯å£å·ï¼Œä¸èŠ‚ç‚¹è¿›è¡Œæ¡æ‰‹</li>
<li>å¦‚æœå­˜åœ¨ï¼Œæ ¹æ® Gossip ç»“æ„è®°å½•çš„ä¿¡æ¯å¯¹èŠ‚ç‚¹æ‰€å¯¹åº”çš„ clusterNode ç»“æ„è¿›è¡Œæ›´æ–°</li>
</ul>
<hr>
<h4 id="FAIL">FAIL</h4>
<p>åœ¨é›†ç¾¤çš„èŠ‚ç‚¹æ•°é‡æ¯”è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Gossip åè®®æ¥ä¼ æ’­èŠ‚ç‚¹çš„å·²ä¸‹çº¿ä¿¡æ¯ä¼šå¸¦æ¥ä¸€å®šå»¶è¿Ÿï¼Œå› ä¸º Gossip åè®®æ¶ˆæ¯é€šå¸¸éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½ä¼ æ’­è‡³æ•´ä¸ªé›†ç¾¤ï¼Œæ‰€ä»¥é€šè¿‡å‘é€ FAILæ¶ˆæ¯å¯ä»¥è®©é›†ç¾¤é‡Œçš„æ‰€æœ‰èŠ‚ç‚¹ç«‹å³çŸ¥é“æŸä¸ªä¸»èŠ‚ç‚¹å·²ä¸‹çº¿ï¼Œä»è€Œå°½å¿«è¿›è¡Œå…¶ä»–æ“ä½œ</p>
<p>FAIL æ¶ˆæ¯çš„æ­£æ–‡ç”± clusterMsgDataFail ç»“æ„è¡¨ç¤ºï¼Œè¯¥ç»“æ„åªæœ‰ä¸€ä¸ªå±æ€§ï¼Œè®°å½•äº†å·²ä¸‹çº¿èŠ‚ç‚¹çš„åå­—</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">clusterMsgDataFail</span> &#123;</span></span><br><span class="line">	<span class="type">char</span> nodename[REDIS_CLUSTER_NAMELEN)];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºä¼ æ’­ä¸‹çº¿ä¿¡æ¯ä¸éœ€è¦å…¶ä»–å±æ€§ï¼Œæ‰€ä»¥èŠ‚çœäº†ä¼ æ’­çš„èµ„æº</p>
<hr>
<h4 id="PUBLISH">PUBLISH</h4>
<p>å½“å®¢æˆ·ç«¯å‘é›†ç¾¤ä¸­çš„æŸä¸ªèŠ‚ç‚¹å‘é€å‘½ä»¤ï¼Œæ¥æ”¶åˆ° PUBLISH å‘½ä»¤çš„èŠ‚ç‚¹ä¸ä»…ä¼šå‘ channel é¢‘é“å‘é€æ¶ˆæ¯ messageï¼Œè¿˜ä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡ PUBLISH æ¶ˆæ¯ï¼Œæ‰€æœ‰æ¥æ”¶åˆ°è¿™æ¡ PUBLISH æ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šå‘ channel é¢‘é“å‘é€ message æ¶ˆæ¯ï¼Œæœ€ç»ˆé›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹éƒ½å‘äº†</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUBLISH &lt;channel&gt; &lt;message&gt; </span><br></pre></td></tr></table></figure>
<p>PUBLISH æ¶ˆæ¯çš„æ­£æ–‡ç”± clusterMsgDataPublish ç»“æ„è¡¨ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">clusterMsgDataPublish</span> &#123;</span></span><br><span class="line">    <span class="comment">// channelå‚æ•°çš„é•¿åº¦</span></span><br><span class="line">    <span class="type">uint32_t</span> channel_len;</span><br><span class="line">    <span class="comment">// messageå‚æ•°çš„é•¿åº¦</span></span><br><span class="line">    <span class="type">uint32_t</span> message_len;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å®šä¹‰ä¸º8å­—èŠ‚åªæ˜¯ä¸ºäº†å¯¹é½å…¶ä»–æ¶ˆæ¯ç»“æ„ï¼Œå®é™…çš„é•¿åº¦ç”±ä¿å­˜çš„å†…å®¹å†³å®š</span></span><br><span class="line">    <span class="comment">// bulk_data çš„ 0 è‡³ channel_len-1 å­—èŠ‚ä¿å­˜çš„æ˜¯channelå‚æ•°</span></span><br><span class="line">    <span class="comment">// bulk_dataçš„ channel_len å­—èŠ‚è‡³ channel_len + message_len-1 å­—èŠ‚ä¿å­˜çš„åˆ™æ˜¯messageå‚æ•°</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> bulk_data[<span class="number">8</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è®©é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œç›¸åŒçš„ PUBLISH å‘½ä»¤ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯å‘æ‰€æœ‰èŠ‚ç‚¹å¹¿æ’­ç›¸åŒçš„ PUBLISH å‘½ä»¤ï¼Œè¿™ä¹Ÿæ˜¯ Redis å¤åˆ¶ PUBLISH å‘½ä»¤æ—¶æ‰€ä½¿ç”¨çš„ï¼Œä½†æ˜¯è¿™ç§åšæ³•å¹¶ä¸ç¬¦åˆ Redis é›†ç¾¤çš„å„<strong>ä¸ªèŠ‚ç‚¹é€šè¿‡å‘é€å’Œæ¥æ”¶æ¶ˆæ¯æ¥è¿›è¡Œé€šä¿¡</strong>çš„è§„åˆ™</p>
<hr>
<h3 id="è„‘è£‚é—®é¢˜">è„‘è£‚é—®é¢˜</h3>
<p>è„‘è£‚æŒ‡åœ¨ä¸»ä»é›†ç¾¤ä¸­ï¼ŒåŒæ—¶æœ‰ä¸¤ä¸ªç›¸åŒçš„ä¸»èŠ‚ç‚¹èƒ½æ¥æ”¶å†™è¯·æ±‚ï¼Œå¯¼è‡´å®¢æˆ·ç«¯ä¸çŸ¥é“åº”è¯¥å¾€å“ªä¸ªä¸»èŠ‚ç‚¹å†™å…¥æ•°æ®ï¼Œæœ€å ä¸åŒå®¢æˆ·ç«¯å¾€ä¸åŒçš„ä¸»èŠ‚ç‚¹ä¸Šå†™å…¥æ•°æ®</p>
<ul>
<li>åŸä¸»èŠ‚ç‚¹å¹¶æ²¡æœ‰çœŸçš„å‘ç”Ÿæ•…éšœï¼Œç”±äºæŸäº›åŸå› æ— æ³•å¤„ç†è¯·æ±‚ï¼ˆCPU åˆ©ç”¨ç‡å¾ˆé«˜ã€è‡ªèº«é˜»å¡ï¼‰ï¼Œæ— æ³•æŒ‰æ—¶å“åº”å¿ƒè·³è¯·æ±‚ï¼Œè¢«å“¨å…µ/é›†ç¾¤ä¸»èŠ‚ç‚¹é”™è¯¯çš„åˆ¤æ–­ä¸ºä¸‹çº¿</li>
<li>åœ¨è¢«åˆ¤æ–­ä¸‹çº¿ä¹‹åï¼ŒåŸä¸»åº“åˆé‡æ–°å¼€å§‹å¤„ç†è¯·æ±‚äº†ï¼Œå“¨å…µ/é›†ç¾¤ä¸»èŠ‚ç‚¹è¿˜æ²¡æœ‰å®Œæˆä¸»ä»åˆ‡æ¢ï¼Œå®¢æˆ·ç«¯ä»ç„¶å¯ä»¥å’ŒåŸä¸»åº“é€šä¿¡ï¼Œå®¢æˆ·ç«¯å‘é€çš„å†™æ“ä½œå°±ä¼šåœ¨åŸä¸»åº“ä¸Šå†™å…¥æ•°æ®ï¼Œé€ æˆè„‘è£‚é—®é¢˜</li>
</ul>
<p>æ•°æ®ä¸¢å¤±é—®é¢˜ï¼šä»åº“ä¸€æ—¦å‡çº§ä¸ºæ–°ä¸»åº“ï¼Œå“¨å…µå°±ä¼šè®©åŸä¸»åº“æ‰§è¡Œ slave of å‘½ä»¤ï¼Œå’Œæ–°ä¸»åº“é‡æ–°è¿›è¡Œå…¨é‡åŒæ­¥ï¼ŒåŸä¸»åº“éœ€è¦æ¸…ç©ºæœ¬åœ°çš„æ•°æ®ï¼ŒåŠ è½½æ–°ä¸»åº“å‘é€çš„ RDB æ–‡ä»¶ï¼Œæ‰€ä»¥åŸä¸»åº“åœ¨ä¸»ä»åˆ‡æ¢æœŸé—´ä¿å­˜çš„æ–°å†™æ•°æ®å°±ä¸¢å¤±äº†</p>
<p>é¢„é˜²è„‘è£‚ï¼šåœ¨ä¸»ä»é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œåˆç†åœ°é…ç½®å‚æ•° min-slaves-to-write å’Œ min-slaves-max-lag</p>
<ul>
<li>å‡è®¾ä»åº“æœ‰ K ä¸ªï¼Œå¯ä»¥å°† min-slaves-to-write è®¾ç½®ä¸º K/2+1ï¼ˆå¦‚æœ K ç­‰äº 1ï¼Œå°±è®¾ä¸º 1ï¼‰</li>
<li>å°† min-slaves-max-lag è®¾ç½®ä¸ºåå‡ ç§’ï¼ˆä¾‹å¦‚ 10ï½20sï¼‰</li>
<li>åœ¨å‡æ•…éšœæœŸé—´æ— æ³•å“åº”å“¨å…µå‘å‡ºçš„å¿ƒè·³æµ‹è¯•ï¼Œæ— æ³•å’Œä»åº“è¿›è¡Œ ACK ç¡®è®¤ï¼Œå¹¶ä¸”æ²¡æœ‰è¶³å¤Ÿçš„ä»åº“ï¼Œ<strong>æ‹’ç»å®¢æˆ·ç«¯çš„å†™å…¥</strong></li>
</ul>
<hr>
<h3 id="ç»“æ„æ­å»º">ç»“æ„æ­å»º</h3>
<p>æ•´ä½“æ¡†æ¶ï¼š</p>
<ul>
<li>é…ç½®æœåŠ¡å™¨ï¼ˆ3 ä¸» 3 ä»ï¼‰</li>
<li>å»ºç«‹é€šä¿¡ï¼ˆMeetï¼‰</li>
<li>åˆ†æ§½ï¼ˆSlotï¼‰</li>
<li>æ­å»ºä¸»ä»ï¼ˆmaster-slaveï¼‰</li>
</ul>
<p>åˆ›å»ºé›†ç¾¤ conf é…ç½®æ–‡ä»¶ï¼š</p>
<ul>
<li>
<p>redis-6501.conf</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">port 6501</span><br><span class="line"><span class="built_in">dir</span> <span class="string">&quot;/redis/data&quot;</span></span><br><span class="line">dbfilename <span class="string">&quot;dump-6501.rdb&quot;</span></span><br><span class="line">cluster-enabled <span class="built_in">yes</span></span><br><span class="line">cluster-config-file <span class="string">&quot;cluster-6501.conf&quot;</span></span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line"></span><br><span class="line"><span class="comment">#å…¶ä»–é…ç½®æ–‡ä»¶å‚ç…§ä¸Šé¢çš„ä¿®æ”¹ç«¯å£å³å¯ï¼Œå†…å®¹å®Œå…¨ä¸€æ ·</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æœåŠ¡ç«¯å¯åŠ¨ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server config_file_name</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å®¢æˆ·ç«¯å¯åŠ¨ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 6504 -c</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>cluster é…ç½®ï¼š</strong></p>
<ul>
<li>
<p>æ˜¯å¦å¯ç”¨ clusterï¼ŒåŠ å…¥ cluster èŠ‚ç‚¹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster-enabled <span class="built_in">yes</span>|no</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>cluster é…ç½®æ–‡ä»¶åï¼Œè¯¥æ–‡ä»¶å±äºè‡ªåŠ¨ç”Ÿæˆï¼Œä»…ç”¨äºå¿«é€ŸæŸ¥æ‰¾æ–‡ä»¶å¹¶æŸ¥è¯¢æ–‡ä»¶å†…å®¹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster-config-file filename</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>èŠ‚ç‚¹æœåŠ¡å“åº”è¶…æ—¶æ—¶é—´ï¼Œç”¨äºåˆ¤å®šè¯¥èŠ‚ç‚¹æ˜¯å¦ä¸‹çº¿æˆ–åˆ‡æ¢ä¸ºä»èŠ‚ç‚¹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster-node-timeout milliseconds</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>master è¿æ¥çš„ slave æœ€å°æ•°é‡</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster-migration-barrier min_slave_number</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å®¢æˆ·ç«¯å¯åŠ¨å‘½ä»¤ï¼š</p>
<p><strong>cluster èŠ‚ç‚¹æ“ä½œå‘½ä»¤ï¼ˆå®¢æˆ·ç«¯å‘½ä»¤ï¼‰ï¼š</strong></p>
<ul>
<li>
<p>æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster nodes</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ›´æ”¹ slave æŒ‡å‘æ–°çš„ master</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster replicate master-id</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å‘ç°ä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œæ–°å¢ master</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster meet ip:port</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¿½ç•¥ä¸€ä¸ªæ²¡æœ‰ solt çš„èŠ‚ç‚¹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster forget server_id</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ‰‹åŠ¨æ•…éšœè½¬ç§»</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster failover</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>é›†ç¾¤æ“ä½œå‘½ä»¤ï¼ˆLinuxï¼‰ï¼š</strong></p>
<ul>
<li>
<p>åˆ›å»ºé›†ç¾¤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli â€“-cluster create masterhost1:masterport1 masterhost2:masterport2  masterhost3:masterport3 [masterhostn:masterportn â€¦] slavehost1:slaveport1  slavehost2:slaveport2 slavehost3:slaveport3 -â€“cluster-replicas n</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šmaster ä¸ slave çš„æ•°é‡è¦åŒ¹é…ï¼Œä¸€ä¸ª master å¯¹åº” n ä¸ª slaveï¼Œç”±æœ€åçš„å‚æ•° n å†³å®šã€‚master ä¸ slave çš„åŒ¹é…é¡ºåºä¸ºç¬¬ä¸€ä¸ª master ä¸å‰ n ä¸ª slave åˆ†ä¸ºä¸€ç»„ï¼Œå½¢æˆä¸»ä»ç»“æ„</p>
</li>
<li>
<p>æ·»åŠ  master åˆ°å½“å‰é›†ç¾¤ä¸­ï¼Œè¿æ¥æ—¶å¯ä»¥æŒ‡å®šä»»æ„ç°æœ‰èŠ‚ç‚¹åœ°å€ä¸ç«¯å£</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster add-node new-master-host:new-master-port now-host:now-port</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ·»åŠ  slave</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster add-node new-slave-host:new-slave-port master-host:master-port --cluster-slave --cluster-master-id masterid</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>åˆ é™¤èŠ‚ç‚¹ï¼Œå¦‚æœåˆ é™¤çš„èŠ‚ç‚¹æ˜¯ masterï¼Œå¿…é¡»ä¿éšœå…¶ä¸­æ²¡æœ‰æ§½ slot</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster del-node del-slave-host:del-slave-port del-slave-id</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‡æ–°åˆ†æ§½ï¼Œåˆ†æ§½æ˜¯ä»å…·æœ‰æ§½çš„ master ä¸­åˆ’åˆ†ä¸€éƒ¨åˆ†ç»™å…¶ä»– masterï¼Œè¿‡ç¨‹ä¸­ä¸åˆ›å»ºæ–°çš„æ§½</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster reshard new-master-host:new-master:port --cluster-from src-  master-id1, src-master-id2, src-master-idn --cluster-to target-master-id --  cluster-slots slots</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šå°†éœ€è¦å‚ä¸åˆ†æ§½çš„æ‰€æœ‰ masterid ä¸åˆ†å…ˆåé¡ºåºæ·»åŠ åˆ°å‚æ•°ä¸­ï¼Œä½¿ç”¨ <code>,</code> åˆ†éš”ï¼ŒæŒ‡å®šç›®æ ‡å¾—åˆ°çš„æ§½çš„æ•°é‡ï¼Œæ‰€æœ‰çš„æ§½å°†å¹³å‡ä»æ¯ä¸ªæ¥æºçš„ master å¤„è·å–</p>
</li>
<li>
<p>é‡æ–°åˆ†é…æ§½ï¼Œä»å…·æœ‰æ§½çš„ master ä¸­åˆ†é…æŒ‡å®šæ•°é‡çš„æ§½åˆ°å¦ä¸€ä¸ª master ä¸­ï¼Œå¸¸ç”¨äºæ¸…ç©ºæŒ‡å®š master ä¸­çš„æ§½</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster reshard src-master-host:src-master-port --cluster-from src-  master-id --cluster-to target-master-id --cluster-slots slots --cluster-yes</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="å…¶ä»–æ“ä½œ">å…¶ä»–æ“ä½œ</h2>
<h3 id="å‘å¸ƒè®¢é˜…">å‘å¸ƒè®¢é˜…</h3>
<h4 id="åŸºæœ¬æŒ‡ä»¤-2">åŸºæœ¬æŒ‡ä»¤</h4>
<p>Redis å‘å¸ƒè®¢é˜…ï¼ˆpub/subï¼‰æ˜¯ä¸€ç§æ¶ˆæ¯é€šä¿¡æ¨¡å¼ï¼šå‘é€è€…ï¼ˆpubï¼‰å‘é€æ¶ˆæ¯ï¼Œè®¢é˜…è€…ï¼ˆsubï¼‰æ¥æ”¶æ¶ˆæ¯</p>
<p>Redis å®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä»»æ„æ•°é‡çš„é¢‘é“ï¼Œæ¯å½“æœ‰å®¢æˆ·ç«¯å‘è¢«è®¢é˜…çš„é¢‘é“å‘é€æ¶ˆæ¯ï¼ˆmessageï¼‰æ—¶ï¼Œé¢‘é“çš„<strong>æ‰€æœ‰è®¢é˜…è€…éƒ½ä¼šæ”¶åˆ°æ¶ˆæ¯</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85.png" alt=""></p>
<p>æ“ä½œè¿‡ç¨‹ï¼š</p>
<ul>
<li>
<p>æ‰“å¼€ä¸€ä¸ªå®¢æˆ·ç«¯è®¢é˜… channel1ï¼š<code>SUBSCRIBE channel1</code></p>
</li>
<li>
<p>æ‰“å¼€å¦ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œç»™ channel1 å‘å¸ƒæ¶ˆæ¯ helloï¼š<code>PUBLISH channel1 hello</code></p>
</li>
<li>
<p>ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯å¯ä»¥çœ‹åˆ°å‘é€çš„æ¶ˆæ¯</p>
</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‘å¸ƒè®¢é˜…æŒ‡ä»¤æ“ä½œ.png" style="zoom:67%;" />
<p>å®¢æˆ·ç«¯è¿˜å¯ä»¥é€šè¿‡ PSUBSCRIBE å‘½ä»¤è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å¼ï¼Œæ¯å½“æœ‰å…¶ä»–å®¢æˆ·ç«¯å‘æŸä¸ªé¢‘é“å‘é€æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯ä¸ä»…ä¼šè¢«å‘é€ç»™è¿™ä¸ªé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…ï¼Œè¿˜ä¼šè¢«<strong>å‘é€ç»™æ‰€æœ‰ä¸è¿™ä¸ªé¢‘é“ç›¸åŒ¹é…çš„æ¨¡å¼çš„è®¢é˜…è€…</strong>ï¼Œæ¯”å¦‚ <code>PSUBSCRIBE channel*</code> è®¢é˜…æ¨¡å¼ï¼Œä¸ channel1 åŒ¹é…</p>
<p>æ³¨æ„ï¼šå‘å¸ƒçš„æ¶ˆæ¯æ²¡æœ‰æŒä¹…åŒ–ï¼Œæ‰€ä»¥è®¢é˜…çš„å®¢æˆ·ç«¯åªèƒ½æ”¶åˆ°è®¢é˜…åå‘å¸ƒçš„æ¶ˆæ¯</p>
<hr>
<h4 id="é¢‘é“æ“ä½œ">é¢‘é“æ“ä½œ</h4>
<p>Redis å°†æ‰€æœ‰é¢‘é“çš„è®¢é˜…å…³ç³»éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨çŠ¶æ€çš„ pubsub_channels å­—å…¸é‡Œï¼Œé”®æ˜¯æŸä¸ªè¢«è®¢é˜…çš„é¢‘é“ï¼Œå€¼æ˜¯ä¸€ä¸ªè®°å½•æ‰€æœ‰è®¢é˜…è¿™ä¸ªé¢‘é“çš„å®¢æˆ·ç«¯é“¾è¡¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">	<span class="comment">// ä¿å­˜æ‰€æœ‰é¢‘é“çš„è®¢é˜…å…³ç³»ï¼Œ</span></span><br><span class="line">	dict *pubsub_channels;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®¢æˆ·ç«¯æ‰§è¡Œ SUBSCRIBE å‘½ä»¤è®¢é˜…æŸä¸ªæˆ–æŸäº›é¢‘é“ï¼ŒæœåŠ¡å™¨ä¼šå°†å®¢æˆ·ç«¯ä¸é¢‘é“è¿›è¡Œå…³è”ï¼š</p>
<ul>
<li>é¢‘é“å·²ç»å­˜åœ¨ï¼Œç›´æ¥å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°é“¾è¡¨æœ«å°¾</li>
<li>é¢‘é“è¿˜æœªæœ‰ä»»ä½•è®¢é˜…è€…ï¼Œåœ¨å­—å…¸ä¸­ä¸ºé¢‘é“åˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹ï¼Œå†å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°é“¾è¡¨</li>
</ul>
<p>UNSUBSCRIBE å‘½ä»¤ç”¨æ¥é€€è®¢æŸä¸ªé¢‘é“ï¼ŒæœåŠ¡å™¨å°†ä» pubsub_channels ä¸­è§£é™¤å®¢æˆ·ç«¯ä¸è¢«é€€è®¢é¢‘é“ä¹‹é—´çš„å…³è”</p>
<hr>
<h4 id="æ¨¡å¼æ“ä½œ">æ¨¡å¼æ“ä½œ</h4>
<p>Redis æœåŠ¡å™¨å°†æ‰€æœ‰æ¨¡å¼çš„è®¢é˜…å…³ç³»éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨çŠ¶æ€çš„ pubsub_patterns å±æ€§é‡Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">	<span class="comment">// ä¿å­˜æ‰€æœ‰æ¨¡å¼è®¢é˜…å…³ç³»ï¼Œé“¾è¡¨ä¸­æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ª pubsubPattern</span></span><br><span class="line">	<span class="built_in">list</span> *pubsub_patterns;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">pubsubPattern</span> &#123;</span></span><br><span class="line">    <span class="comment">// è®¢é˜…çš„å®¢æˆ·ç«¯</span></span><br><span class="line">    redisClient *client;</span><br><span class="line">	<span class="comment">// è¢«è®¢é˜…çš„æ¨¡å¼ï¼Œæ¯”å¦‚  channel*</span></span><br><span class="line">    robj *pattern; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®¢æˆ·ç«¯æ‰§è¡Œ PSUBSCRIBE å‘½ä»¤è®¢é˜…æŸä¸ªæ¨¡å¼ï¼ŒæœåŠ¡å™¨ä¼šæ–°å»ºä¸€ä¸ª pubsubPattern ç»“æ„å¹¶èµ‹å€¼ï¼Œæ”¾å…¥ pubsub_patterns é“¾è¡¨ç»“å°¾</p>
<p>æ¨¡å¼çš„é€€è®¢å‘½ä»¤ PUNSUBSCRIBE æ˜¯è®¢é˜…å‘½ä»¤çš„åæ“ä½œï¼ŒæœåŠ¡å™¨åœ¨ pubsub_patterns é“¾è¡¨ä¸­æŸ¥æ‰¾å¹¶åˆ é™¤å¯¹åº”çš„ç»“æ„</p>
<hr>
<h4 id="å‘é€æ¶ˆæ¯">å‘é€æ¶ˆæ¯</h4>
<p>Redis å®¢æˆ·ç«¯æ‰§è¡Œ <code>PUBLISH &lt;channel&gt; &lt;message&gt;</code> å‘½ä»¤å°†æ¶ˆæ¯ messageå‘é€ç»™é¢‘é“ channelï¼ŒæœåŠ¡å™¨ä¼šæ‰§è¡Œï¼š</p>
<ul>
<li>åœ¨ pubsub_channels å­—å…¸é‡Œæ‰¾åˆ°é¢‘é“ channel çš„è®¢é˜…è€…åå•ï¼Œå°†æ¶ˆæ¯ message å‘é€ç»™æ‰€æœ‰è®¢é˜…è€…</li>
<li>éå†æ•´ä¸ª pubsub_patterns é“¾è¡¨ï¼ŒæŸ¥æ‰¾ä¸ channel é¢‘é“ç›¸<strong>åŒ¹é…çš„æ¨¡å¼</strong>ï¼Œå¹¶å°†æ¶ˆæ¯å‘é€ç»™æ‰€æœ‰è®¢é˜…äº†è¿™äº›æ¨¡å¼çš„å®¢æˆ·ç«¯</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœé¢‘é“å’Œæ¨¡å¼ç›¸åŒ¹é…</span></span><br><span class="line"><span class="keyword">if</span> <span class="title function_">match</span><span class="params">(channel, pubsubPattern.pattern)</span> &#123;</span><br><span class="line">    <span class="comment">// å°†æ¶ˆæ¯å‘é€ç»™è®¢é˜…è¯¥æ¨¡å¼çš„å®¢æˆ·ç«¯</span></span><br><span class="line">    send_message(pubsubPattern.client, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="æŸ¥çœ‹ä¿¡æ¯">æŸ¥çœ‹ä¿¡æ¯</h4>
<p>PUBSUB å‘½ä»¤ç”¨æ¥æŸ¥çœ‹é¢‘é“æˆ–è€…æ¨¡å¼çš„ç›¸å…³ä¿¡æ¯</p>
<p><code>PUBSUB CHANNELS [pattern]</code> è¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…çš„é¢‘é“ï¼Œå…¶ä¸­ pattern å‚æ•°æ˜¯å¯é€‰çš„</p>
<ul>
<li>å¦‚æœä¸ç»™å®š pattern  å‚æ•°ï¼Œé‚£ä¹ˆå‘½ä»¤è¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…çš„æ‰€æœ‰é¢‘é“</li>
<li>å¦‚æœç»™å®š pattern å‚æ•°ï¼Œé‚£ä¹ˆå‘½ä»¤è¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…çš„é¢‘é“ä¸­ä¸ pattern æ¨¡å¼ç›¸åŒ¹é…çš„é¢‘é“</li>
</ul>
<p><code>PUBSUB NUMSUB [channel-1 channel-2 ... channel-n]</code>  å‘½ä»¤æ¥å—ä»»æ„å¤šä¸ªé¢‘é“ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œå¹¶è¿”å›è¿™äº›é¢‘é“çš„è®¢é˜…è€…æ•°é‡</p>
<p><code>PUBSUB NUMPAT</code> å‘½ä»¤ç”¨äºè¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…æ¨¡å¼çš„æ•°é‡</p>
<hr>
<h3 id="ACL-æŒ‡ä»¤">ACL æŒ‡ä»¤</h3>
<p>Redis ACL æ˜¯ Access Control Listï¼ˆè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰çš„ç¼©å†™ï¼Œè¯¥åŠŸèƒ½å…è®¸æ ¹æ®å¯ä»¥æ‰§è¡Œçš„å‘½ä»¤å’Œå¯ä»¥è®¿é—®çš„é”®æ¥é™åˆ¶æŸäº›è¿æ¥</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-ACL%E6%8C%87%E4%BB%A4.png" alt=""></p>
<ul>
<li>
<p>acl catï¼šæŸ¥çœ‹æ·»åŠ æƒé™æŒ‡ä»¤ç±»åˆ«</p>
</li>
<li>
<p>acl whoamiï¼šæŸ¥çœ‹å½“å‰ç”¨æˆ·</p>
</li>
<li>
<p>acl setuser username on &gt;password ~cached:* +getï¼šè®¾ç½®æœ‰ç”¨æˆ·åã€å¯†ç ã€ACL æƒé™ï¼ˆåªèƒ½ getï¼‰</p>
</li>
</ul>
<hr>
<h3 id="ç›‘è§†å™¨">ç›‘è§†å™¨</h3>
<p>MONITOR å‘½ä»¤ï¼Œå¯ä»¥å°†å®¢æˆ·ç«¯å˜ä¸ºä¸€ä¸ªç›‘è§†å™¨ï¼Œå®æ—¶åœ°æ¥æ”¶å¹¶æ‰“å°å‡ºæœåŠ¡å™¨å½“å‰å¤„ç†çš„å‘½ä»¤è¯·æ±‚çš„ç›¸å…³ä¿¡æ¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®ç°åŸç†</span></span><br><span class="line">def <span class="title function_">MONITOR</span><span class="params">()</span>:</span><br><span class="line">	<span class="comment">// æ‰“å¼€å®¢æˆ·ç«¯çš„ç›‘è§†å™¨æ ‡å¿—</span></span><br><span class="line">	client.flags |= REDIS_MONITOR</span><br><span class="line">        </span><br><span class="line">  	<span class="comment">// å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°æœåŠ¡å™¨çŠ¶æ€çš„ redisServer.monitorsé“¾è¡¨çš„æœ«å°¾</span></span><br><span class="line">   	server.monitors.append(client)</span><br><span class="line">  	<span class="comment">// å‘å®¢æˆ·ç«¯è¿”å› ok</span></span><br><span class="line">	send_reply(<span class="string">&quot;OK&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>æœåŠ¡å™¨æ¯æ¬¡å¤„ç†å‘½ä»¤è¯·æ±‚éƒ½ä¼šè°ƒç”¨ replicationFeedMonitors å‡½æ•°ï¼Œå‡½æ•°å°†è¢«å¤„ç†çš„å‘½ä»¤è¯·æ±‚çš„ç›¸å…³ä¿¡æ¯<strong>å‘é€ç»™å„ä¸ªç›‘è§†å™¨</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-ç›‘è§†å™¨.png" style="zoom:50%;" />
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; MONITOR </span><br><span class="line">OK </span><br><span class="line">1378822099.421623 [0 127.0.0.1:56604] <span class="string">&quot;PING&quot;</span> </span><br><span class="line">1378822105.089572 [0 127.0.0.1:56604] <span class="string">&quot;SET&quot;</span> <span class="string">&quot;msg&quot;</span> <span class="string">&quot;hello world&quot;</span> </span><br><span class="line">1378822109.036925 [0 127.0.0.1:56604] <span class="string">&quot;SET&quot;</span> <span class="string">&quot;number&quot;</span> <span class="string">&quot;123&quot;</span> </span><br><span class="line">1378822140.649496 (0 127.0.0.1:56604] <span class="string">&quot;SADD&quot;</span> <span class="string">&quot;fruits&quot;</span> <span class="string">&quot;Apple&quot;</span> <span class="string">&quot;Banana&quot;</span> <span class="string">&quot;Cherry&quot;</span> </span><br><span class="line">1378822154.117160 [0 127.0.0.1:56604] <span class="string">&quot;EXPIRE&quot;</span> <span class="string">&quot;msg&quot;</span> <span class="string">&quot;10086&quot;</span> </span><br><span class="line">1378822257.329412 [0 127.0.0.1:56604] <span class="string">&quot;KEYS&quot;</span> <span class="string">&quot;*&quot;</span> </span><br><span class="line">1378822258.690131 [0 127.0.0.1:56604] <span class="string">&quot;DBSIZE&quot;</span> </span><br></pre></td></tr></table></figure>
<hr>
<h3 id="æ‰¹å¤„ç†">æ‰¹å¤„ç†</h3>
<p>Redis çš„ç®¡é“ Pipeline æœºåˆ¶å¯ä»¥ä¸€æ¬¡å¤„ç†å¤šæ¡æŒ‡ä»¤</p>
<ul>
<li>Pipeline ä¸­çš„å¤šæ¡å‘½ä»¤éåŸå­æ€§ï¼Œå› ä¸ºåœ¨å‘ç®¡é“å†…æ·»åŠ å‘½ä»¤æ—¶ï¼Œå…¶ä»–å®¢æˆ·ç«¯çš„å‘é€çš„å‘½ä»¤ä»ç„¶åœ¨æ‰§è¡Œ</li>
<li>åŸç”Ÿæ‰¹å‘½ä»¤ï¼ˆMSET ç­‰ï¼‰æ˜¯æœåŠ¡ç«¯å®ç°ï¼Œè€Œ Pipeline éœ€è¦æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯å…±åŒå®Œæˆ</li>
</ul>
<p>ä½¿ç”¨ Pipeline å°è£…çš„å‘½ä»¤æ•°é‡ä¸èƒ½å¤ªå¤šï¼Œæ•°æ®é‡è¿‡å¤§ä¼šå¢åŠ å®¢æˆ·ç«¯çš„ç­‰å¾…æ—¶é—´ï¼Œé€ æˆç½‘ç»œé˜»å¡ï¼ŒJedis ä¸­çš„ Pipeline ä½¿ç”¨æ–¹å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºç®¡é“</span></span><br><span class="line"><span class="type">Pipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> jedis.pipelined();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">100000</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// æ”¾å…¥å‘½ä»¤åˆ°ç®¡é“</span></span><br><span class="line">    pipeline.set(<span class="string">&quot;key_&quot;</span> + i, <span class="string">&quot;value_&quot;</span> + i);</span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">1000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// æ¯æ”¾å…¥1000æ¡å‘½ä»¤ï¼Œæ‰¹é‡æ‰§è¡Œ</span></span><br><span class="line">        pipeline.sync();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é›†ç¾¤ä¸‹æ¨¡å¼ä¸‹ï¼Œæ‰¹å¤„ç†å‘½ä»¤çš„å¤šä¸ª key å¿…é¡»è½åœ¨ä¸€ä¸ªæ’æ§½ä¸­ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´æ‰§è¡Œå¤±è´¥ï¼ŒN æ¡æ‰¹å¤„ç†å‘½ä»¤çš„ä¼˜åŒ–æ–¹å¼ï¼š</p>
<ul>
<li>ä¸²è¡Œå‘½ä»¤ï¼šfor å¾ªç¯éå†ï¼Œä¾æ¬¡æ‰§è¡Œæ¯ä¸ªå‘½ä»¤</li>
<li>ä¸²è¡Œ slotï¼šåœ¨å®¢æˆ·ç«¯è®¡ç®—æ¯ä¸ª key çš„ slotï¼Œå°† slot ä¸€è‡´çš„åˆ†ä¸ºä¸€ç»„ï¼Œæ¯ç»„éƒ½åˆ©ç”¨ Pipeline æ‰¹å¤„ç†ï¼Œä¸²è¡Œæ‰§è¡Œå„ç»„å‘½ä»¤</li>
<li>å¹¶è¡Œ slotï¼šåœ¨å®¢æˆ·ç«¯è®¡ç®—æ¯ä¸ª key çš„ slotï¼Œå°† slot ä¸€è‡´çš„åˆ†ä¸ºä¸€ç»„ï¼Œæ¯ç»„éƒ½åˆ©ç”¨ Pipeline æ‰¹å¤„ç†ï¼Œ<strong>å¹¶è¡Œæ‰§è¡Œå„ç»„å‘½ä»¤</strong></li>
<li>hash_tagï¼šå°†æ‰€æœ‰ key è®¾ç½®ç›¸åŒçš„ hash_tagï¼Œåˆ™æ‰€æœ‰ key çš„ slot ä¸€å®šç›¸åŒ</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>è€—æ—¶</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä¸²è¡Œå‘½ä»¤</td>
<td>N æ¬¡ç½‘ç»œè€—æ—¶ + N æ¬¡å‘½ä»¤è€—æ—¶</td>
<td>å®ç°ç®€å•</td>
<td>è€—æ—¶ä¹…</td>
</tr>
<tr>
<td>ä¸²è¡Œ slot</td>
<td>m æ¬¡ç½‘ç»œè€—æ—¶ + N æ¬¡å‘½ä»¤è€—æ—¶ï¼Œm = key çš„ slot ä¸ªæ•°</td>
<td>è€—æ—¶è¾ƒçŸ­</td>
<td>å®ç°ç¨å¤æ‚</td>
</tr>
<tr>
<td>å¹¶è¡Œ slot</td>
<td>1 æ¬¡ç½‘ç»œè€—æ—¶ + N æ¬¡å‘½ä»¤è€—æ—¶</td>
<td>è€—æ—¶éå¸¸çŸ­</td>
<td>å®ç°å¤æ‚</td>
</tr>
<tr>
<td>hash_tag</td>
<td>1 æ¬¡ç½‘ç»œè€—æ—¶ + N æ¬¡å‘½ä»¤è€—æ—¶</td>
<td>è€—æ—¶éå¸¸çŸ­ã€å®ç°ç®€å•</td>
<td>å®¹æ˜“å‡ºç°<strong>æ•°æ®å€¾æ–œ</strong></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>
<h3 id="ç¼“å­˜æ–¹æ¡ˆ">ç¼“å­˜æ–¹æ¡ˆ</h3>
<h4 id="ç¼“å­˜æ¨¡å¼">ç¼“å­˜æ¨¡å¼</h4>
<h5 id="æ—è·¯ç¼“å­˜">æ—è·¯ç¼“å­˜</h5>
<p>ç¼“å­˜æœ¬è´¨ï¼šå¼¥è¡¥ CPU çš„é«˜ç®—åŠ›å’Œ IO çš„æ…¢è¯»å†™ä¹‹é—´å·¨å¤§çš„é¸¿æ²Ÿ</p>
<p>æ—è·¯ç¼“å­˜æ¨¡å¼ Cache Aside Pattern æ˜¯å¹³æ—¶ä½¿ç”¨æ¯”è¾ƒå¤šçš„ä¸€ä¸ªç¼“å­˜è¯»å†™æ¨¡å¼ï¼Œæ¯”è¾ƒé€‚åˆè¯»è¯·æ±‚æ¯”è¾ƒå¤šçš„åœºæ™¯</p>
<p>Cache Aside Pattern ä¸­æœåŠ¡ç«¯éœ€è¦åŒæ—¶ç»´ç³» DB å’Œ cacheï¼Œå¹¶ä¸”æ˜¯ä»¥ DB çš„ç»“æœä¸ºå‡†</p>
<ul>
<li>å†™æ“ä½œï¼šå…ˆæ›´æ–° DBï¼Œç„¶åç›´æ¥åˆ é™¤ cache</li>
<li>è¯»æ“ä½œï¼šä» cache ä¸­è¯»å–æ•°æ®ï¼Œè¯»å–åˆ°å°±ç›´æ¥è¿”å›ï¼›è¯»å–ä¸åˆ°å°±ä» DB ä¸­è¯»å–æ•°æ®è¿”å›ï¼Œå¹¶æ”¾åˆ° cache</li>
</ul>
<p>æ—¶åºå¯¼è‡´çš„ä¸ä¸€è‡´é—®é¢˜ï¼š</p>
<ul>
<li>
<p>åœ¨å†™æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œä¸èƒ½å…ˆåˆ é™¤ cache å†æ›´æ–° DBï¼Œå› ä¸ºä¼šé€ æˆç¼“å­˜çš„ä¸ä¸€è‡´ã€‚æ¯”å¦‚è¯·æ±‚ 1 å…ˆå†™æ•°æ® Aï¼Œè¯·æ±‚ 2 éšåè¯»æ•°æ® Aï¼Œå½“è¯·æ±‚ 1 åˆ é™¤ cache åï¼Œè¯·æ±‚ 2 ç›´æ¥è¯»å–äº† DBï¼Œæ­¤æ—¶è¯·æ±‚ 1 è¿˜æ²¡å†™å…¥ DBï¼ˆå»¶è¿ŸåŒåˆ ï¼‰</p>
</li>
<li>
<p>åœ¨å†™æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œå…ˆæ›´æ–° DB å†åˆ é™¤ cache ä¹Ÿä¼šå‡ºç°é—®é¢˜ï¼Œä½†æ˜¯æ¦‚ç‡å¾ˆå°ï¼Œå› ä¸ºç¼“å­˜çš„å†™å…¥é€Ÿåº¦éå¸¸å¿«</p>
</li>
</ul>
<p>æ—è·¯ç¼“å­˜çš„ç¼ºç‚¹ï¼š</p>
<ul>
<li>é¦–æ¬¡è¯·æ±‚æ•°æ®ä¸€å®šä¸åœ¨ cache çš„é—®é¢˜ï¼Œä¸€èˆ¬é‡‡ç”¨ç¼“å­˜é¢„çƒ­çš„æ–¹æ³•ï¼Œå°†çƒ­ç‚¹æ•°æ®å¯ä»¥æå‰æ”¾å…¥ cache ä¸­</li>
<li>å†™æ“ä½œæ¯”è¾ƒé¢‘ç¹çš„è¯å¯¼è‡´ cache ä¸­çš„æ•°æ®ä¼šè¢«é¢‘ç¹è¢«åˆ é™¤ï¼Œå½±å“ç¼“å­˜å‘½ä¸­ç‡</li>
</ul>
<p><strong>åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜çš„åŸå› </strong>ï¼šæ¯æ¬¡æ›´æ–°æ•°æ®åº“éƒ½æ›´æ–°ç¼“å­˜ï¼Œé€ æˆæ— æ•ˆå†™æ“ä½œè¾ƒå¤šï¼ˆæ‡’æƒ°åŠ è½½ï¼Œéœ€è¦çš„æ—¶å€™å†æ”¾å…¥ç¼“å­˜ï¼‰</p>
<hr>
<h5 id="è¯»å†™ç©¿é€">è¯»å†™ç©¿é€</h5>
<p>è¯»å†™ç©¿é€æ¨¡å¼ Read/Write Through Patternï¼šæœåŠ¡ç«¯æŠŠ cache è§†ä¸ºä¸»è¦æ•°æ®å­˜å‚¨ï¼Œä»ä¸­è¯»å–æ•°æ®å¹¶å°†æ•°æ®å†™å…¥å…¶ä¸­ï¼Œcache è´Ÿè´£å°†æ­¤æ•°æ®åŒæ­¥å†™å…¥ DBï¼Œä»è€Œå‡è½»äº†åº”ç”¨ç¨‹åºçš„èŒè´£</p>
<ul>
<li>
<p>å†™æ“ä½œï¼šå…ˆæŸ¥ cacheï¼Œcache ä¸­ä¸å­˜åœ¨ï¼Œç›´æ¥æ›´æ–° DBï¼›cache ä¸­å­˜åœ¨åˆ™å…ˆæ›´æ–° cacheï¼Œç„¶å cache æœåŠ¡æ›´æ–° DBï¼ˆåŒæ­¥æ›´æ–° cache å’Œ DBï¼‰</p>
</li>
<li>
<p>è¯»æ“ä½œï¼šä» cache ä¸­è¯»å–æ•°æ®ï¼Œè¯»å–åˆ°å°±ç›´æ¥è¿”å› ï¼›è¯»å–ä¸åˆ°å…ˆä» DB åŠ è½½ï¼Œå†™å…¥åˆ° cache åè¿”å›å“åº”</p>
<p>Read-Through Pattern å®é™…åªæ˜¯åœ¨ Cache-Aside Pattern ä¹‹ä¸Šè¿›è¡Œäº†å°è£…ã€‚åœ¨ Cache-Aside Pattern ä¸‹ï¼Œå‘ç”Ÿè¯»è¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœ cache ä¸­ä¸å­˜åœ¨å¯¹åº”çš„æ•°æ®ï¼Œæ˜¯ç”±å®¢æˆ·ç«¯è´Ÿè´£æŠŠæ•°æ®å†™å…¥ cacheï¼Œè€Œ Read Through Pattern åˆ™æ˜¯ cache æœåŠ¡è‡ªå·±æ¥å†™å…¥ç¼“å­˜çš„ï¼Œå¯¹å®¢æˆ·ç«¯æ˜¯é€æ˜çš„</p>
</li>
</ul>
<p>Read-Through Pattern ä¹Ÿå­˜åœ¨é¦–æ¬¡ä¸å‘½ä¸­çš„é—®é¢˜ï¼Œé‡‡ç”¨ç¼“å­˜é¢„çƒ­è§£å†³</p>
<hr>
<h5 id="å¼‚æ­¥ç¼“å­˜">å¼‚æ­¥ç¼“å­˜</h5>
<p>å¼‚æ­¥ç¼“å­˜å†™å…¥ Write Behind Pattern ç”± cache æœåŠ¡æ¥è´Ÿè´£ cache å’Œ DB çš„è¯»å†™ï¼Œå¯¹æ¯”è¯»å†™ç©¿é€ä¸åŒçš„æ˜¯ Write Behind Caching æ˜¯åªæ›´æ–°ç¼“å­˜ï¼Œä¸ç›´æ¥æ›´æ–° DBï¼Œæ”¹ä¸º<strong>å¼‚æ­¥æ‰¹é‡</strong>çš„æ–¹å¼æ¥æ›´æ–° DBï¼Œå¯ä»¥å‡å°å†™çš„æˆæœ¬</p>
<p>ç¼ºç‚¹ï¼šè¿™ç§æ¨¡å¼å¯¹æ•°æ®ä¸€è‡´æ€§æ²¡æœ‰é«˜è¦æ±‚ï¼Œå¯èƒ½å‡ºç° cache è¿˜æ²¡å¼‚æ­¥æ›´æ–° DBï¼ŒæœåŠ¡å°±æŒ‚æ‰äº†</p>
<p>åº”ç”¨ï¼š</p>
<ul>
<li>
<p>DB çš„å†™æ€§èƒ½éå¸¸é«˜ï¼Œé€‚åˆä¸€äº›æ•°æ®ç»å¸¸å˜åŒ–åˆå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚æµè§ˆé‡ã€ç‚¹èµé‡</p>
</li>
<li>
<p>MySQL çš„ InnoDB Buffer Pool æœºåˆ¶ç”¨åˆ°äº†è¿™ç§ç­–ç•¥</p>
</li>
</ul>
<hr>
<h4 id="ç¼“å­˜ä¸€è‡´">ç¼“å­˜ä¸€è‡´</h4>
<p>ä½¿ç”¨ç¼“å­˜ä»£è¡¨ä¸éœ€è¦å¼ºä¸€è‡´æ€§ï¼Œåªéœ€è¦æœ€ç»ˆä¸€è‡´æ€§</p>
<p>ç¼“å­˜ä¸ä¸€è‡´çš„æ–¹æ³•ï¼š</p>
<ul>
<li>
<p>æ•°æ®åº“å’Œç¼“å­˜æ•°æ®å¼ºä¸€è‡´åœºæ™¯ï¼š</p>
<ul>
<li>
<p>åŒæ­¥åŒå†™ï¼šæ›´æ–° DB æ—¶åŒæ ·æ›´æ–° cacheï¼Œä¿è¯åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œé€šè¿‡åŠ é”æ¥ä¿è¯æ›´æ–° cache æ—¶ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜</p>
</li>
<li>
<p>å»¶è¿ŸåŒåˆ ï¼šå…ˆæ·˜æ±°ç¼“å­˜å†å†™æ•°æ®åº“ï¼Œä¼‘çœ  1 ç§’å†æ¬¡æ·˜æ±°ç¼“å­˜ï¼Œå¯ä»¥å°† 1 ç§’å†…é€ æˆçš„ç¼“å­˜è„æ•°æ®å†æ¬¡åˆ é™¤</p>
</li>
<li>
<p>å¼‚æ­¥é€šçŸ¥ï¼š</p>
<ul>
<li>åŸºäº MQ çš„å¼‚æ­¥é€šçŸ¥ï¼šå¯¹æ•°æ®çš„ä¿®æ”¹åï¼Œä»£ç éœ€è¦å‘é€ä¸€æ¡æ¶ˆæ¯åˆ° MQ ä¸­ï¼Œç¼“å­˜æœåŠ¡ç›‘å¬ MQ æ¶ˆæ¯</li>
<li>Canal è®¢é˜… MySQL binlog çš„å˜æ›´ä¸ŠæŠ¥ç»™ Kafkaï¼Œç³»ç»Ÿç›‘å¬ Kafka æ¶ˆæ¯è§¦å‘ç¼“å­˜å¤±æ•ˆï¼Œæˆ–è€…ç›´æ¥å°†å˜æ›´å‘é€åˆ°å¤„ç†æœåŠ¡ï¼Œ<strong>æ²¡æœ‰ä»»ä½•ä»£ç ä¾µå…¥</strong></li>
</ul>
<p>ä½è€¦åˆï¼Œå¯ä»¥åŒæ—¶é€šçŸ¥å¤šä¸ªç¼“å­˜æœåŠ¡ï¼Œä½†æ˜¯æ—¶æ•ˆæ€§ä¸€èˆ¬ï¼Œå¯èƒ½å­˜åœ¨ä¸­é—´ä¸ä¸€è‡´çŠ¶æ€</p>
</li>
</ul>
</li>
<li>
<p>ä½ä¸€è‡´æ€§åœºæ™¯ï¼š</p>
<ul>
<li>æ›´æ–° DB çš„æ—¶å€™åŒæ ·æ›´æ–° cacheï¼Œä½†æ˜¯ç»™ç¼“å­˜åŠ ä¸€ä¸ªæ¯”è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯å³ä½¿æ•°æ®ä¸ä¸€è‡´å½±å“ä¹Ÿæ¯”è¾ƒå°</li>
<li>ä½¿ç”¨ Redis è‡ªå¸¦çš„å†…å­˜æ·˜æ±°æœºåˆ¶</li>
</ul>
</li>
</ul>
<hr>
<h4 id="ç¼“å­˜é—®é¢˜">ç¼“å­˜é—®é¢˜</h4>
<h5 id="ç¼“å­˜é¢„çƒ­">ç¼“å­˜é¢„çƒ­</h5>
<p>åœºæ™¯ï¼šå®•æœºï¼ŒæœåŠ¡å™¨å¯åŠ¨åè¿…é€Ÿå®•æœº</p>
<p>é—®é¢˜æ’æŸ¥ï¼š</p>
<ol>
<li>
<p>è¯·æ±‚æ•°é‡è¾ƒé«˜ï¼Œå¤§é‡çš„è¯·æ±‚è¿‡æ¥ä¹‹åéƒ½éœ€è¦å»ä»ç¼“å­˜ä¸­è·å–æ•°æ®ï¼Œä½†æ˜¯ç¼“å­˜ä¸­åˆæ²¡æœ‰ï¼Œæ­¤æ—¶ä»æ•°æ®åº“ä¸­æŸ¥æ‰¾æ•°æ®ç„¶åå°†æ•°æ®å†å­˜å…¥ç¼“å­˜ï¼Œé€ æˆäº†çŸ­æœŸå†…å¯¹ redis çš„é«˜å¼ºåº¦æ“ä½œä»è€Œå¯¼è‡´é—®é¢˜</p>
</li>
<li>
<p>ä¸»ä»ä¹‹é—´æ•°æ®ååé‡è¾ƒå¤§ï¼Œæ•°æ®åŒæ­¥æ“ä½œé¢‘åº¦è¾ƒé«˜</p>
</li>
</ol>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li>
<p>å‰ç½®å‡†å¤‡å·¥ä½œï¼š</p>
<ol>
<li>
<p>æ—¥å¸¸ä¾‹è¡Œç»Ÿè®¡æ•°æ®è®¿é—®è®°å½•ï¼Œç»Ÿè®¡è®¿é—®é¢‘åº¦è¾ƒé«˜çš„çƒ­ç‚¹æ•°æ®</p>
</li>
<li>
<p>åˆ©ç”¨ LRU æ•°æ®åˆ é™¤ç­–ç•¥ï¼Œæ„å»ºæ•°æ®ç•™å­˜é˜Ÿåˆ—ä¾‹å¦‚ï¼šstorm ä¸ kafka é…åˆ</p>
</li>
</ol>
</li>
<li>
<p>å‡†å¤‡å·¥ä½œï¼š</p>
<ol>
<li>
<p>å°†ç»Ÿè®¡ç»“æœä¸­çš„æ•°æ®åˆ†ç±»ï¼Œæ ¹æ®çº§åˆ«ï¼Œredis ä¼˜å…ˆåŠ è½½çº§åˆ«è¾ƒé«˜çš„çƒ­ç‚¹æ•°æ®</p>
</li>
<li>
<p>åˆ©ç”¨åˆ†å¸ƒå¼å¤šæœåŠ¡å™¨åŒæ—¶è¿›è¡Œæ•°æ®è¯»å–ï¼Œæé€Ÿæ•°æ®åŠ è½½è¿‡ç¨‹</p>
</li>
<li>
<p>çƒ­ç‚¹æ•°æ®ä¸»ä»åŒæ—¶é¢„çƒ­</p>
</li>
</ol>
</li>
<li>
<p>å®æ–½ï¼š</p>
<ol start="4">
<li>
<p>ä½¿ç”¨è„šæœ¬ç¨‹åºå›ºå®šè§¦å‘æ•°æ®é¢„çƒ­è¿‡ç¨‹</p>
</li>
<li>
<p>å¦‚æœæ¡ä»¶å…è®¸ï¼Œä½¿ç”¨äº† CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰ï¼Œæ•ˆæœä¼šæ›´å¥½</p>
</li>
</ol>
</li>
</ul>
<p>æ€»çš„æ¥è¯´ï¼šç¼“å­˜é¢„çƒ­å°±æ˜¯ç³»ç»Ÿå¯åŠ¨å‰ï¼Œæå‰å°†ç›¸å…³çš„ç¼“å­˜æ•°æ®ç›´æ¥åŠ è½½åˆ°ç¼“å­˜ç³»ç»Ÿã€‚é¿å…åœ¨ç”¨æˆ·è¯·æ±‚çš„æ—¶å€™ï¼Œå…ˆæŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå†å°†æ•°æ®ç¼“å­˜çš„é—®é¢˜ï¼Œç”¨æˆ·ç›´æ¥æŸ¥è¯¢äº‹å…ˆè¢«é¢„çƒ­çš„ç¼“å­˜æ•°æ®</p>
<hr>
<h5 id="ç¼“å­˜é›ªå´©">ç¼“å­˜é›ªå´©</h5>
<p>åœºæ™¯ï¼šæ•°æ®åº“æœåŠ¡å™¨å´©æºƒï¼Œä¸€è¿ä¸²çš„é—®é¢˜ä¼šéšä¹‹è€Œæ¥</p>
<p>é—®é¢˜æ’æŸ¥ï¼šåœ¨ä¸€ä¸ªè¾ƒçŸ­çš„æ—¶é—´å†…ï¼Œ<strong>ç¼“å­˜ä¸­è¾ƒå¤šçš„ key é›†ä¸­è¿‡æœŸ</strong>ï¼Œæ­¤å‘¨æœŸå†…è¯·æ±‚è®¿é—®è¿‡æœŸçš„æ•°æ® Redis æœªå‘½ä¸­ï¼ŒRedis å‘æ•°æ®åº“è·å–æ•°æ®ï¼Œæ•°æ®åº“åŒæ—¶æ”¶åˆ°å¤§é‡çš„è¯·æ±‚æ— æ³•åŠæ—¶å¤„ç†ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ol>
<li>åŠ é”ï¼Œæ…ç”¨</li>
<li>è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸è¿œä¸è¿‡æœŸï¼Œå¦‚æœç¼“å­˜æ•°æ®åº“æ˜¯åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå°†çƒ­ç‚¹æ•°æ®å‡åŒ€åˆ†å¸ƒåœ¨ä¸åŒæå¾—ç¼“å­˜æ•°æ®åº“ä¸­</li>
<li>ç¼“å­˜æ•°æ®çš„è¿‡æœŸæ—¶é—´è®¾ç½®éšæœºï¼Œé˜²æ­¢åŒä¸€æ—¶é—´å¤§é‡æ•°æ®è¿‡æœŸç°è±¡å‘ç”Ÿ</li>
<li>æ„å»º<strong>å¤šçº§ç¼“å­˜</strong>æ¶æ„ï¼ŒNginx ç¼“å­˜ + Redis ç¼“å­˜ + ehcache ç¼“å­˜</li>
<li>ç¾éš¾é¢„è­¦æœºåˆ¶ï¼Œç›‘æ§ Redis æœåŠ¡å™¨æ€§èƒ½æŒ‡æ ‡ï¼ŒCPU ä½¿ç”¨ç‡ã€å†…å­˜å®¹é‡ã€å¹³å‡å“åº”æ—¶é—´ã€çº¿ç¨‹æ•°</li>
<li><strong>é™æµã€é™çº§</strong>ï¼šçŸ­æ—¶é—´èŒƒå›´å†…ç‰ºç‰²ä¸€äº›å®¢æˆ·ä½“éªŒï¼Œé™åˆ¶ä¸€éƒ¨åˆ†è¯·æ±‚è®¿é—®ï¼Œé™ä½åº”ç”¨æœåŠ¡å™¨å‹åŠ›ï¼Œå¾…ä¸šåŠ¡ä½é€Ÿè¿è½¬åå†é€æ­¥æ”¾å¼€è®¿é—®</li>
</ol>
<p>æ€»çš„æ¥è¯´ï¼šç¼“å­˜é›ªå´©å°±æ˜¯ç¬é—´è¿‡æœŸæ•°æ®é‡å¤ªå¤§ï¼Œå¯¼è‡´å¯¹æ•°æ®åº“æœåŠ¡å™¨é€ æˆå‹åŠ›ã€‚å¦‚èƒ½å¤Ÿæœ‰æ•ˆé¿å…è¿‡æœŸæ—¶é—´é›†ä¸­ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³é›ªå´©ç°è±¡çš„å‡ºç°ï¼ˆçº¦ 40%ï¼‰ï¼Œé…åˆå…¶ä»–ç­–ç•¥ä¸€èµ·ä½¿ç”¨ï¼Œå¹¶ç›‘æ§æœåŠ¡å™¨çš„è¿è¡Œæ•°æ®ï¼Œæ ¹æ®è¿è¡Œè®°å½•åšå¿«é€Ÿè°ƒæ•´ã€‚</p>
<hr>
<h5 id="ç¼“å­˜å‡»ç©¿">ç¼“å­˜å‡»ç©¿</h5>
<p>ç¼“å­˜å‡»ç©¿ä¹Ÿå«çƒ­ç‚¹ Key é—®é¢˜</p>
<ol>
<li>
<p><strong>Redis ä¸­æŸä¸ª key è¿‡æœŸï¼Œè¯¥ key è®¿é—®é‡å·¨å¤§</strong></p>
</li>
<li>
<p>å¤šä¸ªæ•°æ®è¯·æ±‚ä»æœåŠ¡å™¨ç›´æ¥å‹åˆ° Redis åï¼Œå‡æœªå‘½ä¸­</p>
</li>
<li>
<p>Redis åœ¨çŸ­æ—¶é—´å†…å‘èµ·äº†å¤§é‡å¯¹æ•°æ®åº“ä¸­åŒä¸€æ•°æ®çš„è®¿é—®</p>
</li>
</ol>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ol>
<li>
<p>é¢„å…ˆè®¾å®šï¼šä»¥ç”µå•†ä¸ºä¾‹ï¼Œæ¯ä¸ªå•†å®¶æ ¹æ®åº—é“ºç­‰çº§ï¼ŒæŒ‡å®šè‹¥å¹²æ¬¾ä¸»æ‰“å•†å“ï¼Œåœ¨è´­ç‰©èŠ‚æœŸé—´ï¼ŒåŠ å¤§æ­¤ç±»ä¿¡æ¯ key çš„è¿‡æœŸæ—¶é•¿ æ³¨æ„ï¼šè´­ç‰©èŠ‚ä¸ä»…ä»…æŒ‡å½“å¤©ï¼Œä»¥åŠåç»­è‹¥å¹²å¤©ï¼Œè®¿é—®å³°å€¼å‘ˆç°é€æ¸é™ä½çš„è¶‹åŠ¿</p>
</li>
<li>
<p>ç°åœºè°ƒæ•´ï¼šç›‘æ§è®¿é—®é‡ï¼Œå¯¹è‡ªç„¶æµé‡æ¿€å¢çš„æ•°æ®<strong>å»¶é•¿è¿‡æœŸæ—¶é—´æˆ–è®¾ç½®ä¸ºæ°¸ä¹…æ€§ key</strong></p>
</li>
<li>
<p>åå°åˆ·æ–°æ•°æ®ï¼šå¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œé«˜å³°æœŸæ¥ä¸´ä¹‹å‰ï¼Œåˆ·æ–°æ•°æ®æœ‰æ•ˆæœŸï¼Œç¡®ä¿ä¸ä¸¢å¤±</p>
</li>
<li>
<p><strong>äºŒçº§ç¼“å­˜</strong>ï¼šè®¾ç½®ä¸åŒçš„å¤±æ•ˆæ—¶é—´ï¼Œä¿éšœä¸ä¼šè¢«åŒæ—¶æ·˜æ±°å°±è¡Œ</p>
</li>
<li>
<p>åŠ é”ï¼šåˆ†å¸ƒå¼é”ï¼Œé˜²æ­¢è¢«å‡»ç©¿ï¼Œä½†æ˜¯è¦æ³¨æ„ä¹Ÿæ˜¯æ€§èƒ½ç“¶é¢ˆï¼Œæ…é‡</p>
</li>
</ol>
<p>æ€»çš„æ¥è¯´ï¼šç¼“å­˜å‡»ç©¿å°±æ˜¯å•ä¸ªé«˜çƒ­æ•°æ®è¿‡æœŸçš„ç¬é—´ï¼Œæ•°æ®è®¿é—®é‡è¾ƒå¤§ï¼Œæœªå‘½ä¸­ Redis åï¼Œå‘èµ·äº†å¤§é‡å¯¹åŒä¸€æ•°æ®çš„æ•°æ®åº“è®¿é—®ï¼Œå¯¼è‡´å¯¹æ•°æ®åº“æœåŠ¡å™¨é€ æˆå‹åŠ›ã€‚åº”å¯¹ç­–ç•¥åº”è¯¥åœ¨ä¸šåŠ¡æ•°æ®åˆ†æä¸é¢„é˜²æ–¹é¢è¿›è¡Œï¼Œé…åˆè¿è¡Œç›‘æ§æµ‹è¯•ä¸å³æ—¶è°ƒæ•´ç­–ç•¥ï¼Œæ¯•ç«Ÿå•ä¸ª key çš„è¿‡æœŸç›‘æ§éš¾åº¦è¾ƒé«˜ï¼Œé…åˆé›ªå´©å¤„ç†ç­–ç•¥å³å¯</p>
<hr>
<h5 id="ç¼“å­˜ç©¿é€">ç¼“å­˜ç©¿é€</h5>
<p>åœºæ™¯ï¼šç³»ç»Ÿå¹³ç¨³è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œåº”ç”¨æœåŠ¡å™¨æµé‡éšæ—¶é—´å¢é‡è¾ƒå¤§ï¼ŒRedis æœåŠ¡å™¨å‘½ä¸­ç‡éšæ—¶é—´é€æ­¥é™ä½ï¼ŒRedis å†…å­˜å¹³ç¨³ï¼Œå†…å­˜æ— å‹åŠ›ï¼ŒRedis æœåŠ¡å™¨ CPU å ç”¨æ¿€å¢ï¼Œæ•°æ®åº“æœåŠ¡å™¨å‹åŠ›æ¿€å¢ï¼Œæ•°æ®åº“å´©æºƒ</p>
<p>é—®é¢˜æ’æŸ¥ï¼š</p>
<ol>
<li>
<p>Redis ä¸­å¤§é¢ç§¯å‡ºç°æœªå‘½ä¸­</p>
</li>
<li>
<p>å‡ºç°éæ­£å¸¸ URL è®¿é—®</p>
</li>
</ol>
<p>é—®é¢˜åˆ†æï¼š</p>
<ul>
<li>è®¿é—®äº†ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè·³è¿‡äº† Redis ç¼“å­˜ï¼Œæ•°æ®åº“é¡µæŸ¥è¯¢ä¸åˆ°å¯¹åº”æ•°æ®</li>
<li>Redis è·å–åˆ° null æ•°æ®æœªè¿›è¡ŒæŒä¹…åŒ–ï¼Œç›´æ¥è¿”å›</li>
<li>å‡ºç°é»‘å®¢æ”»å‡»æœåŠ¡å™¨</li>
</ul>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ol>
<li>
<p>ç¼“å­˜ nullï¼šå¯¹æŸ¥è¯¢ç»“æœä¸º null çš„æ•°æ®è¿›è¡Œç¼“å­˜ï¼Œè®¾å®šçŸ­æ—¶é™ï¼Œä¾‹å¦‚ 30-60 ç§’ï¼Œæœ€é«˜ 5 åˆ†é’Ÿ</p>
</li>
<li>
<p>ç™½åå•ç­–ç•¥ï¼šæå‰é¢„çƒ­å„ç§åˆ†ç±»<strong>æ•°æ® id å¯¹åº”çš„ bitmaps</strong>ï¼Œid ä½œä¸º bitmaps çš„ offsetï¼Œç›¸å½“äºè®¾ç½®äº†æ•°æ®ç™½åå•ã€‚å½“åŠ è½½æ­£å¸¸æ•°æ®æ—¶æ”¾è¡Œï¼ŒåŠ è½½å¼‚å¸¸æ•°æ®æ—¶ç›´æ¥æ‹¦æˆªï¼ˆæ•ˆç‡åä½ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆæœ‰å…³å¸ƒéš†è¿‡æ»¤å™¨çš„å‘½ä¸­é—®é¢˜å¯¹å½“å‰çŠ¶å†µå¯ä»¥å¿½ç•¥ï¼‰</p>
</li>
<li>
<p>å®æ—¶ç›‘æ§ï¼šå®æ—¶ç›‘æ§ Redis å‘½ä¸­ç‡ï¼ˆä¸šåŠ¡æ­£å¸¸èŒƒå›´æ—¶ï¼Œé€šå¸¸ä¼šæœ‰ä¸€ä¸ªæ³¢åŠ¨å€¼ï¼‰ä¸ null æ•°æ®çš„å æ¯”</p>
<ul>
<li>éæ´»åŠ¨æ—¶æ®µæ³¢åŠ¨ï¼šé€šå¸¸æ£€æµ‹ 3-5 å€ï¼Œè¶…è¿‡ 5 å€çº³å…¥é‡ç‚¹æ’æŸ¥å¯¹è±¡</li>
<li>æ´»åŠ¨æ—¶æ®µæ³¢åŠ¨ï¼šé€šå¸¸æ£€æµ‹10-50 å€ï¼Œè¶…è¿‡ 50 å€çº³å…¥é‡ç‚¹æ’æŸ¥å¯¹è±¡</li>
</ul>
<p>æ ¹æ®å€æ•°ä¸åŒï¼Œå¯åŠ¨ä¸åŒçš„æ’æŸ¥æµç¨‹ã€‚ç„¶åä½¿ç”¨é»‘åå•è¿›è¡Œé˜²æ§</p>
</li>
<li>
<p>key åŠ å¯†ï¼šä¸´æ—¶å¯åŠ¨é˜²ç¾ä¸šåŠ¡ keyï¼Œå¯¹ key è¿›è¡Œä¸šåŠ¡å±‚ä¼ è¾“åŠ å¯†æœåŠ¡ï¼Œè®¾å®šæ ¡éªŒç¨‹åºï¼Œè¿‡æ¥çš„ key æ ¡éªŒï¼›ä¾‹å¦‚æ¯å¤©éšæœºåˆ†é… 60 ä¸ªåŠ å¯†ä¸²ï¼ŒæŒ‘é€‰ 2 åˆ° 3 ä¸ªï¼Œæ··æ·†åˆ°é¡µé¢æ•°æ® id ä¸­ï¼Œå‘ç°è®¿é—® key ä¸æ»¡è¶³è§„åˆ™ï¼Œé©³å›æ•°æ®è®¿é—®</p>
</li>
</ol>
<p>æ€»çš„æ¥è¯´ï¼šç¼“å­˜å‡»ç©¿æ˜¯æŒ‡è®¿é—®äº†ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè·³è¿‡äº†åˆæ³•æ•°æ®çš„ Redis æ•°æ®ç¼“å­˜é˜¶æ®µï¼Œ<strong>æ¯æ¬¡è®¿é—®æ•°æ®åº“</strong>ï¼Œå¯¼è‡´å¯¹æ•°æ®åº“æœåŠ¡å™¨é€ æˆå‹åŠ›ã€‚é€šå¸¸æ­¤ç±»æ•°æ®çš„å‡ºç°é‡æ˜¯ä¸€ä¸ªè¾ƒä½çš„å€¼ï¼Œå½“å‡ºç°æ­¤ç±»æƒ…å†µä»¥æ¯’æ”»æ¯’ï¼Œå¹¶åŠæ—¶æŠ¥è­¦ã€‚æ— è®ºæ˜¯é»‘åå•è¿˜æ˜¯ç™½åå•ï¼Œéƒ½æ˜¯å¯¹æ•´ä½“ç³»ç»Ÿçš„å‹åŠ›ï¼Œè­¦æŠ¥è§£é™¤åå°½å¿«ç§»é™¤</p>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV15y4y1r7X3">https://www.bilibili.com/video/BV15y4y1r7X3</a></p>
<hr>
<h3 id="Key-è®¾è®¡">Key è®¾è®¡</h3>
<p>å¤§ Keyï¼šé€šå¸¸ä»¥ Key çš„å¤§å°å’Œ Key ä¸­æˆå‘˜çš„æ•°é‡æ¥ç»¼åˆåˆ¤å®šï¼Œå¼•å‘çš„é—®é¢˜ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤çš„æ—¶é•¿å˜æ…¢</li>
<li>Redis å†…å­˜è¾¾åˆ° maxmemory å®šä¹‰çš„ä¸Šé™å¼•å‘æ“ä½œé˜»å¡æˆ–é‡è¦çš„ Key è¢«é€å‡ºï¼Œç”šè‡³å¼•å‘å†…å­˜æº¢å‡ºï¼ˆOOMï¼‰</li>
<li>é›†ç¾¤æ¶æ„ä¸‹ï¼ŒæŸä¸ªæ•°æ®åˆ†ç‰‡çš„å†…å­˜ä½¿ç”¨ç‡è¿œè¶…å…¶ä»–æ•°æ®åˆ†ç‰‡ï¼Œä½¿<strong>æ•°æ®åˆ†ç‰‡çš„å†…å­˜èµ„æºä¸å‡è¡¡</strong></li>
<li>å¯¹å¤§ Key æ‰§è¡Œè¯»è¯·æ±‚ï¼Œä¼šä½¿ Redis å®ä¾‹çš„å¸¦å®½ä½¿ç”¨ç‡è¢«å æ»¡ï¼Œå¯¼è‡´è‡ªèº«æœåŠ¡å˜æ…¢ï¼ŒåŒæ—¶æ˜“æ³¢åŠç›¸å…³çš„æœåŠ¡</li>
<li>å¯¹å¤§ Key æ‰§è¡Œåˆ é™¤æ“ä½œï¼Œä¼šé€ æˆä¸»åº“è¾ƒé•¿æ—¶é—´çš„é˜»å¡ï¼Œè¿›è€Œå¯èƒ½å¼•å‘åŒæ­¥ä¸­æ–­æˆ–ä¸»ä»åˆ‡æ¢</li>
</ul>
<p>çƒ­ Keyï¼šé€šå¸¸ä»¥å…¶æ¥æ”¶åˆ°çš„ Key è¢«è¯·æ±‚é¢‘ç‡æ¥åˆ¤å®šï¼Œå¼•å‘çš„é—®é¢˜ï¼š</p>
<ul>
<li>å ç”¨å¤§é‡çš„ CPU èµ„æºï¼Œå½±å“å…¶ä»–è¯·æ±‚å¹¶å¯¼è‡´æ•´ä½“æ€§èƒ½é™ä½</li>
<li>åˆ†å¸ƒå¼é›†ç¾¤æ¶æ„ä¸‹ï¼Œäº§ç”Ÿ<strong>è®¿é—®å€¾æ–œ</strong>ï¼Œå³æŸä¸ªæ•°æ®åˆ†ç‰‡è¢«å¤§é‡è®¿é—®ï¼Œè€Œå…¶ä»–æ•°æ®åˆ†ç‰‡å¤„äºç©ºé—²çŠ¶æ€ï¼Œå¯èƒ½å¼•èµ·è¯¥æ•°æ®åˆ†ç‰‡çš„è¿æ¥æ•°è¢«è€—å°½ï¼Œæ–°çš„è¿æ¥å»ºç«‹è¯·æ±‚è¢«æ‹’ç»ç­‰é—®é¢˜</li>
<li>åœ¨æŠ¢è´­æˆ–ç§’æ€åœºæ™¯ä¸‹ï¼Œå¯èƒ½å› å•†å“å¯¹åº”åº“å­˜ Key çš„è¯·æ±‚é‡è¿‡å¤§ï¼Œè¶…å‡º Redis å¤„ç†èƒ½åŠ›é€ æˆè¶…å–</li>
<li>çƒ­ Key çš„è¯·æ±‚å‹åŠ›æ•°é‡è¶…å‡º Redis çš„æ‰¿å—èƒ½åŠ›æ˜“é€ æˆç¼“å­˜å‡»ç©¿ï¼Œå³å¤§é‡è¯·æ±‚å°†è¢«ç›´æ¥æŒ‡å‘åç«¯çš„å­˜å‚¨å±‚ï¼Œå¯¼è‡´å­˜å‚¨è®¿é—®é‡æ¿€å¢ç”šè‡³å®•æœºï¼Œä»è€Œå½±å“å…¶ä»–ä¸šåŠ¡</li>
</ul>
<p>çƒ­ Key åˆ†ç±»ä¸¤ç§ï¼Œæ²»ç†æ–¹å¼å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¸€ç§æ˜¯å•ä¸€æ•°æ®ï¼Œæ¯”å¦‚ç§’æ€åœºæ™¯ï¼Œå‡è®¾æ€»é‡ 10000 å¯ä»¥æ‹†ä¸ºå¤šä¸ª Key è¿›è¡Œè®¿é—®ï¼Œæ¯æ¬¡å¯¹è¯·æ±‚è¿›è¡Œè·¯ç”±åˆ°ä¸åŒçš„ Key è®¿é—®ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œä½†æ˜¯ä¼šå‡ºç°è®¿é—®ä¸åŒ Key äº§ç”Ÿçš„å‰©ä½™é‡æ˜¯ä¸åŒçš„ï¼Œè¿™æ—¶å¯ä»¥é€šè¿‡å‰ç«¯è¿›è¡Œ Mock å‡æ•°æ®</li>
<li>ä¸€ç§æ˜¯å¤šæ•°æ®é›†åˆï¼Œæ¯”å¦‚è¿›è¡Œ ID è¿‡æ»¤ï¼Œè¿™æ—¶å¯ä»¥æ·»åŠ æœ¬åœ° LRU ç¼“å­˜ï¼Œå‡å°‘å¯¹çƒ­ Key çš„è®¿é—®</li>
</ul>
<p>å‚è€ƒæ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/353223.html">https://help.aliyun.com/document_detail/353223.html</a></p>
<hr>
<h3 id="æ…¢æŸ¥è¯¢">æ…¢æŸ¥è¯¢</h3>
<p>ç¡®è®¤æœåŠ¡å’Œ Redis ä¹‹é—´çš„é“¾è·¯æ˜¯å¦æ­£å¸¸ï¼Œæ’é™¤ç½‘ç»œåŸå› åè¿›è¡Œ Redis çš„æ’æŸ¥ï¼š</p>
<ul>
<li>ä½¿ç”¨å¤æ‚åº¦è¿‡é«˜çš„å‘½ä»¤</li>
<li>æ“ä½œå¤§ keyï¼Œåˆ†é…å†…å­˜å’Œé‡Šæ”¾å†…å­˜ä¼šæ¯”è¾ƒè€—æ—¶</li>
<li>key é›†ä¸­è¿‡æœŸï¼Œå¯¼è‡´å®šæ—¶ä»»åŠ¡éœ€è¦æ›´é•¿çš„æ—¶é—´å»æ¸…ç†</li>
<li>å®ä¾‹å†…å­˜è¾¾åˆ°ä¸Šé™ï¼Œæ¯æ¬¡å†™å…¥æ–°çš„æ•°æ®ä¹‹å‰ï¼ŒRedis å¿…é¡»å…ˆä»å®ä¾‹ä¸­è¸¢å‡ºä¸€éƒ¨åˆ†æ•°æ®</li>
</ul>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/traditional/p/15633919.html%EF%BC%88%E9%9D%9E%E5%B8%B8%E5%A5%BD%EF%BC%89">https://www.cnblogs.com/traditional/p/15633919.htmlï¼ˆéå¸¸å¥½ï¼‰</a></p>
<hr>
<h1>Java</h1>
<h2 id="JDBC">JDBC</h2>
<h3 id="æ¦‚è¿°-3">æ¦‚è¿°</h3>
<p>JDBCï¼ˆJava DataBase Connectivityï¼ŒJava æ•°æ®åº“è¿æ¥ï¼‰æ˜¯ä¸€ç§ç”¨äºæ‰§è¡Œ SQL è¯­å¥çš„ Java APIï¼Œå¯ä»¥ä¸ºå¤šç§å…³ç³»å‹æ•°æ®åº“æä¾›ç»Ÿä¸€è®¿é—®ï¼Œæ˜¯ç”±ä¸€ç»„ç”¨ Java è¯­è¨€ç¼–å†™çš„ç±»å’Œæ¥å£ç»„æˆçš„ã€‚</p>
<p>JDBC æ˜¯ Java å®˜æ–¹æä¾›çš„ä¸€å¥—è§„èŒƒï¼ˆæ¥å£ï¼‰ï¼Œç”¨äºå¸®åŠ©å¼€å‘äººå‘˜å¿«é€Ÿå®ç°ä¸åŒå…³ç³»å‹æ•°æ®åº“çš„è¿æ¥</p>
<hr>
<h3 id="åŠŸèƒ½ç±»">åŠŸèƒ½ç±»</h3>
<h4 id="DriverManager">DriverManager</h4>
<p>DriverManagerï¼šé©±åŠ¨ç®¡ç†å¯¹è±¡</p>
<ul>
<li>
<p>æ³¨å†Œé©±åŠ¨ï¼š</p>
<ul>
<li>
<p>æ³¨å†Œç»™å®šçš„é©±åŠ¨ï¼š<code>public static void registerDriver(Driver driver)</code></p>
</li>
<li>
<p>ä»£ç å®ç°è¯­æ³•ï¼š<code>Class.forName(&quot;com.mysql.jdbc.Driver)</code></p>
</li>
<li>
<p>com.mysql.jdbc.Driver ä¸­å­˜åœ¨é™æ€ä»£ç å—</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        DriverManager.registerDriver(<span class="keyword">new</span> <span class="title class_">Driver</span>());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException var1) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Can&#x27;t register driver!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¸éœ€è¦é€šè¿‡ DriverManager è°ƒç”¨é™æ€æ–¹æ³• registerDriverï¼Œå› ä¸º Driver ç±»è¢«ä½¿ç”¨ï¼Œåˆ™è‡ªåŠ¨æ‰§è¡Œé™æ€ä»£ç å—å®Œæˆæ³¨å†Œé©±åŠ¨</p>
</li>
<li>
<p>jar åŒ…ä¸­ META-INF ç›®å½•ä¸‹å­˜åœ¨ä¸€ä¸ª java.sql.Driver é…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­æŒ‡å®šäº† com.mysql.jdbc.Driver</p>
</li>
</ul>
</li>
<li>
<p>è·å–æ•°æ®åº“è¿æ¥å¹¶è¿”å›è¿æ¥å¯¹è±¡ï¼š</p>
<p>æ–¹æ³•ï¼š<code>public static Connection getConnection(String url, String user, String password)</code></p>
<ul>
<li>urlï¼šæŒ‡å®šè¿æ¥çš„è·¯å¾„ï¼Œè¯­æ³•ä¸º <code>jdbc:mysql://ipåœ°å€(åŸŸå):ç«¯å£å·/æ•°æ®åº“åç§°</code></li>
<li>userï¼šç”¨æˆ·å</li>
<li>passwordï¼šå¯†ç </li>
</ul>
</li>
</ul>
<hr>
<h4 id="Connection">Connection</h4>
<p>Connectionï¼šæ•°æ®åº“è¿æ¥å¯¹è±¡</p>
<ul>
<li>è·å–æ‰§è¡Œè€…å¯¹è±¡
<ul>
<li>è·å–æ™®é€šæ‰§è¡Œè€…å¯¹è±¡ï¼š<code>Statement createStatement()</code></li>
<li>è·å–é¢„ç¼–è¯‘æ‰§è¡Œè€…å¯¹è±¡ï¼š<code>PreparedStatement prepareStatement(String sql)</code></li>
</ul>
</li>
<li>ç®¡ç†äº‹åŠ¡
<ul>
<li>å¼€å¯äº‹åŠ¡ï¼š<code>setAutoCommit(boolean autoCommit)</code>ï¼Œfalse å¼€å¯äº‹åŠ¡ï¼Œtrue è‡ªåŠ¨æäº¤æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰</li>
<li>æäº¤äº‹åŠ¡ï¼š<code>void commit()</code></li>
<li>å›æ»šäº‹åŠ¡ï¼š<code>void rollback()</code></li>
</ul>
</li>
<li>é‡Šæ”¾èµ„æº
<ul>
<li>é‡Šæ”¾æ­¤ Connection å¯¹è±¡çš„æ•°æ®åº“å’Œ JDBC èµ„æºï¼š<code>void close()</code></li>
</ul>
</li>
</ul>
<hr>
<h4 id="Statement">Statement</h4>
<p>Statementï¼šæ‰§è¡Œ sql è¯­å¥çš„å¯¹è±¡</p>
<ul>
<li>æ‰§è¡Œ DML è¯­å¥ï¼š<code>int executeUpdate(String sql)</code>
<ul>
<li>è¿”å›å€¼ intï¼šè¿”å›å½±å“çš„è¡Œæ•°</li>
<li>å‚æ•° sqlï¼šå¯ä»¥æ‰§è¡Œ insertã€updateã€delete è¯­å¥</li>
</ul>
</li>
<li>æ‰§è¡Œ DQL è¯­å¥ï¼š<code>ResultSet executeQuery(String sql)</code>
<ul>
<li>è¿”å›å€¼ ResultSetï¼šå°è£…æŸ¥è¯¢çš„ç»“æœ</li>
<li>å‚æ•° sqlï¼šå¯ä»¥æ‰§è¡Œ select è¯­å¥</li>
</ul>
</li>
<li>é‡Šæ”¾èµ„æº
<ul>
<li>é‡Šæ”¾æ­¤ Statement å¯¹è±¡çš„æ•°æ®åº“å’Œ JDBC èµ„æºï¼š<code>void close()</code></li>
</ul>
</li>
</ul>
<hr>
<h4 id="ResultSet">ResultSet</h4>
<p>ResultSetï¼šç»“æœé›†å¯¹è±¡ï¼ŒResultSet å¯¹è±¡ç»´æŠ¤äº†ä¸€ä¸ªæ¸¸æ ‡ï¼ŒæŒ‡å‘å½“å‰çš„æ•°æ®è¡Œï¼Œåˆå§‹åœ¨ç¬¬ä¸€è¡Œ</p>
<ul>
<li>åˆ¤æ–­ç»“æœé›†ä¸­æ˜¯å¦æœ‰æ•°æ®ï¼š<code>boolean next()</code>
<ul>
<li>æœ‰æ•°æ®è¿”å› trueï¼Œå¹¶å°†ç´¢å¼•<strong>å‘ä¸‹ç§»åŠ¨ä¸€è¡Œ</strong></li>
<li>æ²¡æœ‰æ•°æ®è¿”å› false</li>
</ul>
</li>
<li>è·å–ç»“æœé›†ä¸­<strong>å½“å‰è¡Œ</strong>çš„æ•°æ®ï¼š<code>XXX getXxx(&quot;åˆ—å&quot;)</code>
<ul>
<li>XXX ä»£è¡¨æ•°æ®ç±»å‹ï¼ˆè¦è·å–æŸåˆ—æ•°æ®ï¼Œè¿™ä¸€åˆ—çš„æ•°æ®ç±»å‹ï¼‰</li>
<li>ä¾‹å¦‚ï¼šString getString(â€œnameâ€);   int getInt(â€œageâ€);</li>
</ul>
</li>
<li>é‡Šæ”¾èµ„æº
<ul>
<li>é‡Šæ”¾ ResultSet å¯¹è±¡çš„æ•°æ®åº“å’Œ JDBC èµ„æºï¼š<code>void close()</code></li>
</ul>
</li>
</ul>
<hr>
<h4 id="ä»£ç å®ç°">ä»£ç å®ç°</h4>
<p>æ•°æ®å‡†å¤‡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">-- åˆ›å»ºdb14æ•°æ®åº“</span><br><span class="line">CREATE DATABASE db14;</span><br><span class="line"></span><br><span class="line">-- ä½¿ç”¨db14æ•°æ®åº“</span><br><span class="line">USE db14;</span><br><span class="line"></span><br><span class="line">-- åˆ›å»ºstudentè¡¨</span><br><span class="line">CREATE TABLE student(</span><br><span class="line">	sid INT PRIMARY KEY AUTO_INCREMENT,	-- å­¦ç”Ÿid</span><br><span class="line">	NAME VARCHAR(20),					-- å­¦ç”Ÿå§“å</span><br><span class="line">	age INT,							-- å­¦ç”Ÿå¹´é¾„</span><br><span class="line">	birthday DATE,						-- å­¦ç”Ÿç”Ÿæ—¥</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">-- æ·»åŠ æ•°æ®</span><br><span class="line">INSERT INTO student VALUES (NULL,&#x27;å¼ ä¸‰&#x27;,23,&#x27;1999-09-23&#x27;),(NULL,&#x27;æå››&#x27;,24,&#x27;1998-08-10&#x27;),</span><br><span class="line">(NULL,&#x27;ç‹äº”&#x27;,25,&#x27;1996-06-06&#x27;),(NULL,&#x27;èµµå…­&#x27;,26,&#x27;1994-10-20&#x27;);</span><br></pre></td></tr></table></figure>
<p>JDBC è¿æ¥ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDBCDemo01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//1.å¯¼å…¥jaråŒ…</span></span><br><span class="line">        <span class="comment">//2.æ³¨å†Œé©±åŠ¨</span></span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.è·å–è¿æ¥</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> DriverManager.getConnection(<span class="string">&quot;jdbc:mysql://192.168.2.184:3306/db2&quot;</span>,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;123456&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.è·å–æ‰§è¡Œè€…å¯¹è±¡</span></span><br><span class="line">        <span class="type">Statement</span> <span class="variable">stat</span> <span class="operator">=</span> con.createStatement();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5.æ‰§è¡Œsqlè¯­å¥ï¼Œå¹¶ä¸”æ¥æ”¶ç»“æœ</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM user&quot;</span>;</span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stat.executeQuery(sql);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6.å¤„ç†ç»“æœ</span></span><br><span class="line">        <span class="keyword">while</span>(rs.next()) &#123;</span><br><span class="line">            System.out.println(rs.getInt(<span class="string">&quot;id&quot;</span>) + <span class="string">&quot;\t&quot;</span> + rs.getString(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//7.é‡Šæ”¾èµ„æº</span></span><br><span class="line">        con.close();</span><br><span class="line">        stat.close();</span><br><span class="line">        con.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="æ³¨å…¥æ”»å‡»">æ³¨å…¥æ”»å‡»</h3>
<h4 id="æ”»å‡»æ¼”ç¤º">æ”»å‡»æ¼”ç¤º</h4>
<p>SQL æ³¨å…¥æ”»å‡»æ¼”ç¤º</p>
<ul>
<li>
<p>åœ¨ç™»å½•ç•Œé¢ï¼Œè¾“å…¥ä¸€ä¸ªé”™è¯¯çš„ç”¨æˆ·åæˆ–å¯†ç ï¼Œä¹Ÿå¯ä»¥ç™»å½•æˆåŠŸ</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/SQL%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB%E6%BC%94%E7%A4%BA.png" alt=""></p>
</li>
<li>
<p>åŸç†ï¼šæˆ‘ä»¬åœ¨å¯†ç å¤„è¾“å…¥çš„æ‰€æœ‰å†…å®¹ï¼Œéƒ½åº”è¯¥è®¤ä¸ºæ˜¯å¯†ç çš„ç»„æˆï¼Œä½†æ˜¯ Statement å¯¹è±¡åœ¨æ‰§è¡Œ SQL è¯­å¥æ—¶ï¼Œå°†ä¸€éƒ¨åˆ†å†…å®¹å½“åšæŸ¥è¯¢æ¡ä»¶æ¥æ‰§è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM user WHERE loginname=&#x27;aaa&#x27; AND password=&#x27;aaa&#x27; OR &#x27;1&#x27;=&#x27;1&#x27;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="æ”»å‡»è§£å†³">æ”»å‡»è§£å†³</h4>
<p>PreparedStatementï¼šé¢„ç¼–è¯‘ sql è¯­å¥çš„æ‰§è¡Œè€…å¯¹è±¡ï¼Œç»§æ‰¿ <code>PreparedStatement extends Statement</code></p>
<ul>
<li>åœ¨æ‰§è¡Œ sql è¯­å¥ä¹‹å‰ï¼Œå°† sql è¯­å¥è¿›è¡Œæå‰ç¼–è¯‘ï¼Œ<strong>æ˜ç¡® sql è¯­å¥çš„æ ¼å¼</strong>ï¼Œå‰©ä½™çš„å†…å®¹éƒ½ä¼šè®¤ä¸ºæ˜¯å‚æ•°</li>
<li>sql è¯­å¥ä¸­çš„å‚æ•°ä½¿ç”¨ ? ä½œä¸º<strong>å ä½ç¬¦</strong></li>
</ul>
<p>ä¸º ? å ä½ç¬¦èµ‹å€¼çš„æ–¹æ³•ï¼š<code>setXxx(int parameterIndex, xxx data)</code></p>
<ul>
<li>
<p>å‚æ•°1ï¼š? çš„ä½ç½®ç¼–å·ï¼ˆç¼–å·ä» 1 å¼€å§‹ï¼‰</p>
</li>
<li>
<p>å‚æ•°2ï¼š? çš„å®é™…å‚æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM user WHERE loginname=? AND password=?&quot;</span>;</span><br><span class="line">pst = con.prepareStatement(sql);</span><br><span class="line">pst.setString(<span class="number">1</span>,loginName);</span><br><span class="line">pst.setString(<span class="number">2</span>,password);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ‰§è¡Œ sql è¯­å¥çš„æ–¹æ³•</p>
<ul>
<li>æ‰§è¡Œ insertã€updateã€delete è¯­å¥ï¼š<code>int executeUpdate()</code></li>
<li>æ‰§è¡Œ select è¯­å¥ï¼š<code>ResultSet executeQuery()</code></li>
</ul>
<hr>
<h3 id="è¿æ¥æ± ">è¿æ¥æ± </h3>
<h4 id="æ¦‚å¿µ">æ¦‚å¿µ</h4>
<p>æ•°æ®åº“è¿æ¥èƒŒæ™¯ï¼šæ•°æ®åº“è¿æ¥æ˜¯ä¸€ç§å…³é”®çš„ã€æœ‰é™çš„ã€æ˜‚è´µçš„èµ„æºï¼Œè¿™ä¸€ç‚¹åœ¨å¤šç”¨æˆ·çš„ç½‘é¡µåº”ç”¨ç¨‹åºä¸­ä½“ç°å¾—å°¤ä¸ºçªå‡ºã€‚å¯¹æ•°æ®åº“è¿æ¥çš„ç®¡ç†èƒ½æ˜¾è‘—å½±å“åˆ°æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ä¼¸ç¼©æ€§å’Œå¥å£®æ€§ï¼Œå½±å“åˆ°ç¨‹åºçš„æ€§èƒ½æŒ‡æ ‡ã€‚</p>
<p>æ•°æ®åº“è¿æ¥æ± ï¼š<strong>æ•°æ®åº“è¿æ¥æ± è´Ÿè´£åˆ†é…ã€ç®¡ç†å’Œé‡Šæ”¾æ•°æ®åº“è¿æ¥</strong>ï¼Œå®ƒå…è®¸åº”ç”¨ç¨‹åº<strong>é‡å¤ä½¿ç”¨</strong>ä¸€ä¸ªç°æœ‰çš„æ•°æ®åº“è¿æ¥ï¼Œè€Œä¸æ˜¯å†é‡æ–°å»ºç«‹ä¸€ä¸ªï¼Œè¿™é¡¹æŠ€æœ¯èƒ½æ˜æ˜¾æé«˜å¯¹æ•°æ®åº“æ“ä½œçš„æ€§èƒ½ã€‚</p>
<p>æ•°æ®åº“è¿æ¥æ± åŸç†</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0%E5%8E%9F%E7%90%86%E5%9B%BE%E8%A7%A3.png" alt=""></p>
<hr>
<h4 id="å½’è¿˜è¿æ¥">å½’è¿˜è¿æ¥</h4>
<p>ä½¿ç”¨åŠ¨æ€ä»£ç†çš„æ–¹å¼æ¥æ”¹è¿›</p>
<p>è‡ªå®šä¹‰æ•°æ®åº“è¿æ¥æ± ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDataSource</span> <span class="keyword">implements</span> <span class="title class_">DataSource</span> &#123;</span><br><span class="line">    <span class="comment">//1.å‡†å¤‡ä¸€ä¸ªå®¹å™¨ã€‚ç”¨äºä¿å­˜å¤šä¸ªæ•°æ®åº“è¿æ¥å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Connection&gt; pool = Collections.synchronizedList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.å®šä¹‰é™æ€ä»£ç å—,è·å–å¤šä¸ªè¿æ¥å¯¹è±¡ä¿å­˜åˆ°å®¹å™¨ä¸­</span></span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> JDBCUtils.getConnection();</span><br><span class="line">            pool.add(con);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.æä¾›ä¸€ä¸ªè·å–è¿æ¥æ± å¤§å°çš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pool.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   	<span class="comment">//åŠ¨æ€ä»£ç†æ–¹å¼</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">if</span>(pool.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> pool.remove(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">Connection</span> <span class="variable">proxyCon</span> <span class="operator">=</span> (Connection) Proxy.newProxyInstance(</span><br><span class="line">                con.getClass().getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Connection.class&#125;, </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvocationHandler</span>() &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    æ‰§è¡ŒConnectionå®ç°ç±»è¿æ¥å¯¹è±¡æ‰€æœ‰çš„æ–¹æ³•éƒ½ä¼šç»è¿‡invoke</span></span><br><span class="line"><span class="comment">                    å¦‚æœæ˜¯closeæ–¹æ³•ï¼Œå½’è¿˜è¿æ¥</span></span><br><span class="line"><span class="comment">                    å¦‚æœä¸æ˜¯ï¼Œç›´æ¥æ‰§è¡Œè¿æ¥å¯¹è±¡åŸæœ‰çš„åŠŸèƒ½å³å¯</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                    <span class="keyword">if</span>(method.getName().equals(<span class="string">&quot;close&quot;</span>)) &#123;</span><br><span class="line">                        <span class="comment">//å½’è¿˜è¿æ¥</span></span><br><span class="line">                        pool.add(con);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> method.invoke(con,args);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> proxyCon;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;è¿æ¥æ•°é‡å·²ç”¨å°½&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="å¼€æºé¡¹ç›®">å¼€æºé¡¹ç›®</h4>
<h5 id="C3P0">C3P0</h5>
<p>ä½¿ç”¨ C3P0 è¿æ¥æ± ï¼š</p>
<ul>
<li>
<p>é…ç½®æ–‡ä»¶åç§°ï¼šc3p0-config.xmlï¼Œå¿…é¡»æ”¾åœ¨ src ç›®å½•ä¸‹</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c3p0-config</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- ä½¿ç”¨é»˜è®¤çš„é…ç½®è¯»å–è¿æ¥æ± å¯¹è±¡ --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">default-config</span>&gt;</span></span><br><span class="line">  	<span class="comment">&lt;!--  è¿æ¥å‚æ•° --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClass&quot;</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcUrl&quot;</span>&gt;</span>jdbc:mysql://192.168.2.184:3306/db14<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span>root<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- è¿æ¥æ± å‚æ•° --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--åˆå§‹åŒ–æ•°é‡--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;initialPoolSize&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--æœ€å¤§è¿æ¥æ•°é‡--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxPoolSize&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--è¶…æ—¶æ—¶é—´ 3000ms--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;checkoutTimeout&quot;</span>&gt;</span>3000<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">default-config</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">named-config</span> <span class="attr">name</span>=<span class="string">&quot;otherc3p0&quot;</span>&gt;</span> </span><br><span class="line">    <span class="comment">&lt;!--  è¿æ¥å‚æ•° --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- è¿æ¥æ± å‚æ•° --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">named-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">c3p0-config</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä»£ç æ¼”ç¤º</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P0Test1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//1.åˆ›å»ºc3p0çš„æ•°æ®åº“è¿æ¥æ± å¯¹è±¡</span></span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComboPooledDataSource</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.é€šè¿‡è¿æ¥æ± å¯¹è±¡è·å–æ•°æ®åº“è¿æ¥</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.æ‰§è¡Œæ“ä½œ</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM student&quot;</span>;</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">pst</span> <span class="operator">=</span> con.prepareStatement(sql);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.æ‰§è¡Œsqlè¯­å¥ï¼Œæ¥æ”¶ç»“æœé›†</span></span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> pst.executeQuery();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5.å¤„ç†ç»“æœé›†</span></span><br><span class="line">        <span class="keyword">while</span>(rs.next()) &#123;</span><br><span class="line">            System.out.println(rs.getInt(<span class="string">&quot;sid&quot;</span>) + <span class="string">&quot;\t&quot;</span> + rs.getString(<span class="string">&quot;name&quot;</span>) + <span class="string">&quot;\t&quot;</span> + rs.getInt(<span class="string">&quot;age&quot;</span>) + <span class="string">&quot;\t&quot;</span> + rs.getDate(<span class="string">&quot;birthday&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6.é‡Šæ”¾èµ„æº</span></span><br><span class="line">        rs.close();   pst.close();   con.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="Druid">Druid</h5>
<p>Druid è¿æ¥æ± ï¼š</p>
<ul>
<li>
<p>é…ç½®æ–‡ä»¶ï¼šdruid.propertiesï¼Œå¿…é¡»æ”¾åœ¨ src ç›®å½•ä¸‹</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">driverClassName</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">url</span>=<span class="string">jdbc:mysql://192.168.2.184:3306/db14</span></span><br><span class="line"><span class="attr">username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">password</span>=<span class="string">123456</span></span><br><span class="line"><span class="attr">initialSize</span>=<span class="string">5</span></span><br><span class="line"><span class="attr">maxActive</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">maxWait</span>=<span class="string">3000</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä»£ç æ¼”ç¤º</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DruidTest1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//è·å–é…ç½®æ–‡ä»¶çš„æµå¯¹è±¡</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> DruidTest1.class.getClassLoader().getResourceAsStream(<span class="string">&quot;druid.properties&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.é€šè¿‡Propertiesé›†åˆï¼ŒåŠ è½½é…ç½®æ–‡ä»¶</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">prop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        prop.load(is);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.é€šè¿‡Druidè¿æ¥æ± å·¥å‚ç±»è·å–æ•°æ®åº“è¿æ¥æ± å¯¹è±¡</span></span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> DruidDataSourceFactory.createDataSource(prop);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.é€šè¿‡è¿æ¥æ± å¯¹è±¡è·å–æ•°æ®åº“è¿æ¥è¿›è¡Œä½¿ç”¨</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">        </span><br><span class="line">		<span class="comment">//4.æ‰§è¡Œsqlè¯­å¥ï¼Œæ¥æ”¶ç»“æœé›†</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM student&quot;</span>;</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">pst</span> <span class="operator">=</span> con.prepareStatement(sql);</span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> pst.executeQuery();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5.å¤„ç†ç»“æœé›†</span></span><br><span class="line">        <span class="keyword">while</span>(rs.next()) &#123;</span><br><span class="line">            System.out.println(rs.getInt(<span class="string">&quot;sid&quot;</span>) + <span class="string">&quot;\t&quot;</span> + rs.getString(<span class="string">&quot;name&quot;</span>) + <span class="string">&quot;\t&quot;</span> + rs.getInt(<span class="string">&quot;age&quot;</span>) + <span class="string">&quot;\t&quot;</span> + rs.getDate(<span class="string">&quot;birthday&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6.é‡Šæ”¾èµ„æº</span></span><br><span class="line">        rs.close();   pst.close();   con.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="Jedis">Jedis</h2>
<h3 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h3>
<p>Jedis ç”¨äº Java è¯­è¨€è¿æ¥ Redis æœåŠ¡ï¼Œå¹¶æä¾›å¯¹åº”çš„æ“ä½œ API</p>
<ul>
<li>
<p>jar åŒ…å¯¼å…¥</p>
<p>ä¸‹è½½åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/redis.clients/jedis">https://mvnrepository.com/artifact/redis.clients/jedis</a></p>
<p>åŸºäº mavenï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å®¢æˆ·ç«¯è¿æ¥ Redisï¼šAPI æ–‡æ¡£ <a target="_blank" rel="noopener" href="http://xetorthio.github.io/jedis/">http://xetorthio.github.io/jedis/</a></p>
<p>è¿æ¥ redisï¼š<code>Jedis jedis = new Jedis(&quot;192.168.0.185&quot;, 6379)</code></p>
<p>æ“ä½œ redisï¼š<code>jedis.set(&quot;name&quot;, &quot;seazean&quot;);  jedis.get(&quot;name&quot;)</code></p>
<p>å…³é—­ redisï¼š<code>jedis.close()</code></p>
</li>
</ul>
<p>ä»£ç å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//1.è·å–è¿æ¥å¯¹è±¡</span></span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.2.185&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">        <span class="comment">//2.æ‰§è¡Œæ“ä½œ</span></span><br><span class="line">        jedis.set(<span class="string">&quot;age&quot;</span>,<span class="string">&quot;39&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">hello</span> <span class="operator">=</span> jedis.get(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        System.out.println(hello);</span><br><span class="line">        jedis.lpush(<span class="string">&quot;list1&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;d&quot;</span>);</span><br><span class="line">        List&lt;String&gt; list1 = jedis.lrange(<span class="string">&quot;list1&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (String s:list1 ) &#123;</span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;</span><br><span class="line">        jedis.sadd(<span class="string">&quot;set1&quot;</span>,<span class="string">&quot;abc&quot;</span>,<span class="string">&quot;abc&quot;</span>,<span class="string">&quot;def&quot;</span>,<span class="string">&quot;poi&quot;</span>,<span class="string">&quot;cba&quot;</span>);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">len</span> <span class="operator">=</span> jedis.scard(<span class="string">&quot;set1&quot;</span>);</span><br><span class="line">        System.out.println(len);</span><br><span class="line">        <span class="comment">//3.å…³é—­è¿æ¥</span></span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="å·¥å…·ç±»">å·¥å…·ç±»</h3>
<p>è¿æ¥æ± å¯¹è±¡ï¼š</p>
<ul>
<li>JedisPoolï¼šJedis æä¾›çš„è¿æ¥æ± æŠ€æœ¯</li>
<li>poolConfigï¼šè¿æ¥æ± é…ç½®å¯¹è±¡</li>
<li>hostï¼šRedis æœåŠ¡åœ°å€</li>
<li>portï¼šRedis æœåŠ¡ç«¯å£å·</li>
</ul>
<p>JedisPool çš„æ„é€ å™¨å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">JedisPool</span><span class="params">(GenericObjectPoolConfig poolConfig, String host, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">	<span class="built_in">this</span>(poolConfig, host, port, <span class="number">2000</span>, (String)<span class="literal">null</span>, <span class="number">0</span>, (String)<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>åˆ›å»ºé…ç½®æ–‡ä»¶ redis.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">redis.maxTotal</span>=<span class="string">50</span></span><br><span class="line"><span class="attr">redis.maxIdel</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">redis.host</span>=<span class="string">192.168.2.185</span></span><br><span class="line"><span class="attr">redis.port</span>=<span class="string">6379</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å·¥å…·ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisUtils</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> maxTotal;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> maxIdel;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JedisPoolConfig jpc;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JedisPool jp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="type">ResourceBundle</span> <span class="variable">bundle</span> <span class="operator">=</span> ResourceBundle.getBundle(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">        <span class="comment">//æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">        maxTotal = Integer.parseInt(bundle.getString(<span class="string">&quot;redis.maxTotal&quot;</span>));</span><br><span class="line">        <span class="comment">//æ´»åŠ¨è¿æ¥æ•°</span></span><br><span class="line">        maxIdel = Integer.parseInt(bundle.getString(<span class="string">&quot;redis.maxIdel&quot;</span>));</span><br><span class="line">        host = bundle.getString(<span class="string">&quot;redis.host&quot;</span>);</span><br><span class="line">        port = Integer.parseInt(bundle.getString(<span class="string">&quot;redis.port&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Jedisè¿æ¥é…ç½®</span></span><br><span class="line">        jpc = <span class="keyword">new</span> <span class="title class_">JedisPoolConfig</span>();</span><br><span class="line">        jpc.setMaxTotal(maxTotal);</span><br><span class="line">        jpc.setMaxIdle(maxIdel);</span><br><span class="line">        <span class="comment">//è¿æ¥æ± å¯¹è±¡</span></span><br><span class="line">        jp = <span class="keyword">new</span> <span class="title class_">JedisPool</span>(jpc, host, port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯¹å¤–è®¿é—®æ¥å£ï¼Œæä¾›jedisè¿æ¥å¯¹è±¡ï¼Œè¿æ¥ä»è¿æ¥æ± è·å–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Jedis <span class="title function_">getJedis</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> jp.getResource();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>redisæ•°æ®åº“</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://www.json25.cn/posts/2636df6a.html">https://www.json25.cn/posts/2636df6a.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>jsonğŸ¥</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2022-03-16</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2023-03-17</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>æ•°æ®åº“</a><a class="post-meta__tags" href="/tags/redis/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>redis</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">æŠ•å–‚ä½œè€…</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn-eys.pages.dev/img/donate.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/donate.webp" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="https://cdn-eys.pages.dev/img/zfb.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/zfb.webp" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/10c11d66.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm13.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">javaå¸¸ç”¨å·¥å…·</div></div></a></div><div class="next-post pull-right"><a href="/posts/827432d7.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm18.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">javaseåŸºç¡€çŸ¥è¯†</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/13fb5dc7.html" title="mysqlæ•°æ®åº“ç¬”è®°"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm20.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-03-16</div><div class="title">mysqlæ•°æ®åº“ç¬”è®°</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NoSQL"><span class="toc-text">NoSQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">æ¦‚è¿°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis"><span class="toc-text">Redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%90%AF%E5%8A%A8"><span class="toc-text">å®‰è£…å¯åŠ¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="toc-text">åŸºæœ¬é…ç½®</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95"><span class="toc-text">ç³»ç»Ÿç›®å½•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">æœåŠ¡å™¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">å®¢æˆ·ç«¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE"><span class="toc-text">æ—¥å¿—é…ç½®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%8C%87%E4%BB%A4"><span class="toc-text">åŸºæœ¬æŒ‡ä»¤</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">æ•°æ®åº“</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8-2"><span class="toc-text">æœåŠ¡å™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%AE%E7%A9%BA%E9%97%B4"><span class="toc-text">é”®ç©ºé—´</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#key-space"><span class="toc-text">key space</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E6%8C%87%E4%BB%A4"><span class="toc-text">è¯»å†™æŒ‡ä»¤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%B6%E6%95%88%E8%AE%BE%E7%BD%AE"><span class="toc-text">æ—¶æ•ˆè®¾ç½®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%B6%E6%95%88%E7%8A%B6%E6%80%81"><span class="toc-text">æ—¶æ•ˆçŠ¶æ€</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%9C%9F%E5%88%A0%E9%99%A4"><span class="toc-text">è¿‡æœŸåˆ é™¤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%AD%96%E7%95%A5"><span class="toc-text">åˆ é™¤ç­–ç•¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%88%A0%E9%99%A4"><span class="toc-text">å®šæ—¶åˆ é™¤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%83%B0%E6%80%A7%E5%88%A0%E9%99%A4"><span class="toc-text">æƒ°æ€§åˆ é™¤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E6%9C%9F%E5%88%A0%E9%99%A4"><span class="toc-text">å®šæœŸåˆ é™¤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%B7%98%E6%B1%B0"><span class="toc-text">æ•°æ®æ·˜æ±°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%90%E5%87%BA%E7%AE%97%E6%B3%95"><span class="toc-text">é€å‡ºç®—æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E9%85%8D%E7%BD%AE"><span class="toc-text">ç­–ç•¥é…ç½®</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F%E6%9C%BA%E5%88%B6"><span class="toc-text">æ’åºæœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SORT"><span class="toc-text">SORT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BY"><span class="toc-text">BY</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LIMIT"><span class="toc-text">LIMIT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GET"><span class="toc-text">GET</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#STORE"><span class="toc-text">STORE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-text">æ‰§è¡Œé¡ºåº</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5%E6%9C%BA%E5%88%B6"><span class="toc-text">é€šçŸ¥æœºåˆ¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84"><span class="toc-text">ä½“ç³»æ¶æ„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8"><span class="toc-text">äº‹ä»¶é©±åŠ¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-2"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6"><span class="toc-text">æ–‡ä»¶äº‹ä»¶</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%BB%84%E6%88%90"><span class="toc-text">åŸºæœ¬ç»„æˆ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8"><span class="toc-text">å¤šè·¯å¤ç”¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">å¤„ç†å™¨</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6"><span class="toc-text">æ—¶é—´äº‹ä»¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E8%B0%83%E5%BA%A6"><span class="toc-text">äº‹ä»¶è°ƒåº¦</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-text">å¤šçº¿ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF-2"><span class="toc-text">å®¢æˆ·ç«¯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-3"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">æ•°æ®ç»“æ„</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#redisClient"><span class="toc-text">redisClient</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="toc-text">å¥—æ¥å­—</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8D%E5%AD%97"><span class="toc-text">åå­—</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%87%E5%BF%97"><span class="toc-text">æ ‡å¿—</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-text">ç¼“å†²åŒº</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4"><span class="toc-text">å‘½ä»¤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81"><span class="toc-text">éªŒè¯</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%B6%E9%97%B4"><span class="toc-text">æ—¶é—´</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">ç”Ÿå‘½å‘¨æœŸ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA"><span class="toc-text">åˆ›å»º</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%97%AD"><span class="toc-text">å…³é—­</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8-3"><span class="toc-text">æœåŠ¡å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">æ‰§è¡Œæµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82"><span class="toc-text">å‘½ä»¤è¯·æ±‚</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-text">å‘½ä»¤æ‰§è¡Œ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Command"><span class="toc-text">Command</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#serverCron"><span class="toc-text">serverCron</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-4"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E7%BC%93%E5%AD%98"><span class="toc-text">æ—¶é—´ç¼“å­˜</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#LRU-%E6%97%B6%E9%92%9F"><span class="toc-text">LRU æ—¶é’Ÿ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%AC%A1%E6%95%B0"><span class="toc-text">å‘½ä»¤æ¬¡æ•°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%B3%B0%E5%80%BC"><span class="toc-text">å†…å­˜å³°å€¼</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SIGTERM"><span class="toc-text">SIGTERM</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E8%B5%84%E6%BA%90"><span class="toc-text">ç®¡ç†èµ„æº</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E7%8A%B6%E6%80%81"><span class="toc-text">æŒä¹…çŠ¶æ€</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E6%89%A7%E8%A1%8C"><span class="toc-text">å»¶è¿Ÿæ‰§è¡Œ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%AC%A1%E6%95%B0"><span class="toc-text">æ‰§è¡Œæ¬¡æ•°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E9%99%90%E5%88%B6"><span class="toc-text">ç¼“å†²é™åˆ¶</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">åˆå§‹åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E7%BB%93%E6%9E%84"><span class="toc-text">åˆå§‹ç»“æ„</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%98%E5%8E%9F%E7%8A%B6%E6%80%81"><span class="toc-text">è¿˜åŸçŠ¶æ€</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E5%BE%AA%E7%8E%AF"><span class="toc-text">é©±åŠ¨å¾ªç¯</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%85%A2%E6%97%A5%E5%BF%97"><span class="toc-text">æ…¢æ—¥å¿—</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-5"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E4%BF%9D%E5%AD%98"><span class="toc-text">æ—¥å¿—ä¿å­˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%97%A5%E5%BF%97"><span class="toc-text">æ·»åŠ æ—¥å¿—</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-2"><span class="toc-text">æ•°æ®ç»“æ„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-text">å­—ç¬¦ä¸²</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SDS"><span class="toc-text">SDS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94"><span class="toc-text">å¯¹æ¯”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98"><span class="toc-text">å†…å­˜</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE%E8%A1%A8"><span class="toc-text">é“¾è¡¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E5%85%B8"><span class="toc-text">å­—å…¸</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E8%A1%A8"><span class="toc-text">å“ˆå¸Œè¡¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E5%85%B8%E7%BB%93%E6%9E%84"><span class="toc-text">å­—å…¸ç»“æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E5%86%B2%E7%AA%81"><span class="toc-text">å“ˆå¸Œå†²çª</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9B%A0%E5%AD%90"><span class="toc-text">è´Ÿè½½å› å­</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E6%95%A3%E5%88%97"><span class="toc-text">é‡æ–°æ•£åˆ—</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%B3%E8%B7%83%E8%A1%A8"><span class="toc-text">è·³è·ƒè¡¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84"><span class="toc-text">åº•å±‚ç»“æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E5%88%86%E6%9E%90"><span class="toc-text">å±æ€§åˆ†æ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88"><span class="toc-text">æ•´æ•°é›†åˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84-2"><span class="toc-text">åº•å±‚ç»“æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E5%8D%87%E7%BA%A7"><span class="toc-text">ç±»å‹å‡çº§</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8"><span class="toc-text">å‹ç¼©åˆ—è¡¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84-3"><span class="toc-text">åº•å±‚ç»“æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%97%E8%A1%A8%E8%8A%82%E7%82%B9"><span class="toc-text">åˆ—è¡¨èŠ‚ç‚¹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E9%94%81%E6%9B%B4%E6%96%B0"><span class="toc-text">è¿é”æ›´æ–°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">æ•°æ®ç±»å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#redisObj"><span class="toc-text">redisObj</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%B3%BB%E7%BB%9F"><span class="toc-text">å¯¹è±¡ç³»ç»Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E5%A4%9A%E6%80%81"><span class="toc-text">å‘½ä»¤å¤šæ€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6"><span class="toc-text">å†…å­˜å›æ”¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%85%B1%E4%BA%AB"><span class="toc-text">å¯¹è±¡å…±äº«</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A9%BA%E8%BD%AC%E6%97%B6%E9%95%BF"><span class="toc-text">ç©ºè½¬æ—¶é•¿</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#string"><span class="toc-text">string</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C"><span class="toc-text">æ“ä½œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-text">å®ç°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8"><span class="toc-text">åº”ç”¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hash"><span class="toc-text">hash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-2"><span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C-2"><span class="toc-text">æ“ä½œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-2"><span class="toc-text">å®ç°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8-2"><span class="toc-text">åº”ç”¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#list"><span class="toc-text">list</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-3"><span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C-3"><span class="toc-text">æ“ä½œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-3"><span class="toc-text">å®ç°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8-3"><span class="toc-text">åº”ç”¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set"><span class="toc-text">set</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-4"><span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C-4"><span class="toc-text">æ“ä½œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-4"><span class="toc-text">å®ç°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8-4"><span class="toc-text">åº”ç”¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zset"><span class="toc-text">zset</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-5"><span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C-5"><span class="toc-text">æ“ä½œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-5"><span class="toc-text">å®ç°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8-5"><span class="toc-text">åº”ç”¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bitmaps"><span class="toc-text">Bitmaps</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-text">åŸºæœ¬æ“ä½œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E5%AE%9E%E7%8E%B0"><span class="toc-text">å‘½ä»¤å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#GETBIT"><span class="toc-text">GETBIT</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SETBIT"><span class="toc-text">SETBIT</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#BITCOUNT"><span class="toc-text">BITCOUNT</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#BITOP"><span class="toc-text">BITOP</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">åº”ç”¨åœºæ™¯</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hyper"><span class="toc-text">Hyper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GEO"><span class="toc-text">GEO</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E6%9C%BA%E5%88%B6"><span class="toc-text">æŒä¹…æœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-2"><span class="toc-text">æ¦‚è¿°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RDB"><span class="toc-text">RDB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA"><span class="toc-text">æ–‡ä»¶åˆ›å»º</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#SAVE"><span class="toc-text">SAVE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#BGSAVE"><span class="toc-text">BGSAVE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E6%8C%87%E4%BB%A4"><span class="toc-text">ç‰¹æ®ŠæŒ‡ä»¤</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%BD%BD%E5%85%A5"><span class="toc-text">æ–‡ä»¶è½½å…¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E4%BF%9D%E5%AD%98"><span class="toc-text">è‡ªåŠ¨ä¿å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">é…ç½®æ–‡ä»¶</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8E%9F%E7%90%86"><span class="toc-text">è‡ªåŠ¨åŸç†</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-text">æ–‡ä»¶ç»“æ„</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AOF"><span class="toc-text">AOF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E8%BF%B0"><span class="toc-text">åŸºæœ¬æ¦‚è¿°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%AE%9E%E7%8E%B0"><span class="toc-text">æŒä¹…å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%BF%BD%E5%8A%A0"><span class="toc-text">å‘½ä»¤è¿½åŠ </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5"><span class="toc-text">æ–‡ä»¶å†™å…¥</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5"><span class="toc-text">æ–‡ä»¶åŒæ­¥</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%BD%BD%E5%85%A5-2"><span class="toc-text">æ–‡ä»¶è½½å…¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E5%86%99%E5%AE%9E%E7%8E%B0"><span class="toc-text">é‡å†™å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E5%86%99%E7%AD%96%E7%95%A5"><span class="toc-text">é‡å†™ç­–ç•¥</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E5%86%99%E5%8E%9F%E7%90%86"><span class="toc-text">é‡å†™åŸç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E9%87%8D%E5%86%99"><span class="toc-text">è‡ªåŠ¨é‡å†™</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94-2"><span class="toc-text">å¯¹æ¯”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fork"><span class="toc-text">fork</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-text">ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-text">ä½¿ç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98-2"><span class="toc-text">å†…å­˜</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6"><span class="toc-text">äº‹åŠ¡æœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%89%B9%E5%BE%81"><span class="toc-text">äº‹åŠ¡ç‰¹å¾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-text">å·¥ä½œæµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WATCH"><span class="toc-text">WATCH</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E8%A7%86%E6%9C%BA%E5%88%B6"><span class="toc-text">ç›‘è§†æœºåˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">å®ç°åŸç†</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ACID"><span class="toc-text">ACID</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%80%A7"><span class="toc-text">åŸå­æ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-text">ä¸€è‡´æ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9A%94%E7%A6%BB%E6%80%A7"><span class="toc-text">éš”ç¦»æ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E6%80%A7"><span class="toc-text">æŒä¹…æ€§</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua-%E8%84%9A%E6%9C%AC"><span class="toc-text">Lua è„šæœ¬</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%88%9B%E5%BB%BA"><span class="toc-text">ç¯å¢ƒåˆ›å»º</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-6"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="toc-text">åˆ›å»ºè¿‡ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8F%E4%BD%9C%E7%BB%84%E4%BB%B6"><span class="toc-text">åä½œç»„ä»¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">ä¼ªå®¢æˆ·ç«¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E5%AD%97%E5%85%B8"><span class="toc-text">è„šæœ¬å­—å…¸</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E5%AE%9E%E7%8E%B0-2"><span class="toc-text">å‘½ä»¤å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E5%87%BD%E6%95%B0"><span class="toc-text">è„šæœ¬å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0"><span class="toc-text">æ‰§è¡Œå‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EVALSHA"><span class="toc-text">EVALSHA</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4"><span class="toc-text">ç®¡ç†å‘½ä»¤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E5%A4%8D%E5%88%B6"><span class="toc-text">è„šæœ¬å¤åˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E5%A4%8D%E5%88%B6"><span class="toc-text">å‘½ä»¤å¤åˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EVALSHA-2"><span class="toc-text">EVALSHA</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">åˆ†å¸ƒå¼é”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C-2"><span class="toc-text">åŸºæœ¬æ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E8%AF%AF%E5%88%A0"><span class="toc-text">é˜²è¯¯åˆ </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E9%94%81"><span class="toc-text">ä¼˜åŒ–é”</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%85%A5"><span class="toc-text">ä¸å¯é‡å…¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E9%87%8D%E8%AF%95"><span class="toc-text">ä¸å¯é‡è¯•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E9%87%8A%E6%94%BE"><span class="toc-text">è¶…æ—¶é‡Šæ”¾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E4%B8%80%E8%87%B4"><span class="toc-text">ä¸»ä»ä¸€è‡´</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-text">ä¸»ä»å¤åˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C-3"><span class="toc-text">åŸºæœ¬æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E4%BB%8B%E7%BB%8D"><span class="toc-text">ä¸»ä»ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E6%8C%87%E4%BB%A4"><span class="toc-text">æ“ä½œæŒ‡ä»¤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E6%B5%81%E7%A8%8B"><span class="toc-text">å¤åˆ¶æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A7%E7%89%88%E5%A4%8D%E5%88%B6"><span class="toc-text">æ—§ç‰ˆå¤åˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E7%BC%BA%E9%99%B7"><span class="toc-text">åŠŸèƒ½ç¼ºé™·</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E7%89%88%E5%A4%8D%E5%88%B6"><span class="toc-text">æ–°ç‰ˆå¤åˆ¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E5%90%8C%E6%AD%A5"><span class="toc-text">éƒ¨åˆ†åŒæ­¥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%81%8F%E7%A7%BB%E9%87%8F"><span class="toc-text">åç§»é‡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA-2"><span class="toc-text">ç¼“å†²åŒº</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8CID"><span class="toc-text">è¿è¡ŒID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PSYNC"><span class="toc-text">PSYNC</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E5%AE%9E%E7%8E%B0"><span class="toc-text">å¤åˆ¶å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B"><span class="toc-text">å®ç°æµç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E5%9B%BE%E7%A4%BA"><span class="toc-text">å¤åˆ¶å›¾ç¤º</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%83%E8%B7%B3%E6%A3%80%E6%B5%8B"><span class="toc-text">å¿ƒè·³æ£€æµ‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BF%83%E8%B7%B3%E6%9C%BA%E5%88%B6"><span class="toc-text">å¿ƒè·³æœºåˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E7%8A%B6%E6%80%81"><span class="toc-text">ç½‘ç»œçŠ¶æ€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9"><span class="toc-text">é…ç½®é€‰é¡¹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E4%B8%A2%E5%A4%B1"><span class="toc-text">å‘½ä»¤ä¸¢å¤±</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-text">å¸¸è§é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E5%90%AF%E6%81%A2%E5%A4%8D"><span class="toc-text">é‡å¯æ¢å¤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E4%B8%AD%E6%96%AD"><span class="toc-text">ç½‘ç»œä¸­æ–­</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7-2"><span class="toc-text">ä¸€è‡´æ€§</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="toc-text">å“¨å…µæ¨¡å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E6%A6%82%E8%BF%B0"><span class="toc-text">å“¨å…µæ¦‚è¿°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E5%93%A8%E5%85%B5"><span class="toc-text">å¯ç”¨å“¨å…µ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-text">é…ç½®æ–¹å¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-2"><span class="toc-text">åˆå§‹åŒ–</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%9B%BF%E6%8D%A2"><span class="toc-text">ä»£ç æ›¿æ¢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E7%8A%B6%E6%80%81"><span class="toc-text">å“¨å…µçŠ¶æ€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E5%88%97%E8%A1%A8"><span class="toc-text">ç›‘æ§åˆ—è¡¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5"><span class="toc-text">ç½‘ç»œè¿æ¥</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E4%BA%A4%E4%BA%92"><span class="toc-text">ä¿¡æ¯äº¤äº’</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E4%BF%A1%E6%81%AF"><span class="toc-text">è·å–ä¿¡æ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">ä¸»æœåŠ¡å™¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">ä»æœåŠ¡å™¨</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E4%BF%A1%E6%81%AF"><span class="toc-text">å‘é€ä¿¡æ¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%97%E4%BF%A1%E6%81%AF"><span class="toc-text">æ¥å—ä¿¡æ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%A2%E9%98%85%E9%A2%91%E9%81%93"><span class="toc-text">è®¢é˜…é¢‘é“</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%BF%9E%E6%8E%A5"><span class="toc-text">å‘½ä»¤è¿æ¥</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E7%BA%BF%E6%A3%80%E6%B5%8B"><span class="toc-text">ä¸‹çº¿æ£€æµ‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E8%A7%82%E4%B8%8B%E7%BA%BF"><span class="toc-text">ä¸»è§‚ä¸‹çº¿</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E8%A7%82%E4%B8%8B%E7%BA%BF"><span class="toc-text">å®¢è§‚ä¸‹çº¿</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%86%E5%A4%B4%E9%80%89%E4%B8%BE"><span class="toc-text">é¢†å¤´é€‰ä¸¾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-text">æ•…éšœè½¬ç§»</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-2"><span class="toc-text">æ‰§è¡Œæµç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E7%AE%97%E6%B3%95"><span class="toc-text">é€‰æ‹©ç®—æ³•</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F"><span class="toc-text">é›†ç¾¤æ¨¡å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9"><span class="toc-text">é›†ç¾¤èŠ‚ç‚¹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E6%A6%82%E8%BF%B0"><span class="toc-text">èŠ‚ç‚¹æ¦‚è¿°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-3"><span class="toc-text">æ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MEET"><span class="toc-text">MEET</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A7%BD%E6%8C%87%E6%B4%BE"><span class="toc-text">æ§½æŒ‡æ´¾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C-4"><span class="toc-text">åŸºæœ¬æ“ä½œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E6%8C%87%E6%B4%BE"><span class="toc-text">èŠ‚ç‚¹æŒ‡æ´¾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%8C%87%E6%B4%BE"><span class="toc-text">é›†ç¾¤æŒ‡æ´¾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%95%B0%E6%8D%AE"><span class="toc-text">é›†ç¾¤æ•°æ®</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%91%BD%E4%BB%A4"><span class="toc-text">é›†ç¾¤å‘½ä»¤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-text">æ‰§è¡Œå‘½ä»¤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MOVED"><span class="toc-text">MOVED</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E5%88%86%E7%89%87"><span class="toc-text">é‡æ–°åˆ†ç‰‡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-2"><span class="toc-text">å®ç°åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E5%8E%9F%E7%90%86"><span class="toc-text">å‘½ä»¤åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ASK-%E9%94%99%E8%AF%AF"><span class="toc-text">ASK é”™è¯¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ASKING"><span class="toc-text">ASKING</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-text">é«˜å¯ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E5%A4%8D%E5%88%B6"><span class="toc-text">èŠ‚ç‚¹å¤åˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%A3%80%E6%B5%8B"><span class="toc-text">æ•…éšœæ£€æµ‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB-2"><span class="toc-text">æ•…éšœè½¬ç§»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E4%B8%BE%E7%AE%97%E6%B3%95"><span class="toc-text">é€‰ä¸¾ç®—æ³•</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6"><span class="toc-text">æ¶ˆæ¯æœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E7%BB%93%E6%9E%84"><span class="toc-text">æ¶ˆæ¯ç»“æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%A4%B4"><span class="toc-text">æ¶ˆæ¯å¤´</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Gossip"><span class="toc-text">Gossip</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FAIL"><span class="toc-text">FAIL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PUBLISH"><span class="toc-text">PUBLISH</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%91%E8%A3%82%E9%97%AE%E9%A2%98"><span class="toc-text">è„‘è£‚é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E6%90%AD%E5%BB%BA"><span class="toc-text">ç»“æ„æ­å»º</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C"><span class="toc-text">å…¶ä»–æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85"><span class="toc-text">å‘å¸ƒè®¢é˜…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%8C%87%E4%BB%A4-2"><span class="toc-text">åŸºæœ¬æŒ‡ä»¤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%91%E9%81%93%E6%93%8D%E4%BD%9C"><span class="toc-text">é¢‘é“æ“ä½œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E6%93%8D%E4%BD%9C"><span class="toc-text">æ¨¡å¼æ“ä½œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-text">å‘é€æ¶ˆæ¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E4%BF%A1%E6%81%AF"><span class="toc-text">æŸ¥çœ‹ä¿¡æ¯</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ACL-%E6%8C%87%E4%BB%A4"><span class="toc-text">ACL æŒ‡ä»¤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E8%A7%86%E5%99%A8"><span class="toc-text">ç›‘è§†å™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%A4%84%E7%90%86"><span class="toc-text">æ‰¹å¤„ç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">è§£å†³æ–¹æ¡ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%96%B9%E6%A1%88"><span class="toc-text">ç¼“å­˜æ–¹æ¡ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%A8%A1%E5%BC%8F"><span class="toc-text">ç¼“å­˜æ¨¡å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%81%E8%B7%AF%E7%BC%93%E5%AD%98"><span class="toc-text">æ—è·¯ç¼“å­˜</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E7%A9%BF%E9%80%8F"><span class="toc-text">è¯»å†™ç©¿é€</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E7%BC%93%E5%AD%98"><span class="toc-text">å¼‚æ­¥ç¼“å­˜</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4"><span class="toc-text">ç¼“å­˜ä¸€è‡´</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98"><span class="toc-text">ç¼“å­˜é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E9%A2%84%E7%83%AD"><span class="toc-text">ç¼“å­˜é¢„çƒ­</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="toc-text">ç¼“å­˜é›ªå´©</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="toc-text">ç¼“å­˜å‡»ç©¿</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-text">ç¼“å­˜ç©¿é€</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Key-%E8%AE%BE%E8%AE%A1"><span class="toc-text">Key è®¾è®¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2"><span class="toc-text">æ…¢æŸ¥è¯¢</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">Java</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JDBC"><span class="toc-text">JDBC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-3"><span class="toc-text">æ¦‚è¿°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E7%B1%BB"><span class="toc-text">åŠŸèƒ½ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DriverManager"><span class="toc-text">DriverManager</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Connection"><span class="toc-text">Connection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Statement"><span class="toc-text">Statement</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ResultSet"><span class="toc-text">ResultSet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">ä»£ç å®ç°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB"><span class="toc-text">æ³¨å…¥æ”»å‡»</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%BC%94%E7%A4%BA"><span class="toc-text">æ”»å‡»æ¼”ç¤º</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E8%A7%A3%E5%86%B3"><span class="toc-text">æ”»å‡»è§£å†³</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-text">è¿æ¥æ± </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-text">æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%92%E8%BF%98%E8%BF%9E%E6%8E%A5"><span class="toc-text">å½’è¿˜è¿æ¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE"><span class="toc-text">å¼€æºé¡¹ç›®</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#C3P0"><span class="toc-text">C3P0</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Druid"><span class="toc-text">Druid</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jedis"><span class="toc-text">Jedis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-text">å·¥å…·ç±»</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">æ ¼è¨€ğŸ§¬</p><div class="bg-ad"><div>å†çœ‹çœ‹é‚£ä¸ªå…‰ç‚¹ï¼Œå®ƒå°±åœ¨è¿™é‡Œï¼Œè¿™æ˜¯å®¶å›­ï¼Œè¿™æ˜¯æˆ‘ä»¬ â€”â€” ä½ æ‰€çˆ±çš„æ¯ä¸€ä¸ªäººï¼Œä½ è®¤è¯†çš„ä¸€ä¸ªäººï¼Œä½ å¬è¯´è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œæ›¾ç»æœ‰è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œéƒ½åœ¨å®ƒä¸Šé¢åº¦è¿‡ä»–ä»¬çš„ä¸€ç”Ÿâœ¨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">ç‚¹å‡»å¼€å¯æ˜Ÿè¾°ä¹‹æ—…</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">çŒœä½ æƒ³çœ‹ğŸ’¡</p><ul class="ft-links"><li><a href="/posts/eec9786.html">é­”æ”¹æŒ‡å—</a><a href="/box/Gallery/">æˆ‘çš„ç”»å»Š</a></li><li><a href="/social/link/">æˆ‘çš„æœ‹å‹</a><a href="/comments/">ç•™ç‚¹ä»€ä¹ˆ</a></li><li><a href="/personal/about/">å…³äºä½œè€…</a><a href="/archives/">æ–‡ç« å½’æ¡£</a></li><li><a href="/categories/">æ–‡ç« åˆ†ç±»</a><a href="/tags/">æ–‡ç« æ ‡ç­¾</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">æ¨èå‹é“¾âŒ›</p><div class="ft-img-group"><div class="img-group-item"><a target="_blank" rel="noopener" href="https://www.fomal.cc/" title="FomalhautğŸ¥"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/60e5d4e39da7c077.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div></div></div></div><div class="copyright"><span><b>&copy;2022-2023</b></span><span><b>&nbsp;&nbsp;By jsonğŸ¥</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="åšå®¢æ¡†æ¶ä¸ºHexo_v6.3.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Frame-Hexo-blue.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="ä¸»é¢˜ç‰ˆæœ¬Butterfly_v4.3.1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Theme-Butterfly-6513df.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" title="æœ¬ç«™é‡‡ç”¨å¤šçº¿éƒ¨ç½²ï¼Œä¸»çº¿è·¯æ‰˜ç®¡äºVercel"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Hosted-Vercel-brightgreen.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://user.51.la/" style="margin-inline:5px" title="æœ¬ç«™æ•°æ®åˆ†æå¾—ç›Šäº51laæŠ€æœ¯æ”¯æŒ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Analytics-51la-3db1eb.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://cdn-eys.pages.dev/html/beian.html" style="margin-inline:5px" title="æœ¬ç«™å·²åŠ å…¥èŒICPè±ªåå¥—é¤ï¼ŒèŒICPå¤‡20226665å·"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/%E8%90%8Cicp%E5%A4%87-2023001927-pink.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://bitiful.dogecast.com/buckets" style="margin-inline:5px" title="æœ¬ç½‘ç«™ç»Service Workeråˆ†æµè‡³ç¼¤çº·äº‘å¯¹è±¡å­˜å‚¨"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Bucket-ç¼¤çº·äº‘-9c62da.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.netdun.net/" style="margin-inline:5px" title="æœ¬ç«™ä½¿ç”¨ç½‘ç›¾æ˜Ÿçƒæä¾›CDNåŠ é€Ÿä¸é˜²æŠ¤"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/CDN-ç½‘ç›¾æ˜Ÿçƒ-fff2cc.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="æœ¬ç½‘ç«™æºç ç”±Githubæä¾›å­˜å‚¨ä»“åº“"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Source-Github-d021d6.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="å³é”®æ¨¡å¼" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>å¤åˆ¶</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>ç™¾åº¦æœç´¢</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>ç²˜è´´</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>ç©ºé™è¯„è®º</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>å¤åˆ¶æœ¬æ–‡åœ°å€</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>ä¿å­˜å›¾ç‰‡</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>åœ¨æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶å›¾ç‰‡é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>æ˜¼å¤œåˆ‡æ¢</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>å…³äºåšå®¢</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>ç¾åŒ–è®¾ç½®</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>åˆ‡æ¢å…¨å±</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>æ‰“å°é¡µé¢</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://www.json1234.xyz/',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://www.json1234.xyz/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://www.json25.cn/categories/è®¡ç®—æœºåŸºç¡€/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¼ jsonã®è®¡ç®—æœºåŸºç¡€ç¬”è®° (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.json25.cn/categories/é­”æ”¹æ•™ç¨‹/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ‰ jsonã®åšå®¢é­”æ”¹æ•™ç¨‹ (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.json25.cn/categories/JavaåŸºç¡€/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸŸ jsonã®JavaåŸºç¡€ç¬”è®° (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.json25.cn/categories/æ•°æ®åº“/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¨ jsonã®æ•°æ®åº“ç¬”è®° (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.json25.cn/categories/å‰ç«¯/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥ jsonã®å‰ç«¯ç¬”è®° (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://www.json25.cn/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';
    console.log('å·²æŒ‚è½½magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/10c11d66.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm13.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-03-17</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/10c11d66.html&quot;);" href="javascript:void(0);" alt="">javaå¸¸ç”¨å·¥å…·</a><div class="blog-slider__text">è¿™æ˜¯ä¸€ç¯‡å…³äºjavaå·¥å…·çš„ä»‹ç»</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/10c11d66.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/440e822d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm5.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-17</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/440e822d.html&quot;);" href="javascript:void(0);" alt="">æ•°æ®ç»“æ„ç®—æ³•</a><div class="blog-slider__text">è¿™æ˜¯è€ƒç ”æ•°æ®ç»“æ„ç®—æ³•æ€»ç»“</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/440e822d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/84cad344.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm9.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-16</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/84cad344.html&quot;);" href="javascript:void(0);" alt="">javassmæ¡†æ¶</a><div class="blog-slider__text">è¿™æ˜¯ssmæ¡†æ¶çš„ç¬”è®°</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/84cad344.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/827432d7.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm18.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-03-16</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/827432d7.html&quot;);" href="javascript:void(0);" alt="">javaseåŸºç¡€çŸ¥è¯†</a><div class="blog-slider__text">è¿™æ˜¯ä¸€ç¯‡å…³äºjavaseçš„ç¬”è®°</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/827432d7.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/779497dd.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm13.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-16</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/779497dd.html&quot;);" href="javascript:void(0);" alt="">å¸¸ç”¨æ¡†æ¶</a><div class="blog-slider__text">è¿™æ˜¯ä¸€ç¯‡å…³äºjavaå¸¸ç”¨æ¡†æ¶çš„ç¬”è®°</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/779497dd.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2636df6a.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm11.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-03-16</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2636df6a.html&quot;);" href="javascript:void(0);" alt="">redisæ•°æ®åº“</a><div class="blog-slider__text">è¿™æ˜¯ä¸€ç¯‡å…³äºredisæ•°æ®åº“çš„ç¬”è®°</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2636df6a.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/b7e144d1.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm0.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/b7e144d1.html&quot;);" href="javascript:void(0);" alt="">ç®—æ³•</a><div class="blog-slider__text">æœ¬æ–‡ä¸»è¦è®°å½•leetcodeåˆ·é¢˜è®°å½•</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/b7e144d1.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/8de1ec.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm4.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/8de1ec.html&quot;);" href="javascript:void(0);" alt="">javaé¢ç»</a><div class="blog-slider__text">æœ¬æ–‡ä¸»è¦è®°å½•Javaé¢è¯•åŸºæœ¬å…«è‚¡æ–‡ï¼ŒåŒæ—¶ä¸ºäº†å·©å›ºjavaåŸºç¡€å’Œå¤ä¹ å­¦è¿‡çš„å†…å®¹</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/8de1ec.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/784bec6.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm15.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/784bec6.html&quot;);" href="javascript:void(0);" alt="">ajaxç¬”è®°</a><div class="blog-slider__text">æœ¬æ–‡ä¸»è¦è®°å½•äº†javaåŸºç¡€ä¸­ajaxæŠ€æœ¯çš„ä½¿ç”¨ä¸ç›¸å…³æŠ€æœ¯</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/784bec6.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/13fb5dc7.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm20.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/13fb5dc7.html&quot;);" href="javascript:void(0);" alt="">mysqlæ•°æ®åº“ç¬”è®°</a><div class="blog-slider__text">æœ¬æ–‡è®°å½•äº†mysqlçš„ä¸€äº›åŸºç¡€æ“ä½œå’Œå¸¸ç”¨çš„crudè¯­å¥çš„ä½¿ç”¨</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/13fb5dc7.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm6.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-08-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">Markdownè¯­æ³•ä¸å¤–æŒ‚æ ‡ç­¾å†™æ³•æ±‡æ€»</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡æ±‡æ€»Markdownæ ¼å¼ä»¥åŠå¤–æŒ‚æ ‡ç­¾åœ¨ç½‘é¡µç«¯çš„æ¸²æŸ“æ•ˆæœï¼Œå¯ä½œä¸ºæ–‡æ¡£è¿›è¡ŒæŸ¥è¯¢</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('å·²æŒ‚è½½gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><!-- hexo injector body_end end --></body></html>