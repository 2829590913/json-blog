<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>å¸¸ç”¨æ¡†æ¶ | json'blogğŸ¥</title><meta name="keywords" content="java,æ¡†æ¶,maven,zk,netty"><meta name="author" content="jsonğŸ¥"><meta name="copyright" content="jsonğŸ¥"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="è¿™æ˜¯ä¸€ç¯‡å…³äºjavaå¸¸ç”¨æ¡†æ¶çš„ç¬”è®°">
<meta property="og:type" content="article">
<meta property="og:title" content="å¸¸ç”¨æ¡†æ¶">
<meta property="og:url" content="https://www.json25.cn/posts/779497dd.html">
<meta property="og:site_name" content="json&#39;blogğŸ¥">
<meta property="og:description" content="è¿™æ˜¯ä¸€ç¯‡å…³äºjavaå¸¸ç”¨æ¡†æ¶çš„ç¬”è®°">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn-eys.pages.dev/img/dm13.webp">
<meta property="article:published_time" content="2023-03-16T15:54:24.000Z">
<meta property="article:modified_time" content="2023-03-16T16:22:19.560Z">
<meta property="article:author" content="jsonğŸ¥">
<meta property="article:tag" content="java">
<meta property="article:tag" content="æ¡†æ¶">
<meta property="article:tag" content="maven">
<meta property="article:tag" content="zk">
<meta property="article:tag" content="netty">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn-eys.pages.dev/img/dm13.webp"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://www.json25.cn/posts/779497dd"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'å¸¸ç”¨æ¡†æ¶',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-17 00:22:19'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="json'blogğŸ¥" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/favicon.png" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">8</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> å…³äº</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">json'blogğŸ¥</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> å…³äº</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="æ£€ç´¢ç«™å†…ä»»ä½•ä½ æƒ³è¦çš„ä¿¡æ¯"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> æœç´¢</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="ç¾åŒ–è®¾ç½®-è‡ªå®šä¹‰ä½ çš„é£æ ¼" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">å¸¸ç”¨æ¡†æ¶</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">å‘è¡¨äº </span><time class="post-meta-date-created" datetime="2023-03-16T15:54:24.000Z" title="å‘è¡¨äº 2023-03-16 23:54:24">2023-03-16</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-03-16T16:22:19.560Z" title="æ›´æ–°äº 2023-03-17 00:22:19">2023-03-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/Java%E5%9F%BA%E7%A1%80/">JavaåŸºç¡€</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">8w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>300åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="å¸¸ç”¨æ¡†æ¶"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h1><h2 id="åŸºæœ¬ä»‹ç»"><a href="#åŸºæœ¬ä»‹ç»" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h2><h3 id="Mvnä»‹ç»"><a href="#Mvnä»‹ç»" class="headerlink" title="Mvnä»‹ç»"></a>Mvnä»‹ç»</h3><p>Mavenï¼šæœ¬è´¨æ˜¯ä¸€ä¸ªé¡¹ç›®ç®¡ç†å·¥å…·ï¼Œå°†é¡¹ç›®å¼€å‘å’Œç®¡ç†è¿‡ç¨‹æŠ½è±¡æˆä¸€ä¸ªé¡¹ç›®å¯¹è±¡æ¨¡å‹ï¼ˆPOMï¼‰</p>
<p>POMï¼šProject Object Model é¡¹ç›®å¯¹è±¡æ¨¡å‹ã€‚Maven æ˜¯ç”¨ Java è¯­è¨€ç¼–å†™çš„ï¼Œç®¡ç†çš„ä¸œè¥¿ä»¥é¢å‘å¯¹è±¡çš„å½¢å¼è¿›è¡Œè®¾è®¡ï¼Œæœ€ç»ˆæŠŠä¸€ä¸ªé¡¹ç›®çœ‹æˆä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å«åš POM</p>
<p>pom.xmlï¼šMaven éœ€è¦ä¸€ä¸ª  pom.xml æ–‡ä»¶ï¼ŒMaven é€šè¿‡åŠ è½½è¿™ä¸ªé…ç½®æ–‡ä»¶å¯ä»¥çŸ¥é“é¡¹ç›®çš„ç›¸å…³ä¿¡æ¯ï¼Œè¿™ä¸ªæ–‡ä»¶ä»£è¡¨å°±ä¸€ä¸ªé¡¹ç›®ã€‚å¦‚æœåš 8 ä¸ªé¡¹ç›®ï¼Œå¯¹åº”çš„æ˜¯ 8 ä¸ª pom.xml æ–‡ä»¶</p>
<p>ä¾èµ–ç®¡ç†ï¼šMaven å¯¹é¡¹ç›®æ‰€æœ‰ä¾èµ–èµ„æºçš„ä¸€ç§ç®¡ç†ï¼Œå®ƒå’Œé¡¹ç›®ä¹‹é—´æ˜¯ä¸€ç§åŒå‘å…³ç³»ï¼Œå³åšé¡¹ç›®æ—¶å¯ä»¥ç®¡ç†æ‰€éœ€è¦çš„å…¶ä»–èµ„æºï¼Œå½“å…¶ä»–é¡¹ç›®éœ€è¦ä¾èµ–æˆ‘ä»¬é¡¹ç›®æ—¶ï¼ŒMaven ä¹Ÿä¼šæŠŠæˆ‘ä»¬çš„é¡¹ç›®å½“ä½œä¸€ç§èµ„æºå»è¿›è¡Œç®¡ç†ã€‚</p>
<p>ç®¡ç†èµ„æºçš„å­˜å‚¨ä½ç½®ï¼šæœ¬åœ°ä»“åº“ï¼Œç§æœï¼Œä¸­å¤®ä»“åº“</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Mavenä»‹ç».png" alt=""></p>
<p>åŸºæœ¬ä½œç”¨ï¼š</p>
<ul>
<li><p>é¡¹ç›®æ„å»ºï¼šæä¾›æ ‡å‡†çš„ï¼Œè·¨å¹³å°çš„è‡ªåŠ¨åŒ–æ„å»ºé¡¹ç›®çš„æ–¹å¼</p>
</li>
<li><p>ä¾èµ–ç®¡ç†ï¼šæ–¹ä¾¿å¿«æ·çš„ç®¡ç†é¡¹ç›®ä¾èµ–çš„èµ„æºï¼ˆjar åŒ…ï¼‰ï¼Œé¿å…èµ„æºé—´çš„ç‰ˆæœ¬å†²çªç­‰é—®é¢˜</p>
</li>
<li><p>ç»Ÿä¸€å¼€å‘ç»“æ„ï¼šæä¾›æ ‡å‡†çš„ï¼Œç»Ÿä¸€çš„é¡¹ç›®å¼€å‘ç»“æ„</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Mavenæ ‡å‡†ç»“æ„.png" alt=""></p>
</li>
</ul>
<p>å„ç›®å½•å­˜æ”¾èµ„æºç±»å‹è¯´æ˜ï¼š</p>
<ul>
<li><p>src/main/javaï¼šé¡¹ç›® java æºç </p>
</li>
<li><p>src/main/resourcesï¼šé¡¹ç›®çš„ç›¸å…³é…ç½®æ–‡ä»¶ï¼ˆæ¯”å¦‚ mybatis é…ç½®ï¼Œxml æ˜ å°„é…ç½®ï¼Œè‡ªå®šä¹‰é…ç½®æ–‡ä»¶ç­‰ï¼‰</p>
</li>
<li><p>src/main/webappï¼šweb èµ„æºï¼ˆæ¯”å¦‚ htmlã€cssã€js ç­‰ï¼‰</p>
</li>
<li><p>src/test/javaï¼šæµ‹è¯•ä»£ç </p>
</li>
<li><p>src/test/resourcesï¼šæµ‹è¯•ç›¸å…³é…ç½®æ–‡ä»¶</p>
</li>
<li><p>src/pom.xmlï¼šé¡¹ç›® pom æ–‡ä»¶</p>
</li>
</ul>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Ah411S7ZE">https://www.bilibili.com/video/BV1Ah411S7ZE</a></p>
<hr>
<h3 id="åŸºç¡€æ¦‚å¿µ"><a href="#åŸºç¡€æ¦‚å¿µ" class="headerlink" title="åŸºç¡€æ¦‚å¿µ"></a>åŸºç¡€æ¦‚å¿µ</h3><p>ä»“åº“ï¼šç”¨äºå­˜å‚¨èµ„æºï¼Œä¸»è¦æ˜¯å„ç§ jar åŒ…ã€‚æœ‰æœ¬åœ°ä»“åº“ï¼Œç§æœï¼Œä¸­å¤®ä»“åº“ï¼Œç§æœå’Œä¸­å¤®ä»“åº“éƒ½æ˜¯è¿œç¨‹ä»“åº“</p>
<ul>
<li><p>ä¸­å¤®ä»“åº“ï¼šMaven å›¢é˜Ÿè‡ªèº«ç»´æŠ¤çš„ä»“åº“ï¼Œå±äºå¼€æºçš„</p>
</li>
<li><p>ç§æœï¼šå„å…¬å¸/éƒ¨é—¨ç­‰å°èŒƒå›´å†…å­˜å‚¨èµ„æºçš„ä»“åº“ï¼Œç§æœä¹Ÿå¯ä»¥ä»ä¸­å¤®ä»“åº“è·å–èµ„æºï¼Œä½œç”¨ï¼š</p>
<ul>
<li>ä¿å­˜å…·æœ‰ç‰ˆæƒçš„èµ„æºï¼ŒåŒ…å«è´­ä¹°æˆ–è‡ªä¸»ç ”å‘çš„ jar</li>
<li>ä¸€å®šèŒƒå›´å†…å…±äº«èµ„æºï¼Œèƒ½åšåˆ°ä»…å¯¹å†…ä¸å¯¹å¤–å¼€æ”¾</li>
</ul>
</li>
<li><p>æœ¬åœ°ä»“åº“ï¼šå¼€å‘è€…è‡ªå·±ç”µè„‘ä¸Šå­˜å‚¨èµ„æºçš„ä»“åº“ï¼Œä¹Ÿå¯ä»è¿œç¨‹ä»“åº“è·å–èµ„æº</p>
</li>
</ul>
<p>åæ ‡ï¼šMaven ä¸­çš„åæ ‡ç”¨äºæè¿°ä»“åº“ä¸­èµ„æºçš„ä½ç½®</p>
<ul>
<li><p>ä½œç”¨ï¼šä½¿ç”¨å”¯ä¸€æ ‡è¯†ï¼Œå”¯ä¸€æ€§å®šä¹‰èµ„æºä½ç½®ï¼Œé€šè¿‡è¯¥æ ‡è¯†å¯ä»¥å°†èµ„æºçš„è¯†åˆ«ä¸ä¸‹è½½å·¥ä½œäº¤ç”±æœºå™¨å®Œæˆ</p>
<ul>
<li><p><a href="https://mvnrepository.comï¼šæŸ¥è¯¢">https://mvnrepository.comï¼šæŸ¥è¯¢</a> maven æŸä¸€ä¸ªèµ„æºçš„åæ ‡ï¼Œè¾“å…¥èµ„æºåç§°è¿›è¡Œæ£€ç´¢</p>
</li>
<li><p>ä¾èµ–è®¾ç½®ï¼š</p>
<ul>
<li>groupIdï¼šå®šä¹‰å½“å‰èµ„æºéš¶å±ç»„ç»‡åç§°ï¼ˆé€šå¸¸æ˜¯åŸŸååå†™ï¼Œå¦‚ï¼šorg.mybatisï¼‰</li>
</ul>
</li>
<li>artifactIdï¼šå®šä¹‰å½“å‰èµ„æºçš„åç§°ï¼ˆé€šå¸¸æ˜¯é¡¹ç›®æˆ–æ¨¡å—åç§°ï¼Œå¦‚ï¼šcrmã€smsï¼‰<ul>
<li>versionï¼šå®šä¹‰å½“å‰èµ„æºçš„ç‰ˆæœ¬å·</li>
</ul>
</li>
</ul>
</li>
<li><p>packagingï¼šå®šä¹‰èµ„æºçš„æ‰“åŒ…æ–¹å¼ï¼Œå–å€¼ä¸€èˆ¬æœ‰å¦‚ä¸‹ä¸‰ç§</p>
<ul>
<li><p>jarï¼šè¯¥èµ„æºæ‰“æˆ jar åŒ…ï¼Œé»˜è®¤æ˜¯ jar</p>
</li>
<li><p>warï¼šè¯¥èµ„æºæ‰“æˆ war åŒ…</p>
</li>
<li><p>pomï¼šè¯¥èµ„æºæ˜¯ä¸€ä¸ªçˆ¶èµ„æºï¼ˆè¡¨æ˜ä½¿ç”¨ Maven åˆ†æ¨¡å—ç®¡ç†ï¼‰ï¼Œæ‰“åŒ…æ—¶åªç”Ÿæˆä¸€ä¸ª pom.xml ä¸ç”Ÿæˆ jar æˆ–å…¶ä»–åŒ…ç»“æ„</p>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><h3 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h3><p>Maven çš„å®˜ç½‘ï¼š<a target="_blank" rel="noopener" href="http://maven.apache.org/">http://maven.apache.org/</a></p>
<p>ä¸‹è½½å®‰è£…ï¼šMaven æ˜¯ä¸€ä¸ªç»¿è‰²è½¯ä»¶ï¼Œè§£å‹å³å®‰è£…</p>
<p>ç›®å½•ç»“æ„ï¼š</p>
<ul>
<li>binï¼šå¯æ‰§è¡Œç¨‹åºç›®å½•</li>
<li>bootï¼šMaven è‡ªèº«çš„å¯åŠ¨åŠ è½½å™¨</li>
<li>confï¼šMaven é…ç½®æ–‡ä»¶çš„å­˜æ”¾ç›®å½•</li>
<li>libï¼šMavenè¿è¡Œæ‰€éœ€åº“çš„å­˜æ”¾ç›®å½•</li>
</ul>
<p>é…ç½® MAVEN_HOMEï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Mavené…ç½®ç¯å¢ƒå˜é‡.png" alt=""></p>
<p>Path ä¸‹é…ç½®ï¼š<code>%MAVEN_HOME%\bin</code></p>
<p>ç¯å¢ƒå˜é‡é…ç½®å¥½ä¹‹åéœ€è¦æµ‹è¯•ç¯å¢ƒé…ç½®ç»“æœï¼Œåœ¨ DOS å‘½ä»¤çª—å£ä¸‹è¾“å…¥ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹è¾“å‡ºï¼š<code>mvn -v</code></p>
<hr>
<h3 id="ä»“åº“é…ç½®"><a href="#ä»“åº“é…ç½®" class="headerlink" title="ä»“åº“é…ç½®"></a>ä»“åº“é…ç½®</h3><p>é»˜è®¤æƒ…å†µ Maven æœ¬åœ°ä»“åº“åœ¨ç³»ç»Ÿç”¨æˆ·ç›®å½•ä¸‹çš„ <code>.m2/repository</code>ï¼Œä¿®æ”¹ Maven çš„é…ç½®æ–‡ä»¶ <code>conf/settings.xml</code> æ¥ä¿®æ”¹ä»“åº“ä½ç½®</p>
<ul>
<li><p>ä¿®æ”¹æœ¬åœ°ä»“åº“ä½ç½®ï¼šæ‰¾åˆ° <localRepository> æ ‡ç­¾ï¼Œä¿®æ”¹é»˜è®¤å€¼</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- localRepository</span></span><br><span class="line"><span class="comment">| The path to the local repository maven will use to store artifacts.</span></span><br><span class="line"><span class="comment">| Default: $&#123;user.home&#125;/.m2/repository</span></span><br><span class="line"><span class="comment">&lt;localRepository&gt;/path/to/local/repo&lt;/localRepository&gt;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>E:\Workspace\Java\Project\.m2\repository<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šåœ¨ä»“åº“çš„åŒçº§ç›®å½•å³ <code>.m2</code> ä¹Ÿåº”è¯¥åŒ…å«ä¸€ä¸ª <code>settings.xml</code> é…ç½®æ–‡ä»¶ï¼Œå±€éƒ¨ç”¨æˆ·é…ç½®ä¼˜å…ˆä¸å…¨å±€é…ç½®</p>
<ul>
<li>å…¨å±€ setting å®šä¹‰äº† Maven çš„å…¬å…±é…ç½®</li>
<li>ç”¨æˆ· setting å®šä¹‰äº†å½“å‰ç”¨æˆ·çš„é…ç½®</li>
</ul>
</li>
<li><p>ä¿®æ”¹è¿œç¨‹ä»“åº“ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ° <code>&lt;mirrors&gt;</code> æ ‡ç­¾ï¼Œåœ¨è¿™ç»„æ ‡ç­¾ä¸‹æ·»åŠ å›½å†…é•œåƒ</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-aliyun<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>  <span class="comment">&lt;!--å¿…é¡»æ˜¯central--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹é»˜è®¤ JDKï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ° <code>&lt;profiles&gt;</code> æ ‡ç­¾ï¼Œæ·»åŠ é…ç½®</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>jdk-10<span class="tag">&lt;/<span class="name">id</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">activation</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">jdk</span>&gt;</span>10<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>10<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>10<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="é¡¹ç›®æ­å»º"><a href="#é¡¹ç›®æ­å»º" class="headerlink" title="é¡¹ç›®æ­å»º"></a>é¡¹ç›®æ­å»º</h2><h3 id="æ‰‹åŠ¨æ­å»º"><a href="#æ‰‹åŠ¨æ­å»º" class="headerlink" title="æ‰‹åŠ¨æ­å»º"></a>æ‰‹åŠ¨æ­å»º</h3><ol>
<li><p>åœ¨ E ç›˜ä¸‹åˆ›å»ºç›®å½• mvnproject è¿›å…¥è¯¥ç›®å½•ï¼Œä½œä¸ºæˆ‘ä»¬çš„æ“ä½œç›®å½•</p>
</li>
<li><p>åˆ›å»ºæˆ‘ä»¬çš„ Maven é¡¹ç›®ï¼Œåˆ›å»ºä¸€ä¸ªç›®å½• <code>project-java</code> ä½œä¸ºæˆ‘ä»¬çš„é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œå¹¶è¿›å…¥åˆ°è¯¥ç›®å½•</p>
</li>
<li><p>åˆ›å»º Java ä»£ç ï¼ˆæºä»£ç ï¼‰æ‰€åœ¨ç›®å½•ï¼Œå³åˆ›å»º <code>src/main/java</code></p>
</li>
<li><p>åˆ›å»ºé…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œå³åˆ›å»º <code>src/main/resources</code></p>
</li>
<li><p>åˆ›å»ºæµ‹è¯•æºä»£ç æ‰€åœ¨ç›®å½•ï¼Œå³åˆ›å»º <code>src/test/java</code></p>
</li>
<li><p>åˆ›å»ºæµ‹è¯•å­˜æ”¾é…ç½®æ–‡ä»¶å­˜æ”¾ç›®å½•ï¼Œå³ <code>src/test/resources</code></p>
</li>
<li><p>åœ¨ <code>src/main/java</code> ä¸­åˆ›å»ºä¸€ä¸ªåŒ…ï¼ˆæ³¨æ„åœ¨ Windos æ–‡ä»¶å¤¹ä¸‹å°±æ˜¯åˆ›å»ºç›®å½•ï¼‰<code>demo</code>ï¼Œåœ¨è¯¥ç›®å½•ä¸‹åˆ›å»º <code>Demo.java</code> æ–‡ä»¶ï¼Œä½œä¸ºæ¼”ç¤ºæ‰€éœ€ Java ç¨‹åºï¼Œå†…å®¹å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span>&#123;</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">say</span><span class="params">(String name)</span>&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;hello &quot;</span>+name);</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;hello &quot;</span>+name;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨ <code>src/test/java</code> ä¸­åˆ›å»ºä¸€ä¸ªæµ‹è¯•åŒ…ï¼ˆç›®å½•ï¼‰<code>demo</code>ï¼Œåœ¨è¯¥åŒ…ä¸‹åˆ›å»ºæµ‹è¯•ç¨‹åº <code>DemoTest.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"><span class="keyword">import</span> org.junit.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoTest</span>&#123;</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSay</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="type">Demo</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Demo</span>();</span><br><span class="line">		<span class="type">String</span> <span class="variable">ret</span> <span class="operator">=</span> d.say(<span class="string">&quot;maven&quot;</span>);</span><br><span class="line">		Assert.assertEquals(<span class="string">&quot;hello maven&quot;</span>,ret);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>åœ¨ <code>project-java/src</code> ä¸‹åˆ›å»º <code>pom.xml</code> æ–‡ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 	</span></span></span><br><span class="line"><span class="string"><span class="tag">                        http://maven.apache.org/maven-v4_0_0.xsd&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--æŒ‡å®špomçš„æ¨¡å‹ç‰ˆæœ¬--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--æ‰“åŒ…æ–¹å¼ï¼Œwebå·¥ç¨‹æ‰“åŒ…ä¸ºwarï¼Œjavaå·¥ç¨‹æ‰“åŒ…ä¸ºjar --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--ç»„ç»‡id--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--é¡¹ç›®id--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>project-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--ç‰ˆæœ¬å·:release,snapshot--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--è®¾ç½®å½“å‰å·¥ç¨‹çš„æ‰€æœ‰ä¾èµ–--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--å…·ä½“çš„ä¾èµ–--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ­å»ºå®Œæˆ Maven çš„é¡¹ç›®ç»“æ„ï¼Œé€šè¿‡ Maven æ¥æ„å»ºé¡¹ç›®ã€‚Maven çš„æ„å»ºå‘½ä»¤ä»¥ <code>mvn</code> å¼€å¤´ï¼Œåé¢æ·»åŠ åŠŸèƒ½å‚æ•°ï¼Œå¯ä»¥ä¸€æ¬¡æ€§æ‰§è¡Œå¤šä¸ªå‘½ä»¤ï¼Œç”¨ç©ºæ ¼åˆ†ç¦»</p>
<ul>
<li><code>mvn compile</code>ï¼šç¼–è¯‘</li>
<li><code>mvn clean</code>ï¼šæ¸…ç†</li>
<li><code>mvn test</code>ï¼šæµ‹è¯•</li>
<li><code>mvn package</code>ï¼šæ‰“åŒ…</li>
<li><code>mvn install</code>ï¼šå®‰è£…åˆ°æœ¬åœ°ä»“åº“</li>
</ul>
<p>æ³¨æ„ï¼šæ‰§è¡ŒæŸä¸€æ¡å‘½ä»¤ï¼Œåˆ™ä¼šæŠŠå‰é¢æ‰€æœ‰çš„éƒ½æ‰§è¡Œä¸€é</p>
</li>
</ol>
<hr>
<h3 id="IDEAæ­å»º"><a href="#IDEAæ­å»º" class="headerlink" title="IDEAæ­å»º"></a>IDEAæ­å»º</h3><h4 id="ä¸ç”¨åŸå‹"><a href="#ä¸ç”¨åŸå‹" class="headerlink" title="ä¸ç”¨åŸå‹"></a>ä¸ç”¨åŸå‹</h4><ol>
<li><p>åœ¨ IDEA ä¸­é…ç½® Mavenï¼Œé€‰æ‹© maven3.6.1 é˜²æ­¢ä¾èµ–é—®é¢˜<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/IDEAé…ç½®Maven.png" alt="IDEAé…ç½®Maven" style="zoom:67%;" /></p>
</li>
<li><p>åˆ›å»º Mavenï¼ŒNew Module â†’ Maven â†’ ä¸é€‰ä¸­ Create from archetype</p>
</li>
<li><p>å¡«å†™é¡¹ç›®çš„åæ ‡</p>
<ul>
<li>GroupIdï¼šdemo</li>
<li>ArtifactIdï¼šproject-java</li>
</ul>
</li>
<li><p>æŸ¥çœ‹å„ç›®å½•é¢œè‰²æ ‡è®°æ˜¯å¦æ­£ç¡®</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/IDEAåˆ›å»ºMavenç›®å½•ç»“æ„.png" alt=""></p>
</li>
<li><p>IDEA å³ä¾§ä¾§æ æœ‰ Maven Projectï¼Œæ‰“å¼€åæœ‰ Lifecycle ç”Ÿå‘½å‘¨æœŸ</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/IDEA-Mavenç”Ÿå‘½å‘¨æœŸ.png" alt=""></p>
</li>
<li><p>è‡ªå®šä¹‰ Maven å‘½ä»¤ï¼šRun â†’ Edit Configurations â†’ å·¦ä¸Šè§’ +  â†’ Maven</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/IDEAé…ç½®Mavenå‘½ä»¤.png" alt=""></p>
</li>
</ol>
<hr>
<h4 id="ä½¿ç”¨åŸå‹"><a href="#ä½¿ç”¨åŸå‹" class="headerlink" title="ä½¿ç”¨åŸå‹"></a>ä½¿ç”¨åŸå‹</h4><p>æ™®é€šå·¥ç¨‹ï¼š</p>
<ol>
<li><p>åˆ›å»º Maven é¡¹ç›®çš„æ—¶å€™é€‰æ‹©ä½¿ç”¨åŸå‹éª¨æ¶</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/IDEAåˆ›å»ºMaven-quickstart.png" alt=""></p>
</li>
<li><p>åˆ›å»ºå®Œæˆåå‘ç°é€šè¿‡è¿™ç§æ–¹å¼ç¼ºå°‘ä¸€äº›ç›®å½•ï¼Œéœ€è¦æ‰‹åŠ¨å»è¡¥å…¨ç›®å½•ï¼Œå¹¶ä¸”è¦å¯¹è¡¥å…¨çš„ç›®å½•è¿›è¡Œæ ‡è®°</p>
</li>
</ol>
<p>Web å·¥ç¨‹ï¼š</p>
<ol>
<li><p>é€‰æ‹© Web å¯¹åº”çš„åŸå‹éª¨æ¶ï¼ˆé€‰æ‹© Maven å¼€å¤´çš„æ˜¯ç®€åŒ–çš„ï¼‰</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/IDEAåˆ›å»ºMaven-webapp.png" alt=""></p>
</li>
<li><p>é€šè¿‡åŸå‹åˆ›å»º Web é¡¹ç›®å¾—åˆ°çš„ç›®å½•ç»“æ„æ˜¯ä¸å…¨çš„ï¼Œå› æ­¤éœ€è¦æˆ‘ä»¬è‡ªè¡Œè¡¥å…¨ï¼ŒåŒæ—¶è¦æ ‡è®°æ­£ç¡®</p>
</li>
<li><p>Web å·¥ç¨‹åˆ›å»ºä¹‹åéœ€è¦å¯åŠ¨è¿è¡Œï¼Œä½¿ç”¨ tomcat æ’ä»¶æ¥è¿è¡Œé¡¹ç›®ï¼Œåœ¨ <code>pom.xml</code> ä¸­æ·»åŠ æ’ä»¶çš„åæ ‡ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> 		</span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 </span></span></span><br><span class="line"><span class="string"><span class="tag">                             http://maven.apache.org/maven-v4_0_0.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>web01<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>web01<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!--æ„å»º--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--è®¾ç½®æ’ä»¶--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--å…·ä½“çš„æ’ä»¶é…ç½®--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--https://mvnrepository.com/  æœç´¢--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">port</span>&gt;</span>80<span class="tag">&lt;/<span class="name">port</span>&gt;</span> <span class="comment">&lt;!--80ç«¯å£é»˜è®¤ä¸æ˜¾ç¤º--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">path</span>&gt;</span>/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ’ä»¶é…ç½®ä»¥åï¼Œåœ¨ IDEA å³ä¾§ <code>maven-project</code> æ“ä½œé¢æ¿çœ‹åˆ°è¯¥æ’ä»¶ï¼Œå¹¶ä¸”å¯ä»¥åˆ©ç”¨è¯¥æ’ä»¶å¯åŠ¨é¡¹ç›®ï¼Œweb01 â†’ Plugins â†’ tomcat7 â†’ tomcat7:run</p>
</li>
</ol>
<hr>
<h2 id="ä¾èµ–ç®¡ç†"><a href="#ä¾èµ–ç®¡ç†" class="headerlink" title="ä¾èµ–ç®¡ç†"></a>ä¾èµ–ç®¡ç†</h2><h3 id="ä¾èµ–é…ç½®"><a href="#ä¾èµ–é…ç½®" class="headerlink" title="ä¾èµ–é…ç½®"></a>ä¾èµ–é…ç½®</h3><p>ä¾èµ–æ˜¯æŒ‡åœ¨å½“å‰é¡¹ç›®ä¸­è¿è¡Œæ‰€éœ€çš„ jarï¼Œä¾èµ–é…ç½®çš„æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--è®¾ç½®å½“å‰é¡¹ç›®æ‰€ä¾èµ–çš„æ‰€æœ‰jar--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--è®¾ç½®å…·ä½“çš„ä¾èµ–--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--ä¾èµ–æ‰€å±ç¾¤ç»„id--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--ä¾èµ–æ‰€å±é¡¹ç›®id--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--ä¾èµ–ç‰ˆæœ¬å·--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="ä¾èµ–ä¼ é€’"><a href="#ä¾èµ–ä¼ é€’" class="headerlink" title="ä¾èµ–ä¼ é€’"></a>ä¾èµ–ä¼ é€’</h3><p>ä¾èµ–å…·æœ‰ä¼ é€’æ€§ï¼Œåˆ†ä¸¤ç§ï¼š</p>
<ul>
<li><p>ç›´æ¥ä¾èµ–ï¼šåœ¨å½“å‰é¡¹ç›®ä¸­é€šè¿‡ä¾èµ–é…ç½®å»ºç«‹çš„ä¾èµ–å…³ç³»</p>
</li>
<li><p>é—´æ¥ä¾èµ–ï¼šè¢«ä¾èµ–çš„èµ„æºå¦‚æœä¾èµ–å…¶ä»–èµ„æºï¼Œåˆ™è¡¨æ˜å½“å‰é¡¹ç›®é—´æ¥ä¾èµ–å…¶ä»–èµ„æº</p>
<p>æ³¨æ„ï¼šç›´æ¥ä¾èµ–å’Œé—´æ¥ä¾èµ–å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªç›¸å¯¹å…³ç³»</p>
</li>
</ul>
<p>ä¾èµ–ä¼ é€’çš„å†²çªé—®é¢˜ï¼šåœ¨ä¾èµ–ä¼ é€’è¿‡ç¨‹ä¸­äº§ç”Ÿäº†å†²çªï¼Œæœ‰ä¸‰ç§ä¼˜å…ˆæ³•åˆ™</p>
<ul>
<li><p>è·¯å¾„ä¼˜å…ˆï¼šå½“ä¾èµ–ä¸­å‡ºç°ç›¸åŒèµ„æºæ—¶ï¼Œå±‚çº§è¶Šæ·±ï¼Œä¼˜å…ˆçº§è¶Šä½ï¼Œåä¹‹åˆ™è¶Šé«˜</p>
</li>
<li><p>å£°æ˜ä¼˜å…ˆï¼šå½“èµ„æºåœ¨ç›¸åŒå±‚çº§è¢«ä¾èµ–æ—¶ï¼Œé…ç½®é¡ºåºé å‰çš„è¦†ç›–é åçš„</p>
</li>
<li><p>ç‰¹æ®Šä¼˜å…ˆï¼šå½“åŒçº§é…ç½®äº†ç›¸åŒèµ„æºçš„ä¸åŒç‰ˆæœ¬æ—¶ï¼Œåé…ç½®çš„è¦†ç›–å…ˆé…ç½®çš„</p>
</li>
</ul>
<p><strong>å¯é€‰ä¾èµ–</strong>ï¼šå¯¹å¤–éšè—å½“å‰æ‰€ä¾èµ–çš„èµ„æºï¼Œä¸é€æ˜</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span> </span><br><span class="line">    <span class="comment">&lt;!--é»˜è®¤æ˜¯falseï¼Œtrueä»¥åå°±å˜å¾—ä¸é€æ˜--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>æ’é™¤ä¾èµ–</strong>ï¼šä¸»åŠ¨æ–­å¼€ä¾èµ–çš„èµ„æºï¼Œè¢«æ’é™¤çš„èµ„æºæ— éœ€æŒ‡å®šç‰ˆæœ¬</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span>        </span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span>            </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hamcrest<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  <span class="comment">&lt;!--æ’é™¤è¿™ä¸ªèµ„æº--&gt;</span>            </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hamcrest-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>        </span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="ä¾èµ–èŒƒå›´"><a href="#ä¾èµ–èŒƒå›´" class="headerlink" title="ä¾èµ–èŒƒå›´"></a>ä¾èµ–èŒƒå›´</h3><p>ä¾èµ–çš„ jar é»˜è®¤æƒ…å†µå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹å¯ç”¨ï¼Œå¯ä»¥é€šè¿‡ <code>scope</code> æ ‡ç­¾è®¾å®šå…¶ä½œç”¨èŒƒå›´ï¼Œæœ‰ä¸‰ç§ï¼š</p>
<ul>
<li><p>ä¸»ç¨‹åºèŒƒå›´æœ‰æ•ˆï¼ˆsrc/main ç›®å½•èŒƒå›´å†…ï¼‰</p>
</li>
<li><p>æµ‹è¯•ç¨‹åºèŒƒå›´å†…æœ‰æ•ˆï¼ˆsrc/test ç›®å½•èŒƒå›´å†…ï¼‰</p>
</li>
<li><p>æ˜¯å¦å‚ä¸æ‰“åŒ…ï¼ˆpackage æŒ‡ä»¤èŒƒå›´å†…ï¼‰</p>
</li>
</ul>
<p><code>scope</code> æ ‡ç­¾çš„å–å€¼æœ‰å››ç§ï¼š<code>compile,test,provided,runtime</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Mavenä¾èµ–èŒƒå›´.png" alt=""></p>
<p><strong>ä¾èµ–èŒƒå›´çš„ä¼ é€’æ€§ï¼š</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Mavenä¾èµ–èŒƒå›´çš„ä¼ é€’æ€§.png" alt=""></p>
<hr>
<h2 id="ç”Ÿå‘½å‘¨æœŸ"><a href="#ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸ"></a>ç”Ÿå‘½å‘¨æœŸ</h2><h3 id="ç›¸å…³äº‹ä»¶"><a href="#ç›¸å…³äº‹ä»¶" class="headerlink" title="ç›¸å…³äº‹ä»¶"></a>ç›¸å…³äº‹ä»¶</h3><p>Maven çš„æ„å»ºç”Ÿå‘½å‘¨æœŸæè¿°çš„æ˜¯ä¸€æ¬¡æ„å»ºè¿‡ç¨‹ç»å†äº†å¤šå°‘ä¸ªäº‹ä»¶</p>
<p>æœ€å¸¸ç”¨çš„ä¸€å¥—æµç¨‹ï¼šcompile â†’ test-compile â†’ test â†’ package â†’ install</p>
<ul>
<li><p>cleanï¼šæ¸…ç†å·¥ä½œ</p>
<ul>
<li>pre-cleanï¼šæ‰§è¡Œä¸€äº›åœ¨ clean ä¹‹å‰çš„å·¥ä½œ</li>
<li>cleanï¼šç§»é™¤ä¸Šä¸€æ¬¡æ„å»ºäº§ç”Ÿçš„æ‰€æœ‰æ–‡ä»¶</li>
<li>post-cleanï¼šæ‰§è¡Œä¸€äº›åœ¨ clean ä¹‹åç«‹åˆ»å®Œæˆçš„å·¥ä½œ</li>
</ul>
</li>
<li><p>defaultï¼šæ ¸å¿ƒå·¥ä½œï¼Œä¾‹å¦‚ç¼–è¯‘ï¼Œæµ‹è¯•ï¼Œæ‰“åŒ…ï¼Œéƒ¨ç½²ç­‰ï¼Œæ¯ä¸ªäº‹ä»¶åœ¨æ‰§è¡Œä¹‹å‰éƒ½ä¼š<strong>å°†ä¹‹å‰çš„æ‰€æœ‰äº‹ä»¶ä¾æ¬¡æ‰§è¡Œä¸€é</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Maven-defaultç”Ÿå‘½å‘¨æœŸ.png" alt=""></p>
</li>
<li><p>siteï¼šäº§ç”ŸæŠ¥å‘Šï¼Œå‘å¸ƒç«™ç‚¹ç­‰</p>
<ul>
<li>pre-siteï¼šæ‰§è¡Œä¸€äº›åœ¨ç”Ÿæˆç«™ç‚¹æ–‡æ¡£ä¹‹å‰çš„å·¥ä½œ</li>
<li>siteï¼šç”Ÿæˆé¡¹ç›®çš„ç«™ç‚¹æ–‡æ¡£</li>
<li>post-siteï¼šæ‰§è¡Œä¸€äº›åœ¨ç”Ÿæˆç«™ç‚¹æ–‡æ¡£ä¹‹åå®Œæˆçš„å·¥ä½œï¼Œå¹¶ä¸ºéƒ¨ç½²åšå‡†å¤‡</li>
<li>site-deployï¼šå°†ç”Ÿæˆçš„ç«™ç‚¹æ–‡æ¡£éƒ¨ç½²åˆ°ç‰¹å®šçš„æœåŠ¡å™¨ä¸Š</li>
</ul>
</li>
</ul>
<hr>
<h3 id="æ‰§è¡Œäº‹ä»¶"><a href="#æ‰§è¡Œäº‹ä»¶" class="headerlink" title="æ‰§è¡Œäº‹ä»¶"></a>æ‰§è¡Œäº‹ä»¶</h3><p>Maven çš„æ’ä»¶ç”¨æ¥æ‰§è¡Œç”Ÿå‘½å‘¨æœŸä¸­çš„ç›¸å…³äº‹ä»¶</p>
<ul>
<li><p>æ’ä»¶ä¸ç”Ÿå‘½å‘¨æœŸå†…çš„é˜¶æ®µç»‘å®šï¼Œåœ¨æ‰§è¡Œåˆ°å¯¹åº”ç”Ÿå‘½å‘¨æœŸæ—¶æ‰§è¡Œå¯¹åº”çš„æ’ä»¶</p>
</li>
<li><p>Maven é»˜è®¤åœ¨å„ä¸ªç”Ÿå‘½å‘¨æœŸä¸Šéƒ½ç»‘å®šäº†é¢„å…ˆè®¾å®šçš„æ’ä»¶æ¥å®Œæˆç›¸åº”åŠŸèƒ½</p>
</li>
<li><p>æ’ä»¶è¿˜å¯ä»¥å®Œæˆä¸€äº›è‡ªå®šä¹‰åŠŸèƒ½</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>        </span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>           </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>           </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-source-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>           </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>           </span><br><span class="line">            <span class="comment">&lt;!--æ‰§è¡Œ--&gt;</span>          </span><br><span class="line">            <span class="tag">&lt;<span class="name">excutions</span>&gt;</span>               </span><br><span class="line">                <span class="comment">&lt;!--å…·ä½“æ‰§è¡Œä½ç½®--&gt;</span>              </span><br><span class="line">                <span class="tag">&lt;<span class="name">excution</span>&gt;</span>                   </span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span>                      </span><br><span class="line">                        <span class="comment">&lt;!--å¯¹æºç è¿›è¡Œæ‰“åŒ…ï¼Œæ‰“åŒ…æ”¾åœ¨targetç›®å½•--&gt;</span>                    	</span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">goal</span>&gt;</span>                      </span><br><span class="line">                        <span class="comment">&lt;!--å¯¹æµ‹è¯•ä»£ç è¿›è¡Œæ‰“åŒ…--&gt;</span>                       </span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>test-jar<span class="tag">&lt;/<span class="name">goal</span>&gt;</span>                 </span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span>                  </span><br><span class="line">                    <span class="comment">&lt;!--æ‰§è¡Œçš„ç”Ÿå‘½å‘¨æœŸ--&gt;</span>                 </span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>generate-test-resources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span>                 </span><br><span class="line">                <span class="tag">&lt;/<span class="name">excution</span>&gt;</span>         </span><br><span class="line">            <span class="tag">&lt;/<span class="name">excutions</span>&gt;</span>       </span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="æ¨¡å—å¼€å‘"><a href="#æ¨¡å—å¼€å‘" class="headerlink" title="æ¨¡å—å¼€å‘"></a>æ¨¡å—å¼€å‘</h2><h3 id="æ‹†åˆ†"><a href="#æ‹†åˆ†" class="headerlink" title="æ‹†åˆ†"></a>æ‹†åˆ†</h3><p>å·¥ç¨‹æ¨¡å—ä¸æ¨¡å—åˆ’åˆ†ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Mavenæ¨¡å—åˆ’åˆ†.png" alt=""></p>
<ul>
<li><p>ssm_pojo æ‹†åˆ†</p>
<ul>
<li>æ–°å»ºæ¨¡å—ï¼Œæ‹·è´åŸå§‹é¡¹ç›®ä¸­å¯¹åº”çš„ç›¸å…³å†…å®¹åˆ° ssm_pojo æ¨¡å—ä¸­</li>
<li>å®ä½“ç±»ï¼ˆUserï¼‰</li>
<li>é…ç½®æ–‡ä»¶ï¼ˆæ— ï¼‰ </li>
</ul>
</li>
<li><p>ssm_dao æ‹†åˆ†</p>
<ul>
<li><p>æ–°å»ºæ¨¡å—</p>
</li>
<li><p>æ‹·è´åŸå§‹é¡¹ç›®ä¸­å¯¹åº”çš„ç›¸å…³å†…å®¹åˆ° ssm_dao æ¨¡å—ä¸­</p>
<ul>
<li><p>æ•°æ®å±‚æ¥å£ï¼ˆUserDaoï¼‰</p>
</li>
<li><p>é…ç½®æ–‡ä»¶ï¼šä¿ç•™ä¸æ•°æ®å±‚ç›¸å…³é…ç½®æ–‡ä»¶(3 ä¸ªï¼‰</p>
</li>
<li><p>æ³¨æ„ï¼šåˆ†é¡µæ’ä»¶åœ¨é…ç½®ä¸­ä¸ SqlSessionFactoryBean ç»‘å®šï¼Œéœ€è¦ä¿ç•™</p>
</li>
<li><p>pom.xmlï¼šå¼•å…¥æ•°æ®å±‚ç›¸å…³åæ ‡å³å¯ï¼Œåˆ é™¤ SpringMVC ç›¸å…³åæ ‡</p>
<ul>
<li>Spring</li>
<li>MyBatis</li>
<li>Spring æ•´åˆ MyBatis</li>
<li>MySQL</li>
<li>druid</li>
<li>pagehelper</li>
<li>ç›´æ¥ä¾èµ– ssm_pojoï¼ˆå¯¹ ssm_pojo æ¨¡å—æ‰§è¡Œ install æŒ‡ä»¤ï¼Œå°†å…¶å®‰è£…åˆ°æœ¬åœ°ä»“åº“ï¼‰</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>    <span class="comment">&lt;!--å¯¼å…¥èµ„æºæ–‡ä»¶pojo--&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>       </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>        </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ssm_pojo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>      </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--springç¯å¢ƒ--&gt;</span>   </span><br><span class="line">    <span class="comment">&lt;!--mybatisç¯å¢ƒ--&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--mysqlç¯å¢ƒ--&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--springæ•´åˆjdbc--&gt;</span>   </span><br><span class="line">    <span class="comment">&lt;!--springæ•´åˆmybatis--&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--druidè¿æ¥æ± --&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--åˆ†é¡µæ’ä»¶åæ ‡--&gt;</span>   </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>ssm_service æ‹†åˆ†</p>
<ul>
<li>æ–°å»ºæ¨¡å—</li>
<li><p>æ‹·è´åŸå§‹é¡¹ç›®ä¸­å¯¹åº”çš„ç›¸å…³å†…å®¹åˆ° ssm_service æ¨¡å—ä¸­</p>
<ul>
<li>ä¸šåŠ¡å±‚æ¥å£ä¸å®ç°ç±»ï¼ˆUserServiceã€UserServiceImplï¼‰</li>
<li>é…ç½®æ–‡ä»¶ï¼šä¿ç•™ä¸æ•°æ®å±‚ç›¸å…³é…ç½®æ–‡ä»¶(1 ä¸ªï¼‰</li>
<li><p>pom.xmlï¼šå¼•å…¥æ•°æ®å±‚ç›¸å…³åæ ‡å³å¯ï¼Œåˆ é™¤ SpringMVC ç›¸å…³åæ ‡</p>
<ul>
<li><p>spring</p>
</li>
<li><p>junit</p>
</li>
<li><p>spring æ•´åˆ junit</p>
</li>
<li><p>ç›´æ¥ä¾èµ– ssm_daoï¼ˆå¯¹ ssm_dao æ¨¡å—æ‰§è¡Œ install æŒ‡ä»¤ï¼Œå°†å…¶å®‰è£…åˆ°æœ¬åœ°ä»“åº“ï¼‰</p>
</li>
<li><p>é—´æ¥ä¾èµ– ssm_pojoï¼ˆç”± ssm_dao æ¨¡å—è´Ÿè´£ä¾èµ–å…³ç³»çš„å»ºç«‹ï¼‰</p>
</li>
</ul>
</li>
<li>ä¿®æ”¹ service æ¨¡å— Spring æ ¸å¿ƒé…ç½®æ–‡ä»¶åï¼Œæ·»åŠ æ¨¡å—åç§°ï¼Œæ ¼å¼ï¼šapplicationContext-service.xml</li>
<li>ä¿®æ”¹ dao æ¨¡å— Spring æ ¸å¿ƒé…ç½®æ–‡ä»¶åï¼Œæ·»åŠ æ¨¡å—åç§°ï¼Œæ ¼å¼ï¼šapplicationContext-dao.xml</li>
<li>ä¿®æ”¹å•å…ƒæµ‹è¯•å¼•å…¥çš„é…ç½®æ–‡ä»¶åç§°ï¼Œç”±å•ä¸ªæ–‡ä»¶ä¿®æ”¹ä¸ºå¤šä¸ªæ–‡ä»¶</li>
</ul>
</li>
</ul>
</li>
<li><p>ssm_control æ‹†åˆ†</p>
<ul>
<li><p>æ–°å»ºæ¨¡å—ï¼ˆä½¿ç”¨ webapp æ¨¡æ¿ï¼‰</p>
</li>
<li><p>æ‹·è´åŸå§‹é¡¹ç›®ä¸­å¯¹åº”çš„ç›¸å…³å†…å®¹åˆ° ssm_controller æ¨¡å—ä¸­</p>
<ul>
<li><p>ç°å±‚æ§åˆ¶å™¨ç±»ä¸ç›¸å…³è®¾ç½®ç±»ï¼ˆUserControllerã€å¼‚å¸¸ç›¸å…³â€¦â€¦ï¼‰</p>
</li>
<li><p>é…ç½®æ–‡ä»¶ï¼šä¿ç•™ä¸è¡¨ç°å±‚ç›¸å…³é…ç½®æ–‡ä»¶(1 ä¸ªï¼‰ã€æœåŠ¡å™¨ç›¸å…³é…ç½®æ–‡ä»¶ï¼ˆ1 ä¸ªï¼‰</p>
</li>
<li><p>pom.xmlï¼šå¼•å…¥æ•°æ®å±‚ç›¸å…³åæ ‡å³å¯ï¼Œåˆ é™¤ SpringMVC ç›¸å…³åæ ‡</p>
<ul>
<li><p>spring</p>
</li>
<li><p>springmvc</p>
</li>
<li><p>jackson</p>
</li>
<li><p>servlet</p>
</li>
<li><p>tomcat æœåŠ¡å™¨æ’ä»¶</p>
</li>
<li><p>ç›´æ¥ä¾èµ– ssm_serviceï¼ˆå¯¹ ssm_service æ¨¡å—æ‰§è¡Œ install æŒ‡ä»¤ï¼Œå°†å…¶å®‰è£…åˆ°æœ¬åœ°ä»“åº“ï¼‰</p>
</li>
<li><p>é—´æ¥ä¾èµ– ssm_daoã€ssm_pojo</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>   </span><br><span class="line">    <span class="comment">&lt;!--å¯¼å…¥èµ„æºæ–‡ä»¶service--&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>      </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>         </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ssm_service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>     </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--springmvcç¯å¢ƒ--&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--jacksonç›¸å…³åæ ‡3ä¸ª--&gt;</span> </span><br><span class="line">    <span class="comment">&lt;!--servletç¯å¢ƒ--&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span>   </span><br><span class="line">    <span class="comment">&lt;!--è®¾ç½®æ’ä»¶--&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>    </span><br><span class="line">        <span class="comment">&lt;!--å…·ä½“çš„æ’ä»¶é…ç½®--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

- ä¿®æ”¹ web.xml é…ç½®æ–‡ä»¶ä¸­åŠ è½½ Spring ç¯å¢ƒçš„é…ç½®æ–‡ä»¶åç§°ï¼Œä½¿ç”¨*é€šé…ï¼ŒåŠ è½½æ‰€æœ‰ applicationContext- å¼€å§‹çš„é…ç½®æ–‡ä»¶ï¼š

  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--åŠ è½½é…ç½®æ–‡ä»¶--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath*:applicationContext-*.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure>

- spring-mvc

  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;controller&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</code></pre><hr>
<h3 id="èšåˆ"><a href="#èšåˆ" class="headerlink" title="èšåˆ"></a>èšåˆ</h3><p>ä½œç”¨ï¼šèšåˆç”¨äºå¿«é€Ÿæ„å»º Maven å·¥ç¨‹ï¼Œä¸€æ¬¡æ€§æ„å»ºå¤šä¸ªé¡¹ç›®/æ¨¡å—</p>
<p>åˆ¶ä½œæ–¹å¼ï¼š</p>
<ul>
<li><p>åˆ›å»ºä¸€ä¸ªç©ºæ¨¡å—ï¼Œæ‰“åŒ…ç±»å‹å®šä¹‰ä¸º pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å®šä¹‰å½“å‰æ¨¡å—è¿›è¡Œæ„å»ºæ“ä½œæ—¶å…³è”çš„å…¶ä»–æ¨¡å—åç§°</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;............&quot;</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ssm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--å®šä¹‰è¯¥å·¥ç¨‹ç”¨äºæ„å»ºç®¡ç†--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span>   </span><br><span class="line">    <span class="comment">&lt;!--ç®¡ç†çš„å·¥ç¨‹åˆ—è¡¨--&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span>       </span><br><span class="line">        <span class="comment">&lt;!--å…·ä½“çš„å·¥ç¨‹åç§°--&gt;</span>     </span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>../ssm_pojo<span class="tag">&lt;/<span class="name">module</span>&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>../ssm_dao<span class="tag">&lt;/<span class="name">module</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>../ssm_service<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>../ssm_controller<span class="tag">&lt;/<span class="name">module</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ³¨æ„äº‹é¡¹ï¼šå‚ä¸èšåˆæ“ä½œçš„æ¨¡å—æœ€ç»ˆæ‰§è¡Œé¡ºåºä¸æ¨¡å—é—´çš„ä¾èµ–å…³ç³»æœ‰å…³ï¼Œä¸é…ç½®é¡ºåºæ— å…³</p>
<hr>
<h3 id="ç»§æ‰¿"><a href="#ç»§æ‰¿" class="headerlink" title="ç»§æ‰¿"></a>ç»§æ‰¿</h3><p>Maven ä¸­çš„ç»§æ‰¿ä¸ Java ä¸­çš„ç»§æ‰¿ç›¸ä¼¼ï¼Œå¯ä»¥å®ç°åœ¨å­å·¥ç¨‹ä¸­æ²¿ç”¨çˆ¶å·¥ç¨‹ä¸­çš„é…ç½®</p>
<p>dependencyManagement é‡Œåªæ˜¯å£°æ˜ä¾èµ–ï¼Œå¹¶ä¸å®ç°å¼•å…¥ï¼Œæ‰€ä»¥å­å·¥ç¨‹éœ€è¦æ˜¾å¼å£°æ˜éœ€è¦ç”¨çš„ä¾èµ–</p>
<ul>
<li>å¦‚æœå­å·¥ç¨‹ä¸­æœªå£°æ˜ä¾èµ–ï¼Œåˆ™ä¸ä¼šä»çˆ¶é¡¹ç›®ç»§æ‰¿ä¸‹æ¥</li>
<li>åœ¨å­å·¥ç¨‹ä¸­å£°æ˜è¯¥ä¾èµ–é¡¹ï¼Œå¹¶ä¸”ä¸æŒ‡å®šå…·ä½“ç‰ˆæœ¬ï¼Œæ‰ä¼šä»çˆ¶é¡¹ç›®ä¸­ç»§æ‰¿è¯¥é¡¹ï¼Œversion å’Œ scope éƒ½ç»§æ‰¿å–è‡ªçˆ¶å·¥ç¨‹ pom æ–‡ä»¶</li>
<li>å¦‚æœå­å·¥ç¨‹ä¸­æŒ‡å®šäº†ç‰ˆæœ¬å·ï¼Œé‚£ä¹ˆä½¿ç”¨å­å·¥ç¨‹ä¸­æŒ‡å®šçš„ jar ç‰ˆæœ¬</li>
</ul>
<p>åˆ¶ä½œæ–¹å¼ï¼š</p>
<ul>
<li><p>åœ¨å­å·¥ç¨‹ä¸­å£°æ˜å…¶çˆ¶å·¥ç¨‹åæ ‡ä¸å¯¹åº”çš„ä½ç½®</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--å®šä¹‰è¯¥å·¥ç¨‹çš„çˆ¶å·¥ç¨‹--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.seazean<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ssm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--å¡«å†™çˆ¶å·¥ç¨‹çš„pomæ–‡ä»¶--&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../ssm/pom.xml<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç»§æ‰¿ä¾èµ–çš„å®šä¹‰ï¼šåœ¨çˆ¶å·¥ç¨‹ä¸­å®šä¹‰ä¾èµ–ç®¡ç†</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--å£°æ˜æ­¤å¤„è¿›è¡Œä¾èµ–ç®¡ç†ï¼Œç‰ˆæœ¬é”å®š--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span>   </span><br><span class="line">    <span class="comment">&lt;!--å…·ä½“çš„ä¾èµ–--&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>      </span><br><span class="line">        <span class="comment">&lt;!--springç¯å¢ƒ--&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>       </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>   </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>      </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>     </span><br><span class="line">        <span class="comment">&lt;!--ç­‰ç­‰æ‰€æœ‰--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç»§æ‰¿ä¾èµ–çš„ä½¿ç”¨ï¼šåœ¨å­å·¥ç¨‹ä¸­å®šä¹‰ä¾èµ–å…³ç³»ï¼Œ<strong>æ— éœ€å£°æ˜ä¾èµ–ç‰ˆæœ¬</strong>ï¼Œç‰ˆæœ¬å‚ç…§çˆ¶å·¥ç¨‹ä¸­ä¾èµ–çš„ç‰ˆæœ¬</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span> </span><br><span class="line">    <span class="comment">&lt;!--springç¯å¢ƒ--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç»§æ‰¿çš„èµ„æºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">groupIdï¼šé¡¹ç›®ç»„IDï¼Œé¡¹ç›®åæ ‡çš„æ ¸å¿ƒå…ƒç´ </span><br><span class="line">versionï¼šé¡¹ç›®ç‰ˆæœ¬ï¼Œé¡¹ç›®åæ ‡çš„æ ¸å¿ƒå› ç´ </span><br><span class="line">descriptionï¼šé¡¹ç›®çš„æè¿°ä¿¡æ¯</span><br><span class="line">organizationï¼šé¡¹ç›®çš„ç»„ç»‡ä¿¡æ¯</span><br><span class="line">inceptionYearï¼šé¡¹ç›®çš„åˆ›å§‹å¹´ä»½</span><br><span class="line">urlï¼šé¡¹ç›®çš„URLåœ°å€</span><br><span class="line">developersï¼šé¡¹ç›®çš„å¼€å‘è€…ä¿¡æ¯</span><br><span class="line">contributorsï¼šé¡¹ç›®çš„è´¡çŒ®è€…ä¿¡æ¯</span><br><span class="line">distributionManagementï¼šé¡¹ç›®çš„éƒ¨ç½²é…ç½®</span><br><span class="line">issueManagementï¼šé¡¹ç›®çš„ç¼ºé™·è·Ÿè¸ªç³»ç»Ÿä¿¡æ¯</span><br><span class="line">ciManagementï¼šé¡¹ç›®çš„æŒç»­é›†æˆç³»ç»Ÿä¿¡æ¯</span><br><span class="line">scmï¼šé¡¹ç›®çš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¿¡æ¯</span><br><span class="line">malilingListsï¼šé¡¹ç›®çš„é‚®ä»¶åˆ—è¡¨ä¿¡æ¯</span><br><span class="line">propertiesï¼šè‡ªå®šä¹‰çš„Mavenå±æ€§</span><br><span class="line">dependenciesï¼šé¡¹ç›®çš„ä¾èµ–é…ç½®</span><br><span class="line">dependencyManagementï¼šé¡¹ç›®çš„ä¾èµ–ç®¡ç†é…ç½®</span><br><span class="line">repositoriesï¼šé¡¹ç›®çš„ä»“åº“é…ç½®</span><br><span class="line">buildï¼šåŒ…æ‹¬é¡¹ç›®çš„æºç ç›®å½•é…ç½®ã€è¾“å‡ºç›®å½•é…ç½®ã€æ’ä»¶é…ç½®ã€æ’ä»¶ç®¡ç†é…ç½®ç­‰</span><br><span class="line">reportingï¼šåŒ…æ‹¬é¡¹ç›®çš„æŠ¥å‘Šè¾“å‡ºç›®å½•é…ç½®ã€æŠ¥å‘Šæ’ä»¶é…ç½®ç­‰</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç»§æ‰¿ä¸èšåˆï¼š</p>
<p>ä½œç”¨ï¼š</p>
<ul>
<li><p>èšåˆç”¨äºå¿«é€Ÿæ„å»ºé¡¹ç›®</p>
</li>
<li><p>ç»§æ‰¿ç”¨äºå¿«é€Ÿé…ç½®</p>
</li>
</ul>
<p>ç›¸åŒç‚¹ï¼š</p>
<ul>
<li><p>èšåˆä¸ç»§æ‰¿çš„ pom.xml æ–‡ä»¶æ‰“åŒ…æ–¹å¼å‡ä¸º pomï¼Œå¯ä»¥å°†ä¸¤ç§å…³ç³»åˆ¶ä½œåˆ°åŒä¸€ä¸ª pom æ–‡ä»¶ä¸­</p>
</li>
<li><p>èšåˆä¸ç»§æ‰¿å‡å±äºè®¾è®¡å‹æ¨¡å—ï¼Œå¹¶æ— å®é™…çš„æ¨¡å—å†…å®¹</p>
</li>
</ul>
<p>ä¸åŒç‚¹ï¼š</p>
<ul>
<li><p>èšåˆæ˜¯åœ¨å½“å‰æ¨¡å—ä¸­é…ç½®å…³ç³»ï¼Œèšåˆå¯ä»¥æ„ŸçŸ¥åˆ°å‚ä¸èšåˆçš„æ¨¡å—æœ‰å“ªäº›</p>
</li>
<li><p>ç»§æ‰¿æ˜¯åœ¨å­æ¨¡å—ä¸­é…ç½®å…³ç³»ï¼Œçˆ¶æ¨¡å—æ— æ³•æ„ŸçŸ¥å“ªäº›å­æ¨¡å—ç»§æ‰¿äº†è‡ªå·±</p>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h3><ul>
<li><p>ç‰ˆæœ¬ç»Ÿä¸€çš„é‡è¦æ€§ï¼š </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Mavenç‰ˆæœ¬ç»Ÿä¸€çš„é‡è¦æ€§.png" alt=""></p>
</li>
<li><p>å±æ€§ç±»åˆ«ï¼š</p>
<ol>
<li>è‡ªå®šä¹‰å±æ€§  </li>
<li>å†…ç½®å±æ€§</li>
<li>setting å±æ€§</li>
<li>Java ç³»ç»Ÿå±æ€§</li>
<li>ç¯å¢ƒå˜é‡å±æ€§</li>
</ol>
</li>
<li><p>è‡ªå®šä¹‰å±æ€§ï¼š</p>
<p>ä½œç”¨ï¼šç­‰åŒäºå®šä¹‰å˜é‡ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç»´æŠ¤</p>
<p>å®šä¹‰æ ¼å¼ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--å®šä¹‰è‡ªå®šä¹‰å±æ€§ï¼Œæ”¾åœ¨dependencyManagementä¸Šæ–¹--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">spring.version</span>&gt;</span>5.1.9.RELEASE<span class="tag">&lt;/<span class="name">spring.version</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>èšåˆä¸ç»§æ‰¿çš„ pom.xml æ–‡ä»¶æ‰“åŒ…æ–¹å¼å‡ä¸º pomï¼Œå¯ä»¥å°†ä¸¤ç§å…³ç³»åˆ¶ä½œåˆ°åŒä¸€ä¸ª pom æ–‡ä»¶ä¸­</p>
</li>
<li><p>èšåˆä¸ç»§æ‰¿å‡å±äºè®¾è®¡å‹æ¨¡å—ï¼Œå¹¶æ— å®é™…çš„æ¨¡å—å†…å®¹</p>
</li>
</ul>
<p>è°ƒç”¨æ ¼å¼ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å†…ç½®å±æ€§ï¼š</p>
<p>ä½œç”¨ï¼šä½¿ç”¨ Maven å†…ç½®å±æ€§ï¼Œå¿«é€Ÿé…ç½®</p>
<p>è°ƒç”¨æ ¼å¼ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;project.basedir&#125; or $&#123;project.basedir&#125;  <span class="comment">&lt;!--../ssmæ ¹ç›®å½•--&gt;</span>$&#123;version&#125; or $&#123;project.version&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>vresion æ˜¯ 1.0-SNAPSHOT</li>
</ul>
</li>
</ul>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ssm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>setting å±æ€§</p>
<ul>
<li>ä½¿ç”¨ Maven é…ç½®æ–‡ä»¶ setting.xml ä¸­çš„æ ‡ç­¾å±æ€§ï¼Œç”¨äºåŠ¨æ€é…ç½®</li>
</ul>
<p>è°ƒç”¨æ ¼å¼ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;settings.localRepository&#125; </span><br></pre></td></tr></table></figure>
</li>
<li><p>Java ç³»ç»Ÿå±æ€§ï¼š</p>
<p>ä½œç”¨ï¼šè¯»å– Java ç³»ç»Ÿå±æ€§</p>
<p>è°ƒç”¨æ ¼å¼ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;user.home&#125;</span><br></pre></td></tr></table></figure>
<p>ç³»ç»Ÿå±æ€§æŸ¥è¯¢æ–¹å¼ cmd å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn <span class="built_in">help</span>:system </span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¯å¢ƒå˜é‡å±æ€§</p>
<p>ä½œç”¨ï¼šä½¿ç”¨ Maven é…ç½®æ–‡ä»¶ setting.xml ä¸­çš„æ ‡ç­¾å±æ€§ï¼Œç”¨äºåŠ¨æ€é…ç½®</p>
<p>è°ƒç”¨æ ¼å¼ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;env.JAVA_HOME&#125; </span><br></pre></td></tr></table></figure>
<p>ç¯å¢ƒå˜é‡å±æ€§æŸ¥è¯¢æ–¹å¼ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn <span class="built_in">help</span>:system </span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="å·¥ç¨‹ç‰ˆæœ¬"><a href="#å·¥ç¨‹ç‰ˆæœ¬" class="headerlink" title="å·¥ç¨‹ç‰ˆæœ¬"></a>å·¥ç¨‹ç‰ˆæœ¬</h3><p>SNAPSHOTï¼ˆå¿«ç…§ç‰ˆæœ¬ï¼‰</p>
<ul>
<li><p>é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸ºæ–¹ä¾¿å›¢é˜Ÿæˆå‘˜åˆä½œï¼Œè§£å†³æ¨¡å—é—´ç›¸äº’ä¾èµ–å’Œæ—¶æ—¶æ›´æ–°çš„é—®é¢˜ï¼Œå¼€å‘è€…å¯¹æ¯ä¸ªæ¨¡å—è¿›è¡Œæ„å»ºçš„æ—¶å€™ï¼Œè¾“å‡ºçš„ä¸´æ—¶æ€§ç‰ˆæœ¬å«å¿«ç…§ç‰ˆæœ¬ï¼ˆæµ‹è¯•é˜¶æ®µç‰ˆæœ¬ï¼‰</p>
</li>
<li><p>å¿«ç…§ç‰ˆæœ¬ä¼šéšç€å¼€å‘çš„è¿›å±•ä¸æ–­æ›´æ–°</p>
</li>
</ul>
<p>RELEASEï¼ˆå‘å¸ƒç‰ˆæœ¬ï¼‰</p>
<ul>
<li>é¡¹ç›®å¼€å‘åˆ°è¿›å…¥é˜¶æ®µé‡Œç¨‹ç¢‘åï¼Œå‘å›¢é˜Ÿå¤–éƒ¨å‘å¸ƒè¾ƒä¸ºç¨³å®šçš„ç‰ˆæœ¬ï¼Œè¿™ç§ç‰ˆæœ¬æ‰€å¯¹åº”çš„æ„ä»¶æ–‡ä»¶æ˜¯ç¨³å®šçš„ï¼Œå³ä¾¿è¿›è¡ŒåŠŸèƒ½çš„åç»­å¼€å‘ï¼Œä¹Ÿä¸ä¼šæ”¹å˜å½“å‰å‘å¸ƒç‰ˆæœ¬å†…å®¹ï¼Œè¿™ç§ç‰ˆæœ¬ç§°ä¸ºå‘å¸ƒç‰ˆæœ¬</li>
</ul>
<p>çº¦å®šè§„èŒƒï¼š</p>
<ul>
<li><p>&lt;ä¸»ç‰ˆæœ¬&gt;.&lt;æ¬¡ç‰ˆæœ¬&gt;.&lt;å¢é‡ç‰ˆæœ¬&gt;.&lt;é‡Œç¨‹ç¢‘ç‰ˆæœ¬&gt;</p>
</li>
<li><p>ä¸»ç‰ˆæœ¬ï¼šè¡¨ç¤ºé¡¹ç›®é‡å¤§æ¶æ„çš„å˜æ›´ï¼Œå¦‚ï¼šSpring5 ç›¸è¾ƒäº Spring4 çš„è¿­ä»£</p>
</li>
<li><p>æ¬¡ç‰ˆæœ¬ï¼šè¡¨ç¤ºæœ‰è¾ƒå¤§çš„åŠŸèƒ½å¢åŠ å’Œå˜åŒ–ï¼Œæˆ–è€…å…¨é¢ç³»ç»Ÿåœ°ä¿®å¤æ¼æ´</p>
</li>
<li><p>å¢é‡ç‰ˆæœ¬ï¼šè¡¨ç¤ºæœ‰é‡å¤§æ¼æ´çš„ä¿®å¤</p>
</li>
<li><p>é‡Œç¨‹ç¢‘ç‰ˆæœ¬ï¼šè¡¨æ˜ä¸€ä¸ªç‰ˆæœ¬çš„é‡Œç¨‹ç¢‘ï¼ˆç‰ˆæœ¬å†…éƒ¨ï¼‰ã€‚è¿™æ ·çš„ç‰ˆæœ¬åŒä¸‹ä¸€ä¸ªæ­£å¼ç‰ˆæœ¬ç›¸æ¯”ï¼Œç›¸å¯¹æ¥è¯´ä¸æ˜¯å¾ˆç¨³å®šï¼Œæœ‰å¾…æ›´å¤šçš„æµ‹è¯•</p>
</li>
</ul>
<hr>
<h3 id="èµ„æºé…ç½®"><a href="#èµ„æºé…ç½®" class="headerlink" title="èµ„æºé…ç½®"></a>èµ„æºé…ç½®</h3><p>ä½œç”¨ï¼šåœ¨ä»»æ„é…ç½®æ–‡ä»¶ä¸­åŠ è½½ pom æ–‡ä»¶ä¸­å®šä¹‰çš„å±æ€§</p>
<ul>
<li><p>çˆ¶æ–‡ä»¶ pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">jdbc.url</span>&gt;</span>jdbc:mysql://192.168.0.137:3306/ssm_db?useSSL=false<span class="tag">&lt;/<span class="name">jdbc.url</span>&gt;</span><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>å¼€å¯é…ç½®æ–‡ä»¶åŠ è½½ pom å±æ€§ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--é…ç½®èµ„æºæ–‡ä»¶å¯¹åº”çš„ä¿¡æ¯--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span>   </span><br><span class="line">        <span class="comment">&lt;!--è®¾å®šé…ç½®æ–‡ä»¶å¯¹åº”çš„ä½ç½®ç›®å½•ï¼Œæ”¯æŒä½¿ç”¨å±æ€§åŠ¨æ€è®¾å®šè·¯å¾„--&gt;</span>     </span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.basedir&#125;/src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!--å¼€å¯å¯¹é…ç½®æ–‡ä»¶çš„èµ„æºåŠ è½½è¿‡æ»¤--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>properties æ–‡ä»¶ä¸­è°ƒç”¨æ ¼å¼ï¼š</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jdbc.driver</span>=<span class="string">com.mysql.jdbc.Driverjdbc.url=$&#123;jdbc.url&#125;</span></span><br><span class="line"><span class="attr">jdbc.username</span>=<span class="string">rootjdbc.password=123456</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="å¤šç¯å¢ƒé…ç½®"><a href="#å¤šç¯å¢ƒé…ç½®" class="headerlink" title="å¤šç¯å¢ƒé…ç½®"></a>å¤šç¯å¢ƒé…ç½®</h3><ul>
<li><p>ç¯å¢ƒé…ç½®</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--åˆ›å»ºå¤šç¯å¢ƒ--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span>   </span><br><span class="line">    <span class="comment">&lt;!--å®šä¹‰å…·ä½“çš„ç¯å¢ƒï¼šç”Ÿäº§ç¯å¢ƒ--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span>     </span><br><span class="line">        <span class="comment">&lt;!--å®šä¹‰ç¯å¢ƒå¯¹åº”çš„å”¯ä¸€åç§°--&gt;</span>        </span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>pro_env<span class="tag">&lt;/<span class="name">id</span>&gt;</span>    </span><br><span class="line">        <span class="comment">&lt;!--å®šä¹‰ç¯å¢ƒä¸­ä¸“ç”¨çš„å±æ€§å€¼--&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span>           </span><br><span class="line">            <span class="tag">&lt;<span class="name">jdbc.url</span>&gt;</span>jdbc:mysql://127.1.1.1:3306/ssm_db<span class="tag">&lt;/<span class="name">jdbc.url</span>&gt;</span>     </span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>     </span><br><span class="line">        <span class="comment">&lt;!--è®¾ç½®é»˜è®¤å¯åŠ¨--&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span>      </span><br><span class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span>   </span><br><span class="line">    <span class="comment">&lt;!--å®šä¹‰å…·ä½“çš„ç¯å¢ƒï¼šå¼€å‘ç¯å¢ƒ--&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span>     </span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>dev_env<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        â€¦â€¦  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>åŠ è½½æŒ‡å®šç¯å¢ƒ</p>
<p>ä½œç”¨ï¼šåŠ è½½æŒ‡å®šç¯å¢ƒé…ç½®</p>
<p>è°ƒç”¨æ ¼å¼ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn æŒ‡ä»¤ â€“P ç¯å¢ƒå®šä¹‰<span class="built_in">id</span></span><br></pre></td></tr></table></figure>
<p>èŒƒä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn install â€“P pro_env</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="è·³è¿‡æµ‹è¯•"><a href="#è·³è¿‡æµ‹è¯•" class="headerlink" title="è·³è¿‡æµ‹è¯•"></a>è·³è¿‡æµ‹è¯•</h2><p>å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn æŒ‡ä»¤ â€“D skipTests</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„äº‹é¡¹ï¼šæ‰§è¡Œçš„æŒ‡ä»¤ç”Ÿå‘½å‘¨æœŸå¿…é¡»åŒ…å«æµ‹è¯•ç¯èŠ‚</p>
<p>IEDA ç•Œé¢ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/IDEAä½¿ç”¨ç•Œé¢æ“ä½œè·³è¿‡æµ‹è¯•.png" alt=""></p>
<p>é…ç½®è·³è¿‡ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--&lt;groupId&gt;org.apache.maven&lt;/groupId&gt;--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.22.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>     </span><br><span class="line">        <span class="tag">&lt;<span class="name">skipTests</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skipTests</span>&gt;</span><span class="comment">&lt;!--è®¾ç½®è·³è¿‡æµ‹è¯•--&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">includes</span>&gt;</span> <span class="comment">&lt;!--åŒ…å«æŒ‡å®šçš„æµ‹è¯•ç”¨ä¾‹--&gt;</span>      </span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/User*Test.java<span class="tag">&lt;/<span class="name">include</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;/<span class="name">includes</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">excludes</span>&gt;</span><span class="comment">&lt;!--æ’é™¤æŒ‡å®šçš„æµ‹è¯•ç”¨ä¾‹--&gt;</span>      </span><br><span class="line">            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/User*TestCase.java<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="ç§æœ"><a href="#ç§æœ" class="headerlink" title="ç§æœ"></a>ç§æœ</h2><h3 id="Nexus"><a href="#Nexus" class="headerlink" title="Nexus"></a>Nexus</h3><p>Nexus æ˜¯ Sonatype å…¬å¸çš„ä¸€æ¬¾ Maven ç§æœäº§å“</p>
<p>ä¸‹è½½åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://help.sonatype.com/repomanager3/download">https://help.sonatype.com/repomanager3/download</a> </p>
<p>å¯åŠ¨æœåŠ¡å™¨ï¼ˆå‘½ä»¤è¡Œå¯åŠ¨ï¼‰ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nexus.exe /run nexus</span><br></pre></td></tr></table></figure>
<p>è®¿é—®æœåŠ¡å™¨ï¼ˆé»˜è®¤ç«¯å£ï¼š8081ï¼‰ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8081</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹åŸºç¡€é…ç½®ä¿¡æ¯</p>
<ul>
<li>å®‰è£…è·¯å¾„ä¸‹ etc ç›®å½•ä¸­ nexus-default.properties æ–‡ä»¶ä¿å­˜æœ‰ nexus åŸºç¡€é…ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚é»˜è®¤è®¿é—®ç«¯å£</li>
</ul>
<p>ä¿®æ”¹æœåŠ¡å™¨è¿è¡Œé…ç½®ä¿¡æ¯</p>
<ul>
<li>å®‰è£…è·¯å¾„ä¸‹ bin ç›®å½•ä¸­ nexus.vmoptions æ–‡ä»¶ä¿å­˜æœ‰ nexus æœåŠ¡å™¨å¯åŠ¨çš„é…ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚é»˜è®¤å ç”¨å†…å­˜ç©ºé—´</li>
</ul>
<hr>
<h3 id="èµ„æºæ“ä½œ"><a href="#èµ„æºæ“ä½œ" class="headerlink" title="èµ„æºæ“ä½œ"></a>èµ„æºæ“ä½œ</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Mavenç§æœèµ„æºè·å–.png" alt=""></p>
<p>ä»“åº“åˆ†ç±»ï¼š</p>
<ul>
<li><p>å®¿ä¸»ä»“åº“ hosted </p>
<ul>
<li>ä¿å­˜æ— æ³•ä»ä¸­å¤®ä»“åº“è·å–çš„èµ„æº<ul>
<li>è‡ªä¸»ç ”å‘</li>
<li>ç¬¬ä¸‰æ–¹éå¼€æºé¡¹ç›®</li>
</ul>
</li>
</ul>
</li>
<li><p>ä»£ç†ä»“åº“ proxy </p>
<ul>
<li>ä»£ç†è¿œç¨‹ä»“åº“ï¼Œé€šè¿‡ nexus è®¿é—®å…¶ä»–å…¬å…±ä»“åº“ï¼Œä¾‹å¦‚ä¸­å¤®ä»“åº“</li>
</ul>
</li>
<li><p>ä»“åº“ç»„ group </p>
<ul>
<li>å°†è‹¥å¹²ä¸ªä»“åº“ç»„æˆä¸€ä¸ªç¾¤ç»„ï¼Œç®€åŒ–é…ç½®</li>
<li>ä»“åº“ç»„ä¸èƒ½ä¿å­˜èµ„æºï¼Œå±äºè®¾è®¡å‹ä»“åº“</li>
</ul>
</li>
</ul>
<p>èµ„æºä¸Šä¼ ï¼Œä¸Šä¼ èµ„æºæ—¶æä¾›å¯¹åº”çš„ä¿¡æ¯</p>
<ul>
<li><p>ä¿å­˜çš„ä½ç½®ï¼ˆå®¿ä¸»ä»“åº“ï¼‰</p>
</li>
<li><p>èµ„æºæ–‡ä»¶</p>
</li>
<li><p>å¯¹åº”åæ ‡</p>
</li>
</ul>
<hr>
<h3 id="IDEAæ“ä½œ"><a href="#IDEAæ“ä½œ" class="headerlink" title="IDEAæ“ä½œ"></a>IDEAæ“ä½œ</h3><h4 id="ä¸Šä¼ ä¸‹è½½"><a href="#ä¸Šä¼ ä¸‹è½½" class="headerlink" title="ä¸Šä¼ ä¸‹è½½"></a>ä¸Šä¼ ä¸‹è½½</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/IDEAç¯å¢ƒä¸­èµ„æºä¸Šä¼ ä¸ä¸‹è½½.png" alt=""></p>
<hr>
<h4 id="è®¿é—®ç§æœ"><a href="#è®¿é—®ç§æœ" class="headerlink" title="è®¿é—®ç§æœ"></a>è®¿é—®ç§æœ</h4><h5 id="æœ¬åœ°è®¿é—®"><a href="#æœ¬åœ°è®¿é—®" class="headerlink" title="æœ¬åœ°è®¿é—®"></a>æœ¬åœ°è®¿é—®</h5><p>é…ç½®æœ¬åœ°ä»“åº“è®¿é—®ç§æœçš„æƒé™ï¼ˆsetting.xmlï¼‰</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servers</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">server</span>&gt;</span>     </span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>heima-release<span class="tag">&lt;/<span class="name">id</span>&gt;</span>      </span><br><span class="line">        <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">password</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;/<span class="name">server</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">server</span>&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>heima-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">password</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>é…ç½®æœ¬åœ°ä»“åº“èµ„æºæ¥æºï¼ˆsetting.xmlï¼‰</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-heima<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://localhost:8081/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h5 id="å·¥ç¨‹è®¿é—®"><a href="#å·¥ç¨‹è®¿é—®" class="headerlink" title="å·¥ç¨‹è®¿é—®"></a>å·¥ç¨‹è®¿é—®</h5><p>é…ç½®å½“å‰é¡¹ç›®è®¿é—®ç§æœä¸Šä¼ èµ„æºçš„ä¿å­˜ä½ç½®ï¼ˆpom.xmlï¼‰</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>heima-release<span class="tag">&lt;/<span class="name">id</span>&gt;</span>      </span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://localhost:8081/repository/heima-release/<span class="tag">&lt;/<span class="name">url</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">snapshotRepository</span>&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>heima-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://localhost:8081/repository/heima-snapshots/<span class="tag">&lt;/<span class="name">url</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>å‘å¸ƒèµ„æºåˆ°ç§æœå‘½ä»¤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn deploy</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="æ—¥å¿—"><a href="#æ—¥å¿—" class="headerlink" title="æ—¥å¿—"></a>æ—¥å¿—</h2><h3 id="Log4j"><a href="#Log4j" class="headerlink" title="Log4j"></a>Log4j</h3><p>ç¨‹åºä¸­çš„æ—¥å¿—å¯ä»¥ç”¨æ¥è®°å½•ç¨‹åºåœ¨è¿è¡Œæ—¶å€™çš„è¯¦æƒ…ï¼Œå¹¶å¯ä»¥è¿›è¡Œæ°¸ä¹…å­˜å‚¨ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>è¾“å‡ºè¯­å¥</th>
<th>æ—¥å¿—æŠ€æœ¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>å–æ¶ˆæ—¥å¿—</td>
<td>éœ€è¦ä¿®æ”¹ä»£ç ï¼Œçµæ´»æ€§æ¯”è¾ƒå·®</td>
<td>ä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œçµæ´»æ€§æ¯”è¾ƒå¥½</td>
</tr>
<tr>
<td>è¾“å‡ºä½ç½®</td>
<td>åªèƒ½æ˜¯æ§åˆ¶å°</td>
<td>å¯ä»¥å°†æ—¥å¿—ä¿¡æ¯å†™å…¥åˆ°æ–‡ä»¶æˆ–è€…æ•°æ®åº“ä¸­</td>
</tr>
<tr>
<td>å¤šçº¿ç¨‹</td>
<td>å’Œä¸šåŠ¡ä»£ç å¤„äºä¸€ä¸ªçº¿ç¨‹ä¸­</td>
<td>å¤šçº¿ç¨‹æ–¹å¼è®°å½•æ—¥å¿—ï¼Œä¸å½±å“ä¸šåŠ¡ä»£ç çš„æ€§èƒ½</td>
</tr>
</tbody>
</table>
</div>
<p>Log4j æ˜¯ Apache çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ã€‚ä½¿ç”¨ Log4jï¼Œé€šè¿‡ä¸€ä¸ªé…ç½®æ–‡ä»¶æ¥çµæ´»åœ°è¿›è¡Œé…ç½®ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹åº”ç”¨çš„ä»£ç ã€‚æˆ‘ä»¬å¯ä»¥æ§åˆ¶æ—¥å¿—ä¿¡æ¯è¾“é€çš„ç›®çš„åœ°æ˜¯æ§åˆ¶å°ã€æ–‡ä»¶ç­‰ä½ç½®ï¼Œä¹Ÿå¯ä»¥æ§åˆ¶æ¯ä¸€æ¡æ—¥å¿—çš„è¾“å‡ºæ ¼å¼ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/æ—¥å¿—ä½“ç³»ç»“æ„.png" style="zoom:50%;" /></p>
<hr>
<h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>é…ç½®æ–‡ä»¶çš„ä¸‰ä¸ªæ ¸å¿ƒï¼š</p>
<ul>
<li><p>é…ç½®æ ¹ Logger</p>
<ul>
<li><p>æ ¼å¼ï¼šlog4j.rootLogger=æ—¥å¿—çº§åˆ«ï¼ŒappenderName1ï¼ŒappenderName2ï¼Œâ€¦</p>
</li>
<li><p>æ—¥å¿—çº§åˆ«ï¼šå¸¸è§çš„äº”ä¸ªçº§åˆ«ï¼š<strong>DEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATAL</strong>ï¼ˆå¯ä»¥è‡ªå®šä¹‰ï¼‰<br>Log4j è§„åˆ™ï¼šåªè¾“å‡ºçº§åˆ«ä¸ä½äºè®¾å®šçº§åˆ«çš„æ—¥å¿—ä¿¡æ¯</p>
</li>
<li><p>appenderName1ï¼šæŒ‡å®šæ—¥å¿—ä¿¡æ¯è¦è¾“å‡ºåœ°å€ã€‚å¯ä»¥åŒæ—¶æŒ‡å®šå¤šä¸ªè¾“å‡ºç›®çš„åœ°ï¼Œç”¨é€—å·éš”å¼€ï¼š</p>
<p>ä¾‹å¦‚ï¼šlog4j.rootLoggerï¼INFOï¼Œcaï¼Œfa</p>
</li>
</ul>
</li>
<li><p>Appendersï¼ˆè¾“å‡ºæºï¼‰ï¼šæ—¥å¿—è¦è¾“å‡ºçš„åœ°æ–¹ï¼Œå¦‚æ§åˆ¶å°ï¼ˆConsoleï¼‰ã€æ–‡ä»¶ï¼ˆFilesï¼‰ç­‰</p>
<ul>
<li><p>Appenders å–å€¼ï¼š</p>
<ul>
<li>org.apache.log4j.ConsoleAppenderï¼ˆæ§åˆ¶å°ï¼‰</li>
<li>org.apache.log4j.FileAppenderï¼ˆæ–‡ä»¶ï¼‰</li>
</ul>
</li>
<li><p>ConsoleAppender å¸¸ç”¨å‚æ•°</p>
<ul>
<li><code>ImmediateFlush=true</code>ï¼šè¡¨ç¤ºæ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šè¢«ç«‹å³è¾“å‡ºï¼Œè®¾ä¸º false åˆ™ä¸è¾“å‡ºï¼Œé»˜è®¤å€¼æ˜¯ true</li>
<li><code>Target=System.err</code>ï¼šé»˜è®¤å€¼æ˜¯ System.out</li>
</ul>
</li>
<li><p>FileAppenderå¸¸ç”¨çš„é€‰é¡¹</p>
<ul>
<li><p><code>ImmediateFlush=true</code>ï¼šè¡¨ç¤ºæ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šè¢«ç«‹å³è¾“å‡ºã€‚è®¾ä¸º false åˆ™ä¸è¾“å‡ºï¼Œé»˜è®¤å€¼æ˜¯ true</p>
</li>
<li><p><code>Append=false</code>ï¼štrue è¡¨ç¤ºå°†æ¶ˆæ¯æ·»åŠ åˆ°æŒ‡å®šæ–‡ä»¶ä¸­ï¼ŒåŸæ¥çš„æ¶ˆæ¯ä¸è¦†ç›–ã€‚é»˜è®¤å€¼æ˜¯ true</p>
</li>
<li><p><code>File=E:/logs/logging.log4j</code>ï¼šæŒ‡å®šæ¶ˆæ¯è¾“å‡ºåˆ° logging.log4j æ–‡ä»¶ä¸­</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Layouts (å¸ƒå±€)ï¼šæ—¥å¿—è¾“å‡ºçš„æ ¼å¼ï¼Œå¸¸ç”¨çš„å¸ƒå±€ç®¡ç†å™¨ï¼š</p>
<ul>
<li>org.apache.log4j.PatternLayoutï¼ˆå¯ä»¥çµæ´»åœ°æŒ‡å®šå¸ƒå±€æ¨¡å¼ï¼‰</li>
</ul>
</li>
<li><p>org.apache.log4j.SimpleLayoutï¼ˆåŒ…å«æ—¥å¿—ä¿¡æ¯çš„çº§åˆ«å’Œä¿¡æ¯å­—ç¬¦ä¸²ï¼‰</p>
</li>
<li><p>org.apache.log4j.TTCCLayoutï¼ˆåŒ…å«æ—¥å¿—äº§ç”Ÿçš„æ—¶é—´ã€çº¿ç¨‹ã€ç±»åˆ«ç­‰ä¿¡æ¯ï¼‰</p>
</li>
<li><p>PatternLayout å¸¸ç”¨çš„é€‰é¡¹<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/æ—¥å¿—-PatternLayoutå¸¸ç”¨çš„é€‰é¡¹.png" style="zoom:80%;" /></p>
</li>
</ul>
<hr>
<h3 id="æ—¥å¿—åº”ç”¨"><a href="#æ—¥å¿—åº”ç”¨" class="headerlink" title="æ—¥å¿—åº”ç”¨"></a>æ—¥å¿—åº”ç”¨</h3><ul>
<li><p>log4j çš„é…ç½®æ–‡ä»¶,åå­—ä¸º log4j.properties, æ”¾åœ¨ src æ ¹ç›®å½•ä¸‹</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">log4j.rootLogger</span>=<span class="string">I</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### direct log messages to my ###</span></span><br><span class="line"><span class="attr">log4j.appender.my</span>=<span class="string">org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="attr">log4j.appender.my.ImmediateFlush</span> = <span class="string">true</span></span><br><span class="line"><span class="attr">log4j.appender.my.Target</span>=<span class="string">System.out</span></span><br><span class="line"><span class="attr">log4j.appender.my.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="attr">log4j.appender.my.layout.ConversionPattern</span>=<span class="string">%d %t %5p %c&#123;1&#125;:%L - %m%n</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># fileAppenderæ¼”ç¤º</span></span><br><span class="line"><span class="attr">log4j.appender.fileAppender</span>=<span class="string">org.apache.log4j.FileAppender</span></span><br><span class="line"><span class="attr">log4j.appender.fileAppender.ImmediateFlush</span> = <span class="string">true</span></span><br><span class="line"><span class="attr">log4j.appender.fileAppender.Append</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">log4j.appender.fileAppender.File</span>=<span class="string">E:/log4j-log.log</span></span><br><span class="line"><span class="attr">log4j.appender.fileAppender.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="attr">log4j.appender.fileAppender.layout.ConversionPattern</span>=<span class="string">%d %5p %c&#123;1&#125;:%L - %m%n</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æµ‹è¯•ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Log4JTest01</span> &#123;    </span><br><span class="line">    <span class="comment">//ä½¿ç”¨log4jçš„apiæ¥è·å–æ—¥å¿—çš„å¯¹è±¡   </span></span><br><span class="line">    <span class="comment">//å¼Šç«¯ï¼šå¦‚æœä»¥åæˆ‘ä»¬æ›´æ¢æ—¥å¿—çš„å®ç°ç±»ï¼Œé‚£ä¹ˆä¸‹é¢çš„ä»£ç å°±éœ€è¦è·Ÿç€æ”¹   </span></span><br><span class="line">    <span class="comment">//ä¸æ¨èä½¿ç”¨   </span></span><br><span class="line">    <span class="comment">//private static final Logger LOGGER = Logger.getLogger(Log4JTest01.class);    </span></span><br><span class="line">    <span class="comment">//ä½¿ç”¨slf4jé‡Œé¢çš„apiæ¥è·å–æ—¥å¿—çš„å¯¹è±¡ </span></span><br><span class="line">    <span class="comment">//å¥½å¤„ï¼šå¦‚æœä»¥åæˆ‘ä»¬æ›´æ¢æ—¥å¿—çš„å®ç°ç±»ï¼Œé‚£ä¹ˆä¸‹é¢çš„ä»£ç ä¸éœ€è¦è·Ÿç€ä¿®æ”¹   </span></span><br><span class="line">    <span class="comment">//æ¨èä½¿ç”¨    </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(Log4JTest01.class);  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;        </span><br><span class="line">        <span class="comment">//1.å¯¼å…¥jaråŒ…        </span></span><br><span class="line">        <span class="comment">//2.ç¼–å†™é…ç½®æ–‡ä»¶        </span></span><br><span class="line">        <span class="comment">//3.åœ¨ä»£ç ä¸­è·å–æ—¥å¿—çš„å¯¹è±¡        </span></span><br><span class="line">        <span class="comment">//4.æŒ‰ç…§æ—¥å¿—çº§åˆ«è®¾ç½®æ—¥å¿—ä¿¡æ¯        </span></span><br><span class="line">        LOGGER.debug(<span class="string">&quot;debugçº§åˆ«çš„æ—¥å¿—&quot;</span>);        </span><br><span class="line">        LOGGER.info(<span class="string">&quot;infoçº§åˆ«çš„æ—¥å¿—&quot;</span>);        </span><br><span class="line">        LOGGER.warn(<span class="string">&quot;warnçº§åˆ«çš„æ—¥å¿—&quot;</span>);        </span><br><span class="line">        LOGGER.error(<span class="string">&quot;errorçº§åˆ«çš„æ—¥å¿—&quot;</span>);    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h1 id="Netty"><a href="#Netty" class="headerlink" title="Netty"></a>Netty</h1><h2 id="åŸºæœ¬ä»‹ç»-1"><a href="#åŸºæœ¬ä»‹ç»-1" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h2><p>Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯</p>
<p>Netty å®˜ç½‘ï¼š<a target="_blank" rel="noopener" href="https://netty.io/">https://netty.io/</a></p>
<p>Netty çš„å¯¹ JDK è‡ªå¸¦çš„ NIO çš„ API è¿›è¡Œå°è£…ï¼Œè§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä¸»è¦ç‰¹ç‚¹æœ‰ï¼š</p>
<ul>
<li>è®¾è®¡ä¼˜é›…ï¼Œé€‚ç”¨äºå„ç§ä¼ è¾“ç±»å‹çš„ç»Ÿä¸€ APIï¼Œ é˜»å¡å’Œéé˜»å¡ Socket åŸºäºçµæ´»ä¸”å¯æ‰©å±•çš„äº‹ä»¶æ¨¡å‹</li>
<li>ä½¿ç”¨æ–¹ä¾¿ï¼Œè¯¦ç»†è®°å½•çš„ Javadocã€ç”¨æˆ·æŒ‡å—å’Œç¤ºä¾‹ï¼Œæ²¡æœ‰å…¶ä»–ä¾èµ–é¡¹</li>
<li>é«˜æ€§èƒ½ï¼Œååé‡æ›´é«˜ï¼Œå»¶è¿Ÿæ›´ä½ï¼Œå‡å°‘èµ„æºæ¶ˆè€—ï¼Œæœ€å°åŒ–ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶</li>
<li>å®‰å…¨ï¼Œå®Œæ•´çš„ SSL/TLS å’Œ StartTLS æ”¯æŒ</li>
</ul>
<p>Netty çš„åŠŸèƒ½ç‰¹æ€§ï¼š</p>
<ul>
<li>ä¼ è¾“æœåŠ¡ï¼šæ”¯æŒ BIO å’Œ NIO</li>
<li>å®¹å™¨é›†æˆï¼šæ”¯æŒ OSGIã€JBossMCã€Springã€Guice å®¹å™¨</li>
<li>åè®®æ”¯æŒï¼šHTTPã€Protobufã€äºŒè¿›åˆ¶ã€æ–‡æœ¬ã€WebSocket ç­‰ä¸€ç³»åˆ—åè®®éƒ½æ”¯æŒï¼Œä¹Ÿæ”¯æŒé€šè¿‡å®è¡Œç¼–ç è§£ç é€»è¾‘æ¥å®ç°è‡ªå®šä¹‰åè®®</li>
<li>Core æ ¸å¿ƒï¼šå¯æ‰©å±•äº‹ä»¶æ¨¡å‹ã€é€šç”¨é€šä¿¡ APIã€æ”¯æŒé›¶æ‹·è´çš„ ByteBuf ç¼“å†²å¯¹è±¡</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Netty-åŠŸèƒ½ç‰¹æ€§.png" style="zoom:50%;" /></p>
<hr>
<h2 id="çº¿ç¨‹æ¨¡å‹"><a href="#çº¿ç¨‹æ¨¡å‹" class="headerlink" title="çº¿ç¨‹æ¨¡å‹"></a>çº¿ç¨‹æ¨¡å‹</h2><h3 id="é˜»å¡æ¨¡å‹"><a href="#é˜»å¡æ¨¡å‹" class="headerlink" title="é˜»å¡æ¨¡å‹"></a>é˜»å¡æ¨¡å‹</h3><p>ä¼ ç»Ÿé˜»å¡å‹ I/O æ¨¡å¼ï¼Œæ¯ä¸ªè¿æ¥éƒ½éœ€è¦ç‹¬ç«‹çš„çº¿ç¨‹å®Œæˆæ•°æ®çš„è¾“å…¥ï¼Œä¸šåŠ¡å¤„ç†ï¼Œæ•°æ®è¿”å›</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Netty-ä¼ ç»Ÿé˜»å¡IOæœåŠ¡æ¨¡å‹.png" style="zoom:50%;" /></p>
<p>æ¨¡å‹ç¼ºç‚¹ï¼š</p>
<ul>
<li>å½“å¹¶å‘æ•°è¾ƒå¤§æ—¶ï¼Œéœ€è¦åˆ›å»ºå¤§é‡çº¿ç¨‹æ¥å¤„ç†è¿æ¥ï¼Œç³»ç»Ÿèµ„æºå ç”¨è¾ƒå¤§</li>
<li>è¿æ¥å»ºç«‹åï¼Œå¦‚æœå½“å‰çº¿ç¨‹æš‚æ—¶æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œåˆ™çº¿ç¨‹å°±é˜»å¡åœ¨ read æ“ä½œä¸Šï¼Œé€ æˆçº¿ç¨‹èµ„æºæµªè´¹</li>
</ul>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/2965fca6bb8f">https://www.jianshu.com/p/2965fca6bb8f</a></p>
<hr>
<h3 id="Reactor"><a href="#Reactor" class="headerlink" title="Reactor"></a>Reactor</h3><h4 id="è®¾è®¡æ€æƒ³"><a href="#è®¾è®¡æ€æƒ³" class="headerlink" title="è®¾è®¡æ€æƒ³"></a>è®¾è®¡æ€æƒ³</h4><p>Reactor æ¨¡å¼ï¼Œé€šè¿‡ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å…¥åŒæ—¶ä¼ é€’ç»™æœåŠ¡å¤„ç†å™¨çš„<strong>äº‹ä»¶é©±åŠ¨å¤„ç†æ¨¡å¼</strong>ã€‚ æœåŠ¡ç«¯ç¨‹åºå¤„ç†ä¼ å…¥çš„å¤šè·¯è¯·æ±‚ï¼Œå¹¶å°†å®ƒä»¬åŒæ­¥åˆ†æ´¾ç»™å¯¹åº”çš„å¤„ç†çº¿ç¨‹ï¼ŒReactor æ¨¡å¼ä¹Ÿå« Dispatcher æ¨¡å¼ï¼Œå³ I/O å¤šè·¯å¤ç”¨ç»Ÿä¸€ç›‘å¬äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶ååˆ†å‘ï¼ˆDispatch ç»™æŸçº¿ç¨‹ï¼‰</p>
<p><strong>I/O å¤ç”¨ç»“åˆçº¿ç¨‹æ± </strong>ï¼Œå°±æ˜¯ Reactor æ¨¡å¼åŸºæœ¬è®¾è®¡æ€æƒ³ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Netty-Reactoræ¨¡å‹.png" style="zoom: 50%;" /></p>
<p>Reactor æ¨¡å¼å…³é”®ç»„æˆï¼š</p>
<ul>
<li>Reactorï¼šåœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œè´Ÿè´£<strong>ç›‘å¬å’Œåˆ†å‘äº‹ä»¶</strong>ï¼Œåˆ†å‘ç»™é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å¯¹ I/O äº‹ä»¶åšå‡ºååº”</li>
<li>Handlerï¼šå¤„ç†ç¨‹åºæ‰§è¡Œ I/O è¦å®Œæˆçš„å®é™…äº‹ä»¶ï¼ŒReactor é€šè¿‡è°ƒåº¦é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å“åº” I/O äº‹ä»¶ï¼Œå¤„ç†ç¨‹åºæ‰§è¡Œ<strong>éé˜»å¡æ“ä½œ</strong></li>
</ul>
<p>Reactor æ¨¡å¼å…·æœ‰å¦‚ä¸‹çš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å“åº”å¿«ï¼Œä¸å¿…ä¸ºå•ä¸ªåŒæ­¥æ—¶é—´æ‰€é˜»å¡ï¼Œè™½ç„¶ Reactor æœ¬èº«ä¾ç„¶æ˜¯åŒæ­¥çš„</li>
<li>ç¼–ç¨‹ç›¸å¯¹ç®€å•ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¤æ‚çš„å¤šçº¿ç¨‹åŠåŒæ­¥é—®é¢˜ï¼Œå¹¶ä¸”é¿å…äº†å¤šçº¿ç¨‹/è¿›ç¨‹çš„åˆ‡æ¢å¼€é”€</li>
<li>å¯æ‰©å±•æ€§ï¼Œå¯ä»¥æ–¹ä¾¿çš„é€šè¿‡å¢åŠ  Reactor å®ä¾‹ä¸ªæ•°æ¥å……åˆ†åˆ©ç”¨ CPU èµ„æº</li>
<li>å¯å¤ç”¨æ€§ï¼ŒReactor æ¨¡å‹æœ¬èº«ä¸å…·ä½“äº‹ä»¶å¤„ç†é€»è¾‘æ— å…³ï¼Œå…·æœ‰å¾ˆé«˜çš„å¤ç”¨æ€§</li>
</ul>
<p>æ ¹æ® Reactor çš„æ•°é‡å’Œå¤„ç†èµ„æºæ± çº¿ç¨‹çš„æ•°é‡ä¸åŒï¼Œæœ‰ä¸‰ç§å…¸å‹çš„å®ç°ï¼š</p>
<ul>
<li>å• Reactor å•çº¿ç¨‹</li>
<li>å• Reactor å¤šçº¿ç¨‹</li>
<li>ä¸»ä» Reactor å¤šçº¿ç¨‹</li>
</ul>
<hr>
<h4 id="å•Rå•çº¿ç¨‹"><a href="#å•Rå•çº¿ç¨‹" class="headerlink" title="å•Rå•çº¿ç¨‹"></a>å•Rå•çº¿ç¨‹</h4><p>Reactor å¯¹è±¡é€šè¿‡ select ç›‘æ§å®¢æˆ·ç«¯è¯·æ±‚äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ dispatch è¿›è¡Œåˆ†å‘ï¼š</p>
<ul>
<li><p>å¦‚æœæ˜¯å»ºç«‹è¿æ¥è¯·æ±‚äº‹ä»¶ï¼Œåˆ™ç”± Acceptor é€šè¿‡ accept å¤„ç†è¿æ¥è¯·æ±‚ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª Handler å¯¹è±¡å¤„ç†è¿æ¥å®Œæˆåçš„åç»­ä¸šåŠ¡å¤„ç†</p>
</li>
<li><p>å¦‚æœä¸æ˜¯å»ºç«‹è¿æ¥äº‹ä»¶ï¼Œåˆ™ Reactor ä¼šåˆ†å‘ç»™è¿æ¥å¯¹åº”çš„ Handler æ¥å“åº”ï¼ŒHandler ä¼šå®Œæˆ readã€ä¸šåŠ¡å¤„ç†ã€send çš„å®Œæ•´æµç¨‹</p>
<p>è¯´æ˜ï¼š<strong>Handler å’Œ Acceptor å±äºåŒä¸€ä¸ªçº¿ç¨‹</strong></p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Netty-å•Reactorå•çº¿ç¨‹.png" style="zoom:50%;" /></p>
<p>æ¨¡å‹ä¼˜ç‚¹ï¼šæ¨¡å‹ç®€å•ï¼Œæ²¡æœ‰å¤šçº¿ç¨‹ã€è¿›ç¨‹é€šä¿¡ã€ç«äº‰çš„é—®é¢˜ï¼Œå…¨éƒ¨éƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆ</p>
<p>æ¨¡å‹ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ€§èƒ½é—®é¢˜ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ— æ³•å‘æŒ¥å¤šæ ¸ CPU çš„æ€§èƒ½ï¼ŒHandler åœ¨å¤„ç†æŸä¸ªè¿æ¥ä¸Šçš„ä¸šåŠ¡æ—¶ï¼Œæ•´ä¸ªè¿›ç¨‹æ— æ³•å¤„ç†å…¶ä»–è¿æ¥äº‹ä»¶ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æ€§èƒ½ç“¶é¢ˆ</li>
<li>å¯é æ€§é—®é¢˜ï¼šçº¿ç¨‹æ„å¤–è·‘é£ï¼Œæˆ–è€…è¿›å…¥æ­»å¾ªç¯ï¼Œä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿé€šä¿¡æ¨¡å—ä¸å¯ç”¨ï¼Œä¸èƒ½æ¥æ”¶å’Œå¤„ç†å¤–éƒ¨æ¶ˆæ¯ï¼Œé€ æˆèŠ‚ç‚¹æ•…éšœ</li>
</ul>
<p>ä½¿ç”¨åœºæ™¯ï¼šå®¢æˆ·ç«¯çš„æ•°é‡æœ‰é™ï¼Œä¸šåŠ¡å¤„ç†éå¸¸å¿«é€Ÿï¼Œæ¯”å¦‚ Redisï¼Œä¸šåŠ¡å¤„ç†çš„æ—¶é—´å¤æ‚åº¦ O(1)</p>
<hr>
<h4 id="å•Rå¤šçº¿ç¨‹"><a href="#å•Rå¤šçº¿ç¨‹" class="headerlink" title="å•Rå¤šçº¿ç¨‹"></a>å•Rå¤šçº¿ç¨‹</h4><p>æ‰§è¡Œæµç¨‹é€šåŒå• Reactor å•çº¿ç¨‹ï¼Œä¸åŒçš„æ˜¯ï¼š</p>
<ul>
<li><p>Handler åªè´Ÿè´£å“åº”äº‹ä»¶ï¼Œä¸åšå…·ä½“ä¸šåŠ¡å¤„ç†ï¼Œé€šè¿‡ read è¯»å–æ•°æ®åï¼Œä¼šåˆ†å‘ç»™åé¢çš„ Worker çº¿ç¨‹æ± è¿›è¡Œä¸šåŠ¡å¤„ç†</p>
</li>
<li><p>Worker çº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çš„çº¿ç¨‹å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡å¤„ç†ï¼Œå°†å“åº”ç»“æœå‘ç»™ Handler è¿›è¡Œå¤„ç†ï¼Œæœ€åç”± Handler æ”¶åˆ°å“åº”ç»“æœåé€šè¿‡ send å°†å“åº”ç»“æœè¿”å›ç»™ Client</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Netty-å•Reactorå¤šçº¿ç¨‹.png" style="zoom:50%;" /></p>
<p>æ¨¡å‹ä¼˜ç‚¹ï¼šå¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„å¤„ç†èƒ½åŠ›</p>
<p>æ¨¡å‹ç¼ºç‚¹ï¼š</p>
<ul>
<li>å¤šçº¿ç¨‹æ•°æ®å…±äº«å’Œè®¿é—®æ¯”è¾ƒå¤æ‚</li>
<li>Reactor æ‰¿æ‹…æ‰€æœ‰äº‹ä»¶çš„ç›‘å¬å’Œå“åº”ï¼Œåœ¨å•çº¿ç¨‹ä¸­è¿è¡Œï¼Œé«˜å¹¶å‘åœºæ™¯ä¸‹å®¹æ˜“æˆä¸ºæ€§èƒ½ç“¶é¢ˆ</li>
</ul>
<hr>
<h4 id="ä¸»ä»æ¨¡å‹"><a href="#ä¸»ä»æ¨¡å‹" class="headerlink" title="ä¸»ä»æ¨¡å‹"></a>ä¸»ä»æ¨¡å‹</h4><p>é‡‡ç”¨å¤šä¸ª Reactor ï¼Œæ‰§è¡Œæµç¨‹ï¼š</p>
<ul>
<li><p>Reactor ä¸»çº¿ç¨‹ MainReactor é€šè¿‡ select <strong>ç›‘æ§å»ºç«‹è¿æ¥äº‹ä»¶</strong>ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ Acceptor æ¥æ”¶ï¼Œå¤„ç†å»ºç«‹è¿æ¥äº‹ä»¶ï¼Œå¤„ç†å®Œæˆå MainReactor ä¼šå°†è¿æ¥åˆ†é…ç»™ Reactor å­çº¿ç¨‹çš„ SubReactorï¼ˆæœ‰å¤šä¸ªï¼‰å¤„ç†</p>
</li>
<li><p>SubReactor å°†è¿æ¥åŠ å…¥è¿æ¥é˜Ÿåˆ—è¿›è¡Œç›‘å¬å…¶ä»–äº‹ä»¶ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª Handler ç”¨äºå¤„ç†è¯¥è¿æ¥çš„äº‹ä»¶ï¼Œå½“æœ‰æ–°çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒSubReactor ä¼šè°ƒç”¨è¿æ¥å¯¹åº”çš„ Handler è¿›è¡Œå“åº”</p>
</li>
<li><p>Handler é€šè¿‡ read è¯»å–æ•°æ®åï¼Œä¼šåˆ†å‘ç»™ Worker çº¿ç¨‹æ± è¿›è¡Œä¸šåŠ¡å¤„ç†</p>
</li>
<li><p>Worker çº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çš„çº¿ç¨‹å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡å¤„ç†ï¼Œå°†å“åº”ç»“æœå‘ç»™ Handler è¿›è¡Œå¤„ç†ï¼Œæœ€åç”± Handler æ”¶åˆ°å“åº”ç»“æœåé€šè¿‡ send å°†å“åº”ç»“æœè¿”å›ç»™ Client</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Netty-ä¸»ä»Reactorå¤šçº¿ç¨‹.png" style="zoom: 50%;" /></p>
<p>æ¨¡å‹ä¼˜ç‚¹</p>
<ul>
<li><strong>çˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹</strong>çš„æ•°æ®äº¤äº’ç®€å•èŒè´£æ˜ç¡®ï¼Œçˆ¶çº¿ç¨‹åªéœ€è¦æ¥æ”¶æ–°è¿æ¥ï¼Œå­çº¿ç¨‹å®Œæˆåç»­çš„ä¸šåŠ¡å¤„ç†</li>
<li>çˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„æ•°æ®äº¤äº’ç®€å•ï¼ŒReactor ä¸»çº¿ç¨‹åªéœ€è¦æŠŠæ–°è¿æ¥ä¼ ç»™å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹æ— éœ€è¿”å›æ•°æ®</li>
</ul>
<p>ä½¿ç”¨åœºæ™¯ï¼šNginx ä¸»ä» Reactor å¤šè¿›ç¨‹æ¨¡å‹ï¼ŒMemcached ä¸»ä»å¤šçº¿ç¨‹ï¼ŒNetty ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹çš„æ”¯æŒ</p>
<hr>
<h3 id="Proactor"><a href="#Proactor" class="headerlink" title="Proactor"></a>Proactor</h3><p>Reactor æ¨¡å¼ä¸­ï¼ŒReactor ç­‰å¾…æŸä¸ªäº‹ä»¶çš„æ“ä½œçŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼ˆæ–‡ä»¶æè¿°ç¬¦å¯è¯»å†™ï¼Œsocket å¯è¯»å†™ï¼‰ï¼Œç„¶åæŠŠäº‹ä»¶ä¼ é€’ç»™äº‹å…ˆæ³¨å†Œçš„ Handler æ¥åšå®é™…çš„è¯»å†™æ“ä½œï¼Œå…¶ä¸­çš„è¯»å†™æ“ä½œéƒ½éœ€è¦åº”ç”¨ç¨‹åºåŒæ­¥æ“ä½œï¼Œæ‰€ä»¥ <strong>Reactor æ˜¯éé˜»å¡åŒæ­¥ç½‘ç»œæ¨¡å‹ï¼ˆNIOï¼‰</strong></p>
<p>æŠŠ I/O æ“ä½œæ”¹ä¸ºå¼‚æ­¥ï¼Œäº¤ç»™æ“ä½œç³»ç»Ÿæ¥å®Œæˆå°±èƒ½è¿›ä¸€æ­¥æå‡æ€§èƒ½ï¼Œè¿™å°±æ˜¯å¼‚æ­¥ç½‘ç»œæ¨¡å‹ Proactorï¼ˆAIOï¼‰ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Netty-Proactoræ¨¡å‹.png" style="zoom:50%;" /></p>
<p>å·¥ä½œæµç¨‹ï¼š</p>
<ul>
<li>ProactorInitiator åˆ›å»º Proactor å’Œ Handler å¯¹è±¡ï¼Œå¹¶å°† Proactor å’Œ Handler é€šè¿‡ Asynchronous Operation Processorï¼ˆAsyOptProcessorï¼‰æ³¨å†Œåˆ°å†…æ ¸</li>
<li>AsyOptProcessor å¤„ç†æ³¨å†Œè¯·æ±‚ï¼Œå¹¶å¤„ç† I/O æ“ä½œï¼Œå®ŒæˆI/Oåé€šçŸ¥ Proactor</li>
<li>Proactor æ ¹æ®ä¸åŒçš„äº‹ä»¶ç±»å‹å›è°ƒä¸åŒçš„ Handler è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œæœ€åç”± Handler å®Œæˆä¸šåŠ¡å¤„ç†</li>
</ul>
<p>å¯¹æ¯”ï¼šReactor åœ¨äº‹ä»¶å‘ç”Ÿæ—¶å°±é€šçŸ¥äº‹å…ˆæ³¨å†Œçš„å¤„ç†å™¨ï¼ˆè¯»å†™åœ¨åº”ç”¨ç¨‹åºçº¿ç¨‹ä¸­å¤„ç†å®Œæˆï¼‰ï¼›Proactor æ˜¯åœ¨äº‹ä»¶å‘ç”Ÿæ—¶åŸºäºå¼‚æ­¥ I/O å®Œæˆè¯»å†™æ“ä½œï¼ˆå†…æ ¸å®Œæˆï¼‰ï¼ŒI/O å®Œæˆåæ‰å›è°ƒåº”ç”¨ç¨‹åºçš„å¤„ç†å™¨è¿›è¡Œä¸šåŠ¡å¤„ç†</p>
<p>æ¨¡å¼ä¼˜ç‚¹ï¼šå¼‚æ­¥ I/O æ›´åŠ å……åˆ†å‘æŒ¥ DMAï¼ˆDirect Memory Access ç›´æ¥å†…å­˜å­˜å–ï¼‰çš„ä¼˜åŠ¿</p>
<p>æ¨¡å¼ç¼ºç‚¹ï¼š</p>
<ul>
<li>ç¼–ç¨‹å¤æ‚æ€§ï¼Œç”±äºå¼‚æ­¥æ“ä½œæµç¨‹çš„äº‹ä»¶çš„åˆå§‹åŒ–å’Œäº‹ä»¶å®Œæˆåœ¨æ—¶é—´å’Œç©ºé—´ä¸Šéƒ½æ˜¯ç›¸äº’åˆ†ç¦»çš„ï¼Œå› æ­¤å¼€å‘å¼‚æ­¥åº”ç”¨ç¨‹åºæ›´åŠ å¤æ‚ï¼Œåº”ç”¨ç¨‹åºè¿˜å¯èƒ½å› ä¸ºåå‘çš„æµæ§è€Œå˜å¾—æ›´åŠ éš¾ä»¥è°ƒè¯•</li>
<li>å†…å­˜ä½¿ç”¨ï¼Œç¼“å†²åŒºåœ¨è¯»æˆ–å†™æ“ä½œçš„æ—¶é—´æ®µå†…å¿…é¡»ä¿æŒä½ï¼Œå¯èƒ½é€ æˆæŒç»­çš„ä¸ç¡®å®šæ€§ï¼Œå¹¶ä¸”æ¯ä¸ªå¹¶å‘æ“ä½œéƒ½è¦æ±‚æœ‰ç‹¬ç«‹çš„ç¼“å­˜ï¼ŒReactor æ¨¡å¼åœ¨ socket å‡†å¤‡å¥½è¯»æˆ–å†™ä¹‹å‰æ˜¯ä¸è¦æ±‚å¼€è¾Ÿç¼“å­˜çš„</li>
<li>æ“ä½œç³»ç»Ÿæ”¯æŒï¼ŒWindows ä¸‹é€šè¿‡ IOCP å®ç°äº†çœŸæ­£çš„å¼‚æ­¥ I/Oï¼Œè€Œåœ¨ Linux ç³»ç»Ÿä¸‹ï¼ŒLinux2.6 æ‰å¼•å…¥å¼‚æ­¥ I/Oï¼Œç›®å‰è¿˜ä¸å®Œå–„ï¼Œæ‰€ä»¥åœ¨ Linux ä¸‹å®ç°é«˜å¹¶å‘ç½‘ç»œç¼–ç¨‹éƒ½æ˜¯ä»¥ Reactor æ¨¡å‹ä¸ºä¸»</li>
</ul>
<hr>
<h3 id="Netty-1"><a href="#Netty-1" class="headerlink" title="Netty"></a>Netty</h3><p>Netty ä¸»è¦åŸºäºä¸»ä» Reactors å¤šçº¿ç¨‹æ¨¡å‹åšäº†ä¸€å®šçš„æ”¹è¿›ï¼ŒNetty çš„å·¥ä½œæ¶æ„å›¾ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Netty-å·¥ä½œæ¨¡å‹.png" style="zoom:50%;" /></p>
<p>å·¥ä½œæµç¨‹ï¼š</p>
<ol>
<li><p>Netty æŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ±  BossGroup ä¸“é—¨è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼ŒWorkerGroup ä¸“é—¨è´Ÿè´£ç½‘ç»œçš„è¯»å†™</p>
</li>
<li><p>BossGroup å’Œ WorkerGroup ç±»å‹éƒ½æ˜¯ NioEventLoopGroupï¼Œè¯¥ Group ç›¸å½“äºä¸€ä¸ªäº‹ä»¶å¾ªç¯ç»„ï¼Œå«æœ‰å¤šä¸ªäº‹ä»¶å¾ªç¯ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯æ˜¯ NioEventLoopï¼Œæ‰€ä»¥å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹</p>
</li>
<li><p>NioEventLoop è¡¨ç¤ºä¸€ä¸ª<strong>å¾ªç¯å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹</strong>ï¼Œæ¯ä¸ª NioEventLoop éƒ½æœ‰ä¸€ä¸ª Selectorï¼Œç”¨äºç›‘å¬ç»‘å®šåœ¨å…¶ä¸Šçš„ Socket çš„é€šè®¯</p>
</li>
<li><p>æ¯ä¸ª Boss NioEventLoop å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤ï¼š</p>
<ul>
<li>è½®è¯¢ accept äº‹ä»¶</li>
<li>å¤„ç† accept äº‹ä»¶ï¼Œä¸ client å»ºç«‹è¿æ¥ï¼Œç”Ÿæˆ NioScocketChannelï¼Œå¹¶å°†å…¶<strong>æ³¨å†Œåˆ°æŸä¸ª Worker ä¸­</strong>çš„æŸä¸ª NioEventLoop ä¸Šçš„ Selectorï¼Œè¿æ¥å°±ä¸ NioEventLoop ç»‘å®š</li>
<li>å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³ runAllTasks</li>
</ul>
</li>
<li><p>æ¯ä¸ª Worker NioEventLoop å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤ï¼š</p>
<ul>
<li>è½®è¯¢ readã€write äº‹ä»¶</li>
<li>å¤„ç† I/O äº‹ä»¶ï¼Œå³ readï¼Œwrite äº‹ä»¶ï¼Œåœ¨å¯¹åº” NioSocketChannel å¤„ç†</li>
<li>å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³ runAllTasks</li>
</ul>
</li>
<li><p>æ¯ä¸ª Worker NioEventLoop å¤„ç†ä¸šåŠ¡æ—¶ï¼Œä¼šä½¿ç”¨ Pipelineï¼ˆç®¡é“ï¼‰ï¼ŒPipeline ä¸­åŒ…å«äº† Channelï¼Œå³é€šè¿‡ Pipeline å¯ä»¥è·å–åˆ°å¯¹åº”é€šé“ï¼Œç®¡é“ä¸­ç»´æŠ¤äº†å¾ˆå¤šçš„å¤„ç†å™¨ Handler</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Netty-Channelä¸Pipeline.png" style="zoom: 50%;" /></p>
</li>
</ol>
<hr>
<h2 id="åŸºæœ¬å®ç°"><a href="#åŸºæœ¬å®ç°" class="headerlink" title="åŸºæœ¬å®ç°"></a>åŸºæœ¬å®ç°</h2><p>å¼€å‘ç®€å•çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ï¼ŒåŸºæœ¬ä»‹ç»ï¼š</p>
<ul>
<li>Channel ç†è§£ä¸ºæ•°æ®çš„é€šé“ï¼ŒæŠŠ msg ç†è§£ä¸ºæµåŠ¨çš„æ•°æ®ï¼Œæœ€å¼€å§‹è¾“å…¥æ˜¯ ByteBufï¼Œä½†ç»è¿‡ Pipeline çš„åŠ å·¥ï¼Œä¼šå˜æˆå…¶å®ƒç±»å‹å¯¹è±¡ï¼Œæœ€åè¾“å‡ºåˆå˜æˆ ByteBuf</li>
<li>Handler ç†è§£ä¸ºæ•°æ®çš„å¤„ç†å·¥åºï¼ŒPipeline è´Ÿè´£å‘å¸ƒäº‹ä»¶ä¼ æ’­ç»™æ¯ä¸ª Handlerï¼ŒHandler å¯¹è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆé‡å†™äº†ç›¸åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼‰ï¼Œåˆ† Inbound å’Œ Outbound ä¸¤ç±»</li>
<li>EventLoop ç†è§£ä¸ºå¤„ç†æ•°æ®çš„æ‰§è¡Œè€…ï¼Œæ—¢å¯ä»¥æ‰§è¡Œ IO æ“ä½œï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä»»åŠ¡å¤„ç†ã€‚æ¯ä¸ªæ‰§è¡Œè€…æœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œå¯ä»¥å †æ”¾å¤šä¸ª Channel çš„å¾…å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡åˆ†ä¸ºæ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡ã€‚æŒ‰ç…§ Pipeline é¡ºåºï¼Œä¾æ¬¡æŒ‰ç…§ Handler çš„è§„åˆ’ï¼ˆä»£ç ï¼‰å¤„ç†æ•°æ®</li>
</ul>
<p>ä»£ç å®ç°ï¼š</p>
<ul>
<li><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.20.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>Server.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">boss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 1. å¯åŠ¨å™¨ï¼Œè´Ÿè´£ç»„è£… netty ç»„ä»¶ï¼Œå¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>()</span><br><span class="line">                <span class="comment">// 2. çº¿ç¨‹ç»„ï¼Œboss åªè´Ÿè´£ã€å¤„ç† accept äº‹ä»¶ã€‘ï¼Œ worker åªã€è´Ÿè´£ channel ä¸Šçš„è¯»å†™ã€‘</span></span><br><span class="line">                .group(boss, worker)</span><br><span class="line">           	 	<span class="comment">//.option() 		// ç»™ ServerSocketChannel é…ç½®å‚æ•°</span></span><br><span class="line">            	<span class="comment">//.childOption()   	// ç»™ SocketChannel é…ç½®å‚æ•°</span></span><br><span class="line">                <span class="comment">// 3. é€‰æ‹©æœåŠ¡å™¨çš„ ServerSocketChannel å®ç°</span></span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                <span class="comment">// 4. boss è´Ÿè´£å¤„ç†è¿æ¥ï¼Œworker(child) è´Ÿè´£å¤„ç†è¯»å†™ï¼Œå†³å®šäº†èƒ½æ‰§è¡Œå“ªäº›æ“ä½œ(handler)</span></span><br><span class="line">                .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="comment">// 5. channel ä»£è¡¨å’Œå®¢æˆ·ç«¯è¿›è¡Œæ•°æ®è¯»å†™çš„é€šé“ Initializer åˆå§‹åŒ–ï¼Œè´Ÿè´£æ·»åŠ åˆ«çš„ handler</span></span><br><span class="line">                    <span class="comment">// 7. è¿æ¥å»ºç«‹åï¼Œæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="comment">// æ·»åŠ å…·ä½“çš„ handler</span></span><br><span class="line">                        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>());<span class="comment">// å°† ByteBuf è½¬æˆå­—ç¬¦ä¸²</span></span><br><span class="line">                        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123; <span class="comment">// è‡ªå®šä¹‰ handler</span></span><br><span class="line">                            <span class="comment">// è¯»äº‹ä»¶</span></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> &#123;</span><br><span class="line">                                <span class="comment">// æ‰“å°è½¬æ¢å¥½çš„å­—ç¬¦ä¸²</span></span><br><span class="line">                                System.out.println(msg);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 6. ç»‘å®šç›‘å¬ç«¯å£</span></span><br><span class="line">                .bind(<span class="number">8080</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Client.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 1. åˆ›å»ºå¯åŠ¨å™¨ç±»</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">                <span class="comment">// 2. æ·»åŠ  EventLoop</span></span><br><span class="line">                .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>())</span><br><span class="line">            	<span class="comment">//.option()ï¼Œç»™ SocketChannel é…ç½®å‚æ•°</span></span><br><span class="line">                <span class="comment">// 3. é€‰æ‹©å®¢æˆ·ç«¯ channel å®ç°</span></span><br><span class="line">                .channel(NioSocketChannel.class)</span><br><span class="line">                <span class="comment">// 4. æ·»åŠ å¤„ç†å™¨</span></span><br><span class="line">                .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="comment">// 4.1 è¿æ¥å»ºç«‹åè¢«è°ƒç”¨</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="comment">// å°† Hello World è½¬ä¸º ByteBuf</span></span><br><span class="line">                        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 5. è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œç„¶åè°ƒç”¨ 4.1</span></span><br><span class="line">                .connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">8080</span>))</span><br><span class="line">                <span class="comment">// 6. é˜»å¡æ–¹æ³•ï¼Œç›´åˆ°è¿æ¥å»ºç«‹</span></span><br><span class="line">                .sync()</span><br><span class="line">                <span class="comment">// 7. ä»£è¡¨è¿æ¥å¯¹è±¡</span></span><br><span class="line">                .channel()</span><br><span class="line">                <span class="comment">// 8. å‘æœåŠ¡å™¨å‘é€æ•°æ®</span></span><br><span class="line">                .writeAndFlush(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1py4y1E7oA">https://www.bilibili.com/video/BV1py4y1E7oA</a></p>
<hr>
<h2 id="ç»„ä»¶ä»‹ç»"><a href="#ç»„ä»¶ä»‹ç»" class="headerlink" title="ç»„ä»¶ä»‹ç»"></a>ç»„ä»¶ä»‹ç»</h2><h3 id="EventLoop"><a href="#EventLoop" class="headerlink" title="EventLoop"></a>EventLoop</h3><h4 id="åŸºæœ¬ä»‹ç»-2"><a href="#åŸºæœ¬ä»‹ç»-2" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h4><p>äº‹ä»¶å¾ªç¯å¯¹è±¡ EventLoopï¼Œ<strong>æœ¬è´¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ‰§è¡Œå™¨åŒæ—¶ç»´æŠ¤äº†ä¸€ä¸ª Selector</strong>ï¼Œæœ‰ run æ–¹æ³•å¤„ç† Channel ä¸Šæºæºä¸æ–­çš„ IO äº‹ä»¶</p>
<p>äº‹ä»¶å¾ªç¯ç»„ EventLoopGroup æ˜¯ä¸€ç»„ EventLoopï¼ŒChannel ä¼šè°ƒç”¨ Boss EventLoopGroup çš„ register æ–¹æ³•æ¥ç»‘å®šå…¶ä¸­ä¸€ä¸ª Worker çš„ EventLoopï¼Œåç»­è¿™ä¸ª Channel ä¸Šçš„ IO äº‹ä»¶éƒ½ç”±æ­¤ EventLoop æ¥å¤„ç†ï¼Œä¿è¯äº†äº‹ä»¶å¤„ç†æ—¶çš„çº¿ç¨‹å®‰å…¨</p>
<p>EventLoopGroup ç±» APIï¼š</p>
<ul>
<li><code>EventLoop next()</code>ï¼šè·å–é›†åˆä¸­ä¸‹ä¸€ä¸ª EventLoopï¼ŒEventLoopGroup å®ç°äº† Iterable æ¥å£æä¾›éå† EventLoop çš„èƒ½åŠ›</li>
<li><p><code>Future&lt;?&gt; shutdownGracefully()</code>ï¼šä¼˜é›…å…³é—­çš„æ–¹æ³•ï¼Œä¼šé¦–å…ˆåˆ‡æ¢ EventLoopGroup åˆ°å…³é—­çŠ¶æ€ä»è€Œæ‹’ç»æ–°çš„ä»»åŠ¡çš„åŠ å…¥ï¼Œç„¶ååœ¨ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡éƒ½å¤„ç†å®Œæˆåï¼Œåœæ­¢çº¿ç¨‹çš„è¿è¡Œï¼Œä»è€Œç¡®ä¿æ•´ä½“åº”ç”¨æ˜¯åœ¨æ­£å¸¸æœ‰åºçš„çŠ¶æ€ä¸‹é€€å‡ºçš„</p>
</li>
<li><p><code>&lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task)</code>ï¼šæäº¤ä»»åŠ¡</p>
</li>
<li><code>ScheduledFuture&lt;?&gt; scheduleWithFixedDelay</code>ï¼šæäº¤å®šæ—¶ä»»åŠ¡</li>
</ul>
<hr>
<h4 id="ä»»åŠ¡ä¼ é€’"><a href="#ä»»åŠ¡ä¼ é€’" class="headerlink" title="ä»»åŠ¡ä¼ é€’"></a>ä»»åŠ¡ä¼ é€’</h4><p>æŠŠè¦è°ƒç”¨çš„ä»£ç å°è£…ä¸ºä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œç”±ä¸‹ä¸€ä¸ª handler çš„çº¿ç¨‹æ¥è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventLoopServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>()</span><br><span class="line">                .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(), <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">2</span>))</span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> &#123;</span><br><span class="line">                        ch.pipeline().addLast(<span class="string">&quot;handler1&quot;</span>, <span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> &#123;</span><br><span class="line">                                <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                                log.debug(buf.toString(Charset.defaultCharset()));</span><br><span class="line">                                ctx.fireChannelRead(msg);   <span class="comment">// è®©æ¶ˆæ¯ã€ä¼ é€’ã€‘ç»™ä¸‹ä¸€ä¸ª handler</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;).addLast(group, <span class="string">&quot;handler2&quot;</span>, <span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> &#123;</span><br><span class="line">                                <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                                log.debug(buf.toString(Charset.defaultCharset()));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .bind(<span class="number">8080</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æºç åˆ†æï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ChannelHandlerContext <span class="title function_">fireChannelRead</span><span class="params">(<span class="keyword">final</span> Object msg)</span> &#123;</span><br><span class="line">    invokeChannelRead(findContextInbound(MASK_CHANNEL_READ), msg);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeChannelRead</span><span class="params">(<span class="keyword">final</span> AbstractChannelHandlerContext next, Object msg)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">m</span> <span class="operator">=</span> next.pipeline.touch(ObjectUtil.checkNotNull(msg, <span class="string">&quot;msg&quot;</span>), next);</span><br><span class="line">    <span class="type">EventExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> next.executor();</span><br><span class="line">    <span class="comment">// ä¸‹ä¸€ä¸ª handler çš„äº‹ä»¶å¾ªç¯æ˜¯å¦ä¸å½“å‰çš„äº‹ä»¶å¾ªç¯æ˜¯åŒä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (executor.inEventLoop()) &#123;</span><br><span class="line">        <span class="comment">// æ˜¯ï¼Œç›´æ¥è°ƒç”¨</span></span><br><span class="line">        next.invokeChannelRead(m);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸æ˜¯ï¼Œå°†è¦æ‰§è¡Œçš„ä»£ç ä½œä¸ºä»»åŠ¡æäº¤ç»™ä¸‹ä¸€ä¸ª handler å¤„ç†</span></span><br><span class="line">        executor.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                next.invokeChannelRead(m);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h3><h4 id="è¿æ¥æ“ä½œ"><a href="#è¿æ¥æ“ä½œ" class="headerlink" title="è¿æ¥æ“ä½œ"></a>è¿æ¥æ“ä½œ</h4><p>Channel ç±» APIï¼š</p>
<ul>
<li><code>ChannelFuture close()</code>ï¼šå…³é—­é€šé“</li>
<li><code>ChannelPipeline pipeline()</code>ï¼šæ·»åŠ å¤„ç†å™¨</li>
<li><code>ChannelFuture write(Object msg)</code>ï¼šæ•°æ®å†™å…¥ç¼“å†²åŒº</li>
<li><code>ChannelFuture writeAndFlush(Object msg)</code>ï¼šæ•°æ®å†™å…¥ç¼“å†²åŒºå¹¶ä¸”åˆ·å‡º</li>
</ul>
<p>ChannelFuture ç±» APIï¼š</p>
<ul>
<li><code>ChannelFuture sync()</code>ï¼šåŒæ­¥é˜»å¡ç­‰å¾…è¿æ¥æˆåŠŸ</li>
<li><code>ChannelFuture addListener(GenericFutureListener listener)</code>ï¼šå¼‚æ­¥ç­‰å¾…</li>
</ul>
<p>ä»£ç å®ç°ï¼š</p>
<ul>
<li>connect æ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œä¸ç­‰è¿æ¥å»ºç«‹å®Œæˆå°±è¿”å›ï¼Œå› æ­¤ channelFuture å¯¹è±¡ä¸­ä¸èƒ½ç«‹åˆ»è·å¾—åˆ°æ­£ç¡®çš„ Channel å¯¹è±¡ï¼Œéœ€è¦ç­‰å¾…</li>
<li>è¿æ¥æœªå»ºç«‹ channel æ‰“å°ä¸º <code>[id: 0x2e1884dd]</code>ï¼›å»ºç«‹æˆåŠŸæ‰“å°ä¸º <code>[id: 0x2e1884dd, L:/127.0.0.1:57191 - R:/127.0.0.1:8080]</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChannelClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">                .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>())</span><br><span class="line">                .channel(NioSocketChannel.class)</span><br><span class="line">                .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 1. è¿æ¥æœåŠ¡å™¨ï¼Œã€å¼‚æ­¥éé˜»å¡ã€‘ï¼Œmain è°ƒç”¨ connect æ–¹æ³•ï¼ŒçœŸæ­£æ‰§è¡Œè¿æ¥çš„æ˜¯ nio çº¿ç¨‹</span></span><br><span class="line">                .connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>));</span><br><span class="line">        <span class="comment">// 2.1 ä½¿ç”¨ sync æ–¹æ³•ã€åŒæ­¥ã€‘å¤„ç†ç»“æœï¼Œé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ° nio çº¿ç¨‹è¿æ¥å»ºç«‹å®Œæ¯•</span></span><br><span class="line">        channelFuture.sync();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> channelFuture.channel();</span><br><span class="line">        System.out.println(channel); <span class="comment">// ã€æ‰“å°ã€‘</span></span><br><span class="line">        <span class="comment">// å‘æœåŠ¡å™¨å‘é€æ•°æ®</span></span><br><span class="line">        channel.writeAndFlush(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">        </span><br><span class="line">**************************************************************************************äºŒé€‰ä¸€</span><br><span class="line">        <span class="comment">// 2.2 ä½¿ç”¨ addListener æ–¹æ³•ã€å¼‚æ­¥ã€‘å¤„ç†ç»“æœ</span></span><br><span class="line">        channelFuture.addListener(<span class="keyword">new</span> <span class="title class_">ChannelFutureListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="comment">// nio çº¿ç¨‹è¿æ¥å»ºç«‹å¥½ä»¥åï¼Œå›è°ƒè¯¥æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">                    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> future.channel();</span><br><span class="line">                	channel.writeAndFlush(<span class="string">&quot;hello, world&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// å»ºç«‹å¤±è´¥ï¼Œéœ€è¦å…³é—­</span></span><br><span class="line">                    future.channel().close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="å…³é—­æ“ä½œ"><a href="#å…³é—­æ“ä½œ" class="headerlink" title="å…³é—­æ“ä½œ"></a>å…³é—­æ“ä½œ</h4><p>å…³é—­ EventLoopGroup çš„è¿è¡Œï¼Œåˆ†ä¸ºåŒæ­¥å…³é—­å’Œå¼‚æ­¥å…³é—­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CloseFutureClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">                <span class="comment">// ....</span></span><br><span class="line">                .connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>));</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> channelFuture.sync().channel();</span><br><span class="line">        <span class="comment">// å‘é€æ•°æ®</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> sc.nextLine();</span><br><span class="line">                <span class="keyword">if</span> (line.equals(<span class="string">&quot;q&quot;</span>)) &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                channel.writeAndFlush(line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;input&quot;</span>).start();</span><br><span class="line">        <span class="comment">// è·å– CloseFuture å¯¹è±¡</span></span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">closeFuture</span> <span class="operator">=</span> channel.closeFuture();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. åŒæ­¥å¤„ç†å…³é—­</span></span><br><span class="line">        System.out.println(<span class="string">&quot;waiting close...&quot;</span>);</span><br><span class="line">        closeFuture.sync();</span><br><span class="line">        System.out.println(<span class="string">&quot;å¤„ç†å…³é—­åçš„æ“ä½œ&quot;</span>);</span><br><span class="line">****************************************************</span><br><span class="line">        <span class="comment">// 2. å¼‚æ­¥å¤„ç†å…³é—­</span></span><br><span class="line">        closeFuture.addListener(<span class="keyword">new</span> <span class="title class_">ChannelFutureListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;å¤„ç†å…³é—­åçš„æ“ä½œ&quot;</span>);</span><br><span class="line">                group.shutdownGracefully();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h3><h4 id="åŸºæœ¬ä»‹ç»-3"><a href="#åŸºæœ¬ä»‹ç»-3" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h4><p>Netty ä¸­çš„ Future ä¸ JDK ä¸­çš„ Future åŒåï¼Œä½†æ˜¯åŠŸèƒ½çš„å®ç°ä¸åŒ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.netty.util.concurrent;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Future</span>&lt;V&gt; <span class="keyword">extends</span> <span class="title class_">java</span>.util.concurrent.Future&lt;V&gt;</span><br></pre></td></tr></table></figure>
<p>Future ç±» APIï¼š</p>
<ul>
<li><code>V get()</code>ï¼šé˜»å¡ç­‰å¾…è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ</li>
<li><code>V getNow()</code>ï¼šéé˜»å¡è·å–ä»»åŠ¡ç»“æœï¼Œè¿˜æœªäº§ç”Ÿç»“æœæ—¶è¿”å› null</li>
<li><code>Throwable cause()</code>ï¼šéé˜»å¡è·å–å¤±è´¥ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰å¤±è´¥ï¼Œè¿”å› null</li>
<li><code>Future&lt;V&gt; sync()</code>ï¼šç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</li>
<li><code>boolean cancel(boolean mayInterruptIfRunning)</code>ï¼šå–æ¶ˆä»»åŠ¡</li>
<li><code>Future&lt;V&gt; addListener(GenericFutureListener listener)</code>ï¼šæ·»åŠ å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ</li>
<li><code>boolean isSuccess()</code>ï¼šåˆ¤æ–­ä»»åŠ¡æ˜¯å¦æˆåŠŸ</li>
<li><code>boolean isCancellable()</code>ï¼šåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å–æ¶ˆ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyFutureDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoop</span> <span class="variable">eventLoop</span> <span class="operator">=</span> group.next();</span><br><span class="line">        Future&lt;Integer&gt; future = eventLoop.submit(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Integer <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ‰§è¡Œè®¡ç®—&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">70</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        future.getNow();</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot;ç­‰å¾…ç»“æœ&quot;</span>);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot;&quot;</span> + future.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="æ‰©å±•å­ç±»"><a href="#æ‰©å±•å­ç±»" class="headerlink" title="æ‰©å±•å­ç±»"></a>æ‰©å±•å­ç±»</h4><p>Promise ç±»æ˜¯ Future çš„å­ç±»ï¼Œå¯ä»¥è„±ç¦»ä»»åŠ¡ç‹¬ç«‹å­˜åœ¨ï¼Œä½œä¸ºä¸¤ä¸ªçº¿ç¨‹é—´ä¼ é€’ç»“æœçš„å®¹å™¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Promise</span>&lt;V&gt; <span class="keyword">extends</span> <span class="title class_">Future</span>&lt;V&gt;</span><br></pre></td></tr></table></figure>
<p>Promise ç±» APIï¼š</p>
<ul>
<li><code>Promise&lt;V&gt; setSuccess(V result)</code>ï¼šè®¾ç½®æˆåŠŸç»“æœ</li>
<li><code>Promise&lt;V&gt; setFailure(Throwable cause)</code>ï¼šè®¾ç½®å¤±è´¥ç»“æœ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyPromiseDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. å‡†å¤‡ EventLoop å¯¹è±¡</span></span><br><span class="line">        <span class="type">EventLoop</span> <span class="variable">eventLoop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>().next();</span><br><span class="line">        <span class="comment">// 2. ä¸»åŠ¨åˆ›å»º promise</span></span><br><span class="line">        DefaultPromise&lt;Integer&gt; promise = <span class="keyword">new</span> <span class="title class_">DefaultPromise</span>&lt;&gt;(eventLoop);</span><br><span class="line">        <span class="comment">// 3. ä»»æ„ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè®¡ç®—ï¼Œè®¡ç®—å®Œæ¯•åå‘ promise å¡«å……ç»“æœ</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            promise.setSuccess(<span class="number">200</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. æ¥å—ç»“æœçš„çº¿ç¨‹</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot;ç­‰å¾…ç»“æœ&quot;</span>);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot;&quot;</span> + promise.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h3><p>ChannelHandler ç”¨æ¥å¤„ç† Channel ä¸Šçš„å„ç§äº‹ä»¶ï¼Œåˆ†ä¸ºå…¥ç«™å‡ºç«™ä¸¤ç§ï¼Œæ‰€æœ‰ ChannelHandler è¿æ¥æˆåŒå‘é“¾è¡¨å°±æ˜¯ Pipeline</p>
<ul>
<li>å…¥ç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelInboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦ç”¨æ¥è¯»å–å®¢æˆ·ç«¯æ•°æ®ï¼Œå†™å›ç»“æœ</li>
<li>å‡ºç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelOutboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦å¯¹å†™å›ç»“æœè¿›è¡ŒåŠ å·¥ï¼ˆå…¥ç«™å’Œå‡ºç«™æ˜¯å¯¹äºæœåŠ¡ç«¯æ¥è¯´çš„ï¼‰</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>()</span><br><span class="line">        .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>())</span><br><span class="line">        .channel(NioServerSocketChannel.class)</span><br><span class="line">        .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="comment">// 1. é€šè¿‡ channel æ‹¿åˆ° pipeline</span></span><br><span class="line">                <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                <span class="comment">// 2. æ·»åŠ å¤„ç†å™¨ head -&gt; h1 -&gt; h2 -&gt; h3 -&gt; h4 -&gt; tail</span></span><br><span class="line">                pipeline.addLast(<span class="string">&quot;h1&quot;</span>, <span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">                        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> buf.toString(Charset.defaultCharset());</span><br><span class="line">                        <span class="comment">// å°†æ•°æ®ä¼ é€’ç»™ä¸‹ä¸€ä¸ªã€å…¥ç«™ã€‘handlerï¼Œå¦‚æœä¸è°ƒç”¨è¯¥æ–¹æ³•åˆ™é“¾ä¼šæ–­å¼€</span></span><br><span class="line">                        <span class="built_in">super</span>.channelRead(ctx, s);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                pipeline.addLast(<span class="string">&quot;h2&quot;</span>, <span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">                        <span class="comment">// ä»ã€å°¾éƒ¨å¼€å§‹å‘å‰è§¦å‘ã€‘å‡ºç«™å¤„ç†å™¨</span></span><br><span class="line">                        ch.writeAndFlush(ctx.alloc().buffer().writeBytes(<span class="string">&quot;server&quot;</span>.getBytes()));</span><br><span class="line">                        <span class="comment">// è¯¥æ–¹æ³•ä¼šè®©ç®¡é“ä»ã€å½“å‰ handler å‘å‰ã€‘å¯»æ‰¾å‡ºç«™å¤„ç†å™¨</span></span><br><span class="line">                        <span class="comment">// ctx.writeAndFlush();</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                pipeline.addLast(<span class="string">&quot;h3&quot;</span>, <span class="keyword">new</span> <span class="title class_">ChannelOutboundHandlerAdapter</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        log.debug(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">                        <span class="built_in">super</span>.write(ctx, msg, promise);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                pipeline.addLast(<span class="string">&quot;h4&quot;</span>, <span class="keyword">new</span> <span class="title class_">ChannelOutboundHandlerAdapter</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        log.debug(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">                        <span class="built_in">super</span>.write(ctx, msg, promise);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .bind(<span class="number">8080</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœåŠ¡å™¨ç«¯ä¾æ¬¡æ‰“å°ï¼š1 2 4 3 ï¼Œæ‰€ä»¥<strong>å…¥ç«™æ˜¯æŒ‰ç…§ addLast çš„é¡ºåºæ‰§è¡Œçš„ï¼Œå‡ºç«™æ˜¯æŒ‰ç…§ addLast çš„é€†åºæ‰§è¡Œ</strong></p>
<p>ä¸€ä¸ª Channel åŒ…å«äº†ä¸€ä¸ª ChannelPipelineï¼Œè€Œ ChannelPipeline ä¸­åˆç»´æŠ¤äº†ä¸€ä¸ªç”± ChannelHandlerContext ç»„æˆçš„åŒå‘é“¾è¡¨ï¼Œå¹¶ä¸”æ¯ä¸ª ChannelHandlerContext ä¸­å…³è”ç€ä¸€ä¸ª ChannelHandler</p>
<p>å…¥ç«™äº‹ä»¶å’Œå‡ºç«™äº‹ä»¶åœ¨ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸­ï¼Œä¸¤ç§ç±»å‹çš„ handler äº’ä¸å¹²æ‰°ï¼š</p>
<ul>
<li>å…¥ç«™äº‹ä»¶ä¼šä»é“¾è¡¨ head å¾€åä¼ é€’åˆ°æœ€åä¸€ä¸ªå…¥ç«™çš„ handler</li>
<li>å‡ºç«™äº‹ä»¶ä¼šä»é“¾è¡¨ tail å¾€å‰ä¼ é€’åˆ°æœ€å‰ä¸€ä¸ªå‡ºç«™çš„ handler</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Netty-ChannelPipeline.png" alt=""></p>
<hr>
<h3 id="ByteBuf"><a href="#ByteBuf" class="headerlink" title="ByteBuf"></a>ByteBuf</h3><h4 id="åŸºæœ¬ä»‹ç»-4"><a href="#åŸºæœ¬ä»‹ç»-4" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h4><p>ByteBuf æ˜¯å¯¹å­—èŠ‚æ•°æ®çš„å°è£…ï¼Œä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ± åŒ–ï¼Œå¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œæ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½</li>
<li>è¯»å†™æŒ‡é’ˆåˆ†ç¦»ï¼Œä¸éœ€è¦åƒ ByteBuffer ä¸€æ ·åˆ‡æ¢è¯»å†™æ¨¡å¼</li>
<li>å¯ä»¥è‡ªåŠ¨æ‰©å®¹</li>
<li>æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œä½¿ç”¨æ›´æµç•…</li>
<li>é›¶æ‹·è´æ€æƒ³ï¼Œä¾‹å¦‚ sliceã€duplicateã€CompositeByteBuf</li>
</ul>
<hr>
<h4 id="åˆ›å»ºæ–¹æ³•"><a href="#åˆ›å»ºæ–¹æ³•" class="headerlink" title="åˆ›å»ºæ–¹æ³•"></a>åˆ›å»ºæ–¹æ³•</h4><p>åˆ›å»ºæ–¹å¼</p>
<ul>
<li><p><code>ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(10)</code>ï¼šåˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„ ByteBufï¼Œåˆå§‹å®¹é‡æ˜¯ 10</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ByteBuf <span class="title function_">buffer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (directByDefault) &#123;</span><br><span class="line">        <span class="keyword">return</span> directBuffer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> heapBuffer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>ByteBuf buffer = ByteBufAllocator.DEFAULT.heapBuffer(10)</code>ï¼šåˆ›å»ºæ± åŒ–åŸºäºå †çš„ ByteBuf</p>
</li>
<li><p><code>ByteBuf buffer = ByteBufAllocator.DEFAULT.directBuffer(10)</code>ï¼šåˆ›å»ºæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBuf</p>
</li>
<li><p><strong>æ¨è</strong>çš„åˆ›å»ºæ–¹å¼ï¼šåœ¨æ·»åŠ å¤„ç†å™¨çš„æ–¹æ³•ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>ç›´æ¥å†…å­˜å¯¹æ¯”å †å†…å­˜ï¼š</p>
<ul>
<li>ç›´æ¥å†…å­˜åˆ›å»ºå’Œé”€æ¯çš„ä»£ä»·æ˜‚è´µï¼Œä½†è¯»å†™æ€§èƒ½é«˜ï¼ˆå°‘ä¸€æ¬¡å†…å­˜å¤åˆ¶ï¼‰ï¼Œé€‚åˆé…åˆæ± åŒ–åŠŸèƒ½ä¸€èµ·ç”¨</li>
<li>ç›´æ¥å†…å­˜å¯¹ GC å‹åŠ›å°ï¼Œå› ä¸ºè¿™éƒ¨åˆ†å†…å­˜ä¸å— JVM åƒåœ¾å›æ”¶çš„ç®¡ç†ï¼Œä½†ä¹Ÿè¦æ³¨æ„åŠæ—¶ä¸»åŠ¨é‡Šæ”¾</li>
</ul>
<p>æ± åŒ–çš„æ„ä¹‰åœ¨äºå¯ä»¥<strong>é‡ç”¨ ByteBuf</strong>ï¼Œé«˜å¹¶å‘æ—¶æ± åŒ–åŠŸèƒ½æ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½ï¼Œä¸éæ± åŒ–å¯¹æ¯”ï¼š</p>
<ul>
<li>éæ± åŒ–ï¼Œæ¯æ¬¡éƒ½è¦åˆ›å»ºæ–°çš„ ByteBuf å®ä¾‹ï¼Œè¿™ä¸ªæ“ä½œå¯¹ç›´æ¥å†…å­˜ä»£ä»·æ˜‚è´µï¼Œå †å†…å­˜ä¼šå¢åŠ  GC å‹åŠ›</li>
<li>æ± åŒ–ï¼Œå¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œå¹¶ä¸”é‡‡ç”¨äº†ä¸ jemalloc ç±»ä¼¼çš„å†…å­˜åˆ†é…ç®—æ³•æå‡åˆ†é…æ•ˆç‡</li>
</ul>
<p>æ± åŒ–åŠŸèƒ½çš„å¼€å¯ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„ç³»ç»Ÿç¯å¢ƒå˜é‡æ¥è®¾ç½®ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dio.netty.allocator.type=&#123;unpooled|pooled&#125;	 <span class="comment"># VM å‚æ•°</span></span><br></pre></td></tr></table></figure>
<ul>
<li>4.1 ä»¥åï¼Œé Android å¹³å°é»˜è®¤å¯ç”¨æ± åŒ–å®ç°ï¼ŒAndroid å¹³å°å¯ç”¨éæ± åŒ–å®ç°</li>
<li>4.1 ä¹‹å‰ï¼Œæ± åŒ–åŠŸèƒ½è¿˜ä¸æˆç†Ÿï¼Œé»˜è®¤æ˜¯éæ± åŒ–å®ç°</li>
</ul>
<hr>
<h4 id="è¯»å†™æ“ä½œ"><a href="#è¯»å†™æ“ä½œ" class="headerlink" title="è¯»å†™æ“ä½œ"></a>è¯»å†™æ“ä½œ</h4><p>ByteBuf ç”±å››éƒ¨åˆ†ç»„æˆï¼Œæœ€å¼€å§‹è¯»å†™æŒ‡é’ˆï¼ˆ<strong>åŒæŒ‡é’ˆ</strong>ï¼‰éƒ½åœ¨ 0 ä½ç½®</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Netty-ByteBufç»„æˆ.png" alt=""></p>
<p>å†™å…¥æ–¹æ³•ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>è¯´æ˜</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>writeBoolean(boolean value)</td>
<td>å†™å…¥ boolean å€¼</td>
<td>ç”¨ä¸€å­—èŠ‚ 01\</td>
<td>00 ä»£è¡¨ true\</td>
<td>false</td>
</tr>
<tr>
<td>writeByte(int value)</td>
<td>å†™å…¥ byte å€¼</td>
<td></td>
</tr>
<tr>
<td>writeInt(int value)</td>
<td>å†™å…¥ int å€¼</td>
<td>Big Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 00 00 02 50</td>
</tr>
<tr>
<td>writeIntLE(int value)</td>
<td>å†™å…¥ int å€¼</td>
<td>Little Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 50 02 00 00</td>
</tr>
<tr>
<td>writeBytes(ByteBuf src)</td>
<td>å†™å…¥ ByteBuf</td>
<td></td>
</tr>
<tr>
<td>writeBytes(byte[] src)</td>
<td>å†™å…¥ byte[]</td>
<td></td>
</tr>
<tr>
<td>writeBytes(ByteBuffer src)</td>
<td>å†™å…¥ NIO çš„ ByteBuffer</td>
<td></td>
</tr>
<tr>
<td>int writeCharSequence(CharSequence s, Charset c)</td>
<td>å†™å…¥å­—ç¬¦ä¸²</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>è¿™äº›æ–¹æ³•çš„æœªæŒ‡æ˜è¿”å›å€¼çš„ï¼Œå…¶è¿”å›å€¼éƒ½æ˜¯ ByteBufï¼Œæ„å‘³ç€å¯ä»¥é“¾å¼è°ƒç”¨</li>
<li>å†™å…¥å‡ ä½å†™æŒ‡é’ˆåç§»å‡ ä½ï¼ŒæŒ‡å‘å¯ä»¥å†™å…¥çš„ä½ç½®</li>
<li>ç½‘ç»œä¼ è¾“ï¼Œé»˜è®¤ä¹ æƒ¯æ˜¯ Big Endian</li>
</ul>
<p>æ‰©å®¹ï¼šå†™å…¥æ•°æ®æ—¶ï¼Œå®¹é‡ä¸å¤Ÿäº†ï¼ˆåˆå§‹å®¹é‡æ˜¯ 10ï¼‰ï¼Œè¿™æ—¶ä¼šå¼•å‘<strong>æ‰©å®¹</strong></p>
<ul>
<li>å¦‚æœå†™å…¥åæ•°æ®å¤§å°æœªè¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 16 çš„æ•´æ•°å€ï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 12 ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 16</li>
<li>å¦‚æœå†™å…¥åæ•°æ®å¤§å°è¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 2^nï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 513ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 2^10 = 1024ï¼ˆ2^9=512 ä¸å¤Ÿï¼‰</li>
<li>æ‰©å®¹ä¸èƒ½è¶…è¿‡ max capacity ä¼šæŠ¥é”™</li>
</ul>
<p>è¯»å–æ–¹æ³•ï¼š</p>
<ul>
<li><code>byte readByte()</code>ï¼šè¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œè¯»æŒ‡é’ˆåç§»</li>
<li><code>byte getByte(int index)</code>ï¼šè¯»å–æŒ‡å®šç´¢å¼•ä½ç½®çš„å­—èŠ‚ï¼Œè¯»æŒ‡é’ˆä¸åŠ¨</li>
<li><code>ByteBuf markReaderIndex()</code>ï¼šæ ‡è®°è¯»æ•°æ®çš„ä½ç½®</li>
<li><code>ByteBuf resetReaderIndex()</code>ï¼šé‡ç½®åˆ°æ ‡è®°ä½ç½®ï¼Œå¯ä»¥é‡å¤è¯»å–æ ‡è®°ä½ç½®å‘åçš„æ•°æ®</li>
</ul>
<hr>
<h4 id="å†…å­˜é‡Šæ”¾"><a href="#å†…å­˜é‡Šæ”¾" class="headerlink" title="å†…å­˜é‡Šæ”¾"></a>å†…å­˜é‡Šæ”¾</h4><p>Netty ä¸­ä¸‰ç§å†…å­˜çš„å›æ”¶ï¼š</p>
<ul>
<li>UnpooledHeapByteBuf ä½¿ç”¨çš„æ˜¯ JVM å†…å­˜ï¼Œåªéœ€ç­‰ GC å›æ”¶å†…å­˜</li>
<li>UnpooledDirectByteBuf ä½¿ç”¨çš„å°±æ˜¯ç›´æ¥å†…å­˜äº†ï¼Œéœ€è¦ç‰¹æ®Šçš„æ–¹æ³•æ¥å›æ”¶å†…å­˜</li>
<li>PooledByteBuf å’Œå­ç±»ä½¿ç”¨äº†æ± åŒ–æœºåˆ¶ï¼Œéœ€è¦æ›´å¤æ‚çš„è§„åˆ™æ¥å›æ”¶å†…å­˜</li>
</ul>
<p>Netty é‡‡ç”¨äº†å¼•ç”¨è®¡æ•°æ³•æ¥æ§åˆ¶å›æ”¶å†…å­˜ï¼Œæ¯ä¸ª ByteBuf éƒ½å®ç°äº† ReferenceCounted æ¥å£ï¼Œå›æ”¶çš„è§„åˆ™ï¼š</p>
<ul>
<li>æ¯ä¸ª ByteBuf å¯¹è±¡çš„åˆå§‹è®¡æ•°ä¸º 1</li>
<li>è°ƒç”¨ release æ–¹æ³•è®¡æ•°å‡ 1ï¼Œå¦‚æœè®¡æ•°ä¸º 0ï¼ŒByteBuf å†…å­˜è¢«å›æ”¶</li>
<li>è°ƒç”¨ retain æ–¹æ³•è®¡æ•°åŠ  1ï¼Œè¡¨ç¤ºè°ƒç”¨è€…æ²¡ç”¨å®Œä¹‹å‰ï¼Œå…¶å®ƒ handler å³ä½¿è°ƒç”¨äº† release ä¹Ÿä¸ä¼šé€ æˆå›æ”¶</li>
<li>å½“è®¡æ•°ä¸º 0 æ—¶ï¼Œåº•å±‚å†…å­˜ä¼šè¢«å›æ”¶ï¼Œè¿™æ—¶å³ä½¿ ByteBuf å¯¹è±¡è¿˜åœ¨ï¼Œå…¶å„ä¸ªæ–¹æ³•å‡æ— æ³•æ­£å¸¸ä½¿ç”¨</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> .ByteBufAllocator.DEFAULT.buffer(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// é€»è¾‘å¤„ç†</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    buf.release();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Pipeline çš„å­˜åœ¨ï¼Œéœ€è¦å°† ByteBuf ä¼ é€’ç»™ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¦‚æœåœ¨ finally ä¸­ release äº†ï¼Œå°±å¤±å»äº†ä¼ é€’æ€§ï¼Œå¤„ç†è§„åˆ™ï¼š</p>
<ul>
<li><p>åˆ›å»º ByteBuf æ”¾å…¥ Pipeline</p>
</li>
<li><p>å…¥ç«™ ByteBuf å¤„ç†åŸåˆ™</p>
<ul>
<li><p>å¯¹åŸå§‹ ByteBuf ä¸åšå¤„ç†ï¼Œè°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œè¿™æ—¶æ— é¡» releaseï¼Œåä¹‹ä¸ä¼ é€’éœ€è¦</p>
</li>
<li><p>å°†åŸå§‹ ByteBuf è½¬æ¢ä¸ºå…¶å®ƒç±»å‹çš„ Java å¯¹è±¡ï¼Œè¿™æ—¶ ByteBuf å°±æ²¡ç”¨äº†ï¼Œæ­¤æ—¶å¿…é¡» release</p>
</li>
<li><p>å¦‚æœå‡ºç°å¼‚å¸¸ï¼ŒByteBuf æ²¡æœ‰æˆåŠŸä¼ é€’åˆ°ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¿…é¡» release</p>
</li>
<li><p>å‡è®¾æ¶ˆæ¯ä¸€ç›´å‘åä¼ ï¼Œé‚£ä¹ˆ TailContext ä¼šè´Ÿè´£é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯ï¼ˆåŸå§‹çš„ ByteBufï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// io.netty.channel.DefaultChannelPipeline#onUnhandledInboundMessage(java.lang.Object)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onUnhandledInboundMessage</span><span class="params">(Object msg)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        logger.debug();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ReferenceCountUtil.release(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// io.netty.util.ReferenceCountUtil#release(java.lang.Object)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(Object msg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> ReferenceCounted) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((ReferenceCounted) msg).release();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>å‡ºç«™ ByteBuf å¤„ç†åŸåˆ™</p>
<ul>
<li>å‡ºç«™æ¶ˆæ¯æœ€ç»ˆéƒ½ä¼šè½¬ä¸º ByteBuf è¾“å‡ºï¼Œä¸€ç›´å‘å‰ä¼ ï¼Œç”± HeadContext flush å release</li>
</ul>
</li>
<li><p>ä¸ç¡®å®š ByteBuf è¢«å¼•ç”¨äº†å¤šå°‘æ¬¡ï¼Œä½†åˆå¿…é¡»å½»åº•é‡Šæ”¾ï¼Œå¯ä»¥å¾ªç¯è°ƒç”¨ release ç›´åˆ°è¿”å› true</p>
</li>
</ul>
<hr>
<h4 id="æ‹·è´æ“ä½œ"><a href="#æ‹·è´æ“ä½œ" class="headerlink" title="æ‹·è´æ“ä½œ"></a>æ‹·è´æ“ä½œ</h4><p>é›¶æ‹·è´æ–¹æ³•ï¼š</p>
<ul>
<li><p><code>ByteBuf slice(int index, int length)</code>ï¼šå¯¹åŸå§‹ ByteBuf è¿›è¡Œåˆ‡ç‰‡æˆå¤šä¸ª ByteBufï¼Œåˆ‡ç‰‡åçš„ ByteBuf å¹¶æ²¡æœ‰å‘ç”Ÿå†…å­˜å¤åˆ¶ï¼Œ<strong>å…±ç”¨åŸå§‹ ByteBuf çš„å†…å­˜</strong>ï¼Œåˆ‡ç‰‡åçš„ ByteBuf ç»´æŠ¤ç‹¬ç«‹çš„ readï¼Œwrite æŒ‡é’ˆ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer(<span class="number">10</span>);</span><br><span class="line">    buf.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>&#125;);</span><br><span class="line">    <span class="comment">// åœ¨åˆ‡ç‰‡è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰å‘ç”Ÿæ•°æ®å¤åˆ¶</span></span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">f1</span> <span class="operator">=</span> buf.slice(<span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line">    f1.retain();</span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">f2</span> <span class="operator">=</span> buf.slice(<span class="number">5</span>, <span class="number">5</span>);</span><br><span class="line">    f2.retain();</span><br><span class="line">    <span class="comment">// å¯¹ f1 è¿›è¡Œç›¸å…³çš„æ“ä½œä¹Ÿä¼šä½“ç°åœ¨ buf ä¸Š</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>ByteBuf duplicate()</code>ï¼šæˆªå–åŸå§‹ ByteBuf æ‰€æœ‰å†…å®¹ï¼Œå¹¶ä¸”æ²¡æœ‰ max capacity çš„é™åˆ¶ï¼Œä¹Ÿæ˜¯ä¸åŸå§‹ ByteBuf ä½¿ç”¨åŒä¸€å—åº•å±‚å†…å­˜ï¼Œåªæ˜¯è¯»å†™æŒ‡é’ˆæ˜¯ç‹¬ç«‹çš„</p>
</li>
<li><p><code>CompositeByteBuf addComponents(boolean increaseWriterIndex, ByteBuf... buffers)</code>ï¼šåˆå¹¶å¤šä¸ª ByteBuf</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buf1</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer();</span><br><span class="line">    buf1.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buf2</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer();</span><br><span class="line">    buf1.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">CompositeByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.compositeBuffer();</span><br><span class="line">    <span class="comment">// true è¡¨ç¤ºå¢åŠ æ–°çš„ ByteBuf è‡ªåŠ¨é€’å¢ write index, å¦åˆ™ write index ä¼šå§‹ç»ˆä¸º 0</span></span><br><span class="line">    buf.addComponents(<span class="literal">true</span>, buf1, buf2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CompositeByteBuf æ˜¯ä¸€ä¸ªç»„åˆçš„ ByteBufï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Component æ•°ç»„ï¼Œæ¯ä¸ª Component ç®¡ç†ä¸€ä¸ª ByteBufï¼Œè®°å½•äº†è¿™ä¸ª ByteBuf ç›¸å¯¹äºæ•´ä½“åç§»é‡ç­‰ä¿¡æ¯ï¼Œä»£è¡¨ç€æ•´ä½“ä¸­æŸä¸€æ®µçš„æ•°æ®</p>
<ul>
<li>ä¼˜ç‚¹ï¼šå¯¹å¤–æ˜¯ä¸€ä¸ªè™šæ‹Ÿè§†å›¾ï¼Œç»„åˆè¿™äº› ByteBuf ä¸ä¼šäº§ç”Ÿå†…å­˜å¤åˆ¶</li>
<li>ç¼ºç‚¹ï¼šå¤æ‚äº†å¾ˆå¤šï¼Œå¤šæ¬¡æ“ä½œä¼šå¸¦æ¥æ€§èƒ½çš„æŸè€—</li>
</ul>
</li>
</ul>
<p>æ·±æ‹·è´ï¼š</p>
<ul>
<li><code>ByteBuf copy()</code>ï¼šå°†åº•å±‚å†…å­˜æ•°æ®è¿›è¡Œæ·±æ‹·è´ï¼Œå› æ­¤æ— è®ºè¯»å†™ï¼Œéƒ½ä¸åŸå§‹ ByteBuf æ— å…³</li>
</ul>
<p>æ± åŒ–ç›¸å…³ï¼š</p>
<ul>
<li><p>Unpooled æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œæä¾›äº†éæ± åŒ–çš„ ByteBuf åˆ›å»ºã€ç»„åˆã€å¤åˆ¶ç­‰æ“ä½œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuf</span> <span class="variable">buf1</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer(<span class="number">5</span>);</span><br><span class="line">buf1.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;);</span><br><span class="line"><span class="type">ByteBuf</span> <span class="variable">buf2</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer(<span class="number">5</span>);</span><br><span class="line">buf2.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“åŒ…è£… ByteBuf ä¸ªæ•°è¶…è¿‡ä¸€ä¸ªæ—¶, åº•å±‚ä½¿ç”¨äº† CompositeByteBufï¼Œé›¶æ‹·è´æ€æƒ³</span></span><br><span class="line"><span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.wrappedBuffer(buf1, buf2);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="ç²˜åŒ…åŠåŒ…"><a href="#ç²˜åŒ…åŠåŒ…" class="headerlink" title="ç²˜åŒ…åŠåŒ…"></a>ç²˜åŒ…åŠåŒ…</h2><h3 id="ç°è±¡æ¼”ç¤º"><a href="#ç°è±¡æ¼”ç¤º" class="headerlink" title="ç°è±¡æ¼”ç¤º"></a>ç°è±¡æ¼”ç¤º</h3><p>åœ¨ TCP ä¼ è¾“ä¸­ï¼Œå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯æ—¶ï¼Œå®é™…ä¸Šæ˜¯å°†æ•°æ®å†™å…¥ TCP çš„ç¼“å­˜ï¼Œæ­¤æ—¶æ•°æ®çš„å¤§å°å’Œç¼“å­˜çš„å¤§å°å°±ä¼šé€ æˆç²˜åŒ…å’ŒåŠåŒ…</p>
<ul>
<li><p>å½“æ•°æ®è¶…è¿‡ TCP ç¼“å­˜å®¹é‡æ—¶ï¼Œå°±ä¼šè¢«æ‹†åˆ†æˆå¤šä¸ªåŒ…ï¼Œé€šè¿‡ Socket å¤šæ¬¡å‘é€åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ¯æ¬¡ä»ç¼“å­˜ä¸­å–æ•°æ®ï¼Œäº§ç”ŸåŠåŒ…é—®é¢˜</p>
</li>
<li><p>å½“æ•°æ®å°äº TCP ç¼“å­˜å®¹é‡æ—¶ï¼Œç¼“å­˜ä¸­å¯ä»¥å­˜æ”¾å¤šä¸ªåŒ…ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸€æ¬¡é€šä¿¡å°±å¯èƒ½ä¼ é€’å¤šä¸ªåŒ…ï¼Œè¿™æ—¶å€™æœåŠ¡ç«¯å°±å¯èƒ½ä¸€æ¬¡è¯»å–å¤šä¸ªåŒ…ï¼Œäº§ç”Ÿç²˜åŒ…çš„é—®é¢˜</p>
</li>
</ul>
<p>ä»£ç æ¼”ç¤ºï¼š</p>
<ul>
<li><p>å®¢æˆ·ç«¯ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        send();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.channel(NioSocketChannel.class);</span><br><span class="line">            bootstrap.group(worker);</span><br><span class="line">            bootstrap.handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                        <span class="comment">// ã€åœ¨è¿æ¥ channel å»ºç«‹æˆåŠŸåï¼Œä¼šè§¦å‘ active æ–¹æ³•ã€‘</span></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="comment">// å‘é€å†…å®¹éšæœºçš„æ•°æ®åŒ…</span></span><br><span class="line">                            <span class="type">Random</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">                            <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">                            <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                                <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">10</span>];</span><br><span class="line">                                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; r.nextInt(<span class="number">9</span>) + <span class="number">1</span>; j++) &#123;</span><br><span class="line">                                    bytes[j] = (<span class="type">byte</span>) c;</span><br><span class="line">                                &#125;</span><br><span class="line">                                c++;</span><br><span class="line">                                buf.writeBytes(bytes);</span><br><span class="line">                            &#125;</span><br><span class="line">                            ctx.writeAndFlush(buf);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;client error&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            worker.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æœåŠ¡å™¨ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">boss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.channel(NioServerSocketChannel.class);</span><br><span class="line">            <span class="comment">// è°ƒæ•´ç³»ç»Ÿçš„æ¥å—ç¼“å†²åŒºã€æ»‘åŠ¨çª—å£ã€‘</span></span><br><span class="line">            <span class="comment">//serverBootstrap.option(ChannelOption.SO_RCVBUF, 10);</span></span><br><span class="line">            <span class="comment">// è°ƒæ•´ netty çš„æ¥å—ç¼“å†²åŒºï¼ˆByteBufï¼‰</span></span><br><span class="line">            <span class="comment">//serverBootstrap.childOption(ChannelOption.RCVBUF_ALLOCATOR, </span></span><br><span class="line">            <span class="comment">//                            new AdaptiveRecvByteBufAllocator(16, 16, 16));</span></span><br><span class="line">            serverBootstrap.group(boss, worker);</span><br><span class="line">            serverBootstrap.childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    <span class="comment">// ã€è¿™é‡Œå¯ä»¥æ·»åŠ è§£ç å™¨ã€‘</span></span><br><span class="line">                    <span class="comment">// LoggingHandler ç”¨æ¥æ‰“å°æ¶ˆæ¯</span></span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> serverBootstrap.bind(<span class="number">8080</span>);</span><br><span class="line">            channelFuture.sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;server error&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            boss.shutdownGracefully();</span><br><span class="line">            worker.shutdownGracefully();</span><br><span class="line">            log.debug(<span class="string">&quot;stop&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç²˜åŒ…æ•ˆæœå±•ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">09:<span class="number">57</span>:<span class="number">27.140</span> [nioEventLoopGroup-<span class="number">3</span>-<span class="number">1</span>] DEBUG io.netty.handler.logging.LoggingHandler - [id: <span class="number">0xddbaaef6</span>, L:/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span> - R:/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8701</span>] READ: 100B	<span class="comment">// è¯»äº† 100 å­—èŠ‚ï¼Œå‘ç”Ÿç²˜åŒ…</span></span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|<span class="number">00000000</span>| <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">31</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> |<span class="number">00000.</span>...<span class="number">.1</span>.....|</span><br><span class="line">|<span class="number">00000010</span>| <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">32</span> <span class="number">32</span> <span class="number">32</span> <span class="number">32</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">33</span> <span class="number">00</span> |...<span class="number">.2222</span>.....<span class="number">.3</span>.|</span><br><span class="line">|<span class="number">00000020</span>| <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">34</span> <span class="number">34</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> |.......<span class="number">.44</span>......|</span><br><span class="line">|<span class="number">00000030</span>| <span class="number">00</span> <span class="number">00</span> <span class="number">35</span> <span class="number">35</span> <span class="number">35</span> <span class="number">35</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">36</span> <span class="number">36</span> <span class="number">36</span> <span class="number">00</span> |.<span class="number">.5555</span>.....<span class="number">.666</span>.|</span><br><span class="line">|<span class="number">00000040</span>| <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">37</span> <span class="number">37</span> <span class="number">37</span> <span class="number">37</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> |.....<span class="number">.7777</span>......|</span><br><span class="line">|<span class="number">00000050</span>| <span class="number">38</span> <span class="number">38</span> <span class="number">38</span> <span class="number">38</span> <span class="number">38</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">39</span> <span class="number">39</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> |<span class="number">88888.</span>...<span class="number">.99</span>....|</span><br><span class="line">|<span class="number">00000060</span>| <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                                     |....            |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>è§£å†³æ–¹æ³•ï¼šé€šè¿‡è°ƒæ•´ç³»ç»Ÿçš„æ¥å—ç¼“å†²åŒºçš„æ»‘åŠ¨çª—å£å’Œ Netty çš„æ¥å—ç¼“å†²åŒºä¿è¯æ¯æ¡åŒ…åªå«æœ‰ä¸€æ¡æ•°æ®ï¼Œæ»‘åŠ¨çª—å£çš„å¤§å°ä»…å†³å®šäº† Netty è¯»å–çš„<strong>æœ€å°å•ä½</strong>ï¼Œå®é™…æ¯æ¬¡è¯»å–çš„ä¸€èˆ¬æ˜¯å®ƒçš„æ•´æ•°å€</p>
<hr>
<h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><h4 id="çŸ­è¿æ¥"><a href="#çŸ­è¿æ¥" class="headerlink" title="çŸ­è¿æ¥"></a>çŸ­è¿æ¥</h4><p>å‘ä¸€ä¸ªåŒ…å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œè¿™æ ·è¿æ¥å»ºç«‹åˆ°è¿æ¥æ–­å¼€ä¹‹é—´å°±æ˜¯æ¶ˆæ¯çš„è¾¹ç•Œï¼Œç¼ºç‚¹å°±æ˜¯æ•ˆç‡å¾ˆä½</p>
<p>å®¢æˆ·ç«¯ä»£ç æ”¹é€ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ† 10 æ¬¡å‘é€</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            send();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="å›ºå®šé•¿åº¦"><a href="#å›ºå®šé•¿åº¦" class="headerlink" title="å›ºå®šé•¿åº¦"></a>å›ºå®šé•¿åº¦</h4><p>æœåŠ¡å™¨ç«¯åŠ å…¥å®šé•¿è§£ç å™¨ï¼Œæ¯ä¸€æ¡æ¶ˆæ¯é‡‡ç”¨å›ºå®šé•¿åº¦ã€‚å¦‚æœæ˜¯åŠåŒ…æ¶ˆæ¯ï¼Œä¼šç¼“å­˜åŠåŒ…æ¶ˆæ¯å¹¶ç­‰å¾…ä¸‹ä¸ªåŒ…åˆ°è¾¾ä¹‹åè¿›è¡Œæ‹¼åŒ…åˆå¹¶ï¼Œç›´åˆ°è¯»å–ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯åŒ…ï¼›å¦‚æœæ˜¯ç²˜åŒ…æ¶ˆæ¯ï¼Œç©ºä½™çš„ä½ç½®ä¼šè¿›è¡Œè¡¥ 0ï¼Œä¼šæµªè´¹ç©ºé—´</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">serverBootstrap.childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">FixedLengthFrameDecoder</span>(<span class="number">10</span>));</span><br><span class="line">        <span class="comment">// LoggingHandler ç”¨æ¥æ‰“å°æ¶ˆæ¯</span></span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">29</span>:<span class="number">06.522</span> [nioEventLoopGroup-<span class="number">3</span>-<span class="number">1</span>] DEBUG io.netty.handler.logging.LoggingHandler - [id: <span class="number">0x38a70fbf</span>, L:/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span> - R:/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">10144</span>] READ: 10B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|<span class="number">00000000</span>| <span class="number">31</span> <span class="number">31</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                   |<span class="number">11.</span>.......      |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line"><span class="number">10</span>:<span class="number">29</span>:<span class="number">06.522</span> [nioEventLoopGroup-<span class="number">3</span>-<span class="number">1</span>] DEBUG io.netty.handler.logging.LoggingHandler - [id: <span class="number">0x38a70fbf</span>, L:/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span> - R:/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">10144</span>] READ: 10B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|<span class="number">00000000</span>| <span class="number">32</span> <span class="number">32</span> <span class="number">32</span> <span class="number">32</span> <span class="number">32</span> <span class="number">32</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                   |<span class="number">222222.</span>...      |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="åˆ†éš”ç¬¦"><a href="#åˆ†éš”ç¬¦" class="headerlink" title="åˆ†éš”ç¬¦"></a>åˆ†éš”ç¬¦</h4><p>æœåŠ¡ç«¯åŠ å…¥è¡Œè§£ç å™¨ï¼Œé»˜è®¤ä»¥ <code>\n</code> æˆ– <code>\r\n</code> ä½œä¸ºåˆ†éš”ç¬¦ï¼Œå¦‚æœè¶…å‡ºæŒ‡å®šé•¿åº¦ä»æœªå‡ºç°åˆ†éš”ç¬¦ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">serverBootstrap.childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">FixedLengthFrameDecoder</span>(<span class="number">8</span>));</span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>å®¢æˆ·ç«¯åœ¨æ¯æ¡æ¶ˆæ¯ä¹‹åï¼ŒåŠ å…¥ <code>\n</code> åˆ†éš”ç¬¦ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Random</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= r.nextInt(<span class="number">16</span>)+<span class="number">1</span>; j++) &#123;</span><br><span class="line">            buffer.writeByte((<span class="type">byte</span>) c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 10 ä»£è¡¨ &#x27;\n&#x27;</span></span><br><span class="line">        buffer.writeByte(<span class="number">10</span>);</span><br><span class="line">        c++;</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.writeAndFlush(buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="é¢„è®¾é•¿åº¦"><a href="#é¢„è®¾é•¿åº¦" class="headerlink" title="é¢„è®¾é•¿åº¦"></a>é¢„è®¾é•¿åº¦</h4><p>LengthFieldBasedFrameDecoder è§£ç å™¨è‡ªå®šä¹‰é•¿åº¦è§£å†³ TCP ç²˜åŒ…é»åŒ…é—®é¢˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> maxFrameLength		<span class="comment">// æ•°æ®æœ€å¤§é•¿åº¦</span></span><br><span class="line"><span class="type">int</span> lengthFieldOffset 	<span class="comment">// é•¿åº¦å­—æ®µåç§»é‡ï¼Œä»ç¬¬å‡ ä¸ªå­—èŠ‚å¼€å§‹æ˜¯å†…å®¹çš„é•¿åº¦å­—æ®µ</span></span><br><span class="line"><span class="type">int</span> lengthFieldLength	<span class="comment">// é•¿åº¦å­—æ®µæœ¬èº«çš„é•¿åº¦</span></span><br><span class="line"><span class="type">int</span> lengthAdjustment 	<span class="comment">// é•¿åº¦å­—æ®µä¸ºåŸºå‡†ï¼Œå‡ ä¸ªå­—èŠ‚åæ‰æ˜¯å†…å®¹</span></span><br><span class="line"><span class="type">int</span> initialBytesToStrip	<span class="comment">// ä»å¤´å¼€å§‹å‰¥ç¦»å‡ ä¸ªå­—èŠ‚è§£ç åæ˜¾ç¤º</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lengthFieldOffset   = <span class="number">1</span> (= the length of HDR1)</span><br><span class="line">lengthFieldLength   = <span class="number">2</span></span><br><span class="line">lengthAdjustment    = <span class="number">1</span> (= the length of HDR2)</span><br><span class="line">initialBytesToStrip = <span class="number">3</span> (= the length of HDR1 + LEN)</span><br><span class="line"></span><br><span class="line">BEFORE <span class="title function_">DECODE</span> <span class="params">(<span class="number">16</span> bytes)</span>                       AFTER <span class="title function_">DECODE</span> <span class="params">(<span class="number">13</span> bytes)</span><span class="comment">//è§£ç </span></span><br><span class="line">+------+--------+------+----------------+      +------+----------------+</span><br><span class="line">| HDR1 | Length | HDR2 | Actual Content |-----&gt;| HDR2 | Actual Content |</span><br><span class="line">| <span class="number">0xCA</span> | <span class="number">0x000C</span> | <span class="number">0xFE</span> | <span class="string">&quot;HELLO, WORLD&quot;</span> |      | <span class="number">0xFE</span> | <span class="string">&quot;HELLO, WORLD&quot;</span> |</span><br><span class="line">+------+--------+------+----------------+      +------+----------------+</span><br></pre></td></tr></table></figure>
<p>ä»£ç å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LengthFieldDecoderDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">EmbeddedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EmbeddedChannel</span>(</span><br><span class="line">                <span class="comment">// int å  4 å­—èŠ‚ï¼Œç‰ˆæœ¬å·ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">LengthFieldBasedFrameDecoder</span>(<span class="number">1024</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">1</span>,<span class="number">5</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4 ä¸ªå­—èŠ‚çš„å†…å®¹é•¿åº¦ï¼Œ å®é™…å†…å®¹</span></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer();</span><br><span class="line">        send(buffer, <span class="string">&quot;Hello, world&quot;</span>);</span><br><span class="line">        send(buffer, <span class="string">&quot;Hi!&quot;</span>);</span><br><span class="line">        <span class="comment">// å†™å‡ºç¼“å­˜</span></span><br><span class="line">        channel.writeInbound(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å†™å…¥ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(ByteBuf buffer, String content)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = content.getBytes();  <span class="comment">// å®é™…å†…å®¹</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> bytes.length;          <span class="comment">// å®é™…å†…å®¹é•¿åº¦</span></span><br><span class="line">        buffer.writeInt(length);</span><br><span class="line">        buffer.writeByte(<span class="number">1</span>);                <span class="comment">// è¡¨ç¤ºç‰ˆæœ¬å·</span></span><br><span class="line">        buffer.writeBytes(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">49</span>:<span class="number">59.344</span> [main] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0xembedded, L:embedded - R:embedded] READ: 12B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|<span class="number">00000000</span>| <span class="number">48</span> <span class="number">65</span> 6c 6c <span class="number">6f</span> 2c <span class="number">20</span> <span class="number">77</span> <span class="number">6f</span> <span class="number">72</span> 6c <span class="number">64</span>             |Hello, world    |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line"><span class="number">10</span>:<span class="number">49</span>:<span class="number">59.344</span> [main] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0xembedded, L:embedded - R:embedded] READ: 3B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|<span class="number">00000000</span>| <span class="number">48</span> <span class="number">69</span> <span class="number">21</span>                                        |Hi!             |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="åè®®è®¾è®¡"><a href="#åè®®è®¾è®¡" class="headerlink" title="åè®®è®¾è®¡"></a>åè®®è®¾è®¡</h3><h4 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h4><p>è®¿é—® URLï¼š<a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080/</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">boss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.channel(NioServerSocketChannel.class);</span><br><span class="line">            serverBootstrap.group(boss, worker);</span><br><span class="line">            serverBootstrap.childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG));</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">HttpServerCodec</span>());</span><br><span class="line">                    <span class="comment">// åªé’ˆå¯¹æŸä¸€ç§ç±»å‹çš„è¯·æ±‚å¤„ç†ï¼Œæ­¤å¤„é’ˆå¯¹ HttpRequest</span></span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;HttpRequest&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, HttpRequest msg)</span> &#123;</span><br><span class="line">                            <span class="comment">// è·å–è¯·æ±‚</span></span><br><span class="line">                            log.debug(msg.uri());</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// è¿”å›å“åº”</span></span><br><span class="line">                            <span class="type">DefaultFullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(</span><br><span class="line">                                msg.protocolVersion(), HttpResponseStatus.OK);</span><br><span class="line"></span><br><span class="line">                            <span class="type">byte</span>[] bytes = <span class="string">&quot;&lt;h1&gt;Hello, world!&lt;/h1&gt;&quot;</span>.getBytes();</span><br><span class="line"></span><br><span class="line">                            response.headers().setInt(CONTENT_LENGTH, bytes.length);</span><br><span class="line">                            response.content().writeBytes(bytes);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// å†™å›å“åº”</span></span><br><span class="line">                            ctx.writeAndFlush(response);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> serverBootstrap.bind(<span class="number">8080</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;n3.server error&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            boss.shutdownGracefully();</span><br><span class="line">            worker.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="è‡ªå®šä¹‰"><a href="#è‡ªå®šä¹‰" class="headerlink" title="è‡ªå®šä¹‰"></a>è‡ªå®šä¹‰</h4><p>å¤„ç†å™¨ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageCodec</span> <span class="keyword">extends</span> <span class="title class_">ByteToMessageCodec</span>&lt;Message&gt; &#123;</span><br><span class="line">    <span class="comment">// ç¼–ç </span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, Message msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 4 å­—èŠ‚çš„é­”æ•°</span></span><br><span class="line">        out.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;);</span><br><span class="line">        <span class="comment">// 1 å­—èŠ‚çš„ç‰ˆæœ¬,</span></span><br><span class="line">        out.writeByte(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1</span></span><br><span class="line">        out.writeByte(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹</span></span><br><span class="line">        out.writeByte(msg.getMessageType());</span><br><span class="line">        <span class="comment">// 4 ä¸ªå­—èŠ‚</span></span><br><span class="line">        out.writeInt(msg.getSequenceId());</span><br><span class="line">        <span class="comment">// æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……, 1 å­—èŠ‚</span></span><br><span class="line">        out.writeByte(<span class="number">0xff</span>);</span><br><span class="line">        <span class="comment">// è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„ï¼Œmsg å¯¹è±¡åºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(msg);</span><br><span class="line">        <span class="type">byte</span>[] bytes = bos.toByteArray();</span><br><span class="line">        <span class="comment">// é•¿åº¦</span></span><br><span class="line">        out.writeInt(bytes.length);</span><br><span class="line">        <span class="comment">// å†™å…¥å†…å®¹</span></span><br><span class="line">        out.writeBytes(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£ç </span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">magicNum</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">version</span> <span class="operator">=</span> in.readByte();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">serializerType</span> <span class="operator">=</span> in.readByte();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">messageType</span> <span class="operator">=</span> in.readByte();</span><br><span class="line">        <span class="type">int</span> <span class="variable">sequenceId</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        in.readByte();</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line">        in.readBytes(bytes, <span class="number">0</span>, length);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes));</span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> (Message) ois.readObject();</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>, magicNum, version, serializerType, messageType, sequenceId, length);</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, message);</span><br><span class="line">        out.add(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">EmbeddedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EmbeddedChannel</span>(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(), <span class="keyword">new</span> <span class="title class_">MessageCodec</span>());</span><br><span class="line">    <span class="comment">// encode</span></span><br><span class="line">    <span class="type">LoginRequestMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginRequestMessage</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">    channel.writeOutbound(message);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// decode</span></span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">MessageCodec</span>().encode(<span class="literal">null</span>, message, buf);</span><br><span class="line">    <span class="comment">// å…¥ç«™</span></span><br><span class="line">    channel.writeInbound(buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginRequestMessage</span> <span class="keyword">extends</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">// set + get </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Netty-è‡ªå®šä¹‰åè®®.png" alt=""></p>
<hr>
<h4 id="Sharable"><a href="#Sharable" class="headerlink" title="Sharable"></a>Sharable</h4><p>@Sharable æ³¨è§£çš„æ·»åŠ æ—¶æœºï¼š</p>
<ul>
<li><p>å½“ handler ä¸ä¿å­˜çŠ¶æ€æ—¶ï¼Œå°±å¯ä»¥å®‰å…¨åœ°åœ¨å¤šçº¿ç¨‹ä¸‹è¢«å…±äº«</p>
</li>
<li><p>å¯¹äºç¼–è§£ç å™¨ç±»ä¸èƒ½ç»§æ‰¿ ByteToMessageCodec æˆ– CombinedChannelDuplexHandlerï¼Œå®ƒä»¬çš„æ„é€ æ–¹æ³•å¯¹ @Sharable æœ‰é™åˆ¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">ByteToMessageCodec</span><span class="params">(<span class="type">boolean</span> preferDirect)</span> &#123;</span><br><span class="line">    ensureNotSharable();</span><br><span class="line">    outboundMsgMatcher = TypeParameterMatcher.find(<span class="built_in">this</span>, ByteToMessageCodec.class, <span class="string">&quot;I&quot;</span>);</span><br><span class="line">    encoder = <span class="keyword">new</span> <span class="title class_">Encoder</span>(preferDirect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">ensureNotSharable</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœç±»ä¸Šæœ‰è¯¥æ³¨è§£</span></span><br><span class="line">    <span class="keyword">if</span> (isSharable()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¦‚æœèƒ½ç¡®ä¿ç¼–è§£ç å™¨ä¸ä¼šä¿å­˜çŠ¶æ€ï¼Œå¯ä»¥ç»§æ‰¿ MessageToMessageCodec çˆ¶ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"><span class="comment">// å¿…é¡»å’Œ LengthFieldBasedFrameDecoder ä¸€èµ·ä½¿ç”¨ï¼Œç¡®ä¿æ¥åˆ°çš„ ByteBuf æ¶ˆæ¯æ˜¯å®Œæ•´çš„</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageCodecSharable</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageCodec</span>&lt;ByteBuf, Message&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, Message msg, List&lt;Object&gt; outList)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">out</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">        <span class="comment">// 4 å­—èŠ‚çš„é­”æ•°</span></span><br><span class="line">        out.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;);</span><br><span class="line">		<span class="comment">// ....</span></span><br><span class="line">        outList.add(out);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="åœºæ™¯ä¼˜åŒ–"><a href="#åœºæ™¯ä¼˜åŒ–" class="headerlink" title="åœºæ™¯ä¼˜åŒ–"></a>åœºæ™¯ä¼˜åŒ–</h2><h3 id="ç©ºé—²æ£€æµ‹"><a href="#ç©ºé—²æ£€æµ‹" class="headerlink" title="ç©ºé—²æ£€æµ‹"></a>ç©ºé—²æ£€æµ‹</h3><h4 id="è¿æ¥å‡æ­»"><a href="#è¿æ¥å‡æ­»" class="headerlink" title="è¿æ¥å‡æ­»"></a>è¿æ¥å‡æ­»</h4><p>è¿æ¥å‡æ­»å°±æ˜¯å®¢æˆ·ç«¯æ•°æ®å‘ä¸å‡ºå»ï¼ŒæœåŠ¡ç«¯ä¹Ÿä¸€ç›´æ”¶ä¸åˆ°æ•°æ®ï¼Œä¿æŒè¿™ç§çŠ¶æ€ï¼Œå‡æ­»çš„è¿æ¥å ç”¨çš„èµ„æºä¸èƒ½è‡ªåŠ¨é‡Šæ”¾ï¼Œè€Œä¸”å‘å‡æ­»è¿æ¥å‘é€æ•°æ®ï¼Œå¾—åˆ°çš„åé¦ˆæ˜¯å‘é€è¶…æ—¶</p>
<p>è§£å†³æ–¹æ¡ˆï¼šæ¯éš”ä¸€æ®µæ—¶é—´å°±æ£€æŸ¥è¿™æ®µæ—¶é—´å†…æ˜¯å¦æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼Œæ²¡æœ‰å°±å¯ä»¥åˆ¤å®šä¸ºè¿æ¥å‡æ­»</p>
<p>IdleStateHandler æ˜¯ Netty æä¾›çš„å¤„ç†ç©ºé—²çŠ¶æ€çš„å¤„ç†å™¨ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯è¯»ç©ºé—²æ—¶é—´æˆ–å†™ç©ºé—²æ—¶é—´è¿‡é•¿</p>
<ul>
<li>å‚æ•°ä¸€ long readerIdleTimeï¼šè¯»ç©ºé—²ï¼Œè¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰è¯»</li>
<li>å‚æ•°äºŒ long writerIdleTimeï¼šå†™ç©ºé—²ï¼Œè¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰å†™</li>
<li>å‚æ•°ä¸‰ long allIdleTimeï¼šè¯»å†™ç©ºé—²ï¼Œè¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰è¯»å†™</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">serverBootstrap.childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LengthFieldBasedFrameDecoder</span>(<span class="number">1024</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">MessageCodec</span>());</span><br><span class="line">        <span class="comment">// 5s å†…å¦‚æœæ²¡æœ‰æ”¶åˆ° channel çš„æ•°æ®ï¼Œä¼šè§¦å‘ä¸€ä¸ª IdleState#READER_IDLE äº‹ä»¶ï¼Œ</span></span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(<span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">        <span class="comment">// ChannelDuplexHandler ã€å¯ä»¥åŒæ—¶ä½œä¸ºå…¥ç«™å’Œå‡ºç«™ã€‘å¤„ç†å™¨</span></span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelDuplexHandler</span>() &#123;</span><br><span class="line">            <span class="comment">// ç”¨æ¥è§¦å‘ç‰¹æ®Šäº‹ä»¶</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">                <span class="type">IdleStateEvent</span> <span class="variable">event</span> <span class="operator">=</span> (IdleStateEvent) evt;</span><br><span class="line">                <span class="comment">// è§¦å‘äº†è¯»ç©ºé—²äº‹ä»¶</span></span><br><span class="line">                <span class="keyword">if</span> (event.state() == IdleState.READER_IDLE) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;å·²ç» 5s æ²¡æœ‰è¯»åˆ°æ•°æ®äº†&quot;</span>);</span><br><span class="line">                    ctx.channel().close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="å¿ƒè·³æœºåˆ¶"><a href="#å¿ƒè·³æœºåˆ¶" class="headerlink" title="å¿ƒè·³æœºåˆ¶"></a>å¿ƒè·³æœºåˆ¶</h4><p>å®¢æˆ·ç«¯å®šæ—¶å‘æœåŠ¡å™¨ç«¯å‘é€æ•°æ®ï¼Œ<strong>æ—¶é—´é—´éš”è¦å°äºæœåŠ¡å™¨å®šä¹‰çš„ç©ºé—²æ£€æµ‹çš„æ—¶é—´é—´éš”</strong>ï¼Œå°±èƒ½é˜²æ­¢è¯¯åˆ¤è¿æ¥å‡æ­»ï¼Œè¿™å°±æ˜¯å¿ƒè·³æœºåˆ¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bootstrap.handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LengthFieldBasedFrameDecoder</span>(<span class="number">1024</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">MessageCodec</span>());</span><br><span class="line">        <span class="comment">// 3s å†…å¦‚æœæ²¡æœ‰å‘æœåŠ¡å™¨å†™æ•°æ®ï¼Œä¼šè§¦å‘ä¸€ä¸ª IdleState#WRITER_IDLE äº‹ä»¶</span></span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(<span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>));</span><br><span class="line">        <span class="comment">// ChannelDuplexHandler å¯ä»¥åŒæ—¶ä½œä¸ºå…¥ç«™å’Œå‡ºç«™å¤„ç†å™¨</span></span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelDuplexHandler</span>() &#123;</span><br><span class="line">            <span class="comment">// ç”¨æ¥è§¦å‘ç‰¹æ®Šäº‹ä»¶</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="type">IdleStateEvent</span> <span class="variable">event</span> <span class="operator">=</span> (IdleStateEvent) evt;</span><br><span class="line">                <span class="comment">// è§¦å‘äº†å†™ç©ºé—²äº‹ä»¶</span></span><br><span class="line">                <span class="keyword">if</span> (event.state() == IdleState.WRITER_IDLE) &#123;</span><br><span class="line">                    <span class="comment">// 3s æ²¡æœ‰å†™æ•°æ®äº†ï¼Œã€å‘é€ä¸€ä¸ªå¿ƒè·³åŒ…ã€‘</span></span><br><span class="line">                    ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">PingMessage</span>());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="åºåˆ—åŒ–"><a href="#åºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–"></a>åºåˆ—åŒ–</h3><h4 id="æ™®é€šæ–¹å¼"><a href="#æ™®é€šæ–¹å¼" class="headerlink" title="æ™®é€šæ–¹å¼"></a>æ™®é€šæ–¹å¼</h4><p>åºåˆ—åŒ–ï¼Œååºåˆ—åŒ–ä¸»è¦ç”¨åœ¨æ¶ˆæ¯æ­£æ–‡çš„è½¬æ¢ä¸Š</p>
<ul>
<li>åºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°† Java å¯¹è±¡å˜ä¸ºè¦ä¼ è¾“çš„æ•°æ®ï¼ˆå¯ä»¥æ˜¯ byte[]ï¼Œæˆ– json ç­‰ï¼Œæœ€ç»ˆéƒ½éœ€è¦å˜æˆ byte[]ï¼‰</li>
<li>ååºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°†ä¼ å…¥çš„æ­£æ–‡æ•°æ®è¿˜åŸæˆ Java å¯¹è±¡ï¼Œä¾¿äºå¤„ç†</li>
</ul>
<p>ä»£ç å®ç°ï¼š</p>
<ul>
<li><p>æŠ½è±¡ä¸€ä¸ª Serializer æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Serializer</span> &#123;</span><br><span class="line">    <span class="comment">// ååºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(Class&lt;T&gt; clazz, <span class="type">byte</span>[] bytes)</span>;</span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    &lt;T&gt; <span class="type">byte</span>[] serialize(T object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æä¾›ä¸¤ä¸ªå®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">SerializerAlgorithm</span> <span class="keyword">implements</span> <span class="title class_">Serializer</span> &#123;</span><br><span class="line">	<span class="comment">// Java å®ç°</span></span><br><span class="line">    Java &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(Class&lt;T&gt; clazz, <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes));</span><br><span class="line">                <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> in.readObject();</span><br><span class="line">                <span class="keyword">return</span> (T) object;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;SerializerAlgorithm.Java ååºåˆ—åŒ–é”™è¯¯&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> &lt;T&gt; <span class="type">byte</span>[] serialize(T object) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(out).writeObject(object);</span><br><span class="line">                <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;SerializerAlgorithm.Java åºåˆ—åŒ–é”™è¯¯&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="comment">// Json å®ç°(å¼•å…¥äº† Gson ä¾èµ–)</span></span><br><span class="line">    Json &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(Class&lt;T&gt; clazz, <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(<span class="keyword">new</span> <span class="title class_">String</span>(bytes, StandardCharsets.UTF_8), clazz);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> &lt;T&gt; <span class="type">byte</span>[] serialize(T object) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(object).getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éœ€è¦ä»åè®®çš„å­—èŠ‚ä¸­å¾—åˆ°æ˜¯å“ªç§åºåˆ—åŒ–ç®—æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SerializerAlgorithm <span class="title function_">getByInt</span><span class="params">(<span class="type">int</span> type)</span> &#123;</span><br><span class="line">        SerializerAlgorithm[] array = SerializerAlgorithm.values();</span><br><span class="line">        <span class="keyword">if</span> (type &lt; <span class="number">0</span> || type &gt; array.length - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;è¶…è¿‡ SerializerAlgorithm èŒƒå›´&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> array[type];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="ProtoBuf"><a href="#ProtoBuf" class="headerlink" title="ProtoBuf"></a>ProtoBuf</h4><h5 id="åŸºæœ¬ä»‹ç»-5"><a href="#åŸºæœ¬ä»‹ç»-5" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h5><p>Codecï¼ˆç¼–è§£ç å™¨ï¼‰çš„ç»„æˆéƒ¨åˆ†æœ‰ä¸¤ä¸ªï¼šDecoderï¼ˆè§£ç å™¨ï¼‰å’Œ Encoderï¼ˆç¼–ç å™¨ï¼‰ã€‚Encoder è´Ÿè´£æŠŠä¸šåŠ¡æ•°æ®è½¬æ¢æˆå­—èŠ‚ç æ•°æ®ï¼ŒDecoder è´Ÿè´£æŠŠå­—èŠ‚ç æ•°æ®è½¬æ¢æˆä¸šåŠ¡æ•°æ®</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Netty-ç¼–ç è§£ç .png" style="zoom: 67%;" /></p>
<p>Protobuf æ˜¯ Google å‘å¸ƒçš„å¼€æºé¡¹ç›®ï¼Œå…¨ç§°  Google Protocol Buffers ï¼Œæ˜¯ä¸€ç§è½»ä¾¿é«˜æ•ˆçš„ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œå¯ä»¥ç”¨äºç»“æ„åŒ–æ•°æ®ä¸²è¡ŒåŒ–ï¼Œæˆ–è€…è¯´åºåˆ—åŒ–ã€‚å¾ˆé€‚åˆåšæ•°æ®å­˜å‚¨æˆ– RPCï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ remote procedure callï¼‰æ•°æ®äº¤æ¢æ ¼å¼ã€‚ç›®å‰å¾ˆå¤šå…¬å¸ä» HTTP + Json è½¬å‘ TCP + Protobuf ï¼Œæ•ˆç‡ä¼šæ›´é«˜</p>
<p>Protobuf æ˜¯ä»¥ message çš„æ–¹å¼æ¥ç®¡ç†æ•°æ®ï¼Œæ”¯æŒè·¨å¹³å°ã€è·¨è¯­è¨€ï¼ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯å¯ä»¥æ˜¯ä¸åŒçš„è¯­è¨€ç¼–å†™çš„ï¼‰ï¼Œé«˜æ€§èƒ½ã€é«˜å¯é æ€§</p>
<p>å·¥ä½œè¿‡ç¨‹ï¼šä½¿ç”¨ Protobuf ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼ŒProtobuf æ˜¯å°†ç±»çš„å®šä¹‰ä½¿ç”¨ .proto æ–‡ä»¶è¿›è¡Œæè¿°ï¼Œç„¶åé€šè¿‡ protoc.exe ç¼–è¯‘å™¨æ ¹æ®  .proto è‡ªåŠ¨ç”Ÿæˆ .java æ–‡ä»¶</p>
<hr>
<h5 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h5><ul>
<li><p>å•ä¸ª messageï¼š</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>; 								<span class="comment">// ç‰ˆæœ¬</span></span><br><span class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">&quot;StudentPOJO&quot;</span>;	<span class="comment">// ç”Ÿæˆçš„å¤–éƒ¨ç±»åï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ–‡ä»¶å</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Student</span> &#123; 	<span class="comment">// åœ¨ StudentPOJO å¤–éƒ¨ç±»ç§ç”Ÿæˆä¸€ä¸ªå†…éƒ¨ç±» Studentï¼Œæ˜¯çœŸæ­£å‘é€çš„ POJO å¯¹è±¡</span></span><br><span class="line">    <span class="type">int32</span> id = <span class="number">1</span>; 	<span class="comment">// Student ç±»ä¸­æœ‰ä¸€ä¸ªå±æ€§ï¼šåå­—ä¸º id ç±»å‹ä¸º int32(protobufç±»å‹) ï¼Œ1è¡¨ç¤ºå±æ€§åºå·ï¼Œä¸æ˜¯å€¼</span></span><br><span class="line">    <span class="type">string</span> name = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Netty-Protobufç¼–è¯‘æ–‡ä»¶.png" style="zoom:80%;" /></p>
<p>ç¼–è¯‘ <code>protoc.exe --java_out=.Student.proto</code>ï¼ˆcmd çª—å£è¾“å…¥ï¼‰ å°†ç”Ÿæˆçš„ StudentPOJO æ”¾å…¥åˆ°é¡¹ç›®ä½¿ç”¨</p>
<p>Server ç«¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>() <span class="comment">//...</span></span><br><span class="line">    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;	<span class="comment">// åˆ›å»ºä¸€ä¸ªé€šé“åˆå§‹åŒ–å¯¹è±¡</span></span><br><span class="line">        <span class="comment">// ç»™pipeline è®¾ç½®å¤„ç†å™¨</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">// åœ¨pipelineåŠ å…¥ProtoBufDecoderï¼ŒæŒ‡å®šå¯¹å“ªç§å¯¹è±¡è¿›è¡Œè§£ç </span></span><br><span class="line">            ch.pipeline().addLast(<span class="string">&quot;decoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">ProtobufDecoder</span>(</span><br><span class="line">                							StudentPOJO.Student.getDefaultInstance()));</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">NettyServerHandler</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Client ç«¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Bootstrap</span>().group(group) 			<span class="comment">// è®¾ç½®çº¿ç¨‹ç»„</span></span><br><span class="line">    .channel(NioSocketChannel.class) 	<span class="comment">// è®¾ç½®å®¢æˆ·ç«¯é€šé“çš„å®ç°ç±»(åå°„)</span></span><br><span class="line">    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">// åœ¨pipelineä¸­åŠ å…¥ ProtoBufEncoder</span></span><br><span class="line">            ch.pipeline().addLast(<span class="string">&quot;encoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">ProtobufEncoder</span>());</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">NettyClientHandler</span>()); <span class="comment">// åŠ å…¥è‡ªå®šä¹‰çš„ä¸šåŠ¡å¤„ç†å™¨</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¤šä¸ª messageï¼šProtobuf å¯ä»¥ä½¿ç”¨ message ç®¡ç†å…¶ä»–çš„ messageã€‚å‡è®¾æŸä¸ªé¡¹ç›®éœ€è¦ä¼ è¾“ 20 ä¸ªå¯¹è±¡ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œå®šä¹‰ 20 ä¸ª messageï¼Œæœ€åå†ç”¨ä¸€ä¸ªæ€»çš„ message æ¥å†³å®šåœ¨å®é™…ä¼ è¾“æ—¶çœŸæ­£éœ€è¦ä¼ è¾“å“ªä¸€ä¸ªå¯¹è±¡</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> optimize_for = SPEED; 					<span class="comment">// åŠ å¿«è§£æ</span></span><br><span class="line"><span class="keyword">option</span> java_package=<span class="string">&quot;com.atguigu.netty.codec2&quot;</span>;	<span class="comment">// æŒ‡å®šç”Ÿæˆåˆ°å“ªä¸ªåŒ…ä¸‹</span></span><br><span class="line"><span class="keyword">option</span> java_outer_classname=<span class="string">&quot;MyDataInfo&quot;</span>; 		<span class="comment">// å¤–éƒ¨ç±»å, æ–‡ä»¶å</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">MyMessage</span> &#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰ä¸€ä¸ªæšä¸¾ç±»å‹ï¼ŒDataType å¦‚æœæ˜¯ 0 åˆ™è¡¨ç¤ºä¸€ä¸ª Student å¯¹è±¡å®ä¾‹ï¼ŒDataType è¿™ä¸ªåç§°è‡ªå®šä¹‰</span></span><br><span class="line">    <span class="keyword">enum </span><span class="title class_">DataType</span> &#123;</span><br><span class="line">        StudentType = <span class="number">0</span>; <span class="comment">//åœ¨ proto3 è¦æ±‚ enum çš„ç¼–å·ä» 0 å¼€å§‹</span></span><br><span class="line">        WorkerType = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨ data_type æ¥æ ‡è¯†ä¼ çš„æ˜¯å“ªä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œè¿™é‡Œæ‰çœŸæ­£å¼€å§‹å®šä¹‰ Message çš„æ•°æ®ç±»å‹</span></span><br><span class="line">    DataType data_type = <span class="number">1</span>;  <span class="comment">// æ‰€æœ‰åé¢çš„æ•°å­—éƒ½åªæ˜¯ç¼–å·è€Œå·²</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// oneof å…³é”®å­—ï¼Œè¡¨ç¤ºæ¯æ¬¡æšä¸¾ç±»å‹è¿›è¡Œä¼ è¾“æ—¶ï¼Œé™åˆ¶æœ€å¤šåªèƒ½ä¼ è¾“ä¸€ä¸ªå¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="comment">// dataBodyåç§°ä¹Ÿæ˜¯è‡ªå®šä¹‰çš„</span></span><br><span class="line">    <span class="comment">// MyMessage é‡Œå‡ºç°çš„ç±»å‹åªæœ‰ä¸¤ä¸ª DataType ç±»å‹ï¼ŒStudent æˆ–è€… Worker ç±»å‹ï¼Œåœ¨çœŸæ­£ä¼ è¾“çš„æ—¶å€™åªä¼šæœ‰ä¸€ä¸ªå‡ºç°</span></span><br><span class="line">    <span class="keyword">oneof</span> dataBody &#123;</span><br><span class="line">        Student student = <span class="number">2</span>;  <span class="comment">//æ³¨æ„è¿™åé¢çš„æ•°å­—ä¹Ÿéƒ½åªæ˜¯ç¼–å·è€Œå·²ï¼Œä¸Šé¢DataType data_type = 1  å äº†ç¬¬ä¸€ä¸ªåºå·äº†</span></span><br><span class="line">        Worker worker = <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="type">int32</span> id = <span class="number">1</span>;		<span class="comment">// Studentç±»çš„å±æ€§</span></span><br><span class="line">    <span class="type">string</span> name = <span class="number">2</span>; 	<span class="comment">//</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">message </span><span class="title class_">Worker</span> &#123;</span><br><span class="line">    <span class="type">string</span> name=<span class="number">1</span>;</span><br><span class="line">    <span class="type">int32</span> age=<span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘ï¼š</p>
<p>Server ç«¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch.pipeline().addLast(<span class="string">&quot;decoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">ProtobufDecoder</span>(MyDataInfo.MyMessage.getDefaultInstance()));</span><br></pre></td></tr></table></figure>
<p>Client ç«¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipeline.addLast(<span class="string">&quot;encoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">ProtobufEncoder</span>());</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="é•¿è¿æ¥"><a href="#é•¿è¿æ¥" class="headerlink" title="é•¿è¿æ¥"></a>é•¿è¿æ¥</h3><p>HTTP åè®®æ˜¯æ— çŠ¶æ€çš„ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨é—´çš„è¯·æ±‚å“åº”ä¸€æ¬¡ï¼Œä¸‹ä¸€æ¬¡ä¼šé‡æ–°åˆ›å»ºè¿æ¥ã€‚å®ç°åŸºäº WebSocket çš„é•¿è¿æ¥çš„å…¨åŒå·¥çš„äº¤äº’ï¼Œæ”¹å˜ HTTP åè®®å¤šæ¬¡è¯·æ±‚çš„çº¦æŸ</p>
<p>å¼€å‘éœ€æ±‚ï¼š</p>
<ul>
<li>å®ç°é•¿è¿æ¥ï¼ŒæœåŠ¡å™¨ä¸æµè§ˆå™¨ç›¸äº’é€šä¿¡å®¢æˆ·ç«¯</li>
<li>æµè§ˆå™¨å’ŒæœåŠ¡å™¨ç«¯ä¼šç›¸äº’æ„ŸçŸ¥ï¼Œæ¯”å¦‚æœåŠ¡å™¨å…³é—­äº†ï¼Œæµè§ˆå™¨ä¼šæ„ŸçŸ¥ï¼ŒåŒæ ·æµè§ˆå™¨å…³é—­äº†ï¼ŒæœåŠ¡å™¨ä¼šæ„ŸçŸ¥</li>
</ul>
<p>ä»£ç å®ç°ï¼š</p>
<ul>
<li><p>WebSocketï¼š</p>
<ul>
<li><p>WebSocket çš„æ•°æ®æ˜¯<strong>ä»¥å¸§ï¼ˆframeï¼‰å½¢å¼ä¼ é€’</strong>ï¼ŒWebSocketFrame ä¸‹é¢æœ‰å…­ä¸ªå­ç±»ï¼Œä»£è¡¨ä¸åŒçš„å¸§æ ¼å¼</p>
</li>
<li><p>æµè§ˆå™¨è¯·æ±‚ URLï¼šws://localhost:8080/xxx</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyWebSocket</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(bossGroup, workerGroup);</span><br><span class="line">            serverBootstrap.channel(NioServerSocketChannel.class);</span><br><span class="line">            serverBootstrap.handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO));</span><br><span class="line">            serverBootstrap.childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// åŸºäº http åè®®ï¼Œä½¿ç”¨ http çš„ç¼–ç å’Œè§£ç å™¨</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HttpServerCodec</span>());</span><br><span class="line">                    <span class="comment">// æ˜¯ä»¥å—æ–¹å¼å†™ï¼Œæ·»åŠ  ChunkedWriteHandler å¤„ç†å™¨</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ChunkedWriteHandler</span>());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// http æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯åˆ†æ®µ, HttpObjectAggregator å°±æ˜¯å¯ä»¥å°†å¤šä¸ªæ®µèšåˆ</span></span><br><span class="line">                    <span class="comment">//  è¿™å°±å°±æ˜¯ä¸ºä»€ä¹ˆï¼Œå½“æµè§ˆå™¨å‘é€å¤§é‡æ•°æ®æ—¶ï¼Œå°±ä¼šå‘å‡ºå¤šæ¬¡ http è¯·æ±‚</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">8192</span>));</span><br><span class="line">        </span><br><span class="line">                    <span class="comment">// WebSocketServerProtocolHandler æ ¸å¿ƒåŠŸèƒ½æ˜¯ã€å°† http åè®®å‡çº§ä¸º ws åè®®ã€‘ï¼Œä¿æŒé•¿è¿æ¥</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">WebSocketServerProtocolHandler</span>(<span class="string">&quot;/hello&quot;</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// è‡ªå®šä¹‰çš„handler ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">MyTextWebSocketFrameHandler</span>());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> serverBootstrap.bind(<span class="number">8080</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¤„ç†å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTextWebSocketFrameHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;TextWebSocketFrame&gt; &#123;</span><br><span class="line">    <span class="comment">// TextWebSocketFrame ç±»å‹ï¼Œè¡¨ç¤ºä¸€ä¸ªæ–‡æœ¬å¸§(frame)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, TextWebSocketFrame msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯ &quot;</span> + msg.text());</span><br><span class="line">        <span class="comment">// å›å¤æ¶ˆæ¯</span></span><br><span class="line">        ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">TextWebSocketFrame</span>(<span class="string">&quot;æœåŠ¡å™¨æ—¶é—´&quot;</span> + LocalDateTime.now() + <span class="string">&quot; &quot;</span> + msg.text()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“webå®¢æˆ·ç«¯è¿æ¥åï¼Œ è§¦å‘æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerAdded</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// id è¡¨ç¤ºå”¯ä¸€çš„å€¼ï¼ŒLongText æ˜¯å”¯ä¸€çš„ ShortText ä¸æ˜¯å”¯ä¸€</span></span><br><span class="line">        System.out.println(<span class="string">&quot;handlerAdded è¢«è°ƒç”¨&quot;</span> + ctx.channel().id().asLongText());</span><br><span class="line">        System.out.println(<span class="string">&quot;handlerAdded è¢«è°ƒç”¨&quot;</span> + ctx.channel().id().asShortText());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerRemoved</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;handlerRemoved è¢«è°ƒç”¨&quot;</span> + ctx.channel().id().asLongText());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å¼‚å¸¸å‘ç”Ÿ &quot;</span> + cause.getMessage());</span><br><span class="line">        ctx.close(); <span class="comment">// å…³é—­è¿æ¥</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>HTMLï¼š</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> socket;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// åˆ¤æ–­å½“å‰æµè§ˆå™¨æ˜¯å¦æ”¯æŒwebsocket</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">WebSocket</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//go on</span></span></span><br><span class="line"><span class="language-javascript">        socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://localhost:8080/hello&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//ç›¸å½“äºchannelReado, ev æ”¶åˆ°æœåŠ¡å™¨ç«¯å›é€çš„æ¶ˆæ¯</span></span></span><br><span class="line"><span class="language-javascript">        socket.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">ev</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> rt = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;responseText&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            rt.<span class="property">value</span> = rt.<span class="property">value</span> + <span class="string">&quot;\n&quot;</span> + ev.<span class="property">data</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//ç›¸å½“äºè¿æ¥å¼€å¯(æ„ŸçŸ¥åˆ°è¿æ¥å¼€å¯)</span></span></span><br><span class="line"><span class="language-javascript">        socket.<span class="property">onopen</span> = <span class="keyword">function</span> (<span class="params">ev</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> rt = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;responseText&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            rt.<span class="property">value</span> = <span class="string">&quot;è¿æ¥å¼€å¯äº†..&quot;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//ç›¸å½“äºè¿æ¥å…³é—­(æ„ŸçŸ¥åˆ°è¿æ¥å…³é—­)</span></span></span><br><span class="line"><span class="language-javascript">        socket.<span class="property">onclose</span> = <span class="keyword">function</span> (<span class="params">ev</span>) &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> rt = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;responseText&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            rt.<span class="property">value</span> = rt.<span class="property">value</span> + <span class="string">&quot;\n&quot;</span> + <span class="string">&quot;è¿æ¥å…³é—­äº†..&quot;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">alert</span>(<span class="string">&quot;å½“å‰æµè§ˆå™¨ä¸æ”¯æŒwebsocket&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">send</span>(<span class="params">message</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// å…ˆåˆ¤æ–­socketæ˜¯å¦åˆ›å»ºå¥½</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span>(!<span class="variable language_">window</span>.<span class="property">socket</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span>(socket.<span class="property">readyState</span> == <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// é€šè¿‡socket å‘é€æ¶ˆæ¯</span></span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">send</span>(message)</span></span><br><span class="line"><span class="language-javascript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="string">&quot;è¿æ¥æ²¡æœ‰å¼€å¯&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">onsubmit</span>=<span class="string">&quot;return false&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&quot;message&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 300px; width: 300px&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;å‘ç”Ÿæ¶ˆæ¯&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;send(this.form.message.value)&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;responseText&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 300px; width: 300px&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;æ¸…ç©ºå†…å®¹&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;document.getElementById(&#x27;responseText&#x27;).value=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="å‚æ•°è°ƒä¼˜"><a href="#å‚æ•°è°ƒä¼˜" class="headerlink" title="å‚æ•°è°ƒä¼˜"></a>å‚æ•°è°ƒä¼˜</h3><h4 id="CONNECT"><a href="#CONNECT" class="headerlink" title="CONNECT"></a>CONNECT</h4><p>å‚æ•°é…ç½®æ–¹å¼ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯é€šè¿‡ .option() æ–¹æ³•é…ç½®å‚æ•°ï¼Œç»™ SocketChannel é…ç½®å‚æ•°</li>
<li>æœåŠ¡å™¨ç«¯ï¼š<ul>
<li>new ServerBootstrap().option()ï¼š ç»™ ServerSocketChannel é…ç½®å‚æ•°</li>
<li>new ServerBootstrap().childOption()ï¼šç»™ SocketChannel é…ç½®å‚æ•°</li>
</ul>
</li>
</ul>
<p>CONNECT_TIMEOUT_MILLIS å‚æ•°ï¼š</p>
<ul>
<li>å±äº SocketChannal å‚æ•°</li>
<li><p>åœ¨å®¢æˆ·ç«¯å»ºç«‹è¿æ¥æ—¶ï¼Œå¦‚æœåœ¨æŒ‡å®šæ¯«ç§’å†…æ— æ³•è¿æ¥ï¼Œä¼šæŠ›å‡º timeout å¼‚å¸¸</p>
</li>
<li><p>SO_TIMEOUT ä¸»è¦ç”¨åœ¨é˜»å¡ IOï¼Œé˜»å¡ IO ä¸­ acceptï¼Œread ç­‰éƒ½æ˜¯æ— é™ç­‰å¾…çš„ï¼Œå¦‚æœä¸å¸Œæœ›æ°¸è¿œé˜»å¡ï¼Œå¯ä»¥è°ƒæ•´è¶…æ—¶æ—¶é—´</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionTimeoutTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">                    .group(group)</span><br><span class="line">                    .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, <span class="number">5000</span>)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>());</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>);</span><br><span class="line">            future.sync().channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.debug(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="SO-BACKLOG"><a href="#SO-BACKLOG" class="headerlink" title="SO_BACKLOG"></a>SO_BACKLOG</h4><p>å±äº ServerSocketChannal å‚æ•°ï¼Œé€šè¿‡ <code>option(ChannelOption.SO_BACKLOG, value)</code> æ¥è®¾ç½®å¤§å°</p>
<p>åœ¨ Linux 2.2 ä¹‹å‰ï¼Œbacklog å¤§å°åŒ…æ‹¬äº†ä¸¤ä¸ªé˜Ÿåˆ—çš„å¤§å°ï¼Œåœ¨ 2.2 ä¹‹åï¼Œåˆ†åˆ«ç”¨ä¸‹é¢ä¸¤ä¸ªå‚æ•°æ¥æ§åˆ¶</p>
<ul>
<li>sync queueï¼šåŠè¿æ¥é˜Ÿåˆ—ï¼Œå¤§å°é€šè¿‡ <code>/proc/sys/net/ipv4/tcp_max_syn_backlog</code> æŒ‡å®šï¼Œåœ¨ <code>syncookies</code> å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œé€»è¾‘ä¸Šæ²¡æœ‰æœ€å¤§å€¼é™åˆ¶</li>
<li>accept queueï¼šå…¨è¿æ¥é˜Ÿåˆ—ï¼Œå¤§å°é€šè¿‡ <code>/proc/sys/net/core/somaxconn</code> æŒ‡å®šï¼Œåœ¨ä½¿ç”¨ listen å‡½æ•°æ—¶ï¼Œå†…æ ¸ä¼šæ ¹æ®ä¼ å…¥çš„ backlog å‚æ•°ä¸ç³»ç»Ÿå‚æ•°ï¼Œå–äºŒè€…çš„è¾ƒå°å€¼ã€‚å¦‚æœ accpet queue é˜Ÿåˆ—æ»¡äº†ï¼Œserver å°†<strong>å‘é€ä¸€ä¸ªæ‹’ç»è¿æ¥çš„é”™è¯¯ä¿¡æ¯</strong>åˆ° client</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Netty-TCPä¸‰æ¬¡æ¡æ‰‹.png" alt=""></p>
<hr>
<h4 id="å…¶ä»–å‚æ•°"><a href="#å…¶ä»–å‚æ•°" class="headerlink" title="å…¶ä»–å‚æ•°"></a>å…¶ä»–å‚æ•°</h4><p>ALLOCATORï¼šå±äº SocketChannal å‚æ•°ï¼Œç”¨æ¥åˆ†é… ByteBufï¼Œ ctx.alloc()</p>
<p>RCVBUF_ALLOCATORï¼šå±äº SocketChannal å‚æ•°</p>
<ul>
<li>æ§åˆ¶ Netty æ¥æ”¶ç¼“å†²åŒºå¤§å°</li>
<li>è´Ÿè´£å…¥ç«™æ•°æ®çš„åˆ†é…ï¼Œå†³å®šå…¥ç«™ç¼“å†²åŒºçš„å¤§å°ï¼ˆå¹¶å¯åŠ¨æ€è°ƒæ•´ï¼‰ï¼Œç»Ÿä¸€é‡‡ç”¨ direct ç›´æ¥å†…å­˜ï¼Œå…·ä½“æ± åŒ–è¿˜æ˜¯éæ± åŒ–ç”± allocator å†³å®š</li>
</ul>
<hr>
<h1 id="RocketMQ"><a href="#RocketMQ" class="headerlink" title="RocketMQ"></a>RocketMQ</h1><h2 id="åŸºæœ¬ä»‹ç»-6"><a href="#åŸºæœ¬ä»‹ç»-6" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h2><h3 id="æ¶ˆæ¯é˜Ÿåˆ—"><a href="#æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—"></a>æ¶ˆæ¯é˜Ÿåˆ—</h3><h4 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h4><p>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ç§å…ˆè¿›å…ˆå‡ºçš„æ•°æ®ç»“æ„ï¼Œå¸¸è§çš„åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li><p>åº”ç”¨è§£è€¦ï¼šç³»ç»Ÿçš„è€¦åˆæ€§è¶Šé«˜ï¼Œå®¹é”™æ€§å°±è¶Šä½</p>
<p>å®ä¾‹ï¼šç”¨æˆ·åˆ›å»ºè®¢å•åï¼Œè€¦åˆè°ƒç”¨åº“å­˜ç³»ç»Ÿã€ç‰©æµç³»ç»Ÿã€æ”¯ä»˜ç³»ç»Ÿï¼Œä»»ä½•ä¸€ä¸ªå­ç³»ç»Ÿå‡ºäº†æ•…éšœéƒ½ä¼šé€ æˆä¸‹å•å¼‚å¸¸ï¼Œå½±å“ç”¨æˆ·ä½¿ç”¨ä½“éªŒã€‚ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦åˆï¼Œæ¯”å¦‚ç‰©æµç³»ç»Ÿå‘ç”Ÿæ•…éšœï¼Œéœ€è¦å‡ åˆ†é’Ÿæ¢å¤ï¼Œå°†ç‰©æµç³»ç»Ÿè¦å¤„ç†çš„æ•°æ®ç¼“å­˜åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç”¨æˆ·çš„ä¸‹å•æ“ä½œæ­£å¸¸å®Œæˆã€‚ç­‰å¾…ç‰©æµç³»ç»Ÿæ­£å¸¸åå¤„ç†å­˜åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•æ¶ˆæ¯å³å¯ï¼Œç»ˆç«¯ç³»ç»Ÿæ„ŸçŸ¥ä¸åˆ°ç‰©æµç³»ç»Ÿå‘ç”Ÿè¿‡å‡ åˆ†é’Ÿæ•…éšœ</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-è§£è€¦.png" alt=""></p>
</li>
<li><p>æµé‡å‰Šå³°ï¼šåº”ç”¨ç³»ç»Ÿå¦‚æœé‡åˆ°ç³»ç»Ÿè¯·æ±‚æµé‡çš„ç¬é—´çŒ›å¢ï¼Œæœ‰å¯èƒ½ä¼šå°†ç³»ç»Ÿå‹å®ï¼Œä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å°†å¤§é‡è¯·æ±‚ç¼“å­˜èµ·æ¥ï¼Œåˆ†æ•£åˆ°å¾ˆé•¿ä¸€æ®µæ—¶é—´å¤„ç†ï¼Œè¿™æ ·å¯ä»¥æé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒ</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-æµé‡å‰Šå³°.png" alt=""></p>
</li>
<li><p>æ•°æ®åˆ†å‘ï¼šè®©æ•°æ®åœ¨å¤šä¸ªç³»ç»Ÿæ›´åŠ ä¹‹é—´è¿›è¡Œæµé€šï¼Œæ•°æ®çš„äº§ç”Ÿæ–¹ä¸éœ€è¦å…³å¿ƒè°æ¥ä½¿ç”¨æ•°æ®ï¼Œåªéœ€è¦å°†æ•°æ®å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ•°æ®ä½¿ç”¨æ–¹ç›´æ¥åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç›´æ¥è·å–æ•°æ®</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-æ•°æ®åˆ†å‘.png" alt=""></p>
</li>
</ul>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1L4411y7mn">https://www.bilibili.com/video/BV1L4411y7mn</a></p>
<hr>
<h4 id="æŠ€æœ¯é€‰å‹"><a href="#æŠ€æœ¯é€‰å‹" class="headerlink" title="æŠ€æœ¯é€‰å‹"></a>æŠ€æœ¯é€‰å‹</h4><p>RocketMQ å¯¹æ¯” Kafka çš„ä¼˜ç‚¹</p>
<ul>
<li>æ”¯æŒ Pullå’Œ Push ä¸¤ç§æ¶ˆæ¯æ¨¡å¼</li>
</ul>
<ul>
<li>æ”¯æŒå»¶æ—¶æ¶ˆæ¯ã€æ­»ä¿¡é˜Ÿåˆ—ã€æ¶ˆæ¯é‡è¯•ã€æ¶ˆæ¯å›æº¯ã€æ¶ˆæ¯è·Ÿè¸ªã€äº‹åŠ¡æ¶ˆæ¯ç­‰é«˜çº§ç‰¹æ€§</li>
<li>å¯¹æ¶ˆæ¯å¯é æ€§åšäº†æ”¹è¿›ï¼Œ<strong>ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±å¹¶ä¸”è‡³å°‘æ¶ˆè´¹ä¸€æ¬¡</strong>ï¼Œä¸ Kafka ä¸€æ ·æ˜¯å…ˆå†™ PageCache å†è½ç›˜ï¼Œå¹¶ä¸”æ•°æ®æœ‰å¤šå‰¯æœ¬</li>
<li>RocketMQ å­˜å‚¨æ¨¡å‹æ˜¯æ‰€æœ‰çš„ Topic éƒ½å†™åˆ°åŒä¸€ä¸ª Commitlog é‡Œï¼Œæ˜¯ä¸€ä¸ª append only æ“ä½œï¼Œåœ¨æµ·é‡ Topic ä¸‹ä¹Ÿèƒ½å°†ç£ç›˜çš„æ€§èƒ½å‘æŒ¥åˆ°æè‡´ï¼Œå¹¶ä¸”ä¿æŒç¨³å®šçš„å†™å…¥æ—¶å»¶ã€‚Kafka çš„ååéå¸¸é«˜ï¼ˆé›¶æ‹·è´ã€æ“ä½œç³»ç»Ÿé¡µç¼“å­˜ã€ç£ç›˜é¡ºåºå†™ï¼‰ï¼Œä½†æ˜¯åœ¨å¤š Topic ä¸‹æ—¶å»¶ä¸å¤Ÿç¨³å®šï¼ˆé¡ºåºå†™å…¥ç‰¹æ€§ä¼šè¢«ç ´åä»è€Œå¼•å…¥å¤§é‡çš„éšæœº I/Oï¼‰ï¼Œä¸é€‚åˆå®æ—¶åœ¨çº¿ä¸šåŠ¡åœºæ™¯</li>
<li>ç»è¿‡é˜¿é‡Œå·´å·´å¤šå¹´åŒ 11 éªŒè¯è¿‡ã€å¯ä»¥æ”¯æŒäº¿çº§å¹¶å‘çš„å¼€æºæ¶ˆæ¯é˜Ÿåˆ—</li>
</ul>
<p>Kafka æ¯” RocketMQ ååé‡é«˜ï¼š</p>
<ul>
<li><p>Kafka å°† Producer ç«¯å°†å¤šä¸ªå°æ¶ˆæ¯åˆå¹¶ï¼Œé‡‡ç”¨å¼‚æ­¥æ‰¹é‡å‘é€çš„æœºåˆ¶ï¼Œå½“å‘é€ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯å¹¶æ²¡æœ‰å‘é€åˆ° Broker è€Œæ˜¯ç¼“å­˜èµ·æ¥ï¼Œç›´æ¥å‘ä¸šåŠ¡è¿”å›æˆåŠŸï¼Œå½“ç¼“å­˜çš„æ¶ˆæ¯è¾¾åˆ°ä¸€å®šæ•°é‡æ—¶å†æ‰¹é‡å‘é€</p>
</li>
<li><p>å‡å°‘äº†ç½‘ç»œ I/Oï¼Œæé«˜äº†æ¶ˆæ¯å‘é€çš„æ€§èƒ½ï¼Œä½†æ˜¯å¦‚æœæ¶ˆæ¯å‘é€è€…å®•æœºï¼Œä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œé™ä½äº†å¯é æ€§</p>
</li>
<li>RocketMQ ç¼“å­˜è¿‡å¤šæ¶ˆæ¯ä¼šå¯¼è‡´é¢‘ç¹ GCï¼Œå¹¶ä¸”ä¸ºäº†ä¿è¯å¯é æ€§æ²¡æœ‰é‡‡ç”¨è¿™ç§æ–¹å¼</li>
</ul>
<p>Topic çš„ partition æ•°é‡è¿‡å¤šæ—¶ï¼ŒKafka çš„æ€§èƒ½ä¸å¦‚ RocketMQï¼š</p>
<ul>
<li><p>ä¸¤è€…éƒ½ä½¿ç”¨æ–‡ä»¶å­˜å‚¨ï¼Œä½†æ˜¯ Kafka æ˜¯ä¸€ä¸ªåˆ†åŒºä¸€ä¸ªæ–‡ä»¶ï¼ŒTopic è¿‡å¤šæ—¶åˆ†åŒºçš„æ€»é‡ä¹Ÿä¼šå¢åŠ ï¼Œè¿‡å¤šçš„æ–‡ä»¶å¯¼è‡´å¯¹æ¶ˆæ¯åˆ·ç›˜æ—¶å‡ºç°æ–‡ä»¶ç«äº‰ç£ç›˜ï¼Œé€ æˆæ€§èƒ½çš„ä¸‹é™ã€‚<strong>ä¸€ä¸ªåˆ†åŒºåªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹ç»„ä¸­çš„ä¸€ä¸ªæ¶ˆè´¹çº¿ç¨‹è¿›è¡Œæ¶ˆè´¹</strong>ï¼Œå› æ­¤å¯ä»¥åŒæ—¶æ¶ˆè´¹çš„æ¶ˆè´¹ç«¯ä¹Ÿæ¯”è¾ƒå°‘</p>
</li>
<li><p>RocketMQ æ‰€æœ‰é˜Ÿåˆ—éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæ¯ä¸ªé˜Ÿåˆ—å­˜å‚¨çš„æ¶ˆæ¯é‡ä¹Ÿæ¯”è¾ƒå°ï¼Œå› æ­¤å¤š Topic çš„å¯¹ RocketMQ çš„æ€§èƒ½çš„å½±å“è¾ƒå°</p>
</li>
</ul>
<hr>
<h3 id="å®‰è£…æµ‹è¯•"><a href="#å®‰è£…æµ‹è¯•" class="headerlink" title="å®‰è£…æµ‹è¯•"></a>å®‰è£…æµ‹è¯•</h3><p>å®‰è£…éœ€è¦ Java ç¯å¢ƒï¼Œä¸‹è½½è§£å‹åè¿›å…¥å®‰è£…ç›®å½•ï¼Œè¿›è¡Œå¯åŠ¨ï¼š</p>
<ul>
<li><p>å¯åŠ¨ NameServer</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.å¯åŠ¨ NameServer</span></span><br><span class="line"><span class="built_in">nohup</span> sh bin/mqnamesrv &amp;</span><br><span class="line"><span class="comment"># 2.æŸ¥çœ‹å¯åŠ¨æ—¥å¿—</span></span><br><span class="line"><span class="built_in">tail</span> -f ~/logs/rocketmqlogs/namesrv.log</span><br></pre></td></tr></table></figure>
<p>RocketMQ é»˜è®¤çš„è™šæ‹Ÿæœºå†…å­˜è¾ƒå¤§ï¼Œéœ€è¦ç¼–è¾‘å¦‚ä¸‹ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹ JVM å†…å­˜å¤§å°</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¼–è¾‘runbroker.shå’Œrunserver.shä¿®æ”¹é»˜è®¤JVMå¤§å°</span></span><br><span class="line">vi runbroker.sh</span><br><span class="line">vi runserver.sh</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒé…ç½®ï¼šJAVA_OPT=â€${JAVA_OPT} -server -Xms256m -Xmx256m -Xmn128m -XX:MetaspaceSize=128m  -XX:MaxMetaspaceSize=320mâ€</p>
</li>
<li><p>å¯åŠ¨ Broker</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.å¯åŠ¨ Broker</span></span><br><span class="line"><span class="built_in">nohup</span> sh bin/mqbroker -n localhost:9876 autoCreateTopicEnable=<span class="literal">true</span> &amp;</span><br><span class="line"><span class="comment"># 2.æŸ¥çœ‹å¯åŠ¨æ—¥å¿—</span></span><br><span class="line"><span class="built_in">tail</span> -f ~/logs/rocketmqlogs/broker.log </span><br></pre></td></tr></table></figure>
</li>
<li><p>å‘é€æ¶ˆæ¯ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.è®¾ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">export</span> NAMESRV_ADDR=localhost:9876</span><br><span class="line"><span class="comment"># 2.ä½¿ç”¨å®‰è£…åŒ…çš„ Demo å‘é€æ¶ˆæ¯</span></span><br><span class="line">sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¥å—æ¶ˆæ¯ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.è®¾ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">export</span> NAMESRV_ADDR=localhost:9876</span><br><span class="line"><span class="comment"># 2.æ¥æ”¶æ¶ˆæ¯</span></span><br><span class="line">sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer</span><br></pre></td></tr></table></figure>
</li>
<li><p>å…³é—­ RocketMQï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.å…³é—­ NameServer</span></span><br><span class="line">sh bin/mqshutdown namesrv</span><br><span class="line"><span class="comment"># 2.å…³é—­ Broker</span></span><br><span class="line">sh bin/mqshutdown broker</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="ç›¸å…³æ¦‚å¿µ"><a href="#ç›¸å…³æ¦‚å¿µ" class="headerlink" title="ç›¸å…³æ¦‚å¿µ"></a>ç›¸å…³æ¦‚å¿µ</h3><p>RocketMQ ä¸»è¦ç”± Producerã€Brokerã€Consumer ä¸‰éƒ¨åˆ†ç»„æˆï¼Œå…¶ä¸­ Producer è´Ÿè´£ç”Ÿäº§æ¶ˆæ¯ï¼ŒConsumer è´Ÿè´£æ¶ˆè´¹æ¶ˆæ¯ï¼ŒBroker è´Ÿè´£å­˜å‚¨æ¶ˆæ¯ï¼ŒNameServer è´Ÿè´£ç®¡ç† Broker</p>
<ul>
<li>ä»£ç†æœåŠ¡å™¨ï¼ˆBroker Serverï¼‰ï¼šæ¶ˆæ¯ä¸­è½¬è§’è‰²ï¼Œè´Ÿè´£<strong>å­˜å‚¨æ¶ˆæ¯ã€è½¬å‘æ¶ˆæ¯</strong>ã€‚åœ¨ RocketMQ ç³»ç»Ÿä¸­è´Ÿè´£æ¥æ”¶ä»ç”Ÿäº§è€…å‘é€æ¥çš„æ¶ˆæ¯å¹¶å­˜å‚¨ã€åŒæ—¶ä¸ºæ¶ˆè´¹è€…çš„æ‹‰å–è¯·æ±‚ä½œå‡†å¤‡ï¼Œä¹Ÿå­˜å‚¨æ¶ˆæ¯ç›¸å…³çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ¶ˆè´¹è€…ç»„ã€æ¶ˆè´¹è¿›åº¦åç§»å’Œä¸»é¢˜å’Œé˜Ÿåˆ—æ¶ˆæ¯ç­‰</li>
<li>åå­—æœåŠ¡ï¼ˆName Serverï¼‰ï¼šå……å½“<strong>è·¯ç”±æ¶ˆæ¯</strong>çš„æä¾›è€…ã€‚ç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…èƒ½å¤Ÿé€šè¿‡åå­—æœåŠ¡æŸ¥æ‰¾å„ä¸»é¢˜ç›¸åº”çš„ Broker IP åˆ—è¡¨</li>
<li>æ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆProducerï¼‰ï¼šè´Ÿè´£<strong>ç”Ÿäº§æ¶ˆæ¯</strong>ï¼ŒæŠŠä¸šåŠ¡åº”ç”¨ç³»ç»Ÿé‡Œäº§ç”Ÿçš„æ¶ˆæ¯å‘é€åˆ° Broker æœåŠ¡å™¨ã€‚RocketMQ æä¾›å¤šç§å‘é€æ–¹å¼ï¼ŒåŒæ­¥å‘é€ã€å¼‚æ­¥å‘é€ã€é¡ºåºå‘é€ã€å•å‘å‘é€ï¼ŒåŒæ­¥å’Œå¼‚æ­¥æ–¹å¼å‡éœ€è¦ Broker è¿”å›ç¡®è®¤ä¿¡æ¯ï¼Œå•å‘å‘é€ä¸éœ€è¦ï¼›å¯ä»¥é€šè¿‡ MQ çš„è´Ÿè½½å‡è¡¡æ¨¡å—é€‰æ‹©ç›¸åº”çš„ Broker é›†ç¾¤é˜Ÿåˆ—è¿›è¡Œæ¶ˆæ¯æŠ•é€’ï¼ŒæŠ•é€’çš„è¿‡ç¨‹æ”¯æŒå¿«é€Ÿå¤±è´¥å¹¶ä¸”ä½å»¶è¿Ÿ</li>
<li>æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰ï¼šè´Ÿè´£<strong>æ¶ˆè´¹æ¶ˆæ¯</strong>ï¼Œä¸€èˆ¬æ˜¯åå°ç³»ç»Ÿè´Ÿè´£å¼‚æ­¥æ¶ˆè´¹ï¼Œä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…ä¼šä» Broker æœåŠ¡å™¨æ‹‰å–æ¶ˆæ¯ã€å¹¶å°†å…¶æä¾›ç»™åº”ç”¨ç¨‹åºã€‚ä»ç”¨æˆ·åº”ç”¨çš„è§’åº¦è€Œæä¾›äº†ä¸¤ç§æ¶ˆè´¹å½¢å¼ï¼š<ul>
<li>æ‹‰å–å¼æ¶ˆè´¹ï¼ˆPull Consumerï¼‰ï¼šåº”ç”¨é€šä¸»åŠ¨è°ƒç”¨ Consumer çš„æ‹‰æ¶ˆæ¯æ–¹æ³•ä» Broker æœåŠ¡å™¨æ‹‰æ¶ˆæ¯ï¼Œä¸»åŠ¨æƒç”±åº”ç”¨æ§åˆ¶ï¼Œä¸€æ—¦è·å–äº†æ‰¹é‡æ¶ˆæ¯ï¼Œåº”ç”¨å°±ä¼šå¯åŠ¨æ¶ˆè´¹è¿‡ç¨‹</li>
<li>æ¨åŠ¨å¼æ¶ˆè´¹ï¼ˆPush Consumerï¼‰ï¼šè¯¥æ¨¡å¼ä¸‹ Broker æ”¶åˆ°æ•°æ®åä¼šä¸»åŠ¨æ¨é€ç»™æ¶ˆè´¹ç«¯ï¼Œå®æ—¶æ€§è¾ƒé«˜</li>
</ul>
</li>
<li>ç”Ÿäº§è€…ç»„ï¼ˆProducer Groupï¼‰ï¼šåŒä¸€ç±» Producer çš„é›†åˆï¼Œå‘é€åŒä¸€ç±»æ¶ˆæ¯ä¸”å‘é€é€»è¾‘ä¸€è‡´ã€‚å¦‚æœå‘é€çš„æ˜¯äº‹åŠ¡æ¶ˆæ¯ä¸”åŸå§‹ç”Ÿäº§è€…åœ¨å‘é€ä¹‹åå´©æºƒï¼Œ<strong>åˆ™ Broker æœåŠ¡å™¨ä¼šè”ç³»åŒä¸€ç”Ÿäº§è€…ç»„çš„å…¶ä»–ç”Ÿäº§è€…å®ä¾‹ä»¥æäº¤æˆ–å›æº¯æ¶ˆè´¹</strong></li>
<li>æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰ï¼šåŒä¸€ç±» Consumer çš„é›†åˆï¼Œæ¶ˆè´¹è€…å®ä¾‹å¿…é¡»è®¢é˜…å®Œå…¨ç›¸åŒçš„ Topicï¼Œæ¶ˆè´¹åŒä¸€ç±»æ¶ˆæ¯ä¸”æ¶ˆè´¹é€»è¾‘ä¸€è‡´ã€‚æ¶ˆè´¹è€…ç»„ä½¿å¾—åœ¨æ¶ˆæ¯æ¶ˆè´¹æ–¹é¢æ›´å®¹æ˜“çš„å®ç°è´Ÿè½½å‡è¡¡å’Œå®¹é”™ã€‚RocketMQ æ”¯æŒä¸¤ç§æ¶ˆæ¯æ¨¡å¼ï¼š<ul>
<li>é›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰ï¼šç›¸åŒ Consumer Group çš„æ¯ä¸ª Consumer å®ä¾‹å¹³å‡åˆ†æ‘Šæ¶ˆæ¯</li>
<li>å¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰ï¼šç›¸åŒ Consumer Group çš„æ¯ä¸ª Consumer å®ä¾‹éƒ½æ¥æ”¶å…¨é‡çš„æ¶ˆæ¯</li>
</ul>
</li>
</ul>
<p>æ¯ä¸ª Broker å¯ä»¥å­˜å‚¨å¤šä¸ª Topic çš„æ¶ˆæ¯ï¼Œæ¯ä¸ª Topic çš„æ¶ˆæ¯ä¹Ÿå¯ä»¥åˆ†ç‰‡å­˜å‚¨äºä¸åŒçš„ Brokerï¼ŒMessage Queueï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰æ˜¯ç”¨äºå­˜å‚¨æ¶ˆæ¯çš„ç‰©ç†åœ°å€ï¼Œæ¯ä¸ª Topic ä¸­çš„æ¶ˆæ¯åœ°å€å­˜å‚¨äºå¤šä¸ª Message Queue ä¸­</p>
<ul>
<li><p>ä¸»é¢˜ï¼ˆTopicï¼‰ï¼šè¡¨ç¤ºä¸€ç±»æ¶ˆæ¯çš„é›†åˆï¼Œæ¯ä¸ªä¸»é¢˜åŒ…å«è‹¥å¹²æ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯åªå±äºä¸€ä¸ªä¸»é¢˜ï¼Œæ˜¯ RocketMQ æ¶ˆæ¯è®¢é˜…çš„åŸºæœ¬å•ä½</p>
</li>
<li><p>æ¶ˆæ¯ï¼ˆMessageï¼‰ï¼šæ¶ˆæ¯ç³»ç»Ÿæ‰€ä¼ è¾“ä¿¡æ¯çš„ç‰©ç†è½½ä½“ï¼Œç”Ÿäº§å’Œæ¶ˆè´¹æ•°æ®çš„æœ€å°å•ä½ï¼Œæ¯æ¡æ¶ˆæ¯å¿…é¡»å±äºä¸€ä¸ªä¸»é¢˜ã€‚RocketMQ ä¸­æ¯ä¸ªæ¶ˆæ¯æ‹¥æœ‰å”¯ä¸€çš„ Message IDï¼Œä¸”å¯ä»¥æºå¸¦å…·æœ‰ä¸šåŠ¡æ ‡è¯†çš„ Keyï¼Œç³»ç»Ÿæä¾›äº†é€šè¿‡ Message ID å’Œ Key æŸ¥è¯¢æ¶ˆæ¯çš„åŠŸèƒ½</p>
</li>
<li><p>æ ‡ç­¾ï¼ˆTagï¼‰ï¼šä¸ºæ¶ˆæ¯è®¾ç½®çš„æ ‡å¿—ï¼Œç”¨äºåŒä¸€ä¸»é¢˜ä¸‹åŒºåˆ†ä¸åŒç±»å‹çš„æ¶ˆæ¯ã€‚æ ‡ç­¾èƒ½å¤Ÿæœ‰æ•ˆåœ°ä¿æŒä»£ç çš„æ¸…æ™°åº¦å’Œè¿è´¯æ€§ï¼Œå¹¶ä¼˜åŒ– RocketMQ æä¾›çš„æŸ¥è¯¢ç³»ç»Ÿï¼Œæ¶ˆè´¹è€…å¯ä»¥æ ¹æ® Tag å®ç°å¯¹ä¸åŒå­ä¸»é¢˜çš„ä¸åŒæ¶ˆè´¹é€»è¾‘ï¼Œå®ç°æ›´å¥½çš„æ‰©å±•æ€§</p>
</li>
<li><p>æ™®é€šé¡ºåºæ¶ˆæ¯ï¼ˆNormal Ordered Messageï¼‰ï¼šæ¶ˆè´¹è€…é€šè¿‡åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆTopic åˆ†åŒºï¼‰æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯æœ‰é¡ºåºçš„ï¼Œä¸åŒæ¶ˆæ¯é˜Ÿåˆ—æ”¶åˆ°çš„æ¶ˆæ¯åˆ™å¯èƒ½æ˜¯æ— é¡ºåºçš„</p>
</li>
<li><p>ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼ˆStrictly Ordered Messageï¼‰ï¼šæ¶ˆè´¹è€…æ”¶åˆ°çš„æ‰€æœ‰æ¶ˆæ¯å‡æ˜¯æœ‰é¡ºåºçš„</p>
</li>
</ul>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq/tree/master/docs/cnï¼ˆåŸºç¡€çŸ¥è¯†éƒ¨åˆ†çš„ç¬”è®°å‚è€ƒå®˜æ–¹æ–‡æ¡£ç¼–å†™ï¼‰">https://github.com/apache/rocketmq/tree/master/docs/cnï¼ˆåŸºç¡€çŸ¥è¯†éƒ¨åˆ†çš„ç¬”è®°å‚è€ƒå®˜æ–¹æ–‡æ¡£ç¼–å†™ï¼‰</a></p>
<hr>
<h2 id="æ¶ˆæ¯æ“ä½œ"><a href="#æ¶ˆæ¯æ“ä½œ" class="headerlink" title="æ¶ˆæ¯æ“ä½œ"></a>æ¶ˆæ¯æ“ä½œ</h2><h3 id="åŸºæœ¬æ ·ä¾‹"><a href="#åŸºæœ¬æ ·ä¾‹" class="headerlink" title="åŸºæœ¬æ ·ä¾‹"></a>åŸºæœ¬æ ·ä¾‹</h3><h4 id="è®¢é˜…å‘å¸ƒ"><a href="#è®¢é˜…å‘å¸ƒ" class="headerlink" title="è®¢é˜…å‘å¸ƒ"></a>è®¢é˜…å‘å¸ƒ</h4><p>æ¶ˆæ¯çš„å‘å¸ƒæ˜¯æŒ‡æŸä¸ªç”Ÿäº§è€…å‘æŸä¸ª Topic å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯çš„è®¢é˜…æ˜¯æŒ‡æŸä¸ªæ¶ˆè´¹è€…å…³æ³¨äº†æŸä¸ª Topic ä¸­å¸¦æœ‰æŸäº› Tag çš„æ¶ˆæ¯ï¼Œè¿›è€Œä»è¯¥ Topic æ¶ˆè´¹æ•°æ®</p>
<p>å¯¼å…¥ MQ å®¢æˆ·ç«¯ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>æ¶ˆæ¯å‘é€è€…æ­¥éª¤åˆ†æï¼š</p>
<ol>
<li>åˆ›å»ºæ¶ˆæ¯ç”Ÿäº§è€… Producerï¼Œå¹¶åˆ¶å®šç”Ÿäº§è€…ç»„å</li>
<li>æŒ‡å®š Nameserver åœ°å€</li>
<li>å¯åŠ¨ Producer</li>
<li>åˆ›å»ºæ¶ˆæ¯å¯¹è±¡ï¼ŒæŒ‡å®šä¸»é¢˜ Topicã€Tag å’Œæ¶ˆæ¯ä½“</li>
<li>å‘é€æ¶ˆæ¯</li>
<li>å…³é—­ç”Ÿäº§è€… Producer</li>
</ol>
<p>æ¶ˆæ¯æ¶ˆè´¹è€…æ­¥éª¤åˆ†æï¼š</p>
<ol>
<li>åˆ›å»ºæ¶ˆè´¹è€… Consumerï¼Œåˆ¶å®šæ¶ˆè´¹è€…ç»„å</li>
<li>æŒ‡å®š Nameserver åœ°å€</li>
<li>è®¢é˜…ä¸»é¢˜ Topic å’Œ Tag</li>
<li>è®¾ç½®å›è°ƒå‡½æ•°ï¼Œå¤„ç†æ¶ˆæ¯</li>
<li>å¯åŠ¨æ¶ˆè´¹è€… Consumer</li>
</ol>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq/blob/master/docs/cn/RocketMQ_Example.md">https://github.com/apache/rocketmq/blob/master/docs/cn/RocketMQ_Example.md</a></p>
<hr>
<h4 id="å‘é€æ¶ˆæ¯"><a href="#å‘é€æ¶ˆæ¯" class="headerlink" title="å‘é€æ¶ˆæ¯"></a>å‘é€æ¶ˆæ¯</h4><h5 id="åŒæ­¥å‘é€"><a href="#åŒæ­¥å‘é€" class="headerlink" title="åŒæ­¥å‘é€"></a>åŒæ­¥å‘é€</h5><p>ä½¿ç”¨ RocketMQ å‘é€ä¸‰ç§ç±»å‹çš„æ¶ˆæ¯ï¼šåŒæ­¥æ¶ˆæ¯ã€å¼‚æ­¥æ¶ˆæ¯å’Œå•å‘æ¶ˆæ¯ï¼Œå…¶ä¸­å‰ä¸¤ç§æ¶ˆæ¯æ˜¯å¯é çš„ï¼Œå› ä¸ºä¼šæœ‰å‘é€æ˜¯å¦æˆåŠŸçš„åº”ç­”</p>
<p>è¿™ç§å¯é æ€§åŒæ­¥åœ°å‘é€æ–¹å¼ä½¿ç”¨çš„æ¯”è¾ƒå¹¿æ³›ï¼Œæ¯”å¦‚ï¼šé‡è¦çš„æ¶ˆæ¯é€šçŸ¥ï¼ŒçŸ­ä¿¡é€šçŸ¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SyncProducer</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    	<span class="comment">// å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…Producer</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">    	<span class="comment">// è®¾ç½®NameServerçš„åœ°å€</span></span><br><span class="line">    	producer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line">    	<span class="comment">// å¯åŠ¨Producerå®ä¾‹</span></span><br><span class="line">        producer.start();</span><br><span class="line">    	<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    	    <span class="comment">// åˆ›å»ºæ¶ˆæ¯ï¼Œå¹¶æŒ‡å®šTopicï¼ŒTagå’Œæ¶ˆæ¯ä½“</span></span><br><span class="line">    	    <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(</span><br><span class="line">                <span class="string">&quot;TopicTest&quot;</span> <span class="comment">/* Topic */</span>,</span><br><span class="line">                <span class="string">&quot;TagA&quot;</span> <span class="comment">/* Tag */</span>,</span><br><span class="line">        		(<span class="string">&quot;Hello RocketMQ &quot;</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span>);</span><br><span class="line">            </span><br><span class="line">        	<span class="comment">// å‘é€æ¶ˆæ¯åˆ°ä¸€ä¸ªBroker</span></span><br><span class="line">            <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.send(msg);</span><br><span class="line">            <span class="comment">// é€šè¿‡sendResultè¿”å›æ¶ˆæ¯æ˜¯å¦æˆåŠŸé€è¾¾</span></span><br><span class="line">            System.out.printf(<span class="string">&quot;%s%n&quot;</span>, sendResult);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="comment">// å¦‚æœä¸å†å‘é€æ¶ˆæ¯ï¼Œå…³é—­Producerå®ä¾‹ã€‚</span></span><br><span class="line">    	producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="å¼‚æ­¥å‘é€"><a href="#å¼‚æ­¥å‘é€" class="headerlink" title="å¼‚æ­¥å‘é€"></a>å¼‚æ­¥å‘é€</h5><p>å¼‚æ­¥æ¶ˆæ¯é€šå¸¸ç”¨åœ¨å¯¹å“åº”æ—¶é—´æ•æ„Ÿçš„ä¸šåŠ¡åœºæ™¯ï¼Œå³å‘é€ç«¯ä¸èƒ½å®¹å¿é•¿æ—¶é—´åœ°ç­‰å¾… Broker çš„å“åº”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncProducer</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    	<span class="comment">// å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…Producer</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">    	<span class="comment">// è®¾ç½®NameServerçš„åœ°å€</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line">    	<span class="comment">// å¯åŠ¨Producerå®ä¾‹</span></span><br><span class="line">        producer.start();</span><br><span class="line">        producer.setRetryTimesWhenSendAsyncFailed(<span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">        <span class="type">int</span> <span class="variable">messageCount</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">		<span class="comment">// æ ¹æ®æ¶ˆæ¯æ•°é‡å®ä¾‹åŒ–å€’è®¡æ—¶è®¡ç®—å™¨</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">CountDownLatch2</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch2</span>(messageCount);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; messageCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="comment">// åˆ›å»ºæ¶ˆæ¯ï¼Œå¹¶æŒ‡å®šTopicï¼ŒTagå’Œæ¶ˆæ¯ä½“</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TopicTest&quot;</span>, <span class="string">&quot;TagA&quot;</span>, <span class="string">&quot;OrderID188&quot;</span>,</span><br><span class="line">                                      <span class="string">&quot;Hello world&quot;</span>.getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// SendCallbackæ¥æ”¶å¼‚æ­¥è¿”å›ç»“æœçš„å›è°ƒ</span></span><br><span class="line">            producer.send(msg, <span class="keyword">new</span> <span class="title class_">SendCallback</span>() &#123;</span><br><span class="line">                <span class="comment">// å‘é€æˆåŠŸå›è°ƒå‡½æ•°</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(SendResult sendResult)</span> &#123;</span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                    System.out.printf(<span class="string">&quot;%-10d OK %s %n&quot;</span>, index, sendResult.getMsgId());</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onException</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                    System.out.printf(<span class="string">&quot;%-10d Exception %s %n&quot;</span>, index, e);</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ç­‰å¾…5s</span></span><br><span class="line">        countDownLatch.await(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">// å¦‚æœä¸å†å‘é€æ¶ˆæ¯ï¼Œå…³é—­Producerå®ä¾‹ã€‚</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="å•å‘å‘é€"><a href="#å•å‘å‘é€" class="headerlink" title="å•å‘å‘é€"></a>å•å‘å‘é€</h5><p>å•å‘å‘é€ä¸»è¦ç”¨åœ¨ä¸ç‰¹åˆ«å…³å¿ƒå‘é€ç»“æœçš„åœºæ™¯ï¼Œä¾‹å¦‚æ—¥å¿—å‘é€</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OnewayProducer</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    	<span class="comment">// å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…Producer</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">    	<span class="comment">// è®¾ç½®NameServerçš„åœ°å€</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line">    	<span class="comment">// å¯åŠ¨Producerå®ä¾‹</span></span><br><span class="line">        producer.start();</span><br><span class="line">    	<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        	<span class="comment">// åˆ›å»ºæ¶ˆæ¯ï¼Œå¹¶æŒ‡å®šTopicï¼ŒTagå’Œæ¶ˆæ¯ä½“</span></span><br><span class="line">        	<span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TopicTest&quot;</span>,<span class="string">&quot;TagA&quot;</span>,</span><br><span class="line">                          (<span class="string">&quot;Hello RocketMQ &quot;</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">        	<span class="comment">// å‘é€å•å‘æ¶ˆæ¯ï¼Œæ²¡æœ‰ä»»ä½•è¿”å›ç»“æœ</span></span><br><span class="line">        	producer.sendOneway(msg);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="comment">// å¦‚æœä¸å†å‘é€æ¶ˆæ¯ï¼Œå…³é—­Producerå®ä¾‹ã€‚</span></span><br><span class="line">    	producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="æ¶ˆè´¹æ¶ˆæ¯"><a href="#æ¶ˆè´¹æ¶ˆæ¯" class="headerlink" title="æ¶ˆè´¹æ¶ˆæ¯"></a>æ¶ˆè´¹æ¶ˆæ¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, MQClientException &#123;</span><br><span class="line">    	<span class="comment">// å®ä¾‹åŒ–æ¶ˆè´¹è€…</span></span><br><span class="line">        <span class="type">DefaultMQPushConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">    	<span class="comment">// è®¾ç½®NameServerçš„åœ°å€</span></span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line"></span><br><span class="line">    	<span class="comment">// è®¢é˜…ä¸€ä¸ªæˆ–è€…å¤šä¸ªTopicï¼Œä»¥åŠTagæ¥è¿‡æ»¤éœ€è¦æ¶ˆè´¹çš„æ¶ˆæ¯</span></span><br><span class="line">        consumer.subscribe(<span class="string">&quot;TopicTest&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">    	<span class="comment">// æ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨ï¼Œå›è°ƒå®ç°ç±»æ¥å¤„ç†ä»brokeræ‹‰å–å›æ¥çš„æ¶ˆæ¯</span></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> <span class="title class_">MessageListenerConcurrently</span>() &#123;</span><br><span class="line">            <span class="comment">// æ¥å—æ¶ˆæ¯å†…å®¹</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title function_">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context)</span> &#123;</span><br><span class="line">                System.out.printf(<span class="string">&quot;%s Receive New Messages: %s %n&quot;</span>, Thread.currentThread().getName(), msgs);</span><br><span class="line">                <span class="comment">// æ ‡è®°è¯¥æ¶ˆæ¯å·²ç»è¢«æˆåŠŸæ¶ˆè´¹</span></span><br><span class="line">                <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// å¯åŠ¨æ¶ˆè´¹è€…å®ä¾‹</span></span><br><span class="line">        consumer.start();</span><br><span class="line">        System.out.printf(<span class="string">&quot;Consumer Started.%n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="é¡ºåºæ¶ˆæ¯"><a href="#é¡ºåºæ¶ˆæ¯" class="headerlink" title="é¡ºåºæ¶ˆæ¯"></a>é¡ºåºæ¶ˆæ¯</h3><h4 id="åŸç†è§£æ"><a href="#åŸç†è§£æ" class="headerlink" title="åŸç†è§£æ"></a>åŸç†è§£æ</h4><p>æ¶ˆæ¯æœ‰åºæŒ‡çš„æ˜¯ä¸€ç±»æ¶ˆæ¯æ¶ˆè´¹æ—¶ï¼Œèƒ½æŒ‰ç…§å‘é€çš„é¡ºåºæ¥æ¶ˆè´¹ã€‚ä¾‹å¦‚ï¼šä¸€ä¸ªè®¢å•äº§ç”Ÿäº†ä¸‰æ¡æ¶ˆæ¯åˆ†åˆ«æ˜¯è®¢å•åˆ›å»ºã€è®¢å•ä»˜æ¬¾ã€è®¢å•å®Œæˆã€‚æ¶ˆè´¹æ—¶è¦æŒ‰ç…§è¿™ä¸ªé¡ºåºæ¶ˆè´¹æ‰èƒ½æœ‰æ„ä¹‰ï¼Œä½†æ˜¯åŒæ—¶è®¢å•ä¹‹é—´æ˜¯å¯ä»¥å¹¶è¡Œæ¶ˆè´¹çš„ï¼ŒRocketMQ å¯ä»¥ä¸¥æ ¼çš„ä¿è¯æ¶ˆæ¯æœ‰åºã€‚</p>
<p>é¡ºåºæ¶ˆæ¯åˆ†ä¸ºå…¨å±€é¡ºåºæ¶ˆæ¯ä¸åˆ†åŒºé¡ºåºæ¶ˆæ¯ï¼Œ</p>
<ul>
<li>å…¨å±€é¡ºåºï¼šå¯¹äºæŒ‡å®šçš„ä¸€ä¸ª Topicï¼Œæ‰€æœ‰æ¶ˆæ¯æŒ‰ç…§ä¸¥æ ¼çš„å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰çš„é¡ºåºè¿›è¡Œå‘å¸ƒå’Œæ¶ˆè´¹ï¼Œé€‚ç”¨äºæ€§èƒ½è¦æ±‚ä¸é«˜ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯ä¸¥æ ¼æŒ‰ç…§ FIFO åŸåˆ™è¿›è¡Œæ¶ˆæ¯å‘å¸ƒå’Œæ¶ˆè´¹çš„åœºæ™¯</li>
<li>åˆ†åŒºé¡ºåºï¼šå¯¹äºæŒ‡å®šçš„ä¸€ä¸ª Topicï¼Œæ‰€æœ‰æ¶ˆæ¯æ ¹æ® Sharding key è¿›è¡Œåˆ†åŒºï¼ŒåŒä¸€ä¸ªåˆ†ç»„å†…çš„æ¶ˆæ¯æŒ‰ç…§ä¸¥æ ¼çš„ FIFO é¡ºåºè¿›è¡Œå‘å¸ƒå’Œæ¶ˆè´¹ã€‚Sharding key æ˜¯é¡ºåºæ¶ˆæ¯ä¸­ç”¨æ¥åŒºåˆ†ä¸åŒåˆ†åŒºçš„å…³é”®å­—æ®µï¼Œå’Œæ™®é€šæ¶ˆæ¯çš„ Key æ˜¯å®Œå…¨ä¸åŒçš„æ¦‚å¿µï¼Œé€‚ç”¨äºæ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯</li>
</ul>
<p>åœ¨é»˜è®¤çš„æƒ…å†µä¸‹æ¶ˆæ¯å‘é€ä¼šé‡‡å– Round Robin è½®è¯¢æ–¹å¼æŠŠæ¶ˆæ¯å‘é€åˆ°ä¸åŒçš„ queueï¼ˆåˆ†åŒºé˜Ÿåˆ—ï¼‰ï¼Œè€Œæ¶ˆè´¹æ¶ˆæ¯æ˜¯ä»å¤šä¸ª queue ä¸Šæ‹‰å–æ¶ˆæ¯ï¼Œè¿™ç§æƒ…å†µå‘é€å’Œæ¶ˆè´¹æ˜¯ä¸èƒ½ä¿è¯é¡ºåºã€‚ä½†æ˜¯å¦‚æœæ§åˆ¶å‘é€çš„é¡ºåºæ¶ˆæ¯åªä¾æ¬¡å‘é€åˆ°åŒä¸€ä¸ª queue ä¸­ï¼Œæ¶ˆè´¹çš„æ—¶å€™åªä»è¿™ä¸ª queue ä¸Šä¾æ¬¡æ‹‰å–ï¼Œåˆ™å°±ä¿è¯äº†é¡ºåºã€‚å½“<strong>å‘é€å’Œæ¶ˆè´¹å‚ä¸çš„ queue åªæœ‰ä¸€ä¸ª</strong>ï¼Œåˆ™æ˜¯å…¨å±€æœ‰åºï¼›å¦‚æœå¤šä¸ªqueue å‚ä¸ï¼Œåˆ™ä¸ºåˆ†åŒºæœ‰åºï¼Œå³ç›¸å¯¹æ¯ä¸ª queueï¼Œæ¶ˆæ¯éƒ½æ˜¯æœ‰åºçš„</p>
<hr>
<h4 id="ä»£ç å®ç°-1"><a href="#ä»£ç å®ç°-1" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h4><p>ä¸€ä¸ªè®¢å•çš„é¡ºåºæµç¨‹æ˜¯ï¼šåˆ›å»ºã€ä»˜æ¬¾ã€æ¨é€ã€å®Œæˆï¼Œè®¢å•å·ç›¸åŒçš„æ¶ˆæ¯ä¼šè¢«å…ˆåå‘é€åˆ°åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹æ—¶åŒä¸€ä¸ª OrderId è·å–åˆ°çš„è‚¯å®šæ˜¯åŒä¸€ä¸ªé˜Ÿåˆ—</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">        producer.setNamesrvAddr(<span class="string">&quot;127.0.0.1:9876&quot;</span>);</span><br><span class="line">        producer.start();</span><br><span class="line">		<span class="comment">// æ ‡ç­¾é›†åˆ</span></span><br><span class="line">        String[] tags = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;TagA&quot;</span>, <span class="string">&quot;TagC&quot;</span>, <span class="string">&quot;TagD&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¢å•åˆ—è¡¨</span></span><br><span class="line">        List&lt;OrderStep&gt; orderList = <span class="keyword">new</span> <span class="title class_">Producer</span>().buildOrders();</span><br><span class="line"></span><br><span class="line">        <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">dateStr</span> <span class="operator">=</span> sdf.format(date);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// åŠ ä¸ªæ—¶é—´å‰ç¼€</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> dateStr + <span class="string">&quot; Hello RocketMQ &quot;</span> + orderList.get(i);</span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;OrderTopic&quot;</span>, tags[i % tags.length], <span class="string">&quot;KEY&quot;</span> + i, body.getBytes());</span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å‚æ•°ä¸€ï¼šæ¶ˆæ¯å¯¹è±¡</span></span><br><span class="line"><span class="comment">             * å‚æ•°äºŒï¼šæ¶ˆæ¯é˜Ÿåˆ—çš„é€‰æ‹©å™¨</span></span><br><span class="line"><span class="comment">             * å‚æ•°ä¸‰ï¼šé€‰æ‹©é˜Ÿåˆ—çš„ä¸šåŠ¡æ ‡è¯†ï¼ˆè®¢å• IDï¼‰</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.send(msg, <span class="keyword">new</span> <span class="title class_">MessageQueueSelector</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * mqsï¼šé˜Ÿåˆ—é›†åˆ</span></span><br><span class="line"><span class="comment">                 * msgï¼šæ¶ˆæ¯å¯¹è±¡</span></span><br><span class="line"><span class="comment">                 * argï¼šä¸šåŠ¡æ ‡è¯†çš„å‚æ•°</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">public</span> MessageQueue <span class="title function_">select</span><span class="params">(List&lt;MessageQueue&gt; mqs, Message msg, Object arg)</span> &#123;</span><br><span class="line">                    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> (Long) arg;</span><br><span class="line">                    <span class="type">long</span> <span class="variable">index</span> <span class="operator">=</span> id % mqs.size(); <span class="comment">// æ ¹æ®è®¢å•idé€‰æ‹©å‘é€queue</span></span><br><span class="line">                    <span class="keyword">return</span> mqs.get((<span class="type">int</span>) index);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, orderList.get(i).getOrderId());<span class="comment">//è®¢å•id</span></span><br><span class="line"></span><br><span class="line">            System.out.println(String.format(<span class="string">&quot;SendResult status:%s, queueId:%d, body:%s&quot;</span>,</span><br><span class="line">                    sendResult.getSendStatus(),</span><br><span class="line">                    sendResult.getMessageQueue().getQueueId(),</span><br><span class="line">                    body));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¢å•çš„æ­¥éª¤</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OrderStep</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> orderId;</span><br><span class="line">        <span class="keyword">private</span> String desc;</span><br><span class="line">        <span class="comment">// set + get</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿæˆæ¨¡æ‹Ÿè®¢å•æ•°æ®</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;OrderStep&gt; <span class="title function_">buildOrders</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;OrderStep&gt; orderList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;OrderStep&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">OrderStep</span> <span class="variable">orderDemo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderStep</span>();</span><br><span class="line">        orderDemo.setOrderId(<span class="number">15103111039L</span>);</span><br><span class="line">        orderDemo.setDesc(<span class="string">&quot;åˆ›å»º&quot;</span>);</span><br><span class="line">        orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">        orderDemo = <span class="keyword">new</span> <span class="title class_">OrderStep</span>();</span><br><span class="line">        orderDemo.setOrderId(<span class="number">15103111065L</span>);</span><br><span class="line">        orderDemo.setDesc(<span class="string">&quot;åˆ›å»º&quot;</span>);</span><br><span class="line">        orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">        orderDemo = <span class="keyword">new</span> <span class="title class_">OrderStep</span>();</span><br><span class="line">        orderDemo.setOrderId(<span class="number">15103111039L</span>);</span><br><span class="line">        orderDemo.setDesc(<span class="string">&quot;ä»˜æ¬¾&quot;</span>);</span><br><span class="line">        orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">        orderDemo = <span class="keyword">new</span> <span class="title class_">OrderStep</span>();</span><br><span class="line">        orderDemo.setOrderId(<span class="number">15103117235L</span>);</span><br><span class="line">        orderDemo.setDesc(<span class="string">&quot;åˆ›å»º&quot;</span>);</span><br><span class="line">        orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">        orderDemo = <span class="keyword">new</span> <span class="title class_">OrderStep</span>();</span><br><span class="line">        orderDemo.setOrderId(<span class="number">15103111065L</span>);</span><br><span class="line">        orderDemo.setDesc(<span class="string">&quot;ä»˜æ¬¾&quot;</span>);</span><br><span class="line">        orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">        orderDemo = <span class="keyword">new</span> <span class="title class_">OrderStep</span>();</span><br><span class="line">        orderDemo.setOrderId(<span class="number">15103117235L</span>);</span><br><span class="line">        orderDemo.setDesc(<span class="string">&quot;ä»˜æ¬¾&quot;</span>);</span><br><span class="line">        orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">        orderDemo = <span class="keyword">new</span> <span class="title class_">OrderStep</span>();</span><br><span class="line">        orderDemo.setOrderId(<span class="number">15103111065L</span>);</span><br><span class="line">        orderDemo.setDesc(<span class="string">&quot;å®Œæˆ&quot;</span>);</span><br><span class="line">        orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">        orderDemo = <span class="keyword">new</span> <span class="title class_">OrderStep</span>();</span><br><span class="line">        orderDemo.setOrderId(<span class="number">15103111039L</span>);</span><br><span class="line">        orderDemo.setDesc(<span class="string">&quot;æ¨é€&quot;</span>);</span><br><span class="line">        orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">        orderDemo = <span class="keyword">new</span> <span class="title class_">OrderStep</span>();</span><br><span class="line">        orderDemo.setOrderId(<span class="number">15103117235L</span>);</span><br><span class="line">        orderDemo.setDesc(<span class="string">&quot;å®Œæˆ&quot;</span>);</span><br><span class="line">        orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">        orderDemo = <span class="keyword">new</span> <span class="title class_">OrderStep</span>();</span><br><span class="line">        orderDemo.setOrderId(<span class="number">15103111039L</span>);</span><br><span class="line">        orderDemo.setDesc(<span class="string">&quot;å®Œæˆ&quot;</span>);</span><br><span class="line">        orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> orderList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¡ºåºæ¶ˆæ¯æ¶ˆè´¹ï¼Œå¸¦äº‹åŠ¡æ–¹å¼ï¼ˆåº”ç”¨å¯æ§åˆ¶Offsetä»€ä¹ˆæ—¶å€™æäº¤ï¼‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerInOrder</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">DefaultMQPushConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(<span class="string">&quot;please_rename_unique_group_name_3&quot;</span>);</span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">&quot;127.0.0.1:9876&quot;</span>);</span><br><span class="line">        <span class="comment">// è®¾ç½®Consumerç¬¬ä¸€æ¬¡å¯åŠ¨æ˜¯ä»é˜Ÿåˆ—å¤´éƒ¨å¼€å§‹æ¶ˆè´¹è¿˜æ˜¯é˜Ÿåˆ—å°¾éƒ¨å¼€å§‹æ¶ˆè´¹</span></span><br><span class="line">        <span class="comment">// å¦‚æœéç¬¬ä¸€æ¬¡å¯åŠ¨ï¼Œé‚£ä¹ˆæŒ‰ç…§ä¸Šæ¬¡æ¶ˆè´¹çš„ä½ç½®ç»§ç»­æ¶ˆè´¹</span></span><br><span class="line">        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);</span><br><span class="line">		<span class="comment">// è®¢é˜…ä¸‰ä¸ªtag</span></span><br><span class="line">        consumer.subscribe(<span class="string">&quot;OrderTopic&quot;</span>, <span class="string">&quot;TagA || TagC || TagD&quot;</span>);</span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> <span class="title class_">MessageListenerOrderly</span>() &#123;</span><br><span class="line">            <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ConsumeOrderlyStatus <span class="title function_">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs, ConsumeOrderlyContext context)</span> &#123;</span><br><span class="line">                context.setAutoCommit(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</span><br><span class="line">                    <span class="comment">// å¯ä»¥çœ‹åˆ°æ¯ä¸ªqueueæœ‰å”¯ä¸€çš„consumeçº¿ç¨‹æ¥æ¶ˆè´¹, è®¢å•å¯¹æ¯ä¸ªqueue(åˆ†åŒº)æœ‰åº</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;consumeThread=&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;queueId=&quot;</span> + msg.getQueueId() + <span class="string">&quot;, content:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(msg.getBody()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> ConsumeOrderlyStatus.SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        consumer.start();</span><br><span class="line">        System.out.println(<span class="string">&quot;Consumer Started.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="å»¶æ—¶æ¶ˆæ¯"><a href="#å»¶æ—¶æ¶ˆæ¯" class="headerlink" title="å»¶æ—¶æ¶ˆæ¯"></a>å»¶æ—¶æ¶ˆæ¯</h3><h4 id="åŸç†è§£æ-1"><a href="#åŸç†è§£æ-1" class="headerlink" title="åŸç†è§£æ"></a>åŸç†è§£æ</h4><p>å®šæ—¶æ¶ˆæ¯ï¼ˆå»¶è¿Ÿé˜Ÿåˆ—ï¼‰æ˜¯æŒ‡æ¶ˆæ¯å‘é€åˆ° Broker åï¼Œä¸ä¼šç«‹å³è¢«æ¶ˆè´¹ï¼Œç­‰å¾…ç‰¹å®šæ—¶é—´æŠ•é€’ç»™çœŸæ­£çš„ Topic</p>
<p>RocketMQ å¹¶ä¸æ”¯æŒä»»æ„æ—¶é—´çš„å»¶æ—¶ï¼Œéœ€è¦è®¾ç½®å‡ ä¸ªå›ºå®šçš„å»¶æ—¶ç­‰çº§ï¼Œä» 1s åˆ° 2h åˆ†åˆ«å¯¹åº”ç€ç­‰çº§ 1 åˆ° 18ï¼Œæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ä¼šè¿›å…¥å»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¶ˆæ¯å‘é€æ—¶é—´ä¸è®¾ç½®çš„å»¶æ—¶ç­‰çº§å’Œé‡è¯•æ¬¡æ•°æœ‰å…³ï¼Œè¯¦è§ä»£ç  <code>SendMessageProcessor.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">messageDelayLevel</span> <span class="operator">=</span> <span class="string">&quot;1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>Broker å¯ä»¥é…ç½® messageDelayLevelï¼Œè¯¥å±æ€§æ˜¯ Broker çš„å±æ€§ï¼Œä¸å±äºæŸä¸ª Topic</p>
<p>å‘æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥è®¾ç½®å»¶è¿Ÿç­‰çº§ <code>msg.setDelayLevel(level)</code>ï¼Œlevel æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p>
<ul>
<li>level == 0ï¼šæ¶ˆæ¯ä¸ºéå»¶è¿Ÿæ¶ˆæ¯</li>
<li>1&lt;=level&lt;=maxLevelï¼šæ¶ˆæ¯å»¶è¿Ÿç‰¹å®šæ—¶é—´ï¼Œä¾‹å¦‚ level==1ï¼Œå»¶è¿Ÿ 1s</li>
<li>level &gt; maxLevelï¼šåˆ™ level== maxLevelï¼Œä¾‹å¦‚ level==20ï¼Œå»¶è¿Ÿ 2h</li>
</ul>
<p>å®šæ—¶æ¶ˆæ¯ä¼šæš‚å­˜åœ¨åä¸º SCHEDULE_TOPIC_XXXX çš„ Topic ä¸­ï¼Œå¹¶æ ¹æ® delayTimeLevel å­˜å…¥ç‰¹å®šçš„ queueï¼Œé˜Ÿåˆ—çš„æ ‡è¯† <code>queueId = delayTimeLevel â€“ 1</code>ï¼Œå³<strong>ä¸€ä¸ª queue åªå­˜ç›¸åŒå»¶è¿Ÿçš„æ¶ˆæ¯</strong>ï¼Œä¿è¯å…·æœ‰ç›¸åŒå‘é€å»¶è¿Ÿçš„æ¶ˆæ¯èƒ½å¤Ÿé¡ºåºæ¶ˆè´¹ã€‚Broker ä¼šä¸ºæ¯ä¸ªå»¶è¿Ÿçº§åˆ«æäº¤ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œè°ƒåº¦åœ°æ¶ˆè´¹ SCHEDULE_TOPIC_XXXXï¼Œå°†æ¶ˆæ¯å†™å…¥çœŸå®çš„ Topic</p>
<p>æ³¨æ„ï¼šå®šæ—¶æ¶ˆæ¯åœ¨ç¬¬ä¸€æ¬¡å†™å…¥å’Œè°ƒåº¦å†™å…¥çœŸå® Topic æ—¶éƒ½ä¼šè®¡æ•°ï¼Œå› æ­¤å‘é€æ•°é‡ã€tps éƒ½ä¼šå˜é«˜</p>
<hr>
<h4 id="ä»£ç å®ç°-2"><a href="#ä»£ç å®ç°-2" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h4><p>æäº¤äº†ä¸€ä¸ªè®¢å•å°±å¯ä»¥å‘é€ä¸€ä¸ªå»¶æ—¶æ¶ˆæ¯ï¼Œ1h åå»æ£€æŸ¥è¿™ä¸ªè®¢å•çš„çŠ¶æ€ï¼Œå¦‚æœè¿˜æ˜¯æœªä»˜æ¬¾å°±å–æ¶ˆè®¢å•é‡Šæ”¾åº“å­˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScheduledMessageProducer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–ä¸€ä¸ªç”Ÿäº§è€…æ¥äº§ç”Ÿå»¶æ—¶æ¶ˆæ¯</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;ExampleProducerGroup&quot;</span>);</span><br><span class="line">        producer.setNamesrvAddr(<span class="string">&quot;127.0.0.1:9876&quot;</span>);</span><br><span class="line">        <span class="comment">// å¯åŠ¨ç”Ÿäº§è€…</span></span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="type">int</span> <span class="variable">totalMessagesToSend</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; totalMessagesToSend; i++) &#123;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;DelayTopic&quot;</span>, (<span class="string">&quot;Hello scheduled message &quot;</span> + i).getBytes());</span><br><span class="line">            <span class="comment">// è®¾ç½®å»¶æ—¶ç­‰çº§3,è¿™ä¸ªæ¶ˆæ¯å°†åœ¨10sä¹‹åå‘é€(ç°åœ¨åªæ”¯æŒå›ºå®šçš„å‡ ä¸ªæ—¶é—´,è¯¦çœ‹delayTimeLevel)</span></span><br><span class="line">            message.setDelayTimeLevel(<span class="number">3</span>);</span><br><span class="line">            <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">            producer.send(message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å…³é—­ç”Ÿäº§è€…</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScheduledMessageConsumer</span> &#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="comment">// å®ä¾‹åŒ–æ¶ˆè´¹è€…</span></span><br><span class="line">      <span class="type">DefaultMQPushConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(<span class="string">&quot;ExampleConsumer&quot;</span>);</span><br><span class="line">      consumer.setNamesrvAddr(<span class="string">&quot;127.0.0.1:9876&quot;</span>);</span><br><span class="line">      <span class="comment">// è®¢é˜…Topics</span></span><br><span class="line">      consumer.subscribe(<span class="string">&quot;DelayTopic&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">      <span class="comment">// æ³¨å†Œæ¶ˆæ¯ç›‘å¬è€…</span></span><br><span class="line">      consumer.registerMessageListener(<span class="keyword">new</span> <span class="title class_">MessageListenerConcurrently</span>() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title function_">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; messages, ConsumeConcurrentlyContext context)</span> &#123;</span><br><span class="line">              <span class="keyword">for</span> (MessageExt message : messages) &#123;</span><br><span class="line">                  <span class="comment">// æ‰“å°å»¶è¿Ÿçš„æ—¶é—´æ®µ</span></span><br><span class="line">                  System.out.println(<span class="string">&quot;Receive message[msgId=&quot;</span> + message.getMsgId() + <span class="string">&quot;] &quot;</span> + (System.currentTimeMillis() - message.getBornTimestamp()) + <span class="string">&quot;ms later&quot;</span>);&#125;</span><br><span class="line">              <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// å¯åŠ¨æ¶ˆè´¹è€…</span></span><br><span class="line">      consumer.start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="æ‰¹é‡æ¶ˆæ¯"><a href="#æ‰¹é‡æ¶ˆæ¯" class="headerlink" title="æ‰¹é‡æ¶ˆæ¯"></a>æ‰¹é‡æ¶ˆæ¯</h3><p>æ‰¹é‡å‘é€æ¶ˆæ¯èƒ½æ˜¾è‘—æé«˜ä¼ é€’å°æ¶ˆæ¯çš„æ€§èƒ½ï¼Œé™åˆ¶æ˜¯è¿™äº›æ‰¹é‡æ¶ˆæ¯åº”è¯¥æœ‰ç›¸åŒçš„ topicï¼Œç›¸åŒçš„ waitStoreMsgOKï¼Œè€Œä¸”ä¸èƒ½æ˜¯å»¶æ—¶æ¶ˆæ¯ï¼Œå¹¶ä¸”è¿™ä¸€æ‰¹æ¶ˆæ¯çš„æ€»å¤§å°ä¸åº”è¶…è¿‡ 4MB</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;ExampleProducerGroup&quot;</span>)</span><br><span class="line">        producer.setNamesrvAddr(<span class="string">&quot;127.0.0.1:9876&quot;</span>);</span><br><span class="line">        <span class="comment">//å¯åŠ¨producer</span></span><br><span class="line">        producer.start();</span><br><span class="line"></span><br><span class="line">        List&lt;Message&gt; msgs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Message&gt;();</span><br><span class="line">        <span class="comment">// åˆ›å»ºæ¶ˆæ¯å¯¹è±¡ï¼ŒæŒ‡å®šä¸»é¢˜Topicã€Tagå’Œæ¶ˆæ¯ä½“</span></span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;BatchTopic&quot;</span>, <span class="string">&quot;Tag1&quot;</span>, (<span class="string">&quot;Hello World&quot;</span> + <span class="number">1</span>).getBytes());</span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;BatchTopic&quot;</span>, <span class="string">&quot;Tag1&quot;</span>, (<span class="string">&quot;Hello World&quot;</span> + <span class="number">2</span>).getBytes());</span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;BatchTopic&quot;</span>, <span class="string">&quot;Tag1&quot;</span>, (<span class="string">&quot;Hello World&quot;</span> + <span class="number">3</span>).getBytes());</span><br><span class="line"></span><br><span class="line">        msgs.add(msg1);</span><br><span class="line">        msgs.add(msg2);</span><br><span class="line">        msgs.add(msg3);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">        <span class="type">SendResult</span> <span class="variable">result</span> <span class="operator">=</span> producer.send(msgs);</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘é€ç»“æœ:&quot;</span> + result);</span><br><span class="line">        <span class="comment">// å…³é—­ç”Ÿäº§è€…producer</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“å‘é€å¤§æ‰¹é‡æ•°æ®æ—¶ï¼Œå¯èƒ½ä¸ç¡®å®šæ¶ˆæ¯æ˜¯å¦è¶…è¿‡äº†å¤§å°é™åˆ¶ï¼ˆ4MBï¼‰ï¼Œæ‰€ä»¥éœ€è¦å°†æ¶ˆæ¯åˆ—è¡¨åˆ†å‰²ä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ListSplitter</span> <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;List&lt;Message&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIZE_LIMIT</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Message&gt; messages;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> currIndex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ListSplitter</span><span class="params">(List&lt;Message&gt; messages)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.messages = messages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> currIndex &lt; messages.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Message&gt; <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">startIndex</span> <span class="operator">=</span> getStartIndex();</span><br><span class="line">        <span class="type">int</span> <span class="variable">nextIndex</span> <span class="operator">=</span> startIndex;</span><br><span class="line">        <span class="type">int</span> <span class="variable">totalSize</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (; nextIndex &lt; messages.size(); nextIndex++) &#123;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> messages.get(nextIndex);</span><br><span class="line">            <span class="type">int</span> <span class="variable">tmpSize</span> <span class="operator">=</span> calcMessageSize(message);</span><br><span class="line">            <span class="comment">// å•ä¸ªæ¶ˆæ¯è¶…è¿‡äº†æœ€å¤§çš„é™åˆ¶</span></span><br><span class="line">            <span class="keyword">if</span> (tmpSize + totalSize &gt; SIZE_LIMIT) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                totalSize += tmpSize;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Message&gt; subList = messages.subList(startIndex, nextIndex);</span><br><span class="line">        currIndex = nextIndex;</span><br><span class="line">        <span class="keyword">return</span> subList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getStartIndex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">currMessage</span> <span class="operator">=</span> messages.get(currIndex);</span><br><span class="line">        <span class="type">int</span> <span class="variable">tmpSize</span> <span class="operator">=</span> calcMessageSize(currMessage);</span><br><span class="line">        <span class="keyword">while</span> (tmpSize &gt; SIZE_LIMIT) &#123;</span><br><span class="line">            currIndex += <span class="number">1</span>;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> messages.get(curIndex);</span><br><span class="line">            tmpSize = calcMessageSize(message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> currIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">calcMessageSize</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">tmpSize</span> <span class="operator">=</span> message.getTopic().length() + message.getBody().length;</span><br><span class="line">        Map&lt;String, String&gt; properties = message.getProperties();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : properties.entrySet()) &#123;</span><br><span class="line">            tmpSize += entry.getKey().length() + entry.getValue().length();</span><br><span class="line">        &#125;</span><br><span class="line">        tmpSize = tmpSize + <span class="number">20</span>; <span class="comment">// å¢åŠ â½‡æ—¥å¿—çš„å¼€é”€20å­—èŠ‚</span></span><br><span class="line">        <span class="keyword">return</span> tmpSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//æŠŠå¤§çš„æ¶ˆæ¯åˆ†è£‚æˆè‹¥å¹²ä¸ªå°çš„æ¶ˆæ¯</span></span><br><span class="line">        <span class="type">ListSplitter</span> <span class="variable">splitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListSplitter</span>(messages);</span><br><span class="line">        <span class="keyword">while</span> (splitter.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                List&lt;Message&gt; listItem = splitter.next();</span><br><span class="line">                producer.send(listItem);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="comment">//å¤„ç†error</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="è¿‡æ»¤æ¶ˆæ¯"><a href="#è¿‡æ»¤æ¶ˆæ¯" class="headerlink" title="è¿‡æ»¤æ¶ˆæ¯"></a>è¿‡æ»¤æ¶ˆæ¯</h3><h4 id="åŸºæœ¬è¯­æ³•"><a href="#åŸºæœ¬è¯­æ³•" class="headerlink" title="åŸºæœ¬è¯­æ³•"></a>åŸºæœ¬è¯­æ³•</h4><p>RocketMQ å®šä¹‰äº†ä¸€äº›åŸºæœ¬è¯­æ³•æ¥æ”¯æŒè¿‡æ»¤ç‰¹æ€§ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°æ‰©å±•ï¼š</p>
<ul>
<li>æ•°å€¼æ¯”è¾ƒï¼Œæ¯”å¦‚ï¼š&gt;ï¼Œ&gt;=ï¼Œ&lt;ï¼Œ&lt;=ï¼ŒBETWEENï¼Œ=</li>
<li>å­—ç¬¦æ¯”è¾ƒï¼Œæ¯”å¦‚ï¼š=ï¼Œ&lt;&gt;ï¼ŒIN</li>
<li>IS NULL æˆ–è€… IS NOT NULL</li>
<li>é€»è¾‘ç¬¦å· ANDï¼ŒORï¼ŒNOT</li>
</ul>
<p>å¸¸é‡æ”¯æŒç±»å‹ä¸ºï¼š</p>
<ul>
<li>æ•°å€¼ï¼Œæ¯”å¦‚ 123ï¼Œ3.1415</li>
<li>å­—ç¬¦ï¼Œæ¯”å¦‚ â€˜abcâ€™ï¼Œå¿…é¡»ç”¨å•å¼•å·åŒ…è£¹èµ·æ¥</li>
<li>NULLï¼Œç‰¹æ®Šçš„å¸¸é‡</li>
<li>å¸ƒå°”å€¼ï¼ŒTRUE æˆ– FALSE</li>
</ul>
<p>åªæœ‰ä½¿ç”¨ push æ¨¡å¼çš„æ¶ˆè´¹è€…æ‰èƒ½ç”¨ä½¿ç”¨ SQL92 æ ‡å‡†çš„ sql è¯­å¥ï¼Œæ¥å£å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> MessageSelector messageSelector)</span></span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼šæ¶ˆè´¹è€…æ¥æ”¶åŒ…å« TAGA æˆ– TAGB æˆ– TAGC çš„æ¶ˆæ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultMQPushConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(<span class="string">&quot;CID_EXAMPLE&quot;</span>);</span><br><span class="line">consumer.subscribe(<span class="string">&quot;TOPIC&quot;</span>, <span class="string">&quot;TAGA || TAGB || TAGC&quot;</span>);</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="åŸç†è§£æ-2"><a href="#åŸç†è§£æ-2" class="headerlink" title="åŸç†è§£æ"></a>åŸç†è§£æ</h4><p>RocketMQ åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯è¿‡æ»¤æ–¹å¼æ˜¯åœ¨ Consumer ç«¯è®¢é˜…æ¶ˆæ¯æ—¶å†åšæ¶ˆæ¯è¿‡æ»¤çš„ï¼Œæ‰€ä»¥æ˜¯åœ¨ Broker ç«¯å®ç°çš„ï¼Œä¼˜ç‚¹æ˜¯å‡å°‘äº†å¯¹äº Consumer æ— ç”¨æ¶ˆæ¯çš„ç½‘ç»œä¼ è¾“ï¼Œç¼ºç‚¹æ˜¯å¢åŠ äº† Broker çš„è´Ÿæ‹…ï¼Œè€Œä¸”å®ç°ç›¸å¯¹å¤æ‚</p>
<p>RocketMQ åœ¨ Producer ç«¯å†™å…¥æ¶ˆæ¯å’Œåœ¨ Consumer ç«¯è®¢é˜…æ¶ˆæ¯é‡‡ç”¨<strong>åˆ†ç¦»å­˜å‚¨</strong>çš„æœºåˆ¶å®ç°ï¼ŒConsumer ç«¯è®¢é˜…æ¶ˆæ¯æ˜¯éœ€è¦é€šè¿‡ ConsumeQueue è¿™ä¸ªæ¶ˆæ¯æ¶ˆè´¹çš„é€»è¾‘é˜Ÿåˆ—æ‹¿åˆ°ä¸€ä¸ªç´¢å¼•ï¼Œç„¶åå†ä» CommitLog é‡Œé¢è¯»å–çœŸæ­£çš„æ¶ˆæ¯å®ä½“å†…å®¹</p>
<p>ConsumeQueue çš„å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼Œæœ‰ 8 ä¸ªå­—èŠ‚å­˜å‚¨çš„ Message Tag çš„å“ˆå¸Œå€¼ï¼ŒåŸºäº Tag çš„æ¶ˆæ¯è¿‡æ»¤å°±æ˜¯åŸºäºè¿™ä¸ªå­—æ®µ</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-æ¶ˆè´¹é˜Ÿåˆ—ç»“æ„.png" alt=""></p>
<ul>
<li><p>Tag è¿‡æ»¤ï¼šConsumer ç«¯è®¢é˜…æ¶ˆæ¯æ—¶æŒ‡å®š Topic å’Œ TAGï¼Œç„¶åå°†è®¢é˜…è¯·æ±‚æ„å»ºæˆä¸€ä¸ª SubscriptionDataï¼Œå‘é€ä¸€ä¸ª Pull æ¶ˆæ¯çš„è¯·æ±‚ç»™ Broker ç«¯ã€‚Broker ç«¯ç”¨è¿™äº›æ•°æ®å…ˆæ„å»ºä¸€ä¸ª MessageFilterï¼Œç„¶åä¼ ç»™æ–‡ä»¶å­˜å‚¨å±‚ Storeã€‚Store ä» ConsumeQueue è¯»å–åˆ°ä¸€æ¡è®°å½•åï¼Œä¼šç”¨å®ƒè®°å½•çš„æ¶ˆæ¯ tag hash å€¼å»åšè¿‡æ»¤ã€‚å› ä¸ºåœ¨æœåŠ¡ç«¯åªæ˜¯æ ¹æ® hashcode è¿›è¡Œåˆ¤æ–­ï¼Œæ— æ³•ç²¾ç¡®å¯¹ tag åŸå§‹å­—ç¬¦ä¸²è¿›è¡Œè¿‡æ»¤ï¼Œæ‰€ä»¥æ¶ˆè´¹ç«¯æ‹‰å–åˆ°æ¶ˆæ¯åï¼Œè¿˜éœ€è¦å¯¹æ¶ˆæ¯çš„åŸå§‹ tag å­—ç¬¦ä¸²è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœä¸åŒï¼Œåˆ™ä¸¢å¼ƒè¯¥æ¶ˆæ¯ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ¶ˆè´¹</p>
</li>
<li><p>SQL92 è¿‡æ»¤ï¼šå·¥ä½œæµç¨‹å’Œ Tag è¿‡æ»¤å¤§è‡´ä¸€æ ·ï¼Œåªæ˜¯åœ¨ Store å±‚çš„å…·ä½“è¿‡æ»¤æ–¹å¼ä¸ä¸€æ ·ã€‚çœŸæ­£çš„ SQL expression çš„æ„å»ºå’Œæ‰§è¡Œç”± rocketmq-filter æ¨¡å—è´Ÿè´£ï¼Œæ¯æ¬¡è¿‡æ»¤éƒ½å»æ‰§è¡Œ SQL è¡¨è¾¾å¼ä¼šå½±å“æ•ˆç‡ï¼Œæ‰€ä»¥ RocketMQ ä½¿ç”¨äº† BloomFilter æ¥é¿å…äº†æ¯æ¬¡éƒ½å»æ‰§è¡Œ</p>
</li>
</ul>
<hr>
<h4 id="ä»£ç å®ç°-3"><a href="#ä»£ç å®ç°-3" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h4><p>å‘é€æ¶ˆæ¯æ—¶ï¼Œé€šè¿‡ putUserProperty æ¥è®¾ç½®æ¶ˆæ¯çš„å±æ€§ï¼ŒSQL92 çš„è¡¨è¾¾å¼ä¸Šä¸‹æ–‡ä¸ºæ¶ˆæ¯çš„å±æ€§</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">        producer.setNamesrvAddr(<span class="string">&quot;127.0.0.1:9876&quot;</span>);</span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;FilterTopic&quot;</span>, <span class="string">&quot;tag&quot;</span>,</span><br><span class="line">               (<span class="string">&quot;Hello RocketMQ &quot;</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">            <span class="comment">// è®¾ç½®ä¸€äº›å±æ€§</span></span><br><span class="line">            msg.putUserProperty(<span class="string">&quot;i&quot;</span>, String.valueOf(i));</span><br><span class="line">            <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.send(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ SQL ç­›é€‰è¿‡æ»¤æ¶ˆæ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">DefaultMQPushConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">&quot;127.0.0.1:9876&quot;</span>);</span><br><span class="line">        <span class="comment">// è¿‡æ»¤å±æ€§å¤§äº 5  çš„æ¶ˆæ¯</span></span><br><span class="line">        consumer.subscribe(<span class="string">&quot;FilterTopic&quot;</span>, MessageSelector.bySql(<span class="string">&quot;i&gt;5&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®å›è°ƒå‡½æ•°ï¼Œå¤„ç†æ¶ˆæ¯</span></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> <span class="title class_">MessageListenerConcurrently</span>() &#123;</span><br><span class="line">            <span class="comment">//æ¥å—æ¶ˆæ¯å†…å®¹</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title function_">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context)</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;consumeThread=&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;,&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(msg.getBody()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// å¯åŠ¨æ¶ˆè´¹è€…consumer</span></span><br><span class="line">        consumer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="äº‹åŠ¡æ¶ˆæ¯"><a href="#äº‹åŠ¡æ¶ˆæ¯" class="headerlink" title="äº‹åŠ¡æ¶ˆæ¯"></a>äº‹åŠ¡æ¶ˆæ¯</h3><h4 id="å·¥ä½œæµç¨‹"><a href="#å·¥ä½œæµç¨‹" class="headerlink" title="å·¥ä½œæµç¨‹"></a>å·¥ä½œæµç¨‹</h4><p>RocketMQ æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡æ¶ˆæ¯ï¼Œé‡‡ç”¨äº† 2PC çš„æ€æƒ³æ¥å®ç°äº†æäº¤äº‹åŠ¡æ¶ˆæ¯ï¼ŒåŒæ—¶å¢åŠ ä¸€ä¸ª<strong>è¡¥å¿é€»è¾‘</strong>æ¥å¤„ç†äºŒé˜¶æ®µè¶…æ—¶æˆ–è€…å¤±è´¥çš„æ¶ˆæ¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-äº‹åŠ¡æ¶ˆæ¯.png" alt=""></p>
<p>äº‹åŠ¡æ¶ˆæ¯çš„å¤§è‡´æ–¹æ¡ˆåˆ†ä¸ºä¸¤ä¸ªæµç¨‹ï¼šæ­£å¸¸äº‹åŠ¡æ¶ˆæ¯çš„å‘é€åŠæäº¤ã€äº‹åŠ¡æ¶ˆæ¯çš„è¡¥å¿æµç¨‹</p>
<ol>
<li><p>äº‹åŠ¡æ¶ˆæ¯å‘é€åŠæäº¤ï¼š</p>
<ul>
<li><p>å‘é€æ¶ˆæ¯ï¼ˆHalf æ¶ˆæ¯ï¼‰ï¼ŒæœåŠ¡å™¨å°†æ¶ˆæ¯çš„ä¸»é¢˜å’Œé˜Ÿåˆ—æ”¹ä¸ºåŠæ¶ˆæ¯çŠ¶æ€ï¼Œå¹¶æ”¾å…¥åŠæ¶ˆæ¯é˜Ÿåˆ—</p>
</li>
<li><p>æœåŠ¡ç«¯å“åº”æ¶ˆæ¯å†™å…¥ç»“æœï¼ˆå¦‚æœå†™å…¥å¤±è´¥ï¼Œæ­¤æ—¶ Half æ¶ˆæ¯å¯¹ä¸šåŠ¡ä¸å¯è§ï¼‰</p>
</li>
<li>æ ¹æ®å‘é€ç»“æœæ‰§è¡Œæœ¬åœ°äº‹åŠ¡</li>
<li>æ ¹æ®æœ¬åœ°äº‹åŠ¡çŠ¶æ€æ‰§è¡Œ Commit æˆ–è€… Rollback</li>
</ul>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-äº‹åŠ¡å·¥ä½œæµç¨‹.png" alt=""></p>
<ol>
<li><p>è¡¥å¿æœºåˆ¶ï¼šç”¨äºè§£å†³æ¶ˆæ¯ Commit æˆ–è€… Rollback å‘ç”Ÿè¶…æ—¶æˆ–è€…å¤±è´¥çš„æƒ…å†µï¼Œæ¯”å¦‚å‡ºç°ç½‘ç»œé—®é¢˜</p>
<ul>
<li>Broker æœåŠ¡ç«¯é€šè¿‡<strong>å¯¹æ¯” Half æ¶ˆæ¯å’Œ Op æ¶ˆæ¯</strong>ï¼Œå¯¹æœªç¡®å®šçŠ¶æ€çš„æ¶ˆæ¯æ¨è¿› CheckPoint</li>
<li>æ²¡æœ‰ Commit/Rollback çš„äº‹åŠ¡æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯æ ¹æ®æ ¹æ®åŠæ¶ˆæ¯çš„ç”Ÿäº§è€…ç»„ï¼Œåˆ° ProducerManager ä¸­è·å–ç”Ÿäº§è€…ï¼ˆåŒä¸€ä¸ª Group çš„ Producerï¼‰çš„ä¼šè¯é€šé“ï¼Œå‘èµ·ä¸€æ¬¡å›æŸ¥ï¼ˆ<strong>å•å‘è¯·æ±‚</strong>ï¼‰</li>
<li>Producer æ”¶åˆ°å›æŸ¥æ¶ˆæ¯ï¼Œæ£€æŸ¥äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€è¡¨å†…å¯¹åº”çš„æœ¬åœ°äº‹åŠ¡çš„çŠ¶æ€</li>
<li>æ ¹æ®æœ¬åœ°äº‹åŠ¡çŠ¶æ€ï¼Œé‡æ–° Commit æˆ–è€… Rollback</li>
</ul>
<p>RocketMQ å¹¶ä¸ä¼šæ— ä¼‘æ­¢çš„è¿›è¡Œäº‹åŠ¡çŠ¶æ€å›æŸ¥ï¼Œæœ€å¤§å›æŸ¥ 15 æ¬¡ï¼Œå¦‚æœ 15 æ¬¡å›æŸ¥è¿˜æ˜¯æ— æ³•å¾—çŸ¥äº‹åŠ¡çŠ¶æ€ï¼Œåˆ™é»˜è®¤å›æ»šè¯¥æ¶ˆæ¯ï¼Œ</p>
<p>å›æŸ¥æœåŠ¡ï¼š<code>TransactionalMessageCheckService#run</code></p>
</li>
</ol>
<hr>
<h4 id="ä¸¤é˜¶æ®µ"><a href="#ä¸¤é˜¶æ®µ" class="headerlink" title="ä¸¤é˜¶æ®µ"></a>ä¸¤é˜¶æ®µ</h4><h5 id="ä¸€é˜¶æ®µ"><a href="#ä¸€é˜¶æ®µ" class="headerlink" title="ä¸€é˜¶æ®µ"></a>ä¸€é˜¶æ®µ</h5><p>äº‹åŠ¡æ¶ˆæ¯ç›¸å¯¹æ™®é€šæ¶ˆæ¯æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯<strong>ä¸€é˜¶æ®µå‘é€çš„æ¶ˆæ¯å¯¹ç”¨æˆ·æ˜¯ä¸å¯è§çš„</strong>ï¼Œå› ä¸ºå¯¹äº Half æ¶ˆæ¯ï¼Œä¼šå¤‡ä»½åŸæ¶ˆæ¯çš„ä¸»é¢˜ä¸æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œç„¶åæ”¹å˜ä¸»é¢˜ä¸º RMQ_SYS_TRANS_HALF_TOPICï¼Œç”±äºæ¶ˆè´¹ç»„æœªè®¢é˜…è¯¥ä¸»é¢˜ï¼Œæ•…æ¶ˆè´¹ç«¯æ— æ³•æ¶ˆè´¹ Half ç±»å‹çš„æ¶ˆæ¯</p>
<p>RocketMQ ä¼šå¼€å¯ä¸€ä¸ª<strong>å®šæ—¶ä»»åŠ¡</strong>ï¼Œä» Topic ä¸º RMQ_SYS_TRANS_HALF_TOPIC ä¸­æ‹‰å–æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ï¼Œæ ¹æ®ç”Ÿäº§è€…ç»„è·å–ä¸€ä¸ªæœåŠ¡æä¾›è€…å‘é€å›æŸ¥äº‹åŠ¡çŠ¶æ€è¯·æ±‚ï¼Œæ ¹æ®äº‹åŠ¡çŠ¶æ€æ¥å†³å®šæ˜¯æäº¤æˆ–å›æ»šæ¶ˆæ¯</p>
<p>RocketMQ çš„å…·ä½“å®ç°ç­–ç•¥ï¼šå¦‚æœå†™å…¥çš„æ˜¯äº‹åŠ¡æ¶ˆæ¯ï¼Œå¯¹æ¶ˆæ¯çš„ Topic å’Œ Queue ç­‰å±æ€§è¿›è¡Œæ›¿æ¢ï¼ŒåŒæ—¶å°†åŸæ¥çš„ Topic å’Œ Queue ä¿¡æ¯å­˜å‚¨åˆ°<strong>æ¶ˆæ¯çš„å±æ€§</strong>ä¸­ï¼Œå› ä¸ºæ¶ˆæ¯çš„ä¸»é¢˜è¢«æ›¿æ¢ï¼Œæ‰€ä»¥æ¶ˆæ¯ä¸ä¼šè½¬å‘åˆ°è¯¥åŸä¸»é¢˜çš„æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…æ— æ³•æ„ŸçŸ¥æ¶ˆæ¯çš„å­˜åœ¨ï¼Œä¸ä¼šæ¶ˆè´¹</p>
<hr>
<h5 id="äºŒé˜¶æ®µ"><a href="#äºŒé˜¶æ®µ" class="headerlink" title="äºŒé˜¶æ®µ"></a>äºŒé˜¶æ®µ</h5><p>ä¸€é˜¶æ®µå†™å…¥ä¸å¯è§çš„æ¶ˆæ¯åï¼ŒäºŒé˜¶æ®µæ“ä½œï¼š</p>
<ul>
<li><p>å¦‚æœæ‰§è¡Œ Commit æ“ä½œï¼Œåˆ™éœ€è¦è®©æ¶ˆæ¯å¯¹ç”¨æˆ·å¯è§ï¼Œæ„å»ºå‡º Half æ¶ˆæ¯çš„ç´¢å¼•ã€‚ä¸€é˜¶æ®µçš„ Half æ¶ˆæ¯å†™åˆ°ä¸€ä¸ªç‰¹æ®Šçš„ Topicï¼Œæ„å»ºç´¢å¼•æ—¶éœ€è¦è¯»å–å‡º Half æ¶ˆæ¯ï¼Œç„¶åé€šè¿‡ä¸€æ¬¡æ™®é€šæ¶ˆæ¯çš„å†™å…¥æ“ä½œå°† Topic å’Œ Queue æ›¿æ¢æˆçœŸæ­£çš„ç›®æ ‡ Topic å’Œ Queueï¼Œç”Ÿæˆä¸€æ¡å¯¹ç”¨æˆ·å¯è§çš„æ¶ˆæ¯ã€‚å…¶å®å°±æ˜¯åˆ©ç”¨äº†ä¸€é˜¶æ®µå­˜å‚¨çš„æ¶ˆæ¯çš„å†…å®¹ï¼Œåœ¨äºŒé˜¶æ®µæ—¶æ¢å¤å‡ºä¸€æ¡å®Œæ•´çš„æ™®é€šæ¶ˆæ¯ï¼Œç„¶åèµ°ä¸€éæ¶ˆæ¯å†™å…¥æµç¨‹</p>
</li>
<li><p>å¦‚æœæ˜¯ Rollback åˆ™éœ€è¦æ’¤é”€ä¸€é˜¶æ®µçš„æ¶ˆæ¯ï¼Œå› ä¸ºæ¶ˆæ¯æœ¬å°±ä¸å¯è§ï¼Œæ‰€ä»¥å¹¶<strong>ä¸éœ€è¦çœŸæ­£æ’¤é”€æ¶ˆæ¯</strong>ï¼ˆå®é™…ä¸Š RocketMQ ä¹Ÿæ— æ³•å»åˆ é™¤ä¸€æ¡æ¶ˆæ¯ï¼Œå› ä¸ºæ˜¯é¡ºåºå†™æ–‡ä»¶çš„ï¼‰ã€‚RocketMQ ä¸ºäº†åŒºåˆ†è¿™æ¡æ¶ˆæ¯æ²¡æœ‰ç¡®å®šçŠ¶æ€çš„æ¶ˆæ¯ï¼Œé‡‡ç”¨ Op æ¶ˆæ¯æ ‡è¯†å·²ç»ç¡®å®šçŠ¶æ€çš„äº‹åŠ¡æ¶ˆæ¯ï¼ˆCommit æˆ–è€… Rollbackï¼‰</p>
</li>
</ul>
<p><strong>äº‹åŠ¡æ¶ˆæ¯æ— è®ºæ˜¯ Commit æˆ–è€… Rollback éƒ½ä¼šè®°å½•ä¸€ä¸ª Op æ“ä½œ</strong>ï¼Œä¸¤è€…çš„åŒºåˆ«æ˜¯ Commit ç›¸å¯¹äº Rollback åœ¨å†™å…¥ Op æ¶ˆæ¯å‰å°†åŸæ¶ˆæ¯çš„ä¸»é¢˜å’Œé˜Ÿåˆ—æ¢å¤ã€‚å¦‚æœä¸€æ¡äº‹åŠ¡æ¶ˆæ¯æ²¡æœ‰å¯¹åº”çš„ Op æ¶ˆæ¯ï¼Œè¯´æ˜è¿™ä¸ªäº‹åŠ¡çš„çŠ¶æ€è¿˜æ— æ³•ç¡®å®šï¼ˆå¯èƒ½æ˜¯äºŒé˜¶æ®µå¤±è´¥äº†ï¼‰</p>
<p>RocketMQ å°† Op æ¶ˆæ¯å†™å…¥åˆ°å…¨å±€ä¸€ä¸ªç‰¹å®šçš„ Topic ä¸­ï¼Œé€šè¿‡æºç ä¸­çš„æ–¹æ³• <code>TransactionalMessageUtil.buildOpTopic()</code>ï¼Œè¿™ä¸ªä¸»é¢˜æ˜¯ä¸€ä¸ªå†…éƒ¨çš„ Topicï¼ˆåƒ Half æ¶ˆæ¯çš„ Topic ä¸€æ ·ï¼‰ï¼Œä¸ä¼šè¢«ç”¨æˆ·æ¶ˆè´¹ã€‚Op æ¶ˆæ¯çš„å†…å®¹ä¸ºå¯¹åº”çš„ Half æ¶ˆæ¯çš„å­˜å‚¨çš„ Offsetï¼Œè¿™æ ·<strong>é€šè¿‡ Op  æ¶ˆæ¯èƒ½ç´¢å¼•åˆ° Half æ¶ˆæ¯</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-OPæ¶ˆæ¯.png" alt=""></p>
<hr>
<h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><h5 id="ä½¿ç”¨æ–¹å¼"><a href="#ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h5><p>äº‹åŠ¡æ¶ˆæ¯å…±æœ‰ä¸‰ç§çŠ¶æ€ï¼Œæäº¤çŠ¶æ€ã€å›æ»šçŠ¶æ€ã€ä¸­é—´çŠ¶æ€ï¼š</p>
<ul>
<li>TransactionStatus.CommitTransactionï¼šæäº¤äº‹åŠ¡ï¼Œå…è®¸æ¶ˆè´¹è€…æ¶ˆè´¹æ­¤æ¶ˆæ¯ã€‚</li>
<li>TransactionStatus.RollbackTransactionï¼šå›æ»šäº‹åŠ¡ï¼Œä»£è¡¨è¯¥æ¶ˆæ¯å°†è¢«åˆ é™¤ï¼Œä¸å…è®¸è¢«æ¶ˆè´¹</li>
<li>TransactionStatus.Unknownï¼šä¸­é—´çŠ¶æ€ï¼Œä»£è¡¨éœ€è¦æ£€æŸ¥æ¶ˆæ¯é˜Ÿåˆ—æ¥ç¡®å®šçŠ¶æ€</li>
</ul>
<p>ä½¿ç”¨é™åˆ¶ï¼š</p>
<ol>
<li>äº‹åŠ¡æ¶ˆæ¯ä¸æ”¯æŒå»¶æ—¶æ¶ˆæ¯å’Œæ‰¹é‡æ¶ˆæ¯</li>
<li>Broker é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•° <code>transactionTimeout</code> ä¸ºç‰¹å®šæ—¶é—´ï¼Œäº‹åŠ¡æ¶ˆæ¯å°†åœ¨ç‰¹å®šæ—¶é—´é•¿åº¦ä¹‹åè¢«æ£€æŸ¥ã€‚å½“å‘é€äº‹åŠ¡æ¶ˆæ¯æ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡è®¾ç½®ç”¨æˆ·å±æ€§ <code>CHECK_IMMUNITY_TIME_IN_SECONDS</code> æ¥æ”¹å˜è¿™ä¸ªé™åˆ¶ï¼Œè¯¥å‚æ•°ä¼˜å…ˆäº <code>transactionTimeout</code> å‚æ•°</li>
<li>ä¸ºäº†é¿å…å•ä¸ªæ¶ˆæ¯è¢«æ£€æŸ¥å¤ªå¤šæ¬¡è€Œå¯¼è‡´åŠé˜Ÿåˆ—æ¶ˆæ¯ç´¯ç§¯ï¼Œé»˜è®¤å°†å•ä¸ªæ¶ˆæ¯çš„æ£€æŸ¥æ¬¡æ•°é™åˆ¶ä¸º 15 æ¬¡ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ Broker é…ç½®æ–‡ä»¶çš„ <code>transactionCheckMax</code> å‚æ•°æ¥ä¿®æ”¹æ­¤é™åˆ¶ã€‚å¦‚æœå·²ç»æ£€æŸ¥æŸæ¡æ¶ˆæ¯è¶…è¿‡ N æ¬¡ï¼ˆN = <code>transactionCheckMax</code>ï¼‰ï¼Œ åˆ™ Broker å°†ä¸¢å¼ƒæ­¤æ¶ˆæ¯ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šæ‰“å°é”™è¯¯æ—¥å¿—ã€‚å¯ä»¥é€šè¿‡é‡å†™ <code>AbstractTransactionalMessageCheckListener</code> ç±»æ¥ä¿®æ”¹è¿™ä¸ªè¡Œä¸º</li>
<li>äº‹åŠ¡æ€§æ¶ˆæ¯å¯èƒ½ä¸æ­¢ä¸€æ¬¡è¢«æ£€æŸ¥æˆ–æ¶ˆè´¹</li>
<li>æäº¤ç»™ç”¨æˆ·çš„ç›®æ ‡ä¸»é¢˜æ¶ˆæ¯å¯èƒ½ä¼šå¤±è´¥ï¼Œå¯ä»¥æŸ¥çœ‹æ—¥å¿—çš„è®°å½•ã€‚äº‹åŠ¡çš„é«˜å¯ç”¨æ€§é€šè¿‡ RocketMQ æœ¬èº«çš„é«˜å¯ç”¨æ€§æœºåˆ¶æ¥ä¿è¯ï¼Œå¦‚æœå¸Œæœ›äº‹åŠ¡æ¶ˆæ¯ä¸ä¸¢å¤±ã€å¹¶ä¸”äº‹åŠ¡å®Œæ•´æ€§å¾—åˆ°ä¿è¯ï¼Œå¯ä»¥ä½¿ç”¨åŒæ­¥çš„åŒé‡å†™å…¥æœºåˆ¶</li>
<li>äº‹åŠ¡æ¶ˆæ¯çš„ç”Ÿäº§è€… ID ä¸èƒ½ä¸å…¶ä»–ç±»å‹æ¶ˆæ¯çš„ç”Ÿäº§è€… ID å…±äº«ã€‚ä¸å…¶ä»–ç±»å‹çš„æ¶ˆæ¯ä¸åŒï¼Œäº‹åŠ¡æ¶ˆæ¯å…è®¸åå‘æŸ¥è¯¢ï¼ŒMQ æœåŠ¡å™¨èƒ½é€šè¿‡æ¶ˆæ¯çš„ç”Ÿäº§è€… ID æŸ¥è¯¢åˆ°æ¶ˆè´¹è€…</li>
</ol>
<hr>
<h5 id="ä»£ç å®ç°-4"><a href="#ä»£ç å®ç°-4" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h5><p>å®ç°äº‹åŠ¡çš„ç›‘å¬æ¥å£ï¼Œå½“å‘é€åŠæ¶ˆæ¯æˆåŠŸæ—¶ï¼š</p>
<ul>
<li><code>executeLocalTransaction</code> æ–¹æ³•æ¥æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œè¿”å›ä¸‰ä¸ªäº‹åŠ¡çŠ¶æ€ä¹‹ä¸€</li>
<li><code>checkLocalTransaction</code> æ–¹æ³•æ£€æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€ï¼Œå“åº”æ¶ˆæ¯é˜Ÿåˆ—çš„æ£€æŸ¥è¯·æ±‚ï¼Œè¿”å›ä¸‰ä¸ªäº‹åŠ¡çŠ¶æ€ä¹‹ä¸€</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionListenerImpl</span> <span class="keyword">implements</span> <span class="title class_">TransactionListener</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">transactionIndex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">private</span> ConcurrentHashMap&lt;String, Integer&gt; localTrans = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> LocalTransactionState <span class="title function_">executeLocalTransaction</span><span class="params">(Message msg, Object arg)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> transactionIndex.getAndIncrement();</span><br><span class="line">        <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> value % <span class="number">3</span>;</span><br><span class="line">        <span class="comment">// å°†äº‹åŠ¡IDå’ŒçŠ¶æ€å­˜å…¥ map é›†åˆ</span></span><br><span class="line">        localTrans.put(msg.getTransactionId(), status);</span><br><span class="line">        <span class="keyword">return</span> LocalTransactionState.UNKNOW;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> LocalTransactionState <span class="title function_">checkLocalTransaction</span><span class="params">(MessageExt msg)</span> &#123;</span><br><span class="line">        <span class="comment">// ä» map é›†åˆè¯»å‡ºå½“å‰äº‹åŠ¡å¯¹åº”çš„çŠ¶æ€</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> localTrans.get(msg.getTransactionId());</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != status) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (status) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">return</span> LocalTransactionState.UNKNOW;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    <span class="keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ <strong>TransactionMQProducer</strong> ç±»åˆ›å»ºäº‹åŠ¡æ€§ç”Ÿäº§è€…ï¼Œå¹¶æŒ‡å®šå”¯ä¸€çš„ <code>ProducerGroup</code>ï¼Œå°±å¯ä»¥è®¾ç½®è‡ªå®šä¹‰çº¿ç¨‹æ± æ¥å¤„ç†è¿™äº›æ£€æŸ¥è¯·æ±‚ï¼Œæ‰§è¡Œæœ¬åœ°äº‹åŠ¡åï¼Œéœ€è¦æ ¹æ®æ‰§è¡Œç»“æœå¯¹æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå›å¤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæ¶ˆæ¯ç”Ÿäº§è€…</span></span><br><span class="line">       	<span class="type">TransactionMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransactionMQProducer</span>(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">       	<span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">2</span>, <span class="number">5</span>, <span class="number">100</span>, TimeUnit.SECONDS);</span><br><span class="line">        producer.setExecutorService(executorService);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ›å»ºäº‹åŠ¡ç›‘å¬å™¨</span></span><br><span class="line">		<span class="type">TransactionListener</span> <span class="variable">transactionListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransactionListenerImpl</span>();</span><br><span class="line">        <span class="comment">// ç”Ÿäº§è€…çš„ç›‘å¬å™¨</span></span><br><span class="line">        producer.setTransactionListener(transactionListener);</span><br><span class="line">       	<span class="comment">// å¯åŠ¨ç”Ÿäº§è€…</span></span><br><span class="line">        producer.start();</span><br><span class="line">        String[] tags = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;TagA&quot;</span>, <span class="string">&quot;TagB&quot;</span>, <span class="string">&quot;TagC&quot;</span>, <span class="string">&quot;TagD&quot;</span>, <span class="string">&quot;TagE&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TransactionTopic&quot;</span>, tags[i % tags.length], <span class="string">&quot;KEY&quot;</span> + i,</span><br><span class="line">                                (<span class="string">&quot;Hello RocketMQ &quot;</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">                <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.sendMessageInTransaction(msg, <span class="literal">null</span>);</span><br><span class="line">                System.out.printf(<span class="string">&quot;%s%n&quot;</span>, sendResult);</span><br><span class="line">                Thread.sleep(<span class="number">10</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (MQClientException | UnsupportedEncodingException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       	<span class="comment">//Thread.sleep(1000000);</span></span><br><span class="line">        <span class="comment">//producer.shutdown();æš‚æ—¶ä¸å…³é—­</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¶ˆè´¹è€…ä»£ç å’Œå‰é¢çš„å®ä¾‹ç›¸åŒçš„</p>
<hr>
<h2 id="ç³»ç»Ÿç‰¹æ€§"><a href="#ç³»ç»Ÿç‰¹æ€§" class="headerlink" title="ç³»ç»Ÿç‰¹æ€§"></a>ç³»ç»Ÿç‰¹æ€§</h2><h3 id="å·¥ä½œæµç¨‹-1"><a href="#å·¥ä½œæµç¨‹-1" class="headerlink" title="å·¥ä½œæµç¨‹"></a>å·¥ä½œæµç¨‹</h3><h4 id="æ¨¡å—ä»‹ç»"><a href="#æ¨¡å—ä»‹ç»" class="headerlink" title="æ¨¡å—ä»‹ç»"></a>æ¨¡å—ä»‹ç»</h4><p>NameServer æ˜¯ä¸€ä¸ªç®€å•çš„ Topic è·¯ç”±æ³¨å†Œä¸­å¿ƒï¼Œæ”¯æŒ Broker çš„åŠ¨æ€æ³¨å†Œä¸å‘ç°ï¼Œç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…èƒ½å¤Ÿé€šè¿‡åå­—æœåŠ¡æŸ¥æ‰¾å„ä¸»é¢˜ç›¸åº”çš„ Broker IP åˆ—è¡¨</p>
<p>NameServer ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªåŠŸèƒ½ï¼š</p>
<ul>
<li>Broker ç®¡ç†ï¼ŒNameServer æ¥å— Broker é›†ç¾¤çš„æ³¨å†Œä¿¡æ¯ï¼Œä¿å­˜ä¸‹æ¥ä½œä¸ºè·¯ç”±ä¿¡æ¯çš„åŸºæœ¬æ•°æ®ï¼Œæä¾›<strong>å¿ƒè·³æ£€æµ‹æœºåˆ¶</strong>æ£€æŸ¥ Broker æ˜¯å¦è¿˜å­˜æ´»ï¼Œæ¯ 10 ç§’æ¸…é™¤ä¸€æ¬¡ä¸¤å°æ—¶æ²¡æœ‰æ´»è·ƒçš„ Broker</li>
<li>è·¯ç”±ä¿¡æ¯ç®¡ç†ï¼Œæ¯ä¸ª NameServer å°†ä¿å­˜å…³äº Broker é›†ç¾¤çš„æ•´ä¸ªè·¯ç”±ä¿¡æ¯å’Œç”¨äºå®¢æˆ·ç«¯æŸ¥è¯¢çš„é˜Ÿåˆ—ä¿¡æ¯ï¼Œç„¶å Producer å’Œ Conumser é€šè¿‡ NameServer å°±å¯ä»¥çŸ¥é“æ•´ä¸ª Broker é›†ç¾¤çš„è·¯ç”±ä¿¡æ¯ï¼Œä»è€Œè¿›è¡Œæ¶ˆæ¯çš„æŠ•é€’å’Œæ¶ˆè´¹</li>
</ul>
<p>NameServer ç‰¹ç‚¹ï¼š</p>
<ul>
<li>NameServer é€šå¸¸æ˜¯é›†ç¾¤çš„æ–¹å¼éƒ¨ç½²ï¼Œ<strong>å„å®ä¾‹é—´ç›¸äº’ä¸è¿›è¡Œä¿¡æ¯é€šè®¯</strong></li>
<li>Broker å‘æ¯ä¸€å° NameServerï¼ˆé›†ç¾¤ï¼‰æ³¨å†Œè‡ªå·±çš„è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥æ¯ä¸ª NameServer å®ä¾‹ä¸Šé¢<strong>éƒ½ä¿å­˜ä¸€ä»½å®Œæ•´çš„è·¯ç”±ä¿¡æ¯</strong></li>
<li>å½“æŸä¸ª NameServer å› æŸç§åŸå› ä¸‹çº¿äº†ï¼ŒBroker ä»å¯ä»¥å‘å…¶å®ƒ NameServer åŒæ­¥å…¶è·¯ç”±ä¿¡æ¯</li>
</ul>
<p>BrokerServer ä¸»è¦è´Ÿè´£æ¶ˆæ¯çš„å­˜å‚¨ã€æŠ•é€’å’ŒæŸ¥è¯¢ä»¥åŠæœåŠ¡é«˜å¯ç”¨ä¿è¯ï¼Œåœ¨ RocketMQ ç³»ç»Ÿä¸­æ¥æ”¶ä»ç”Ÿäº§è€…å‘é€æ¥çš„æ¶ˆæ¯å¹¶å­˜å‚¨ã€åŒæ—¶ä¸ºæ¶ˆè´¹è€…çš„æ‹‰å–è¯·æ±‚ä½œå‡†å¤‡ï¼Œä¹Ÿå­˜å‚¨æ¶ˆæ¯ç›¸å…³çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ¶ˆè´¹è€…ç»„ã€æ¶ˆè´¹è¿›åº¦åç§»å’Œä¸»é¢˜å’Œé˜Ÿåˆ—æ¶ˆæ¯ç­‰</p>
<p>Broker åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªé‡è¦å­æ¨¡å—ï¼š</p>
<ul>
<li><p>Remoting Moduleï¼šæ•´ä¸ª Broker çš„å®ä½“ï¼Œè´Ÿè´£å¤„ç†æ¥è‡ª Clients ç«¯çš„è¯·æ±‚</p>
</li>
<li><p>Client Managerï¼šè´Ÿè´£ç®¡ç†å®¢æˆ·ç«¯ï¼ˆProducer/Consumerï¼‰å’Œç»´æŠ¤ Consumer çš„ Topic è®¢é˜…ä¿¡æ¯</p>
</li>
<li><p>Store Serviceï¼šæä¾›æ–¹ä¾¿ç®€å•çš„ API æ¥å£å¤„ç†æ¶ˆæ¯å­˜å‚¨åˆ°ç‰©ç†ç¡¬ç›˜å’ŒæŸ¥è¯¢åŠŸèƒ½</p>
</li>
<li><p>HA Serviceï¼šé«˜å¯ç”¨æœåŠ¡ï¼Œæä¾› Master Broker å’Œ Slave Broker ä¹‹é—´çš„æ•°æ®åŒæ­¥åŠŸèƒ½</p>
</li>
<li><p>Index Serviceï¼šæ ¹æ®ç‰¹å®šçš„ Message key å¯¹æŠ•é€’åˆ° Broker çš„æ¶ˆæ¯è¿›è¡Œç´¢å¼•æœåŠ¡ï¼Œä»¥æä¾›æ¶ˆæ¯çš„å¿«é€ŸæŸ¥è¯¢</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-Brokerå·¥ä½œæµç¨‹.png" alt=""></p>
<hr>
<h4 id="æ€»ä½“æµç¨‹"><a href="#æ€»ä½“æµç¨‹" class="headerlink" title="æ€»ä½“æµç¨‹"></a>æ€»ä½“æµç¨‹</h4><p>RocketMQ çš„å·¥ä½œæµç¨‹ï¼š</p>
<ul>
<li>å¯åŠ¨ NameServer ç›‘å¬ç«¯å£ï¼Œç­‰å¾… Brokerã€Producerã€Consumer è¿ä¸Šæ¥ï¼Œç›¸å½“äºä¸€ä¸ªè·¯ç”±æ§åˆ¶ä¸­å¿ƒ</li>
<li>Broker å¯åŠ¨ï¼Œè·Ÿ<strong>æ‰€æœ‰çš„ NameServer ä¿æŒé•¿è¿æ¥</strong>ï¼Œæ¯éš” 30s æ—¶é—´å‘ NameServer ä¸ŠæŠ¥ Topic è·¯ç”±ä¿¡æ¯ï¼ˆå¿ƒè·³åŒ…ï¼‰ã€‚å¿ƒè·³åŒ…ä¸­åŒ…å«å½“å‰ Broker ä¿¡æ¯ï¼ˆIPã€ç«¯å£ç­‰ï¼‰ä»¥åŠå­˜å‚¨æ‰€æœ‰ Topic ä¿¡æ¯ã€‚æ³¨å†ŒæˆåŠŸåï¼ŒNameServer é›†ç¾¤ä¸­å°±æœ‰ Topic è·Ÿ Broker çš„æ˜ å°„å…³ç³»</li>
<li>æ”¶å‘æ¶ˆæ¯å‰ï¼Œå…ˆåˆ›å»º Topicï¼Œåˆ›å»º Topic æ—¶éœ€è¦æŒ‡å®šè¯¥ Topic è¦å­˜å‚¨åœ¨å“ªäº› Broker ä¸Šï¼Œä¹Ÿå¯ä»¥åœ¨å‘é€æ¶ˆæ¯æ—¶è‡ªåŠ¨åˆ›å»º Topic</li>
<li>Producer å¯åŠ¨æ—¶å…ˆè·Ÿ NameServer é›†ç¾¤ä¸­çš„<strong>å…¶ä¸­ä¸€å°</strong>å»ºç«‹é•¿è¿æ¥ï¼Œå¹¶ä» NameServer ä¸­è·å–å½“å‰å‘é€çš„ Topic å­˜åœ¨å“ªäº› Broker ä¸Šï¼ŒåŒæ—¶ Producer ä¼šé»˜è®¤æ¯éš” 30s å‘ NameServer <strong>å®šæ—¶æ‹‰å–</strong>ä¸€æ¬¡è·¯ç”±ä¿¡æ¯</li>
<li>Producer å‘é€æ¶ˆæ¯æ—¶ï¼Œæ ¹æ®æ¶ˆæ¯çš„ Topic ä»æœ¬åœ°ç¼“å­˜çš„ TopicPublishInfoTable è·å–è·¯ç”±ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šä» NameServer ä¸Šé‡æ–°æ‹‰å–å¹¶æ›´æ–°ï¼Œè½®è¯¢é˜Ÿåˆ—åˆ—è¡¨å¹¶é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ— MessageQueueï¼Œç„¶åä¸é˜Ÿåˆ—æ‰€åœ¨çš„ Broker å»ºç«‹é•¿è¿æ¥ï¼Œå‘ Broker å‘æ¶ˆæ¯</li>
<li>Consumer è·Ÿ Producer ç±»ä¼¼ï¼Œè·Ÿå…¶ä¸­ä¸€å° NameServer å»ºç«‹é•¿è¿æ¥ï¼Œ<strong>å®šæ—¶è·å–è·¯ç”±ä¿¡æ¯</strong>ï¼Œæ ¹æ®å½“å‰è®¢é˜… Topic å­˜åœ¨å“ªäº› Broker ä¸Šï¼Œç›´æ¥è·Ÿ Broker å»ºç«‹è¿æ¥é€šé“ï¼Œåœ¨å®Œæˆå®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡åï¼Œé€‰æ‹©å…¶ä¸­çš„æŸä¸€ä¸ªæˆ–è€…æŸå‡ ä¸ª MessageQueue æ¥æ‹‰å–æ¶ˆæ¯å¹¶è¿›è¡Œæ¶ˆè´¹</li>
</ul>
<hr>
<h4 id="ç”Ÿäº§æ¶ˆè´¹"><a href="#ç”Ÿäº§æ¶ˆè´¹" class="headerlink" title="ç”Ÿäº§æ¶ˆè´¹"></a>ç”Ÿäº§æ¶ˆè´¹</h4><p>At least Onceï¼šè‡³å°‘ä¸€æ¬¡ï¼ŒæŒ‡æ¯ä¸ªæ¶ˆæ¯å¿…é¡»æŠ•é€’ä¸€æ¬¡ï¼ŒConsumer å…ˆ Pull æ¶ˆæ¯åˆ°æœ¬åœ°ï¼Œæ¶ˆè´¹å®Œæˆåæ‰å‘æœåŠ¡å™¨è¿”å› ACKï¼Œå¦‚æœæ²¡æœ‰æ¶ˆè´¹ä¸€å®šä¸ä¼š ACK æ¶ˆæ¯</p>
<p>å›æº¯æ¶ˆè´¹ï¼šæŒ‡ Consumer å·²ç»æ¶ˆè´¹æˆåŠŸçš„æ¶ˆæ¯ï¼Œç”±äºä¸šåŠ¡ä¸Šéœ€æ±‚éœ€è¦é‡æ–°æ¶ˆè´¹ï¼ŒBroker åœ¨å‘ Consumer æŠ•é€’æˆåŠŸæ¶ˆæ¯åï¼Œæ¶ˆæ¯ä»ç„¶éœ€è¦ä¿ç•™ã€‚å¹¶ä¸”é‡æ–°æ¶ˆè´¹ä¸€èˆ¬æ˜¯æŒ‰ç…§æ—¶é—´ç»´åº¦ï¼Œä¾‹å¦‚ç”±äº Consumer ç³»ç»Ÿæ•…éšœï¼Œæ¢å¤åéœ€è¦é‡æ–°æ¶ˆè´¹ 1 å°æ—¶å‰çš„æ•°æ®ï¼ŒRocketMQ æ”¯æŒæŒ‰ç…§æ—¶é—´å›æº¯æ¶ˆè´¹ï¼Œæ—¶é—´ç»´åº¦ç²¾ç¡®åˆ°æ¯«ç§’</p>
<p>åˆ†å¸ƒå¼é˜Ÿåˆ—å› ä¸ºæœ‰é«˜å¯é æ€§çš„è¦æ±‚ï¼Œæ‰€ä»¥æ•°æ®è¦è¿›è¡Œ<strong>æŒä¹…åŒ–å­˜å‚¨</strong></p>
<ol>
<li>æ¶ˆæ¯ç”Ÿäº§è€…å‘é€æ¶ˆæ¯</li>
<li>MQ æ”¶åˆ°æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯è¿›è¡ŒæŒä¹…åŒ–ï¼Œåœ¨å­˜å‚¨ä¸­æ–°å¢ä¸€æ¡è®°å½•</li>
<li>è¿”å› ACK ç»™ç”Ÿäº§è€…</li>
<li>MQ push æ¶ˆæ¯ç»™å¯¹åº”çš„æ¶ˆè´¹è€…ï¼Œç„¶åç­‰å¾…æ¶ˆè´¹è€…è¿”å› ACK</li>
<li>å¦‚æœæ¶ˆæ¯æ¶ˆè´¹è€…åœ¨æŒ‡å®šæ—¶é—´å†…æˆåŠŸè¿”å› ACKï¼Œé‚£ä¹ˆ MQ è®¤ä¸ºæ¶ˆæ¯æ¶ˆè´¹æˆåŠŸï¼Œåœ¨å­˜å‚¨ä¸­åˆ é™¤æ¶ˆæ¯ï¼›å¦‚æœ MQ åœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ° ACKï¼Œåˆ™è®¤ä¸ºæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ï¼Œä¼šå°è¯•é‡æ–° push æ¶ˆæ¯ï¼Œé‡å¤æ‰§è¡Œ 4ã€5ã€6 æ­¥éª¤</li>
<li>MQ åˆ é™¤æ¶ˆæ¯</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-æ¶ˆæ¯å­˜å–.png" alt=""></p>
<hr>
<h3 id="å­˜å‚¨æœºåˆ¶"><a href="#å­˜å‚¨æœºåˆ¶" class="headerlink" title="å­˜å‚¨æœºåˆ¶"></a>å­˜å‚¨æœºåˆ¶</h3><h4 id="å­˜å‚¨ç»“æ„"><a href="#å­˜å‚¨ç»“æ„" class="headerlink" title="å­˜å‚¨ç»“æ„"></a>å­˜å‚¨ç»“æ„</h4><p>RocketMQ ä¸­ Broker è´Ÿè´£å­˜å‚¨æ¶ˆæ¯è½¬å‘æ¶ˆæ¯ï¼Œæ‰€ä»¥ä»¥ä¸‹çš„ç»“æ„æ˜¯å­˜å‚¨åœ¨ Broker Server ä¸Šçš„ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸ Broker è¿›è¡Œæ¶ˆæ¯çš„æ”¶å‘æ˜¯é€šè¿‡ä¸»é¢˜å¯¹åº”çš„ Message Queue å®Œæˆï¼Œç±»ä¼¼äºé€šé“</p>
<p>RocketMQ æ¶ˆæ¯çš„å­˜å‚¨æ˜¯ç”± ConsumeQueue å’Œ CommitLog é…åˆå®Œæˆ çš„ï¼ŒCommitLog æ˜¯æ¶ˆæ¯çœŸæ­£çš„<strong>ç‰©ç†å­˜å‚¨</strong>æ–‡ä»¶ï¼ŒConsumeQueue æ˜¯æ¶ˆæ¯çš„é€»è¾‘é˜Ÿåˆ—ï¼Œç±»ä¼¼æ•°æ®åº“çš„<strong>ç´¢å¼•èŠ‚ç‚¹</strong>ï¼Œå­˜å‚¨çš„æ˜¯æŒ‡å‘ç‰©ç†å­˜å‚¨çš„åœ°å€ã€‚<strong>æ¯ä¸ª Topic ä¸‹çš„æ¯ä¸ª Message Queue éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ ConsumeQueue æ–‡ä»¶</strong></p>
<p>æ¯æ¡æ¶ˆæ¯éƒ½ä¼šæœ‰å¯¹åº”çš„ç´¢å¼•ä¿¡æ¯ï¼ŒConsumer é€šè¿‡ ConsumeQueue è¿™ä¸ªç»“æ„æ¥è¯»å–æ¶ˆæ¯å®ä½“å†…å®¹</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-æ¶ˆæ¯å­˜å‚¨ç»“æ„.png" alt=""></p>
<ul>
<li>CommitLogï¼šæ¶ˆæ¯ä¸»ä½“ä»¥åŠå…ƒæ•°æ®çš„å­˜å‚¨ä¸»ä½“ï¼Œå­˜å‚¨ Producer ç«¯å†™å…¥çš„æ¶ˆæ¯å†…å®¹ï¼Œæ¶ˆæ¯å†…å®¹ä¸æ˜¯å®šé•¿çš„ã€‚æ¶ˆæ¯ä¸»è¦æ˜¯<strong>é¡ºåºå†™å…¥</strong>æ—¥å¿—æ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶å¤§å°é»˜è®¤ 1Gï¼Œåç§»é‡ä»£è¡¨ä¸‹ä¸€æ¬¡å†™å…¥çš„ä½ç½®ï¼Œå½“æ–‡ä»¶å†™æ»¡äº†å°±ç»§ç»­å†™å…¥ä¸‹ä¸€ä¸ªæ–‡ä»¶</li>
<li>ConsumerQueueï¼šæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯åœ¨ CommitLog çš„ç´¢å¼•ã€‚RocketMQ æ¶ˆæ¯æ¶ˆè´¹æ—¶è¦éå† CommitLog æ–‡ä»¶ï¼Œå¹¶æ ¹æ®ä¸»é¢˜ Topic æ£€ç´¢æ¶ˆæ¯ï¼Œè¿™æ˜¯éå¸¸ä½æ•ˆçš„ã€‚å¼•å…¥ ConsumeQueue ä½œä¸ºæ¶ˆè´¹æ¶ˆæ¯çš„ç´¢å¼•ï¼Œ<strong>ä¿å­˜äº†æŒ‡å®š Topic ä¸‹çš„é˜Ÿåˆ—æ¶ˆæ¯åœ¨ CommitLog ä¸­çš„èµ·å§‹ç‰©ç†åç§»é‡ offset</strong>ï¼Œæ¶ˆæ¯å¤§å° size å’Œæ¶ˆæ¯ Tag çš„ HashCode å€¼ï¼Œæ¯ä¸ª ConsumeQueue æ–‡ä»¶å¤§å°çº¦ 5.72M</li>
<li>IndexFileï¼šä¸ºäº†æ¶ˆæ¯æŸ¥è¯¢æä¾›äº†ä¸€ç§é€šè¿‡ Key æˆ–æ—¶é—´åŒºé—´æ¥æŸ¥è¯¢æ¶ˆæ¯çš„æ–¹æ³•ï¼Œé€šè¿‡ IndexFile æ¥æŸ¥æ‰¾æ¶ˆæ¯çš„æ–¹æ³•<strong>ä¸å½±å“å‘é€ä¸æ¶ˆè´¹æ¶ˆæ¯çš„ä¸»æµç¨‹</strong>ã€‚IndexFile çš„åº•å±‚å­˜å‚¨ä¸ºåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­å®ç°çš„ HashMap ç»“æ„ï¼Œæ•… RocketMQ çš„ç´¢å¼•æ–‡ä»¶å…¶åº•å±‚å®ç°ä¸º <strong>hash ç´¢å¼•</strong></li>
</ul>
<p>RocketMQ é‡‡ç”¨çš„æ˜¯æ··åˆå‹çš„å­˜å‚¨ç»“æ„ï¼Œå³ä¸º Broker å•ä¸ªå®ä¾‹ä¸‹æ‰€æœ‰çš„é˜Ÿåˆ—å…±ç”¨ä¸€ä¸ªæ—¥å¿—æ•°æ®æ–‡ä»¶ï¼ˆCommitLogï¼‰æ¥å­˜å‚¨ï¼Œå¤šä¸ª Topic çš„æ¶ˆæ¯å®ä½“å†…å®¹éƒ½å­˜å‚¨äºä¸€ä¸ª CommitLog ä¸­ã€‚æ··åˆå‹å­˜å‚¨ç»“æ„é’ˆå¯¹ Producer å’Œ Consumer åˆ†åˆ«é‡‡ç”¨äº†<strong>æ•°æ®å’Œç´¢å¼•éƒ¨åˆ†ç›¸åˆ†ç¦»</strong>çš„å­˜å‚¨ç»“æ„ï¼ŒProducer å‘é€æ¶ˆæ¯è‡³ Broker ç«¯ï¼Œç„¶å Broker ç«¯ä½¿ç”¨åŒæ­¥æˆ–è€…å¼‚æ­¥çš„æ–¹å¼å¯¹æ¶ˆæ¯åˆ·ç›˜æŒä¹…åŒ–ï¼Œä¿å­˜è‡³ CommitLog ä¸­ã€‚åªè¦æ¶ˆæ¯è¢«æŒä¹…åŒ–è‡³ç£ç›˜æ–‡ä»¶ CommitLog ä¸­ï¼ŒProducer å‘é€çš„æ¶ˆæ¯å°±ä¸ä¼šä¸¢å¤±ï¼ŒConsumer ä¹Ÿå°±è‚¯å®šæœ‰æœºä¼šå»æ¶ˆè´¹è¿™æ¡æ¶ˆæ¯</p>
<p>æœåŠ¡ç«¯æ”¯æŒé•¿è½®è¯¢æ¨¡å¼ï¼Œå½“æ¶ˆè´¹è€…æ— æ³•æ‹‰å–åˆ°æ¶ˆæ¯åï¼Œå¯ä»¥ç­‰ä¸‹ä¸€æ¬¡æ¶ˆæ¯æ‹‰å–ï¼ŒBroker å…è®¸ç­‰å¾… 30s çš„æ—¶é—´ï¼Œåªè¦è¿™æ®µæ—¶é—´å†…æœ‰æ–°æ¶ˆæ¯åˆ°è¾¾ï¼Œå°†ç›´æ¥è¿”å›ç»™æ¶ˆè´¹ç«¯ã€‚RocketMQ çš„å…·ä½“åšæ³•æ˜¯ï¼Œä½¿ç”¨ Broker ç«¯çš„åå°æœåŠ¡çº¿ç¨‹ ReputMessageService ä¸åœåœ°åˆ†å‘è¯·æ±‚å¹¶å¼‚æ­¥æ„å»º ConsumeQueueï¼ˆé€»è¾‘æ¶ˆè´¹é˜Ÿåˆ—ï¼‰å’Œ IndexFileï¼ˆç´¢å¼•æ–‡ä»¶ï¼‰æ•°æ®</p>
<hr>
<h4 id="å†…å­˜æ˜ å°„"><a href="#å†…å­˜æ˜ å°„" class="headerlink" title="å†…å­˜æ˜ å°„"></a>å†…å­˜æ˜ å°„</h4><p>æ“ä½œç³»ç»Ÿåˆ†ä¸ºç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Œæ–‡ä»¶æ“ä½œã€ç½‘ç»œæ“ä½œéœ€è¦æ¶‰åŠè¿™ä¸¤ç§å½¢æ€çš„åˆ‡æ¢ï¼Œéœ€è¦è¿›è¡Œæ•°æ®å¤åˆ¶ã€‚ä¸€å°æœåŠ¡å™¨æŠŠæœ¬æœºç£ç›˜æ–‡ä»¶çš„å†…å®¹å‘é€åˆ°å®¢æˆ·ç«¯ï¼Œåˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li><p>readï¼šè¯»å–æœ¬åœ°æ–‡ä»¶å†…å®¹</p>
</li>
<li><p>writeï¼šå°†è¯»å–çš„å†…å®¹é€šè¿‡ç½‘ç»œå‘é€å‡ºå»</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-æ–‡ä»¶ä¸ç½‘ç»œæ“ä½œ.png" alt=""></p>
<p>è¡¥å……ï¼šProg â†’ NET â†’ I/O â†’ é›¶æ‹·è´éƒ¨åˆ†çš„ç¬”è®°è¯¦è§£ç›¸å…³å†…å®¹</p>
<p>é€šè¿‡ä½¿ç”¨ mmap çš„æ–¹å¼ï¼Œå¯ä»¥çœå»å‘ç”¨æˆ·æ€çš„å†…å­˜å¤åˆ¶ï¼ŒRocketMQ å……åˆ†åˆ©ç”¨<strong>é›¶æ‹·è´æŠ€æœ¯</strong>ï¼Œæé«˜æ¶ˆæ¯å­˜ç›˜å’Œç½‘ç»œå‘é€çš„é€Ÿåº¦</p>
<p>RocketMQ é€šè¿‡ MappedByteBuffer å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œï¼Œåˆ©ç”¨äº† NIO ä¸­çš„ FileChannel æ¨¡å‹å°†ç£ç›˜ä¸Šçš„ç‰©ç†æ–‡ä»¶ç›´æ¥æ˜ å°„åˆ°ç”¨æˆ·æ€çš„å†…å­˜åœ°å€ä¸­ï¼Œå°†å¯¹æ–‡ä»¶çš„æ“ä½œè½¬åŒ–ä¸ºç›´æ¥å¯¹å†…å­˜åœ°å€è¿›è¡Œæ“ä½œï¼Œä»è€Œæå¤§åœ°æé«˜äº†æ–‡ä»¶çš„è¯»å†™æ•ˆç‡</p>
<p>MappedByteBuffer å†…å­˜æ˜ å°„çš„æ–¹å¼<strong>é™åˆ¶</strong>ä¸€æ¬¡åªèƒ½æ˜ å°„ 1.5~2G çš„æ–‡ä»¶è‡³ç”¨æˆ·æ€çš„è™šæ‹Ÿå†…å­˜ï¼Œæ‰€ä»¥ RocketMQ é»˜è®¤è®¾ç½®å•ä¸ª CommitLog æ—¥å¿—æ•°æ®æ–‡ä»¶ä¸º 1Gã€‚RocketMQ çš„æ–‡ä»¶å­˜å‚¨ä½¿ç”¨å®šé•¿ç»“æ„æ¥å­˜å‚¨ï¼Œæ–¹ä¾¿ä¸€æ¬¡å°†æ•´ä¸ªæ–‡ä»¶æ˜ å°„è‡³å†…å­˜</p>
<hr>
<h4 id="é¡µé¢ç¼“å­˜"><a href="#é¡µé¢ç¼“å­˜" class="headerlink" title="é¡µé¢ç¼“å­˜"></a>é¡µé¢ç¼“å­˜</h4><p>é¡µç¼“å­˜ï¼ˆPageCacheï¼‰æ˜¯ OS å¯¹æ–‡ä»¶çš„ç¼“å­˜ï¼Œæ¯ä¸€é¡µçš„å¤§å°é€šå¸¸æ˜¯ 4Kï¼Œç”¨äºåŠ é€Ÿå¯¹æ–‡ä»¶çš„è¯»å†™ã€‚å› ä¸º OS å°†ä¸€éƒ¨åˆ†çš„å†…å­˜ç”¨ä½œ PageCacheï¼Œæ‰€ä»¥ç¨‹åºå¯¹æ–‡ä»¶è¿›è¡Œé¡ºåºè¯»å†™çš„é€Ÿåº¦å‡ ä¹æ¥è¿‘äºå†…å­˜çš„è¯»å†™é€Ÿåº¦</p>
<ul>
<li>å¯¹äºæ•°æ®çš„å†™å…¥ï¼ŒOS ä¼šå…ˆå†™å…¥è‡³ Cache å†…ï¼Œéšå<strong>é€šè¿‡å¼‚æ­¥çš„æ–¹å¼ç”± pdflush å†…æ ¸çº¿ç¨‹å°† Cache å†…çš„æ•°æ®åˆ·ç›˜è‡³ç‰©ç†ç£ç›˜ä¸Š</strong></li>
<li>å¯¹äºæ•°æ®çš„è¯»å–ï¼Œå¦‚æœä¸€æ¬¡è¯»å–æ–‡ä»¶æ—¶å‡ºç°æœªå‘½ä¸­ PageCache çš„æƒ…å†µï¼ŒOS ä»ç‰©ç†ç£ç›˜ä¸Šè®¿é—®è¯»å–æ–‡ä»¶çš„åŒæ—¶ï¼Œä¼šé¡ºåºå¯¹å…¶ä»–ç›¸é‚»å—çš„æ•°æ®æ–‡ä»¶è¿›è¡Œ<strong>é¢„è¯»å–</strong>ï¼ˆå±€éƒ¨æ€§åŸç†ï¼Œæœ€å¤§ 128Kï¼‰</li>
</ul>
<p>åœ¨ RocketMQ ä¸­ï¼ŒConsumeQueue é€»è¾‘æ¶ˆè´¹é˜Ÿåˆ—å­˜å‚¨çš„æ•°æ®è¾ƒå°‘ï¼Œå¹¶ä¸”æ˜¯é¡ºåºè¯»å–ï¼Œåœ¨ PageCache æœºåˆ¶çš„é¢„è¯»å–ä½œç”¨ä¸‹ï¼ŒConsume Queue æ–‡ä»¶çš„è¯»æ€§èƒ½å‡ ä¹æ¥è¿‘è¯»å†…å­˜ï¼Œå³ä½¿åœ¨æœ‰æ¶ˆæ¯å †ç§¯æƒ…å†µä¸‹ä¹Ÿä¸ä¼šå½±å“æ€§èƒ½ã€‚ä½†æ˜¯ CommitLog æ¶ˆæ¯å­˜å‚¨çš„æ—¥å¿—æ•°æ®æ–‡ä»¶è¯»å–å†…å®¹æ—¶ä¼šäº§ç”Ÿè¾ƒå¤šçš„éšæœºè®¿é—®è¯»å–ï¼Œä¸¥é‡å½±å“æ€§èƒ½ã€‚é€‰æ‹©åˆé€‚çš„ç³»ç»Ÿ IO è°ƒåº¦ç®—æ³•å’Œå›ºæ€ç¡¬ç›˜ï¼Œæ¯”å¦‚è®¾ç½®è°ƒåº¦ç®—æ³•ä¸º Deadlineï¼Œéšæœºè¯»çš„æ€§èƒ½ä¹Ÿä¼šæœ‰æ‰€æå‡</p>
<hr>
<h4 id="åˆ·ç›˜æœºåˆ¶"><a href="#åˆ·ç›˜æœºåˆ¶" class="headerlink" title="åˆ·ç›˜æœºåˆ¶"></a>åˆ·ç›˜æœºåˆ¶</h4><p>ä¸¤ç§æŒä¹…åŒ–çš„æ–¹æ¡ˆï¼š</p>
<ul>
<li>å…³ç³»å‹æ•°æ®åº“ DBï¼šIO è¯»å†™æ€§èƒ½æ¯”è¾ƒå·®ï¼Œå¦‚æœ DB å‡ºç°æ•…éšœï¼Œåˆ™ MQ çš„æ¶ˆæ¯å°±æ— æ³•è½ç›˜å­˜å‚¨å¯¼è‡´çº¿ä¸Šæ•…éšœï¼Œå¯é æ€§ä¸é«˜</li>
<li>æ–‡ä»¶ç³»ç»Ÿï¼šæ¶ˆæ¯åˆ·ç›˜è‡³æ‰€éƒ¨ç½²è™šæ‹Ÿæœº/ç‰©ç†æœºçš„æ–‡ä»¶ç³»ç»Ÿæ¥åšæŒä¹…åŒ–ï¼Œåˆ†ä¸ºå¼‚æ­¥åˆ·ç›˜å’ŒåŒæ­¥åˆ·ç›˜ä¸¤ç§æ¨¡å¼ã€‚æ¶ˆæ¯åˆ·ç›˜ä¸ºæ¶ˆæ¯å­˜å‚¨æä¾›äº†ä¸€ç§é«˜æ•ˆç‡ã€é«˜å¯é æ€§å’Œé«˜æ€§èƒ½çš„æ•°æ®æŒä¹…åŒ–æ–¹å¼ï¼Œé™¤ééƒ¨ç½² MQ æœºå™¨æœ¬èº«æˆ–æ˜¯æœ¬åœ°ç£ç›˜æŒ‚äº†ï¼Œä¸€èˆ¬ä¸ä¼šå‡ºç°æ— æ³•æŒä¹…åŒ–çš„é—®é¢˜</li>
</ul>
<p>RocketMQ é‡‡ç”¨æ–‡ä»¶ç³»ç»Ÿçš„æ–¹å¼ï¼Œæ— è®ºåŒæ­¥è¿˜æ˜¯å¼‚æ­¥åˆ·ç›˜ï¼Œéƒ½ä½¿ç”¨<strong>é¡ºåº IO</strong>ï¼Œå› ä¸ºç£ç›˜çš„é¡ºåºè¯»å†™è¦æ¯”éšæœºè¯»å†™å¿«å¾ˆå¤š</p>
<ul>
<li><p>åŒæ­¥åˆ·ç›˜ï¼šåªæœ‰åœ¨æ¶ˆæ¯çœŸæ­£æŒä¹…åŒ–è‡³ç£ç›˜å RocketMQ çš„ Broker ç«¯æ‰ä¼šçœŸæ­£è¿”å›ç»™ Producer ç«¯ä¸€ä¸ªæˆåŠŸçš„ ACK å“åº”ï¼Œä¿éšœ MQ æ¶ˆæ¯çš„å¯é æ€§ï¼Œä½†æ˜¯æ€§èƒ½ä¸Šä¼šæœ‰è¾ƒå¤§å½±å“ï¼Œä¸€èˆ¬é€‚ç”¨äºé‡‘èä¸šåŠ¡åº”ç”¨è¯¥æ¨¡å¼è¾ƒå¤š</p>
</li>
<li><p>å¼‚æ­¥åˆ·ç›˜ï¼šåˆ©ç”¨ OS çš„ PageCacheï¼Œåªè¦æ¶ˆæ¯å†™å…¥å†…å­˜ PageCache å³å¯å°†æˆåŠŸçš„ ACK è¿”å›ç»™ Producer ç«¯ï¼Œé™ä½äº†è¯»å†™å»¶è¿Ÿï¼Œæé«˜äº† MQ çš„æ€§èƒ½å’Œååé‡ã€‚æ¶ˆæ¯åˆ·ç›˜é‡‡ç”¨<strong>åå°å¼‚æ­¥çº¿ç¨‹</strong>æäº¤çš„æ–¹å¼è¿›è¡Œï¼Œå½“å†…å­˜é‡Œçš„æ¶ˆæ¯é‡ç§¯ç´¯åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œè§¦å‘å†™ç£ç›˜åŠ¨ä½œ</p>
</li>
</ul>
<p>é€šè¿‡ Broker é…ç½®æ–‡ä»¶é‡Œçš„ flushDiskType å‚æ•°è®¾ç½®é‡‡ç”¨ä»€ä¹ˆæ–¹å¼ï¼Œå¯ä»¥é…ç½®æˆ SYNC_FLUSHã€ASYNC_FLUSH ä¸­çš„ä¸€ä¸ª</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-åˆ·ç›˜æœºåˆ¶.png" alt=""></p>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq/blob/master/docs/cn/design.md">https://github.com/apache/rocketmq/blob/master/docs/cn/design.md</a></p>
<hr>
<h3 id="é›†ç¾¤è®¾è®¡"><a href="#é›†ç¾¤è®¾è®¡" class="headerlink" title="é›†ç¾¤è®¾è®¡"></a>é›†ç¾¤è®¾è®¡</h3><h4 id="é›†ç¾¤æ¨¡å¼"><a href="#é›†ç¾¤æ¨¡å¼" class="headerlink" title="é›†ç¾¤æ¨¡å¼"></a>é›†ç¾¤æ¨¡å¼</h4><p>å¸¸ç”¨çš„ä»¥ä¸‹å‡ ç§æ¨¡å¼ï¼š</p>
<ul>
<li>å• Master æ¨¡å¼ï¼šè¿™ç§æ–¹å¼é£é™©è¾ƒå¤§ï¼Œä¸€æ—¦ Broker é‡å¯æˆ–è€…å®•æœºï¼Œä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡ä¸å¯ç”¨</li>
<li><p>å¤š Master æ¨¡å¼ï¼šä¸€ä¸ªé›†ç¾¤æ—  Slaveï¼Œå…¨æ˜¯ Master</p>
<ul>
<li><p>ä¼˜ç‚¹ï¼šé…ç½®ç®€å•ï¼Œå•ä¸ª Master å®•æœºæˆ–é‡å¯ç»´æŠ¤å¯¹åº”ç”¨æ— å½±å“ï¼Œåœ¨ç£ç›˜é…ç½®ä¸º RAID10 æ—¶ï¼Œå³ä½¿æœºå™¨å®•æœºä¸å¯æ¢å¤æƒ…å†µä¸‹ï¼Œç”±äº RAID10 ç£ç›˜éå¸¸å¯é ï¼Œæ¶ˆæ¯ä¹Ÿä¸ä¼šä¸¢ï¼ˆå¼‚æ­¥åˆ·ç›˜ä¸¢å¤±å°‘é‡æ¶ˆæ¯ï¼ŒåŒæ­¥åˆ·ç›˜ä¸€æ¡ä¸ä¸¢ï¼‰ï¼Œæ€§èƒ½æœ€é«˜</p>
</li>
<li><p>ç¼ºç‚¹ï¼šå•å°æœºå™¨å®•æœºæœŸé—´ï¼Œè¿™å°æœºå™¨ä¸Šæœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯åœ¨æœºå™¨æ¢å¤ä¹‹å‰ä¸å¯è®¢é˜…ï¼Œæ¶ˆæ¯å®æ—¶æ€§ä¼šå—åˆ°å½±å“</p>
</li>
</ul>
</li>
<li><p>å¤š Master å¤š Slave æ¨¡å¼ï¼ˆåŒæ­¥ï¼‰ï¼šæ¯ä¸ª Master é…ç½®ä¸€ä¸ª Slaveï¼Œæœ‰å¤šå¯¹ Master-Slaveï¼ŒHA é‡‡ç”¨<strong>åŒæ­¥åŒå†™</strong>æ–¹å¼ï¼Œå³åªæœ‰ä¸»å¤‡éƒ½å†™æˆåŠŸï¼Œæ‰å‘åº”ç”¨è¿”å›æˆåŠŸ</p>
<ul>
<li>ä¼˜ç‚¹ï¼šæ•°æ®ä¸æœåŠ¡éƒ½æ— å•ç‚¹æ•…éšœï¼ŒMaster å®•æœºæƒ…å†µä¸‹ï¼Œæ¶ˆæ¯æ— å»¶è¿Ÿï¼ŒæœåŠ¡å¯ç”¨æ€§ä¸æ•°æ®å¯ç”¨æ€§éƒ½éå¸¸é«˜</li>
<li>ç¼ºç‚¹ï¼šæ€§èƒ½æ¯”å¼‚æ­¥å¤åˆ¶ç•¥ä½ï¼ˆå¤§çº¦ä½ 10% å·¦å³ï¼‰ï¼Œå‘é€å•ä¸ªæ¶ˆæ¯çš„ RT ç•¥é«˜ï¼Œç›®å‰ä¸èƒ½å®ç°ä¸»èŠ‚ç‚¹å®•æœºï¼Œå¤‡æœºè‡ªåŠ¨åˆ‡æ¢ä¸ºä¸»æœº</li>
</ul>
</li>
<li><p>å¤š Master å¤š Slave æ¨¡å¼ï¼ˆå¼‚æ­¥ï¼‰ï¼šHA é‡‡ç”¨å¼‚æ­¥å¤åˆ¶çš„æ–¹å¼ï¼Œä¼šé€ æˆä¸»å¤‡æœ‰çŸ­æš‚çš„æ¶ˆæ¯å»¶è¿Ÿï¼ˆæ¯«ç§’çº§åˆ«ï¼‰</p>
<ul>
<li>ä¼˜ç‚¹ï¼šå³ä½¿ç£ç›˜æŸåï¼Œæ¶ˆæ¯ä¸¢å¤±çš„éå¸¸å°‘ï¼Œä¸”æ¶ˆæ¯å®æ—¶æ€§ä¸ä¼šå—å½±å“ï¼ŒåŒæ—¶ Master å®•æœºåï¼Œæ¶ˆè´¹è€…ä»ç„¶å¯ä»¥ä» Slave æ¶ˆè´¹ï¼Œè€Œä¸”æ­¤è¿‡ç¨‹å¯¹åº”ç”¨é€æ˜ï¼Œä¸éœ€è¦äººå·¥å¹²é¢„ï¼Œæ€§èƒ½åŒå¤š Master æ¨¡å¼å‡ ä¹ä¸€æ ·</li>
<li>ç¼ºç‚¹ï¼šMaster å®•æœºï¼Œç£ç›˜æŸåæƒ…å†µä¸‹ä¼šä¸¢å¤±å°‘é‡æ¶ˆæ¯</li>
</ul>
</li>
</ul>
<hr>
<h4 id="é›†ç¾¤æ¶æ„"><a href="#é›†ç¾¤æ¶æ„" class="headerlink" title="é›†ç¾¤æ¶æ„"></a>é›†ç¾¤æ¶æ„</h4><p>RocketMQ ç½‘ç»œéƒ¨ç½²ç‰¹ç‚¹ï¼š</p>
<ul>
<li><p>NameServer æ˜¯ä¸€ä¸ªå‡ ä¹<strong>æ— çŠ¶æ€èŠ‚ç‚¹</strong>ï¼ŒèŠ‚ç‚¹ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œæ— ä»»ä½•ä¿¡æ¯åŒæ­¥</p>
</li>
<li><p>Broker éƒ¨ç½²ç›¸å¯¹å¤æ‚ï¼ŒBroker åˆ†ä¸º Master ä¸ Slaveï¼ŒMaster å¯ä»¥éƒ¨ç½²å¤šä¸ªï¼Œä¸€ä¸ª Master å¯ä»¥å¯¹åº”å¤šä¸ª Slaveï¼Œä½†æ˜¯ä¸€ä¸ª Slave åªèƒ½å¯¹åº”ä¸€ä¸ª Masterï¼ŒMaster ä¸ Slave çš„å¯¹åº”å…³ç³»é€šè¿‡æŒ‡å®šç›¸åŒ BrokerNameã€ä¸åŒ BrokerId æ¥å®šä¹‰ï¼ŒBrokerId ä¸º 0 æ˜¯ Masterï¼Œé 0 è¡¨ç¤º Slaveã€‚<strong>æ¯ä¸ª Broker ä¸ NameServer é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹å»ºç«‹é•¿è¿æ¥</strong>ï¼Œå®šæ—¶æ³¨å†Œ Topic ä¿¡æ¯åˆ°æ‰€æœ‰ NameServer</p>
<p>è¯´æ˜ï¼šéƒ¨ç½²æ¶æ„ä¸Šä¹Ÿæ”¯æŒä¸€ Master å¤š Slaveï¼Œä½†åªæœ‰ BrokerId=1 çš„ä»æœåŠ¡å™¨æ‰ä¼šå‚ä¸æ¶ˆæ¯çš„è¯»è´Ÿè½½ï¼ˆè¯»å†™åˆ†ç¦»ï¼‰</p>
</li>
<li><p>Producer ä¸ NameServer é›†ç¾¤ä¸­çš„å…¶ä¸­<strong>ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆéšæœºé€‰æ‹©ï¼‰å»ºç«‹é•¿è¿æ¥</strong>ï¼Œå®šæœŸä» NameServer è·å– Topic è·¯ç”±ä¿¡æ¯ï¼Œå¹¶å‘æä¾› Topic æœåŠ¡çš„ Master å»ºç«‹é•¿è¿æ¥ï¼Œä¸”å®šæ—¶å‘ Master <strong>å‘é€å¿ƒè·³</strong>ã€‚Producer å®Œå…¨æ— çŠ¶æ€ï¼Œå¯é›†ç¾¤éƒ¨ç½²</p>
</li>
<li><p>Consumer ä¸ NameServer é›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆéšæœºé€‰æ‹©ï¼‰å»ºç«‹é•¿è¿æ¥ï¼Œå®šæœŸä» NameServer è·å– Topic è·¯ç”±ä¿¡æ¯ï¼Œå¹¶å‘æä¾›  Topic æœåŠ¡çš„ Masterã€Slave å»ºç«‹é•¿è¿æ¥ï¼Œä¸”å®šæ—¶å‘ Masterã€Slave å‘é€å¿ƒè·³</p>
<p>Consumer æ—¢å¯ä»¥ä» Master è®¢é˜…æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥ä» Slave è®¢é˜…æ¶ˆæ¯ï¼Œåœ¨å‘ Master æ‹‰å–æ¶ˆæ¯æ—¶ï¼ŒMaster æœåŠ¡å™¨ä¼šæ ¹æ®æ‹‰å–åç§»é‡ä¸æœ€å¤§åç§»é‡çš„è·ç¦»ï¼ˆåˆ¤æ–­æ˜¯å¦è¯»è€æ¶ˆæ¯ï¼Œäº§ç”Ÿè¯» I/Oï¼‰ï¼Œä»¥åŠä»æœåŠ¡å™¨æ˜¯å¦å¯è¯»ç­‰å› ç´ å»ºè®®ä¸‹ä¸€æ¬¡æ˜¯ä» Master è¿˜æ˜¯ Slave æ‹‰å–</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-é›†ç¾¤æ¶æ„.png" alt=""></p>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq/blob/master/docs/cn/architecture.md">https://github.com/apache/rocketmq/blob/master/docs/cn/architecture.md</a></p>
<hr>
<h4 id="é«˜å¯ç”¨æ€§"><a href="#é«˜å¯ç”¨æ€§" class="headerlink" title="é«˜å¯ç”¨æ€§"></a>é«˜å¯ç”¨æ€§</h4><p>NameServer èŠ‚ç‚¹æ˜¯æ— çŠ¶æ€çš„ï¼Œä¸”å„ä¸ªèŠ‚ç‚¹ç›´æ¥çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œéƒ¨åˆ† NameServer ä¸å¯ç”¨ä¹Ÿå¯ä»¥ä¿è¯ MQ æœåŠ¡æ­£å¸¸è¿è¡Œ</p>
<p>BrokerServer çš„é«˜å¯ç”¨é€šè¿‡ Master å’Œ Slave çš„é…åˆï¼š</p>
<ul>
<li><p>Slave åªè´Ÿè´£è¯»ï¼Œå½“ Master ä¸å¯ç”¨ï¼Œå¯¹åº”çš„ Slave ä»èƒ½ä¿è¯æ¶ˆæ¯è¢«æ­£å¸¸æ¶ˆè´¹</p>
</li>
<li><p>é…ç½®å¤šç»„ Master-Slave ç»„ï¼Œå…¶ä»–çš„ Master-Slave ç»„ä¹Ÿä¼šä¿è¯æ¶ˆæ¯çš„æ­£å¸¸å‘é€å’Œæ¶ˆè´¹</p>
</li>
<li><p><strong>ç›®å‰ä¸æ”¯æŒæŠŠ Slave è‡ªåŠ¨è½¬æˆ Master</strong>ï¼Œéœ€è¦æ‰‹åŠ¨åœæ­¢ Slave è§’è‰²çš„ Brokerï¼Œæ›´æ”¹é…ç½®æ–‡ä»¶ï¼Œç”¨æ–°çš„é…ç½®æ–‡ä»¶å¯åŠ¨ Broker</p>
<p>æ‰€ä»¥éœ€è¦é…ç½®å¤šä¸ª Master ä¿è¯å¯ç”¨æ€§ï¼Œå¦åˆ™ä¸€ä¸ª Master æŒ‚äº†å¯¼è‡´æ•´ä½“ç³»ç»Ÿçš„å†™æ“ä½œä¸å¯ç”¨</p>
</li>
</ul>
<p>ç”Ÿäº§ç«¯çš„é«˜å¯ç”¨ï¼šåœ¨åˆ›å»º Topic çš„æ—¶å€™ï¼ŒæŠŠ Topic çš„<strong>å¤šä¸ª Message Queue åˆ›å»ºåœ¨å¤šä¸ª Broker ç»„</strong>ä¸Šï¼ˆç›¸åŒ Broker åç§°ï¼Œä¸åŒ brokerId çš„æœºå™¨ï¼‰ï¼Œå½“ä¸€ä¸ª Broker ç»„çš„ Master ä¸å¯ç”¨åï¼Œå…¶ä»–ç»„çš„ Master ä»ç„¶å¯ç”¨ï¼ŒProducer ä»ç„¶å¯ä»¥å‘é€æ¶ˆæ¯</p>
<p>æ¶ˆè´¹ç«¯çš„é«˜å¯ç”¨ï¼šåœ¨ Consumer çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸éœ€è¦è®¾ç½®æ˜¯ä» Master Broker è¯»è¿˜æ˜¯ä» Slave è¯»ï¼Œå½“ Master ä¸å¯ç”¨æˆ–è€…ç¹å¿™çš„æ—¶å€™ï¼ŒConsumer ä¼šè¢«è‡ªåŠ¨åˆ‡æ¢åˆ°ä» Slave è¯»ã€‚æœ‰äº†è‡ªåŠ¨åˆ‡æ¢çš„æœºåˆ¶ï¼Œå½“ä¸€ä¸ª Master æœºå™¨å‡ºç°æ•…éšœåï¼ŒConsumer ä»ç„¶å¯ä»¥ä» Slave è¯»å–æ¶ˆæ¯ï¼Œä¸å½±å“ Consumer ç¨‹åºï¼Œè¾¾åˆ°äº†æ¶ˆè´¹ç«¯çš„é«˜å¯ç”¨æ€§</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-é«˜å¯ç”¨.png" alt=""></p>
<hr>
<h4 id="ä¸»ä»å¤åˆ¶"><a href="#ä¸»ä»å¤åˆ¶" class="headerlink" title="ä¸»ä»å¤åˆ¶"></a>ä¸»ä»å¤åˆ¶</h4><p>å¦‚æœä¸€ä¸ª Broker ç»„æœ‰ Master å’Œ Slaveï¼Œæ¶ˆæ¯éœ€è¦ä» Master å¤åˆ¶åˆ° Slave ä¸Šï¼Œæœ‰åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§å¤åˆ¶æ–¹å¼ï¼š</p>
<ul>
<li><p>åŒæ­¥å¤åˆ¶æ–¹å¼ï¼šMaster å’Œ Slave å‡å†™æˆåŠŸåæ‰åé¦ˆç»™å®¢æˆ·ç«¯å†™æˆåŠŸçŠ¶æ€ï¼ˆå†™ Page Cacheï¼‰ã€‚åœ¨åŒæ­¥å¤åˆ¶æ–¹å¼ä¸‹ï¼Œå¦‚æœ Master å‡ºæ•…éšœï¼Œ Slave ä¸Šæœ‰å…¨éƒ¨çš„å¤‡ä»½æ•°æ®ï¼Œå®¹æ˜“æ¢å¤ï¼Œä½†æ˜¯åŒæ­¥å¤åˆ¶ä¼šå¢å¤§æ•°æ®å†™å…¥å»¶è¿Ÿï¼Œé™ä½ç³»ç»Ÿååé‡</p>
</li>
<li><p>å¼‚æ­¥å¤åˆ¶æ–¹å¼ï¼šåªè¦ Master å†™æˆåŠŸï¼Œå³å¯åé¦ˆç»™å®¢æˆ·ç«¯å†™æˆåŠŸçŠ¶æ€ï¼Œç³»ç»Ÿæ‹¥æœ‰è¾ƒä½çš„å»¶è¿Ÿå’Œè¾ƒé«˜çš„ååé‡ï¼Œä½†æ˜¯å¦‚æœ Master å‡ºäº†æ•…éšœï¼Œæœ‰äº›æ•°æ®å› ä¸ºæ²¡æœ‰è¢«å†™å…¥ Slaveï¼Œæœ‰å¯èƒ½ä¼šä¸¢å¤±</p>
</li>
</ul>
<p>åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶æ˜¯é€šè¿‡ Broker é…ç½®æ–‡ä»¶é‡Œçš„ brokerRole å‚æ•°è¿›è¡Œè®¾ç½®çš„ï¼Œå¯ä»¥è®¾ç½®æˆ ASYNC_MASTEã€RSYNC_MASTERã€SLAVE ä¸‰ä¸ªå€¼ä¸­çš„ä¸€ä¸ª</p>
<p>ä¸€èˆ¬æŠŠåˆ·ç›˜æœºåˆ¶é…ç½®æˆ ASYNC_FLUSHï¼Œä¸»ä»å¤åˆ¶ä¸º SYNC_MASTERï¼Œè¿™æ ·å³ä½¿æœ‰ä¸€å°æœºå™¨å‡ºæ•…éšœï¼Œä»ç„¶èƒ½ä¿è¯æ•°æ®ä¸ä¸¢</p>
<p>RocketMQ æ”¯æŒæ¶ˆæ¯çš„é«˜å¯é ï¼Œå½±å“æ¶ˆæ¯å¯é æ€§çš„å‡ ç§æƒ…å†µï¼š</p>
<ol>
<li>Broker éæ­£å¸¸å…³é—­</li>
<li>Broker å¼‚å¸¸ Crash</li>
<li>OS Crash</li>
<li>æœºå™¨æ‰ç”µï¼Œä½†æ˜¯èƒ½ç«‹å³æ¢å¤ä¾›ç”µæƒ…å†µ</li>
<li>æœºå™¨æ— æ³•å¼€æœºï¼ˆå¯èƒ½æ˜¯ CPUã€ä¸»æ¿ã€å†…å­˜ç­‰å…³é”®è®¾å¤‡æŸåï¼‰</li>
<li>ç£ç›˜è®¾å¤‡æŸå</li>
</ol>
<p>å‰å››ç§æƒ…å†µéƒ½å±äºç¡¬ä»¶èµ„æºå¯ç«‹å³æ¢å¤æƒ…å†µï¼ŒRocketMQ åœ¨è¿™å››ç§æƒ…å†µä¸‹èƒ½ä¿è¯æ¶ˆæ¯ä¸ä¸¢ï¼Œæˆ–è€…ä¸¢å¤±å°‘é‡æ•°æ®ï¼ˆä¾èµ–åˆ·ç›˜æ–¹å¼ï¼‰</p>
<p>åä¸¤ç§å±äºå•ç‚¹æ•…éšœï¼Œä¸”æ— æ³•æ¢å¤ï¼Œä¸€æ—¦å‘ç”Ÿï¼Œåœ¨æ­¤å•ç‚¹ä¸Šçš„æ¶ˆæ¯å…¨éƒ¨ä¸¢å¤±ã€‚RocketMQ åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œé€šè¿‡ä¸»ä»å¼‚æ­¥å¤åˆ¶ï¼Œå¯ä¿è¯ 99% çš„æ¶ˆæ¯ä¸ä¸¢ï¼Œä½†æ˜¯ä»ç„¶ä¼šæœ‰æå°‘é‡çš„æ¶ˆæ¯å¯èƒ½ä¸¢å¤±ã€‚é€šè¿‡<strong>åŒæ­¥åŒå†™æŠ€æœ¯</strong>å¯ä»¥å®Œå…¨é¿å…å•ç‚¹ï¼Œä½†æ˜¯ä¼šå½±å“æ€§èƒ½ï¼Œé€‚åˆå¯¹æ¶ˆæ¯å¯é æ€§è¦æ±‚æé«˜çš„åœºåˆï¼ŒRocketMQ ä» 3.0 ç‰ˆæœ¬å¼€å§‹æ”¯æŒåŒæ­¥åŒå†™</p>
<p>ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ä¼šå»ºè®®é‡‡å–åŒæ­¥åŒå†™ + å¼‚æ­¥åˆ·ç›˜çš„æ–¹å¼ï¼Œåœ¨æ¶ˆæ¯çš„å¯é æ€§å’Œæ€§èƒ½é—´æœ‰ä¸€ä¸ªè¾ƒå¥½çš„å¹³è¡¡</p>
<hr>
<h3 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h3><h4 id="ç”Ÿäº§ç«¯"><a href="#ç”Ÿäº§ç«¯" class="headerlink" title="ç”Ÿäº§ç«¯"></a>ç”Ÿäº§ç«¯</h4><p>RocketMQ ä¸­çš„è´Ÿè½½å‡è¡¡å¯ä»¥åˆ†ä¸º Producer ç«¯å‘é€æ¶ˆæ¯æ—¶å€™çš„è´Ÿè½½å‡è¡¡å’Œ Consumer ç«¯è®¢é˜…æ¶ˆæ¯çš„è´Ÿè½½å‡è¡¡</p>
<p>Producer ç«¯åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šå…ˆæ ¹æ® Topic æ‰¾åˆ°æŒ‡å®šçš„ TopicPublishInfoï¼Œåœ¨è·å–äº† TopicPublishInfo è·¯ç”±ä¿¡æ¯åï¼ŒRocketMQ çš„å®¢æˆ·ç«¯åœ¨é»˜è®¤æ–¹å¼è°ƒç”¨ <code>selectOneMessageQueue()</code> æ–¹æ³•ä» TopicPublishInfo ä¸­çš„ messageQueueList ä¸­é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ— MessageQueue è¿›è¡Œå‘é€æ¶ˆæ¯</p>
<p>é»˜è®¤ä¼š<strong>è½®è¯¢æ‰€æœ‰çš„ Message Queue å‘é€</strong>ï¼Œä»¥è®©æ¶ˆæ¯å¹³å‡è½åœ¨ä¸åŒçš„ queue ä¸Šï¼Œè€Œç”±äº queueå¯ä»¥æ•£è½åœ¨ä¸åŒçš„ Brokerï¼Œæ‰€ä»¥æ¶ˆæ¯å°±å‘é€åˆ°ä¸åŒçš„ Broker ä¸‹ï¼Œå›¾ä¸­ç®­å¤´çº¿æ¡ä¸Šçš„æ ‡å·ä»£è¡¨é¡ºåºï¼Œå‘å¸ƒæ–¹ä¼šæŠŠç¬¬ä¸€æ¡æ¶ˆæ¯å‘é€è‡³ Queue 0ï¼Œç„¶åç¬¬äºŒæ¡æ¶ˆæ¯å‘é€è‡³ Queue 1ï¼Œä»¥æ­¤ç±»æ¨ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-producerè´Ÿè½½å‡è¡¡.png" alt=""></p>
<p>å®¹é”™ç­–ç•¥å‡åœ¨ MQFaultStrategy è¿™ä¸ªç±»ä¸­å®šä¹‰ï¼Œæœ‰ä¸€ä¸ª sendLatencyFaultEnable å¼€å…³å˜é‡ï¼š</p>
<ul>
<li>å¦‚æœå¼€å¯ï¼Œä¼šåœ¨<strong>éšæœºï¼ˆåªæœ‰åˆå§‹åŒ–ç´¢å¼•å˜é‡æ—¶æ‰éšæœºï¼Œæ­£å¸¸éƒ½æ˜¯é€’å¢ï¼‰é€’å¢å–æ¨¡</strong>çš„åŸºç¡€ä¸Šï¼Œå†è¿‡æ»¤æ‰ not available çš„ Broker</li>
<li>å¦‚æœå…³é—­ï¼Œé‡‡ç”¨éšæœºé€’å¢å–æ¨¡çš„æ–¹å¼é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆMessageQueueï¼‰æ¥å‘é€æ¶ˆæ¯</li>
</ul>
<p>LatencyFaultTolerance æœºåˆ¶æ˜¯å®ç°æ¶ˆæ¯å‘é€é«˜å¯ç”¨çš„æ ¸å¿ƒå…³é”®æ‰€åœ¨ï¼Œå¯¹ä¹‹å‰å¤±è´¥çš„ï¼ŒæŒ‰ä¸€å®šçš„æ—¶é—´åšé€€é¿ã€‚ä¾‹å¦‚ä¸Šæ¬¡è¯·æ±‚çš„ latency è¶…è¿‡ 550Lmsï¼Œå°±é€€é¿ 3000Lmsï¼›è¶…è¿‡ 1000Lï¼Œå°±é€€é¿ 60000L</p>
<hr>
<h4 id="æ¶ˆè´¹ç«¯"><a href="#æ¶ˆè´¹ç«¯" class="headerlink" title="æ¶ˆè´¹ç«¯"></a>æ¶ˆè´¹ç«¯</h4><p>åœ¨ RocketMQ ä¸­ï¼ŒConsumer ç«¯çš„ä¸¤ç§æ¶ˆè´¹æ¨¡å¼ï¼ˆPush/Pullï¼‰éƒ½æ˜¯åŸºäºæ‹‰æ¨¡å¼æ¥è·å–æ¶ˆæ¯çš„ï¼Œè€Œåœ¨ Push æ¨¡å¼åªæ˜¯å¯¹ Pull æ¨¡å¼çš„ä¸€ç§å°è£…ï¼Œå…¶æœ¬è´¨å®ç°ä¸ºæ¶ˆæ¯æ‹‰å–çº¿ç¨‹åœ¨ä»æœåŠ¡å™¨æ‹‰å–åˆ°ä¸€æ‰¹æ¶ˆæ¯ï¼Œæäº¤åˆ°æ¶ˆæ¯æ¶ˆè´¹çº¿ç¨‹æ± åï¼Œåˆç»§ç»­å‘æœåŠ¡å™¨å†æ¬¡å°è¯•æ‹‰å–æ¶ˆæ¯ï¼Œå¦‚æœæœªæ‹‰å–åˆ°æ¶ˆæ¯ï¼Œåˆ™å»¶è¿Ÿä¸€ä¸‹åˆç»§ç»­æ‹‰å–</p>
<p>åœ¨ä¸¤ç§åŸºäºæ‹‰æ¨¡å¼çš„æ¶ˆè´¹æ–¹å¼ï¼ˆPush/Pullï¼‰ä¸­ï¼Œå‡éœ€è¦ Consumer ç«¯åœ¨çŸ¥é“ä» Broker ç«¯çš„å“ªä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­å»è·å–æ¶ˆæ¯ï¼Œæ‰€ä»¥åœ¨ Consumer ç«¯æ¥åšè´Ÿè½½å‡è¡¡ï¼Œå³ Broker ç«¯ä¸­å¤šä¸ª MessageQueue åˆ†é…ç»™åŒä¸€ä¸ª Consumer Group ä¸­çš„å“ªäº› Consumer æ¶ˆè´¹</p>
<ul>
<li><p>å¹¿æ’­æ¨¡å¼ä¸‹è¦æ±‚ä¸€æ¡æ¶ˆæ¯éœ€è¦æŠ•é€’åˆ°ä¸€ä¸ªæ¶ˆè´¹ç»„ä¸‹é¢æ‰€æœ‰çš„æ¶ˆè´¹è€…å®ä¾‹ï¼Œæ‰€ä»¥ä¸å­˜åœ¨è´Ÿè½½å‡è¡¡ï¼Œåœ¨å®ç°ä¸Šï¼ŒConsumer åˆ†é… queue æ—¶ï¼Œæ‰€æœ‰ Consumer éƒ½åˆ†åˆ°æ‰€æœ‰çš„ queueã€‚</p>
</li>
<li><p>åœ¨é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œæ¯æ¡æ¶ˆæ¯åªéœ€è¦æŠ•é€’åˆ°è®¢é˜…è¿™ä¸ª Topic çš„ Consumer Group ä¸‹çš„ä¸€ä¸ªå®ä¾‹å³å¯ï¼ŒRocketMQ é‡‡ç”¨ä¸»åŠ¨æ‹‰å–çš„æ–¹å¼æ‹‰å–å¹¶æ¶ˆè´¹æ¶ˆæ¯ï¼Œåœ¨æ‹‰å–çš„æ—¶å€™éœ€è¦æ˜ç¡®æŒ‡å®šæ‹‰å–å“ªä¸€æ¡ Message Queue</p>
</li>
</ul>
<p>é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œæ¯å½“æ¶ˆè´¹è€…å®ä¾‹çš„æ•°é‡æœ‰å˜æ›´ï¼Œéƒ½ä¼šè§¦å‘ä¸€æ¬¡æ‰€æœ‰å®ä¾‹çš„è´Ÿè½½å‡è¡¡ï¼Œè¿™æ—¶å€™ä¼šæŒ‰ç…§ queue çš„æ•°é‡å’Œå®ä¾‹çš„æ•°é‡å¹³å‡åˆ†é… queue ç»™æ¯ä¸ªå®ä¾‹ã€‚é»˜è®¤çš„åˆ†é…ç®—æ³•æ˜¯ AllocateMessageQueueAveragelyï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-å¹³å‡é˜Ÿåˆ—åˆ†é….png" alt=""></p>
<p>  è¿˜æœ‰ä¸€ç§å¹³å‡çš„ç®—æ³•æ˜¯ AllocateMessageQueueAveragelyByCircleï¼Œä»¥ç¯çŠ¶è½®æµå‡åˆ† queue çš„å½¢å¼ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-å¹³å‡é˜Ÿåˆ—è½®æµåˆ†é….png" alt=""></p>
<p>é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ<strong>queue éƒ½æ˜¯åªå…è®¸åˆ†é…ä¸€ä¸ªå®ä¾‹</strong>ï¼Œå¦‚æœå¤šä¸ªå®ä¾‹åŒæ—¶æ¶ˆè´¹ä¸€ä¸ª queue çš„æ¶ˆæ¯ï¼Œç”±äºæ‹‰å–å“ªäº›æ¶ˆæ¯æ˜¯ Consumer ä¸»åŠ¨æ§åˆ¶çš„ï¼Œä¼šå¯¼è‡´åŒä¸€ä¸ªæ¶ˆæ¯åœ¨ä¸åŒçš„å®ä¾‹ä¸‹è¢«æ¶ˆè´¹å¤šæ¬¡</p>
<p>é€šè¿‡å¢åŠ  Consumer å®ä¾‹å»åˆ†æ‘Š queue çš„æ¶ˆè´¹ï¼Œå¯ä»¥èµ·åˆ°æ°´å¹³æ‰©å±•çš„æ¶ˆè´¹èƒ½åŠ›çš„ä½œç”¨ã€‚è€Œå½“æœ‰å®ä¾‹ä¸‹çº¿æ—¶ï¼Œä¼šé‡æ–°è§¦å‘è´Ÿè½½å‡è¡¡ï¼Œè¿™æ—¶å€™åŸæ¥åˆ†é…åˆ°çš„ queue å°†åˆ†é…åˆ°å…¶ä»–å®ä¾‹ä¸Šç»§ç»­æ¶ˆè´¹ã€‚ä½†æ˜¯å¦‚æœ Consumer å®ä¾‹çš„æ•°é‡æ¯” Message Queue çš„æ€»æ•°é‡è¿˜å¤šçš„è¯ï¼Œå¤šå‡ºæ¥çš„ Consumer å®ä¾‹å°†æ— æ³•åˆ†åˆ° queueï¼Œä¹Ÿå°±æ— æ³•æ¶ˆè´¹åˆ°æ¶ˆæ¯ï¼Œä¹Ÿå°±æ— æ³•èµ·åˆ°åˆ†æ‘Šè´Ÿè½½çš„ä½œç”¨äº†ï¼Œæ‰€ä»¥éœ€è¦<strong>æ§åˆ¶è®© queue çš„æ€»æ•°é‡å¤§äºç­‰äº Consumer çš„æ•°é‡</strong></p>
<hr>
<h4 id="åŸç†è§£æ-3"><a href="#åŸç†è§£æ-3" class="headerlink" title="åŸç†è§£æ"></a>åŸç†è§£æ</h4><p>åœ¨ Consumer å¯åŠ¨åï¼Œä¼šé€šè¿‡å®šæ—¶ä»»åŠ¡ä¸æ–­åœ°å‘ RocketMQ é›†ç¾¤ä¸­çš„æ‰€æœ‰ Broker å®ä¾‹å‘é€å¿ƒè·³åŒ…ã€‚Broker ç«¯åœ¨æ”¶åˆ° Consumer çš„å¿ƒè·³æ¶ˆæ¯åï¼Œä¼šå°†å®ƒç»´æŠ¤åœ¨ ConsumerManager çš„æœ¬åœ°ç¼“å­˜å˜é‡ consumerTableï¼ŒåŒæ—¶å¹¶å°†å°è£…åçš„å®¢æˆ·ç«¯ç½‘ç»œé€šé“ä¿¡æ¯ä¿å­˜åœ¨æœ¬åœ°ç¼“å­˜å˜é‡ channelInfoTable ä¸­ï¼Œä¸º Consumer ç«¯çš„è´Ÿè½½å‡è¡¡æä¾›å¯ä»¥ä¾æ®çš„å…ƒæ•°æ®ä¿¡æ¯</p>
<p>Consumer ç«¯å®ç°è´Ÿè½½å‡è¡¡çš„æ ¸å¿ƒç±» <strong>RebalanceImpl</strong></p>
<p>åœ¨ Consumer å®ä¾‹çš„å¯åŠ¨æµç¨‹ä¸­çš„ä¼šå¯åŠ¨ MQClientInstance å®ä¾‹ï¼Œå®Œæˆè´Ÿè½½å‡è¡¡æœåŠ¡çº¿ç¨‹ RebalanceService çš„å¯åŠ¨ï¼ˆ<strong>æ¯éš” 20s æ‰§è¡Œä¸€æ¬¡</strong>è´Ÿè½½å‡è¡¡ï¼‰ï¼ŒRebalanceService çº¿ç¨‹çš„ run() æ–¹æ³•æœ€ç»ˆè°ƒç”¨çš„æ˜¯ RebalanceImpl ç±»çš„ rebalanceByTopic() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯å®ç° Consumer ç«¯è´Ÿè½½å‡è¡¡çš„æ ¸å¿ƒã€‚rebalanceByTopic() æ–¹æ³•ä¼šæ ¹æ®å¹¿æ’­æ¨¡å¼è¿˜æ˜¯é›†ç¾¤æ¨¡å¼åšä¸åŒçš„é€»è¾‘å¤„ç†ã€‚ä¸»è¦çœ‹é›†ç¾¤æ¨¡å¼ï¼š</p>
<ul>
<li><p>ä» rebalanceImpl å®ä¾‹çš„æœ¬åœ°ç¼“å­˜å˜é‡ topicSubscribeInfoTable ä¸­ï¼Œè·å–è¯¥ Topic ä¸»é¢˜ä¸‹çš„æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—é›†åˆ mqSet</p>
</li>
<li><p>æ ¹æ® Topic å’Œ consumerGroup ä¸ºå‚æ•°è°ƒç”¨ <code>mQClientFactory.findConsumerIdList()</code> æ–¹æ³•å‘ Broker ç«¯å‘é€è·å–è¯¥æ¶ˆè´¹ç»„ä¸‹æ¶ˆè´¹è€… ID åˆ—è¡¨çš„ RPC é€šä¿¡è¯·æ±‚ï¼ˆBroker ç«¯åŸºäºå‰é¢ Consumer ç«¯ä¸ŠæŠ¥çš„å¿ƒè·³åŒ…æ•°æ®è€Œæ„å»ºçš„ consumerTable åšå‡ºå“åº”è¿”å›ï¼Œä¸šåŠ¡è¯·æ±‚ç  <code>GET_CONSUMER_LIST_BY_GROUP</code>ï¼‰</p>
</li>
<li><p>å…ˆå¯¹ Topic ä¸‹çš„æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ã€æ¶ˆè´¹è€… ID æ’åºï¼Œç„¶åç”¨æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ç­–ç•¥ç®—æ³•ï¼ˆé»˜è®¤æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„å¹³å‡åˆ†é…ç®—æ³•ï¼‰ï¼Œè®¡ç®—å‡ºå¾…æ‹‰å–çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚å¹³å‡åˆ†é…ç®—æ³•ç±»ä¼¼äºåˆ†é¡µçš„ç®—æ³•ï¼Œå°†æ‰€æœ‰ MessageQueue æ’å¥½åºç±»ä¼¼äºè®°å½•ï¼Œå°†æ‰€æœ‰æ¶ˆè´¹ç«¯ Consumer æ’å¥½åºç±»ä¼¼é¡µæ•°ï¼Œå¹¶æ±‚å‡ºæ¯ä¸€é¡µéœ€è¦åŒ…å«çš„å¹³å‡ size å’Œæ¯ä¸ªé¡µé¢è®°å½•çš„èŒƒå›´ rangeï¼Œæœ€åéå†æ•´ä¸ª range è€Œè®¡ç®—å‡ºå½“å‰ Consumer ç«¯åº”è¯¥åˆ†é…åˆ°çš„è®°å½•ï¼ˆè¿™é‡Œå³ä¸º MessageQueueï¼‰</p>
</li>
<li><p>è°ƒç”¨ updateProcessQueueTableInRebalance() æ–¹æ³•ï¼Œå…ˆå°†åˆ†é…åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—é›†åˆ mqSet ä¸ processQueueTable åšä¸€ä¸ªè¿‡æ»¤æ¯”å¯¹</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-è´Ÿè½½å‡è¡¡é‡æ–°å¹³è¡¡ç®—æ³•.png" alt=""></p>
</li>
<li><p>processQueueTable æ ‡æ³¨çš„çº¢è‰²éƒ¨åˆ†ï¼Œè¡¨ç¤ºä¸åˆ†é…åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—é›†åˆ mqSet äº’ä¸åŒ…å«ï¼Œå°†è¿™äº›é˜Ÿåˆ—è®¾ç½® Dropped å±æ€§ä¸º trueï¼Œç„¶åæŸ¥çœ‹è¿™äº›é˜Ÿåˆ—æ˜¯å¦å¯ä»¥ç§»é™¤å‡º processQueueTable ç¼“å­˜å˜é‡ã€‚å…·ä½“æ‰§è¡Œ removeUnnecessaryMessageQueue() æ–¹æ³•ï¼Œå³æ¯éš” 1s  æŸ¥çœ‹æ˜¯å¦å¯ä»¥è·å–å½“å‰æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—çš„é”ï¼Œæ‹¿åˆ°çš„è¯è¿”å› trueï¼›å¦‚æœç­‰å¾… 1s åï¼Œä»ç„¶æ‹¿ä¸åˆ°å½“å‰æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—çš„é”åˆ™è¿”å› falseã€‚å¦‚æœè¿”å› trueï¼Œåˆ™ä» processQueueTable ç¼“å­˜å˜é‡ä¸­ç§»é™¤å¯¹åº”çš„ Entry</p>
</li>
<li><p>processQueueTable çš„ç»¿è‰²éƒ¨åˆ†ï¼Œè¡¨ç¤ºä¸åˆ†é…åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—é›†åˆ mqSet çš„äº¤é›†ï¼Œåˆ¤æ–­è¯¥ ProcessQueue æ˜¯å¦å·²ç»è¿‡æœŸäº†ï¼Œåœ¨ Pull æ¨¡å¼çš„ä¸ç”¨ç®¡ï¼Œå¦‚æœæ˜¯ Push æ¨¡å¼çš„ï¼Œè®¾ç½® Dropped å±æ€§ä¸º trueï¼Œå¹¶ä¸”è°ƒç”¨ removeUnnecessaryMessageQueue() æ–¹æ³•ï¼Œåƒä¸Šé¢ä¸€æ ·å°è¯•ç§»é™¤ Entry</p>
</li>
<li><p>ä¸ºè¿‡æ»¤åçš„æ¶ˆæ¯é˜Ÿåˆ—é›†åˆ mqSet ä¸­æ¯ä¸ª MessageQueue åˆ›å»º ProcessQueue å¯¹è±¡å­˜å…¥ RebalanceImpl çš„ processQueueTable é˜Ÿåˆ—ä¸­ï¼ˆå…¶ä¸­è°ƒç”¨ RebalanceImpl å®ä¾‹çš„ <code>computePullFromWhere(MessageQueue mq)</code> æ–¹æ³•è·å–è¯¥ MessageQueue å¯¹è±¡çš„ä¸‹ä¸€ä¸ªè¿›åº¦æ¶ˆè´¹å€¼ offsetï¼Œéšåå¡«å……è‡³æ¥ä¸‹æ¥è¦åˆ›å»ºçš„ pullRequest å¯¹è±¡å±æ€§ä¸­ï¼‰ï¼Œå¹¶<strong>åˆ›å»ºæ‹‰å–è¯·æ±‚å¯¹è±¡</strong> pullRequest æ·»åŠ åˆ°æ‹‰å–åˆ—è¡¨ pullRequestList ä¸­ï¼Œæœ€åæ‰§è¡Œ dispatchPullRequest() æ–¹æ³•ï¼Œå°† Pull æ¶ˆæ¯çš„è¯·æ±‚å¯¹è±¡ PullRequest æ”¾å…¥ PullMessageService æœåŠ¡çº¿ç¨‹çš„<strong>é˜»å¡é˜Ÿåˆ—</strong> pullRequestQueue ä¸­ï¼Œå¾…è¯¥æœåŠ¡çº¿ç¨‹å–å‡ºåå‘ Broker ç«¯å‘èµ· Pull æ¶ˆæ¯çš„è¯·æ±‚</p>
<p>å¯¹æ¯”ä¸‹ RebalancePushImpl å’Œ RebalancePullImpl ä¸¤ä¸ªå®ç°ç±»çš„ dispatchPullRequest() æ–¹æ³•ï¼ŒRebalancePullImpl ç±»é‡Œé¢çš„è¯¥æ–¹æ³•ä¸ºç©º</p>
</li>
</ul>
<p>æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—åœ¨<strong>åŒä¸€æ¶ˆè´¹ç»„ä¸åŒæ¶ˆè´¹è€…ä¹‹é—´çš„è´Ÿè½½å‡è¡¡</strong>ï¼Œå…¶æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯åœ¨<strong>ä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—åœ¨åŒä¸€æ—¶é—´åªå…è®¸è¢«åŒä¸€æ¶ˆè´¹ç»„å†…çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…èƒ½åŒæ—¶æ¶ˆè´¹å¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—</strong></p>
<hr>
<h3 id="æ¶ˆæ¯æŸ¥è¯¢"><a href="#æ¶ˆæ¯æŸ¥è¯¢" class="headerlink" title="æ¶ˆæ¯æŸ¥è¯¢"></a>æ¶ˆæ¯æŸ¥è¯¢</h3><h4 id="æŸ¥è¯¢æ–¹å¼"><a href="#æŸ¥è¯¢æ–¹å¼" class="headerlink" title="æŸ¥è¯¢æ–¹å¼"></a>æŸ¥è¯¢æ–¹å¼</h4><p>RocketMQ æ”¯æŒæŒ‰ç…§ä¸¤ç§ç»´åº¦è¿›è¡Œæ¶ˆæ¯æŸ¥è¯¢ï¼šæŒ‰ç…§ Message ID æŸ¥è¯¢æ¶ˆæ¯ã€æŒ‰ç…§ Message Key æŸ¥è¯¢æ¶ˆæ¯</p>
<ul>
<li><p>RocketMQ ä¸­çš„ MessageID çš„é•¿åº¦æ€»å…±æœ‰ 16 å­—èŠ‚ï¼Œå…¶ä¸­åŒ…å«äº†æ¶ˆæ¯å­˜å‚¨ä¸»æœºåœ°å€ï¼ˆIP åœ°å€å’Œç«¯å£ï¼‰ï¼Œæ¶ˆæ¯ Commit Log offset</p>
<p>å®ç°æ–¹å¼ï¼šClient ç«¯ä» MessageID ä¸­è§£æå‡º Broker çš„åœ°å€ï¼ˆIP åœ°å€å’Œç«¯å£ï¼‰å’Œ Commit Log çš„åç§»åœ°å€ï¼Œå°è£…æˆä¸€ä¸ª RPC è¯·æ±‚åé€šè¿‡ Remoting é€šä¿¡å±‚å‘é€ï¼ˆä¸šåŠ¡è¯·æ±‚ç  VIEW_MESSAGE_BY_IDï¼‰ã€‚Broker ç«¯èµ°çš„æ˜¯ QueryMessageProcessorï¼Œè¯»å–æ¶ˆæ¯çš„è¿‡ç¨‹ç”¨å…¶ä¸­çš„ CommitLog çš„ offset å’Œ size å» CommitLog ä¸­æ‰¾åˆ°çœŸæ­£çš„è®°å½•å¹¶è§£ææˆä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯è¿”å›</p>
</li>
<li><p>æŒ‰ç…§ Message Key æŸ¥è¯¢æ¶ˆæ¯ï¼ŒIndexFile ç´¢å¼•æ–‡ä»¶ä¸ºæä¾›äº†é€šè¿‡ Message Key æŸ¥è¯¢æ¶ˆæ¯çš„æœåŠ¡</p>
<p>å®ç°æ–¹å¼ï¼šé€šè¿‡ Broker ç«¯çš„ QueryMessageProcessor ä¸šåŠ¡å¤„ç†å™¨æ¥æŸ¥è¯¢ï¼Œè¯»å–æ¶ˆæ¯çš„è¿‡ç¨‹ç”¨ <strong>Topic å’Œ Key</strong> æ‰¾åˆ° IndexFile ç´¢å¼•æ–‡ä»¶ä¸­çš„ä¸€æ¡è®°å½•ï¼Œæ ¹æ®å…¶ä¸­çš„ CommitLog Offset ä» CommitLog æ–‡ä»¶ä¸­è¯»å–æ¶ˆæ¯çš„å®ä½“å†…å®¹</p>
</li>
</ul>
<hr>
<h4 id="ç´¢å¼•æœºåˆ¶"><a href="#ç´¢å¼•æœºåˆ¶" class="headerlink" title="ç´¢å¼•æœºåˆ¶"></a>ç´¢å¼•æœºåˆ¶</h4><p>RocketMQ çš„ç´¢å¼•æ–‡ä»¶é€»è¾‘ç»“æ„ï¼Œç±»ä¼¼ JDK ä¸­ HashMap çš„å®ç°ï¼Œå…·ä½“ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-IndexFileç´¢å¼•æ–‡ä»¶.png" alt=""></p>
<p>IndexFile æ–‡ä»¶çš„å­˜å‚¨åœ¨ <code>$HOME\store\index$&#123;fileName&#125;</code>ï¼Œæ–‡ä»¶å fileName æ˜¯ä»¥åˆ›å»ºæ—¶çš„æ—¶é—´æˆ³å‘½åï¼Œæ–‡ä»¶å¤§å°æ˜¯å›ºå®šçš„ï¼Œç­‰äº <code>40+500W*4+2000W*20= 420000040</code> ä¸ªå­—èŠ‚å¤§å°ã€‚å¦‚æœæ¶ˆæ¯çš„ properties ä¸­è®¾ç½®äº† UNIQ_KEY è¿™ä¸ªå±æ€§ï¼Œå°±ç”¨ <code>topic + â€œ#â€ + UNIQ_KEY</code> ä½œä¸º key æ¥åšå†™å…¥æ“ä½œï¼›å¦‚æœæ¶ˆæ¯è®¾ç½®äº† KEYS å±æ€§ï¼ˆå¤šä¸ª KEY ä»¥ç©ºæ ¼åˆ†éš”ï¼‰ï¼Œä¹Ÿä¼šç”¨ <code>topic + â€œ#â€ + KEY</code> æ¥åšç´¢å¼•</p>
<p>æ•´ä¸ª Index File çš„ç»“æ„å¦‚å›¾ï¼Œ40 Byte çš„ Header ç”¨äºä¿å­˜ä¸€äº›æ€»çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œ<code>4*500W</code> çš„ Slot Table å¹¶ä¸ä¿å­˜çœŸæ­£çš„ç´¢å¼•æ•°æ®ï¼Œè€Œæ˜¯ä¿å­˜æ¯ä¸ªæ§½ä½å¯¹åº”çš„å•å‘é“¾è¡¨çš„<strong>å¤´æŒ‡é’ˆ</strong>ï¼Œå³ä¸€ä¸ª Index File å¯ä»¥ä¿å­˜ 2000W ä¸ªç´¢å¼•ï¼Œ<code>20*2000W</code> æ˜¯<strong>çœŸæ­£çš„ç´¢å¼•æ•°æ®</strong></p>
<p>ç´¢å¼•æ•°æ®åŒ…å«äº† Key Hash/CommitLog Offset/Timestamp/NextIndex offset è¿™å››ä¸ªå­—æ®µï¼Œä¸€å…± 20 Byte</p>
<ul>
<li>NextIndex offset å³å‰é¢è¯»å‡ºæ¥çš„ slotValueï¼Œå¦‚æœæœ‰ hash å†²çªï¼Œå°±å¯ä»¥ç”¨è¿™ä¸ªå­—æ®µå°†æ‰€æœ‰å†²çªçš„ç´¢å¼•ç”¨é“¾è¡¨çš„æ–¹å¼ä¸²èµ·æ¥</li>
<li>Timestamp è®°å½•çš„æ˜¯æ¶ˆæ¯ storeTimestamp ä¹‹é—´çš„å·®ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªç»å¯¹çš„æ—¶é—´</li>
</ul>
<p>å‚è€ƒæ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq/blob/master/docs/cn/design.md">https://github.com/apache/rocketmq/blob/master/docs/cn/design.md</a></p>
<hr>
<h3 id="æ¶ˆæ¯é‡è¯•"><a href="#æ¶ˆæ¯é‡è¯•" class="headerlink" title="æ¶ˆæ¯é‡è¯•"></a>æ¶ˆæ¯é‡è¯•</h3><h4 id="æ¶ˆæ¯é‡æŠ•"><a href="#æ¶ˆæ¯é‡æŠ•" class="headerlink" title="æ¶ˆæ¯é‡æŠ•"></a>æ¶ˆæ¯é‡æŠ•</h4><p>ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼ŒåŒæ­¥æ¶ˆæ¯å’Œå¼‚æ­¥æ¶ˆæ¯å¤±è´¥ä¼šé‡æŠ•ï¼Œoneway æ²¡æœ‰ä»»ä½•ä¿è¯ã€‚æ¶ˆæ¯é‡æŠ•ä¿è¯æ¶ˆæ¯å°½å¯èƒ½å‘é€æˆåŠŸã€ä¸ä¸¢å¤±ï¼Œä½†å½“å‡ºç°æ¶ˆæ¯é‡å¤§ã€ç½‘ç»œæŠ–åŠ¨æ—¶ï¼Œå¯èƒ½ä¼šé€ æˆæ¶ˆæ¯é‡å¤ï¼›ç”Ÿäº§è€…ä¸»åŠ¨é‡å‘ã€Consumer è´Ÿè½½å˜åŒ–ä¹Ÿä¼šå¯¼è‡´é‡å¤æ¶ˆæ¯</p>
<p>å¦‚ä¸‹æ–¹æ³•å¯ä»¥è®¾ç½®æ¶ˆæ¯é‡æŠ•ç­–ç•¥ï¼š</p>
<ul>
<li>retryTimesWhenSendFailedï¼šåŒæ­¥å‘é€å¤±è´¥é‡æŠ•æ¬¡æ•°ï¼Œé»˜è®¤ä¸º 2ï¼Œå› æ­¤ç”Ÿäº§è€…ä¼šæœ€å¤šå°è¯•å‘é€ retryTimesWhenSendFailed + 1 æ¬¡ã€‚ä¸ä¼šé€‰æ‹©ä¸Šæ¬¡å¤±è´¥çš„ Brokerï¼Œå°è¯•å‘å…¶ä»– Broker å‘é€ï¼Œ<strong>æœ€å¤§ç¨‹åº¦ä¿è¯æ¶ˆæ¯ä¸ä¸¢</strong>ã€‚è¶…è¿‡é‡æŠ•æ¬¡æ•°æŠ›å‡ºå¼‚å¸¸ï¼Œç”±å®¢æˆ·ç«¯ä¿è¯æ¶ˆæ¯ä¸ä¸¢ã€‚å½“å‡ºç° RemotingExceptionã€MQClientException å’Œéƒ¨åˆ† MQBrokerException æ—¶ä¼šé‡æŠ•</li>
<li>retryTimesWhenSendAsyncFailedï¼šå¼‚æ­¥å‘é€å¤±è´¥é‡è¯•æ¬¡æ•°ï¼Œå¼‚æ­¥é‡è¯•ä¸ä¼šé€‰æ‹©å…¶ä»– Brokerï¼Œä»…åœ¨åŒä¸€ä¸ª Broker ä¸Šåšé‡è¯•ï¼Œ<strong>ä¸ä¿è¯æ¶ˆæ¯ä¸ä¸¢</strong></li>
<li>retryAnotherBrokerWhenNotStoreOKï¼šæ¶ˆæ¯åˆ·ç›˜ï¼ˆä¸»æˆ–å¤‡ï¼‰è¶…æ—¶æˆ– slave ä¸å¯ç”¨ï¼ˆè¿”å›çŠ¶æ€é SEND_OKï¼‰ï¼Œæ˜¯å¦å°è¯•å‘é€åˆ°å…¶ä»–  Brokerï¼Œé»˜è®¤ falseï¼Œååˆ†é‡è¦æ¶ˆæ¯å¯ä»¥å¼€å¯</li>
</ul>
<p>æ³¨æ„ç‚¹ï¼š</p>
<ul>
<li>å¦‚æœåŒæ­¥æ¨¡å¼å‘é€å¤±è´¥ï¼Œåˆ™é€‰æ‹©åˆ°ä¸‹ä¸€ä¸ª Brokerï¼Œå¦‚æœå¼‚æ­¥æ¨¡å¼å‘é€å¤±è´¥ï¼Œåˆ™<strong>åªä¼šåœ¨å½“å‰ Broker è¿›è¡Œé‡è¯•</strong></li>
<li>å‘é€æ¶ˆæ¯è¶…æ—¶æ—¶é—´é»˜è®¤ 3000 æ¯«ç§’ï¼Œå°±ä¸ä¼šå†å°è¯•é‡è¯•</li>
</ul>
<hr>
<h4 id="æ¶ˆæ¯é‡è¯•-1"><a href="#æ¶ˆæ¯é‡è¯•-1" class="headerlink" title="æ¶ˆæ¯é‡è¯•"></a>æ¶ˆæ¯é‡è¯•</h4><p>Consumer æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥åï¼Œæä¾›äº†ä¸€ç§é‡è¯•æœºåˆ¶ï¼Œä»¤æ¶ˆæ¯å†æ¶ˆè´¹ä¸€æ¬¡ã€‚Consumer æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥å¯ä»¥è®¤ä¸ºæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p>
<ul>
<li>ç”±äºæ¶ˆæ¯æœ¬èº«çš„åŸå› ï¼Œä¾‹å¦‚ååºåˆ—åŒ–å¤±è´¥ï¼Œæ¶ˆæ¯æ•°æ®æœ¬èº«æ— æ³•å¤„ç†ç­‰ã€‚è¿™ç§é”™è¯¯é€šå¸¸éœ€è¦è·³è¿‡è¿™æ¡æ¶ˆæ¯ï¼Œå†æ¶ˆè´¹å…¶å®ƒæ¶ˆæ¯ï¼Œè€Œè¿™æ¡å¤±è´¥çš„æ¶ˆæ¯å³ä½¿ç«‹åˆ»é‡è¯•æ¶ˆè´¹ï¼Œ99% ä¹Ÿä¸æˆåŠŸï¼Œæ‰€ä»¥éœ€è¦æä¾›ä¸€ç§å®šæ—¶é‡è¯•æœºåˆ¶ï¼Œå³è¿‡ 10 ç§’åå†é‡è¯•</li>
<li>ç”±äºä¾èµ–çš„ä¸‹æ¸¸åº”ç”¨æœåŠ¡ä¸å¯ç”¨ï¼Œä¾‹å¦‚ DB è¿æ¥ä¸å¯ç”¨ï¼Œå¤–ç³»ç»Ÿç½‘ç»œä¸å¯è¾¾ç­‰ã€‚è¿™ç§æƒ…å†µå³ä½¿è·³è¿‡å½“å‰å¤±è´¥çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹å…¶ä»–æ¶ˆæ¯åŒæ ·ä¹Ÿä¼šæŠ¥é”™ï¼Œè¿™ç§æƒ…å†µå»ºè®®åº”ç”¨ sleep 30sï¼Œå†æ¶ˆè´¹ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œè¿™æ ·å¯ä»¥å‡è½» Broker é‡è¯•æ¶ˆæ¯çš„å‹åŠ›</li>
</ul>
<p>RocketMQ ä¼šä¸ºæ¯ä¸ªæ¶ˆè´¹ç»„éƒ½è®¾ç½®ä¸€ä¸ª Topic åç§°ä¸º <code>%RETRY%+consumerGroup</code> çš„é‡è¯•é˜Ÿåˆ—ï¼ˆè¿™ä¸ª Topic çš„é‡è¯•é˜Ÿåˆ—æ˜¯<strong>é’ˆå¯¹æ¶ˆè´¹ç»„</strong>ï¼Œè€Œä¸æ˜¯é’ˆå¯¹æ¯ä¸ª Topic è®¾ç½®çš„ï¼‰ï¼Œç”¨äºæš‚æ—¶ä¿å­˜å› ä¸ºå„ç§å¼‚å¸¸è€Œå¯¼è‡´ Consumer ç«¯æ— æ³•æ¶ˆè´¹çš„æ¶ˆæ¯</p>
<ul>
<li><p>é¡ºåºæ¶ˆæ¯çš„é‡è¯•ï¼Œå½“æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥åï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ ä¼šè‡ªåŠ¨ä¸æ–­è¿›è¡Œæ¶ˆæ¯é‡è¯•ï¼ˆæ¯æ¬¡é—´éš”æ—¶é—´ä¸º 1 ç§’ï¼‰ï¼Œè¿™æ—¶åº”ç”¨ä¼šå‡ºç°æ¶ˆæ¯æ¶ˆè´¹è¢«é˜»å¡çš„æƒ…å†µã€‚æ‰€ä»¥åœ¨ä½¿ç”¨é¡ºåºæ¶ˆæ¯æ—¶ï¼Œå¿…é¡»ä¿è¯åº”ç”¨èƒ½å¤ŸåŠæ—¶ç›‘æ§å¹¶å¤„ç†æ¶ˆè´¹å¤±è´¥çš„æƒ…å†µï¼Œé¿å…é˜»å¡ç°è±¡çš„å‘ç”Ÿ</p>
</li>
<li><p>æ— åºæ¶ˆæ¯ï¼ˆæ™®é€šã€å®šæ—¶ã€å»¶æ—¶ã€äº‹åŠ¡æ¶ˆæ¯ï¼‰çš„é‡è¯•ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®è¿”å›çŠ¶æ€è¾¾åˆ°æ¶ˆæ¯é‡è¯•çš„ç»“æœã€‚æ— åºæ¶ˆæ¯çš„é‡è¯•åªé’ˆå¯¹é›†ç¾¤æ¶ˆè´¹æ–¹å¼ç”Ÿæ•ˆï¼Œå¹¿æ’­æ–¹å¼ä¸æä¾›å¤±è´¥é‡è¯•ç‰¹æ€§ï¼Œå³æ¶ˆè´¹å¤±è´¥åï¼Œå¤±è´¥æ¶ˆæ¯ä¸å†é‡è¯•ï¼Œç»§ç»­æ¶ˆè´¹æ–°çš„æ¶ˆæ¯</p>
</li>
</ul>
<p><strong>æ— åºæ¶ˆæ¯æƒ…å†µä¸‹</strong>ï¼Œå› ä¸ºå¼‚å¸¸æ¢å¤éœ€è¦ä¸€äº›æ—¶é—´ï¼Œä¼šä¸ºé‡è¯•é˜Ÿåˆ—è®¾ç½®å¤šä¸ªé‡è¯•çº§åˆ«ï¼Œæ¯ä¸ªé‡è¯•çº§åˆ«éƒ½æœ‰å¯¹åº”çš„é‡æ–°æŠ•é€’å»¶æ—¶ï¼Œé‡è¯•æ¬¡æ•°è¶Šå¤šæŠ•é€’å»¶æ—¶å°±è¶Šå¤§ã€‚RocketMQ å¯¹äºé‡è¯•æ¶ˆæ¯çš„å¤„ç†æ˜¯å…ˆä¿å­˜è‡³ Topic åç§°ä¸º <code>SCHEDULE_TOPIC_XXXX</code> çš„å»¶è¿Ÿé˜Ÿåˆ—ä¸­ï¼Œåå°å®šæ—¶ä»»åŠ¡<strong>æŒ‰ç…§å¯¹åº”çš„æ—¶é—´è¿›è¡Œ Delay å</strong>é‡æ–°ä¿å­˜è‡³ <code>%RETRY%+consumerGroup</code> çš„é‡è¯•é˜Ÿåˆ—ä¸­</p>
<p>æ¶ˆæ¯é˜Ÿåˆ— RocketMQ é»˜è®¤å…è®¸æ¯æ¡æ¶ˆæ¯æœ€å¤šé‡è¯• 16 æ¬¡ï¼Œæ¯æ¬¡é‡è¯•çš„é—´éš”æ—¶é—´å¦‚ä¸‹è¡¨ç¤ºï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">ç¬¬å‡ æ¬¡é‡è¯•</th>
<th style="text-align:center">ä¸ä¸Šæ¬¡é‡è¯•çš„é—´éš”æ—¶é—´</th>
<th style="text-align:center">ç¬¬å‡ æ¬¡é‡è¯•</th>
<th style="text-align:center">ä¸ä¸Šæ¬¡é‡è¯•çš„é—´éš”æ—¶é—´</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">10 ç§’</td>
<td style="text-align:center">9</td>
<td style="text-align:center">7 åˆ†é’Ÿ</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">30 ç§’</td>
<td style="text-align:center">10</td>
<td style="text-align:center">8 åˆ†é’Ÿ</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">1 åˆ†é’Ÿ</td>
<td style="text-align:center">11</td>
<td style="text-align:center">9 åˆ†é’Ÿ</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">2 åˆ†é’Ÿ</td>
<td style="text-align:center">12</td>
<td style="text-align:center">10 åˆ†é’Ÿ</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">3 åˆ†é’Ÿ</td>
<td style="text-align:center">13</td>
<td style="text-align:center">20 åˆ†é’Ÿ</td>
</tr>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:center">4 åˆ†é’Ÿ</td>
<td style="text-align:center">14</td>
<td style="text-align:center">30 åˆ†é’Ÿ</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:center">5 åˆ†é’Ÿ</td>
<td style="text-align:center">15</td>
<td style="text-align:center">1 å°æ—¶</td>
</tr>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:center">6 åˆ†é’Ÿ</td>
<td style="text-align:center">16</td>
<td style="text-align:center">2 å°æ—¶</td>
</tr>
</tbody>
</table>
</div>
<p>å¦‚æœæ¶ˆæ¯é‡è¯• 16 æ¬¡åä»ç„¶å¤±è´¥ï¼Œæ¶ˆæ¯å°†<strong>ä¸å†æŠ•é€’</strong>ï¼Œå¦‚æœä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°é‡è¯•æ—¶é—´é—´éš”è®¡ç®—ï¼ŒæŸæ¡æ¶ˆæ¯åœ¨ä¸€ç›´æ¶ˆè´¹å¤±è´¥çš„å‰æä¸‹ï¼Œå°†ä¼šåœ¨æ¥ä¸‹æ¥çš„ 4 å°æ—¶ 46 åˆ†é’Ÿä¹‹å†…è¿›è¡Œ 16 æ¬¡é‡è¯•ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´èŒƒå›´æ¶ˆæ¯å°†ä¸å†é‡è¯•æŠ•é€’</p>
<p>æ—¶é—´é—´éš”ä¸æ”¯æŒè‡ªå®šä¹‰é…ç½®ï¼Œæœ€å¤§é‡è¯•æ¬¡æ•°å¯é€šè¿‡è‡ªå®šä¹‰å‚æ•° <code>MaxReconsumeTimes</code> å–å€¼è¿›è¡Œé…ç½®ï¼Œè‹¥é…ç½®è¶…è¿‡ 16 æ¬¡ï¼Œåˆ™è¶…è¿‡çš„é—´éš”æ—¶é—´å‡ä¸º 2 å°æ—¶</p>
<p>è¯´æ˜ï¼šä¸€æ¡æ¶ˆæ¯æ— è®ºé‡è¯•å¤šå°‘æ¬¡ï¼Œ<strong>æ¶ˆæ¯çš„ Message ID æ˜¯ä¸ä¼šæ”¹å˜çš„</strong></p>
<hr>
<h4 id="é‡è¯•æ“ä½œ"><a href="#é‡è¯•æ“ä½œ" class="headerlink" title="é‡è¯•æ“ä½œ"></a>é‡è¯•æ“ä½œ</h4><p>é›†ç¾¤æ¶ˆè´¹æ–¹å¼ä¸‹ï¼Œæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥åæœŸæœ›æ¶ˆæ¯é‡è¯•ï¼Œéœ€è¦åœ¨æ¶ˆæ¯ç›‘å¬å™¨æ¥å£çš„å®ç°ä¸­æ˜ç¡®è¿›è¡Œé…ç½®ï¼ˆä¸‰ç§æ–¹å¼ä»»é€‰ä¸€ç§ï¼‰ï¼š</p>
<ul>
<li>è¿”å› Action.ReconsumeLater ï¼ˆæ¨èï¼‰</li>
<li>è¿”å› null</li>
<li>æŠ›å‡ºå¼‚å¸¸</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageListenerImpl</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Action <span class="title function_">consume</span><span class="params">(Message message, ConsumeContext context)</span> &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">        doConsumeMessage(message);</span><br><span class="line">        <span class="comment">//æ–¹å¼1ï¼šè¿”å› Action.ReconsumeLaterï¼Œæ¶ˆæ¯å°†é‡è¯•</span></span><br><span class="line">        <span class="keyword">return</span> Action.ReconsumeLater;</span><br><span class="line">        <span class="comment">//æ–¹å¼2ï¼šè¿”å› nullï¼Œæ¶ˆæ¯å°†é‡è¯•</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">//æ–¹å¼3ï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œ æ¶ˆæ¯å°†é‡è¯•</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Consumer Message exceotion&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é›†ç¾¤æ¶ˆè´¹æ–¹å¼ä¸‹ï¼Œæ¶ˆæ¯å¤±è´¥åæœŸæœ›æ¶ˆæ¯ä¸é‡è¯•ï¼Œéœ€è¦æ•è·æ¶ˆè´¹é€»è¾‘ä¸­å¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸ï¼Œæœ€ç»ˆè¿”å› Action.CommitMessageï¼Œæ­¤åè¿™æ¡æ¶ˆæ¯å°†ä¸ä¼šå†é‡è¯•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageListenerImpl</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Action <span class="title function_">consume</span><span class="params">(Message message, ConsumeContext context)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            doConsumeMessage(message);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="comment">// æ•è·æ¶ˆè´¹é€»è¾‘ä¸­çš„æ‰€æœ‰å¼‚å¸¸ï¼Œå¹¶è¿”å› Action.CommitMessage;</span></span><br><span class="line">            <span class="keyword">return</span> Action.CommitMessage;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ¶ˆæ¯å¤„ç†æ­£å¸¸ï¼Œç›´æ¥è¿”å› Action.CommitMessage;</span></span><br><span class="line">        <span class="keyword">return</span> Action.CommitMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡ªå®šä¹‰æ¶ˆæ¯æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ŒRocketMQ å…è®¸ Consumer å¯åŠ¨çš„æ—¶å€™è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé‡è¯•æ—¶é—´é—´éš”å°†æŒ‰ç…§å¦‚ä¸‹ç­–ç•¥ï¼š</p>
<ul>
<li>æœ€å¤§é‡è¯•æ¬¡æ•°å°äºç­‰äº 16 æ¬¡ï¼Œåˆ™é‡è¯•æ—¶é—´é—´éš”åŒä¸Šè¡¨æè¿°</li>
<li>æœ€å¤§é‡è¯•æ¬¡æ•°å¤§äº 16 æ¬¡ï¼Œè¶…è¿‡ 16 æ¬¡çš„é‡è¯•æ—¶é—´é—´éš”å‡ä¸ºæ¯æ¬¡ 2 å°æ—¶</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line"><span class="comment">// é…ç½®å¯¹åº” Group ID çš„æœ€å¤§æ¶ˆæ¯é‡è¯•æ¬¡æ•°ä¸º 20 æ¬¡</span></span><br><span class="line">properties.put(PropertyKeyConst.MaxReconsumeTimes,<span class="string">&quot;20&quot;</span>);</span><br><span class="line"><span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> ONSFactory.createConsumer(properties);</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>æ¶ˆæ¯æœ€å¤§é‡è¯•æ¬¡æ•°çš„è®¾ç½®å¯¹ç›¸åŒ Group ID ä¸‹çš„æ‰€æœ‰ Consumer å®ä¾‹æœ‰æ•ˆã€‚ä¾‹å¦‚åªå¯¹ç›¸åŒ Group ID ä¸‹ä¸¤ä¸ª Consumer å®ä¾‹ä¸­çš„å…¶ä¸­ä¸€ä¸ªè®¾ç½®äº† MaxReconsumeTimesï¼Œé‚£ä¹ˆè¯¥é…ç½®å¯¹ä¸¤ä¸ª Consumer å®ä¾‹å‡ç”Ÿæ•ˆ</li>
<li>é…ç½®é‡‡ç”¨è¦†ç›–çš„æ–¹å¼ç”Ÿæ•ˆï¼Œå³æœ€åå¯åŠ¨çš„ Consumer å®ä¾‹ä¼šè¦†ç›–ä¹‹å‰çš„å¯åŠ¨å®ä¾‹çš„é…ç½®</li>
</ul>
<p>æ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯åï¼Œå¯æŒ‰ç…§å¦‚ä¸‹æ–¹å¼è·å–æ¶ˆæ¯çš„é‡è¯•æ¬¡æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageListenerImpl</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Action <span class="title function_">consume</span><span class="params">(Message message, ConsumeContext context)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–æ¶ˆæ¯çš„é‡è¯•æ¬¡æ•°</span></span><br><span class="line">        System.out.println(message.getReconsumeTimes());</span><br><span class="line">        <span class="keyword">return</span> Action.CommitMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="æ­»ä¿¡é˜Ÿåˆ—"><a href="#æ­»ä¿¡é˜Ÿåˆ—" class="headerlink" title="æ­»ä¿¡é˜Ÿåˆ—"></a>æ­»ä¿¡é˜Ÿåˆ—</h3><p>æ­£å¸¸æƒ…å†µä¸‹æ— æ³•è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ç§°ä¸ºæ­»ä¿¡æ¶ˆæ¯ï¼ˆDead-Letter Messageï¼‰ï¼Œå­˜å‚¨æ­»ä¿¡æ¶ˆæ¯çš„ç‰¹æ®Šé˜Ÿåˆ—ç§°ä¸ºæ­»ä¿¡é˜Ÿåˆ—ï¼ˆDead-Letter Queueï¼‰</p>
<p>å½“ä¸€æ¡æ¶ˆæ¯åˆæ¬¡æ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ ä¼šè‡ªåŠ¨è¿›è¡Œæ¶ˆæ¯é‡è¯•ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œè‹¥æ¶ˆè´¹ä¾ç„¶å¤±è´¥ï¼Œåˆ™è¡¨æ˜æ¶ˆè´¹è€…åœ¨æ­£å¸¸æƒ…å†µä¸‹æ— æ³•æ­£ç¡®åœ°æ¶ˆè´¹è¯¥æ¶ˆæ¯ï¼Œæ­¤æ—¶ RocketMQ ä¸ä¼šç«‹åˆ»å°†æ¶ˆæ¯ä¸¢å¼ƒï¼Œè€Œæ˜¯å°†å…¶å‘é€åˆ°è¯¥æ¶ˆè´¹è€…å¯¹åº”çš„æ­»ä¿¡é˜Ÿåˆ—ä¸­</p>
<p>æ­»ä¿¡æ¶ˆæ¯å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>ä¸ä¼šå†è¢«æ¶ˆè´¹è€…æ­£å¸¸æ¶ˆè´¹</li>
<li>æœ‰æ•ˆæœŸä¸æ­£å¸¸æ¶ˆæ¯ç›¸åŒï¼Œå‡ä¸º 3 å¤©ï¼Œ3 å¤©åä¼šè¢«è‡ªåŠ¨åˆ é™¤ï¼Œæ‰€ä»¥è¯·åœ¨æ­»ä¿¡æ¶ˆæ¯äº§ç”Ÿåçš„ 3 å¤©å†…åŠæ—¶å¤„ç†</li>
</ul>
<p>æ­»ä¿¡é˜Ÿåˆ—å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li><strong>ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—å¯¹åº”ä¸€ä¸ª Group IDï¼Œ è€Œä¸æ˜¯å¯¹åº”å•ä¸ªæ¶ˆè´¹è€…å®ä¾‹</strong></li>
<li>å¦‚æœä¸€ä¸ª Group ID æœªäº§ç”Ÿæ­»ä¿¡æ¶ˆæ¯ï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ ä¸ä¼šä¸ºå…¶åˆ›å»ºç›¸åº”çš„æ­»ä¿¡é˜Ÿåˆ—</li>
<li>ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—åŒ…å«äº†å¯¹åº” Group ID äº§ç”Ÿçš„æ‰€æœ‰æ­»ä¿¡æ¶ˆæ¯ï¼Œä¸è®ºè¯¥æ¶ˆæ¯å±äºå“ªä¸ª Topic</li>
</ul>
<p>ä¸€æ¡æ¶ˆæ¯è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œéœ€è¦æ’æŸ¥å¯ç–‘å› ç´ å¹¶è§£å†³é—®é¢˜åï¼Œå¯ä»¥åœ¨æ¶ˆæ¯é˜Ÿåˆ— RocketMQ æ§åˆ¶å°é‡æ–°å‘é€è¯¥æ¶ˆæ¯ï¼Œè®©æ¶ˆè´¹è€…é‡æ–°æ¶ˆè´¹ä¸€æ¬¡</p>
<hr>
<h3 id="é«˜å¯é æ€§"><a href="#é«˜å¯é æ€§" class="headerlink" title="é«˜å¯é æ€§"></a>é«˜å¯é æ€§</h3><p>RocketMQ æ¶ˆæ¯ä¸¢å¤±å¯èƒ½å‘ç”Ÿåœ¨ä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µï¼š</p>
<ul>
<li>ç”Ÿäº§é˜¶æ®µï¼šæ¶ˆæ¯åœ¨ Producer å‘é€ç«¯åˆ›å»ºå‡ºæ¥ï¼Œç»è¿‡ç½‘ç»œä¼ è¾“å‘é€åˆ° Broker å­˜å‚¨ç«¯<ul>
<li>ç”Ÿäº§è€…å¾—åˆ°ä¸€ä¸ªæˆåŠŸçš„å“åº”ï¼Œå°±å¯ä»¥è®¤ä¸ºæ¶ˆæ¯çš„å­˜å‚¨å’Œæ¶ˆæ¯çš„æ¶ˆè´¹éƒ½æ˜¯å¯é çš„</li>
<li>æ¶ˆæ¯é‡æŠ•æœºåˆ¶</li>
</ul>
</li>
<li>å­˜å‚¨é˜¶æ®µï¼šæ¶ˆæ¯åœ¨ Broker ç«¯å­˜å‚¨ï¼Œå¦‚æœæ˜¯ä¸»å¤‡æˆ–è€…å¤šå‰¯æœ¬ï¼Œæ¶ˆæ¯ä¼šåœ¨è¿™ä¸ªé˜¶æ®µè¢«å¤åˆ¶åˆ°å…¶ä»–çš„èŠ‚ç‚¹æˆ–è€…å‰¯æœ¬ä¸Š<ul>
<li>å•ç‚¹ï¼šåˆ·ç›˜æœºåˆ¶ï¼ˆåŒæ­¥æˆ–å¼‚æ­¥ï¼‰</li>
<li>ä¸»ä»ï¼šæ¶ˆæ¯åŒæ­¥æœºåˆ¶ï¼ˆå¼‚æ­¥å¤åˆ¶æˆ–åŒæ­¥åŒå†™ï¼Œä¸»ä»å¤åˆ¶ç« èŠ‚è¯¦è§£ï¼‰</li>
<li>è¿‡æœŸåˆ é™¤ï¼šæ“ä½œ CommitLogã€ConsumeQueue æ–‡ä»¶æ˜¯åŸºäºæ–‡ä»¶å†…å­˜æ˜ å°„æœºåˆ¶ï¼Œå¹¶ä¸”åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šå°†æ‰€æœ‰çš„æ–‡ä»¶åŠ è½½ï¼Œä¸ºäº†é¿å…å†…å­˜ä¸ç£ç›˜çš„æµªè´¹ï¼Œè®©ç£ç›˜èƒ½å¤Ÿå¾ªç¯åˆ©ç”¨ï¼Œé˜²æ­¢ç£ç›˜ä¸è¶³å¯¼è‡´æ¶ˆæ¯æ— æ³•å†™å…¥ç­‰å¼•å…¥äº†æ–‡ä»¶è¿‡æœŸåˆ é™¤æœºåˆ¶ã€‚æœ€ç»ˆä½¿å¾—ç£ç›˜æ°´ä½ä¿æŒåœ¨ä¸€å®šæ°´å¹³ï¼Œæœ€ç»ˆä¿è¯æ–°å†™å…¥æ¶ˆæ¯çš„å¯é å­˜å‚¨</li>
</ul>
</li>
<li>æ¶ˆè´¹é˜¶æ®µï¼šConsumer æ¶ˆè´¹ç«¯ä» Brokerå­˜å‚¨ç«¯æ‹‰å–æ¶ˆæ¯ï¼Œç»è¿‡ç½‘ç»œä¼ è¾“å‘é€åˆ° Consumer æ¶ˆè´¹ç«¯ä¸Š<ul>
<li>æ¶ˆæ¯é‡è¯•æœºåˆ¶æ¥æœ€å¤§é™åº¦çš„ä¿è¯æ¶ˆæ¯çš„æ¶ˆè´¹</li>
<li>æ¶ˆè´¹å¤±è´¥çš„è¿›è¡Œæ¶ˆæ¯å›é€€ï¼Œé‡è¯•æ¬¡æ•°è¿‡å¤šçš„æ¶ˆæ¯æ”¾å…¥æ­»ä¿¡é˜Ÿåˆ—</li>
</ul>
</li>
</ul>
<p>æ¨èæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://cdn.modb.pro/db/394751">https://cdn.modb.pro/db/394751</a></p>
<hr>
<h3 id="å¹‚ç­‰æ¶ˆè´¹"><a href="#å¹‚ç­‰æ¶ˆè´¹" class="headerlink" title="å¹‚ç­‰æ¶ˆè´¹"></a>å¹‚ç­‰æ¶ˆè´¹</h3><p>æ¶ˆæ¯é˜Ÿåˆ— RocketMQ æ¶ˆè´¹è€…åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯ä»¥åï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡ä¸Šçš„å”¯ä¸€ Key å¯¹æ¶ˆæ¯åšå¹‚ç­‰å¤„ç†</p>
<p>At least Once æœºåˆ¶ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œä½†æ˜¯å¯èƒ½ä¼šé€ æˆæ¶ˆæ¯é‡å¤ï¼ŒRocketMQ ä¸­æ— æ³•é¿å…æ¶ˆæ¯é‡å¤ï¼ˆExactly-Onceï¼‰ï¼Œåœ¨äº’è”ç½‘åº”ç”¨ä¸­ï¼Œå°¤å…¶åœ¨ç½‘ç»œä¸ç¨³å®šçš„æƒ…å†µä¸‹ï¼Œå‡ ç§æƒ…å†µï¼š</p>
<ul>
<li><p>å‘é€æ—¶æ¶ˆæ¯é‡å¤ï¼šå½“ä¸€æ¡æ¶ˆæ¯å·²è¢«æˆåŠŸå‘é€åˆ°æœåŠ¡ç«¯å¹¶å®ŒæˆæŒä¹…åŒ–ï¼Œæ­¤æ—¶å‡ºç°äº†ç½‘ç»œé—ªæ–­æˆ–å®¢æˆ·ç«¯å®•æœºï¼Œå¯¼è‡´æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯åº”ç­”å¤±è´¥ã€‚æ­¤æ—¶ç”Ÿäº§è€…æ„è¯†åˆ°æ¶ˆæ¯å‘é€å¤±è´¥å¹¶å°è¯•å†æ¬¡å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åç»­ä¼šæ”¶åˆ°ä¸¤æ¡å†…å®¹ç›¸åŒå¹¶ä¸” Message ID ä¹Ÿç›¸åŒçš„æ¶ˆæ¯</p>
</li>
<li><p>æŠ•é€’æ—¶æ¶ˆæ¯é‡å¤ï¼šæ¶ˆæ¯æ¶ˆè´¹çš„åœºæ™¯ä¸‹ï¼Œæ¶ˆæ¯å·²æŠ•é€’åˆ°æ¶ˆè´¹è€…å¹¶å®Œæˆä¸šåŠ¡å¤„ç†ï¼Œå½“å®¢æˆ·ç«¯ç»™æœåŠ¡ç«¯åé¦ˆåº”ç­”çš„æ—¶å€™ç½‘ç»œé—ªæ–­ã€‚ä¸ºäº†ä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ çš„æœåŠ¡ç«¯å°†åœ¨ç½‘ç»œæ¢å¤åå†æ¬¡å°è¯•æŠ•é€’ä¹‹å‰å·²è¢«å¤„ç†è¿‡çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åç»­ä¼šæ”¶åˆ°ä¸¤æ¡å†…å®¹ç›¸åŒå¹¶ä¸” Message ID ä¹Ÿç›¸åŒçš„æ¶ˆæ¯</p>
</li>
<li><p>è´Ÿè½½å‡è¡¡æ—¶æ¶ˆæ¯é‡å¤ï¼šå½“æ¶ˆæ¯é˜Ÿåˆ— RocketMQ çš„ Broker æˆ–å®¢æˆ·ç«¯é‡å¯ã€æ‰©å®¹æˆ–ç¼©å®¹æ—¶ï¼Œä¼šè§¦å‘ Rebalanceï¼Œæ­¤æ—¶æ¶ˆè´¹è€…å¯èƒ½ä¼šæ”¶åˆ°é‡å¤æ¶ˆæ¯</p>
</li>
</ul>
<p>å¤„ç†æ–¹å¼ï¼š</p>
<ul>
<li><p>å› ä¸º Message ID æœ‰å¯èƒ½å‡ºç°å†²çªï¼ˆé‡å¤ï¼‰çš„æƒ…å†µï¼Œæ‰€ä»¥çœŸæ­£å®‰å…¨çš„å¹‚ç­‰å¤„ç†ï¼Œä¸å»ºè®®ä»¥ Message ID ä½œä¸ºå¤„ç†ä¾æ®ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯ä»¥ä¸šåŠ¡å”¯ä¸€æ ‡è¯†ä½œä¸ºå¹‚ç­‰å¤„ç†çš„å…³é”®ä¾æ®ï¼Œè€Œä¸šåŠ¡çš„å”¯ä¸€æ ‡è¯†å¯ä»¥é€šè¿‡æ¶ˆæ¯ Key è¿›è¡Œè®¾ç½®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">message.setKey(<span class="string">&quot;ORDERID_100&quot;</span>);</span><br><span class="line"><span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.send(message);</span><br></pre></td></tr></table></figure>
</li>
<li><p>è®¢é˜…æ–¹æ”¶åˆ°æ¶ˆæ¯æ—¶å¯ä»¥æ ¹æ®æ¶ˆæ¯çš„ Key è¿›è¡Œå¹‚ç­‰å¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">consumer.subscribe(<span class="string">&quot;ons_test&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="keyword">new</span> <span class="title class_">MessageListener</span>() &#123;</span><br><span class="line">    <span class="keyword">public</span> Action <span class="title function_">consume</span><span class="params">(Message message, ConsumeContext context)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> message.getKey()</span><br><span class="line">        <span class="comment">// æ ¹æ®ä¸šåŠ¡å”¯ä¸€æ ‡è¯†çš„ key åšå¹‚ç­‰å¤„ç†</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="æµé‡æ§åˆ¶"><a href="#æµé‡æ§åˆ¶" class="headerlink" title="æµé‡æ§åˆ¶"></a>æµé‡æ§åˆ¶</h3><p>ç”Ÿäº§è€…æµæ§ï¼Œå› ä¸º Broker å¤„ç†èƒ½åŠ›è¾¾åˆ°ç“¶é¢ˆï¼›æ¶ˆè´¹è€…æµæ§ï¼Œå› ä¸ºæ¶ˆè´¹èƒ½åŠ›è¾¾åˆ°ç“¶é¢ˆ</p>
<p>ç”Ÿäº§è€…æµæ§ï¼š</p>
<ul>
<li>CommitLog æ–‡ä»¶è¢«é”æ—¶é—´è¶…è¿‡ osPageCacheBusyTimeOutMills æ—¶ï¼Œå‚æ•°é»˜è®¤ä¸º 1000msï¼Œè¿”å›æµæ§</li>
<li>å¦‚æœå¼€å¯ transientStorePoolEnable == trueï¼Œä¸” Broker ä¸ºå¼‚æ­¥åˆ·ç›˜çš„ä¸»æœºï¼Œä¸” transientStorePool ä¸­èµ„æºä¸è¶³ï¼Œæ‹’ç»å½“å‰ send è¯·æ±‚ï¼Œè¿”å›æµæ§</li>
<li>Broker æ¯éš” 10ms æ£€æŸ¥ send è¯·æ±‚é˜Ÿåˆ—å¤´éƒ¨è¯·æ±‚çš„ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ waitTimeMillsInSendQueueï¼Œé»˜è®¤ 200msï¼Œæ‹’ç»å½“å‰ send è¯·æ±‚ï¼Œè¿”å›æµæ§ã€‚</li>
<li>Broker é€šè¿‡æ‹’ç» send è¯·æ±‚æ–¹å¼å®ç°æµé‡æ§åˆ¶</li>
</ul>
<p>æ³¨æ„ï¼šç”Ÿäº§è€…æµæ§ï¼Œä¸ä¼šå°è¯•æ¶ˆæ¯é‡æŠ•</p>
<p>æ¶ˆè´¹è€…æµæ§ï¼š</p>
<ul>
<li>æ¶ˆè´¹è€…æœ¬åœ°ç¼“å­˜æ¶ˆæ¯æ•°è¶…è¿‡ pullThresholdForQueue æ—¶ï¼Œé»˜è®¤ 1000</li>
<li>æ¶ˆè´¹è€…æœ¬åœ°ç¼“å­˜æ¶ˆæ¯å¤§å°è¶…è¿‡ pullThresholdSizeForQueue æ—¶ï¼Œé»˜è®¤ 100MB</li>
<li>æ¶ˆè´¹è€…æœ¬åœ°ç¼“å­˜æ¶ˆæ¯è·¨åº¦è¶…è¿‡ consumeConcurrentlyMaxSpan æ—¶ï¼Œé»˜è®¤ 2000</li>
</ul>
<p>æ¶ˆè´¹è€…æµæ§çš„ç»“æœæ˜¯é™ä½æ‹‰å–é¢‘ç‡</p>
<hr>
<h2 id="åŸç†è§£æ-4"><a href="#åŸç†è§£æ-4" class="headerlink" title="åŸç†è§£æ"></a>åŸç†è§£æ</h2><h3 id="Namesrv"><a href="#Namesrv" class="headerlink" title="Namesrv"></a>Namesrv</h3><h4 id="æœåŠ¡å¯åŠ¨"><a href="#æœåŠ¡å¯åŠ¨" class="headerlink" title="æœåŠ¡å¯åŠ¨"></a>æœåŠ¡å¯åŠ¨</h4><h5 id="å¯åŠ¨æ–¹æ³•"><a href="#å¯åŠ¨æ–¹æ³•" class="headerlink" title="å¯åŠ¨æ–¹æ³•"></a>å¯åŠ¨æ–¹æ³•</h5><p>NamesrvStartup ç±»ä¸­æœ‰ Namesrv æœåŠ¡çš„å¯åŠ¨æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå¯åŠ¨æ—¶ ä½¿ç”¨ -c  -p  è®¾ç½®å‚æ•°äº†ï¼Œè¿™äº›å‚æ•°å­˜å‚¨åœ¨ args ä¸­</span></span><br><span class="line">    main0(args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> NamesrvController <span class="title function_">main0</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»º namesrv æ§åˆ¶å™¨ï¼Œç”¨æ¥åˆå§‹åŒ– namesrv å¯åŠ¨ namesrv å…³é—­ namesrv</span></span><br><span class="line">        <span class="type">NamesrvController</span> <span class="variable">controller</span> <span class="operator">=</span> createNamesrvController(args);</span><br><span class="line">		<span class="comment">// å¯åŠ¨ controller</span></span><br><span class="line">        start(controller);</span><br><span class="line">        <span class="keyword">return</span> controller;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="comment">// å‡ºç°å¼‚å¸¸ï¼Œåœæ­¢ç³»ç»Ÿ</span></span><br><span class="line">        System.exit(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NamesrvStartup#createNamesrvControllerï¼šè¯»å–é…ç½®ä¿¡æ¯ï¼Œåˆå§‹åŒ– Namesrv æ§åˆ¶å™¨</p>
<ul>
<li><p><code>ServerUtil.parseCmdLine(&quot;mqnamesrv&quot;, args, buildCommandlineOptions(options)ï¼Œ..)</code>ï¼šè§£æå¯åŠ¨æ—¶çš„å‚æ•°ä¿¡æ¯</p>
</li>
<li><p><code>namesrvConfig = new NamesrvConfig()</code>ï¼šåˆ›å»º Namesrv é…ç½®å¯¹è±¡</p>
<ul>
<li><code>private String rocketmqHome</code>ï¼šè·å– ROCKETMQ_HOME å€¼</li>
<li><code>private boolean orderMessageEnable = false</code>ï¼š<strong>é¡ºåºæ¶ˆæ¯</strong>åŠŸèƒ½æ˜¯å¦å¼€å¯</li>
</ul>
</li>
<li><p><code>nettyServerConfig = new NettyServerConfig()</code>ï¼šNetty çš„æœåŠ¡å™¨é…ç½®å¯¹è±¡</p>
</li>
<li><p><code>nettyServerConfig.setListenPort(9876)</code>ï¼šNamesrv æœåŠ¡å™¨çš„<strong>ç›‘å¬ç«¯å£è®¾ç½®ä¸º 9876</strong></p>
</li>
<li><p><code>if (commandLine.hasOption(&#39;c&#39;))</code>ï¼šè¯»å–å‘½ä»¤è¡Œ -c çš„å‚æ•°å€¼</p>
<p><code>in = new BufferedInputStream(new FileInputStream(file))</code>ï¼šè¯»å–æŒ‡å®šç›®å½•çš„é…ç½®æ–‡ä»¶</p>
<p><code>properties.load(in)</code>ï¼šå°†é…ç½®æ–‡ä»¶ä¿¡æ¯åŠ è½½åˆ° properties å¯¹è±¡ï¼Œç›¸å…³å±æ€§ä¼šå¤å†™åˆ° Namesrv é…ç½®å’Œ Netty é…ç½®å¯¹è±¡</p>
<p><code>namesrvConfig.setConfigStorePath(file)</code>ï¼šå°†é…ç½®æ–‡ä»¶çš„è·¯å¾„ä¿å­˜åˆ°é…ç½®ä¿å­˜å­—æ®µ</p>
</li>
<li><p><code>if (null == namesrvConfig.getRocketmqHome())</code>ï¼šæ£€æŸ¥ ROCKETMQ_HOME é…ç½®æ˜¯å¦æ˜¯ç©ºï¼Œæ˜¯ç©ºå°±æŠ¥é”™</p>
</li>
<li><p><code>lc = (LoggerContext) LoggerFactory.getILoggerFactory()</code>ï¼šåˆ›å»ºæ—¥å¿—å¯¹è±¡</p>
</li>
<li><p><code>controller = new NamesrvController(namesrvConfig, nettyServerConfig)</code>ï¼š<strong>åˆ›å»º Namesrv æ§åˆ¶å™¨</strong></p>
</li>
</ul>
<p>NamesrvStartup#startï¼šå¯åŠ¨ Namesrv æ§åˆ¶å™¨</p>
<ul>
<li><p><code>boolean initResult = controller.initialize()</code>ï¼šåˆå§‹åŒ–æ–¹æ³•</p>
</li>
<li><p><code>Runtime.getRuntime().addShutdownHook(new ShutdownHookThread())</code>ï¼šJVM HOOK å¹³æ»‘å…³é—­çš„é€»è¾‘ï¼Œ å½“ JVM è¢«å…³é—­æ—¶ï¼Œä¸»åŠ¨è°ƒç”¨ controller.shutdown() æ–¹æ³•ï¼Œè®©æœåŠ¡å™¨å¹³æ»‘å…³æœº</p>
</li>
<li><code>controller.start()</code>ï¼šå¯åŠ¨æœåŠ¡å™¨</li>
</ul>
<p>æºç è§£æå‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://space.bilibili.com/457326371">https://space.bilibili.com/457326371</a></p>
<hr>
<h5 id="æ§åˆ¶å™¨ç±»"><a href="#æ§åˆ¶å™¨ç±»" class="headerlink" title="æ§åˆ¶å™¨ç±»"></a>æ§åˆ¶å™¨ç±»</h5><p>NamesrvController ç”¨æ¥åˆå§‹åŒ–å’Œå¯åŠ¨ Namesrv æœåŠ¡å™¨</p>
<ul>
<li><p>æˆå‘˜å˜é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduledExecutorService;	<span class="comment">// è°ƒåº¦çº¿ç¨‹æ± ï¼Œç”¨æ¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RouteInfoManager routeInfoManager;					<span class="comment">// ç®¡ç†ã€è·¯ç”±ä¿¡æ¯ã€‘çš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> RemotingServer remotingServer;								<span class="comment">// ã€ç½‘ç»œå±‚ã€‘å°è£…å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> BrokerHousekeepingService brokerHousekeepingService;		<span class="comment">// ç”¨äºç›‘å¬ channel çŠ¶æ€</span></span><br></pre></td></tr></table></figure>
<p><code>private ExecutorService remotingExecutor</code>ï¼šä¸šåŠ¡çº¿ç¨‹æ± ï¼Œ<strong>netty çº¿ç¨‹è§£ææŠ¥æ–‡æˆ RemotingCommand å¯¹è±¡ï¼Œç„¶åå°†è¯¥å¯¹è±¡äº¤ç»™ä¸šåŠ¡çº¿ç¨‹æ± å†ç»§ç»­å¤„ç†</strong></p>
</li>
<li><p>åˆå§‹åŒ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">initialize</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// åŠ è½½æœ¬åœ°kvé…ç½®ï¼ˆæˆ‘è¿˜ä¸æ˜ç™½ kv é…ç½®æ˜¯å•¥ï¼‰</span></span><br><span class="line">    <span class="built_in">this</span>.kvConfigManager.load();</span><br><span class="line">    <span class="comment">// åˆ›å»ºç½‘ç»œæœåŠ¡å™¨å¯¹è±¡ï¼Œã€å°† netty çš„é…ç½®å’Œç›‘å¬å™¨ä¼ å…¥ã€‘</span></span><br><span class="line">    <span class="comment">// ç›‘å¬å™¨ç›‘å¬ channel çŠ¶æ€çš„æ”¹å˜ï¼Œä¼šå‘äº‹ä»¶é˜Ÿåˆ—å‘èµ·äº‹ä»¶ï¼Œæœ€åäº¤ç”± service å¤„ç†</span></span><br><span class="line">    <span class="built_in">this</span>.remotingServer = <span class="keyword">new</span> <span class="title class_">NettyRemotingServer</span>(<span class="built_in">this</span>.nettyServerConfig, <span class="built_in">this</span>.brokerHousekeepingService);</span><br><span class="line">    <span class="comment">// ã€åˆ›å»ºä¸šåŠ¡çº¿ç¨‹æ± ï¼Œé»˜è®¤çº¿ç¨‹æ•° 8ã€‘</span></span><br><span class="line">    <span class="built_in">this</span>.remotingExecutor = Executors.newFixedThreadPool(nettyServerConfig.getServerWorkerThreads().);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œåè®®å¤„ç†å™¨ï¼ˆç¼ºçœåè®®å¤„ç†å™¨ï¼‰ï¼Œã€å¤„ç†å™¨æ˜¯ DefaultRequestProcessorã€‘ï¼Œçº¿ç¨‹ä½¿ç”¨çš„æ˜¯åˆšåˆ›å»ºçš„ä¸šåŠ¡çš„çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="built_in">this</span>.registerProcessor();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šæ—¶ä»»åŠ¡1ï¼šæ¯ 10 ç§’é’Ÿæ£€æŸ¥ broker å­˜æ´»çŠ¶æ€ï¼Œå°† IDLE çŠ¶æ€çš„ broker ç§»é™¤ã€æ‰«ææœºåˆ¶ï¼Œå¿ƒè·³æ£€æµ‹ã€‘</span></span><br><span class="line">    <span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// æ‰«æ brokerLiveTable è¡¨ï¼Œå°†ä¸¤å°æ—¶æ²¡æœ‰æ´»åŠ¨çš„ broker å…³é—­ï¼Œ</span></span><br><span class="line">            <span class="comment">// é€šè¿‡ next.getKey() è·å– broker çš„åœ°å€ï¼Œç„¶åã€å…³é—­æœåŠ¡å™¨ä¸brokerç‰©ç†èŠ‚ç‚¹çš„ channelã€‘</span></span><br><span class="line">            NamesrvController.<span class="built_in">this</span>.routeInfoManager.scanNotActiveBroker();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">5</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šæ—¶ä»»åŠ¡2ï¼šæ¯ 10 åˆ†é’Ÿæ‰“å°ä¸€é kv é…ç½®ã€‚</span></span><br><span class="line">    <span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            NamesrvController.<span class="built_in">this</span>.kvConfigManager.printAllPeriodically();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1</span>, <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨ç½‘ç»œå±‚å¯åŠ¨ã€‚</span></span><br><span class="line">    <span class="built_in">this</span>.remotingServer.start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.fileWatchService != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.fileWatchService.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="ç½‘ç»œé€šä¿¡"><a href="#ç½‘ç»œé€šä¿¡" class="headerlink" title="ç½‘ç»œé€šä¿¡"></a>ç½‘ç»œé€šä¿¡</h4><h5 id="é€šä¿¡åŸç†"><a href="#é€šä¿¡åŸç†" class="headerlink" title="é€šä¿¡åŸç†"></a>é€šä¿¡åŸç†</h5><p>RocketMQ çš„ RPC é€šä¿¡é‡‡ç”¨ Netty ç»„ä»¶ä½œä¸ºåº•å±‚é€šä¿¡åº“ï¼ŒåŒæ ·ä¹Ÿéµå¾ªäº† Reactor å¤šçº¿ç¨‹æ¨¡å‹ï¼ŒNettyRemotingServer ç±»è´Ÿè´£æ¡†æ¶çš„é€šä¿¡æœåŠ¡ï¼ŒåŒæ—¶åˆåœ¨è¿™ä¹‹ä¸Šåšäº†ä¸€äº›æ‰©å±•å’Œä¼˜åŒ–</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-Reactorè®¾è®¡.png" alt=""></p>
<p>RocketMQ åŸºäº NettyRemotingServer çš„ Reactor å¤šçº¿ç¨‹æ¨¡å‹ï¼š</p>
<ul>
<li><p>ä¸€ä¸ª Reactor ä¸»çº¿ç¨‹ï¼ˆeventLoopGroupBossï¼‰è´Ÿè´£ç›‘å¬ TCP ç½‘ç»œè¿æ¥è¯·æ±‚ï¼Œå»ºç«‹å¥½è¿æ¥åˆ›å»º SocketChannelï¼ˆRocketMQ ä¼šè‡ªåŠ¨æ ¹æ® OS çš„ç±»å‹é€‰æ‹© NIO å’Œ Epollï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‚æ•°é…ç½®ï¼‰ï¼Œå¹¶æ³¨å†Œåˆ° Selector ä¸Šï¼Œç„¶åç›‘å¬çœŸæ­£çš„ç½‘ç»œæ•°æ®</p>
</li>
<li><p>æ‹¿åˆ°ç½‘ç»œæ•°æ®äº¤ç»™ Worker çº¿ç¨‹æ± ï¼ˆeventLoopGroupSelectorï¼Œé»˜è®¤è®¾ç½®ä¸º 3ï¼‰ï¼Œåœ¨çœŸæ­£æ‰§è¡Œä¸šåŠ¡é€»è¾‘ä¹‹å‰éœ€è¦è¿›è¡Œ SSL éªŒè¯ã€ç¼–è§£ç ã€ç©ºé—²æ£€æŸ¥ã€ç½‘ç»œè¿æ¥ç®¡ç†ï¼Œè¿™äº›å·¥ä½œäº¤ç»™ defaultEventExecutorGroupï¼ˆé»˜è®¤è®¾ç½®ä¸º 8ï¼‰å»åš</p>
</li>
<li>å¤„ç†ä¸šåŠ¡æ“ä½œæ”¾åœ¨ä¸šåŠ¡çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œæ ¹æ® RomotingCommand çš„<strong>ä¸šåŠ¡è¯·æ±‚ç  code</strong> å» processorTable è¿™ä¸ªæœ¬åœ°ç¼“å­˜å˜é‡ä¸­æ‰¾åˆ°å¯¹åº”çš„ processorï¼Œå°è£…æˆ task ä»»åŠ¡æäº¤ç»™å¯¹åº”çš„ processor å¤„ç†çº¿ç¨‹æ± æ¥æ‰§è¡Œï¼ˆsendMessageExecutorï¼Œä»¥å‘é€æ¶ˆæ¯ä¸ºä¾‹ï¼‰</li>
<li>ä»å…¥å£åˆ°ä¸šåŠ¡é€»è¾‘çš„å‡ ä¸ªæ­¥éª¤ä¸­çº¿ç¨‹æ± ä¸€ç›´å†å¢åŠ ï¼Œè¿™è·Ÿæ¯ä¸€æ­¥é€»è¾‘å¤æ‚æ€§ç›¸å…³ï¼Œè¶Šå¤æ‚ï¼Œéœ€è¦çš„å¹¶å‘é€šé“è¶Šå®½</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>çº¿ç¨‹æ•°</th>
<th>çº¿ç¨‹å</th>
<th>çº¿ç¨‹å…·ä½“è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>NettyBoss_%d</td>
<td>Reactor ä¸»çº¿ç¨‹</td>
</tr>
<tr>
<td>N</td>
<td>NettyServerEPOLLSelector<em>%d</em>%d</td>
<td>Reactor çº¿ç¨‹æ± </td>
</tr>
<tr>
<td>M1</td>
<td>NettyServerCodecThread_%d</td>
<td>Worker çº¿ç¨‹æ± </td>
</tr>
<tr>
<td>M2</td>
<td>RemotingExecutorThread_%d</td>
<td>ä¸šåŠ¡ processor å¤„ç†çº¿ç¨‹æ± </td>
</tr>
</tbody>
</table>
</div>
<p>RocketMQ çš„å¼‚æ­¥é€šä¿¡æµç¨‹ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-å¼‚æ­¥é€šä¿¡æµç¨‹.png" alt=""></p>
<p>==todoï¼šåæœŸå¯¹ Netty æœ‰äº†æ›´æ·±çš„è®¤çŸ¥åä¼šè¿›è¡Œæ‰©å……ï¼Œç°åœ¨æš‚æ—¶ copy å®˜æ–¹æ–‡æ¡£==</p>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq/blob/master/docs/cn/design.md#2-%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6">https://github.com/apache/rocketmq/blob/master/docs/cn/design.md#2-%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6</a></p>
<hr>
<h5 id="æˆå‘˜å±æ€§"><a href="#æˆå‘˜å±æ€§" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>NettyRemotingServer ç±»æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>æœåŠ¡å™¨ç›¸å…³å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ServerBootstrap serverBootstrap;				<span class="comment">// netty æœåŠ¡ç«¯å¯åŠ¨å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> EventLoopGroup eventLoopGroupSelector;		<span class="comment">// netty worker ç»„çº¿ç¨‹æ± ï¼Œã€é»˜è®¤ 3 ä¸ªçº¿ç¨‹ã€‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> EventLoopGroup eventLoopGroupBoss;			<span class="comment">// netty boss ç»„çº¿ç¨‹æ± ï¼Œã€ä¸€èˆ¬æ˜¯ 1 ä¸ªçº¿ç¨‹ã€‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> NettyServerConfig nettyServerConfig;			<span class="comment">// netty æœåŠ¡ç«¯ç½‘ç»œé…ç½®</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">0</span>;										<span class="comment">// æœåŠ¡å™¨ç»‘å®šçš„ç«¯å£</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å…¬å…±çº¿ç¨‹æ± ï¼šæ³¨å†Œå¤„ç†å™¨æ—¶å¦‚æœæœªæŒ‡å®šçº¿ç¨‹æ± ï¼Œåˆ™ä¸šåŠ¡å¤„ç†ä½¿ç”¨å…¬å…±çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ•°é‡é»˜è®¤æ˜¯ 4 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExecutorService publicExecutor;</span><br></pre></td></tr></table></figure>
</li>
<li><p>äº‹ä»¶ç›‘å¬å™¨ï¼šNameserver ä½¿ç”¨ BrokerHouseKeepingServiceï¼ŒBroker ä½¿ç”¨ ClientHouseKeepingService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelEventListener channelEventListener;</span><br></pre></td></tr></table></figure>
</li>
<li><p>äº‹ä»¶å¤„ç†çº¿ç¨‹æ± ï¼šé»˜è®¤æ˜¯ 8</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> DefaultEventExecutorGroup defaultEventExecutorGroup;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®šæ—¶å™¨ï¼šæ‰§è¡Œå¾ªç¯ä»»åŠ¡ï¼Œå¹¶ä¸”å°†å®šæ—¶å™¨çº¿ç¨‹è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>(<span class="string">&quot;ServerHouseKeepingService&quot;</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¤„ç†å™¨ï¼šå¤šä¸ª Channel å…±äº«çš„å¤„ç†å™¨ Handlerï¼Œå¤šä¸ªé€šé“ä½¿ç”¨åŒä¸€ä¸ªå¯¹è±¡</p>
</li>
<li><p>Netty é…ç½®å¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyServerConfig</span> <span class="keyword">implements</span> <span class="title class_">Cloneable</span> &#123;</span><br><span class="line">    <span class="comment">// æœåŠ¡ç«¯å¯åŠ¨æ—¶ç›‘å¬çš„ç«¯å£å·</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">listenPort</span> <span class="operator">=</span> <span class="number">8888</span>;</span><br><span class="line">    <span class="comment">// ã€ä¸šåŠ¡çº¿ç¨‹æ± ã€‘ çº¿ç¨‹æ•°é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">serverWorkerThreads</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line">    <span class="comment">// æ ¹æ®è¯¥å€¼åˆ›å»º remotingServer å†…éƒ¨çš„ä¸€ä¸ª publicExecutor</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">serverCallbackExecutorThreads</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// netty ã€workerã€‘çº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">serverSelectorThreads</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">    <span class="comment">// ã€å•å‘è®¿é—®ã€‘æ—¶çš„å¹¶å‘é™åˆ¶</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">serverOnewaySemaphoreValue</span> <span class="operator">=</span> <span class="number">256</span>;</span><br><span class="line">    <span class="comment">// ã€å¼‚æ­¥è®¿é—®ã€‘æ—¶çš„å¹¶å‘é™åˆ¶</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">serverAsyncSemaphoreValue</span> <span class="operator">=</span> <span class="number">64</span>;</span><br><span class="line">    <span class="comment">// channel æœ€å¤§çš„ç©ºé—²å­˜æ´»æ—¶é—´ é»˜è®¤æ˜¯ 2min</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">serverChannelMaxIdleTimeSeconds</span> <span class="operator">=</span> <span class="number">120</span>;</span><br><span class="line">    <span class="comment">// å‘é€ç¼“å†²åŒºå¤§å° 65535</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">serverSocketSndBufSize</span> <span class="operator">=</span> NettySystemConfig.socketSndbufSize;</span><br><span class="line">    <span class="comment">// æ¥æ”¶ç¼“å†²åŒºå¤§å° 65535</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">serverSocketRcvBufSize</span> <span class="operator">=</span> NettySystemConfig.socketRcvbufSize;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å¯ç”¨ netty å†…å­˜æ±  é»˜è®¤å¼€å¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">serverPooledByteBufAllocatorEnable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é»˜è®¤ linux ä¼šå¯ç”¨ ã€epollã€‘</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">useEpollNativeSelector</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<ul>
<li><p>æ— ç›‘å¬å™¨æ„é€ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">NettyRemotingServer</span><span class="params">(<span class="keyword">final</span> NettyServerConfig nettyServerConfig)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(nettyServerConfig, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æœ‰å‚æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">NettyRemotingServer</span><span class="params">(<span class="keyword">final</span> NettyServerConfig nettyServerConfig,</span></span><br><span class="line"><span class="params">                           <span class="keyword">final</span> ChannelEventListener channelEventListener)</span> &#123;</span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·è¯·æ±‚æ—¶å¹¶å‘é™åˆ¶ã€‚ã€å•å‘è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚ã€‘çš„å¹¶å‘é™åˆ¶</span></span><br><span class="line">    <span class="built_in">super</span>(nettyServerConfig.getServerOnewaySemaphoreValue(), nettyServerConfig.getServerAsyncSemaphoreValue());</span><br><span class="line">	<span class="comment">// Netty çš„å¯åŠ¨å™¨ï¼Œè´Ÿè´£ç»„è£… netty ç»„ä»¶</span></span><br><span class="line">    <span class="built_in">this</span>.serverBootstrap = <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">    <span class="comment">// æˆå‘˜å˜é‡çš„èµ‹å€¼</span></span><br><span class="line">    <span class="built_in">this</span>.nettyServerConfig = nettyServerConfig;</span><br><span class="line">    <span class="built_in">this</span>.channelEventListener = channelEventListener;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¬å…±çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ï¼Œé»˜è®¤ç»™çš„0ï¼Œè¿™é‡Œæœ€ç»ˆä¿®æ”¹ä¸º4.</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">publicThreadNums</span> <span class="operator">=</span> nettyServerConfig.getServerCallbackExecutorThreads();</span><br><span class="line">    <span class="keyword">if</span> (publicThreadNums &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        publicThreadNums = <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå…¬å…±çº¿ç¨‹æ± ï¼ŒæŒ‡å®šçº¿ç¨‹å·¥å‚ï¼Œè®¾ç½®çº¿ç¨‹åç§°å‰ç¼€ï¼šNettyServerPublicExecutor_[æ•°å­—]</span></span><br><span class="line">    <span class="built_in">this</span>.publicExecutor = Executors.newFixedThreadPool(publicThreadNums, <span class="keyword">new</span> <span class="title class_">ThreadFactory</span>()&#123;.&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸¤ä¸ª netty çš„çº¿ç¨‹ç»„ï¼Œä¸€ä¸ªæ˜¯bossç»„ï¼Œä¸€ä¸ªæ˜¯workerç»„ï¼Œã€linux ç³»ç»Ÿé»˜è®¤å¯ç”¨ epollã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (useEpoll()) &#123;...&#125; <span class="keyword">else</span> &#123;...&#125;</span><br><span class="line">	<span class="comment">// SSL ç›¸å…³</span></span><br><span class="line">    loadSslContext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="å¯åŠ¨æ–¹æ³•-1"><a href="#å¯åŠ¨æ–¹æ³•-1" class="headerlink" title="å¯åŠ¨æ–¹æ³•"></a>å¯åŠ¨æ–¹æ³•</h5><p>æ ¸å¿ƒæ–¹æ³•çš„è§£æï¼š</p>
<ul>
<li><p>start()ï¼šå¯åŠ¨æ–¹æ³•ï¼Œ<strong>åˆ›å»º BootStrapï¼Œå¹¶æ·»åŠ  NettyServerHandler å¤„ç†å™¨</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Channel Pipeline å†…çš„ handler ä½¿ç”¨çš„çº¿ç¨‹èµ„æºï¼Œã€çº¿ç¨‹åˆ†é…ç»™ handler å¤„ç†äº‹ä»¶ã€‘</span></span><br><span class="line">    <span class="built_in">this</span>.defaultEventExecutorGroup = <span class="keyword">new</span> <span class="title class_">DefaultEventExecutorGroup</span>(...);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºé€šç”¨å…±äº«çš„å¤„ç†å™¨ handlerï¼Œã€éå¸¸é‡è¦çš„ NettyServerHandlerã€‘</span></span><br><span class="line">    prepareSharableHandlers();</span><br><span class="line"></span><br><span class="line">    <span class="type">ServerBootstrap</span> <span class="variable">childHandler</span> <span class="operator">=</span></span><br><span class="line">        <span class="comment">// é…ç½®å·¥ä½œç»„ bossï¼ˆæ•°é‡1ï¼‰ å’Œ workerï¼ˆæ•°é‡3ï¼‰ ç»„</span></span><br><span class="line">        <span class="built_in">this</span>.serverBootstrap.group(<span class="built_in">this</span>.eventLoopGroupBoss, <span class="built_in">this</span>.eventLoopGroupSelector)</span><br><span class="line">        <span class="comment">// è®¾ç½®æœåŠ¡ç«¯ ServerSocketChannel ç±»å‹ï¼Œ Linux ç”¨ epoll</span></span><br><span class="line">        .channel(useEpoll() ? EpollServerSocketChannel.class : NioServerSocketChannel.class)</span><br><span class="line">        <span class="comment">// è®¾ç½®æœåŠ¡ç«¯ channel é€‰é¡¹</span></span><br><span class="line">        .option(ChannelOption.SO_BACKLOG, <span class="number">1024</span>)</span><br><span class="line">        <span class="comment">// å®¢æˆ·ç«¯ channel é€‰é¡¹</span></span><br><span class="line">        .childOption(ChannelOption.TCP_NODELAY, <span class="literal">true</span>)</span><br><span class="line">        <span class="comment">// è®¾ç½®æœåŠ¡å™¨ç«¯å£</span></span><br><span class="line">        .localAddress(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="built_in">this</span>.nettyServerConfig.getListenPort()))</span><br><span class="line">        <span class="comment">// å‘ channel pipeline æ·»åŠ äº†å¾ˆå¤š handlerï¼Œã€åŒ…æ‹¬ NettyServerHandlerã€‘</span></span><br><span class="line">        .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;&#125;);</span><br><span class="line">            </span><br><span class="line">	<span class="comment">// å®¢æˆ·ç«¯å¼€å¯ å†…å­˜æ± ï¼Œä½¿ç”¨çš„å†…å­˜æ± æ˜¯  PooledByteBufAllocator.DEFAULT</span></span><br><span class="line">    <span class="keyword">if</span> (nettyServerConfig.isServerPooledByteBufAllocatorEnable()) &#123;</span><br><span class="line">        childHandler.childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥ç­‰å¾…å»ºç«‹è¿æ¥ï¼Œå¹¶ç»‘å®šç«¯å£ã€‚</span></span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">sync</span> <span class="operator">=</span> <span class="built_in">this</span>.serverBootstrap.bind().sync();</span><br><span class="line">        <span class="type">InetSocketAddress</span> <span class="variable">addr</span> <span class="operator">=</span> (InetSocketAddress) sync.channel().localAddress();</span><br><span class="line">        <span class="comment">// å°†æœåŠ¡å™¨æˆåŠŸç»‘å®šçš„ç«¯å£å·èµ‹å€¼ç»™å­—æ®µ portã€‚</span></span><br><span class="line">        <span class="built_in">this</span>.port = addr.getPort();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// housekeepingService ä¸ä¸ºç©ºï¼Œåˆ™åˆ›å»ºã€ç½‘ç»œå¼‚å¸¸äº‹ä»¶å¤„ç†å™¨ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.channelEventListener != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// çº¿ç¨‹ä¸€ç›´è½®è¯¢ nettyEvent çŠ¶æ€ï¼Œæ ¹æ® CONNECT,CLOSE,IDLE,EXCEPTION å››ç§äº‹ä»¶ç±»å‹</span></span><br><span class="line">        <span class="comment">// CONNECT ä¸åšæ“ä½œï¼Œå…¶ä½™éƒ½æ˜¯å›è°ƒ onChannelDestroy ã€å…³é—­æœåŠ¡å™¨ä¸ Broker ç‰©ç†èŠ‚ç‚¹çš„ Channelã€‘</span></span><br><span class="line">        <span class="built_in">this</span>.nettyEventExecutor.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æäº¤å®šæ—¶ä»»åŠ¡ï¼Œæ¯ä¸€ç§’ æ‰§è¡Œä¸€æ¬¡ã€‚æ‰«æ responseTable è¡¨ï¼Œå°†è¿‡æœŸçš„æ•°æ®ç§»é™¤</span></span><br><span class="line">    <span class="built_in">this</span>.timer.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">       		NettyRemotingServer.<span class="built_in">this</span>.scanResponseTable();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span> * <span class="number">3</span>, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>registerProcessor()ï¼šæ³¨å†Œä¸šåŠ¡å¤„ç†å™¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerProcessor</span><span class="params">(<span class="type">int</span> requestCode, NettyRequestProcessor processor, ExecutorService executor)</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorThis</span> <span class="operator">=</span> executor;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == executor) &#123;</span><br><span class="line">        <span class="comment">// æœªæŒ‡å®šçº¿ç¨‹æ± èµ„æºï¼Œå°†å…¬å…±çº¿ç¨‹æ± èµ‹å€¼</span></span><br><span class="line">        executorThis = <span class="built_in">this</span>.publicExecutor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// pair å¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨çš„æ˜¯å¤„ç†å™¨ï¼Œ ç¬¬äºŒä¸ªå‚æ•°æ˜¯çº¿ç¨‹æ± ï¼Œé»˜è®¤æ˜¯å…¬å…±çš„çº¿ç¨‹æ± </span></span><br><span class="line">    Pair&lt;NettyRequestProcessor, ExecutorService&gt; pair = <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;NettyRequestProcessor, ExecutorService&gt;(processor, executorThis);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// key æ˜¯è¯·æ±‚ç ï¼Œvalue æ˜¯ Pair å¯¹è±¡</span></span><br><span class="line">    <span class="built_in">this</span>.processorTable.put(requestCode, pair);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>getProcessorPair()ï¼š<strong>æ ¹æ®è¯·æ±‚ç è·å–å¯¹åº”çš„å¤„ç†å™¨å’Œçº¿ç¨‹æ± èµ„æº</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Pair&lt;NettyRequestProcessor, ExecutorService&gt; <span class="title function_">getProcessorPair</span><span class="params">(<span class="type">int</span> requestCode)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> processorTable.get(requestCode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="è¯·æ±‚æ–¹æ³•"><a href="#è¯·æ±‚æ–¹æ³•" class="headerlink" title="è¯·æ±‚æ–¹æ³•"></a>è¯·æ±‚æ–¹æ³•</h5><p>åœ¨ RocketMQ æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ”¯æŒé€šä¿¡çš„æ–¹å¼ä¸»è¦æœ‰åŒæ­¥ï¼ˆsyncï¼‰ã€å¼‚æ­¥ï¼ˆasyncï¼‰ã€å•å‘ï¼ˆonewayï¼‰ä¸‰ç§ï¼Œå…¶ä¸­å•å‘é€šä¿¡æ¨¡å¼ç›¸å¯¹ç®€å•ï¼Œä¸€èˆ¬ç”¨åœ¨å‘é€å¿ƒè·³åŒ…åœºæ™¯ä¸‹ï¼Œæ— éœ€å…³æ³¨å…¶ Response</p>
<p>æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚æ—¶ï¼Œä½¿ç”¨ä¸‰ç§æ–¹æ³•</p>
<ul>
<li>invokeSync()ï¼š åŒæ­¥è°ƒç”¨ï¼Œ<strong>æœåŠ¡å™¨éœ€è¦é˜»å¡ç­‰å¾…è°ƒç”¨çš„è¿”å›ç»“æœ</strong><ul>
<li><code>int opaque = request.getOpaque()</code>ï¼šè·å–è¯·æ±‚ IDï¼ˆä¸è¯·æ±‚ç ä¸åŒï¼‰</li>
<li><code>responseFuture = new ResponseFuture(...)</code>ï¼š<strong>åˆ›å»ºå“åº”å¯¹è±¡</strong>ï¼Œæ²¡æœ‰å›è°ƒå‡½æ•°å’Œ Once</li>
<li><code>this.responseTable.put(opaque, responseFuture)</code>ï¼š<strong>åŠ å…¥åˆ°å“åº”æ˜ å°„è¡¨ä¸­</strong>ï¼Œkey ä¸ºè¯·æ±‚ ID</li>
<li><code>SocketAddress addr = channel.remoteAddress()</code>ï¼šè·å–å®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯</li>
<li><code>channel.writeAndFlush(request).addListener(...)</code>ï¼šå°†<strong>ä¸šåŠ¡ Command ä¿¡æ¯</strong>å†™å…¥é€šé“ï¼Œä¸šåŠ¡çº¿ç¨‹å°†æ•°æ®äº¤ç»™ Netty ï¼ŒNetty çš„ IO çº¿ç¨‹æ¥ç®¡å†™åˆ·æ•°æ®çš„æ“ä½œï¼Œ<strong>ç›‘å¬å™¨ç”± IO çº¿ç¨‹åœ¨å†™åˆ·åå›è°ƒ</strong><ul>
<li><code>if (f.isSuccess())</code>ï¼šå†™å…¥æˆåŠŸä¼šå°†å“åº”å¯¹è±¡è®¾ç½®ä¸ºæˆåŠŸçŠ¶æ€ç›´æ¥ returnï¼Œå†™å…¥å¤±è´¥è®¾ç½®ä¸ºå¤±è´¥çŠ¶æ€</li>
<li><code>responseTable.remove(opaque)</code>ï¼šå°†å½“å‰è¯·æ±‚çš„ responseFuture <strong>ä»æ˜ å°„è¡¨ç§»é™¤</strong></li>
<li><code>responseFuture.setCause(f.cause())</code>ï¼šè®¾ç½®é”™è¯¯çš„ä¿¡æ¯</li>
<li><code>responseFuture.putResponse(null)</code>ï¼šå“åº” Command è®¾ç½®ä¸º null</li>
</ul>
</li>
<li><code>responseCommand = responseFuture.waitResponse(timeoutMillis)</code>ï¼šå½“å‰çº¿ç¨‹è®¾ç½®è¶…æ—¶æ—¶é—´æŒ‚èµ·ï¼Œ<strong>åŒæ­¥ç­‰å¾…å“åº”</strong></li>
<li><code>if (null == responseCommand)</code>ï¼šè¶…æ—¶æˆ–è€…å‡ºç°å¼‚å¸¸ï¼Œç›´æ¥æŠ¥é”™</li>
<li><code>return responseCommand</code>ï¼šè¿”å›å“åº” Command ä¿¡æ¯</li>
</ul>
</li>
<li><p>invokeAsync()ï¼šå¼‚æ­¥è°ƒç”¨ï¼Œæœ‰å›è°ƒå¯¹è±¡ï¼Œæ— è¿”å›å€¼</p>
<ul>
<li><code>boolean acquired = this.semaphoreAsync.tryAcquire(timeoutMillis, TimeUnit.MILLISECONDS)</code>ï¼šè·å–ä¿¡å·é‡çš„è®¸å¯è¯ï¼Œä¿¡å·é‡ç”¨æ¥<strong>é™åˆ¶å¼‚æ­¥è¯·æ±‚</strong>çš„æ•°é‡</li>
<li><code>if (acquired)</code>ï¼šè®¸å¯è¯è·å–å¤±è´¥è¯´æ˜å¹¶å‘è¾ƒé«˜ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸</li>
<li><code>once = new SemaphoreReleaseOnlyOnce(this.semaphoreAsync)</code>ï¼šOnce å¯¹è±¡å°è£…äº†é‡Šæ”¾ä¿¡å·é‡çš„æ“ä½œ</li>
<li><code>costTime = System.currentTimeMillis() - beginStartTime</code>ï¼šè®¡ç®—ä¸€ä¸‹è€—è´¹çš„æ—¶é—´ï¼Œè¶…æ—¶ä¸å†å‘èµ·è¯·æ±‚</li>
<li><code>responseFuture = new ResponseFuture()</code>ï¼š<strong>åˆ›å»ºå“åº”å¯¹è±¡ï¼ŒåŒ…è£…äº†å›è°ƒå‡½æ•°å’Œ Once å¯¹è±¡</strong></li>
<li><code>this.responseTable.put(opaque, responseFuture)</code>ï¼šåŠ å…¥åˆ°å“åº”æ˜ å°„è¡¨ä¸­ï¼Œkey ä¸ºè¯·æ±‚ ID</li>
<li><code>channel.writeAndFlush(request).addListener(...)</code>ï¼šå†™åˆ·æ•°æ®<ul>
<li><code>if (f.isSuccess())</code>ï¼šå†™åˆ·æˆåŠŸï¼Œè®¾ç½® responseFuture å‘ç”ŸçŠ¶æ€ä¸º true</li>
<li><code>requestFail(opaque)</code>ï¼šå†™å…¥å¤±è´¥ï¼Œä½¿ç”¨ publicExecutor <strong>å…¬å…±çº¿ç¨‹æ± å¼‚æ­¥æ‰§è¡Œå›è°ƒå¯¹è±¡çš„å‡½æ•°</strong></li>
<li><code>responseFuture.release()</code>ï¼šå‡ºç°å¼‚å¸¸ä¼šé‡Šæ”¾ä¿¡å·é‡</li>
</ul>
</li>
</ul>
</li>
<li><p>invokeOneway()ï¼šå•å‘è°ƒç”¨ï¼Œä¸å…³æ³¨å“åº”ç»“æœ</p>
<ul>
<li><code>request.markOnewayRPC()</code>ï¼šè®¾ç½®å•å‘æ ‡è®°ï¼Œå¯¹ç«¯æ£€æŸ¥æ ‡è®°å¯çŸ¥è¯¥è¯·æ˜¯å•å‘è¯·æ±‚</li>
<li><code>boolean acquired = this.semaphoreOneway.tryAcquire(timeoutMillis, TimeUnit.MILLISECONDS)</code>ï¼šè·å–ä¿¡å·é‡çš„è®¸å¯è¯ï¼Œä¿¡å·é‡ç”¨æ¥<strong>é™åˆ¶å•å‘è¯·æ±‚</strong>çš„æ•°é‡</li>
</ul>
</li>
</ul>
<hr>
<h4 id="å¤„ç†å™¨ç±»"><a href="#å¤„ç†å™¨ç±»" class="headerlink" title="å¤„ç†å™¨ç±»"></a>å¤„ç†å™¨ç±»</h4><h5 id="åè®®è®¾è®¡-1"><a href="#åè®®è®¾è®¡-1" class="headerlink" title="åè®®è®¾è®¡"></a>åè®®è®¾è®¡</h5><p>åœ¨ Client å’Œ Server ä¹‹é—´å®Œæˆä¸€æ¬¡æ¶ˆæ¯å‘é€æ—¶ï¼Œéœ€è¦å¯¹å‘é€çš„æ¶ˆæ¯è¿›è¡Œä¸€ä¸ªåè®®çº¦å®šï¼Œæ‰€ä»¥è‡ªå®šä¹‰ RocketMQ çš„æ¶ˆæ¯åè®®ã€‚åœ¨ RocketMQ ä¸­ï¼Œä¸ºäº†é«˜æ•ˆåœ°åœ¨ç½‘ç»œä¸­ä¼ è¾“æ¶ˆæ¯å’Œå¯¹æ”¶åˆ°çš„æ¶ˆæ¯è¯»å–ï¼Œå°±éœ€è¦å¯¹æ¶ˆæ¯è¿›è¡Œç¼–è§£ç ï¼ŒRemotingCommand è¿™ä¸ªç±»åœ¨æ¶ˆæ¯ä¼ è¾“è¿‡ç¨‹ä¸­å¯¹æ‰€æœ‰æ•°æ®å†…å®¹çš„å°è£…ï¼Œä¸ä½†åŒ…å«äº†æ‰€æœ‰çš„æ•°æ®ç»“æ„ï¼Œè¿˜åŒ…å«äº†ç¼–ç è§£ç æ“ä½œ</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Headerå­—æ®µ</th>
<th>ç±»å‹</th>
<th>Request è¯´æ˜</th>
<th>Response è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>code</td>
<td>int</td>
<td>è¯·æ±‚æ“ä½œç ï¼Œåº”ç­”æ–¹æ ¹æ®ä¸åŒçš„è¯·æ±‚ç è¿›è¡Œä¸åŒçš„å¤„ç†</td>
<td>åº”ç­”å“åº”ç ï¼Œ0 è¡¨ç¤ºæˆåŠŸï¼Œé 0 åˆ™è¡¨ç¤ºå„ç§é”™è¯¯</td>
</tr>
<tr>
<td>language</td>
<td>LanguageCode</td>
<td>è¯·æ±‚æ–¹å®ç°çš„è¯­è¨€</td>
<td>åº”ç­”æ–¹å®ç°çš„è¯­è¨€</td>
</tr>
<tr>
<td>version</td>
<td>int</td>
<td>è¯·æ±‚æ–¹ç¨‹åºçš„ç‰ˆæœ¬</td>
<td>åº”ç­”æ–¹ç¨‹åºçš„ç‰ˆæœ¬</td>
</tr>
<tr>
<td>opaque</td>
<td>int</td>
<td>ç›¸å½“äº requestIdï¼Œåœ¨åŒä¸€ä¸ªè¿æ¥ä¸Šçš„ä¸åŒè¯·æ±‚æ ‡è¯†ç ï¼Œä¸å“åº”æ¶ˆæ¯ä¸­çš„ç›¸å¯¹åº”</td>
<td>åº”ç­”ä¸åšä¿®æ”¹ç›´æ¥è¿”å›</td>
</tr>
<tr>
<td>flag</td>
<td>int</td>
<td>åŒºåˆ†æ˜¯æ™®é€š RPC è¿˜æ˜¯ onewayRPC çš„æ ‡å¿—</td>
<td>åŒºåˆ†æ˜¯æ™®é€š RPC è¿˜æ˜¯ onewayRPCçš„æ ‡å¿—</td>
</tr>
<tr>
<td>remark</td>
<td>String</td>
<td>ä¼ è¾“è‡ªå®šä¹‰æ–‡æœ¬ä¿¡æ¯</td>
<td>ä¼ è¾“è‡ªå®šä¹‰æ–‡æœ¬ä¿¡æ¯</td>
</tr>
<tr>
<td>extFields</td>
<td>HashMap<String, String></td>
<td>è¯·æ±‚è‡ªå®šä¹‰æ‰©å±•ä¿¡æ¯</td>
<td>å“åº”è‡ªå®šä¹‰æ‰©å±•ä¿¡æ¯</td>
</tr>
</tbody>
</table>
</div>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-æ¶ˆæ¯åè®®.png" alt=""></p>
<p>ä¼ è¾“å†…å®¹ä¸»è¦å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å››éƒ¨åˆ†ï¼š</p>
<ul>
<li><p>æ¶ˆæ¯é•¿åº¦ï¼šæ€»é•¿åº¦ï¼Œå››ä¸ªå­—èŠ‚å­˜å‚¨ï¼Œå ç”¨ä¸€ä¸ª int ç±»å‹</p>
</li>
<li><p>åºåˆ—åŒ–ç±»å‹&amp;æ¶ˆæ¯å¤´é•¿åº¦ï¼šåŒæ ·å ç”¨ä¸€ä¸ª int ç±»å‹ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºåºåˆ—åŒ–ç±»å‹ï¼Œåé¢ä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºæ¶ˆæ¯å¤´é•¿åº¦</p>
</li>
<li><p>æ¶ˆæ¯å¤´æ•°æ®ï¼šç»è¿‡åºåˆ—åŒ–åçš„æ¶ˆæ¯å¤´æ•°æ®</p>
</li>
<li><p>æ¶ˆæ¯ä¸»ä½“æ•°æ®ï¼šæ¶ˆæ¯ä¸»ä½“çš„äºŒè¿›åˆ¶å­—èŠ‚æ•°æ®å†…å®¹</p>
</li>
</ul>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq/blob/master/docs/cn/design.md">https://github.com/apache/rocketmq/blob/master/docs/cn/design.md</a></p>
<hr>
<h5 id="å¤„ç†æ–¹æ³•"><a href="#å¤„ç†æ–¹æ³•" class="headerlink" title="å¤„ç†æ–¹æ³•"></a>å¤„ç†æ–¹æ³•</h5><p>NettyServerHandler ç±»ç”¨æ¥å¤„ç† Channel ä¸Šçš„äº‹ä»¶ï¼Œåœ¨ NettyRemotingServer å¯åŠ¨æ—¶æ³¨å†Œåˆ° Netty ä¸­ï¼Œå¯ä»¥å¤„ç† RemotingCommand ç›¸å…³çš„æ•°æ®ï¼Œé’ˆå¯¹æŸä¸€ç§ç±»å‹çš„<strong>è¯·æ±‚å¤„ç†</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NettyServerHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;RemotingCommand&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// æœåŠ¡å™¨å¤„ç†æ¥å—åˆ°çš„è¯·æ±‚ä¿¡æ¯</span></span><br><span class="line">        processMessageReceived(ctx, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processMessageReceived</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">RemotingCommand</span> <span class="variable">cmd</span> <span class="operator">=</span> msg;</span><br><span class="line">    <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="comment">// æ ¹æ®è¯·æ±‚çš„ç±»å‹è¿›è¡Œå¤„ç†</span></span><br><span class="line">        <span class="keyword">switch</span> (cmd.getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> REQUEST_COMMAND:<span class="comment">// å®¢æˆ·ç«¯å‘èµ·çš„è¯·æ±‚ï¼Œèµ°è¿™é‡Œ</span></span><br><span class="line">                processRequestCommand(ctx, cmd);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RESPONSE_COMMAND:<span class="comment">// å®¢æˆ·ç«¯å“åº”çš„æ•°æ®ï¼Œèµ°è¿™é‡Œã€å½“å‰ç±»æœ¬èº«æ˜¯æœåŠ¡å™¨ç±»ä¹Ÿæ˜¯å®¢æˆ·ç«¯ç±»ã€‘</span></span><br><span class="line">                processResponseCommand(ctx, cmd);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NettyRemotingAbstract#processRequestCommandï¼š<strong>å¤„ç†è¯·æ±‚çš„æ•°æ®</strong></p>
<ul>
<li><p><code>matched = this.processorTable.get(cmd.getCode())</code>ï¼šæ ¹æ®ä¸šåŠ¡è¯·æ±‚ç è·å– Pair å¯¹è±¡ï¼ŒåŒ…å«<strong>å¤„ç†å™¨å’Œçº¿ç¨‹æ± èµ„æº</strong></p>
</li>
<li><p><code>pair = null == matched ? this.defaultRequestProcessor : matched</code>ï¼šæœªæ‰¾åˆ°å¤„ç†å™¨åˆ™ä½¿ç”¨ç¼ºçœå¤„ç†å™¨</p>
</li>
<li><p><code>int opaque = cmd.getOpaque()</code>ï¼šè·å–è¯·æ±‚ ID</p>
</li>
<li><p><code>Runnable run = new Runnable()</code>ï¼šåˆ›å»ºä»»åŠ¡å¯¹è±¡ï¼Œä»»åŠ¡åœ¨æäº¤åˆ°çº¿ç¨‹æ± åå¼€å§‹æ‰§è¡Œ</p>
<ul>
<li><p><code>doBeforeRpcHooks()</code>ï¼šRPC HOOK å‰ç½®å¤„ç†</p>
</li>
<li><p><code>callback = new RemotingResponseCallback()</code>ï¼š<strong>å°è£…å“åº”å®¢æˆ·ç«¯çš„é€»è¾‘</strong></p>
<ul>
<li><code>doAfterRpcHooks()</code>ï¼šRPC HOOK åç½®å¤„ç†</li>
<li><code>if (!cmd.isOnewayRPC())</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜ä¸æ˜¯å•å‘è¯·æ±‚ï¼Œéœ€è¦ç»“æœ</li>
<li><code>response.setOpaque(opaque)</code>ï¼šå°†è¯·æ±‚ ID è®¾ç½®åˆ° response</li>
<li><code>response.markResponseType()</code>ï¼š<strong>è®¾ç½®å½“å‰è¯·æ±‚æ˜¯å“åº”</strong></li>
<li><code>ctx.writeAndFlush(response)</code>ï¼š <strong>å°†å“åº”æ•°æ®äº¤ç»™ Netty IO çº¿ç¨‹ï¼Œå®Œæˆæ•°æ®å†™å’Œåˆ·</strong></li>
</ul>
</li>
<li><p><code>if (pair.getObject1() instanceof AsyncNettyRequestProcessor)</code>ï¼šNameserver é»˜è®¤ä½¿ç”¨ DefaultRequestProcessor å¤„ç†å™¨ï¼Œæ˜¯ä¸€ä¸ª AsyncNettyRequestProcessor å­ç±»</p>
</li>
<li><p><code>processor = (AsyncNettyRequestProcessor)pair.getObject1()</code>ï¼šè·å–å¤„ç†å™¨</p>
</li>
<li><p><code>processor.asyncProcessRequest(ctx, cmd, callback)</code>ï¼šå¼‚æ­¥è°ƒç”¨ï¼Œé¦–å…ˆ processRequestï¼Œç„¶å callback å“åº”å®¢æˆ·ç«¯</p>
<p><code>DefaultRequestProcessor.processRequest</code>ï¼š<strong>æ ¹æ®ä¸šåŠ¡ç å¤„ç†è¯·æ±‚ï¼Œæ‰§è¡Œå¯¹åº”çš„æ“ä½œ</strong></p>
<p><code>ClientRemotingProcessor.processRequest</code>ï¼šå¤„ç†äº‹åŠ¡å›æŸ¥æ¶ˆæ¯ï¼Œæˆ–è€…å›æ‰§æ¶ˆæ¯ï¼Œéœ€è¦æ¶ˆè´¹è€…å›æ‰§ä¸€æ¡æ¶ˆæ¯ç»™ç”Ÿäº§è€…</p>
</li>
</ul>
</li>
<li><p><code>requestTask = new RequestTask(run, ctx.channel(), cmd)</code>ï¼šå°†ä»»åŠ¡å¯¹è±¡ã€é€šé“ã€è¯·æ±‚å°è£…æˆ RequestTask å¯¹è±¡</p>
</li>
<li><p><code>pair.getObject2().submit(requestTask)</code>ï¼š<strong>è·å–å¤„ç†å™¨å¯¹åº”çš„çº¿ç¨‹æ± ï¼Œå°† task æäº¤ï¼Œä» IO çº¿ç¨‹åˆ‡æ¢åˆ°ä¸šåŠ¡çº¿ç¨‹</strong></p>
</li>
</ul>
<p>NettyRemotingAbstract#processResponseCommandï¼š<strong>å¤„ç†å“åº”çš„æ•°æ®</strong></p>
<ul>
<li><code>int opaque = cmd.getOpaque()</code>ï¼šè·å–è¯·æ±‚ ID</li>
<li><code>responseFuture = responseTable.get(opaque)</code>ï¼š<strong>ä»å“åº”æ˜ å°„è¡¨ä¸­è·å–å¯¹åº”çš„å¯¹è±¡</strong></li>
<li><code>responseFuture.setResponseCommand(cmd)</code>ï¼šè®¾ç½®å“åº”çš„ Command å¯¹è±¡</li>
<li><code>responseTable.remove(opaque)</code>ï¼šä»æ˜ å°„è¡¨ä¸­ç§»é™¤å¯¹è±¡ï¼Œä»£è¡¨å¤„ç†å®Œæˆ</li>
<li><code>if (responseFuture.getInvokeCallback() != null)</code>ï¼šåŒ…å«å›è°ƒå¯¹è±¡ï¼Œå¼‚æ­¥æ‰§è¡Œå›è°ƒå¯¹è±¡</li>
<li><code>responseFuture.putResponse(cmd)</code>ï¼šä¸åŒ…å«å›è°ƒå¯¹è±¡ï¼Œ<strong>åŒæ­¥è°ƒç”¨æ—¶ï¼Œå”¤é†’ç­‰å¾…çš„ä¸šåŠ¡çº¿ç¨‹</strong></li>
</ul>
<p>æµç¨‹ï¼šå®¢æˆ·ç«¯ invokeSync â†’ æœåŠ¡å™¨çš„ processRequestCommand â†’ å®¢æˆ·ç«¯çš„ processResponseCommand â†’ ç»“æŸ</p>
<hr>
<h4 id="è·¯ç”±ä¿¡æ¯"><a href="#è·¯ç”±ä¿¡æ¯" class="headerlink" title="è·¯ç”±ä¿¡æ¯"></a>è·¯ç”±ä¿¡æ¯</h4><h5 id="ä¿¡æ¯ç®¡ç†"><a href="#ä¿¡æ¯ç®¡ç†" class="headerlink" title="ä¿¡æ¯ç®¡ç†"></a>ä¿¡æ¯ç®¡ç†</h5><p>RouteInfoManager ç±»è´Ÿè´£ç®¡ç†è·¯ç”±ä¿¡æ¯ï¼ŒNamesrvController çš„æ„é€ æ–¹æ³•ä¸­åˆ›å»ºè¯¥ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œç®¡ç†æœåŠ¡ç«¯çš„è·¯ç”±æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RouteInfoManager</span> &#123;</span><br><span class="line">    <span class="comment">// Broker ä¸¤ä¸ªå°æ—¶ä¸æ´»è·ƒï¼Œè§†ä¸ºç¦»çº¿ï¼Œè¢«å®šæ—¶ä»»åŠ¡åˆ é™¤</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">BROKER_CHANNEL_EXPIRED_TIME</span> <span class="operator">=</span> <span class="number">1000</span> * <span class="number">60</span> * <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// è¯»å†™é”ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReadWriteLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line">    <span class="comment">// ä¸»é¢˜é˜Ÿåˆ—æ•°æ®ï¼Œä¸€ä¸ªä¸»é¢˜å¯¹åº”å¤šä¸ªé˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String<span class="comment">/* topic */</span>, List&lt;QueueData&gt;&gt; topicQueueTable;</span><br><span class="line">    <span class="comment">// Broker æ•°æ®åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String<span class="comment">/* brokerName */</span>, BrokerData&gt; brokerAddrTable;</span><br><span class="line">    <span class="comment">// é›†ç¾¤</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String<span class="comment">/* clusterName */</span>, Set&lt;String<span class="comment">/* brokerName */</span>&gt;&gt; clusterAddrTable;</span><br><span class="line">    <span class="comment">// Broker å­˜æ´»ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String<span class="comment">/* brokerAddr */</span>, BrokerLiveInfo&gt; brokerLiveTable;</span><br><span class="line">    <span class="comment">// æœåŠ¡è¿‡æ»¤</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String<span class="comment">/* brokerAddr */</span>, List&lt;String&gt;<span class="comment">/* Filter Server */</span>&gt; filterServerTable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="è·¯ç”±æ³¨å†Œ"><a href="#è·¯ç”±æ³¨å†Œ" class="headerlink" title="è·¯ç”±æ³¨å†Œ"></a>è·¯ç”±æ³¨å†Œ</h5><p>DefaultRequestProcessor REGISTER_BROKER æ–¹æ³•è§£æï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RemotingCommand <span class="title function_">registerBroker</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand request)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå“åº”è¯·æ±‚çš„å¯¹è±¡ï¼Œè®¾ç½®ä¸ºå“åº”ç±»å‹ï¼Œã€å…ˆè®¾ç½®å“åº”çš„çŠ¶æ€ç æ—¶ç³»ç»Ÿé”™è¯¯ç ã€‘</span></span><br><span class="line">    <span class="comment">// åå°„åˆ›å»º RegisterBrokerResponseHeader å¯¹è±¡è®¾ç½®åˆ° response.customHeader å±æ€§ä¸­</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">RemotingCommand</span> <span class="variable">response</span> <span class="operator">=</span> RemotingCommand.createResponseCommand(RegisterBrokerResponseHeader.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å‡ºåå°„åˆ›å»ºçš„ RegisterBrokerResponseHeader ç”¨æˆ·è‡ªå®šä¹‰headerå¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">RegisterBrokerResponseHeader</span> <span class="variable">responseHeader</span> <span class="operator">=</span> (RegisterBrokerResponseHeader) response.readCustomHeader();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åå°„åˆ›å»º RegisterBrokerRequestHeader å¯¹è±¡ï¼Œå¹¶ä¸”å°† request.extFields ä¸­çš„æ•°æ®å†™å…¥åˆ°è¯¥å¯¹è±¡ä¸­</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">RegisterBrokerRequestHeader</span> <span class="variable">requestHeader</span> <span class="operator">=</span> request.decodeCommandCustomHeader(RegisterBrokerRequestHeader.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CRC æ ¡éªŒï¼Œè®¡ç®—è¯·æ±‚ä¸­çš„ CRC å€¼å’Œè¯·æ±‚å¤´ä¸­åŒ…å«çš„æ˜¯å¦ä¸€è‡´</span></span><br><span class="line">    <span class="keyword">if</span> (!checksum(ctx, request, requestHeader)) &#123;</span><br><span class="line">        response.setCode(ResponseCode.SYSTEM_ERROR);</span><br><span class="line">        response.setRemark(<span class="string">&quot;crc32 not match&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TopicConfigSerializeWrapper topicConfigWrapper;</span><br><span class="line">    <span class="keyword">if</span> (request.getBody() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ã€è§£æè¯·æ±‚ä½“ bodyã€‘ï¼Œè§£ç å‡ºæ¥çš„æ•°æ®å°±æ˜¯å½“å‰æœºå™¨çš„ä¸»é¢˜ä¿¡æ¯</span></span><br><span class="line">        topicConfigWrapper = TopicConfigSerializeWrapper.decode(request.getBody(), TopicConfigSerializeWrapper.class);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        topicConfigWrapper = <span class="keyword">new</span> <span class="title class_">TopicConfigSerializeWrapper</span>();</span><br><span class="line">        topicConfigWrapper.getDataVersion().setCounter(<span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>));</span><br><span class="line">        topicConfigWrapper.getDataVersion().setTimestamp(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œæ–¹æ³•</span></span><br><span class="line">    <span class="comment">// å‚æ•°1 é›†ç¾¤ã€å‚æ•°2ï¼šèŠ‚ç‚¹ipåœ°å€ã€å‚æ•°3ï¼šbrokerNameã€å‚æ•°4ï¼šbrokerId æ³¨æ„brokerId=0çš„èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// å‚æ•°5ï¼šhaèŠ‚ç‚¹ipåœ°å€ã€å‚æ•°6å½“å‰èŠ‚ç‚¹ä¸»é¢˜ä¿¡æ¯ã€å‚æ•°7ï¼šè¿‡æ»¤æœåŠ¡å™¨åˆ—è¡¨ã€å‚æ•°8ï¼šå½“å‰æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯é€šä¿¡çš„channel</span></span><br><span class="line">    <span class="type">RegisterBrokerResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.namesrvController.getRouteInfoManager().registerBroker(..);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ç»“æœä¿¡æ¯ å†™åˆ° responseHeader ä¸­</span></span><br><span class="line">    responseHeader.setHaServerAddr(result.getHaServerAddr());</span><br><span class="line">    responseHeader.setMasterAddr(result.getMasterAddr());</span><br><span class="line">    <span class="comment">// è·å– kvé…ç½®ï¼Œå†™å…¥ response body ä¸­ï¼Œã€kv é…ç½®æ˜¯é¡ºåºæ¶ˆæ¯ç›¸å…³çš„ã€‘</span></span><br><span class="line">    <span class="type">byte</span>[] jsonValue = <span class="built_in">this</span>.namesrvController.getKvConfigManager().getKVListByNamespace(NamesrvUtil.NAMESPACE_ORDER_TOPIC);</span><br><span class="line">    response.setBody(jsonValue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// code è®¾ç½®ä¸º SUCCESS</span></span><br><span class="line">    response.setCode(ResponseCode.SUCCESS);</span><br><span class="line">    response.setRemark(<span class="literal">null</span>);</span><br><span class="line">	<span class="comment">// è¿”å› response ï¼Œã€è¿”å›çš„ response ç”± callback å¯¹è±¡å¤„ç†ã€‘</span></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RouteInfoManager#registerBrokerï¼šæ³¨å†Œ Broker çš„ä¿¡æ¯</p>
<ul>
<li><p><code>RegisterBrokerResult result = new RegisterBrokerResult()</code>ï¼šè¿”å›ç»“æœçš„å°è£…å¯¹è±¡</p>
</li>
<li><p><code>this.lock.writeLock().lockInterruptibly()</code>ï¼šåŠ å†™é”å<strong>åŒæ­¥æ‰§è¡Œ</strong></p>
</li>
<li><p><code>brokerNames = this.clusterAddrTable.get(clusterName)</code>ï¼šè·å–å½“å‰é›†ç¾¤ä¸Šçš„ Broker åç§°åˆ—è¡¨ï¼Œæ˜¯ç©ºå°±æ–°å»ºåˆ—è¡¨</p>
</li>
<li><p><code>brokerNames.add(brokerName)</code>ï¼šå°†å½“å‰ Broker åå­—åŠ å…¥åˆ°é›†ç¾¤åˆ—è¡¨</p>
</li>
<li><p><code>brokerData = this.brokerAddrTable.get(brokerName)</code>ï¼šè·å–å½“å‰ Broker çš„ brokerDataï¼Œæ˜¯ç©ºå°±æ–°å»ºæ”¾å…¥æ˜ å°„è¡¨</p>
</li>
<li><p><code>brokerAddrsMap = brokerData.getBrokerAddrs()</code>ï¼šè·å–å½“å‰ Broker çš„ç‰©ç†èŠ‚ç‚¹ map è¡¨ï¼Œè¿›è¡Œéå†ï¼Œå¦‚æœç‰©ç†èŠ‚ç‚¹è§’è‰²å‘ç”Ÿå˜åŒ–ï¼ˆslave â†’ masterï¼‰ï¼Œå…ˆå°†æ—§æ•°æ®ä»ç‰©ç†èŠ‚ç‚¹ map ä¸­ç§»é™¤ï¼Œç„¶åé‡å†™æ”¾å…¥ï¼Œ<strong>ä¿è¯èŠ‚ç‚¹çš„å”¯ä¸€æ€§</strong></p>
</li>
<li><p><code>if (null != topicConfigWrapper &amp;&amp; MixAll.MASTER_ID == brokerId)</code>ï¼šBroker ä¸Šçš„ Topic ä¸ä¸º nullï¼Œå¹¶ä¸”å½“å‰ç‰©ç†èŠ‚ç‚¹æ˜¯  Broker ä¸Šçš„ master èŠ‚ç‚¹</p>
<p><code>tcTable = topicConfigWrapper.getTopicConfigTable()</code>ï¼šè·å–å½“å‰ Broker ä¿¡æ¯ä¸­çš„ä¸»é¢˜æ˜ å°„è¡¨</p>
<p><code>if (tcTable != null)</code>ï¼šæ˜ å°„è¡¨ä¸ç©ºå°±åŠ å…¥æˆ–è€…æ›´æ–°åˆ° Namesrv å†…</p>
</li>
<li><p><code>prevBrokerLiveInfo = this.brokerLiveTable.put(brokerAddr)</code>ï¼šæ·»åŠ <strong>å½“å‰èŠ‚ç‚¹çš„ BrokerLiveInfo</strong> ï¼Œè¿”å›ä¸Šä¸€æ¬¡å¿ƒè·³æ—¶å½“å‰ Broker èŠ‚ç‚¹çš„å­˜æ´»å¯¹è±¡æ•°æ®ã€‚<strong>NamesrvController  ä¸­çš„å®šæ—¶ä»»åŠ¡ä¼šæ‰«ææ˜ å°„è¡¨ brokerLiveTable</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BrokerLiveInfo</span> <span class="variable">prevBrokerLiveInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.brokerLiveTable.put(brokerAddr, <span class="keyword">new</span> <span class="title class_">BrokerLiveInfo</span>(</span><br><span class="line">    System.currentTimeMillis(),topicConfigWrapper.getDataVersion(), channel,haServerAddr));</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>if (MixAll.MASTER_ID != brokerId)</code>ï¼šå½“å‰ Broker ä¸æ˜¯ master èŠ‚ç‚¹ï¼Œ<strong>è·å–ä¸»èŠ‚ç‚¹çš„ä¿¡æ¯</strong>è®¾ç½®åˆ°ç»“æœå¯¹è±¡</p>
</li>
<li><p><code>this.lock.writeLock().unlock()</code>ï¼šé‡Šæ”¾å†™é”</p>
</li>
</ul>
<hr>
<h3 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h3><h4 id="MappedFile"><a href="#MappedFile" class="headerlink" title="MappedFile"></a>MappedFile</h4><h5 id="æˆå‘˜å±æ€§-1"><a href="#æˆå‘˜å±æ€§-1" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>MappedFile ç±»æ˜¯æœ€åŸºç¡€çš„å­˜å‚¨ç±»ï¼Œç»§æ‰¿è‡ª ReferenceResource ç±»ï¼Œç”¨æ¥<strong>ä¿è¯çº¿ç¨‹å®‰å…¨</strong></p>
<p>MappedFile ç±»æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>å†…å­˜ç›¸å…³ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">OS_PAGE_SIZE</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">4</span>;<span class="comment">// å†…å­˜é¡µå¤§å°ï¼šé»˜è®¤æ˜¯ 4k</span></span><br><span class="line"><span class="keyword">private</span> AtomicLong TOTAL_MAPPED_VIRTUAL_MEMORY;	<span class="comment">// å½“å‰è¿›ç¨‹ä¸‹æ‰€æœ‰çš„ mappedFile å ç”¨çš„æ€»è™šæ‹Ÿå†…å­˜å¤§å°</span></span><br><span class="line"><span class="keyword">private</span> AtomicInteger TOTAL_MAPPED_FILES;		<span class="comment">// å½“å‰è¿›ç¨‹ä¸‹æ‰€æœ‰çš„ mappedFile ä¸ªæ•°</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ•°æ®ä½ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> AtomicInteger wrotePosition;	<span class="comment">// å½“å‰ mappedFile çš„æ•°æ®å†™å…¥ç‚¹</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> AtomicInteger committedPosition;<span class="comment">// å½“å‰ mappedFile çš„æ•°æ®æäº¤ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger flushedPosition;	<span class="comment">// æ•°æ®è½ç›˜ä½ç‚¹ï¼Œåœ¨è¿™ä¹‹å‰çš„æ•°æ®æ˜¯æŒä¹…åŒ–çš„å®‰å…¨æ•°æ®</span></span><br><span class="line">												<span class="comment">// flushedPosition-wrotePosition ä¹‹é—´çš„æ•°æ®å±äºè„é¡µ</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ–‡ä»¶ç›¸å…³ï¼šCL æ˜¯ CommitLogï¼ŒCQ æ˜¯ ConsumeQueue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String fileName;	<span class="comment">// æ–‡ä»¶åç§°ï¼ŒCLå’ŒCQæ–‡ä»¶åæ˜¯ã€ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ç‰©ç†åç§»é‡ã€‘ï¼Œç´¢å¼•æ–‡ä»¶æ˜¯ã€å¹´æœˆæ—¥æ—¶åˆ†ç§’ã€‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> fileFromOffset;<span class="comment">// æ–‡ä»¶åè½¬longï¼Œä»£è¡¨è¯¥å¯¹è±¡çš„ã€èµ·å§‹åç§»é‡ã€‘	</span></span><br><span class="line"><span class="keyword">private</span> File file;			<span class="comment">// æ–‡ä»¶å¯¹è±¡</span></span><br></pre></td></tr></table></figure>
<p><strong>MF ä¸­ä»¥ç‰©ç†åç§»é‡ä½œä¸ºæ–‡ä»¶åï¼Œå¯ä»¥æ›´å¥½çš„å¯»å€å’Œè¿›è¡Œåˆ¤æ–­</strong></p>
</li>
<li><p>å†…å­˜æ˜ å°„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> FileChannel fileChannel;			<span class="comment">// æ–‡ä»¶é€šé“</span></span><br><span class="line"><span class="keyword">private</span> MappedByteBuffer mappedByteBuffer;	<span class="comment">// å†…å­˜æ˜ å°„ç¼“å†²åŒºï¼Œè®¿é—®è™šæ‹Ÿå†…å­˜</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>ReferenceResource ç±»æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>å¼•ç”¨æ•°é‡ï¼šå½“ <code>refCount &lt;= 0</code> æ—¶ï¼Œè¡¨ç¤ºè¯¥èµ„æºå¯ä»¥é‡Šæ”¾äº†ï¼Œæ²¡æœ‰ä»»ä½•å…¶ä»–ç¨‹åºä¾èµ–å®ƒäº†ï¼Œç”¨åŸå­ç±»ä¿è¯çº¿ç¨‹å®‰å…¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">refCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">1</span>);	<span class="comment">// åˆå§‹å€¼ä¸º 1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å­˜æ´»çŠ¶æ€ï¼šè¡¨ç¤ºèµ„æºçš„å­˜æ´»çŠ¶æ€</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">available</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ˜¯å¦æ¸…ç†ï¼šé»˜è®¤å€¼ falseï¼Œå½“æ‰§è¡Œå®Œå­ç±»å¯¹è±¡çš„ cleanup() æ¸…ç†æ–¹æ³•åï¼Œè¯¥å€¼ç½®ä¸º true ï¼Œè¡¨ç¤ºèµ„æºå·²ç»å…¨éƒ¨é‡Šæ”¾</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">cleanupOver</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¬¬ä¸€æ¬¡å…³é—­èµ„æºçš„æ—¶é—´ï¼šç”¨æ¥è®°å½•è¶…æ—¶æ—¶é—´</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">firstShutdownTimestamp</span> <span class="operator">=</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æˆå‘˜æ–¹æ³•"><a href="#æˆå‘˜æ–¹æ³•" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h5><p>MappedFile ç±»æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li><p>appendMessage()ï¼šæä¾›ä¸Šå±‚å‘å†…å­˜æ˜ å°„ä¸­è¿½åŠ æ¶ˆæ¯çš„æ–¹æ³•ï¼Œæ¶ˆæ¯å¦‚ä½•è¿½åŠ ç”± AppendMessageCallback æ§åˆ¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°ä¸€ï¼šæ¶ˆæ¯     å‚æ•°äºŒï¼šè¿½åŠ æ¶ˆæ¯å›è°ƒ</span></span><br><span class="line"><span class="keyword">public</span> AppendMessageResult <span class="title function_">appendMessage</span><span class="params">(MessageExtBrokerInner msg, AppendMessageCallback cb)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†å­—èŠ‚æ•°ç»„å†™å…¥åˆ°æ–‡ä»¶é€šé“</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">appendMessage</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] data)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>flush()ï¼šåˆ·ç›˜æ¥å£ï¼Œå‚æ•° flushLeastPages  ä»£è¡¨åˆ·ç›˜çš„æœ€å°é¡µæ•° ï¼Œç­‰äº 0 æ—¶å±äºå¼ºåˆ¶åˆ·ç›˜ï¼›&gt; 0 æ—¶éœ€è¦è„é¡µï¼ˆè®¡ç®—æ–¹æ³•åœ¨æ•°æ®ä½ç‚¹ï¼‰è¾¾åˆ°è¯¥å€¼æ‰è¿›è¡Œç‰©ç†åˆ·ç›˜ï¼›æ–‡ä»¶å†™æ»¡æ—¶å¼ºåˆ¶åˆ·ç›˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">flush</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> flushLeastPages)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>selectMappedBuffer()ï¼šè¯¥æ–¹æ³•ä»¥ pos ä¸ºå¼€å§‹ä½ç‚¹ ï¼Œåˆ°æœ‰æ•ˆæ•°æ®ä¸ºæ­¢ï¼Œåˆ›å»ºä¸€ä¸ªåˆ‡ç‰‡ ByteBuffer ä½œä¸ºæ•°æ®å‰¯æœ¬ï¼Œä¾›ä¸šåŠ¡è®¿é—®æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SelectMappedBufferResult <span class="title function_">selectMappedBuffer</span><span class="params">(<span class="type">int</span> pos)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>destroy()ï¼šé”€æ¯æ˜ å°„æ–‡ä»¶å¯¹è±¡ï¼Œå¹¶åˆ é™¤å…³è”çš„ç³»ç»Ÿæ–‡ä»¶ï¼Œå‚æ•°æ˜¯å¼ºåˆ¶å…³é—­èµ„æºçš„æ—¶é—´</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">destroy</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> intervalForcibly)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>cleanup()ï¼š<strong>é‡Šæ”¾å †å¤–å†…å­˜</strong>ï¼Œæ›´æ–°æ€»è™šæ‹Ÿå†…å­˜å’Œæ€»å†…å­˜æ˜ å°„æ–‡ä»¶æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">cleanup</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> currentRef)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>warmMappedFile()ï¼šå†…å­˜é¢„çƒ­ï¼Œå½“è¦æ–°å»ºçš„ MappedFile å¯¹è±¡å¤§äº 1g æ—¶æ‰§è¡Œè¯¥æ–¹æ³•ã€‚mappedByteBuffer å·²ç»é€šè¿‡mmapæ˜ å°„ï¼Œæ­¤æ—¶æ“ä½œç³»ç»Ÿä¸­åªæ˜¯è®°å½•äº†è¯¥æ–‡ä»¶å’Œè¯¥ Buffer çš„æ˜ å°„å…³ç³»ï¼Œè€Œå¹¶æ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œå¯¹è¯¥ MappedFile çš„æ¯ä¸ª Page Cache è¿›è¡Œå†™å…¥ä¸€ä¸ªå­—èŠ‚åˆ†é…å†…å­˜ï¼Œ<strong>å°†æ˜ å°„æ–‡ä»¶å…¨éƒ¨åŠ è½½åˆ°å†…å­˜</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">warmMappedFile</span><span class="params">(FlushDiskType type, <span class="type">int</span> pages)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>mlock()ï¼šé”ä½æŒ‡å®šçš„å†…å­˜åŒºåŸŸé¿å…è¢«æ“ä½œç³»ç»Ÿè°ƒåˆ° swap ç©ºé—´ï¼Œå‡å°‘äº†ç¼ºé¡µå¼‚å¸¸çš„äº§ç”Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mlock</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<p>swap space æ˜¯ç£ç›˜ä¸Šçš„ä¸€å—åŒºåŸŸï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªåˆ†åŒºæˆ–è€…ä¸€ä¸ªæ–‡ä»¶æˆ–è€…æ˜¯ç»„åˆã€‚å½“ç³»ç»Ÿç‰©ç†å†…å­˜ä¸è¶³æ—¶ï¼ŒLinux ä¼šå°†å†…å­˜ä¸­ä¸å¸¸è®¿é—®çš„æ•°æ®ä¿å­˜åˆ° swap åŒºåŸŸä¸Šï¼Œè¿™æ ·ç³»ç»Ÿå°±å¯ä»¥æœ‰æ›´å¤šçš„ç‰©ç†å†…å­˜ä¸ºå„ä¸ªè¿›ç¨‹æœåŠ¡ï¼Œè€Œå½“ç³»ç»Ÿéœ€è¦è®¿é—® swap ä¸Šå­˜å‚¨çš„å†…å®¹æ—¶ï¼Œéœ€è¦é€šè¿‡<strong>ç¼ºé¡µä¸­æ–­</strong>å°† swap ä¸Šçš„æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­</p>
</li>
</ul>
<p>ReferenceResource ç±»æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li><p>hold()ï¼šå¢åŠ å¼•ç”¨è®°æ•° refCountï¼Œæ–¹æ³•åŠ é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">hold</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>shutdown()ï¼šå…³é—­èµ„æºï¼Œå‚æ•°ä»£è¡¨å¼ºåˆ¶å…³é—­èµ„æºçš„æ—¶é—´é—´éš”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç³»ç»Ÿå½“å‰æ—¶é—´ - firstShutdownTimestamp æ—¶é—´  &gt; intervalForcibly è¿›è¡Œã€å¼ºåˆ¶å…³é—­ã€‘</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> intervalForcibly)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>release()ï¼šå¼•ç”¨è®¡æ•°å‡ 1ï¼Œå½“ refCount  ä¸º 0 æ—¶ï¼Œè°ƒç”¨å­ç±»çš„ cleanup æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="MapQueue"><a href="#MapQueue" class="headerlink" title="MapQueue"></a>MapQueue</h4><h5 id="æˆå‘˜å±æ€§-2"><a href="#æˆå‘˜å±æ€§-2" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>MappedFileQueue ç”¨æ¥ç®¡ç† MappedFile æ–‡ä»¶</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>ç®¡ç†ç›®å½•ï¼šCommitLog æ˜¯ <code>../store/commitlog</code>ï¼Œ ConsumeQueue æ˜¯ <code>../store/xxx_topic/0</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String storePath;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ–‡ä»¶å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> mappedFileSize;	<span class="comment">// ç›®å½•ä¸‹æ¯ä¸ªæ–‡ä»¶å¤§å°ï¼ŒCLæ–‡ä»¶é»˜è®¤ 1gï¼ŒCQæ–‡ä»¶ é»˜è®¤ 600wå­—èŠ‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> CopyOnWriteArrayList&lt;MappedFile&gt; mappedFiles;	<span class="comment">//ç›®å½•ä¸‹çš„æ¯ä¸ª mappedFile éƒ½åŠ å…¥è¯¥é›†åˆ</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ•°æ®ä½ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="variable">flushedWhere</span> <span class="operator">=</span> <span class="number">0</span>;		<span class="comment">// ç›®å½•çš„åˆ·ç›˜ä½ç‚¹ï¼Œå€¼ä¸º mf.fileName + mf.wrotePosition</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="variable">committedWhere</span> <span class="operator">=</span> <span class="number">0</span>;	<span class="comment">// ç›®å½•çš„æäº¤ä½ç‚¹</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆæ¯å­˜å‚¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">storeTimestamp</span> <span class="operator">=</span> <span class="number">0</span>;	<span class="comment">// å½“å‰ç›®å½•ä¸‹æœ€åä¸€æ¡ msg çš„å­˜å‚¨æ—¶é—´</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»ºæœåŠ¡ï¼šæ–°å»º MappedFile å®ä¾‹ï¼Œç»§æ‰¿è‡ª ServiceThread æ˜¯ä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œrun æ–¹æ³•ç”¨æ¥åˆ›å»ºå®ä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AllocateMappedFileService allocateMappedFileService;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æˆå‘˜æ–¹æ³•-1"><a href="#æˆå‘˜æ–¹æ³•-1" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h5><p>æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li><p>load()ï¼šBroker å¯åŠ¨æ—¶ï¼ŒåŠ è½½æœ¬åœ°ç£ç›˜æ•°æ®ï¼Œè¯¥æ–¹æ³•è¯»å– storePath ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œåˆ›å»º MappedFile å¯¹è±¡æ”¾å…¥é›†åˆå†…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">load</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>getLastMappedFile()ï¼šè·å–å½“å‰æ­£åœ¨é¡ºåºå†™å…¥çš„ MappedFile å¯¹è±¡ï¼Œå¦‚æœæœ€åä¸€ä¸ª MappedFile å†™æ»¡äº†ï¼Œæˆ–è€…ä¸å­˜åœ¨ MappedFile å¯¹è±¡ï¼Œåˆ™åˆ›å»ºæ–°çš„ MappedFile</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°ä¸€ï¼šæ–‡ä»¶èµ·å§‹åç§»é‡ï¼›å‚æ•°äºŒï¼šå½“listä¸ºç©ºæ—¶ï¼Œæ˜¯å¦æ–°å»º MappedFile</span></span><br><span class="line"><span class="keyword">public</span> MappedFile <span class="title function_">getLastMappedFile</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> startOffset, <span class="type">boolean</span> needCreate)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>flush()ï¼šæ ¹æ® flushedWhere å±æ€§æŸ¥æ‰¾åˆé€‚çš„ MappedFileï¼Œè°ƒç”¨è¯¥ MappedFile çš„è½ç›˜æ–¹æ³•ï¼Œå¹¶æ›´æ–°å…¨å±€çš„ flushedWhere</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‚æ•°ï¼š0 è¡¨ç¤ºå¼ºåˆ¶åˆ·æ–°ï¼Œ &gt; 0 è„é¡µæ•°æ®å¿…é¡»è¾¾åˆ° flushLeastPages æ‰åˆ·æ–°</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">flush</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> flushLeastPages)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>findMappedFileByOffset()ï¼šæ ¹æ®åç§»é‡æŸ¥è¯¢å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> MappedFile <span class="title function_">findMappedFileByOffset</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> offset, <span class="keyword">final</span> <span class="type">boolean</span> returnFirstOnNotFound)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>deleteExpiredFileByTime()ï¼šCL åˆ é™¤è¿‡æœŸæ–‡ä»¶ï¼Œæ ¹æ®æ–‡ä»¶çš„ä¿ç•™æ—¶é•¿å†³å®šæ˜¯å¦åˆ é™¤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°ä¸€ï¼šè¿‡æœŸæ—¶é—´ï¼› å‚æ•°äºŒï¼šåˆ é™¤ä¸¤ä¸ªæ–‡ä»¶ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼› å‚æ•°ä¸‰ï¼šmf.destoryä¼ é€’çš„å‚æ•°ï¼› å‚æ•°å››ï¼štrue å¼ºåˆ¶åˆ é™¤</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deleteExpiredFileByTime</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> expiredTime,<span class="keyword">final</span> <span class="type">int</span> deleteFilesInterval, <span class="keyword">final</span> <span class="type">long</span> intervalForcibly, <span class="keyword">final</span> <span class="type">boolean</span> cleanImmediately)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>deleteExpiredFileByOffset()ï¼šCQ åˆ é™¤è¿‡æœŸæ–‡ä»¶ï¼Œéå†æ¯ä¸ª MF æ–‡ä»¶ï¼Œè·å–å½“å‰æ–‡ä»¶æœ€åä¸€ä¸ªæ•°æ®å•å…ƒçš„ç‰©ç†åç§»é‡ï¼Œå°äº offset è¯´æ˜å½“å‰ MF æ–‡ä»¶å†…éƒ½æ˜¯è¿‡æœŸæ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°ä¸€ï¼šconsumeLog ç›®å½•ä¸‹æœ€å°ç‰©ç†åç§»é‡ï¼Œå°±æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ offsetï¼› </span></span><br><span class="line"><span class="comment">// å‚æ•°äºŒï¼šConsumerQueue æ–‡ä»¶å†…æ¯ä¸ªæ•°æ®å•å…ƒå›ºå®šå¤§å°</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deleteExpiredFileByOffset</span><span class="params">(<span class="type">long</span> offset, <span class="type">int</span> unitSize)</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="CommitLog"><a href="#CommitLog" class="headerlink" title="CommitLog"></a>CommitLog</h4><h5 id="æˆå‘˜å±æ€§-3"><a href="#æˆå‘˜å±æ€§-3" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>é­”æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">MESSAGE_MAGIC_CODE</span> <span class="operator">=</span> -<span class="number">626843481</span>;	<span class="comment">// æ¶ˆæ¯çš„ç¬¬ä¸€ä¸ªå­—æ®µæ˜¯å¤§å°ï¼Œç¬¬äºŒä¸ªå­—æ®µå°±æ˜¯é­”æ•°	</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">BLANK_MAGIC_CODE</span> <span class="operator">=</span> -<span class="number">875286124</span>;	<span class="comment">// æ–‡ä»¶å°¾æ¶ˆæ¯çš„é­”æ³•å€¼</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>MappedFileQueueï¼šç”¨äºç®¡ç† <code>../store/commitlog</code> ç›®å½•ä¸‹çš„æ–‡ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> MappedFileQueue mappedFileQueue;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å­˜å‚¨æœåŠ¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> DefaultMessageStore defaultMessageStore;	<span class="comment">// å­˜å‚¨æ¨¡å—å¯¹è±¡ï¼Œä¸Šå±‚æœåŠ¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> FlushCommitLogService flushCommitLogService;	<span class="comment">// åˆ·ç›˜æœåŠ¡ï¼Œé»˜è®¤å®ç°æ˜¯å¼‚æ­¥åˆ·ç›˜</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å›è°ƒå™¨ï¼šæ§åˆ¶æ¶ˆæ¯çš„å“ªäº›å­—æ®µæ·»åŠ åˆ° MappedFile</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AppendMessageCallback appendMessageCallback;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é˜Ÿåˆ—åç§»é‡å­—å…¸è¡¨ï¼škey æ˜¯ä¸»é¢˜é˜Ÿåˆ— idï¼Œvalue æ˜¯åç§»é‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> HashMap&lt;String, Long&gt; topicQueueTable = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Long&gt;(<span class="number">1024</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>é”ç›¸å…³ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">beginTimeInLock</span> <span class="operator">=</span> <span class="number">0</span>;		 	<span class="comment">// å†™æ•°æ®æ—¶åŠ é”çš„å¼€å§‹æ—¶é—´</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> PutMessageLock putMessageLock;		<span class="comment">// å†™é”ï¼Œä¸¤ä¸ªå®ç°ç±»ï¼šè‡ªæ—‹é”å’Œé‡å…¥é”</span></span><br></pre></td></tr></table></figure>
<p>å› ä¸ºå‘é€æ¶ˆæ¯æ˜¯éœ€è¦æŒä¹…åŒ–çš„ï¼Œåœ¨ Broker ç«¯æŒä¹…åŒ–æ—¶ä¼šè·å–è¯¥é”ï¼Œ<strong>ä¿è¯å‘é€çš„æ¶ˆæ¯çš„çº¿ç¨‹å®‰å…¨</strong></p>
</li>
</ul>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<ul>
<li><p>æœ‰å‚æ„é€ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">CommitLog</span><span class="params">(<span class="keyword">final</span> DefaultMessageStore defaultMessageStore)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»º MappedFileQueue å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// å‚æ•°1ï¼š../store/commitlogï¼› å‚æ•°2ï¼šã€1gã€‘ï¼› å‚æ•°3ï¼šallocateMappedFileService</span></span><br><span class="line">    <span class="built_in">this</span>.mappedFileQueue = <span class="keyword">new</span> <span class="title class_">MappedFileQueue</span>(...);</span><br><span class="line">    <span class="comment">// é»˜è®¤ å¼‚æ­¥åˆ·ç›˜ï¼Œåˆ›å»ºè¿™ä¸ªå¯¹è±¡</span></span><br><span class="line">   	<span class="built_in">this</span>.flushCommitLogService = <span class="keyword">new</span> <span class="title class_">FlushRealTimeService</span>();</span><br><span class="line">    <span class="comment">// æ§åˆ¶æ¶ˆæ¯å“ªäº›å­—æ®µè¿½åŠ åˆ° mappedFileï¼Œã€æ¶ˆæ¯æœ€å¤§æ˜¯ 4Mã€‘</span></span><br><span class="line">   	<span class="built_in">this</span>.appendMessageCallback = <span class="keyword">new</span> <span class="title class_">DefaultAppendMessageCallback</span>(...);</span><br><span class="line">    <span class="comment">// é»˜è®¤ä½¿ç”¨è‡ªæ—‹é”</span></span><br><span class="line">    <span class="built_in">this</span>.putMessageLock = ...;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æˆå‘˜æ–¹æ³•-2"><a href="#æˆå‘˜æ–¹æ³•-2" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h5><p>CommitLog ç±»æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li><p>start()ï¼šä¼šå¯åŠ¨åˆ·ç›˜æœåŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>shutdown()ï¼šå…³é—­åˆ·ç›˜æœåŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>load()ï¼šåŠ è½½ CommitLog ç›®å½•ä¸‹çš„æ–‡ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">load</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>getMessage()ï¼šæ ¹æ® offset æŸ¥è¯¢å•æ¡ä¿¡æ¯ï¼Œè¿”å›çš„ç»“æœå¯¹è±¡å†…éƒ¨å°è£…äº†ä¸€ä¸ª ByteBufferï¼Œè¯¥ Buffer è¡¨ç¤º <code>[offset, offset + size]</code> åŒºé—´çš„ MappedFile çš„æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SelectMappedBufferResult <span class="title function_">getMessage</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> offset, <span class="keyword">final</span> <span class="type">int</span> size)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>deleteExpiredFile()ï¼šåˆ é™¤è¿‡æœŸæ–‡ä»¶ï¼Œæ–¹æ³•ç”± DefaultMessageStore çš„å®šæ—¶ä»»åŠ¡è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deleteExpiredFile</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>asyncPutMessage()ï¼š<strong>å­˜å‚¨æ¶ˆæ¯</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletableFuture&lt;PutMessageResult&gt; <span class="title function_">asyncPutMessage</span><span class="params">(<span class="keyword">final</span> MessageExtBrokerInner msg)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>msg.setStoreTimestamp(System.currentTimeMillis())</code>ï¼šè®¾ç½®å­˜å‚¨æ—¶é—´ï¼Œåé¢è·å–åˆ°å†™é”åè¿™ä¸ªäº‹ä»¶ä¼šé‡å†™</li>
<li><code>msg.setBodyCRC(UtilAll.crc32(msg.getBody()))</code>ï¼šè·å–æ¶ˆæ¯çš„ CRC å€¼</li>
<li><code>topicã€queueId</code>ï¼šè·å–ä¸»é¢˜å’Œé˜Ÿåˆ— ID</li>
<li><code>if (msg.getDelayTimeLevel() &gt; 0)</code>ï¼š<strong>è·å–æ¶ˆæ¯çš„å»¶è¿Ÿçº§åˆ«ï¼Œè¿™é‡Œæ˜¯å»¶è¿Ÿæ¶ˆæ¯å®ç°çš„å…³é”®</strong></li>
<li><code>topic = TopicValidator.RMQ_SYS_SCHEDULE_TOPIC</code>ï¼š<strong>ä¿®æ”¹æ¶ˆæ¯çš„ä¸»é¢˜ä¸º <code>SCHEDULE_TOPIC_XXXX</code></strong></li>
<li><code>queueId = ScheduleMessageService.delayLevel2QueueId()</code>ï¼š<strong>é˜Ÿåˆ— ID ä¸ºå»¶è¿Ÿçº§åˆ« -1</strong></li>
<li><code>MessageAccessor.putProperty</code>ï¼š<strong>å°†åŸæ¥çš„æ¶ˆæ¯ä¸»é¢˜å’Œ ID å­˜å…¥æ¶ˆæ¯çš„å±æ€§ <code>REAL_TOPIC</code> ä¸­</strong></li>
<li><code>mappedFile = this.mappedFileQueue.getLastMappedFile()</code>ï¼šè·å–å½“å‰é¡ºåºå†™çš„ MappedFile å¯¹è±¡</li>
<li><code>putMessageLock.lock()</code>ï¼š<strong>è·å–å†™é”</strong></li>
<li><code>msg.setStoreTimestamp(beginLockTimestamp)</code>ï¼šè®¾ç½®æ¶ˆæ¯çš„å­˜å‚¨æ—¶é—´ä¸ºè·å–é”çš„æ—¶é—´</li>
<li><code>if (null == mappedFile || mappedFile.isFull())</code>ï¼šæ–‡ä»¶å†™æ»¡äº†åˆ›å»ºæ–°çš„ MF å¯¹è±¡</li>
<li><code>result = mappedFile.appendMessage(msg, this.appendMessageCallback)</code>ï¼š<strong>æ¶ˆæ¯è¿½åŠ </strong>ï¼Œæ ¸å¿ƒé€»è¾‘åœ¨å›è°ƒå™¨ç±»</li>
<li><code>putMessageLock.unlock()</code>ï¼šé‡Šæ”¾å†™é”</li>
<li><code>this.defaultMessageStore.unlockMappedFile(..)</code>ï¼šå°† MappedByteBuffer ä» lock åˆ‡æ¢ä¸º unlock çŠ¶æ€</li>
<li><code>putMessageResult = new PutMessageResult(PutMessageStatus.PUT_OK, result)</code>ï¼šç»“æœå°è£…</li>
<li><code>flushResultFuture = submitFlushRequest(result, msg)</code>ï¼š<strong>å”¤é†’åˆ·ç›˜çº¿ç¨‹</strong></li>
<li><code>replicaResultFuture = submitReplicaRequest(result, msg)</code>ï¼šHA æ¶ˆæ¯åŒæ­¥</li>
</ul>
</li>
<li><p>recoverNormally()ï¼šæ­£å¸¸å…³æœºæ—¶çš„æ¢å¤æ–¹æ³•ï¼Œå­˜å‚¨æ¨¡å—å¯åŠ¨æ—¶<strong>å…ˆæ¢å¤æ‰€æœ‰çš„ ConsumeQueue æ•°æ®ï¼Œå†æ¢å¤ CommitLog æ•°æ®</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°è¡¨ç¤ºæ¢å¤é˜¶æ®µ ConsumeQueue ä¸­å·²çŸ¥çš„æœ€å¤§çš„æ¶ˆæ¯ offset</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recoverNormally</span><span class="params">(<span class="type">long</span> maxPhyOffsetOfConsumeQueue)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>int index = mappedFiles.size() - 3</code>ï¼šä»å€’æ•°ç¬¬ä¸‰ä¸ª file å¼€å§‹å‘åæ¢å¤</p>
</li>
<li><p><code>dispatchRequest = this.checkMessageAndReturnSize()</code>ï¼šæ¯æ¬¡ä»åˆ‡ç‰‡å†…è§£æå‡ºä¸€æ¡ msg å°è£…æˆ DispatchRequest å¯¹è±¡</p>
</li>
<li><p><code>size = dispatchRequest.getMsgSize()</code>ï¼šè·å–æ¶ˆæ¯çš„å¤§å°ï¼Œæ£€æŸ¥ DispatchRequest å¯¹è±¡çš„çŠ¶æ€</p>
<p>æƒ…å†µ 1ï¼šæ­£å¸¸æ•°æ®ï¼Œåˆ™ <code>mappedFileOffset += size</code></p>
<p>æƒ…å†µ 2ï¼šæ–‡ä»¶å°¾æ•°æ®ï¼Œå¤„ç†ä¸‹ä¸€ä¸ªæ–‡ä»¶ï¼ŒmappedFileOffset ç½®ä¸º 0ï¼Œmagic_code è¡¨ç¤ºæ–‡ä»¶å°¾</p>
</li>
<li><p><code>processOffset += mappedFileOffset</code>ï¼šè®¡ç®—å‡ºæ­£ç¡®çš„æ•°æ®å­˜å‚¨ä½ç‚¹ï¼Œå¹¶è®¾ç½® MappedFileQueue çš„ç›®å½•åˆ·ç›˜ä½ç‚¹</p>
</li>
<li><p><code>this.mappedFileQueue.truncateDirtyFiles(processOffset)</code>ï¼šè°ƒæ•´ MFQ ä¸­æ–‡ä»¶çš„åˆ·ç›˜ä½ç‚¹</p>
</li>
<li><p><code>if (maxPhyOffsetOfConsumeQueue &gt;= processOffset)</code>ï¼šåˆ é™¤å†—ä½™æ•°æ®ï¼Œå°†è¶…è¿‡å…¨å±€ä½ç‚¹çš„ CQ ä¸‹çš„æ–‡ä»¶åˆ é™¤ï¼Œå°†åŒ…å«å…¨å±€ä½ç‚¹çš„ CQ ä¸‹çš„æ–‡ä»¶é‡æ–°å®šä½</p>
</li>
</ul>
</li>
<li><p>recoverAbnormally()ï¼šå¼‚å¸¸å…³æœºæ—¶çš„æ¢å¤æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recoverAbnormally</span><span class="params">(<span class="type">long</span> maxPhyOffsetOfConsumeQueue)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>int index = mappedFiles.size() - 1</code>ï¼šä»å°¾éƒ¨å¼€å§‹éå† MFQï¼ŒéªŒè¯ MF çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªéªŒè¯é€šè¿‡çš„æ–‡ä»¶å¯¹è±¡</li>
<li><code>dispatchRequest = this.checkMessageAndReturnSize()</code>ï¼šæ¯æ¬¡è§£æå‡ºä¸€æ¡ msg å°è£…æˆ DispatchRequest å¯¹è±¡</li>
<li><code>this.defaultMessageStore.doDispatch(dispatchRequest)</code>ï¼š<strong>é‡å»º ConsumerQueue å’Œ Indexï¼Œé¿å…ä¸Šæ¬¡å¼‚å¸¸åœæœºå¯¼è‡´ CQ å’Œ Index ä¸ CommitLog ä¸å¯¹é½</strong></li>
<li>å‰©ä½™é€»è¾‘ä¸æ­£å¸¸å…³æœºçš„æ¢å¤æ–¹æ³•ç›¸ä¼¼</li>
</ul>
</li>
</ul>
<hr>
<h5 id="æœåŠ¡çº¿ç¨‹"><a href="#æœåŠ¡çº¿ç¨‹" class="headerlink" title="æœåŠ¡çº¿ç¨‹"></a>æœåŠ¡çº¿ç¨‹</h5><p>AppendMessageCallback æ¶ˆæ¯è¿½åŠ æœåŠ¡å®ç°ç±»ä¸º DefaultAppendMessageCallback</p>
<ul>
<li><p>doAppend()ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> AppendMessageResult <span class="title function_">doAppend</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>long wroteOffset = fileFromOffset + byteBuffer.position()</code>ï¼šæ¶ˆæ¯å†™å…¥çš„ä½ç½®ï¼Œç‰©ç†åç§»é‡ phyOffset</li>
<li><code>String msgId</code>ï¼š<strong>æ¶ˆæ¯ IDï¼Œè§„åˆ™æ˜¯å®¢æˆ·ç«¯ IP + æ¶ˆæ¯åç§»é‡ phyOffset</strong></li>
<li><code>byte[] topicData</code>ï¼šåºåˆ—åŒ–æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯çš„å­—æ®µå‹å…¥åˆ°  msgStoreItemMemory è¿™ä¸ª Buffer ä¸­</li>
<li><code>byteBuffer.put(this.msgStoreItemMemory.array(), 0, msgLen)</code>ï¼šå°† msgStoreItemMemory ä¸­çš„æ•°æ®å†™å…¥ MF å¯¹è±¡çš„å†…å­˜æ˜ å°„çš„ Buffer ä¸­ï¼Œæ•°æ®è¿˜æ²¡è½ç›˜</li>
<li><code>AppendMessageResult result</code>ï¼šæ„é€ ç»“æœå¯¹è±¡ï¼ŒåŒ…æ‹¬å­˜å‚¨ä½ç‚¹ã€æ˜¯å¦æˆåŠŸã€é˜Ÿåˆ—åç§»é‡ç­‰ä¿¡æ¯</li>
<li><code>CommitLog.this.topicQueueTable.put(key, ++queueOffset)</code>ï¼šæ›´æ–°é˜Ÿåˆ—åç§»é‡</li>
</ul>
</li>
</ul>
<p>FlushRealTimeService åˆ·ç›˜ CL æ•°æ®ï¼Œé»˜è®¤æ˜¯å¼‚æ­¥åˆ·ç›˜ç±» FlushRealTimeService</p>
<ul>
<li><p>run()ï¼šè¿è¡Œæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>while (!this.isStopped())</code>ï¼šstoppedä¸º true æ‰è·³å‡ºå¾ªç¯</p>
</li>
<li><p><code>boolean flushCommitLogTimed</code>ï¼šæ§åˆ¶çº¿ç¨‹çš„ä¼‘çœ æ–¹å¼ï¼Œé»˜è®¤æ˜¯ falseï¼Œä½¿ç”¨ <code>CountDownLatch.await()</code> ä¼‘çœ ï¼Œè®¾ç½®ä¸º true æ—¶ä½¿ç”¨ <code>Thread.sleep()</code> ä¼‘çœ </p>
</li>
<li><p><code>int interval</code>ï¼šè·å–é…ç½®ä¸­çš„åˆ·ç›˜æ—¶é—´é—´éš”</p>
</li>
<li><p><code>int flushPhysicQueueLeastPages</code>ï¼š<strong>è·å–æœ€å°åˆ·ç›˜é¡µæ•°ï¼Œé»˜è®¤æ˜¯ 4 é¡µ</strong>ï¼Œè„é¡µè¾¾åˆ°æŒ‡å®šé¡µæ•°æ‰åˆ·ç›˜</p>
</li>
<li><p><code>int flushPhysicQueueThoroughInterval</code>ï¼šè·å–å¼ºåˆ¶åˆ·ç›˜å‘¨æœŸï¼Œé»˜è®¤æ˜¯ 10 ç§’ï¼Œè¾¾åˆ°å‘¨æœŸåå¼ºåˆ¶åˆ·ç›˜ï¼Œä¸è€ƒè™‘è„é¡µ</p>
</li>
<li><p><code>if (flushCommitLogTimed)</code>ï¼š<strong>ä¼‘çœ é€»è¾‘</strong>ï¼Œé¿å… CPU å ç”¨å¤ªé•¿æ—¶é—´ï¼Œå¯¼è‡´æ— æ³•æ‰§è¡Œå…¶ä»–æ›´ç´§æ€¥çš„ä»»åŠ¡</p>
</li>
<li><p><code>CommitLog.this.mappedFileQueue.flush(flushPhysicQueueLeastPages)</code>ï¼š<strong>åˆ·ç›˜</strong></p>
</li>
<li><p><code>for (int i = 0; i &lt; RETRY_TIMES_OVER &amp;&amp; !result; i++)</code>ï¼šstopped åœæ­¢æ ‡è®°ä¸º true æ—¶ï¼Œéœ€è¦ç¡®ä¿æ‰€æœ‰çš„æ•°æ®éƒ½å·²ç»åˆ·ç›˜ï¼Œæ‰€ä»¥æ­¤å¤„å°è¯• 10 æ¬¡å¼ºåˆ¶åˆ·ç›˜ï¼Œ</p>
<p><code>result = CommitLog.this.mappedFileQueue.flush(0)</code>ï¼š<strong>å¼ºåˆ¶åˆ·ç›˜</strong></p>
</li>
</ul>
</li>
</ul>
<p>åŒæ­¥åˆ·ç›˜ç±» GroupCommitService</p>
<ul>
<li><p>run()ï¼šè¿è¡Œæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>while (!this.isStopped())</code>ï¼šstoppedä¸º true æ‰è·³å‡ºå¾ªç¯</p>
<p><code>this.waitForRunning(10)</code>ï¼šçº¿ç¨‹ä¼‘çœ  10 æ¯«ç§’ï¼Œæœ€åè°ƒç”¨ <code>onWaitEnd()</code> è¿›è¡Œ<strong>è¯·æ±‚çš„äº¤æ¢</strong> <code>swapRequests()</code></p>
<p><code>this.doCommit()</code>ï¼šåšæäº¤é€»è¾‘</p>
<ul>
<li><p><code>if (!this.requestsRead.isEmpty())</code>ï¼šè¯»è¯·æ±‚é›†åˆä¸ä¸ºç©º</p>
<p><code>for (GroupCommitRequest req : this.requestsRead)</code>ï¼šéå†æ‰€æœ‰çš„è¯»è¯·æ±‚ï¼Œè¯·æ±‚ä¸­çš„å±æ€§ï¼š</p>
<ul>
<li><code>private final long nextOffset</code>ï¼šæœ¬æ¡æ¶ˆæ¯å­˜å‚¨ä¹‹åï¼Œä¸‹ä¸€æ¡æ¶ˆæ¯å¼€å§‹çš„ offset</li>
<li><code>private CompletableFuture&lt;PutMessageStatus&gt; flushOKFuture</code>ï¼šFuture å¯¹è±¡</li>
</ul>
<p><code>boolean flushOK = ...</code>ï¼šå½“å‰è¯·æ±‚å…³æ³¨çš„æ•°æ®æ˜¯å¦å…¨éƒ¨è½ç›˜ï¼Œ<strong>è½ç›˜æˆåŠŸå”¤é†’æ¶ˆè´¹è€…çº¿ç¨‹</strong></p>
<p><code>for (int i = 0; i &lt; 2 &amp;&amp; !flushOK; i++)</code>ï¼šå°è¯•è¿›è¡Œä¸¤æ¬¡å¼ºåˆ¶åˆ·ç›˜ï¼Œä¿è¯åˆ·ç›˜æˆåŠŸ</p>
<p><code>CommitLog.this.mappedFileQueue.flush(0)</code>ï¼šå¼ºåˆ¶åˆ·ç›˜</p>
<p><code>req.wakeupCustomer(flushOK ? ...)</code>ï¼šè®¾ç½® Future ç»“æœï¼Œåœ¨ Future é˜»å¡çš„çº¿ç¨‹åœ¨è¿™é‡Œä¼šè¢«å”¤é†’</p>
<p><code>this.requestsRead.clear()</code>ï¼šæ¸…ç† reqeustsRead åˆ—è¡¨ï¼Œæ–¹ä¾¿äº¤æ¢æ—¶æˆä¸º requestsWrite ä½¿ç”¨</p>
</li>
<li><p><code>else</code>ï¼šè¯»è¯·æ±‚é›†åˆä¸ºç©º</p>
<p><code>CommitLog.this.mappedFileQueue.flush(0)</code>ï¼šå¼ºåˆ¶åˆ·ç›˜</p>
</li>
</ul>
</li>
<li><p><code>this.swapRequests()</code>ï¼šäº¤æ¢è¯»å†™è¯·æ±‚</p>
</li>
<li><p><code>this.doCommit()</code>ï¼šäº¤æ¢ååšä¸€æ¬¡æäº¤</p>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="ConsQueue"><a href="#ConsQueue" class="headerlink" title="ConsQueue"></a>ConsQueue</h4><h5 id="æˆå‘˜å±æ€§-4"><a href="#æˆå‘˜å±æ€§-4" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>ConsumerQueue æ˜¯æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯åœ¨ CommitLog çš„ç´¢å¼•ï¼Œä¾¿äºå¿«é€Ÿå®šä½æ¶ˆæ¯</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>æ•°æ®å•å…ƒï¼šConsumerQueueData æ•°æ®å•å…ƒçš„å›ºå®šå¤§å°æ˜¯ 20 å­—èŠ‚ï¼Œé»˜è®¤ç”³è¯· 20 å­—èŠ‚çš„ç¼“å†²åŒº</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CQ_STORE_UNIT_SIZE</span> <span class="operator">=</span> <span class="number">20</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ–‡ä»¶ç®¡ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MappedFileQueue mappedFileQueue;	<span class="comment">// æ–‡ä»¶ç®¡ç†å™¨ï¼Œç®¡ç† CQ ç›®å½•ä¸‹çš„æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String storePath;					<span class="comment">// ç›®å½•ï¼Œæ¯”å¦‚../store/consumequeue/xxx_topic/0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> mappedFileSize;				<span class="comment">// æ¯ä¸€ä¸ª CQ å­˜å‚¨æ–‡ä»¶å¤§å°ï¼Œé»˜è®¤ 20 * 30w = 600w byte</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å­˜å‚¨ä¸»æ¨¡å—ï¼šä¸Šå±‚çš„å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DefaultMessageStore defaultMessageStore;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆæ¯å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String topic;					<span class="comment">// CQ ä¸»é¢˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> queueId;					<span class="comment">// CQ é˜Ÿåˆ—ï¼Œæ¯ä¸€ä¸ªé˜Ÿåˆ—éƒ½æœ‰ä¸€ä¸ª ConsumeQueue å¯¹è±¡è¿›è¡Œç®¡ç†</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ByteBuffer byteBufferIndex;	<span class="comment">// ä¸´æ—¶ç¼“å†²åŒºï¼Œæ’æ–°çš„ CQData æ—¶ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="variable">maxPhysicOffset</span> <span class="operator">=</span> -<span class="number">1</span>;			<span class="comment">// å½“å‰ConsumeQueueå†…å­˜å‚¨çš„æœ€å¤§æ¶ˆæ¯ç‰©ç†åç§»é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">minLogicOffset</span> <span class="operator">=</span> <span class="number">0</span>;	<span class="comment">// å½“å‰ConsumeQueueå†…å­˜å‚¨çš„æœ€å°æ¶ˆæ¯ç‰©ç†åç§»é‡</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<ul>
<li><p>æœ‰å‚æ„é€ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConsumeQueue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ç”³è¯·äº†ä¸€ä¸ª 20 å­—èŠ‚å¤§å°çš„ ä¸´æ—¶ç¼“å†²åŒº</span></span><br><span class="line">    <span class="built_in">this</span>.byteBufferIndex = ByteBuffer.allocate(CQ_STORE_UNIT_SIZE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æˆå‘˜æ–¹æ³•-3"><a href="#æˆå‘˜æ–¹æ³•-3" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h5><p>ConsumeQueue å¯åŠ¨é˜¶æ®µæ–¹æ³•ï¼š</p>
<ul>
<li>load()ï¼šç¬¬ä¸€æ­¥ï¼ŒåŠ è½½ storePath ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œåˆå§‹åŒ– MappedFileQueue</li>
<li>recover()ï¼šç¬¬äºŒæ­¥ï¼Œæ¢å¤ ConsumeQueue æ•°æ®<ul>
<li>ä»å€’æ•°ç¬¬ä¸‰ä¸ª MF æ–‡ä»¶å¼€å§‹å‘åéå†ï¼Œä¾æ¬¡è¯»å– MF ä¸­ 20 ä¸ªå­—èŠ‚çš„ CQData æ•°æ®ï¼Œæ£€æŸ¥ offset å’Œ size æ˜¯å¦æ˜¯æœ‰æ•ˆæ•°æ®</li>
<li>æ‰¾åˆ°æ— æ•ˆçš„ CQData çš„ä½ç‚¹ï¼Œè¯¥ä½ç‚¹å°±æ˜¯ CQ çš„åˆ·ç›˜ç‚¹å’Œæ•°æ®é¡ºåºå†™å…¥ç‚¹</li>
<li>åˆ é™¤æ— æ•ˆçš„ MF æ–‡ä»¶ï¼Œè°ƒæ•´å½“å‰é¡ºåºå†™çš„ MF æ–‡ä»¶çš„æ•°æ®ä½ç‚¹</li>
</ul>
</li>
</ul>
<p>å…¶ä»–æ–¹æ³•ï¼š</p>
<ul>
<li><p>truncateDirtyLogicFiles()ï¼šCommitLog æ¢å¤é˜¶æ®µè°ƒç”¨ï¼Œå°† ConsumeQueue æœ‰æ•ˆæ•°æ®æ–‡ä»¶ä¸ CommitLog å¯¹é½ï¼Œå°†è¶…å‡ºéƒ¨åˆ†çš„æ•°æ®æ–‡åˆ é™¤æ‰ï¼Œå¹¶è°ƒæ•´å½“å‰æ–‡ä»¶çš„æ•°æ®ä½ç‚¹ã€‚Broker å¯åŠ¨é˜¶æ®µå…ˆæ¢å¤ CQ çš„æ•°æ®ï¼Œå†æ¢å¤ CL æ•°æ®ï¼Œä½†æ˜¯<strong>æ•°æ®è¦ä»¥ CL ä¸ºåŸºå‡†</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°æ˜¯æœ€å¤§æ¶ˆæ¯ç‰©ç†åç§»é‡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">truncateDirtyLogicFiles</span><span class="params">(<span class="type">long</span> phyOffet)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>flush()ï¼šåˆ·ç›˜ï¼Œè°ƒç”¨ MFQ çš„åˆ·ç›˜æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">flush</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> flushLeastPages)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>deleteExpiredFile()ï¼šåˆ é™¤è¿‡æœŸæ–‡ä»¶ï¼Œå°†å°äº offset çš„æ‰€æœ‰ MF æ–‡ä»¶åˆ é™¤ï¼Œoffset æ˜¯ CommitLog ç›®å½•ä¸‹æœ€å°çš„ç‰©ç†åç§»é‡ï¼Œå°äºè¯¥å€¼çš„ CL æ–‡ä»¶å·²ç»æ²¡æœ‰äº†ï¼Œæ‰€ä»¥ CQ ä¹Ÿæ²¡æœ‰å­˜åœ¨çš„å¿…è¦</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deleteExpiredFile</span><span class="params">(<span class="type">long</span> offset)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>putMessagePositionInfoWrapper()ï¼š<strong>å‘ CQ ä¸­è¿½åŠ  CQData æ•°æ®</strong>ï¼Œç”±å­˜å‚¨ä¸»æ¨¡å— DefaultMessageStore å†…éƒ¨çš„å¼‚æ­¥çº¿ç¨‹è°ƒç”¨ï¼Œè´Ÿè´£æ„å»º ConsumeQueue æ–‡ä»¶å’Œ Index æ–‡ä»¶çš„ï¼Œè¯¥çº¿ç¨‹ä¼šæŒç»­å…³æ³¨ CommitLog æ–‡ä»¶ï¼Œå½“ CommitLog æ–‡ä»¶å†…æœ‰æ–°æ•°æ®å†™å…¥ï¼Œå°±è¯»å‡ºæ¥å°è£…æˆ DispatchRequest å¯¹è±¡ï¼Œè½¬å‘ç»™ ConsumeQueue æˆ–è€… IndexService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putMessagePositionInfoWrapper</span><span class="params">(DispatchRequest request)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>getIndexBuffer()ï¼šè½¬æ¢ startIndex ä¸º offsetï¼Œè·å–åŒ…å«è¯¥ offset çš„ MappedFile æ–‡ä»¶ï¼Œè¯»å– <code>[offset%maxSize, mfPos]</code> èŒƒå›´çš„æ•°æ®ï¼ŒåŒ…è£…æˆç»“æœå¯¹è±¡è¿”å›</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SelectMappedBufferResult <span class="title function_">getIndexBuffer</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> startIndex)</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="IndexFile"><a href="#IndexFile" class="headerlink" title="IndexFile"></a>IndexFile</h4><h5 id="æˆå‘˜å±æ€§-5"><a href="#æˆå‘˜å±æ€§-5" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>IndexFile ç±»æˆå‘˜å±æ€§</p>
<ul>
<li><p>å“ˆå¸Œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">hashSlotSize</span> <span class="operator">=</span> <span class="number">4</span>;	<span class="comment">// æ¯ä¸ª hash æ¡¶çš„å¤§å°æ˜¯ 4 å­—èŠ‚ï¼Œã€ç”¨æ¥å­˜æ”¾ç´¢å¼•çš„ç¼–å·ã€‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> hashSlotNum;			<span class="comment">// hash æ¡¶çš„ä¸ªæ•°ï¼Œé»˜è®¤ 500 ä¸‡</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç´¢å¼•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">indexSize</span> <span class="operator">=</span> <span class="number">20</span>;		<span class="comment">// æ¯ä¸ª index æ¡ç›®çš„å¤§å°æ˜¯ 20 å­—èŠ‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">invalidIndex</span> <span class="operator">=</span> <span class="number">0</span>;	<span class="comment">// æ— æ•ˆç´¢å¼•ç¼–å·ï¼š0 ç‰¹æ®Šå€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> indexNum;				<span class="comment">// é»˜è®¤å€¼ï¼š2000w</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> IndexHeader indexHeader;	<span class="comment">// ç´¢å¼•å¤´</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ˜ å°„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MappedFile mappedFile;			<span class="comment">// ã€ç´¢å¼•æ–‡ä»¶ä½¿ç”¨çš„ MF æ–‡ä»¶ã€‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> FileChannel fileChannel;			<span class="comment">// æ–‡ä»¶é€šé“</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MappedByteBuffer mappedByteBuffer;<span class="comment">// ä» MF ä¸­è·å–çš„å†…å­˜æ˜ å°„ç¼“å†²åŒº</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<ul>
<li><p>æœ‰å‚æ„é€ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// endPhyOffset ä¸Šä¸ªç´¢å¼•æ–‡ä»¶ æœ€åä¸€æ¡æ¶ˆæ¯çš„ ç‰©ç†åç§»é‡</span></span><br><span class="line"><span class="comment">// endTimestamp ä¸Šä¸ªç´¢å¼•æ–‡ä»¶ æœ€åä¸€æ¡æ¶ˆæ¯çš„ å­˜å‚¨æ—¶é—´</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">IndexFile</span><span class="params">(<span class="keyword">final</span> String fileName, <span class="keyword">final</span> <span class="type">int</span> hashSlotNum, <span class="keyword">final</span> <span class="type">int</span> indexNum,</span></span><br><span class="line"><span class="params">                 <span class="keyword">final</span> <span class="type">long</span> endPhyOffset, <span class="keyword">final</span> <span class="type">long</span> endTimestamp)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// æ–‡ä»¶å¤§å° 40 + 500w * 4 + 2000w * 20</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">fileTotalSize</span> <span class="operator">=</span></span><br><span class="line">        IndexHeader.INDEX_HEADER_SIZE + (hashSlotNum * hashSlotSize) + (indexNum * indexSize);</span><br><span class="line">    <span class="comment">// åˆ›å»º mf å¯¹è±¡ï¼Œä¼šåœ¨diskä¸Šåˆ›å»ºæ–‡ä»¶</span></span><br><span class="line">    <span class="built_in">this</span>.mappedFile = <span class="keyword">new</span> <span class="title class_">MappedFile</span>(fileName, fileTotalSize);</span><br><span class="line">    <span class="comment">// åˆ›å»º ç´¢å¼•å¤´å¯¹è±¡ï¼Œä¼ é€’ ç´¢å¼•æ–‡ä»¶mf çš„åˆ‡ç‰‡æ•°æ®</span></span><br><span class="line">    <span class="built_in">this</span>.indexHeader = <span class="keyword">new</span> <span class="title class_">IndexHeader</span>(byteBuffer);</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æˆå‘˜æ–¹æ³•-4"><a href="#æˆå‘˜æ–¹æ³•-4" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h5><p>IndexFile ç±»æ–¹æ³•</p>
<ul>
<li><p>load()ï¼šåŠ è½½ IndexHeader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>flush()ï¼šMappedByteBuffer å†…çš„æ•°æ®å¼ºåˆ¶è½ç›˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flush</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>isWriteFull()ï¼šæ£€æŸ¥å½“å‰çš„ IndexFile å·²å†™ç´¢å¼•æ•°æ˜¯å¦ &gt;= indexNumï¼Œè¾¾åˆ°è¯¥å€¼åˆ™å½“å‰ IndexFile ä¸èƒ½ç»§ç»­è¿½åŠ  IndexData äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isWriteFull</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>destroy()ï¼šåˆ é™¤æ–‡ä»¶æ—¶ä½¿ç”¨çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">destroy</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> intervalForcibly)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>putKey()ï¼šæ·»åŠ ç´¢å¼•æ•°æ®ï¼Œè§£å†³å“ˆå¸Œå†²çªä½¿ç”¨<strong>å¤´æ’æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°ä¸€ï¼šæ¶ˆæ¯çš„ keyï¼Œuniq_key æˆ–è€… keys=&quot;aaa bbb ccc&quot; ä¼šåˆ†åˆ«ä¸º aaa bbb ccc åˆ›å»ºç´¢å¼•</span></span><br><span class="line"><span class="comment">// å‚æ•°äºŒï¼šæ¶ˆæ¯çš„ç‰©ç†åç§»é‡ï¼›  å‚æ•°ä¸‰ï¼šæ¶ˆæ¯å­˜å‚¨æ—¶é—´</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">putKey</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="type">long</span> phyOffset, <span class="keyword">final</span> <span class="type">long</span> storeTimestamp)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>int slotPos = keyHash % this.hashSlotNum</code>ï¼šå¯¹ key è®¡ç®—å“ˆå¸Œåï¼Œå–æ¨¡å¾—åˆ°å¯¹åº”çš„å“ˆå¸Œæ§½ slot ä¸‹æ ‡ï¼Œç„¶åè®¡ç®—å‡ºå“ˆå¸Œæ§½çš„å­˜å‚¨ä½ç½® absSlotPos</li>
<li><code>int slotValue = this.mappedByteBuffer.getInt(absSlotPos)</code>ï¼šè·å–æ§½ä¸­çš„å€¼ï¼Œå¦‚æœæ˜¯æ— æ•ˆå€¼è¯´æ˜æ²¡æœ‰å“ˆå¸Œå†²çª</li>
<li><code>timeDiff = timeDiff / 1000</code>ï¼šè®¡ç®—å½“å‰ msg å­˜å‚¨æ—¶é—´å‡å»ç´¢å¼•æ–‡ä»¶å†…ç¬¬ä¸€æ¡æ¶ˆæ¯å­˜å‚¨æ—¶é—´çš„å·®å€¼ï¼Œè½¬åŒ–ä¸ºç§’è¿›è¡Œå­˜å‚¨</li>
<li><code>int absIndexPos</code>ï¼šè®¡ç®—å½“å‰ç´¢å¼•æ•°æ®å­˜å‚¨çš„ä½ç½®ï¼Œå¼€å§‹å¡«å……ç´¢å¼•æ•°æ®åˆ°å¯¹åº”çš„ä½ç½®</li>
<li><code>this.mappedByteBuffer.putInt(absIndexPos + 4 + 8 + 4, slotValue)</code>ï¼š<strong>hash æ¡¶çš„åŸå€¼ï¼Œå¤´æ’æ³•</strong></li>
<li><code>this.mappedByteBuffer.putInt(absSlotPos, this.indexHeader...)</code>ï¼šåœ¨ slot æ”¾å…¥å½“å‰ç´¢å¼•çš„ç´¢å¼•ç¼–å·</li>
<li><code>if (this.indexHeader.getIndexCount() &lt;= 1)</code>ï¼šç´¢å¼•æ–‡ä»¶æ’å…¥çš„ç¬¬ä¸€æ¡æ•°æ®ï¼Œéœ€è¦è®¾ç½®èµ·å§‹åç§»é‡å’Œå­˜å‚¨æ—¶é—´</li>
<li><code>if (invalidIndex == slotValue)</code>ï¼šæ²¡æœ‰å“ˆå¸Œå†²çªï¼Œè¯´æ˜å ç”¨äº†ä¸€ä¸ªæ–°çš„ hash slot</li>
<li><code>this.indexHeader</code>ï¼šè®¾ç½®ç´¢å¼•å¤´çš„ç›¸å…³å±æ€§</li>
</ul>
</li>
<li><p>selectPhyOffset()ï¼šä»ç´¢å¼•æ–‡ä»¶æŸ¥è¯¢æ¶ˆæ¯çš„ç‰©ç†åç§»é‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°ä¸€ï¼šæŸ¥è¯¢ç»“æœå…¨éƒ¨æ”¾åˆ°è¯¥listå†…ï¼› å‚æ•°äºŒï¼šæŸ¥è¯¢keyï¼› å‚æ•°ä¸‰ï¼šç»“æœæœ€å¤§æ•°é™åˆ¶ï¼› å‚æ•°å››äº”ï¼šæ—¶é—´èŒƒå›´</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">selectPhyOffset</span><span class="params">(<span class="keyword">final</span> List&lt;Long&gt; phyOffsets, <span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="type">int</span> maxNum,<span class="keyword">final</span> <span class="type">long</span> begin, <span class="keyword">final</span> <span class="type">long</span> end, <span class="type">boolean</span> lock)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>if (this.mappedFile.hold())</code>ï¼š MF çš„å¼•ç”¨è®°æ•° +1ï¼ŒæŸ¥è¯¢æœŸé—´ MF èµ„æº<strong>ä¸èƒ½è¢«é‡Šæ”¾</strong></li>
<li><code>int slotValue = this.mappedByteBuffer.getInt(absSlotPos)</code>ï¼šè·å–æ§½ä¸­çš„å€¼ï¼Œå¯èƒ½æ˜¯æ— æ•ˆå€¼æˆ–è€…ç´¢å¼•ç¼–å·ï¼Œå¦‚æœæ˜¯æ— æ•ˆå€¼è¯´æ˜æŸ¥è¯¢æœªå‘½ä¸­</li>
<li><code>int absIndexPos</code>ï¼šè®¡ç®—å‡ºç´¢å¼•ç¼–å·å¯¹åº”ç´¢å¼•æ•°æ®çš„å¼€å§‹ä½ç‚¹</li>
<li><code>this.mappedByteBuffer</code>ï¼šè¯»å–ç´¢å¼•æ•°æ®</li>
<li><code>long timeRead = this.indexHeader.getBeginTimestamp() + timeDiff</code>ï¼šè®¡ç®—å‡ºå‡†ç¡®çš„å­˜å‚¨æ—¶é—´</li>
<li><code>boolean timeMatched = (timeRead &gt;= begin) &amp;&amp; (timeRead &lt;= end)</code>ï¼šæ—¶é—´èŒƒå›´çš„åŒ¹é…</li>
<li><code>phyOffsets.add(phyOffsetRead)</code>ï¼šå°†å‘½ä¸­çš„æ¶ˆæ¯ç´¢å¼•çš„æ¶ˆæ¯åç§»é‡åŠ å…¥åˆ° list é›†åˆä¸­</li>
<li><code>nextIndexToRead = prevIndexRead</code>ï¼šéå†å‰é©±èŠ‚ç‚¹</li>
</ul>
</li>
</ul>
<hr>
<h4 id="IndexServ"><a href="#IndexServ" class="headerlink" title="IndexServ"></a>IndexServ</h4><h5 id="æˆå‘˜å±æ€§-6"><a href="#æˆå‘˜å±æ€§-6" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>IndexService ç±»ç”¨æ¥ç®¡ç† IndexFile æ–‡ä»¶</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>å­˜å‚¨ä¸»æ¨¡å—ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DefaultMessageStore defaultMessageStore;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç´¢å¼•æ–‡ä»¶å­˜å‚¨ç›®å½•ï¼š<code>../store/index</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String storePath;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç´¢å¼•å¯¹è±¡é›†åˆï¼šç›®å½•ä¸‹çš„æ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ª IndexFile å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;IndexFile&gt; indexFileList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;IndexFile&gt;();</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç´¢å¼•æ–‡ä»¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> hashSlotNum;		<span class="comment">// æ¯ä¸ªç´¢å¼•æ–‡ä»¶åŒ…å«çš„ å“ˆå¸Œæ¡¶æ•°é‡ ï¼š500w</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> indexNum;			<span class="comment">// æ¯ä¸ªç´¢å¼•æ–‡ä»¶åŒ…å«çš„ ç´¢å¼•æ¡ç›®æ•°é‡ ï¼š2000w</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æˆå‘˜æ–¹æ³•-5"><a href="#æˆå‘˜æ–¹æ³•-5" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h5><ul>
<li><p>load()ï¼šåŠ è½½ storePath ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºä¸€ä¸ª IndexFile å®ä¾‹å¯¹è±¡ï¼Œå¹¶åŠ è½½ IndexHeader ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">load</span><span class="params">(<span class="keyword">final</span> <span class="type">boolean</span> lastExitOK)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>deleteExpiredFile()ï¼šåˆ é™¤è¿‡æœŸç´¢å¼•æ–‡ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•° offset è¡¨ç¤º CommitLog å†…æœ€æ—©çš„æ¶ˆæ¯çš„ phyOffset</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteExpiredFile</span><span class="params">(<span class="type">long</span> offset)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>this.readWriteLock.readLock().lock()</code>ï¼šåŠ é”åˆ¤æ–­</li>
<li><code>long endPhyOffset = this.indexFileList.get(0).getEndPhyOffset()</code>ï¼šè·å–ç›®å½•ä¸­ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ç»“æŸåç§»é‡</li>
<li><code>if (endPhyOffset &lt; offset)</code>ï¼šç´¢å¼•ç›®å½•å†…å­˜åœ¨è¿‡æœŸçš„ç´¢å¼•æ–‡ä»¶ï¼Œå¹¶ä¸”å½“å‰çš„ IndexFile éƒ½æ˜¯è¿‡æœŸçš„æ•°æ®</li>
<li><code>for (int i = 0; i &lt; (files.length - 1); i++)</code>ï¼šéå†æ–‡ä»¶åˆ—è¡¨ï¼Œåˆ é™¤è¿‡æœŸçš„æ–‡ä»¶</li>
</ul>
</li>
<li><p>buildIndex()ï¼šå­˜å‚¨ä¸»æ¨¡å— DefaultMessageStore å†…éƒ¨çš„å¼‚æ­¥çº¿ç¨‹è°ƒç”¨ï¼Œæ„å»º Index æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">buildIndex</span><span class="params">(DispatchRequest req)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>indexFile = retryGetAndCreateIndexFile()</code>ï¼šè·å–æˆ–è€…åˆ›å»ºé¡ºåºå†™çš„ç´¢å¼•æ–‡ä»¶å¯¹è±¡</p>
</li>
<li><p><code>buildKey(topic, req.getUniqKey())</code>ï¼š<strong>æ„å»ºç´¢å¼• keyï¼Œ<code>topic + # + uniqKey</code></strong></p>
</li>
<li><p><code>indexFile = putKey()</code>ï¼šæ’å…¥ç´¢å¼•æ–‡ä»¶</p>
</li>
<li><p><code>if (keys != null &amp;&amp; keys.length() &gt; 0)</code>ï¼šæ¶ˆæ¯å­˜åœ¨è‡ªå®šä¹‰ç´¢å¼• keys</p>
<p><code>for (int i = 0; i &lt; keyset.length; i++)</code>ï¼šéå†æ¯ä¸ªç´¢å¼•ï¼Œä¸ºæ¯ä¸ª key è°ƒç”¨ä¸€æ¬¡ putKey</p>
</li>
</ul>
</li>
<li><p>getAndCreateLastIndexFile()ï¼šè·å–å½“å‰é¡ºåºå†™çš„ IndexFileï¼Œæ²¡æœ‰å°±åˆ›å»º</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> IndexFile <span class="title function_">getAndCreateLastIndexFile</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="HAService"><a href="#HAService" class="headerlink" title="HAService"></a>HAService</h4><h5 id="HAService-1"><a href="#HAService-1" class="headerlink" title="HAService"></a>HAService</h5><h6 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h6><p>HAService ç±»æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>ä¸»èŠ‚ç‚¹å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// master èŠ‚ç‚¹å½“å‰æœ‰å¤šå°‘ä¸ª slave èŠ‚ç‚¹ä¸å…¶è¿›è¡Œæ•°æ®åŒæ­¥</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">connectionCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// master èŠ‚ç‚¹ä¼šç»™æ¯ä¸ªå‘èµ·è¿æ¥çš„ slave èŠ‚ç‚¹çš„é€šé“åˆ›å»ºä¸€ä¸ª HAConnectionï¼Œã€æ§åˆ¶ master ç«¯å‘ slave ç«¯ä¼ è¾“æ•°æ®ã€‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;HAConnection&gt; connectionList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"><span class="comment">// master å‘ slave èŠ‚ç‚¹æ¨é€çš„æœ€å¤§çš„ offsetï¼Œè¡¨ç¤ºæ•°æ®åŒæ­¥çš„è¿›åº¦</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">push2SlaveMaxOffset</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>å†…éƒ¨ç±»å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°è£…äº†ç»‘å®šæœåŠ¡å™¨æŒ‡å®šç«¯å£ï¼Œç›‘å¬ slave çš„è¿æ¥çš„é€»è¾‘ï¼Œæ²¡æœ‰ä½¿ç”¨ Nettyï¼Œä½¿ç”¨äº†åŸç”Ÿæ€çš„ NIO å»åš</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AcceptSocketService acceptSocketService;</span><br><span class="line"><span class="comment">// æ§åˆ¶ç”Ÿäº§è€…çº¿ç¨‹é˜»å¡ç­‰å¾…çš„é€»è¾‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> GroupTransferService groupTransferService;</span><br><span class="line"><span class="comment">// slave èŠ‚ç‚¹çš„å®¢æˆ·ç«¯å¯¹è±¡ï¼Œã€slave ç«¯æ‰ä¼šæ­£å¸¸è¿è¡Œè¯¥å®ä¾‹ã€‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HAClient haClient;</span><br></pre></td></tr></table></figure>
</li>
<li><p>çº¿ç¨‹é€šä¿¡å¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">WaitNotifyObject</span> <span class="variable">waitNotifyObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WaitNotifyObject</span>()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æˆå‘˜æ–¹æ³•ï¼š</p>
<ul>
<li><p>start()ï¼šå¯åŠ¨é«˜å¯ç”¨æœåŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// ç›‘å¬ä»èŠ‚ç‚¹</span></span><br><span class="line">    <span class="built_in">this</span>.acceptSocketService.beginAccept();</span><br><span class="line">    <span class="comment">// å¯åŠ¨ç›‘å¬æœåŠ¡</span></span><br><span class="line">    <span class="built_in">this</span>.acceptSocketService.start();</span><br><span class="line">    <span class="comment">// å¯åŠ¨è½¬ç§»æœåŠ¡</span></span><br><span class="line">    <span class="built_in">this</span>.groupTransferService.start();</span><br><span class="line">    <span class="comment">// å¯åŠ¨ä»èŠ‚ç‚¹å®¢æˆ·ç«¯å®ä¾‹</span></span><br><span class="line">    <span class="built_in">this</span>.haClient.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h6 id="Accept"><a href="#Accept" class="headerlink" title="Accept"></a>Accept</h6><p>AcceptSocketService ç±»ç”¨äº<strong>ç›‘å¬ä»èŠ‚ç‚¹çš„è¿æ¥</strong>ï¼Œåˆ›å»º HAConnection è¿æ¥å¯¹è±¡</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>ç«¯å£ä¿¡æ¯ï¼šMaster ç»‘å®šç›‘å¬çš„ç«¯å£ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SocketAddress socketAddressListen;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æœåŠ¡ç«¯é€šé“ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ServerSocketChannel serverSocketChannel;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¤šè·¯å¤ç”¨å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Selector selector;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æˆå‘˜æ–¹æ³•ï¼š</p>
<ul>
<li><p>beginAccept()ï¼šå¼€å§‹ç›‘å¬è¿æ¥ï¼Œ<strong>NIO</strong> æ ‡å‡†æ¨¡æ¿</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beginAccept</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>run()ï¼šæœåŠ¡å¯åŠ¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>this.selector.select(1000)</code>ï¼šå¤šè·¯å¤ç”¨å™¨é˜»å¡è·å–å°±ç»ªçš„é€šé“ï¼Œæœ€å¤šç­‰å¾… 1 ç§’é’Ÿ</li>
<li><code>Set&lt;SelectionKey&gt; selected = this.selector.selectedKeys()</code>ï¼šè·å–é€‰æ‹©å™¨ä¸­æ‰€æœ‰æ³¨å†Œçš„é€šé“ä¸­å·²ç»å°±ç»ªå¥½çš„äº‹ä»¶</li>
<li><code>for (SelectionKey k : selected)</code>ï¼šéå†æ‰€æœ‰å°±ç»ªçš„äº‹ä»¶</li>
<li><code>if ((k.readyOps() &amp; SelectionKey.OP_ACCEPT) != 0)</code>ï¼šè¯´æ˜ <code>OP_ACCEPT</code> äº‹ä»¶å°±ç»ª</li>
<li><code>SocketChannel sc = ((ServerSocketChannel) k.channel()).accept()</code>ï¼š<strong>è·å–åˆ°å®¢æˆ·ç«¯è¿æ¥çš„é€šé“</strong></li>
<li><code>HAConnection conn = new HAConnection(HAService.this, sc)</code>ï¼š<strong>ä¸ºæ¯ä¸ªè¿æ¥ master æœåŠ¡å™¨çš„ slave åˆ›å»ºè¿æ¥å¯¹è±¡</strong></li>
<li><code>conn.start()</code>ï¼š<strong>å¯åŠ¨ HAConnection å¯¹è±¡</strong>ï¼Œå†…éƒ¨å¯åŠ¨ä¸¤ä¸ªæœåŠ¡ä¸ºè¯»æ•°æ®æœåŠ¡ã€å†™æ•°æ®æœåŠ¡</li>
<li><code>HAService.this.addConnection(conn)</code>ï¼šåŠ å…¥åˆ° HAConnection é›†åˆå†…</li>
</ul>
</li>
</ul>
<hr>
<h6 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h6><p>GroupTransferService ç”¨æ¥æ§åˆ¶æ•°æ®åŒæ­¥</p>
<p>æˆå‘˜æ–¹æ³•ï¼š</p>
<ul>
<li><p>doWaitTransfer()ï¼šç­‰å¾…ä¸»ä»æ•°æ®åŒæ­¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doWaitTransfer</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>if (!this.requestsRead.isEmpty())</code>ï¼šè¯»è¯·æ±‚ä¸ä¸ºç©º</li>
<li><code>boolean transferOK = HAService.this.push2SlaveMaxOffset... &gt;= req.getNextOffset()</code>ï¼š<strong>ä¸»ä»åŒæ­¥æ˜¯å¦å®Œæˆ</strong></li>
<li><code>req.wakeupCustomer(transferOK ? ...)</code>ï¼šå”¤é†’æ¶ˆè´¹è€…</li>
<li><code>this.requestsRead.clear()</code>ï¼šæ¸…ç©ºè¯»è¯·æ±‚</li>
</ul>
</li>
<li><p>swapRequests()ï¼šäº¤æ¢è¯»å†™è¯·æ±‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">swapRequests</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="HAClient"><a href="#HAClient" class="headerlink" title="HAClient"></a>HAClient</h5><h6 id="æˆå‘˜å±æ€§-7"><a href="#æˆå‘˜å±æ€§-7" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h6><p>HAClient æ˜¯ slave ç«¯è¿è¡Œçš„ä»£ç ï¼Œç”¨äº<strong>å’Œ master æœåŠ¡å™¨å»ºç«‹é•¿è¿æ¥</strong>ï¼Œä¸ŠæŠ¥æœ¬åœ°åŒæ­¥è¿›åº¦ï¼Œæ¶ˆè´¹æœåŠ¡å™¨å‘æ¥çš„ msg æ•°æ®</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>ç¼“å†²åŒºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">READ_MAX_BUFFER_SIZE</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">4</span>;	<span class="comment">// é»˜è®¤å¤§å°ï¼š4 MB</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">ByteBuffer</span> <span class="variable">byteBufferRead</span> <span class="operator">=</span> ByteBuffer.allocate(READ_MAX_BUFFER_SIZE);</span><br><span class="line"><span class="keyword">private</span> <span class="type">ByteBuffer</span> <span class="variable">byteBufferBackup</span> <span class="operator">=</span> ByteBuffer.allocate(READ_MAX_BUFFER_SIZE);</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸»èŠ‚ç‚¹åœ°å€ï¼šæ ¼å¼ä¸º <code>ip:port</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;String&gt; masterAddress = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;()</span><br></pre></td></tr></table></figure>
</li>
<li><p>NIO å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ByteBuffer reportOffset;	<span class="comment">// é€šä¿¡ä½¿ç”¨NIOï¼Œæ‰€ä»¥æ¶ˆæ¯ä½¿ç”¨å—ä¼ è¾“ï¼Œä¸ŠæŠ¥ slave offset ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">private</span> SocketChannel socketChannel;	<span class="comment">// å®¢æˆ·ç«¯ä¸ master çš„ä¼šè¯é€šé“				</span></span><br><span class="line"><span class="keyword">private</span> Selector selector;				<span class="comment">// å¤šè·¯å¤ç”¨å™¨</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>é€šä¿¡æ—¶é—´ï¼šä¸Šæ¬¡ä¼šè¯é€šä¿¡æ—¶é—´ï¼Œç”¨äºæ§åˆ¶ socketChannel æ˜¯å¦å…³é—­çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="variable">lastWriteTimestamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br></pre></td></tr></table></figure>
</li>
<li><p>è¿›åº¦ä¿¡æ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="variable">currentReportedOffset</span> <span class="operator">=</span> <span class="number">0</span>;	<span class="comment">// slave å½“å‰çš„è¿›åº¦ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">dispatchPosition</span> <span class="operator">=</span> <span class="number">0</span>;		<span class="comment">// æ§åˆ¶ byteBufferRead position æŒ‡é’ˆ</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h6 id="æˆå‘˜æ–¹æ³•-6"><a href="#æˆå‘˜æ–¹æ³•-6" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h6><ul>
<li><p>run()ï¼šå¯åŠ¨æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>if (this.connectMaster())</code>ï¼šè¿æ¥ä¸»èŠ‚ç‚¹ï¼Œè¿æ¥å¤±è´¥ä¼šä¼‘çœ  5 ç§’</p>
<ul>
<li><code>String addr = this.masterAddress.get()</code>ï¼šè·å– master æš´éœ²çš„ HA åœ°å€ç«¯å£ä¿¡æ¯</li>
<li><code>this.socketChannel = RemotingUtil.connect(socketAddress)</code>ï¼šå»ºç«‹è¿æ¥</li>
<li><code>this.socketChannel.register(this.selector, SelectionKey.OP_READ)</code>ï¼šæ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ï¼Œ<strong>å…³æ³¨è¯»äº‹ä»¶</strong></li>
<li><code>this.currentReportedOffset</code>ï¼š åˆå§‹åŒ–ä¸ŠæŠ¥è¿›åº¦å­—æ®µä¸º slave çš„ maxPhyOffset</li>
</ul>
</li>
<li><p><code>if (this.isTimeToReportOffset())</code>ï¼šslave æ¯ 5 ç§’ä¼šä¸ŠæŠ¥ä¸€æ¬¡ slave ç«¯çš„åŒæ­¥è¿›åº¦ä¿¡æ¯ç»™ master</p>
<p><code>boolean result = this.reportSlaveMaxOffset()</code>ï¼š<strong>ä¸ŠæŠ¥åŒæ­¥ä¿¡æ¯</strong>ï¼Œä¸ŠæŠ¥å¤±è´¥å…³é—­è¿æ¥</p>
</li>
<li><p><code>this.selector.select(1000)</code>ï¼šå¤šè·¯å¤ç”¨å™¨é˜»å¡è·å–å°±ç»ªçš„é€šé“ï¼Œæœ€å¤šç­‰å¾… 1 ç§’é’Ÿï¼Œ<strong>è·å–åˆ°å°±ç»ªäº‹ä»¶æˆ–è€…è¶…æ—¶åç»“æŸ</strong></p>
</li>
<li><p><code>boolean ok = this.processReadEvent()</code>ï¼šå¤„ç†è¯»äº‹ä»¶</p>
</li>
<li><p><code>if (!reportSlaveMaxOffsetPlus())</code>ï¼šæ£€æŸ¥æ˜¯å¦é‡æ–°ä¸ŠæŠ¥åŒæ­¥è¿›åº¦</p>
</li>
</ul>
</li>
<li><p>reportSlaveMaxOffset()ï¼šä¸ŠæŠ¥ slave åŒæ­¥è¿›åº¦</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">reportSlaveMaxOffset</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> maxOffset)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>é¦–å…ˆå‘ç¼“å†²åŒºå†™å…¥ slave ç«¯æœ€å¤§åç§»é‡ï¼Œå†™å®Œä»¥ååˆ‡æ¢ä¸ºæŒ‡å®šç½®ä¸ºåˆå§‹çŠ¶æ€</p>
</li>
<li><p><code>for (int i = 0; i &lt; 3 &amp;&amp; this.reportOffset.hasRemaining(); i++)</code>ï¼šå°è¯•ä¸‰æ¬¡å†™æ•°æ®</p>
<p><code>this.socketChannel.write(this.reportOffset)</code>ï¼š<strong>å†™æ•°æ®</strong></p>
</li>
<li><p><code>return !this.reportOffset.hasRemaining()</code>ï¼šå†™æˆåŠŸä¹‹å pos = limit</p>
</li>
</ul>
</li>
<li><p>processReadEvent()ï¼šå¤„ç† master å‘é€ç»™ slave æ•°æ®ï¼Œè¿”å› true è¡¨ç¤ºå¤„ç†æˆåŠŸ   false è¡¨ç¤º Socket å¤„äºåŠå…³é—­çŠ¶æ€ï¼Œéœ€è¦ä¸Šå±‚é‡å»º haClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">processReadEvent</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>int readSizeZeroTimes = 0</code>ï¼šæ§åˆ¶ while å¾ªç¯çš„ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œå½“å€¼ä¸º 3 æ—¶è·³å‡ºå¾ªç¯</p>
</li>
<li><p><code>while (this.byteBufferRead.hasRemaining())</code>ï¼šbyteBufferRead æœ‰ç©ºé—´å¯ä»¥å» Socket è¯»ç¼“å†²åŒºåŠ è½½æ•°æ®</p>
</li>
<li><p><code>int readSize = this.socketChannel.read(this.byteBufferRead)</code>ï¼š<strong>ä»é€šé“è¯»æ•°æ®</strong></p>
</li>
<li><p><code>if (readSize &gt; 0)</code>ï¼šåŠ è½½æˆåŠŸï¼Œæœ‰æ–°æ•°æ®</p>
<p><code>readSizeZeroTimes = 0</code>ï¼šç½®ä¸º 0</p>
<p><code>boolean result = this.dispatchReadRequest()</code>ï¼šå¤„ç†æ•°æ®çš„æ ¸å¿ƒé€»è¾‘</p>
</li>
<li><p><code>else if (readSize == 0)</code>ï¼šè¿ç»­æ— æ–°æ•°æ® 3 æ¬¡ï¼Œè·³å‡ºå¾ªç¯</p>
</li>
<li><p><code>else</code>ï¼šreadSize = -1 å°±è¡¨ç¤º Socket å¤„äºåŠå…³é—­çŠ¶æ€ï¼Œå¯¹ç«¯å·²ç»å…³é—­äº†</p>
</li>
</ul>
</li>
<li><p>dispatchReadRequest()ï¼š<strong>å¤„ç†æ•°æ®çš„æ ¸å¿ƒé€»è¾‘</strong>ï¼Œmaster ä¸ slave ä¼ è¾“çš„æ•°æ®æ ¼å¼ <code>&#123;[phyOffset][size][data...]&#125;</code>ï¼ŒphyOffset è¡¨ç¤ºæ•°æ®åŒºé—´çš„å¼€å§‹åç§»é‡ï¼Œdata ä»£è¡¨æ•°æ®å—ï¼Œæœ€å¤§ 32kbï¼Œå¯èƒ½åŒ…å«å¤šæ¡æ¶ˆæ¯çš„æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">dispatchReadRequest</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>final int msgHeaderSize = 8 + 4</code>ï¼šåè®®å¤´å¤§å° 12</p>
</li>
<li><p><code>int readSocketPos = this.byteBufferRead.position()</code>ï¼šè®°å½•ç¼“å†²åŒºå¤„ç†æ•°æ®å‰çš„ pos ä½ç‚¹ï¼Œç”¨äºæ¢å¤æŒ‡é’ˆ</p>
</li>
<li><p><code>int diff = ...</code>ï¼šå½“å‰ byteBufferRead è¿˜å‰©å¤šå°‘ byte æœªå¤„ç†ï¼Œæ¯å¤„ç†ä¸€æ¡å¸§æ•°æ®éƒ½ä¼šæ›´æ–° dispatchPosition</p>
</li>
<li><p><code>if (diff &gt;= msgHeaderSize)</code>ï¼šç¼“å†²åŒºè¿˜æœ‰å®Œæ•´çš„åè®®å¤´ header æ•°æ®</p>
</li>
<li><p><code>if (diff &gt;= (msgHeaderSize + bodySize))</code>ï¼šè¯´æ˜<strong>ç¼“å†²åŒºå†…æ˜¯åŒ…å«å½“å‰å¸§çš„å…¨éƒ¨æ•°æ®çš„</strong>ï¼Œå¼€å§‹å¤„ç†å¸§æ•°æ® </p>
<p><code>HAService...appendToCommitLog(masterPhyOffset, bodyData)</code>ï¼š<strong>å­˜å‚¨æ•°æ®åˆ° CommitLog</strong>ï¼Œå¹¶æ„å»º Index å’Œ CQ</p>
<p><code>this.byteBufferRead.position(readSocketPos)</code>ï¼šæ¢å¤ byteBufferRead çš„ pos æŒ‡é’ˆ</p>
<p><code>this.dispatchPosition += msgHeaderSize + bodySize</code>ï¼šåŠ ä¸€å¸§æ•°æ®é•¿åº¦ï¼Œå¤„ç†ä¸‹ä¸€æ¡æ•°æ®ä½¿ç”¨</p>
<p><code>if (!reportSlaveMaxOffsetPlus())</code>ï¼šä¸ŠæŠ¥ slave åŒæ­¥ä¿¡æ¯</p>
</li>
<li><p><code>if (!this.byteBufferRead.hasRemaining())</code>ï¼šç¼“å†²åŒºå†™æ»¡äº†ï¼Œé‡æ–°åˆ†é…ç¼“å†²åŒº</p>
</li>
</ul>
</li>
<li><p>reallocateByteBuffer()ï¼šé‡æ–°åˆ†é…ç¼“å†²åŒº</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reallocateByteBuffer</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>int remain = READ_MAX_BUFFER_SIZE - this.dispatchPosition</code>ï¼šè¡¨ç¤ºç¼“å†²åŒºå°šæœªå¤„ç†è¿‡çš„å­—èŠ‚æ•°é‡</p>
</li>
<li><p><code>if (remain &gt; 0)</code>ï¼šæ¡ä»¶æˆç«‹ï¼Œè¯´æ˜ç¼“å†²åŒº<strong>æœ€åä¸€å¸§æ•°æ®æ˜¯åŠåŒ…æ•°æ®</strong>ï¼Œä½†æ˜¯ä¸èƒ½ä¸¢å¤±æ•°æ®</p>
<p><code>this.byteBufferBackup.put(this.byteBufferRead)</code>ï¼š<strong>å°†åŠåŒ…æ•°æ®æ‹·è´åˆ° backup ç¼“å†²åŒº</strong></p>
</li>
<li><p><code>this.swapByteBuffer()</code>ï¼šäº¤æ¢ backup æˆä¸º read</p>
</li>
<li><p><code>this.byteBufferRead.position(remain)</code>ï¼šè®¾ç½® pos ä¸º remain ï¼Œåç»­åŠ è½½æ•°æ® pos ä»remain å¼€å§‹å‘åç§»åŠ¨</p>
</li>
<li><p><code>this.dispatchPosition = 0</code>ï¼šå½“å‰ç¼“å†²åŒºäº¤æ¢ä¹‹åï¼Œç›¸å½“äºæ˜¯ä¸€ä¸ªå…¨æ–°çš„ byteBufferï¼Œæ‰€ä»¥åˆ†é…æŒ‡é’ˆå½’é›¶</p>
</li>
</ul>
</li>
</ul>
<hr>
<h5 id="HAConn"><a href="#HAConn" class="headerlink" title="HAConn"></a>HAConn</h5><h6 id="Connection"><a href="#Connection" class="headerlink" title="Connection"></a>Connection</h6><p>HAConnection ç±»æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>ä¼šè¯é€šé“ï¼šmaster å’Œ slave ä¹‹é—´é€šä¿¡çš„ SocketChannel </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SocketChannel socketChannel;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®¢æˆ·ç«¯åœ°å€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String clientAddr;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æœåŠ¡ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> WriteSocketService writeSocketService;	<span class="comment">// å†™æ•°æ®æœåŠ¡</span></span><br><span class="line"><span class="keyword">private</span> ReadSocketService readSocketService;	<span class="comment">// è¯»æ•°æ®æœåŠ¡</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>è¯·æ±‚ä½ç‚¹ï¼šåœ¨ slave ä¸ŠæŠ¥æœ¬åœ°çš„è¿›åº¦ä¹‹åè¢«èµ‹å€¼ï¼Œè¯¥å€¼å¤§äº 0 ååŒæ­¥é€»è¾‘æ‰ä¼šè¿è¡Œï¼Œmaster å¦‚æœä¸çŸ¥é“ slave èŠ‚ç‚¹å½“å‰æ¶ˆæ¯çš„å­˜å‚¨è¿›åº¦ï¼Œå°±æ— æ³•ç»™ slave æ¨é€æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">slaveRequestOffset</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>åº”ç­”ä½ç‚¹ï¼š ä¿å­˜æœ€æ–°çš„ slave ä¸ŠæŠ¥çš„ offset ä¿¡æ¯ï¼ŒslaveAckOffset ä¹‹å‰çš„æ•°æ®éƒ½å¯ä»¥è®¤ä¸º slave å·²ç»åŒæ­¥å®Œæˆ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">slaveAckOffset</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li><p>æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">HAConnection</span><span class="params">(<span class="keyword">final</span> HAService haService, <span class="keyword">final</span> SocketChannel socketChannel)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ä¸€äº›ä¸œè¥¿</span></span><br><span class="line">    <span class="comment">// è®¾ç½® socket è¯»å†™ç¼“å†²åŒºä¸º 64kb å¤§å°</span></span><br><span class="line">    <span class="built_in">this</span>.socketChannel.socket().setReceiveBufferSize(<span class="number">1024</span> * <span class="number">64</span>);</span><br><span class="line">    <span class="built_in">this</span>.socketChannel.socket().setSendBufferSize(<span class="number">1024</span> * <span class="number">64</span>);</span><br><span class="line">    <span class="comment">// åˆ›å»ºè¯»å†™æœåŠ¡</span></span><br><span class="line">    <span class="built_in">this</span>.writeSocketService = <span class="keyword">new</span> <span class="title class_">WriteSocketService</span>(<span class="built_in">this</span>.socketChannel);</span><br><span class="line">    <span class="built_in">this</span>.readSocketService = <span class="keyword">new</span> <span class="title class_">ReadSocketService</span>(<span class="built_in">this</span>.socketChannel);</span><br><span class="line">    <span class="comment">// è‡ªå¢</span></span><br><span class="line">    <span class="built_in">this</span>.haService.getConnectionCount().incrementAndGet();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.readSocketService.start();</span><br><span class="line">    <span class="built_in">this</span>.writeSocketService.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h6 id="ReadSocket"><a href="#ReadSocket" class="headerlink" title="ReadSocket"></a>ReadSocket</h6><p>ReadSocketService ç±»æ˜¯ä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œslave å‘ master ä¼ è¾“çš„å¸§æ ¼å¼ä¸º <code>[long][long][long]</code>ï¼Œä¸ŠæŠ¥çš„æ˜¯ slave æœ¬åœ°çš„åŒæ­¥è¿›åº¦ï¼ŒåŒæ­¥è¿›åº¦æ˜¯ä¸€ä¸ª long å€¼</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>è¯»ç¼“å†²ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">READ_MAX_BUFFER_SIZE</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span>;	<span class="comment">// é»˜è®¤å¤§å° 1MB</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ByteBuffer</span> <span class="variable">byteBufferRead</span> <span class="operator">=</span> ByteBuffer.allocate(READ_MAX_BUFFER_SIZE);</span><br></pre></td></tr></table></figure>
</li>
<li><p>NIO å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Selector selector;			<span class="comment">// å¤šè·¯å¤ç”¨å™¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SocketChannel socketChannel;	<span class="comment">// master ä¸ slave ä¹‹é—´çš„ä¼šè¯ SocketChannel</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¤„ç†ä½ç‚¹ï¼šç¼“å†²åŒºå¤„ç†ä½ç‚¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">processPosition</span> <span class="operator">=</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸Šæ¬¡è¯»æ“ä½œçš„æ—¶é—´ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">lastReadTimestamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li><p>æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ReadSocketService</span><span class="params">(<span class="keyword">final</span> SocketChannel socketChannel)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>this.socketChannel.register(this.selector, SelectionKey.OP_READ)</code>ï¼šé€šé“æ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ï¼Œå…³æ³¨è¯»äº‹ä»¶</li>
<li><code>this.setDaemon(true)</code>ï¼šè®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹</li>
</ul>
</li>
<li><p>è¿è¡Œæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>this.selector.select(1000)</code>ï¼šå¤šè·¯å¤ç”¨å™¨é˜»å¡è·å–å°±ç»ªçš„é€šé“ï¼Œæœ€å¤šç­‰å¾… 1 ç§’é’Ÿï¼Œè·å–åˆ°å°±ç»ªäº‹ä»¶æˆ–è€…è¶…æ—¶åç»“æŸ</p>
</li>
<li><p><code>boolean ok = this.processReadEvent()</code>ï¼š<strong>è¯»æ•°æ®çš„æ ¸å¿ƒæ–¹æ³•</strong>ï¼Œè¿”å› true è¡¨ç¤ºå¤„ç†æˆåŠŸ   false è¡¨ç¤º Socket å¤„äºåŠå…³é—­çŠ¶æ€ï¼Œéœ€è¦ä¸Šå±‚é‡å»º HAConnection å¯¹è±¡</p>
<ul>
<li><p><code>int readSizeZeroTimes = 0</code>ï¼šæ§åˆ¶ while å¾ªç¯ï¼Œå½“è¿ç»­ä» Socket è¯»å–å¤±è´¥ 3 æ¬¡ï¼ˆæœªåŠ è½½åˆ°æ•°æ®ï¼‰è·³å‡ºå¾ªç¯</p>
</li>
<li><p><code>if (!this.byteBufferRead.hasRemaining())</code>ï¼šbyteBufferRead å·²ç»å…¨éƒ¨ä½¿ç”¨å®Œï¼Œéœ€è¦æ¸…ç†æ•°æ®å¹¶æ›´æ–°ä½ç‚¹</p>
</li>
<li><p><code>while (this.byteBufferRead.hasRemaining())</code>ï¼šbyteBufferRead æœ‰ç©ºé—´å¯ä»¥å» Socket è¯»ç¼“å†²åŒºåŠ è½½æ•°æ®</p>
</li>
<li><p><code>int readSize = this.socketChannel.read(this.byteBufferRead)</code>ï¼š<strong>ä»é€šé“è¯»æ•°æ®</strong></p>
</li>
<li><p><code>if (readSize &gt; 0)</code>ï¼šåŠ è½½æˆåŠŸï¼Œæœ‰æ–°æ•°æ®</p>
<p><code>if ((byteBufferRead.position() - processPosition) &gt;= 8)</code>ï¼šç¼“å†²åŒºçš„å¯è¯»æ•°æ®æœ€å°‘åŒ…å«ä¸€ä¸ªæ•°æ®å¸§</p>
<ul>
<li><code>int pos = ...</code>ï¼š<strong>è·å–å¯è¯»å¸§æ•°æ®ä¸­æœ€åä¸€ä¸ªå®Œæ•´çš„å¸§æ•°æ®çš„ä½ç‚¹ï¼Œåé¢çš„æ•°æ®ä¸¢å¼ƒ</strong></li>
</ul>
</li>
<li><p><code>long readOffset = ...byteBufferRead.getLong(pos - 8)</code>ï¼šè¯»å–æœ€åä¸€å¸§æ•°æ®ï¼Œslave ç«¯å½“å‰çš„åŒæ­¥è¿›åº¦ä¿¡æ¯</p>
<ul>
<li><code>this.processPosition = pos</code>ï¼šæ›´æ–°å¤„ç†ä½ç‚¹</li>
<li><code>HAConnection.this.slaveAckOffset = readOffset</code>ï¼šæ›´æ–°åº”ç­”ä½ç‚¹</li>
<li><code>if (HAConnection.this.slaveRequestOffset &lt; 0)</code>ï¼šæ¡ä»¶æˆç«‹<strong>ç»™ slaveRequestOffset èµ‹å€¼</strong></li>
<li><code>HAConnection...notifyTransferSome(slaveAckOffset)</code>ï¼š<strong>å”¤é†’é˜»å¡çš„ç”Ÿäº§è€…çº¿ç¨‹</strong></li>
</ul>
</li>
<li><p><code>else if (readSize == 0)</code>ï¼šè¯»å– 3 æ¬¡æ— æ–°æ•°æ®è·³å‡ºå¾ªç¯</p>
</li>
<li><p><code>else</code>ï¼šreadSize = -1 å°±è¡¨ç¤º Socket å¤„äºåŠå…³é—­çŠ¶æ€ï¼Œå¯¹ç«¯å·²ç»å…³é—­äº†</p>
</li>
</ul>
</li>
<li><p><code>if (interval &gt; 20)</code>ï¼šè¶…è¿‡ 20 ç§’æœªå‘ç”Ÿé€šä¿¡ï¼Œç›´æ¥ç»“æŸå¾ªç¯</p>
</li>
</ul>
</li>
</ul>
<hr>
<h6 id="WriteSocket"><a href="#WriteSocket" class="headerlink" title="WriteSocket"></a>WriteSocket</h6><p>WriteSocketService ç±»æ˜¯ä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œmaster å‘ slave ä¼ è¾“çš„æ•°æ®å¸§æ ¼å¼ä¸º <code>&#123;[phyOffset][size][data...]&#125;&#123;[phyOffset][size][data...]&#125;</code></p>
<ul>
<li>phyOffsetï¼šæ•°æ®åŒºé—´çš„å¼€å§‹åç§»é‡ï¼Œå¹¶ä¸è¡¨ç¤ºæŸä¸€æ¡å…·ä½“çš„æ¶ˆæ¯ï¼Œè¡¨ç¤ºçš„æ•°æ®å—å¼€å§‹çš„åç§»é‡ä½ç½®</li>
<li>sizeï¼šåŒæ­¥çš„æ•°æ®å—çš„å¤§å°</li>
<li>dataï¼šæ•°æ®å—ï¼Œæœ€å¤§ 32kbï¼Œå¯èƒ½åŒ…å«å¤šæ¡æ¶ˆæ¯çš„æ•°æ®</li>
</ul>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>åè®®å¤´ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">headerSize</span> <span class="operator">=</span> <span class="number">8</span> + <span class="number">4</span>;		<span class="comment">// åè®®å¤´å¤§å°ï¼š12</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ByteBuffer byteBufferHeader;	<span class="comment">// å¸§å¤´ç¼“å†²åŒº</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>NIO å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Selector selector;			<span class="comment">// å¤šè·¯å¤ç”¨å™¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SocketChannel socketChannel;	<span class="comment">// master ä¸ slave ä¹‹é—´çš„ä¼šè¯ SocketChannel</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¤„ç†ä½ç‚¹ï¼šä¸‹ä¸€æ¬¡ä¼ è¾“åŒæ­¥æ•°æ®çš„ä½ç½®ä¿¡æ¯ï¼Œmaster ç»™å½“å‰ slave åŒæ­¥çš„ä½ç‚¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="variable">nextTransferFromWhere</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸Šæ¬¡å†™æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">lastWriteOver</span> <span class="operator">=</span> <span class="literal">true</span>;							<span class="comment">// ä¸Šä¸€è½®æ•°æ®æ˜¯å¦ä¼ è¾“å®Œæ¯•</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="variable">lastWriteTimestamp</span> <span class="operator">=</span> System.currentTimeMillis();	<span class="comment">// ä¸Šæ¬¡å†™æ“ä½œçš„æ—¶é—´</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li><p>æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">WriteSocketService</span><span class="params">(<span class="keyword">final</span> SocketChannel socketChannel)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>this.socketChannel.register(this.selector, SelectionKey.OP_WRITE)</code>ï¼šé€šé“æ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ï¼Œå…³æ³¨å†™äº‹ä»¶</li>
<li><code>this.setDaemon(true)</code>ï¼šè®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹</li>
</ul>
</li>
<li><p>è¿è¡Œæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>this.selector.select(1000)</code>ï¼šå¤šè·¯å¤ç”¨å™¨é˜»å¡è·å–å°±ç»ªçš„é€šé“ï¼Œæœ€å¤šç­‰å¾… 1 ç§’é’Ÿï¼Œè·å–åˆ°å°±ç»ªäº‹ä»¶æˆ–è€…è¶…æ—¶åç»“æŸ</p>
</li>
<li><p><code>if (-1 == HAConnection.this.slaveRequestOffset)</code>ï¼š<strong>ç­‰å¾… slave åŒæ­¥å®Œæ•°æ®</strong></p>
</li>
<li><p><code>if (-1 == this.nextTransferFromWhere)</code>ï¼šæ¡ä»¶æˆç«‹ï¼Œéœ€è¦åˆå§‹åŒ–è¯¥å˜é‡</p>
<p><code>if (0 == HAConnection.this.slaveRequestOffset)</code>ï¼šslave æ˜¯ä¸€ä¸ªå…¨æ–°èŠ‚ç‚¹ï¼Œä»æ­£åœ¨é¡ºåºå†™çš„ MF å¼€å§‹åŒæ­¥æ•°æ®</p>
<p><code>long masterOffset = ...</code>ï¼šè·å– master æœ€å¤§çš„ offsetï¼Œå¹¶è®¡ç®—å½’å±çš„ mappedFile æ–‡ä»¶çš„å¼€å§‹ offset</p>
<p><code>this.nextTransferFromWhere = masterOffset</code>ï¼š<strong>èµ‹å€¼ç»™ä¸‹ä¸€æ¬¡ä¼ è¾“åŒæ­¥æ•°æ®çš„ä½ç½®ä¿¡æ¯</strong></p>
<p><code>this.nextTransferFromWhere = HAConnection.this.slaveRequestOffset</code>ï¼šå¤§éƒ¨åˆ†æƒ…å†µèµ°è¿™ä¸ªèµ‹å€¼é€»è¾‘</p>
</li>
<li><p><code>if (this.lastWriteOver)</code>ï¼šä¸Šä¸€æ¬¡å¾…å‘é€æ•°æ®å…¨éƒ¨å‘é€å®Œæˆ</p>
<p><code>if (interval &gt; 5)</code>ï¼š<strong>è¶…è¿‡ 5 ç§’æœªåŒæ­¥æ•°æ®ï¼Œå‘é€ä¸€ä¸ª header å¿ƒè·³æ•°æ®åŒ…ï¼Œç»´æŒé•¿è¿æ¥</strong></p>
</li>
<li><p><code>else</code>ï¼šä¸Šä¸€è½®çš„å¾…å‘é€æ•°æ®æœªå…¨éƒ¨å‘é€ï¼Œéœ€è¦åŒæ­¥æ•°æ®åˆ° slave èŠ‚ç‚¹</p>
</li>
<li><p><code>SelectMappedBufferResult selectResult</code>ï¼š<strong>åˆ° CommitLog ä¸­æŸ¥è¯¢ nextTransferFromWhere å¼€å§‹ä½ç½®çš„æ•°æ®</strong></p>
</li>
<li><p><code>if (size &gt; 32k)</code>ï¼šä¸€æ¬¡æœ€å¤šåŒæ­¥ 32k æ•°æ®</p>
</li>
<li><p><code>this.nextTransferFromWhere += size</code>ï¼šå¢åŠ  sizeï¼Œä¸‹ä¸€è½®ä¼ è¾“è·³è¿‡æœ¬å¸§æ•°æ®</p>
</li>
<li><p><code>selectResult.getByteBuffer().limit(size)</code>ï¼šè®¾ç½® byteBuffer å¯è®¿é—®æ•°æ®åŒºé—´ä¸º [pos, size]</p>
</li>
<li><p><code>this.selectMappedBufferResult = selectResult</code>ï¼š<strong>å¾…å‘é€çš„æ•°æ®</strong></p>
</li>
<li><p><code>this.byteBufferHeader.put</code>ï¼š<strong>æ„å»ºå¸§å¤´æ•°æ®</strong></p>
</li>
<li><p><code>this.lastWriteOver = this.transferData()</code>ï¼šå¤„ç†æ•°æ®ï¼Œè¿”å›æ˜¯å¦å¤„ç†å®Œæˆ</p>
</li>
</ul>
</li>
<li><p>åŒæ­¥æ–¹æ³•ï¼š<strong>åŒæ­¥æ•°æ®åˆ° slave èŠ‚ç‚¹</strong>ï¼Œè¿”å› true è¡¨ç¤ºæœ¬è½®æ•°æ®å…¨éƒ¨åŒæ­¥å®Œæˆï¼Œfalse è¡¨ç¤ºæœ¬è½®åŒæ­¥æœªå®Œæˆï¼ˆHeader å’Œ Body å…¶ä¸­ä¸€ä¸ªæœªåŒæ­¥å®Œæˆéƒ½ä¼šè¿”å› falseï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">transferData</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>int writeSizeZeroTimes= 0</code>ï¼šæ§åˆ¶ while å¾ªç¯ï¼Œå½“å†™å¤±è´¥è¿ç»­ 3 æ¬¡æ—¶ï¼Œè·³å‡ºå¾ªç¯ï¼‰è·³å‡ºå¾ªç¯</p>
</li>
<li><p><code>while (this.byteBufferHeader.hasRemaining())</code>ï¼š<strong>å¸§å¤´æ•°æ®ç¼“å†²åŒºæœ‰å¾…å‘é€çš„æ•°æ®</strong></p>
</li>
<li><p><code>int writeSize = this.socketChannel.write(this.byteBufferHeader)</code>ï¼šå‘é€šé“å†™å¸§å¤´æ•°æ®</p>
</li>
<li><p><code>if (null == this.selectMappedBufferResult)</code>ï¼šè¯´æ˜æ˜¯å¿ƒè·³æ•°æ®ï¼Œè¿”å›å¿ƒè·³æ•°æ®æ˜¯å¦å‘é€å®Œæˆ</p>
</li>
<li><p><code>if (!this.byteBufferHeader.hasRemaining())</code>ï¼š<strong>Headerå†™æˆåŠŸä¹‹åï¼Œæ‰è¿›è¡Œå†™ Body</strong></p>
</li>
<li><p><code>while (this.selectMappedBufferResult.getByteBuffer().hasRemaining())</code>ï¼š<strong>æ•°æ®ç¼“å†²åŒºæœ‰å¾…å‘é€çš„æ•°æ®</strong></p>
</li>
<li><p><code>int writeSize = this.socketChannel.write(this.selectMappedBufferResult...)</code>ï¼šå‘é€šé“å†™å¸§å¤´æ•°æ®</p>
</li>
<li><p><code>if (writeSize &gt; 0)</code>ï¼šå†™æ•°æ®æˆåŠŸï¼Œä½†æ˜¯ä¸ä»£è¡¨ SMBR ä¸­çš„æ•°æ®å…¨éƒ¨å†™å®Œæˆ</p>
</li>
<li><p><code>boolean result</code>ï¼šåˆ¤æ–­æ˜¯å¦å‘é€å®Œæˆï¼Œè¿”å›è¯¥å€¼</p>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="MesStore"><a href="#MesStore" class="headerlink" title="MesStore"></a>MesStore</h4><h5 id="ç”Ÿå‘½å‘¨æœŸ-1"><a href="#ç”Ÿå‘½å‘¨æœŸ-1" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸ"></a>ç”Ÿå‘½å‘¨æœŸ</h5><p>DefaultMessageStore ç±»æ ¸å¿ƒæ˜¯æ•´ä¸ªå­˜å‚¨æœåŠ¡çš„è°ƒåº¦ç±»</p>
<ul>
<li><p>æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">DefaultMessageStore</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>this.allocateMappedFileService.start()</code>ï¼šå¯åŠ¨<strong>åˆ›å»º MappedFile æ–‡ä»¶æœåŠ¡</strong></li>
<li><code>this.indexService.start()</code>ï¼šå¯åŠ¨ç´¢å¼•æœåŠ¡</li>
</ul>
</li>
<li><p>load()ï¼šå…ˆåŠ è½½ CommitLogï¼Œå†åŠ è½½ ConsumeQueueï¼Œæœ€ååŠ è½½ IndexFileï¼ŒåŠ è½½å®Œè¿›å…¥æ¢å¤é˜¶æ®µï¼Œå…ˆæ¢å¤ CQï¼Œåœ¨æ¢å¤ CL</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">load</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>start()ï¼šæ ¸å¿ƒå¯åŠ¨æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>lock = lockFile.getChannel().tryLock(0, 1, false)</code>ï¼šè·å–æ–‡ä»¶é”ï¼Œè·å–å¤±è´¥è¯´æ˜å½“å‰ç›®å½•å·²ç»å¯åŠ¨è¿‡ Broker</p>
</li>
<li><p><code>long maxPhysicalPosInLogicQueue = commitLog.getMinOffset()</code>ï¼šéå†å…¨éƒ¨çš„ CQ å¯¹è±¡ï¼Œè·å– CQ ä¸­æ¶ˆæ¯çš„æœ€å¤§åç§»é‡</p>
</li>
<li><p><code>this.reputMessageService.start()</code>ï¼šè®¾ç½®åˆ†å‘æœåŠ¡çš„åˆ†å‘ä½ç‚¹ï¼Œå¯åŠ¨<strong>åˆ†å‘æœåŠ¡</strong>ï¼Œæ„å»º ConsumerQueue å’Œ IndexFile</p>
</li>
<li><p><code>if (dispatchBehindBytes() &lt;= 0)</code>ï¼šçº¿ç¨‹ç­‰å¾…åˆ†å‘æœåŠ¡å°†åˆ†å‘æ•°æ®å…¨éƒ¨å¤„ç†å®Œæ¯•</p>
</li>
<li><p><code>this.recoverTopicQueueTable()</code>ï¼šå› ä¸ºä¿®æ”¹äº† CQ æ•°æ®ï¼Œæ‰€ä»¥å†æ¬¡æ„å»ºé˜Ÿåˆ—åç§»é‡å­—æ®µè¡¨</p>
</li>
<li><p><code>this.haService.start()</code>ï¼šå¯åŠ¨ <strong>HA æœåŠ¡</strong></p>
</li>
<li><p><code>this.handleScheduleMessageService()</code>ï¼šå¯åŠ¨<strong>æ¶ˆæ¯è°ƒåº¦æœåŠ¡</strong></p>
</li>
<li><p><code>this.flushConsumeQueueService.start()</code>ï¼šå¯åŠ¨ CQ <strong>æ¶ˆè´¹é˜Ÿåˆ—åˆ·ç›˜æœåŠ¡</strong></p>
</li>
<li><p><code>this.commitLog.start()</code>ï¼šå¯åŠ¨ <strong>CL åˆ·ç›˜æœåŠ¡</strong></p>
</li>
<li><p><code>this.storeStatsService.start()</code>ï¼šå¯åŠ¨çŠ¶æ€å­˜å‚¨æœåŠ¡</p>
</li>
<li><p><code>this.createTempFile()</code>ï¼šåˆ›å»º AbortFileï¼Œæ­£å¸¸å…³æœºæ—¶ JVM HOOK ä¼šåˆ é™¤è¯¥æ–‡ä»¶ï¼Œ<strong>å¼‚å¸¸å®•æœºæ—¶è¯¥æ–‡ä»¶ä¸ä¼šåˆ é™¤</strong>ï¼Œå¼€æœºæ•°æ®æ¢å¤é˜¶æ®µæ ¹æ®æ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œæ‰§è¡Œä¸åŒçš„æ¢å¤ç­–ç•¥</p>
</li>
<li><p><code>this.addScheduleTask()</code>ï¼šæ·»åŠ å®šæ—¶ä»»åŠ¡</p>
<ul>
<li><p><code>DefaultMessageStore.this.cleanFilesPeriodically()</code>ï¼š<strong>å®šæ—¶æ¸…ç†è¿‡æœŸæ–‡ä»¶</strong>ï¼Œå‘¨æœŸæ˜¯ 10 ç§’</p>
<ul>
<li><code>this.cleanCommitLogService.run()</code>ï¼šå¯åŠ¨æ¸…ç†è¿‡æœŸçš„ CL æ–‡ä»¶æœåŠ¡</li>
<li><code>this.cleanConsumeQueueService.run()</code>ï¼šå¯åŠ¨æ¸…ç†è¿‡æœŸçš„ CQ æ–‡ä»¶æœåŠ¡</li>
</ul>
</li>
<li><p><code>DefaultMessageStore.this.checkSelf()</code>ï¼šæ¯ 10 åˆ†ç§è¿›è¡Œå¥åº·æ£€æŸ¥</p>
</li>
<li><p><code>DefaultMessageStore.this.cleanCommitLogService.isSpaceFull()</code>ï¼š<strong>ç£ç›˜é¢„è­¦å®šæ—¶ä»»åŠ¡</strong>ï¼Œæ¯ 10 ç§’ä¸€æ¬¡</p>
<ul>
<li><p><code>if (physicRatio &gt; this.diskSpaceWarningLevelRatio)</code>ï¼šæ£€æŸ¥ç£ç›˜æ˜¯å¦åˆ°è¾¾ waring é˜ˆå€¼ï¼Œé»˜è®¤ 90%</p>
<p><code>boolean diskok = ...runningFlags.getAndMakeDiskFull()</code>ï¼šè®¾ç½®ç£ç›˜å†™æ»¡æ ‡è®°</p>
</li>
<li><p><code>boolean diskok = ...this.runningFlags.getAndMakeDiskOK()</code>ï¼šè®¾ç½®ç£ç›˜å¯å†™æ ‡è®°</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>this.shutdown = false</code>ï¼šåˆšå¯åŠ¨ï¼Œè®¾ç½®ä¸º false</p>
</li>
</ul>
</li>
<li><p>shutdown()ï¼šå…³é—­å„ç§æœåŠ¡å’Œçº¿ç¨‹èµ„æºï¼Œè®¾ç½®å­˜å‚¨æ¨¡å—çŠ¶æ€ä¸ºå…³é—­çŠ¶æ€</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>destroy()ï¼šé”€æ¯ Broker çš„å·¥ä½œç›®å½•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æœåŠ¡çº¿ç¨‹-1"><a href="#æœåŠ¡çº¿ç¨‹-1" class="headerlink" title="æœåŠ¡çº¿ç¨‹"></a>æœåŠ¡çº¿ç¨‹</h5><p>ServiceThread ç±»è¢«å¾ˆå¤šæœåŠ¡ç»§æ‰¿ï¼Œæœ¬èº«æ˜¯ä¸€ä¸ª Runnable ä»»åŠ¡å¯¹è±¡ï¼Œç»§æ‰¿è€…é€šè¿‡é‡å†™ run æ–¹æ³•æ¥å®ç°æœåŠ¡çš„é€»è¾‘</p>
<ul>
<li><p>run()ï¼šä¸€èˆ¬å®ç°æ–¹å¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (!<span class="built_in">this</span>.isStopped()) &#123;</span><br><span class="line">        <span class="comment">// ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡å‚æ•° stopped æ§åˆ¶æœåŠ¡çš„åœæ­¢ï¼Œä½¿ç”¨ volatile ä¿®é¥°ä¿è¯å¯è§æ€§</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">stopped</span> <span class="operator">=</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>shutdown()ï¼šåœæ­¢çº¿ç¨‹ï¼Œé¦–å…ˆè®¾ç½® stopped ä¸º trueï¼Œç„¶åè¿›è¡Œå”¤é†’ï¼Œé»˜è®¤ä¸ç›´æ¥æ‰“æ–­çº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>waitForRunning()ï¼šæŒ‚èµ·çº¿ç¨‹ï¼Œè®¾ç½®å”¤é†’æ ‡è®° hasNotified ä¸º false</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">waitForRunning</span><span class="params">(<span class="type">long</span> interval)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>wakeup()ï¼šå”¤é†’çº¿ç¨‹ï¼Œè®¾ç½® hasNotified ä¸º true</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wakeup</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æ„å»ºæœåŠ¡"><a href="#æ„å»ºæœåŠ¡" class="headerlink" title="æ„å»ºæœåŠ¡"></a>æ„å»ºæœåŠ¡</h5><p>AllocateMappedFileService <strong>åˆ›å»º MappedFile æœåŠ¡</strong></p>
<ul>
<li><p>mmapOperation()ï¼šæ ¸å¿ƒæœåŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">mmapOperation</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>req = this.requestQueue.take()</code>ï¼š <strong>ä» requestQueue é˜»å¡é˜Ÿåˆ—ï¼ˆä¼˜å…ˆçº§ï¼‰ä¸­è·å– AllocateRequest ä»»åŠ¡</strong></li>
<li><code>if (...isTransientStorePoolEnable())</code>ï¼šæ¡ä»¶æˆç«‹ä½¿ç”¨ç›´æ¥å†…å­˜å†™å…¥æ•°æ®ï¼Œ ä»ç›´æ¥å†…å­˜ä¸­ commit åˆ° FileChannel ä¸­</li>
<li><code>mappedFile = new MappedFile(req.getFilePath(), req.getFileSize())</code>ï¼šæ ¹æ®è¯·æ±‚çš„è·¯å¾„å’Œå¤§å°åˆ›å»ºå¯¹è±¡</li>
<li><code>mappedFile.warmMappedFile()</code>ï¼šåˆ¤æ–­ mappedFile å¤§å°ï¼Œåªæœ‰ CommitLog æ‰è¿›è¡Œæ–‡ä»¶é¢„çƒ­</li>
<li><code>req.setMappedFile(mappedFile)</code>ï¼šå°†åˆ›å»ºå¥½çš„ MF å¯¹è±¡çš„èµ‹å€¼ç»™è¯·æ±‚å¯¹è±¡çš„æˆå‘˜å±æ€§</li>
<li><code>req.getCountDownLatch().countDown()</code>ï¼š<strong>å”¤é†’è¯·æ±‚çš„é˜»å¡çº¿ç¨‹</strong></li>
</ul>
</li>
<li><p>putRequestAndReturnMappedFile()ï¼šMappedFileQueue ä¸­ç”¨æ¥åˆ›å»º MF å¯¹è±¡çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> MappedFile <span class="title function_">putRequestAndReturnMappedFile</span><span class="params">(String nextFilePath, String nextNextFilePath, <span class="type">int</span> fileSize)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>AllocateRequest nextReq = new AllocateRequest(...)</code>ï¼šåˆ›å»º nextFilePath çš„ AllocateRequest å¯¹è±¡ï¼Œæ”¾å…¥è¯·æ±‚åˆ—è¡¨å’Œé˜»å¡é˜Ÿåˆ—ï¼Œç„¶ååˆ›å»º nextNextFilePath çš„ AllocateRequest å¯¹è±¡ï¼Œæ”¾å…¥è¯·æ±‚åˆ—è¡¨å’Œé˜»å¡é˜Ÿåˆ—</li>
<li><code>AllocateRequest result = this.requestTable.get(nextFilePath)</code>ï¼šä»è¯·æ±‚åˆ—è¡¨è·å– nextFilePath çš„è¯·æ±‚å¯¹è±¡</li>
<li><code>result.getCountDownLatch().await(...)</code>ï¼š<strong>çº¿ç¨‹æŒ‚èµ·</strong>ï¼Œç›´åˆ°è¶…æ—¶æˆ–è€… nextFilePath å¯¹åº”çš„ MF æ–‡ä»¶åˆ›å»ºå®Œæˆ</li>
<li><code>return result.getMappedFile()</code>ï¼šè¿”å›åˆ›å»ºå¥½çš„ MF æ–‡ä»¶å¯¹è±¡</li>
</ul>
</li>
</ul>
<p>ReputMessageService æ¶ˆæ¯åˆ†å‘æœåŠ¡ï¼Œç”¨äºæ„<strong>å»º ConsumerQueue å’Œ IndexFile æ–‡ä»¶</strong></p>
<ul>
<li><p>run()ï¼š<strong>å¾ªç¯æ‰§è¡Œ doReput æ–¹æ³•</strong>ï¼Œ<strong>æ‰€ä»¥å‘é€çš„æ¶ˆæ¯å­˜å‚¨è¿› CL å°±å¯ä»¥äº§ç”Ÿå¯¹åº”çš„ CQ</strong>ï¼Œæ¯æ‰§è¡Œä¸€æ¬¡çº¿ç¨‹ä¼‘çœ  1 æ¯«ç§’</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>doReput()ï¼šå®ç°åˆ†å‘çš„æ ¸å¿ƒé€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReput</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>for (boolean doNext = true; this.isCommitLogAvailable() &amp;&amp; doNext; )</code>ï¼šå¾ªç¯éå†</li>
<li><code>SelectMappedBufferResult result</code>ï¼š ä» CommitLog æ‹‰å–æ•°æ®ï¼Œæ•°æ®èŒƒå›´ <code>[reputFromOffset, åŒ…å«è¯¥åç§»é‡çš„ MF çš„æœ€å¤§ Pos]</code>ï¼Œå°è£…æˆç»“æœå¯¹è±¡</li>
<li><code>DispatchRequest dispatchRequest</code>ï¼šä»ç»“æœå¯¹è±¡è¯»å–å‡ºä¸€æ¡ DispatchRequest æ•°æ®</li>
<li><code>DefaultMessageStore.this.doDispatch(dispatchRequest)</code>ï¼šå°†æ•°æ®äº¤ç»™åˆ†å‘å™¨è¿›è¡Œåˆ†å‘ï¼Œç”¨äº<strong>æ„å»º CQ å’Œç´¢å¼•æ–‡ä»¶</strong></li>
<li><code>this.reputFromOffset += size</code>ï¼šæ›´æ–°æ•°æ®èŒƒå›´</li>
</ul>
</li>
</ul>
<hr>
<h5 id="åˆ·ç›˜æœåŠ¡"><a href="#åˆ·ç›˜æœåŠ¡" class="headerlink" title="åˆ·ç›˜æœåŠ¡"></a>åˆ·ç›˜æœåŠ¡</h5><p>FlushConsumeQueueService åˆ·ç›˜ CQ æ•°æ®</p>
<ul>
<li><p>run()ï¼šæ¯éš” 1 ç§’æ‰§è¡Œä¸€æ¬¡åˆ·ç›˜æœåŠ¡ï¼Œè·³å‡ºå¾ªç¯åè¿˜ä¼šæ‰§è¡Œä¸€æ¬¡å¼ºåˆ¶åˆ·ç›˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>doFlush()ï¼šåˆ·ç›˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doFlush</span><span class="params">(<span class="type">int</span> retryTimes)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>int flushConsumeQueueLeastPages</code>ï¼šè„é¡µé˜ˆå€¼ï¼Œé»˜è®¤æ˜¯ 2</p>
</li>
<li><p><code>if (retryTimes == RETRY_TIMES_OVER)</code>ï¼š<strong>é‡è¯•æ¬¡æ•°æ˜¯ 3</strong> æ—¶è®¾ç½®å¼ºåˆ¶åˆ·ç›˜ï¼Œè®¾ç½®è„é¡µé˜ˆå€¼ä¸º 0</p>
</li>
<li><code>int flushConsumeQueueThoroughInterval</code>ï¼šä¸¤æ¬¡åˆ·æ–°çš„<strong>æ—¶é—´é—´éš”è¶…è¿‡ 60 ç§’</strong>ä¼šå¼ºåˆ¶åˆ·ç›˜</li>
<li><code>for (ConsumeQueue cq : maps.values())</code>ï¼šéå†æ‰€æœ‰çš„ CQï¼Œè¿›è¡Œåˆ·ç›˜</li>
<li><code>DefaultMessageStore.this.getStoreCheckpoint().flush()</code>ï¼šå¼ºåˆ¶åˆ·ç›˜æ—¶å°† StoreCheckpoint ç¬æ—¶æ•°æ®åˆ·ç›˜</li>
</ul>
</li>
</ul>
<p>FlushCommitLogService åˆ·ç›˜ CL æ•°æ®ï¼Œé»˜è®¤æ˜¯å¼‚æ­¥åˆ·ç›˜</p>
<ul>
<li><p>run()ï¼šè¿è¡Œæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>while (!this.isStopped())</code>ï¼šstoppedä¸º true æ‰è·³å‡ºå¾ªç¯</p>
</li>
<li><p><code>boolean flushCommitLogTimed</code>ï¼šæ§åˆ¶çº¿ç¨‹çš„ä¼‘çœ æ–¹å¼ï¼Œé»˜è®¤æ˜¯ falseï¼Œä½¿ç”¨ <code>CountDownLatch.await()</code> ä¼‘çœ ï¼Œè®¾ç½®ä¸º true æ—¶ä½¿ç”¨ <code>Thread.sleep()</code> ä¼‘çœ </p>
</li>
<li><p><code>int interval</code>ï¼šè·å–é…ç½®ä¸­çš„åˆ·ç›˜æ—¶é—´é—´éš”</p>
</li>
<li><p><code>int flushPhysicQueueLeastPages</code>ï¼šè·å–æœ€å°åˆ·ç›˜é¡µæ•°ï¼Œé»˜è®¤æ˜¯ 4 é¡µï¼Œè„é¡µè¾¾åˆ°æŒ‡å®šé¡µæ•°æ‰åˆ·ç›˜</p>
</li>
<li><p><code>int flushPhysicQueueThoroughInterval</code>ï¼šè·å–å¼ºåˆ¶åˆ·ç›˜å‘¨æœŸï¼Œé»˜è®¤æ˜¯ 10 ç§’ï¼Œè¾¾åˆ°å‘¨æœŸåå¼ºåˆ¶åˆ·ç›˜ï¼Œä¸è€ƒè™‘è„é¡µ</p>
</li>
<li><p><code>if (flushCommitLogTimed)</code>ï¼šä¼‘çœ é€»è¾‘ï¼Œé¿å… CPU å ç”¨å¤ªé•¿æ—¶é—´ï¼Œå¯¼è‡´æ— æ³•æ‰§è¡Œå…¶ä»–æ›´ç´§æ€¥çš„ä»»åŠ¡</p>
</li>
<li><p><code>CommitLog.this.mappedFileQueue.flush(flushPhysicQueueLeastPages)</code>ï¼š<strong>åˆ·ç›˜</strong></p>
</li>
<li><p><code>for (int i = 0; i &lt; RETRY_TIMES_OVER &amp;&amp; !result; i++)</code>ï¼šstopped åœæ­¢æ ‡è®°ä¸º true æ—¶ï¼Œéœ€è¦ç¡®ä¿æ‰€æœ‰çš„æ•°æ®éƒ½å·²ç»åˆ·ç›˜ï¼Œæ‰€ä»¥æ­¤å¤„å°è¯• 10 æ¬¡å¼ºåˆ¶åˆ·ç›˜ï¼Œ</p>
<p><code>result = CommitLog.this.mappedFileQueue.flush(0)</code>ï¼š<strong>å¼ºåˆ¶åˆ·ç›˜</strong></p>
</li>
</ul>
</li>
</ul>
<hr>
<h5 id="æ¸…ç†æœåŠ¡"><a href="#æ¸…ç†æœåŠ¡" class="headerlink" title="æ¸…ç†æœåŠ¡"></a>æ¸…ç†æœåŠ¡</h5><p>CleanCommitLogService æ¸…ç†è¿‡æœŸçš„ CL æ•°æ®ï¼Œå®šæ—¶ä»»åŠ¡ 10 ç§’è°ƒç”¨ä¸€æ¬¡ï¼Œ<strong>å…ˆæ¸…ç† CLï¼Œå†æ¸…ç† CQ</strong>ï¼Œå› ä¸º CQ ä¾èµ–äº CL çš„æ•°æ®</p>
<ul>
<li><p>run()ï¼šè¿è¡Œæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>deleteExpiredFiles()ï¼šåˆ é™¤è¿‡æœŸ CL æ–‡ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">deleteExpiredFiles</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>long fileReservedTime</code>ï¼šé»˜è®¤ 72ï¼Œä»£è¡¨æ–‡ä»¶çš„ä¿ç•™æ—¶é—´</li>
<li><code>boolean timeup = this.isTimeToDelete()</code>ï¼šå½“å‰æ—¶é—´æ˜¯å¦æ˜¯å‡Œæ™¨ 4 ç‚¹</li>
<li><code>boolean spacefull = this.isSpaceToDelete()</code>ï¼šCL æˆ–è€… CQ çš„ç›®å½•ç£ç›˜ä½¿ç”¨ç‡è¾¾åˆ°é˜ˆå€¼æ ‡å‡† 85%</li>
<li><code>boolean manualDelete = this.manualDeleteFileSeveralTimes &gt; 0</code>ï¼šæ‰‹åŠ¨åˆ é™¤æ–‡ä»¶</li>
<li><code>fileReservedTime *= 60 * 60 * 1000</code>ï¼šé»˜è®¤ä¿ç•™ 72 å°æ—¶</li>
<li><code>deleteCount = DefaultMessageStore.this.commitLog.deleteExpiredFile()</code>ï¼š<strong>è°ƒç”¨ MFQ å¯¹è±¡çš„åˆ é™¤æ–¹æ³•</strong></li>
</ul>
</li>
</ul>
<p>CleanConsumeQueueService æ¸…ç†è¿‡æœŸçš„ CQ æ•°æ®</p>
<ul>
<li><p>run()ï¼šè¿è¡Œæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>deleteExpiredFiles()ï¼šåˆ é™¤è¿‡æœŸ CQ æ–‡ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">deleteExpiredFiles</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>int deleteLogicsFilesInterval</code>ï¼šæ¸…ç† CQ çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤ 100 æ¯«ç§’</li>
<li><code>long minOffset = DefaultMessageStore.this.commitLog.getMinOffset()</code>ï¼šè·å– CL æ–‡ä»¶ä¸­æœ€å°çš„ç‰©ç†åç§»é‡</li>
<li><code>if (minOffset &gt; this.lastPhysicalMinOffset)</code>ï¼šCL æœ€å°çš„åç§»é‡å¤§äº CQ æœ€å°çš„ï¼Œè¯´æ˜æœ‰è¿‡æœŸæ•°æ®</li>
<li><code>this.lastPhysicalMinOffset = minOffset</code>ï¼šæ›´æ–° CQ çš„æœ€å°åç§»é‡</li>
<li><code>for (ConsumeQueue logic : maps.values())</code>ï¼šéå†æ‰€æœ‰çš„ CQ æ–‡ä»¶</li>
<li><code>logic.deleteExpiredFile(minOffset)</code>ï¼š<strong>è°ƒç”¨ MFQ å¯¹è±¡çš„åˆ é™¤æ–¹æ³•</strong></li>
<li><code>DefaultMessageStore.this.indexService.deleteExpiredFile(minOffset)</code>ï¼š<strong>åˆ é™¤è¿‡æœŸçš„ç´¢å¼•æ–‡ä»¶</strong></li>
</ul>
</li>
</ul>
<hr>
<h5 id="è·å–æ¶ˆæ¯"><a href="#è·å–æ¶ˆæ¯" class="headerlink" title="è·å–æ¶ˆæ¯"></a>è·å–æ¶ˆæ¯</h5><p>DefaultMessageStore#getMessage ç”¨äºè·å–æ¶ˆæ¯ï¼Œåœ¨ PullMessageProcessor#processRequest æ–¹æ³•ä¸­è¢«è°ƒç”¨ ï¼ˆæç¤ºï¼šå»ºè®®å­¦ä¹ æ¶ˆè´¹è€…æºç æ—¶å†é˜…è¯»ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// offset: å®¢æˆ·ç«¯æ‹‰æ¶ˆæ¯ä½¿ç”¨ä½ç‚¹ï¼›   maxMsgNums: 32ï¼›  messageFilter: ä¸€èˆ¬è¿™é‡Œæ˜¯ tagCode è¿‡æ»¤ </span></span><br><span class="line"><span class="keyword">public</span> GetMessageResult <span class="title function_">getMessage</span><span class="params">(<span class="keyword">final</span> String group, <span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="type">int</span> queueId, <span class="keyword">final</span> <span class="type">long</span> offset, <span class="keyword">final</span> <span class="type">int</span> maxMsgNums, <span class="keyword">final</span> MessageFilter messageFilter)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>if (this.shutdown)</code>ï¼šæ£€æŸ¥è¿è¡ŒçŠ¶æ€</p>
</li>
<li><p><code>GetMessageResult getResult</code>ï¼šåˆ›å»ºæŸ¥è¯¢ç»“æœå¯¹è±¡</p>
</li>
<li><p><code>final long maxOffsetPy = this.commitLog.getMaxOffset()</code>ï¼š<strong>è·å– CommitLog æœ€å¤§ç‰©ç†åç§»é‡</strong></p>
</li>
<li><p><code>ConsumeQueue consumeQueue = findConsumeQueue(topic, queueId)</code>ï¼šæ ¹æ®ä¸»é¢˜å’Œé˜Ÿåˆ— ID è·å– ConsumeQueueå¯¹è±¡</p>
</li>
<li><p><code>minOffset, maxOffset</code>ï¼šè·å–å½“å‰ ConsumeQueue çš„æœ€å° offset å’Œ æœ€å¤§ offsetï¼Œ<strong>åˆ¤æ–­æ˜¯å¦æ»¡è¶³æœ¬æ¬¡ Pull çš„ offset</strong></p>
<p><code>if (maxOffset == 0)</code>ï¼šè¯´æ˜é˜Ÿåˆ—å†…æ— æ•°æ®ï¼Œè®¾ç½®çŠ¶æ€ä¸º NO_MESSAGE_IN_QUEUEï¼Œå¤–å±‚è¿›è¡Œé•¿è½®è¯¢</p>
<p><code>else if (offset &lt; minOffset)</code>ï¼šè¯´æ˜ offset å¤ªå°äº†ï¼Œè®¾ç½®çŠ¶æ€ä¸º OFFSET_TOO_SMALL</p>
<p><code>else if (offset == maxOffset)</code>ï¼šæ¶ˆè´¹è¿›åº¦æŒå¹³ï¼Œè®¾ç½®çŠ¶æ€ä¸º OFFSET_OVERFLOW_ONEï¼Œå¤–å±‚è¿›è¡Œé•¿è½®è¯¢</p>
<p><code>else if (offset &gt; maxOffset)</code>ï¼šè¯´æ˜ offset è¶Šç•Œäº†ï¼Œè®¾ç½®çŠ¶æ€ä¸º OFFSET_OVERFLOW_BADLY</p>
</li>
<li><p><code>SelectMappedBufferResult bufferConsumeQueue</code>ï¼šæŸ¥è¯¢ CQData <strong>è·å–åŒ…å«è¯¥ offset çš„ MappedFile æ–‡ä»¶</strong>ï¼Œå¦‚æœè¯¥æ–‡ä»¶ä¸æ˜¯é¡ºåºå†™çš„æ–‡ä»¶ï¼Œå°±è¯»å– <code>[offset%maxSize, æ–‡ä»¶å°¾]</code> èŒƒå›´çš„æ•°æ®ï¼Œåä¹‹è¯»å– <code>[offset%maxSize, æ–‡ä»¶å+wrotePositionå°¾]</code> </p>
<p>å…ˆæŸ¥ CQ çš„åŸå› ï¼šå› ä¸º CQ æ—¶ CL çš„ç´¢å¼•ï¼Œé€šè¿‡ CQ æŸ¥è¯¢ CL æ›´åŠ å¿«æ·</p>
</li>
<li><p><code>if (bufferConsumeQueue != null)</code>ï¼šåªæœ‰å† CQ åˆ é™¤è¿‡æœŸæ•°æ®çš„é€»è¾‘æ‰§è¡Œæ—¶ï¼Œæ¡ä»¶æ‰ä¸æˆç«‹ï¼Œä¸€èˆ¬éƒ½æ˜¯æˆç«‹çš„</p>
</li>
<li><p><code>long nextPhyFileStartOffset = Long.MIN_VALUE</code>ï¼šä¸‹ä¸€ä¸ª commitLog ç‰©ç†æ–‡ä»¶åï¼Œåˆå§‹å€¼ä¸ºæœ€å°å€¼</p>
</li>
<li><p><code>long maxPhyOffsetPulling = 0</code>ï¼šæœ¬æ¬¡æ‹‰æ¶ˆæ¯æœ€åä¸€æ¡æ¶ˆæ¯çš„ç‰©ç†åç§»é‡</p>
</li>
<li><p><code>for ()</code>ï¼š<strong>å¤„ç†æ•°æ®</strong>ï¼Œæ¯æ¬¡å¤„ç† 20 å­—èŠ‚å¤„ç†å­—èŠ‚æ•°å¤§äº 16000 æ—¶è·³å‡ºå¾ªç¯</p>
</li>
<li><p><code>offsetPy, sizePy, tagsCode</code>ï¼šè¯»å– 20 ä¸ªå­—èŠ‚åï¼Œè·å–æ¶ˆæ¯ç‰©ç†åç§»é‡ã€æ¶ˆæ¯å¤§å°ã€æ¶ˆæ¯ tagCode</p>
</li>
<li><p><code>boolean isInDisk = checkInDiskByCommitOffset(...)</code>ï¼š<strong>æ£€æŸ¥æ¶ˆæ¯æ˜¯çƒ­æ•°æ®è¿˜æ˜¯å†·æ•°æ®</strong>ï¼Œfalse ä¸ºçƒ­æ•°æ®</p>
<ul>
<li><code>long memory</code>ï¼šBroker ç³»ç»Ÿ 40% å†…å­˜çš„å­—èŠ‚æ•°ï¼Œå†™æ•°æ®æ—¶å†…å­˜ä¸å¤Ÿä¼šä½¿ç”¨ LRU ç®—æ³•æ·˜æ±°æ•°æ®ï¼Œå°†æ·˜æ±°æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜</li>
<li><code>return (maxOffsetPy - offsetPy) &gt; memory</code>ï¼šè¿”å› true è¯´æ˜æ•°æ®å·²ç»æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œä¸ºå†·æ•°æ®</li>
</ul>
</li>
<li><p><code>if (this.isTheBatchFull())</code>ï¼š<strong>æ§åˆ¶æ˜¯å¦è·³å‡ºå¾ªç¯</strong></p>
<ul>
<li><p><code>if (0 == bufferTotal || 0 == messageTotal)</code>ï¼šæœ¬æ¬¡ pull æ¶ˆæ¯æœªæ‹‰å–åˆ°ä»»ä½•ä¸œè¥¿ï¼Œéœ€è¦å¤–å±‚ for å¾ªç¯ç»§ç»­ï¼Œè¿”å› false</p>
</li>
<li><p><code>if (maxMsgNums &lt;= messageTotal)</code>ï¼šç»“æœå¯¹è±¡å†…æ¶ˆæ¯æ•°å·²ç»è¶…è¿‡äº†æœ€å¤§æ¶ˆæ¯æ•°é‡ï¼Œå¯ä»¥ç»“æŸå¾ªç¯äº†</p>
</li>
<li><p><code>if (isInDisk)</code>ï¼šå†·æ•°æ®</p>
<p><code>if ((bufferTotal + sizePy) &gt; ...)</code>ï¼šå†·æ•°æ®ä¸€æ¬¡ pull è¯·æ±‚æœ€å¤§å…è®¸è·å– 64kb çš„æ¶ˆæ¯</p>
<p><code>if (messageTotal &gt; ...)</code>ï¼šå†·æ•°æ®ä¸€æ¬¡ pull è¯·æ±‚æœ€å¤§å…è®¸è·å–8 æ¡æ¶ˆæ¯</p>
</li>
<li><p><code>else</code>ï¼šçƒ­æ•°æ®</p>
<p><code>if ((bufferTotal + sizePy) &gt; ...)</code>ï¼šçƒ­æ•°æ®ä¸€æ¬¡ pull è¯·æ±‚æœ€å¤§å…è®¸è·å– 256kb çš„æ¶ˆæ¯</p>
<p><code>if (messageTotal &gt; ...)</code>ï¼šå†·æ•°æ®ä¸€æ¬¡ pull è¯·æ±‚æœ€å¤§å…è®¸è·å– 32 æ¡æ¶ˆæ¯</p>
</li>
</ul>
</li>
<li><p><code>if (messageFilter != null)</code>ï¼šæŒ‰ç…§æ¶ˆæ¯ tagCode è¿›è¡Œè¿‡æ»¤</p>
</li>
<li><p><code>selectResult = this.commitLog.getMessage(offsetPy, sizePy)</code>ï¼šæ ¹æ® CQ æ¶ˆæ¯ç‰©ç†åç§»é‡å’Œæ¶ˆæ¯å¤§å°<strong>åˆ° commitLog ä¸­æŸ¥è¯¢è¿™æ¡ msg</strong></p>
</li>
<li><p><code>if (null == selectResult)</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜ commitLog æ‰§è¡Œäº†åˆ é™¤è¿‡æœŸæ–‡ä»¶çš„å®šæ—¶ä»»åŠ¡ï¼Œå› ä¸ºæ˜¯å…ˆæ¸…ç†çš„ CLï¼Œæ‰€ä»¥ CQ è¿˜æœ‰è¯¥ç´¢å¼•æ•°æ®</p>
</li>
<li><p><code>nextPhyFileStartOffset = this.commitLog.rollNextFile(offsetPy)</code>ï¼šè·å–åŒ…å«è¯¥ offsetPy çš„ä¸‹ä¸€ä¸ªæ•°æ®æ–‡ä»¶çš„æ–‡ä»¶å</p>
</li>
<li><p><code>getResult.addMessage(selectResult)</code>ï¼š<strong>å°†æœ¬æ¬¡å¾ªç¯æŸ¥è¯¢å‡ºæ¥çš„ msg åŠ å…¥åˆ° getResult å†…</strong></p>
</li>
<li><p><code>status = GetMessageStatus.FOUND</code>ï¼šæŸ¥è¯¢çŠ¶æ€è®¾ç½®ä¸º FOUND</p>
</li>
<li><p><code>nextPhyFileStartOffset = Long.MIN_VALUE</code>ï¼šè®¾ç½®ä¸ºæœ€å°å€¼ï¼Œè·³è¿‡æœŸ CQData æ•°æ®çš„é€»è¾‘</p>
</li>
<li><p><code>nextBeginOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE)</code>ï¼šè®¡ç®—å®¢æˆ·ç«¯ä¸‹ä¸€æ¬¡ pull æ—¶ä½¿ç”¨çš„ä½ç‚¹ä¿¡æ¯</p>
</li>
<li><p><code>getResult.setSuggestPullingFromSlave(diff &gt; memory)</code>ï¼š<strong>é€‰æ‹©ä¸»ä»èŠ‚ç‚¹çš„å»ºè®®</strong></p>
<ul>
<li><code>diff &gt; memory =&gt; true</code>ï¼šè¡¨ç¤ºæœ¬è½®æŸ¥è¯¢æœ€åä¸€æ¡æ¶ˆæ¯ä¸ºå†·æ•°æ®ï¼ŒBroker å»ºè®®å®¢æˆ·ç«¯ä¸‹ä¸€æ¬¡ pull æ—¶åˆ° slave èŠ‚ç‚¹</li>
<li><code>diff &gt; memory =&gt; false</code>ï¼šè¡¨ç¤ºæœ¬è½®æŸ¥è¯¢æœ€åä¸€æ¡æ¶ˆæ¯ä¸ºçƒ­æ•°æ®ï¼ŒBroker å»ºè®®å®¢æˆ·ç«¯ä¸‹ä¸€æ¬¡ pull æ—¶åˆ° master èŠ‚ç‚¹</li>
</ul>
</li>
<li><p><code>getResult.setStatus(status)</code>ï¼šè®¾ç½®ç»“æœçŠ¶æ€</p>
</li>
<li><p><code>getResult.setNextBeginOffset(nextBeginOffset)</code>ï¼šè®¾ç½®å®¢æˆ·ç«¯ä¸‹ä¸€æ¬¡ pull æ—¶çš„ offset</p>
</li>
<li><p><code>getResult.setMaxOffset(maxOffset)</code>ï¼šè®¾ç½® queue çš„æœ€å¤§ offset å’Œæœ€å° offset</p>
</li>
<li><p><code>return getResult</code>ï¼šè¿”å›ç»“æœå¯¹è±¡</p>
</li>
</ul>
<hr>
<h4 id="Broker-1"><a href="#Broker-1" class="headerlink" title="Broker"></a>Broker</h4><p>BrokerStartup å¯åŠ¨æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    start(createBrokerController(args));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> BrokerController <span class="title function_">start</span><span class="params">(BrokerController controller)</span> &#123;</span><br><span class="line">    controller.start();	<span class="comment">// å¯åŠ¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BrokerStartup#createBrokerControllerï¼šæ„é€ æ§åˆ¶å™¨ï¼Œå¹¶åˆå§‹åŒ–</p>
<ul>
<li><code>final BrokerController controller()</code>ï¼šåˆ›å»ºå®ä¾‹å¯¹è±¡</li>
<li><code>boolean initResult = controller.initialize()</code>ï¼šæ§åˆ¶å™¨åˆå§‹åŒ–<ul>
<li><code>this.registerProcessor()</code>ï¼š<strong>æ³¨å†Œäº†å¤„ç†å™¨ï¼ŒåŒ…æ‹¬å‘é€æ¶ˆæ¯ã€æ‹‰å–æ¶ˆæ¯ã€æŸ¥è¯¢æ¶ˆæ¯ç­‰æ ¸å¿ƒå¤„ç†å™¨</strong></li>
<li><code>initialTransaction()</code>ï¼šåˆå§‹åŒ–äº†äº‹åŠ¡æœåŠ¡ï¼Œç”¨äºè¿›è¡Œ<strong>äº‹åŠ¡å›æŸ¥</strong></li>
</ul>
</li>
</ul>
<p>BrokerController#startï¼šæ ¸å¿ƒå¯åŠ¨æ–¹æ³•</p>
<ul>
<li><p><code>this.messageStore.start()</code>ï¼š<strong>å¯åŠ¨å­˜å‚¨æœåŠ¡</strong></p>
</li>
<li><p><code>this.remotingServer.start()</code>ï¼šå¯åŠ¨ Netty é€šä¿¡æœåŠ¡</p>
</li>
<li><p><code>this.fileWatchService.start()</code>ï¼šå¯åŠ¨æ–‡ä»¶ç›‘å¬æœåŠ¡</p>
</li>
<li><p><code>startProcessorByHa(messageStoreConfig.getBrokerRole())</code>ï¼š<strong>å¯åŠ¨äº‹åŠ¡å›æŸ¥</strong></p>
</li>
<li><p><code>this.scheduledExecutorService.scheduleAtFixedRate()</code>ï¼šæ¯éš” 30s å‘ NameServer ä¸ŠæŠ¥ Topic è·¯ç”±ä¿¡æ¯ï¼Œ<strong>å¿ƒè·³æœºåˆ¶</strong></p>
<p><code>BrokerController.this.registerBrokerAll(true, false, brokerConfig.isForceRegister())</code></p>
</li>
</ul>
<hr>
<h3 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h3><h4 id="ç”Ÿäº§è€…ç±»"><a href="#ç”Ÿäº§è€…ç±»" class="headerlink" title="ç”Ÿäº§è€…ç±»"></a>ç”Ÿäº§è€…ç±»</h4><h5 id="ç”Ÿäº§è€…ç±»-1"><a href="#ç”Ÿäº§è€…ç±»-1" class="headerlink" title="ç”Ÿäº§è€…ç±»"></a>ç”Ÿäº§è€…ç±»</h5><p>DefaultMQProducer æ˜¯ç”Ÿäº§è€…çš„é»˜è®¤å®ç°ç±»</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>ç”Ÿäº§è€…å®ç°ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">transient</span> DefaultMQProducerImpl defaultMQProducerImpl</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç”Ÿäº§è€…ç»„ï¼šå‘é€äº‹åŠ¡æ¶ˆæ¯ï¼ŒBroker ç«¯è¿›è¡Œäº‹åŠ¡å›æŸ¥ï¼ˆè¡¥å¿æœºåˆ¶ï¼‰æ—¶ï¼Œé€‰æ‹©å½“å‰ç”Ÿäº§è€…ç»„çš„ä¸‹ä¸€ä¸ªç”Ÿäº§è€…è¿›è¡Œäº‹åŠ¡å›æŸ¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String producerGroup;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é»˜è®¤ä¸»é¢˜ï¼šisAutoCreateTopicEnable å¼€å¯æ—¶ï¼Œå½“å‘é€æ¶ˆæ¯æŒ‡å®šçš„ Topic åœ¨ Namesrv æœªæ‰¾åˆ°è·¯ç”±ä¿¡æ¯ï¼Œä½¿ç”¨è¯¥å€¼åˆ›å»º Topic ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">createTopicKey</span> <span class="operator">=</span> TopicValidator.AUTO_CREATE_TOPIC_KEY_TOPIC;</span><br><span class="line"><span class="comment">// å€¼ä¸ºã€TBW102ã€‘ï¼ŒJust for testing or demo program</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆæ¯é‡æŠ•ï¼šç³»ç»Ÿç‰¹æ€§æ¶ˆæ¯é‡è¯•éƒ¨åˆ†è¯¦è§£äº†ä¸‰ä¸ªå‚æ•°çš„ä½œç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">retryTimesWhenSendFailed</span> <span class="operator">=</span> <span class="number">2</span>;		<span class="comment">// åŒæ­¥å‘é€å¤±è´¥åé‡è¯•çš„å‘é€æ¬¡æ•°ï¼ŒåŠ ä¸Šç¬¬ä¸€æ¬¡å‘é€ï¼Œä¸€å…±ä¸‰æ¬¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">retryTimesWhenSendAsyncFailed</span> <span class="operator">=</span> <span class="number">2</span>;	<span class="comment">// å¼‚æ­¥</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">retryAnotherBrokerWhenNotStoreOK</span> <span class="operator">=</span> <span class="literal">false</span>;	<span class="comment">// æ¶ˆæ¯æœªå­˜å‚¨æˆåŠŸï¼Œé€‰æ‹©å…¶ä»– Broker é‡è¯•</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆæ¯é˜Ÿåˆ—ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">defaultTopicQueueNums</span> <span class="operator">=</span> <span class="number">4</span>;		<span class="comment">// é»˜è®¤ Broker åˆ›å»ºçš„é˜Ÿåˆ—æ•°</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆæ¯å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">sendMsgTimeout</span> <span class="operator">=</span> <span class="number">3000</span>;					<span class="comment">// å‘é€æ¶ˆæ¯çš„è¶…æ—¶é™åˆ¶</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">compressMsgBodyOverHowmuch</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">4</span>;	<span class="comment">// å‹ç¼©é˜ˆå€¼ï¼Œå½“ msg body è¶…è¿‡ 4k åä½¿ç”¨å‹ç¼©</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxMessageSize</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">4</span>;		<span class="comment">// æ¶ˆæ¯ä½“çš„æœ€å¤§é™åˆ¶ï¼Œé»˜è®¤ 4M</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">TraceDispatcher</span> <span class="variable">traceDispatcher</span> <span class="operator">=</span> <span class="literal">null</span>;		<span class="comment">// æ¶ˆæ¯è½¨è¿¹</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<ul>
<li><p>æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">DefaultMQProducer</span><span class="params">(<span class="keyword">final</span> String namespace, <span class="keyword">final</span> String producerGroup, RPCHook rpcHook)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.namespace = namespace;</span><br><span class="line">    <span class="built_in">this</span>.producerGroup = producerGroup;</span><br><span class="line">    <span class="comment">// åˆ›å»ºç”Ÿäº§è€…å®ç°å¯¹è±¡</span></span><br><span class="line">    defaultMQProducerImpl = <span class="keyword">new</span> <span class="title class_">DefaultMQProducerImpl</span>(<span class="built_in">this</span>, rpcHook);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æˆå‘˜æ–¹æ³•ï¼š</p>
<ul>
<li><p>start()ï¼šå¯åŠ¨æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> MQClientException &#123;</span><br><span class="line">    <span class="comment">// é‡ç½®ç”Ÿäº§è€…ç»„åï¼Œå¦‚æœä¼ é€’äº†å‘½åç©ºé—´ï¼Œåˆ™ ã€namespace%groupã€‘</span></span><br><span class="line">    <span class="built_in">this</span>.setProducerGroup(withNamespace(<span class="built_in">this</span>.producerGroup));</span><br><span class="line">    <span class="comment">// ç”Ÿäº§è€…å®ç°å¯¹è±¡å¯åŠ¨</span></span><br><span class="line">    <span class="built_in">this</span>.defaultMQProducerImpl.start();</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != traceDispatcher) &#123;</span><br><span class="line">      	<span class="comment">// æ¶ˆæ¯è½¨è¿¹çš„é€»è¾‘</span></span><br><span class="line">   		traceDispatcher.start(<span class="built_in">this</span>.getNamesrvAddr(), <span class="built_in">this</span>.getAccessChannel());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>send()ï¼š<strong>å‘é€æ¶ˆæ¯</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SendResult <span class="title function_">send</span><span class="params">(Message msg)</span>&#123;</span><br><span class="line">    <span class="comment">// æ ¡éªŒæ¶ˆæ¯</span></span><br><span class="line">    Validators.checkMessage(msg, <span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®æ¶ˆæ¯ Topic</span></span><br><span class="line">    msg.setTopic(withNamespace(msg.getTopic()));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.defaultMQProducerImpl.send(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>request()ï¼šè¯·æ±‚æ–¹æ³•ï¼Œ<strong>éœ€è¦æ¶ˆè´¹è€…å›æ‰§æ¶ˆæ¯</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Message <span class="title function_">request</span><span class="params">(<span class="keyword">final</span> Message msg, <span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> <span class="type">long</span> timeout)</span> &#123;</span><br><span class="line">    msg.setTopic(withNamespace(msg.getTopic()));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.defaultMQProducerImpl.request(msg, mq, timeout);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="å®ç°è€…ç±»"><a href="#å®ç°è€…ç±»" class="headerlink" title="å®ç°è€…ç±»"></a>å®ç°è€…ç±»</h5><p>DefaultMQProducerImpl ç±»æ˜¯é»˜è®¤çš„ç”Ÿäº§è€…å®ç°ç±»</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>å®ä¾‹å¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DefaultMQProducer defaultMQProducer;	<span class="comment">// æŒæœ‰é»˜è®¤ç”Ÿäº§è€…å¯¹è±¡ï¼Œç”¨æ¥è·å–å¯¹è±¡ä¸­çš„é…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">private</span> MQClientInstance mQClientFactory;			<span class="comment">// å®¢æˆ·ç«¯å®ä¾‹å¯¹è±¡ï¼Œç”Ÿäº§è€…å¯åŠ¨åéœ€è¦æ³¨å†Œåˆ°è¯¥å®¢æˆ·ç«¯å¯¹è±¡å†…</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸»é¢˜å‘å¸ƒä¿¡æ¯æ˜ å°„è¡¨ï¼škey æ˜¯ Topicï¼Œvalue æ˜¯å‘å¸ƒä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, TopicPublishInfo&gt; topicPublishInfoTable = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, TopicPublishInfo&gt;();</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¼‚æ­¥å‘é€æ¶ˆæ¯ï¼šç›¸å…³ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; asyncSenderThreadPoolQueue;<span class="comment">// å¼‚æ­¥å‘é€æ¶ˆæ¯ï¼Œå¼‚æ­¥çº¿ç¨‹æ± ä½¿ç”¨çš„é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExecutorService defaultAsyncSenderExecutor;	<span class="comment">// å¼‚æ­¥å‘é€æ¶ˆæ¯é»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">private</span> ExecutorService asyncSenderExecutor;				<span class="comment">// å¼‚æ­¥æ¶ˆæ¯å‘é€çº¿ç¨‹æ± ï¼ŒæŒ‡å®šåå°±ä¸ä½¿ç”¨é»˜è®¤çº¿ç¨‹æ± äº†</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å®šæ—¶å™¨ï¼šæ‰§è¡Œå®šæ—¶ä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>(<span class="string">&quot;RequestHouseKeepingService&quot;</span>, <span class="literal">true</span>);	<span class="comment">// å®ˆæŠ¤çº¿ç¨‹</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>çŠ¶æ€ä¿¡æ¯ï¼šæœåŠ¡çš„çŠ¶æ€ï¼Œé»˜è®¤åˆ›å»ºçŠ¶æ€</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">ServiceState</span> <span class="variable">serviceState</span> <span class="operator">=</span> ServiceState.CREATE_JUST;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å‹ç¼©ç­‰çº§ï¼šZIP å‹ç¼©ç®—æ³•çš„ç­‰çº§ï¼Œé»˜è®¤æ˜¯ 5ï¼Œè¶Šé«˜å‹ç¼©æ•ˆæœå¥½ï¼Œä½†æ˜¯å‹ç¼©çš„æ›´æ…¢</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">zipCompressLevel</span> <span class="operator">=</span> Integer.parseInt(System.getProperty..., <span class="string">&quot;5&quot;</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®¹é”™ç­–ç•¥ï¼šé€‰æ‹©é˜Ÿåˆ—çš„å®¹é”™ç­–ç•¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">MQFaultStrategy</span> <span class="variable">mqFaultStrategy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MQFaultStrategy</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>é’©å­ï¼šç”¨æ¥è¿›è¡Œå‰ç½®æˆ–è€…åç½®å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;SendMessageHook&gt; sendMessageHookList;			<span class="comment">// å‘é€æ¶ˆæ¯çš„é’©å­ï¼Œç•™ç»™ç”¨æˆ·æ‰©å±•ä½¿ç”¨</span></span><br><span class="line">ArrayList&lt;CheckForbiddenHook&gt; checkForbiddenHookList;	<span class="comment">// å¯¹æ¯”ä¸Šé¢çš„é’©å­ï¼Œå¯ä»¥æŠ›å¼‚å¸¸ï¼Œæ§åˆ¶æ¶ˆæ¯æ˜¯å¦å¯ä»¥å‘é€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RPCHook rpcHook;						 	<span class="comment">// ä¼ é€’ç»™ NettyRemotingClient</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<ul>
<li><p>é»˜è®¤æ„é€ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">DefaultMQProducerImpl</span><span class="params">(<span class="keyword">final</span> DefaultMQProducer defaultMQProducer)</span> &#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤ RPC HOOK æ˜¯ç©º</span></span><br><span class="line">    <span class="built_in">this</span>(defaultMQProducer, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æœ‰å‚æ„é€ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">DefaultMQProducerImpl</span><span class="params">(<span class="keyword">final</span> DefaultMQProducer defaultMQProducer, RPCHook rpcHook)</span> &#123;</span><br><span class="line">    <span class="comment">// å±æ€§èµ‹å€¼</span></span><br><span class="line">    <span class="built_in">this</span>.defaultMQProducer = defaultMQProducer;</span><br><span class="line">    <span class="built_in">this</span>.rpcHook = rpcHook;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºã€å¼‚æ­¥æ¶ˆæ¯çº¿ç¨‹æ± ä»»åŠ¡é˜Ÿåˆ—ã€‘ï¼Œé•¿åº¦æ˜¯ 5w</span></span><br><span class="line">    <span class="built_in">this</span>.asyncSenderThreadPoolQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="number">50000</span>);</span><br><span class="line">    <span class="comment">// åˆ›å»ºé»˜è®¤çš„å¼‚æ­¥æ¶ˆæ¯ä»»åŠ¡çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="built_in">this</span>.defaultAsyncSenderExecutor = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">        <span class="comment">// æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°éƒ½æ˜¯ ç³»ç»Ÿå¯ç”¨çš„è®¡ç®—èµ„æºï¼ˆ8æ ¸16çº¿ç¨‹çš„ç³»ç»Ÿå°±æ˜¯ 16ï¼‰...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="å®ç°æ–¹æ³•"><a href="#å®ç°æ–¹æ³•" class="headerlink" title="å®ç°æ–¹æ³•"></a>å®ç°æ–¹æ³•</h5><ul>
<li><p>start()ï¼šå¯åŠ¨æ–¹æ³•ï¼Œå‚æ•°é»˜è®¤æ˜¯ trueï¼Œä»£è¡¨æ­£å¸¸çš„å¯åŠ¨è·¯å¾„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(<span class="keyword">final</span> <span class="type">boolean</span> startFactory)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>this.serviceState = ServiceState.START_FAILED</code>ï¼šå…ˆä¿®æ”¹ä¸ºå¯åŠ¨å¤±è´¥ï¼ŒæˆåŠŸåå†ä¿®æ”¹ï¼Œè¿™ç§æ€æƒ³å¾ˆå¸¸è§</p>
</li>
<li><p><code>this.checkConfig()</code>ï¼šåˆ¤æ–­ç”Ÿäº§è€…ç»„åä¸èƒ½æ˜¯ç©ºï¼Œä¹Ÿä¸èƒ½æ˜¯ default_PRODUCER</p>
</li>
<li><p><code>if (!getProducerGroup().equals(MixAll.CLIENT_INNER_PRODUCER_GROUP))</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ç”Ÿäº§è€…ä¸æ˜¯å†…éƒ¨äº§ç”Ÿè€…ï¼Œå†…éƒ¨ç”Ÿäº§è€…æ˜¯<strong>å¤„ç†æ¶ˆæ¯å›é€€</strong>çš„è¿™ç§æƒ…å†µä½¿ç”¨çš„ç”Ÿäº§è€…</p>
<p><code>this.defaultMQProducer.changeInstanceNameToPID()</code>ï¼šä¿®æ”¹ç”Ÿäº§è€…å®ä¾‹åç§°ä¸ºå½“å‰è¿›ç¨‹çš„ PID</p>
</li>
<li><p><code>this.mQClientFactory = ...</code>ï¼šè·å–å½“å‰è¿›ç¨‹çš„ MQ å®¢æˆ·ç«¯å®ä¾‹å¯¹è±¡ï¼Œä» factoryTable ä¸­è·å– key ä¸º å®¢æˆ·ç«¯ IDï¼Œæ ¼å¼æ˜¯<code>ip@pid</code>ï¼Œ<strong>ä¸€ä¸ª JVM è¿›ç¨‹åªæœ‰ä¸€ä¸ª PIDï¼Œä¹Ÿåªæœ‰ä¸€ä¸ª MQClientInstance</strong></p>
</li>
<li><p><code>boolean registerOK = mQClientFactory.registerProducer(...)</code>ï¼šå°†ç”Ÿäº§è€…æ³¨å†Œåˆ° RocketMQ å®¢æˆ·ç«¯å®ä¾‹å†…</p>
</li>
<li><p><code>this.topicPublishInfoTable.put(...)</code>ï¼šæ·»åŠ ä¸€ä¸ªä¸»é¢˜å‘å¸ƒä¿¡æ¯ï¼Œkey æ˜¯ <strong>TBW102</strong> ï¼Œvalue æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡</p>
</li>
<li><p><code>mQClientFactory.start()</code>ï¼šå¯åŠ¨ RocketMQ å®¢æˆ·ç«¯å®ä¾‹å¯¹è±¡</p>
</li>
<li><p><code>this.mQClientFactory.sendHeartbeatToAllBrokerWithLock()</code>ï¼šRocketMQ <strong>å®¢æˆ·ç«¯å®ä¾‹å‘å·²çŸ¥çš„ Broker èŠ‚ç‚¹å‘é€ä¸€æ¬¡å¿ƒè·³</strong>ï¼ˆä¹Ÿæ˜¯å®šæ—¶ä»»åŠ¡ï¼‰</p>
</li>
<li><p><code>this.timer.scheduleAtFixedRate()</code>ï¼š request å‘é€çš„æ¶ˆæ¯éœ€è¦æ¶ˆè´¹ç€å›æ‰§ä¿¡æ¯ï¼Œå¯åŠ¨å®šæ—¶ä»»åŠ¡æ¯ç§’ä¸€æ¬¡åˆ é™¤è¶…æ—¶è¯·æ±‚</p>
<ul>
<li>ç”Ÿäº§è€… msg æ·»åŠ ä¿¡æ¯å…³è” ID å‘é€åˆ° Broker</li>
<li>æ¶ˆè´¹è€…ä» Broker æ‹¿åˆ°æ¶ˆæ¯åä¼šæ£€æŸ¥ msg ç±»å‹æ˜¯ä¸€ä¸ªéœ€è¦å›æ‰§çš„æ¶ˆæ¯ï¼Œå¤„ç†å®Œæ¶ˆæ¯åä¼šæ ¹æ® msg å…³è” ID å’Œå®¢æˆ·ç«¯ ID ç”Ÿæˆä¸€æ¡å“åº”ç»“æœæ¶ˆæ¯å‘é€åˆ° Brokerï¼ŒBroker åˆ¤æ–­ä¸ºå›æ‰§æ¶ˆæ¯ï¼Œä¼šæ ¹æ®å®¢æˆ·ç«¯ID æ‰¾åˆ° channel æ¨é€ç»™ç”Ÿäº§è€…</li>
<li>ç”Ÿäº§è€…æ‹¿åˆ°å›æ‰§æ¶ˆæ¯åï¼Œè¯»å–å‡ºæ¥å…³è” ID æ‰¾åˆ°å¯¹åº”çš„ RequestFutureï¼Œå°†é˜»å¡çº¿ç¨‹å”¤é†’</li>
</ul>
</li>
</ul>
</li>
<li><p>sendDefaultImpl()ï¼šå‘é€æ¶ˆæ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‚æ•°1ï¼šæ¶ˆæ¯ï¼›å‚æ•°2ï¼šå‘é€æ¨¡å¼ï¼ˆåŒæ­¥å¼‚æ­¥å•å‘ï¼‰ï¼›å‚æ•°3ï¼šå›è°ƒå‡½æ•°ï¼Œå¼‚æ­¥å‘é€æ—¶éœ€è¦ï¼›å‚æ•°4ï¼šå‘é€è¶…æ—¶æ—¶é—´, é»˜è®¤ 3 ç§’</span></span><br><span class="line"><span class="keyword">private</span> SendResult <span class="title function_">sendDefaultImpl</span><span class="params">(msg, communicationMode, sendCallback,timeout)</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>this.makeSureStateOK()</code>ï¼šæ ¡éªŒç”Ÿäº§è€…çŠ¶æ€æ˜¯è¿è¡Œä¸­ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸</p>
</li>
<li><p><code>topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic())</code>ï¼š<strong>è·å–å½“å‰æ¶ˆæ¯ä¸»é¢˜çš„å‘å¸ƒä¿¡æ¯</strong></p>
<ul>
<li><p><code>this.topicPublishInfoTable.get(topic)</code>ï¼šå…ˆå°è¯•ä»æœ¬åœ°ä¸»é¢˜å‘å¸ƒä¿¡æ¯æ˜ å°„è¡¨è·å–ä¿¡æ¯ï¼Œè·å–ä¸åˆ°ç»§ç»­æ‰§è¡Œ</p>
</li>
<li><p><code>this.mQClientFactory.update...FromNameServer(topic)</code>ï¼šç„¶åä» Namesrv æ›´æ–°è¯¥ Topic çš„è·¯ç”±æ•°æ®</p>
</li>
<li><p><code>this.mQClientFactory.update...FromNameServer(...)</code>ï¼š<strong>è·¯ç”±æ•°æ®æ˜¯ç©ºï¼Œè·å–é»˜è®¤ TBW102 çš„æ•°æ®</strong></p>
<p><code>return topicPublishInfo</code>ï¼šè¿”å› TBW102 ä¸»é¢˜çš„å‘å¸ƒä¿¡æ¯</p>
</li>
</ul>
</li>
<li><p><code>String[] brokersSent = new String[timesTotal]</code>ï¼šä¸‹æ ‡ç´¢å¼•ä»£è¡¨ç¬¬å‡ æ¬¡å‘é€ï¼Œå€¼ä»£è¡¨è¿™æ¬¡å‘é€é€‰æ‹© Broker name</p>
</li>
<li><p><code>for (; times &lt; timesTotal; times++)</code>ï¼šå¾ªç¯å‘é€ï¼Œ<strong>å‘é€æˆåŠŸæˆ–è€…å‘é€å°è¯•æ¬¡æ•°è¾¾åˆ°ä¸Šé™ï¼Œç»“æŸå¾ªç¯</strong></p>
</li>
<li><p><code>String lastBrokerName = null == mq ? null : mq.getBrokerName()</code>ï¼šè·å–ä¸Šæ¬¡å‘é€å¤±è´¥çš„ BrokerName</p>
</li>
<li><p><code>mqSelected = this.selectOneMessageQueue(topicPublishInfo, lastBrokerName)</code>ï¼šä»å‘å¸ƒä¿¡æ¯ä¸­é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç”Ÿäº§è€…çš„<strong>è´Ÿè½½å‡è¡¡ç­–ç•¥</strong>ï¼Œå‚è€ƒç³»ç»Ÿç‰¹æ€§ç« èŠ‚</p>
</li>
<li><p><code>brokersSent[times] = mq.getBrokerName()</code>ï¼šå°†æœ¬æ¬¡é€‰æ‹©çš„ BrokerName å­˜å…¥æ•°ç»„</p>
</li>
<li><p><code>msg.setTopic(this.defaultMQProducer.withNamespace(msg.getTopic()))</code>ï¼š<strong>äº§ç”Ÿé‡æŠ•ï¼Œé‡æŠ•æ¶ˆæ¯éœ€è¦åŠ ä¸Šæ ‡è®°</strong></p>
</li>
<li><p><code>sendResult = this.sendKernelImpl</code>ï¼šæ ¸å¿ƒå‘é€æ–¹æ³•</p>
</li>
<li><p><code>switch (communicationMode)</code>ï¼šå¼‚æ­¥æˆ–è€…å•å‘æ¶ˆæ¯ç›´æ¥è¿”å› nullï¼Œå¼‚æ­¥é€šè¿‡å›è°ƒå‡½æ•°å¤„ç†ï¼ŒåŒæ­¥å‘é€è¿›å…¥é€»è¾‘åˆ¤æ–­</p>
<p><code>if (sendResult.getSendStatus() != SendStatus.SEND_OK)</code>ï¼š<strong>æœåŠ¡ç«¯ Broker å­˜å‚¨å¤±è´¥ï¼Œéœ€è¦é‡è¯•å…¶ä»– Broker</strong></p>
</li>
<li><p><code>throw new MQClientException()</code>ï¼šæœªæ‰¾åˆ°å½“å‰ä¸»é¢˜çš„è·¯ç”±æ•°æ®ï¼Œæ— æ³•å‘é€æ¶ˆæ¯ï¼ŒæŠ›å‡ºå¼‚å¸¸</p>
</li>
</ul>
</li>
<li><p>sendKernelImpl()ï¼š<strong>æ ¸å¿ƒå‘é€æ–¹æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‚æ•°1ï¼šæ¶ˆæ¯ï¼›å‚æ•°2ï¼šé€‰æ‹©çš„é˜Ÿåˆ—ï¼›å‚æ•°3ï¼šå‘é€æ¨¡å¼ï¼ˆåŒæ­¥å¼‚æ­¥å•å‘ï¼‰ï¼›å‚æ•°4ï¼šå›è°ƒå‡½æ•°ï¼Œå¼‚æ­¥å‘é€æ—¶éœ€è¦ï¼›å‚æ•°5ï¼šä¸»é¢˜å‘å¸ƒä¿¡æ¯ï¼›å‚æ•°6ï¼šå‰©ä½™è¶…æ—¶æ—¶é—´é™åˆ¶</span></span><br><span class="line"><span class="keyword">private</span> SendResult <span class="title function_">sendKernelImpl</span><span class="params">(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>brokerAddr = this.mQClientFactory(...)</code>ï¼š<strong>è·å–æŒ‡å®š BrokerName å¯¹åº”çš„ mater èŠ‚ç‚¹çš„åœ°å€</strong>ï¼Œmaster èŠ‚ç‚¹çš„ ID ä¸º 0ï¼Œé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ<strong>å‘é€æ¶ˆæ¯è¦å‘åˆ°ä¸»èŠ‚ç‚¹</strong></p>
</li>
<li><p><code>brokerAddr = MixAll.brokerVIPChannel()</code>ï¼šBroker å¯åŠ¨æ—¶ä¼šç»‘å®šä¸¤ä¸ªæœåŠ¡å™¨ç«¯å£ï¼Œä¸€ä¸ªæ˜¯æ™®é€šç«¯å£ï¼Œä¸€ä¸ªæ˜¯ VIP ç«¯å£ï¼ŒæœåŠ¡å™¨ç«¯æ ¹æ®ä¸åŒç«¯å£åˆ›å»ºä¸åŒçš„çš„ NioSocketChannel</p>
</li>
<li><p><code>byte[] prevBody = msg.getBody()</code>ï¼šè·å–æ¶ˆæ¯ä½“</p>
</li>
<li><p><code>if (!(msg instanceof MessageBatch))</code>ï¼šéæ‰¹é‡æ¶ˆæ¯ï¼Œéœ€è¦é‡æ–°è®¾ç½®æ¶ˆæ¯ ID</p>
<p><code>MessageClientIDSetter.setUniqID(msg)</code>ï¼š<strong>msg id ç”±ä¸¤éƒ¨åˆ†ç»„æˆ</strong>ï¼Œä¸€éƒ¨åˆ†æ˜¯ ip åœ°å€ã€è¿›ç¨‹å·ã€Classloader çš„ hashcodeï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯æ—¶é—´å·®ï¼ˆå½“å‰æ—¶é—´å‡å»å½“æœˆä¸€å·çš„æ—¶é—´ï¼‰å’Œè®¡æ•°å™¨çš„å€¼</p>
</li>
<li><p><code>if (this.tryToCompressMessage(msg))</code>ï¼šåˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å‹ç¼©ï¼Œå‹ç¼©éœ€è¦è®¾ç½®å‹ç¼©æ ‡è®°</p>
</li>
<li><p><code>hasCheckForbiddenHookã€hasSendMessageHook</code>ï¼šæ‰§è¡Œé’©å­æ–¹æ³•</p>
</li>
<li><p><code>requestHeader = new SendMessageRequestHeader()</code>ï¼šè®¾ç½®å‘é€æ¶ˆæ¯çš„æ¶ˆæ¯å¤´</p>
</li>
<li><p><code>if (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX))</code>ï¼šé‡æŠ•çš„å‘é€æ¶ˆæ¯</p>
</li>
<li><p><code>switch (communicationMode)</code>ï¼šå¼‚æ­¥å‘é€ä¸€ç§å¤„ç†æ–¹å¼ï¼Œå•å‘å’ŒåŒæ­¥åŒæ ·çš„å¤„ç†é€»è¾‘</p>
<p><code>sendResult = this.mQClientFactory.getMQClientAPIImpl().sendMessage()</code>ï¼š<strong>å‘é€æ¶ˆæ¯</strong></p>
<ul>
<li><code>request = RemotingCommand.createRequestCommand()</code>ï¼šåˆ›å»ºä¸€ä¸ª RequestCommand å¯¹è±¡</li>
<li><code>request.setBody(msg.getBody())</code>ï¼š<strong>å°†æ¶ˆæ¯æ”¾å…¥è¯·æ±‚ä½“</strong></li>
<li><code>switch (communicationMode)</code>ï¼š<strong>æ ¹æ®ä¸åŒçš„æ¨¡å¼ invoke ä¸åŒçš„æ–¹æ³•</strong></li>
</ul>
</li>
</ul>
</li>
<li><p>request()ï¼šè¯·æ±‚æ–¹æ³•ï¼Œæ¶ˆè´¹è€…å›æ‰§æ¶ˆæ¯ï¼Œè¿™ç§æ¶ˆæ¯æ˜¯å¼‚æ­¥æ¶ˆæ¯</p>
<ul>
<li><p><code>requestResponseFuture = new RequestResponseFuture(correlationId, timeout, null)</code>ï¼šåˆ›å»ºè¯·æ±‚å“åº”å¯¹è±¡</p>
</li>
<li><p><code>getRequestFutureTable().put(correlationId, requestResponseFuture)</code>ï¼šæ”¾å…¥RequestFutureTable æ˜ å°„è¡¨ä¸­</p>
</li>
<li><p><code>this.sendDefaultImpl(msg, CommunicationMode.ASYNC, new SendCallback())</code>ï¼š<strong>å‘é€å¼‚æ­¥æ¶ˆæ¯ï¼Œæœ‰å›è°ƒå‡½æ•°</strong></p>
</li>
<li><p><code>return waitResponse(msg, timeout, requestResponseFuture, cost)</code>ï¼šç”¨æ¥æŒ‚èµ·è¯·æ±‚çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Message <span class="title function_">waitResponseMessage</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> timeout)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// è¯·æ±‚æŒ‚èµ·</span></span><br><span class="line">    <span class="built_in">this</span>.countDownLatch.await(timeout, TimeUnit.MILLISECONDS);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.responseMsg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å½“æ¶ˆæ¯è¢«æ¶ˆè´¹åï¼Œå®¢æˆ·ç«¯å¤„ç†å“åº”æ—¶é€šè¿‡æ¶ˆæ¯çš„å…³è” IDï¼Œä»æ˜ å°„è¡¨ä¸­è·å–æ¶ˆæ¯çš„ RequestResponseFutureï¼Œæ‰§è¡Œä¸‹é¢çš„æ–¹æ³•å”¤é†’æŒ‚èµ·çº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putResponseMessage</span><span class="params">(<span class="keyword">final</span> Message responseMsg)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.responseMsg = responseMsg;</span><br><span class="line">    <span class="built_in">this</span>.countDownLatch.countDown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="è·¯ç”±ä¿¡æ¯-1"><a href="#è·¯ç”±ä¿¡æ¯-1" class="headerlink" title="è·¯ç”±ä¿¡æ¯"></a>è·¯ç”±ä¿¡æ¯</h4><p>TopicPublishInfo ç±»ç”¨æ¥å­˜å‚¨è·¯ç”±ä¿¡æ¯</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>é¡ºåºæ¶ˆæ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">orderTopic</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆæ¯é˜Ÿåˆ—ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;MessageQueue&gt; messageQueueList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();			<span class="comment">// ä¸»é¢˜å…¨éƒ¨çš„æ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">ThreadLocalIndex</span> <span class="variable">sendWhichQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadLocalIndex</span>();	<span class="comment">// æ¶ˆæ¯é˜Ÿåˆ—ç´¢å¼•</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ã€æ¶ˆæ¯é˜Ÿåˆ—ç±»ã€‘</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageQueue</span> <span class="keyword">implements</span> <span class="title class_">Comparable</span>&lt;MessageQueue&gt;, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> String topic;</span><br><span class="line">    <span class="keyword">private</span> String brokerName;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> queueId;<span class="comment">// é˜Ÿåˆ— ID</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>è·¯ç”±æ•°æ®ï¼šä¸»é¢˜å¯¹åº”çš„è·¯ç”±æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> TopicRouteData topicRouteData;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TopicRouteData</span> <span class="keyword">extends</span> <span class="title class_">RemotingSerializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String orderTopicConf;</span><br><span class="line">    <span class="keyword">private</span> List&lt;QueueData&gt; queueDatas;		<span class="comment">// é˜Ÿåˆ—æ•°æ®</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;BrokerData&gt; brokerDatas;	<span class="comment">// Broker æ•°æ®</span></span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String<span class="comment">/* brokerAddr */</span>, List&lt;String&gt;<span class="comment">/* Filter Server */</span>&gt; filterServerTable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueueData</span> <span class="keyword">implements</span> <span class="title class_">Comparable</span>&lt;QueueData&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> String brokerName;	<span class="comment">// èŠ‚ç‚¹åç§°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> readQueueNums;	<span class="comment">// è¯»é˜Ÿåˆ—æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> writeQueueNums;	<span class="comment">// å†™é˜Ÿåˆ—æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> perm;			<span class="comment">// æƒé™</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> topicSynFlag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BrokerData</span> <span class="keyword">implements</span> <span class="title class_">Comparable</span>&lt;BrokerData&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> String cluster;		<span class="comment">// é›†ç¾¤å</span></span><br><span class="line">    <span class="keyword">private</span> String brokerName;	<span class="comment">// BrokerèŠ‚ç‚¹åç§°</span></span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;Long<span class="comment">/* brokerId */</span>, String<span class="comment">/* broker address */</span>&gt; brokerAddrs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li><p>selectOneMessageQueue()ï¼š<strong>é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—</strong>ä½¿ç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°æ˜¯ä¸Šæ¬¡å¤±è´¥æ—¶çš„ brokerNameï¼Œå¯ä»¥ä¸º null</span></span><br><span class="line"><span class="keyword">public</span> MessageQueue <span class="title function_">selectOneMessageQueue</span><span class="params">(<span class="keyword">final</span> String lastBrokerName)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (lastBrokerName == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> selectOneMessageQueue();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// éå†æ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.messageQueueList.size(); i++) &#123;</span><br><span class="line">            <span class="comment">// ã€è·å–é˜Ÿåˆ—çš„ç´¢å¼•ï¼Œ+1ã€‘</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="built_in">this</span>.sendWhichQueue.getAndIncrement();</span><br><span class="line">            <span class="comment">// è·å–é˜Ÿåˆ—çš„ä¸‹æ ‡ä½ç½®</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> Math.abs(index) % <span class="built_in">this</span>.messageQueueList.size();</span><br><span class="line">            <span class="keyword">if</span> (pos &lt; <span class="number">0</span>)</span><br><span class="line">                pos = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// è·å–æ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">            <span class="type">MessageQueue</span> <span class="variable">mq</span> <span class="operator">=</span> <span class="built_in">this</span>.messageQueueList.get(pos);</span><br><span class="line">            <span class="comment">// ä¸ä¸Šæ¬¡é€‰æ‹©çš„ä¸åŒå°±å¯ä»¥è¿”å›</span></span><br><span class="line">            <span class="keyword">if</span> (!mq.getBrokerName().equals(lastBrokerName)) &#123;</span><br><span class="line">                <span class="keyword">return</span> mq;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> selectOneMessageQueue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="å…¬å…±é…ç½®"><a href="#å…¬å…±é…ç½®" class="headerlink" title="å…¬å…±é…ç½®"></a>å…¬å…±é…ç½®</h4><p>å…¬å…±çš„é…ç½®ä¿¡æ¯ç±»</p>
<ul>
<li><p>ClientConfig ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientConfig</span> &#123;</span><br><span class="line">    <span class="comment">// Namesrv åœ°å€é…ç½®</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">namesrvAddr</span> <span class="operator">=</span> NameServerAddressUtils.getNameServerAddresses();</span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯çš„ IP åœ°å€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">clientIP</span> <span class="operator">=</span> RemotingUtil.getLocalAddress();</span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯å®ä¾‹åç§°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">instanceName</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;rocketmq.client.name&quot;</span>, <span class="string">&quot;DEFAULT&quot;</span>);</span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯å›è°ƒçº¿ç¨‹æ± çš„æ•°é‡ï¼Œå¹³å°æ ¸å¿ƒæ•°ï¼Œ8æ ¸16çº¿ç¨‹çš„ç”µè„‘è¿”å›16</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">clientCallbackExecutorThreads</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">    <span class="comment">// å‘½åç©ºé—´</span></span><br><span class="line">    <span class="keyword">protected</span> String namespace;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">AccessChannel</span> <span class="variable">accessChannel</span> <span class="operator">=</span> AccessChannel.LOCAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–è·¯ç”±ä¿¡æ¯çš„é—´éš”æ—¶é—´ 30s</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">pollNameServerInterval</span> <span class="operator">=</span> <span class="number">1000</span> * <span class="number">30</span>;</span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯ä¸ broker ä¹‹é—´çš„å¿ƒè·³å‘¨æœŸ 30s</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">heartbeatBrokerInterval</span> <span class="operator">=</span> <span class="number">1000</span> * <span class="number">30</span>;</span><br><span class="line">    <span class="comment">// æ¶ˆè´¹è€…æŒä¹…åŒ–æ¶ˆè´¹çš„å‘¨æœŸ 5s</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">persistConsumerOffsetInterval</span> <span class="operator">=</span> <span class="number">1000</span> * <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">pullTimeDelayMillsWhenException</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">unitMode</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> String unitName;</span><br><span class="line">    <span class="comment">// vip é€šé“ï¼Œbroker å¯åŠ¨æ—¶ç»‘å®šä¸¤ä¸ªç«¯å£ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯ vip é€šé“</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">vipChannelEnabled</span> <span class="operator">=</span> Boolean.parseBoolean();</span><br><span class="line">    <span class="comment">// è¯­è¨€ï¼Œé»˜è®¤æ˜¯ Java</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">LanguageCode</span> <span class="variable">language</span> <span class="operator">=</span> LanguageCode.JAVA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>NettyClientConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyClientConfig</span> &#123;</span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯å·¥ä½œçº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">clientWorkerThreads</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">    <span class="comment">// å›è°ƒå¤„ç†çº¿ç¨‹æ±  çº¿ç¨‹æ•°ï¼šå¹³å°æ ¸å¿ƒæ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">clientCallbackExecutorThreads</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">    <span class="comment">// å•å‘è¯·æ±‚å¹¶å‘æ•°ï¼Œé»˜è®¤ 65535</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">clientOnewaySemaphoreValue</span> <span class="operator">=</span> NettySystemConfig.CLIENT_ONEWAY_SEMAPHORE_VALUE;</span><br><span class="line">    <span class="comment">// å¼‚æ­¥è¯·æ±‚å¹¶å‘æ•°ï¼Œé»˜è®¤ 65535</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">clientAsyncSemaphoreValue</span> <span class="operator">=</span> NettySystemConfig.CLIENT_ASYNC_SEMAPHORE_VALUE;</span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨çš„è¶…æ—¶æ—¶é—´é™åˆ¶ 3ç§’</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">connectTimeoutMillis</span> <span class="operator">=</span> <span class="number">3000</span>;</span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯æœªæ¿€æ´»å‘¨æœŸï¼Œ60sï¼ˆæŒ‡å®šæ—¶é—´å†… ch æœªæ¿€æ´»ï¼Œéœ€è¦å…³é—­ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">channelNotActiveInterval</span> <span class="operator">=</span> <span class="number">1000</span> * <span class="number">60</span>;</span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ ch æœ€å¤§ç©ºé—²æ—¶é—´ 2åˆ†é’Ÿ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">clientChannelMaxIdleTimeSeconds</span> <span class="operator">=</span> <span class="number">120</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åº•å±‚ Socket å†™å’Œæ”¶ ç¼“å†²åŒºçš„å¤§å° 65535  64k</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">clientSocketSndBufSize</span> <span class="operator">=</span> NettySystemConfig.socketSndbufSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">clientSocketRcvBufSize</span> <span class="operator">=</span> NettySystemConfig.socketRcvbufSize;</span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯ netty æ˜¯å¦å¯åŠ¨å†…å­˜æ± </span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">clientPooledByteBufAllocatorEnable</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯æ˜¯å¦è¶…æ—¶å…³é—­ Socket è¿æ¥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">clientCloseSocketIfTimeout</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="å®¢æˆ·ç«¯ç±»"><a href="#å®¢æˆ·ç«¯ç±»" class="headerlink" title="å®¢æˆ·ç«¯ç±»"></a>å®¢æˆ·ç«¯ç±»</h4><h5 id="æˆå‘˜å±æ€§-8"><a href="#æˆå‘˜å±æ€§-8" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>MQClientInstance æ˜¯ RocketMQ å®¢æˆ·ç«¯å®ä¾‹ï¼Œåœ¨ä¸€ä¸ª JVM è¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯å®ä¾‹ï¼Œ<strong>æ—¢æœåŠ¡äºç”Ÿäº§è€…ï¼Œä¹ŸæœåŠ¡äºæ¶ˆè´¹è€…</strong></p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>é…ç½®ä¿¡æ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> instanceIndex;			<span class="comment">// ç´¢å¼•ä¸€èˆ¬æ˜¯ 0ï¼Œå› ä¸ºå®¢æˆ·ç«¯å®ä¾‹ä¸€èˆ¬éƒ½æ˜¯ä¸€ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ª</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String clientId;				<span class="comment">// å®¢æˆ·ç«¯ ID ip@pid</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> bootTimestamp;			<span class="comment">// å®¢æˆ·ç«¯çš„å¯åŠ¨æ—¶é—´</span></span><br><span class="line"><span class="keyword">private</span> ServiceState serviceState;			<span class="comment">// å®¢æˆ·ç«¯çŠ¶æ€</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç”Ÿäº§è€…æ¶ˆè´¹è€…çš„æ˜ å°„è¡¨ï¼škey æ˜¯ç»„å</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, MQProducerInner&gt; producerTable</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, MQConsumerInner&gt; consumerTable</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, MQAdminExtInner&gt; adminExtTable</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç½‘ç»œå±‚é…ç½®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> NettyClientConfig nettyClientConfig;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ ¸å¿ƒåŠŸèƒ½çš„å®ç°ï¼šè´Ÿè´£å°† MQ ä¸šåŠ¡å±‚çš„æ•°æ®è½¬æ¢ä¸ºç½‘ç»œå±‚çš„ RemotingCommand å¯¹è±¡ï¼Œä½¿ç”¨å†…éƒ¨æŒæœ‰çš„ NettyRemotingClient å¯¹è±¡çš„ invoke ç³»åˆ—æ–¹æ³•ï¼Œå®Œæˆç½‘ç»œ IOï¼ˆåŒæ­¥ã€å¼‚æ­¥ã€å•å‘ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MQClientAPIImpl mQClientAPIImpl;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æœ¬åœ°è·¯ç”±æ•°æ®ï¼škey æ˜¯ä¸»é¢˜åç§°ï¼Œvalue è·¯ç”±ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, TopicRouteData&gt; topicRouteTable = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>
</li>
<li><p>é”ä¿¡æ¯ï¼šä¸¤æŠŠé”ï¼Œé”ä¸åŒçš„æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">lockNamesrv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">lockHeartbeat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>è°ƒåº¦çº¿ç¨‹æ± ï¼šå•çº¿ç¨‹ï¼Œæ‰§è¡Œå®šæ—¶ä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduledExecutorService;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Broker æ˜ å°„è¡¨ï¼škey æ˜¯ BrokerName</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç‰©ç†èŠ‚ç‚¹æ˜ å°„è¡¨ï¼Œvalueï¼šLong æ˜¯ brokerIDï¼Œã€ID=0 çš„æ˜¯ä¸»èŠ‚ç‚¹ï¼Œå…¶ä»–æ˜¯ä»èŠ‚ç‚¹ã€‘ï¼ŒString æ˜¯åœ°å€ ip:port</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, HashMap&lt;Long, String&gt;&gt; brokerAddrTable;</span><br><span class="line"><span class="comment">// ç‰©ç†èŠ‚ç‚¹ç‰ˆæœ¬æ˜ å°„è¡¨ï¼ŒString æ˜¯åœ°å€ ip:portï¼ŒInteger æ˜¯ç‰ˆæœ¬</span></span><br><span class="line">ConcurrentMap&lt;String, HashMap&lt;String, Integer&gt;&gt; brokerVersionTable;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>å®¢æˆ·ç«¯çš„åè®®å¤„ç†å™¨</strong>ï¼šç”¨äºå¤„ç† IO äº‹ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ClientRemotingProcessor clientRemotingProcessor;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆæ¯æœåŠ¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PullMessageService pullMessageService;		<span class="comment">// æ‹‰æ¶ˆæ¯æœåŠ¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RebalanceService rebalanceService;			<span class="comment">// æ¶ˆè´¹è€…è´Ÿè½½å‡è¡¡æœåŠ¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConsumerStatsManager consumerStatsManager;	<span class="comment">// æ¶ˆè´¹è€…çŠ¶æ€ç®¡ç†</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å†…éƒ¨ç”Ÿäº§è€…å®ä¾‹ï¼šå¤„ç†æ¶ˆè´¹ç«¯<strong>æ¶ˆæ¯å›é€€</strong>ï¼Œç”¨è¯¥ç”Ÿäº§è€…å‘é€å›é€€æ¶ˆæ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DefaultMQProducer defaultMQProducer;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¿ƒè·³æ¬¡æ•°ç»Ÿè®¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">sendHeartbeatTimesTotal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<ul>
<li><p>MQClientInstance æœ‰å‚æ„é€ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">MQClientInstance</span><span class="params">(ClientConfig clientConfig, <span class="type">int</span> instanceIndex, String clientId, RPCHook rpcHook)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.clientConfig = clientConfig;</span><br><span class="line">    <span class="built_in">this</span>.instanceIndex = instanceIndex;</span><br><span class="line">    <span class="comment">// Netty ç›¸å…³çš„é…ç½®ä¿¡æ¯</span></span><br><span class="line">    <span class="built_in">this</span>.nettyClientConfig = <span class="keyword">new</span> <span class="title class_">NettyClientConfig</span>();</span><br><span class="line">    <span class="comment">// å¹³å°æ ¸å¿ƒæ•°</span></span><br><span class="line">    <span class="built_in">this</span>.nettyClientConfig.setClientCallbackExecutorThreads(...);</span><br><span class="line">    <span class="built_in">this</span>.nettyClientConfig.setUseTLS(clientConfig.isUseTLS());</span><br><span class="line">    <span class="comment">// ã€åˆ›å»ºå®¢æˆ·ç«¯åè®®å¤„ç†å™¨ã€‘</span></span><br><span class="line">    <span class="built_in">this</span>.clientRemotingProcessor = <span class="keyword">new</span> <span class="title class_">ClientRemotingProcessor</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// åˆ›å»º API å®ç°å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// å‚æ•°ä¸€ï¼šå®¢æˆ·ç«¯ç½‘ç»œé…ç½®</span></span><br><span class="line">    <span class="comment">// å‚æ•°äºŒï¼šå®¢æˆ·ç«¯åè®®å¤„ç†å™¨ï¼Œæ³¨å†Œåˆ°å®¢æˆ·ç«¯ç½‘ç»œå±‚</span></span><br><span class="line">    <span class="comment">// å‚æ•°ä¸‰ï¼šrpcHookï¼Œæ³¨å†Œåˆ°å®¢æˆ·ç«¯ç½‘ç»œå±‚</span></span><br><span class="line">    <span class="comment">// å‚æ•°å››ï¼šå®¢æˆ·ç«¯é…ç½®</span></span><br><span class="line">    <span class="built_in">this</span>.mQClientAPIImpl = <span class="keyword">new</span> <span class="title class_">MQClientAPIImpl</span>(<span class="built_in">this</span>.nettyClientConfig, <span class="built_in">this</span>.clientRemotingProcessor, rpcHook, clientConfig);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">// å†…éƒ¨ç”Ÿäº§è€…ï¼ŒæŒ‡å®šå†…éƒ¨ç”Ÿäº§è€…çš„ç»„</span></span><br><span class="line">    <span class="built_in">this</span>.defaultMQProducer = <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(MixAll.CLIENT_INNER_PRODUCER_GROUP);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>MQClientAPIImpl æœ‰å‚æ„é€ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">MQClientAPIImpl</span><span class="params">(nettyClientConfig, clientRemotingProcessor, rpcHook, clientConfig)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.clientConfig = clientConfig;</span><br><span class="line">    topAddressing = <span class="keyword">new</span> <span class="title class_">TopAddressing</span>(MixAll.getWSAddr(), clientConfig.getUnitName());</span><br><span class="line">    <span class="comment">// åˆ›å»ºç½‘ç»œå±‚å¯¹è±¡ï¼Œå‚æ•°äºŒä¸º null è¯´æ˜å®¢æˆ·ç«¯å¹¶ä¸å…³å¿ƒ channel event</span></span><br><span class="line">    <span class="built_in">this</span>.remotingClient = <span class="keyword">new</span> <span class="title class_">NettyRemotingClient</span>(nettyClientConfig, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// ä¸šåŠ¡å¤„ç†å™¨</span></span><br><span class="line">    <span class="built_in">this</span>.clientRemotingProcessor = clientRemotingProcessor;</span><br><span class="line">    <span class="comment">// æ³¨å†Œ RpcHook</span></span><br><span class="line">    <span class="built_in">this</span>.remotingClient.registerRPCHook(rpcHook);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// æ³¨å†Œå›é€€æ¶ˆæ¯çš„è¯·æ±‚ç </span></span><br><span class="line">    <span class="built_in">this</span>.remotingClient.registerProcessor(RequestCode.PUSH_REPLY_MESSAGE_TO_CLIENT, <span class="built_in">this</span>.clientRemotingProcessor, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æˆå‘˜æ–¹æ³•-7"><a href="#æˆå‘˜æ–¹æ³•-7" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h5><ul>
<li><p>start()ï¼šå¯åŠ¨æ–¹æ³•</p>
<ul>
<li><code>synchronized (this)</code>ï¼šåŠ é”ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹å¯¹è±¡å¯åŠ¨</li>
<li><code>this.mQClientAPIImpl.start()</code>ï¼šå¯åŠ¨å®¢æˆ·ç«¯ç½‘ç»œå±‚ï¼Œåº•å±‚è°ƒç”¨ RemotingClient ç±» </li>
<li><code>this.startScheduledTask()</code>ï¼šå¯åŠ¨å®šæ—¶ä»»åŠ¡</li>
<li><code>this.pullMessageService.start()</code>ï¼šå¯åŠ¨æ‹‰å–æ¶ˆæ¯æœåŠ¡</li>
<li><code>this.rebalanceService.start()</code>ï¼šå¯åŠ¨è´Ÿè½½å‡è¡¡æœåŠ¡</li>
<li><code>this.defaultMQProducer...start(false)</code>ï¼šå¯åŠ¨å†…éƒ¨ç”Ÿäº§è€…ï¼Œå‚æ•°ä¸º false ä»£è¡¨ä¸å¯åŠ¨å®ä¾‹</li>
</ul>
</li>
<li><p>startScheduledTask()ï¼š<strong>å¯åŠ¨å®šæ—¶ä»»åŠ¡</strong>ï¼Œè°ƒåº¦çº¿ç¨‹æ± æ˜¯å•çº¿ç¨‹</p>
<ul>
<li><p><code>if (null == this.clientConfig.getNamesrvAddr())</code>ï¼šNamesrv åœ°å€æ˜¯ç©ºï¼Œéœ€è¦ä¸¤åˆ†é’Ÿæ‹‰å–ä¸€æ¬¡ Namesrv åœ°å€</p>
</li>
<li><p>å®šæ—¶ä»»åŠ¡ 1ï¼š<strong>ä» Namesrv æ›´æ–°å®¢æˆ·ç«¯æœ¬åœ°çš„è·¯ç”±æ•°æ®</strong>ï¼Œå‘¨æœŸ 30 ç§’ä¸€æ¬¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è®¢é˜…çš„ä¸»é¢˜é›†åˆï¼Œéå†é›†åˆï¼Œå¯¹æ¯”ä» namesrv æ‹‰å–æœ€æ–°çš„ä¸»é¢˜è·¯ç”±æ•°æ®å’Œæœ¬åœ°æ•°æ®ï¼Œæ˜¯å¦éœ€è¦æ›´æ–°</span></span><br><span class="line">MQClientInstance.<span class="built_in">this</span>.updateTopicRouteInfoFromNameServer();</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®šæ—¶ä»»åŠ¡ 2ï¼šå‘¨æœŸ 30 ç§’ä¸€æ¬¡ï¼Œä¸¤ä¸ªä»»åŠ¡</p>
<ul>
<li><strong>æ¸…ç†ä¸‹çº¿çš„ Broker èŠ‚ç‚¹</strong>ï¼Œéå†å®¢æˆ·ç«¯çš„ Broker ç‰©ç†èŠ‚ç‚¹æ˜ å°„è¡¨ï¼Œå°†æ‰€æœ‰ä¸»é¢˜æ•°æ®éƒ½ä¸åŒ…å«çš„ Broker ç‰©ç†èŠ‚ç‚¹æ¸…ç†æ‰ï¼Œå¦‚æœè¢«æ¸…ç†çš„ Broker ä¸‹æ‰€æœ‰çš„ç‰©ç†èŠ‚ç‚¹éƒ½æ²¡æœ‰äº†ï¼Œå°±å°†è¯¥ Broker çš„æ˜ å°„æ•°æ®åˆ é™¤æ‰</li>
<li><strong>å‘åœ¨çº¿çš„æ‰€æœ‰çš„ Broker å‘é€å¿ƒè·³æ•°æ®</strong>ï¼ŒåŒæ­¥å‘é€çš„æ–¹å¼ï¼Œè¿”å›å€¼æ˜¯ Broker ç‰©ç†èŠ‚ç‚¹çš„ç‰ˆæœ¬å·ï¼Œæ›´æ–°ç‰ˆæœ¬æ˜ å°„è¡¨</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MQClientInstance.<span class="built_in">this</span>.cleanOfflineBroker();</span><br><span class="line">MQClientInstance.<span class="built_in">this</span>.sendHeartbeatToAllBrokerWithLock();</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¿ƒè·³æ•°æ®</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeartbeatData</span> <span class="keyword">extends</span> <span class="title class_">RemotingSerializable</span> &#123;</span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯ ID  ip@pid</span></span><br><span class="line">    <span class="keyword">private</span> String clientID;</span><br><span class="line">    <span class="comment">// å­˜å‚¨å®¢æˆ·ç«¯æ‰€æœ‰ç”Ÿäº§è€…æ•°æ®</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;ProducerData&gt; producerDataSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;ProducerData&gt;();</span><br><span class="line">    <span class="comment">// å­˜å‚¨å®¢æˆ·ç«¯æ‰€æœ‰æ¶ˆè´¹è€…æ•°æ®</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;ConsumerData&gt; consumerDataSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;ConsumerData&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®šæ—¶ä»»åŠ¡ 3ï¼šæ¶ˆè´¹è€…æŒä¹…åŒ–æ¶ˆè´¹æ•°æ®ï¼Œå‘¨æœŸ 5 ç§’ä¸€æ¬¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MQClientInstance.<span class="built_in">this</span>.persistAllConsumerOffset();</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®šæ—¶ä»»åŠ¡ 4ï¼šåŠ¨æ€è°ƒæ•´æ¶ˆè´¹è€…çº¿ç¨‹æ± ï¼Œå‘¨æœŸ 1 åˆ†é’Ÿä¸€æ¬¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MQClientInstance.<span class="built_in">this</span>.adjustThreadPool();</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>updateTopicRouteInfoFromNameServer()ï¼š<strong>æ›´æ–°è·¯ç”±æ•°æ®</strong>ï¼Œé€šè¿‡åŠ é”ä¿è¯å½“å‰å®ä¾‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹å»æ›´æ–°</p>
<ul>
<li><p><code>if (isDefault &amp;&amp; defaultMQProducer != null)</code>ï¼šéœ€è¦é»˜è®¤æ•°æ®</p>
<p><code>topicRouteData = ...getDefaultTopicRouteInfoFromNameServer()</code>ï¼šä» Namesrv è·å–é»˜è®¤çš„ TBW102 çš„è·¯ç”±æ•°æ®</p>
</li>
<li><p><code>topicRouteData = ...getTopicRouteInfoFromNameServer(topic)</code>ï¼šéœ€è¦<strong>ä» Namesrv è·å–</strong>è·¯ç”±æ•°æ®ï¼ˆåŒæ­¥ï¼‰</p>
</li>
<li><p><code>old = this.topicRouteTable.get(topic)</code>ï¼šè·å–å®¢æˆ·ç«¯å®ä¾‹æœ¬åœ°çš„è¯¥ä¸»é¢˜çš„è·¯ç”±æ•°æ®</p>
</li>
<li><p><code>boolean changed = topicRouteDataIsChange(old, topicRouteData)</code>ï¼šå¯¹æ¯”æœ¬åœ°å’Œæœ€æ–°ä¸‹æ‹‰çš„æ•°æ®æ˜¯å¦ä¸€è‡´</p>
</li>
<li><p><code>if (changed)</code>ï¼šä¸ä¸€è‡´è¿›å…¥æ›´æ–°é€»è¾‘</p>
<p><code>this.brokerAddrTable.put(...)</code>ï¼šæ›´æ–°å®¢æˆ·ç«¯ broker ç‰©ç†<strong>èŠ‚ç‚¹æ˜ å°„è¡¨</strong></p>
<p><code>Update Pub info</code>ï¼šæ›´æ–°ç”Ÿäº§è€…ä¿¡æ¯</p>
<ul>
<li><code>publishInfo = topicRouteData2TopicPublishInfo(topic, topicRouteData)</code>ï¼šå°†ä¸»é¢˜è·¯ç”±æ•°æ®è½¬åŒ–ä¸ºå‘å¸ƒæ•°æ®ï¼Œä¼š<strong>åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ— MQ</strong>ï¼Œæ”¾å…¥å‘å¸ƒæ•°æ®å¯¹è±¡çš„é›†åˆä¸­</li>
<li><code>impl.updateTopicPublishInfo(topic, publishInfo)</code>ï¼šç”Ÿäº§è€…å°†ä¸»é¢˜çš„å‘å¸ƒæ•°æ®ä¿å­˜åˆ°å®ƒæœ¬åœ°ï¼Œæ–¹ä¾¿å‘é€æ¶ˆæ¯ä½¿ç”¨</li>
</ul>
<p><code>Update sub info</code>ï¼šæ›´æ–°æ¶ˆè´¹è€…ä¿¡æ¯ï¼Œåˆ›å»º MQ é˜Ÿåˆ—ï¼Œæ›´æ–°è®¢é˜…ä¿¡æ¯ï¼Œç”¨äºè´Ÿè½½å‡è¡¡</p>
<p><code>this.topicRouteTable.put(topic, cloneTopicRouteData)</code>ï¼š<strong>å°†æ•°æ®æ”¾å…¥æœ¬åœ°è·¯ç”±è¡¨</strong></p>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="ç½‘ç»œé€šä¿¡-1"><a href="#ç½‘ç»œé€šä¿¡-1" class="headerlink" title="ç½‘ç»œé€šä¿¡"></a>ç½‘ç»œé€šä¿¡</h4><h5 id="æˆå‘˜å±æ€§-9"><a href="#æˆå‘˜å±æ€§-9" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>NettyRemotingClient ç±»è´Ÿè´£å®¢æˆ·ç«¯çš„ç½‘ç»œé€šä¿¡</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>Netty æœåŠ¡ç›¸å…³å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> NettyClientConfig nettyClientConfig;			<span class="comment">// å®¢æˆ·ç«¯çš„ç½‘ç»œå±‚é…ç½®</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();		<span class="comment">// å®¢æˆ·ç«¯ç½‘ç»œå±‚å¯åŠ¨å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> EventLoopGroup eventLoopGroupWorker;			<span class="comment">// å®¢æˆ·ç«¯ç½‘ç»œå±‚ Netty IO çº¿ç¨‹ç»„</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Channel æ˜ å°„è¡¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, ChannelWrapper&gt; channelTables;<span class="comment">// key æ˜¯æœåŠ¡å™¨çš„åœ°å€ï¼Œvalue æ˜¯é€šé“å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">lockChannelTables</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();		  <span class="comment">// é”ï¼Œæ§åˆ¶å¹¶å‘å®‰å…¨</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å®šæ—¶å™¨ï¼šå¯åŠ¨å®šæ—¶ä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>(<span class="string">&quot;ClientHouseKeepingService&quot;</span>, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>çº¿ç¨‹æ± ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ExecutorService publicExecutor;		<span class="comment">// å…¬å…±çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">private</span> ExecutorService callbackExecutor; 	<span class="comment">// å›è°ƒçº¿ç¨‹æ± ï¼Œå®¢æˆ·ç«¯å‘èµ·å¼‚æ­¥è¯·æ±‚ï¼ŒæœåŠ¡å™¨çš„å“åº”æ•°æ®ç”±å›è°ƒçº¿ç¨‹æ± å¤„ç†</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>äº‹ä»¶ç›‘å¬å™¨ï¼šå®¢æˆ·ç«¯è¿™é‡Œæ˜¯ null</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelEventListener channelEventListener;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ„é€ æ–¹æ³•</p>
<ul>
<li><p>æ— å‚æ„é€ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">NettyRemotingClient</span><span class="params">(<span class="keyword">final</span> NettyClientConfig nettyClientConfig)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(nettyClientConfig, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æœ‰å‚æ„é€ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">NettyRemotingClient</span><span class="params">(nettyClientConfig, channelEventListener)</span> &#123;</span><br><span class="line">    <span class="comment">// çˆ¶ç±»åˆ›å»ºäº†2ä¸ªä¿¡å·é‡ï¼Œ1ã€æ§åˆ¶å•å‘è¯·æ±‚çš„å¹¶å‘åº¦ï¼Œ2ã€æ§åˆ¶å¼‚æ­¥è¯·æ±‚çš„å¹¶å‘åº¦</span></span><br><span class="line">    <span class="built_in">super</span>(nettyClientConfig.getClientOnewaySemaphoreValue(), nettyClientConfig.getClientAsyncSemaphoreValue());</span><br><span class="line">    <span class="built_in">this</span>.nettyClientConfig = nettyClientConfig;</span><br><span class="line">    <span class="built_in">this</span>.channelEventListener = channelEventListener;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå…¬å…±çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="type">int</span> <span class="variable">publicThreadNums</span> <span class="operator">=</span> nettyClientConfig.getClientCallbackExecutorThreads();</span><br><span class="line">    <span class="keyword">if</span> (publicThreadNums &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        publicThreadNums = <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.publicExecutor = Executors.newFixedThreadPool(publicThreadNums,);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º Netty IO çº¿ç¨‹ï¼Œ1ä¸ªçº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">this</span>.eventLoopGroupWorker = <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>, );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nettyClientConfig.isUseTLS()) &#123;</span><br><span class="line">  		sslContext = TlsHelper.buildSslContext(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æˆå‘˜æ–¹æ³•-8"><a href="#æˆå‘˜æ–¹æ³•-8" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h5><ul>
<li><p>start()ï¼šå¯åŠ¨æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// channel pipeline å†…çš„ handler ä½¿ç”¨çš„çº¿ç¨‹èµ„æºï¼Œé»˜è®¤ 4 ä¸ª</span></span><br><span class="line">    <span class="built_in">this</span>.defaultEventExecutorGroup = <span class="keyword">new</span> <span class="title class_">DefaultEventExecutorGroup</span>();</span><br><span class="line">    <span class="comment">// é…ç½® netty å®¢æˆ·ç«¯å¯åŠ¨ç±»å¯¹è±¡</span></span><br><span class="line">    <span class="type">Bootstrap</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="built_in">this</span>.bootstrap.group(<span class="built_in">this</span>.eventLoopGroupWorker).channel(NioSocketChannel.class)</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                <span class="comment">// åŠ å‡ ä¸ªhandler</span></span><br><span class="line">                pipeline.addLast(</span><br><span class="line">                    <span class="comment">// æœåŠ¡ç«¯çš„æ•°æ®ï¼Œéƒ½ä¼šæ¥åˆ°è¿™ä¸ª</span></span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">NettyClientHandler</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="comment">// æ³¨æ„ Bootstrap åªæ˜¯é…ç½®å¥½å®¢æˆ·ç«¯çš„å…ƒæ•°æ®äº†ï¼Œã€åœ¨è¿™é‡Œå¹¶æ²¡æœ‰åˆ›å»ºä»»ä½• channel å¯¹è±¡ã€‘</span></span><br><span class="line">    <span class="comment">// å®šæ—¶ä»»åŠ¡ æ‰«æ responseTable ä¸­è¶…æ—¶çš„ ResponseFutureï¼Œé¿å…å®¢æˆ·ç«¯çº¿ç¨‹é•¿æ—¶é—´é˜»å¡</span></span><br><span class="line">    <span class="built_in">this</span>.timer.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">     	NettyRemotingClient.<span class="built_in">this</span>.scanResponseTable();</span><br><span class="line">    &#125;, <span class="number">1000</span> * <span class="number">3</span>, <span class="number">1000</span>);</span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯ nullï¼Œä¸å¯åŠ¨</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.channelEventListener != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.nettyEventExecutor.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å•å‘é€šä¿¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RemotingCommand <span class="title function_">invokeSync</span><span class="params">(String addr, <span class="keyword">final</span> RemotingCommand request, <span class="type">long</span> timeoutMillis)</span> &#123;</span><br><span class="line">    <span class="comment">// å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">beginStartTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// è·å–æˆ–è€…åˆ›å»ºå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ï¼ˆaddrï¼‰çš„é€šé“ channel</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="built_in">this</span>.getAndCreateChannel(addr);</span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ channel é€šé“æ­£å¸¸ï¼Œå¯ä»¥é€šä¿¡</span></span><br><span class="line">    <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isActive()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ‰§è¡Œ rpcHook æ‹“å±•ç‚¹</span></span><br><span class="line">            doBeforeRpcHooks(addr, request);</span><br><span class="line">            <span class="comment">// è®¡ç®—è€—æ—¶ï¼Œå¦‚æœå½“å‰è€—æ—¶å·²ç»è¶…è¿‡ timeoutMillis é™åˆ¶ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¸å†è¿›è¡Œç³»ç»Ÿé€šä¿¡</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">costTime</span> <span class="operator">=</span> System.currentTimeMillis() - beginStartTime;</span><br><span class="line">            <span class="keyword">if</span> (timeoutMillis &lt; costTime) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RemotingTimeoutException</span>(<span class="string">&quot;invokeSync call timeout&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å‚æ•°1ï¼šå®¢æˆ·ç«¯-æœåŠ¡ç«¯é€šé“channel</span></span><br><span class="line">            <span class="comment">// å‚æ•°äºŒï¼šç½‘ç»œå±‚ä¼ è¾“å¯¹è±¡ï¼Œå°è£…ç€è¯·æ±‚æ•°æ®</span></span><br><span class="line">            <span class="comment">// å‚æ•°ä¸‰ï¼šå‰©ä½™çš„è¶…æ—¶é™åˆ¶</span></span><br><span class="line">            <span class="type">RemotingCommand</span> <span class="variable">response</span> <span class="operator">=</span> <span class="built_in">this</span>.invokeSyncImpl(channel, request, ...);</span><br><span class="line">            <span class="comment">// åç½®å¤„ç†</span></span><br><span class="line">            doAfterRpcHooks(RemotingHelper.parseChannelRemoteAddr(channel), request, response);</span><br><span class="line">            <span class="comment">// è¿”å›å“åº”æ•°æ®</span></span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemotingSendRequestException e) &#123;&#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.closeChannel(addr, channel);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RemotingConnectException</span>(addr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="å»¶è¿Ÿæ¶ˆæ¯"><a href="#å»¶è¿Ÿæ¶ˆæ¯" class="headerlink" title="å»¶è¿Ÿæ¶ˆæ¯"></a>å»¶è¿Ÿæ¶ˆæ¯</h4><h5 id="æ¶ˆæ¯å¤„ç†"><a href="#æ¶ˆæ¯å¤„ç†" class="headerlink" title="æ¶ˆæ¯å¤„ç†"></a>æ¶ˆæ¯å¤„ç†</h5><p>BrokerStartup åˆå§‹åŒ– BrokerController è°ƒç”¨ <code>registerProcessor()</code> æ–¹æ³•å°† SendMessageProcessor æ³¨å†Œåˆ° NettyRemotingServer ä¸­ï¼Œå¯¹åº”çš„è¯·æ±‚ ID ä¸º <code>SEND_MESSAGE = 10</code>ï¼ŒNettyServerHandler åœ¨å¤„ç†è¯·æ±‚æ—¶é€šè¿‡ CMD ä¼šè·å–å¤„ç†å™¨æ‰§è¡Œ processRequest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°ä¸€ï¼šå¤„ç†é€šé“çš„äº‹ä»¶ï¼›   å‚æ•°äºŒï¼šå®¢æˆ·ç«¯</span></span><br><span class="line"><span class="keyword">public</span> RemotingCommand <span class="title function_">processRequest</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand request)</span>  &#123;</span><br><span class="line">    <span class="type">RemotingCommand</span> <span class="variable">response</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">   	response = asyncProcessRequest(ctx, request).get();</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SendMessageProcessor#asyncConsumerSendMsgBackï¼šå¼‚æ­¥å‘é€æ¶ˆè´¹è€…çš„å›è°ƒæ¶ˆæ¯</p>
<ul>
<li><p><code>final RemotingCommand response</code>ï¼šåˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨å“åº”å¯¹è±¡</p>
</li>
<li><p><code>final ConsumerSendMsgBackRequestHeader requestHeader</code>ï¼šè§£æå‡ºå®¢æˆ·ç«¯è¯·æ±‚å¤´ä¿¡æ¯ï¼Œå‡ ä¸ª<strong>æ ¸å¿ƒå­—æ®µ</strong>ï¼š</p>
<ul>
<li><code>private Long offset</code>ï¼šå›é€€æ¶ˆæ¯çš„ CommitLog offset</li>
<li><code>private Integer delayLevel</code>ï¼šå»¶è¿Ÿçº§åˆ«ï¼Œä¸€èˆ¬æ˜¯ 0</li>
<li><code>private String originMsgId, originTopic</code>ï¼šåŸå§‹çš„æ¶ˆæ¯ IDï¼Œä¸»é¢˜</li>
<li><code>private Integer maxReconsumeTimes</code>ï¼šæœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤æ˜¯ 16 æ¬¡</li>
</ul>
</li>
<li><p><code>if ()</code>ï¼šé‰´æƒï¼Œæ˜¯å¦æ‰¾åˆ°è®¢é˜…ç»„é…ç½®ã€Broker æ˜¯å¦æ”¯æŒå†™è¯·æ±‚ã€è®¢é˜…ç»„æ˜¯å¦æ”¯æŒæ¶ˆæ¯é‡è¯•</p>
</li>
<li><p><code>String newTopic = MixAll.getRetryTopic(...)</code>ï¼š<strong>è·å–æ¶ˆè´¹è€…ç»„çš„é‡è¯•ä¸»é¢˜</strong>ï¼Œè§„åˆ™æ˜¯ <code>%RETRY%GroupName</code></p>
</li>
<li><p><code>int queueIdInt = Math.abs()</code>ï¼š<strong>é‡è¯•ä¸»é¢˜ä¸‹çš„é˜Ÿåˆ— ID æ˜¯ 0</strong></p>
</li>
<li><p><code>TopicConfig topicConfig</code>ï¼šè·å–é‡è¯•ä¸»é¢˜çš„é…ç½®ä¿¡æ¯</p>
</li>
<li><p><code>MessageExt msgExt</code>ï¼šæ ¹æ®æ¶ˆæ¯çš„ç‰©ç† offset åˆ°å­˜å‚¨æ¨¡å—æŸ¥è¯¢ï¼Œå†…éƒ¨å…ˆæŸ¥è¯¢å‡ºè¿™æ¡æ¶ˆæ¯çš„ sizeï¼Œç„¶åå†æ ¹æ® offset å’Œ size æŸ¥è¯¢å‡ºæ•´æ¡ msg</p>
</li>
<li><p><code>final String retryTopic</code>ï¼šè·å–æ¶ˆæ¯çš„åŸå§‹ä¸»é¢˜</p>
</li>
<li><p><code>if (null == retryTopic)</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜<strong>å½“å‰æ¶ˆæ¯æ˜¯ç¬¬ä¸€æ¬¡è¢«å›é€€</strong>ï¼Œ æ·»åŠ  <code>RETRY_TOPIC</code> å±æ€§</p>
</li>
<li><p><code>msgExt.setWaitStoreMsgOK(false)</code>ï¼šå¼‚æ­¥åˆ·ç›˜</p>
</li>
<li><p><code>if (msgExt...() &gt;= maxReconsumeTimes || delayLevel &lt; 0)</code>ï¼šæ¶ˆæ¯é‡è¯•æ¬¡æ•°è¶…è¿‡æœ€å¤§æ¬¡æ•°ï¼Œä¸æ”¯æŒé‡è¯•</p>
<p><code>newTopic = MixAll.getDLQTopic()</code>ï¼š<strong>è·å–æ¶ˆè´¹è€…çš„æ­»ä¿¡é˜Ÿåˆ—</strong>ï¼Œè§„åˆ™æ˜¯ <code>%DLQ%GroupName</code></p>
<p><code>queueIdInt, topicConfig</code>ï¼šæ­»ä¿¡é˜Ÿåˆ— ID ä¸º 0ï¼Œåˆ›å»ºæ­»ä¿¡é˜Ÿåˆ—çš„é…ç½®</p>
</li>
<li><p><code>if (0 == delayLevel)</code>ï¼šè¯´æ˜å»¶è¿Ÿçº§åˆ«ç”± Broker æ§åˆ¶</p>
<p><code>delayLevel = 3 + msgExt.getReconsumeTimes()</code>ï¼š<strong>å»¶è¿Ÿçº§åˆ«é»˜è®¤ä» 3 çº§å¼€å§‹</strong>ï¼Œæ¯é‡è¯•ä¸€æ¬¡ï¼Œå»¶è¿Ÿçº§åˆ« +1</p>
</li>
<li><p><code>msgExt.setDelayTimeLevel(delayLevel)</code>ï¼š<strong>å°†å»¶è¿Ÿçº§åˆ«è®¾ç½®è¿›æ¶ˆæ¯å±æ€§</strong>ï¼Œå­˜å‚¨æ—¶ä¼šæ£€æŸ¥è¯¥å±æ€§ï¼Œè¯¥å±æ€§å€¼ &gt; 0 ä¼š<strong>å°†æ¶ˆæ¯çš„ä¸»é¢˜å’Œé˜Ÿåˆ—ä¿®æ”¹ä¸ºè°ƒåº¦ä¸»é¢˜å’Œè°ƒåº¦é˜Ÿåˆ— ID</strong></p>
</li>
<li><p><code>MessageExtBrokerInner msgInner</code>ï¼šåˆ›å»ºä¸€æ¡ç©ºæ¶ˆæ¯ï¼Œæ¶ˆæ¯å±æ€§ä» offset æŸ¥è¯¢å‡ºæ¥çš„ msg ä¸­æ‹·è´</p>
</li>
<li><p><code>msgInner.setReconsumeTimes)</code>ï¼šé‡è¯•æ¬¡æ•°è®¾ç½®ä¸ºåŸ msg çš„æ¬¡æ•° +1</p>
</li>
<li><p><code>UtilAll.isBlank(originMsgId)</code>ï¼šåˆ¤æ–­æ¶ˆæ¯æ˜¯å¦æ˜¯åˆæ¬¡è¿”å›åˆ°æœåŠ¡å™¨</p>
<ul>
<li>trueï¼šè¯´æ˜ msgExt æ¶ˆæ¯æ˜¯ç¬¬ä¸€æ¬¡è¢«è¿”å›åˆ°æœåŠ¡å™¨ï¼Œæ­¤æ—¶ä½¿ç”¨è¯¥ msg çš„ id ä½œä¸º originMessageId</li>
<li>falseï¼šè¯´æ˜åŸå§‹æ¶ˆæ¯å·²ç»è¢«é‡è¯•ä¸æ­¢ 1 æ¬¡ï¼Œæ­¤æ—¶ä½¿ç”¨ offset æŸ¥è¯¢å‡ºæ¥çš„ msg ä¸­çš„ originMessageId</li>
</ul>
</li>
<li><p><code>CompletableFuture putMessageResult = ..asyncPutMessage(msgInner)</code>ï¼šè°ƒç”¨å­˜å‚¨æ¨¡å—å­˜å‚¨æ¶ˆæ¯</p>
<p><code>DefaultMessageStore#asyncPutMessage</code>ï¼š</p>
<ul>
<li><code>PutMessageResult result = this.commitLog.asyncPutMessage(msg)</code>ï¼š<strong>å°†æ–°æ¶ˆæ¯å­˜å‚¨åˆ° CommitLog ä¸­</strong></li>
</ul>
</li>
</ul>
<hr>
<h5 id="è°ƒåº¦æœåŠ¡"><a href="#è°ƒåº¦æœåŠ¡" class="headerlink" title="è°ƒåº¦æœåŠ¡"></a>è°ƒåº¦æœåŠ¡</h5><p>DefaultMessageStore ä¸­æœ‰æˆå‘˜å±æ€§ ScheduleMessageServiceï¼Œåœ¨ start æ–¹æ³•ä¸­ä¼šå¯åŠ¨è¯¥è°ƒåº¦æœåŠ¡</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>å»¶è¿Ÿçº§åˆ«å±æ€§è¡¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­˜å‚¨å»¶è¿Ÿçº§åˆ«å¯¹åº”çš„ å»¶è¿Ÿæ—¶é—´é•¿åº¦ ï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Integer <span class="comment">/* level */</span>, Long<span class="comment">/* delay timeMillis */</span>&gt; delayLevelTable;</span><br><span class="line"><span class="comment">// å­˜å‚¨å»¶è¿Ÿçº§åˆ« queue çš„æ¶ˆè´¹è¿›åº¦ offsetï¼Œè¯¥ table æ¯ 10 ç§’é’Ÿï¼Œä¼šæŒä¹…åŒ–ä¸€æ¬¡ï¼ŒæŒä¹…åŒ–åˆ°æœ¬åœ°ç£ç›˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Integer <span class="comment">/* level */</span>, Long<span class="comment">/* offset */</span>&gt; offsetTable;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æœ€å¤§å»¶è¿Ÿçº§åˆ«ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> maxDelayLevel;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¨¡å—å¯åŠ¨çŠ¶æ€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicBoolean</span> <span class="variable">started</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®šæ—¶å™¨ï¼šå†…éƒ¨æœ‰çº¿ç¨‹èµ„æºï¼Œå¯æ‰§è¡Œè°ƒåº¦ä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Timer timer;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æˆå‘˜æ–¹æ³•ï¼š</p>
<ul>
<li><p>load()ï¼šåŠ è½½è°ƒåº¦æ¶ˆæ¯ï¼Œ<strong>åˆå§‹åŒ– delayLevelTable å’Œ offsetTable</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">load</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>start()ï¼šå¯åŠ¨æ¶ˆæ¯è°ƒåº¦æœåŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>if (started.compareAndSet(false, true))</code>ï¼šå°†å¯åŠ¨çŠ¶æ€è®¾ä¸º true</p>
</li>
<li><p><code>this.timer</code>ï¼šåˆ›å»ºå®šæ—¶å™¨å¯¹è±¡</p>
</li>
<li><p><code>for (... : this.delayLevelTable.entrySet())</code>ï¼šä¸º<strong>æ¯ä¸ªå»¶è¿Ÿçº§åˆ«åˆ›å»ºä¸€ä¸ªå»¶è¿Ÿä»»åŠ¡</strong>æäº¤åˆ° timer ï¼Œå‘¨æœŸæ‰§è¡Œï¼Œè¿™æ ·å°±å¯ä»¥<strong>å°†å»¶è¿Ÿæ¶ˆæ¯å¾—åˆ°åŠæ—¶çš„æ¶ˆè´¹</strong></p>
</li>
<li><p><code>this.timer.scheduleAtFixedRate()</code>ï¼šæäº¤å‘¨æœŸå‹ä»»åŠ¡ï¼Œå»¶è¿Ÿ 10 ç§’æ‰§è¡Œï¼Œå‘¨æœŸä¸º 10 ç§’ï¼ŒæŒä¹…åŒ–å»¶è¿Ÿé˜Ÿåˆ—æ¶ˆè´¹è¿›åº¦ä»»åŠ¡</p>
<p><code>ScheduleMessageService.this.persist()</code>ï¼šæŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦</p>
</li>
</ul>
</li>
</ul>
<hr>
<h5 id="è°ƒåº¦ä»»åŠ¡"><a href="#è°ƒåº¦ä»»åŠ¡" class="headerlink" title="è°ƒåº¦ä»»åŠ¡"></a>è°ƒåº¦ä»»åŠ¡</h5><p>DeliverDelayedMessageTimerTask æ˜¯ä¸€ä¸ªä»»åŠ¡ç±»</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>å»¶è¿Ÿçº§åˆ«ï¼šå»¶è¿Ÿé˜Ÿåˆ—ä»»åŠ¡å¤„ç†çš„å»¶è¿Ÿçº§åˆ«</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> delayLevel;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆè´¹è¿›åº¦ï¼šå»¶è¿Ÿé˜Ÿåˆ—ä»»åŠ¡å¤„ç†çš„å»¶è¿Ÿé˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> offset;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æˆå‘˜æ–¹æ³•ï¼š</p>
<ul>
<li><p>run()ï¼šæ‰§è¡Œä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isStarted()) &#123;</span><br><span class="line">        <span class="built_in">this</span>.executeOnTimeup();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>executeOnTimeup()ï¼šæ‰§è¡Œä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeOnTimeup</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>ConsumeQueue cq</code>ï¼šè·å–å‡ºè¯¥å»¶è¿Ÿé˜Ÿåˆ—ä»»åŠ¡å¤„ç†çš„<strong>å»¶è¿Ÿé˜Ÿåˆ— ConsumeQueue</strong></p>
</li>
<li><p><code>SelectMappedBufferResult bufferCQ</code>ï¼šæ ¹æ®æ¶ˆè´¹è¿›åº¦æŸ¥è¯¢å‡º SMBR å¯¹è±¡</p>
</li>
<li><p><code>for (; i &lt; bufferCQ.getSize(); i += ConsumeQueue.CQ_STORE_UNIT_SIZE)</code>ï¼šæ¯æ¬¡è¯»å– 20 å„å­—èŠ‚çš„æ•°æ®</p>
</li>
<li><p><code>offsetPy, sizePy</code>ï¼šå»¶è¿Ÿæ¶ˆæ¯çš„ç‰©ç†åç§»é‡å’Œæ¶ˆæ¯å¤§å°</p>
</li>
<li><p><code>long tagsCode</code>ï¼šå»¶è¿Ÿæ¶ˆæ¯çš„äº¤ä»˜æ—¶é—´ï¼Œåœ¨ ReputMessageService è½¬å‘æ—¶æ ¹æ®æ¶ˆæ¯çš„ DELAY å±æ€§æ˜¯å¦ &gt;0 ï¼Œä¼šåœ¨ tagsCode å­—æ®µå­˜å‚¨äº¤ä»˜æ—¶é—´</p>
</li>
<li><p><code>long deliver... = this.correctDeliverTimestamp(..)</code>ï¼š<strong>æ ¡å‡†äº¤ä»˜æ—¶é—´</strong>ï¼Œå»¶è¿Ÿæ—¶é—´è¿‡é•¿ä¼šè°ƒæ•´ä¸ºå½“å‰æ—¶é—´ç«‹åˆ»æ‰§è¡Œ</p>
</li>
<li><p><code>long countdown = deliverTimestamp - now</code>ï¼šè®¡ç®—å·®å€¼</p>
</li>
<li><p><code>if (countdown &lt;= 0)</code>ï¼š<strong>æ¶ˆæ¯å·²ç»åˆ°è¾¾äº¤ä»˜æ—¶é—´äº†</strong></p>
<p><code>MessageExt msgExt</code>ï¼šæ ¹æ®ç‰©ç†åç§»é‡å’Œæ¶ˆæ¯å¤§å°è·å–è¿™æ¡æ¶ˆæ¯</p>
<p><code>MessageExtBrokerInner msgInner</code>ï¼š<strong>æ„å»ºä¸€æ¡æ–°æ¶ˆæ¯</strong>ï¼Œå°†åŸæ¶ˆæ¯çš„å±æ€§æ‹·è´è¿‡æ¥</p>
<ul>
<li><code>long tagsCodeValue</code>ï¼šä¸å†æ˜¯äº¤ä»˜æ—¶é—´äº†</li>
<li><code>MessageAccessor.clearProperty(msgInner, DELAY..)</code>ï¼šæ¸…ç†æ–°æ¶ˆæ¯çš„ DELAY å±æ€§ï¼Œé¿å…å­˜å‚¨æ—¶é‡å®šå‘åˆ°å»¶è¿Ÿé˜Ÿåˆ—</li>
<li><code>msgInner.setTopic()</code>ï¼š<strong>ä¿®æ”¹ä¸»é¢˜ä¸ºåŸå§‹çš„ä¸»é¢˜ <code>%RETRY%GroupName</code></strong></li>
<li><code>String queueIdStr</code>ï¼šä¿®æ”¹é˜Ÿåˆ— ID ä¸ºåŸå§‹çš„ ID</li>
</ul>
<p><code>PutMessageResult putMessageResult</code>ï¼š<strong>å°†æ–°æ¶ˆæ¯å­˜å‚¨åˆ° CommitLog</strong>ï¼Œæ¶ˆè´¹è€…è®¢é˜…çš„æ˜¯ç›®æ ‡ä¸»é¢˜ï¼Œä¼šå†æ¬¡æ¶ˆè´¹è¯¥æ¶ˆæ¯</p>
</li>
<li><p><code>else</code>ï¼šæ¶ˆæ¯è¿˜æœªåˆ°è¾¾äº¤ä»˜æ—¶é—´</p>
<p><code>ScheduleMessageService.this.timer.schedule()</code>ï¼šåˆ›å»ºè¯¥å»¶è¿Ÿçº§åˆ«çš„ä»»åŠ¡ï¼Œå»¶è¿Ÿ countDown æ¯«ç§’ä¹‹åå†æ‰§è¡Œ</p>
<p><code>ScheduleMessageService.this.updateOffset()</code>ï¼šæ›´æ–°å»¶è¿Ÿçº§åˆ«é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦</p>
</li>
<li><p><code>PutMessageResult putMessageResult</code></p>
</li>
<li><p><code>bufferCQ == null</code>ï¼šè¯´æ˜é€šè¿‡æ¶ˆè´¹è¿›åº¦æ²¡æœ‰è·å–åˆ°æ•°æ®</p>
<p><code>if (offset &lt; cqMinOffset)</code>ï¼šå¦‚æœæ¶ˆè´¹è¿›åº¦æ¯”æœ€å°ä½ç‚¹éƒ½å°ï¼Œè¯´æ˜æ˜¯è¿‡æœŸæ•°æ®ï¼Œé‡ç½®ä¸ºæœ€å°ä½ç‚¹ </p>
</li>
<li><p><code>ScheduleMessageService.this.timer.schedule()</code>ï¼šé‡æ–°æäº¤è¯¥å»¶è¿Ÿçº§åˆ«å¯¹åº”çš„å»¶è¿Ÿé˜Ÿåˆ—ä»»åŠ¡ï¼Œå»¶è¿Ÿ 100 æ¯«ç§’åæ‰§è¡Œ</p>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="äº‹åŠ¡æ¶ˆæ¯-1"><a href="#äº‹åŠ¡æ¶ˆæ¯-1" class="headerlink" title="äº‹åŠ¡æ¶ˆæ¯"></a>äº‹åŠ¡æ¶ˆæ¯</h4><h5 id="ç”Ÿäº§è€…ç±»-2"><a href="#ç”Ÿäº§è€…ç±»-2" class="headerlink" title="ç”Ÿäº§è€…ç±»"></a>ç”Ÿäº§è€…ç±»</h5><p>TransactionMQProducer ç±»å‘é€äº‹åŠ¡æ¶ˆæ¯æ—¶ä½¿ç”¨</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>äº‹åŠ¡å›æŸ¥çº¿ç¨‹æ± èµ„æºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ExecutorService executorService;</span><br></pre></td></tr></table></figure>
</li>
<li><p>äº‹åŠ¡ç›‘å¬å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> TransactionListener transactionListener;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li><p>start()ï¼šå¯åŠ¨æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>this.defaultMQProducerImpl.initTransactionEnv()</code>ï¼šåˆå§‹åŒ–ç”Ÿäº§è€…å®ä¾‹å’Œå›æŸ¥çº¿ç¨‹æ± èµ„æº</li>
<li><code>super.start()</code>ï¼šå¯åŠ¨ç”Ÿäº§è€…å®ä¾‹</li>
</ul>
</li>
<li><p>sendMessageInTransaction()ï¼šå‘é€äº‹åŠ¡æ¶ˆæ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> TransactionSendResult <span class="title function_">sendMessageInTransaction</span><span class="params">(<span class="keyword">final</span> Message msg, <span class="keyword">final</span> Object arg)</span> &#123;</span><br><span class="line">    msg.setTopic(NamespaceUtil.wrapNamespace(<span class="built_in">this</span>.getNamespace(), msg.getTopic()));</span><br><span class="line">    <span class="comment">// è°ƒç”¨å®ç°ç±»çš„å‘é€æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.defaultMQProducerImpl.sendMessageInTransaction(msg, <span class="literal">null</span>, arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>TransactionListener transactionListener = getCheckListener()</code>ï¼šè·å–ç›‘å¬å™¨</p>
</li>
<li><p><code>if (null == localTransactionExecuter &amp;&amp; null == transactionListener)</code>ï¼šä¸¤è€…éƒ½ä¸º null æŠ›å‡ºå¼‚å¸¸</p>
</li>
<li><p><code>MessageAccessor.putProperty(msg, MessageConst.PROPERTY_TRANSACTION_PREPARED, &quot;true&quot;)</code>ï¼š<strong>è®¾ç½®äº‹åŠ¡æ ‡å¿—</strong></p>
</li>
<li><p><code>sendResult = this.send(msg)</code>ï¼šå‘é€æ¶ˆæ¯ï¼ŒåŒæ­¥å‘é€</p>
</li>
<li><p><code>switch (sendResult.getSendStatus())</code>ï¼š<strong>åˆ¤æ–­å‘é€æ¶ˆæ¯çš„ç»“æœçŠ¶æ€</strong></p>
</li>
<li><p><code>case SEND_OK</code>ï¼šæ¶ˆæ¯å‘é€æˆåŠŸ</p>
<p><code>msg.setTransactionId(transactionId)</code>ï¼š<strong>è®¾ç½®äº‹åŠ¡ ID ä¸ºæ¶ˆæ¯çš„ UNIQ_KEY å±æ€§</strong></p>
<p><code>localTransactionState = ...executeLocalTransactionBranch(msg, arg)</code>ï¼š<strong>æ‰§è¡Œæœ¬åœ°äº‹åŠ¡</strong></p>
</li>
<li><p><code>case SLAVE_NOT_AVAILABLE</code>ï¼šå…¶ä»–æƒ…å†µéƒ½éœ€è¦å›æ»šäº‹åŠ¡</p>
<p><code>localTransactionState = LocalTransactionState.ROLLBACK_MESSAGE</code>ï¼š<strong>äº‹åŠ¡çŠ¶æ€è®¾ç½®ä¸ºå›æ»š</strong></p>
</li>
<li><p><code>this.endTransaction(sendResult, ...)</code>ï¼šç»“æŸäº‹åŠ¡</p>
<ul>
<li><code>EndTransactionRequestHeader requestHeader</code>ï¼šæ„å»ºäº‹åŠ¡ç»“æŸå¤´å¯¹è±¡</li>
<li><code>this.mQClientFactory.getMQClientAPIImpl().endTransactionOneway()</code>ï¼šå‘ Broker å‘èµ·äº‹åŠ¡ç»“æŸçš„å•å‘è¯·æ±‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h5 id="æ¥å—æ¶ˆæ¯"><a href="#æ¥å—æ¶ˆæ¯" class="headerlink" title="æ¥å—æ¶ˆæ¯"></a>æ¥å—æ¶ˆæ¯</h5><p>SendMessageProcessor æ˜¯æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯å‘é€æ¥çš„æ¶ˆæ¯çš„å¤„ç†å™¨ï¼Œ<code>processRequest()</code> æ–¹æ³•å¤„ç†è¯·æ±‚</p>
<p>æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li><p><code>asyncProcessRequest()</code>ï¼šå¤„ç†è¯·æ±‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletableFuture&lt;RemotingCommand&gt; <span class="title function_">asyncProcessRequest</span><span class="params">(ChannelHandlerContext ctx,</span></span><br><span class="line"><span class="params">                                                              RemotingCommand request)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> SendMessageContext mqtraceContext;</span><br><span class="line">    <span class="keyword">switch</span> (request.getCode()) &#123;</span><br><span class="line">            <span class="comment">// å›è°ƒæ¶ˆæ¯å›é€€</span></span><br><span class="line">        <span class="keyword">case</span> RequestCode.CONSUMER_SEND_MSG_BACK:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.asyncConsumerSendMsgBack(ctx, request);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// è§£æå‡ºè¯·æ±‚å¤´å¯¹è±¡</span></span><br><span class="line">            <span class="type">SendMessageRequestHeader</span> <span class="variable">requestHeader</span> <span class="operator">=</span> parseRequestHeader(request);</span><br><span class="line">            <span class="keyword">if</span> (requestHeader == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡</span></span><br><span class="line">            mqtraceContext = buildMsgContext(ctx, requestHeader);</span><br><span class="line">            <span class="comment">// å‰ç½®å¤„ç†å™¨</span></span><br><span class="line">            <span class="built_in">this</span>.executeSendMessageHookBefore(ctx, request, mqtraceContext);</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯æ‰¹é‡æ¶ˆæ¯</span></span><br><span class="line">            <span class="keyword">if</span> (requestHeader.isBatch()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.asyncSendBatchMessage(ctx, request, mqtraceContext, requestHeader);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.asyncSendMessage(ctx, request, mqtraceContext, requestHeader);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>asyncSendMessage()ï¼šå¼‚æ­¥å¤„ç†å‘é€æ¶ˆæ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> CompletableFuture&lt;RemotingCommand&gt; <span class="title function_">asyncSendMessage</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand request, SendMessageContext mqtraceContext, SendMessageRequestHeader requestHeader)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>RemotingCommand response</code>ï¼šåˆ›å»ºå“åº”å¯¹è±¡</p>
</li>
<li><p><code>MessageExtBrokerInner msgInner = new MessageExtBrokerInner()</code>ï¼šåˆ›å»º msgInner å¯¹è±¡ï¼Œå¹¶èµ‹å€¼ç›¸å…³çš„å±æ€§ï¼Œä¸»é¢˜å’Œé˜Ÿåˆ— ID éƒ½æ˜¯è¯·æ±‚å¤´ä¸­çš„</p>
</li>
<li><p><code>String transFlag</code>ï¼š<strong>è·å–äº‹åŠ¡å±æ€§</strong></p>
</li>
<li><p><code>if (transFlag != null &amp;&amp; Boolean.parseBoolean(transFlag))</code>ï¼šåˆ¤æ–­äº‹åŠ¡å±æ€§æ˜¯å¦æ˜¯ trueï¼Œèµ°äº‹åŠ¡æ¶ˆæ¯çš„å­˜å‚¨æµç¨‹</p>
<ul>
<li><p><code>putMessageResult = ...asyncPrepareMessage(msgInner)</code>ï¼š<strong>äº‹åŠ¡æ¶ˆæ¯å¤„ç†æµç¨‹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletableFuture&lt;PutMessageResult&gt; <span class="title function_">asyncPutHalfMessage</span><span class="params">(MessageExtBrokerInner messageInner)</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨å­˜å‚¨æ¨¡å—ï¼Œå°†ä¿®æ”¹åçš„ msg å­˜å‚¨è¿› Broker(CommitLog)</span></span><br><span class="line">    <span class="keyword">return</span> store.asyncPutMessage(parseHalfMessageInner(messageInner));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TransactionalMessageBridge#parseHalfMessageInnerï¼š</p>
<ul>
<li><code>MessageAccessor.putProperty(...)</code>ï¼š<strong>å°†æ¶ˆæ¯çš„åŸä¸»é¢˜å’Œé˜Ÿåˆ— ID æ”¾å…¥æ¶ˆæ¯çš„å±æ€§ä¸­</strong></li>
<li><code>msgInner.setSysFlag(...)</code>ï¼šæ¶ˆæ¯è®¾ç½®ä¸ºéäº‹åŠ¡çŠ¶æ€</li>
<li><code>msgInner.setTopic(TransactionalMessageUtil.buildHalfTopic())</code>ï¼š<strong>æ¶ˆæ¯ä¸»é¢˜è®¾ç½®ä¸ºåŠæ¶ˆæ¯ä¸»é¢˜</strong></li>
<li><code>msgInner.setQueueId(0)</code>ï¼š<strong>é˜Ÿåˆ— ID è®¾ç½®ä¸º 0</strong></li>
</ul>
</li>
</ul>
</li>
<li><p><code>else</code>ï¼šæ™®é€šæ¶ˆæ¯å­˜å‚¨</p>
</li>
</ul>
</li>
</ul>
<hr>
<h5 id="å›æŸ¥å¤„ç†"><a href="#å›æŸ¥å¤„ç†" class="headerlink" title="å›æŸ¥å¤„ç†"></a>å›æŸ¥å¤„ç†</h5><p>ClientRemotingProcessor æ˜¯å®¢æˆ·ç«¯ç”¨äºå¤„ç†è¯·æ±‚ï¼Œåˆ›å»º MQClientAPIImpl æ—¶å°†è¯¥å¤„ç†å™¨æ³¨å†Œåˆ° Netty ä¸­ï¼Œ<code>processRequest()</code> æ–¹æ³•æ ¹æ®è¯·æ±‚çš„å‘½ä»¤ç ï¼Œè¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œäº‹åŠ¡å›æŸ¥çš„å¤„ç†å‘½ä»¤ç ä¸º <code>CHECK_TRANSACTION_STATE</code></p>
<p>Broker ç«¯æœ‰å®šæ—¶ä»»åŠ¡å‘é€å›æŸ¥è¯·æ±‚</p>
<p>æˆå‘˜æ–¹æ³•ï¼š</p>
<ul>
<li><p>checkTransactionState()ï¼šæ£€æŸ¥äº‹åŠ¡çŠ¶æ€</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RemotingCommand <span class="title function_">checkTransactionState</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand request)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>final CheckTransactionStateRequestHeader requestHeader</code>ï¼šè§£æå‡ºè¯·æ±‚å¤´å¯¹è±¡</li>
<li><code>final MessageExt messageExt</code>ï¼šä»è¯·æ±‚ body ä¸­è§£æå‡ºæœåŠ¡å™¨å›æŸ¥çš„äº‹åŠ¡æ¶ˆæ¯</li>
<li><code>String transactionId</code>ï¼šæå– UNIQ_KEY å­—æ®µå±æ€§å€¼èµ‹å€¼ç»™äº‹åŠ¡ ID</li>
<li><code>final String group</code>ï¼šæå–ç”Ÿäº§è€…ç»„å</li>
<li><code>MQProducerInner producer = this...selectProducer(group)</code>ï¼šæ ¹æ®ç”Ÿäº§è€…ç»„è·å–ç”Ÿäº§è€…å¯¹è±¡</li>
<li><code>String addr = RemotingHelper.parseChannelRemoteAddr()</code>ï¼šè§£æå‡ºè¦å›æŸ¥çš„ Broker æœåŠ¡å™¨çš„åœ°å€</li>
<li><code>producer.checkTransactionState(addr, messageExt, requestHeader)</code>ï¼šç”Ÿäº§è€…çš„äº‹åŠ¡å›æŸ¥<ul>
<li><code>Runnable request = new Runnable()</code>ï¼š<strong>åˆ›å»ºå›æŸ¥äº‹åŠ¡çŠ¶æ€ä»»åŠ¡å¯¹è±¡</strong><ul>
<li>è·å–ç”Ÿäº§è€…çš„ TransactionCheckListener å’Œ TransactionListenerï¼Œé€‰æ‹©ä¸€ä¸ªä¸ä¸º null çš„ç›‘å¬å™¨è¿›è¡Œäº‹åŠ¡çŠ¶æ€å›æŸ¥</li>
<li><code>this.processTransactionState()</code>ï¼šå¤„ç†å›æŸ¥çŠ¶æ€<ul>
<li><code>EndTransactionRequestHeader thisHeader</code>ï¼šæ„å»º EndTransactionRequestHeader å¯¹è±¡</li>
<li><code>DefaultMQProducerImpl...endTransactionOneway()</code>ï¼šå‘ Broker å‘èµ·ç»“æŸäº‹åŠ¡å•å‘è¯·æ±‚ï¼Œ<strong>äºŒé˜¶æ®µæäº¤</strong></li>
</ul>
</li>
</ul>
</li>
<li><code>this.checkExecutor.submit(request)</code>ï¼šæäº¤åˆ°çº¿ç¨‹æ± è¿è¡Œ</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>å‚è€ƒå›¾ï¼š<a target="_blank" rel="noopener" href="https://www.processon.com/view/link/61c8257e0e3e7474fb9dcbc0">https://www.processon.com/view/link/61c8257e0e3e7474fb9dcbc0</a></p>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://space.bilibili.com/457326371">https://space.bilibili.com/457326371</a></p>
<hr>
<h5 id="äº‹åŠ¡æäº¤"><a href="#äº‹åŠ¡æäº¤" class="headerlink" title="äº‹åŠ¡æäº¤"></a>äº‹åŠ¡æäº¤</h5><p>EndTransactionProcessor ç±»æ˜¯æœåŠ¡ç«¯ç”¨æ¥å¤„ç†å®¢æˆ·ç«¯å‘æ¥çš„æäº¤æˆ–è€…å›æ»šè¯·æ±‚</p>
<ul>
<li><p>processRequest()ï¼šå¤„ç†è¯·æ±‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RemotingCommand <span class="title function_">processRequest</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand request)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>EndTransactionRequestHeader requestHeader</code>ï¼šä»è¯·æ±‚ä¸­è§£æå‡º EndTransactionRequestHeader</p>
</li>
<li><p><code>if (MessageSysFlag.TRANSACTION_COMMIT_TYPE)</code>ï¼š<strong>äº‹åŠ¡æäº¤</strong></p>
<p><code>result = this.brokerController...commitMessage(requestHeader)</code>ï¼šæ ¹æ® commitLogOffset æå–å‡º halfMsg æ¶ˆæ¯</p>
<p><code>MessageExtBrokerInner msgInner</code>ï¼šæ ¹æ® result å…‹éš†å‡ºä¸€æ¡æ–°æ¶ˆæ¯</p>
<ul>
<li><p><code>msgInner.setTopic(msgExt.getUserProperty(...))</code>ï¼š<strong>è®¾ç½®å›åŸä¸»é¢˜</strong></p>
</li>
<li><p><code>msgInner.setQueueId(Integer.parseInt(msgExt.getUserProperty(..)))</code>ï¼š<strong>è®¾ç½®å›åŸé˜Ÿåˆ— ID</strong></p>
</li>
<li><code>MessageAccessor.clearProperty()</code>ï¼šæ¸…ç†ä¸Šé¢çš„ä¸¤ä¸ªå±æ€§</li>
</ul>
<p><code>MessageAccessor.clearProperty(msgInner, ...)</code>ï¼š<strong>æ¸…ç†äº‹åŠ¡å±æ€§</strong></p>
<p><code>RemotingCommand sendResult = sendFinalMessage(msgInner)</code>ï¼šè°ƒç”¨å­˜å‚¨æ¨¡å—å­˜å‚¨è‡³ Broker</p>
<p><code>this.brokerController...deletePrepareMessage(result.getPrepareMessage())</code>ï¼š<strong>å‘åˆ é™¤ï¼ˆOPï¼‰é˜Ÿåˆ—æ·»åŠ æ¶ˆæ¯</strong>ï¼Œæ¶ˆæ¯ä½“çš„æ•°æ®æ˜¯ halfMsg çš„ queueOffsetï¼Œ<strong>è¡¨ç¤ºåŠæ¶ˆæ¯é˜Ÿåˆ—æŒ‡å®šçš„ offset çš„æ¶ˆæ¯å·²è¢«åˆ é™¤</strong></p>
<ul>
<li><code>if (this...putOpMessage(msgExt, TransactionalMessageUtil.REMOVETAG))</code>ï¼šæ·»åŠ ä¸€æ¡ OP æ•°æ®<ul>
<li><code>MessageQueue messageQueue</code>ï¼šæ–°å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼ŒOP é˜Ÿåˆ—</li>
<li><code>return addRemoveTagInTransactionOp(messageExt, messageQueue)</code>ï¼šæ·»åŠ æ•°æ®<ul>
<li><code>Message message</code>ï¼šåˆ›å»º OP æ¶ˆæ¯</li>
<li><code>writeOp(message, messageQueue)</code>ï¼šå†™å…¥ OP æ¶ˆæ¯</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>else if (MessageSysFlag.TRANSACTION_ROLLBACK_TYPE)</code>ï¼š<strong>äº‹åŠ¡å›æ»š</strong></p>
<p><code>this.brokerController...deletePrepareMessage(result.getPrepareMessage())</code>ï¼š<strong>ä¹Ÿéœ€è¦å‘ OP é˜Ÿåˆ—æ·»åŠ æ¶ˆæ¯</strong></p>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h3><h4 id="æ¶ˆè´¹è€…ç±»"><a href="#æ¶ˆè´¹è€…ç±»" class="headerlink" title="æ¶ˆè´¹è€…ç±»"></a>æ¶ˆè´¹è€…ç±»</h4><h5 id="é»˜è®¤æ¶ˆè´¹"><a href="#é»˜è®¤æ¶ˆè´¹" class="headerlink" title="é»˜è®¤æ¶ˆè´¹"></a>é»˜è®¤æ¶ˆè´¹</h5><p>DefaultMQPushConsumer ç±»æ˜¯é»˜è®¤çš„æ¶ˆè´¹è€…ç±»</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>æ¶ˆè´¹è€…å®ç°ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">transient</span> DefaultMQPushConsumerImpl defaultMQPushConsumerImpl;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆè´¹å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String consumerGroup;									<span class="comment">// æ¶ˆè´¹è€…ç»„</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">MessageModel</span> <span class="variable">messageModel</span> <span class="operator">=</span> MessageModel.CLUSTERING;	<span class="comment">// æ¶ˆè´¹æ¨¡å¼ï¼Œé»˜è®¤é›†ç¾¤æ¨¡å¼</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>è®¢é˜…ä¿¡æ¯ï¼škey æ˜¯ä¸»é¢˜ï¼Œvalue æ˜¯è¿‡æ»¤è¡¨è¾¾å¼ï¼Œä¸€èˆ¬æ˜¯ tag</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, String &gt; subscription = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;()</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆæ¯ç›‘å¬å™¨ï¼š<strong>æ¶ˆæ¯å¤„ç†é€»è¾‘</strong>ï¼Œå¹¶å‘æ¶ˆè´¹ MessageListenerConcurrentlyï¼Œé¡ºåºï¼ˆåˆ†åŒºï¼‰æ¶ˆè´¹ MessageListenerOrderly</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> MessageListener messageListener;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆè´¹ä½ç‚¹ï¼šå½“ä» Broker è·å–å½“å‰ç»„å†…è¯¥ queue çš„ offset ä¸å­˜åœ¨æ—¶ï¼ŒconsumeFromWhere æ‰æœ‰æ•ˆï¼Œé»˜è®¤å€¼ä»£è¡¨ä»é˜Ÿåˆ—çš„æœ€å offset å¼€å§‹æ¶ˆè´¹ï¼Œå½“é˜Ÿåˆ—å†…å†æœ‰ä¸€æ¡æ–°çš„ msg åŠ å…¥æ—¶ï¼Œæ¶ˆè´¹è€…æ‰ä¼šå»æ¶ˆè´¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">ConsumeFromWhere</span> <span class="variable">consumeFromWhere</span> <span class="operator">=</span> ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆè´¹æ—¶é—´æˆ³ï¼šå½“æ¶ˆè´¹ä½ç‚¹é…ç½®çš„æ˜¯ CONSUME_FROM_TIMESTAMP æ—¶ï¼Œå¹¶ä¸”æœåŠ¡å™¨ Group å†…ä¸å­˜åœ¨è¯¥ queue çš„ offset æ—¶ï¼Œä¼šä½¿ç”¨è¯¥æ—¶é—´æˆ³è¿›è¡Œæ¶ˆè´¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">consumeTimestamp</span> <span class="operator">=</span> UtilAll.timeMillisToHumanString3(System.currentTimeMillis() - (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">30</span>));<span class="comment">// æ¶ˆè´¹è€…åˆ›å»ºæ—¶é—´ - 30ç§’ï¼Œè½¬æ¢æˆ æ ¼å¼ï¼š å¹´æœˆæ—¥å°æ—¶åˆ†é’Ÿç§’ï¼Œæ¯”å¦‚ 20220203171201</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>é˜Ÿåˆ—åˆ†é…ç­–ç•¥ï¼šä¸»é¢˜ä¸‹çš„é˜Ÿåˆ—åˆ†é…ç­–ç•¥ï¼ŒRebalanceImpl å¯¹è±¡ä¾èµ–è¯¥ç®—æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> AllocateMessageQueueStrategy allocateMessageQueueStrategy;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆè´¹è¿›åº¦å­˜å‚¨å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> OffsetStore offsetStore;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li><p>start()ï¼šå¯åŠ¨æ¶ˆè´¹è€…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>shutdown()ï¼šå…³é—­æ¶ˆè´¹è€…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>registerMessageListener()ï¼šæ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerMessageListener</span><span class="params">(MessageListener messageListener)</span> </span><br></pre></td></tr></table></figure>
</li>
<li><p>subscribe()ï¼šæ·»åŠ è®¢é˜…ä¿¡æ¯ï¼Œ<strong>å°†è®¢é˜…ä¿¡æ¯æ”¾å…¥è´Ÿè½½å‡è¡¡å¯¹è±¡çš„ subscriptionInner ä¸­</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(String topic, String subExpression)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>unsubscribe()ï¼šåˆ é™¤è®¢é˜…æŒ‡å®šä¸»é¢˜çš„ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unsubscribe</span><span class="params">(String topic)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>suspend()ï¼šåœæ­¢æ¶ˆè´¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">suspend</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>resume()ï¼šæ¢å¤æ¶ˆè´¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">resume</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="é»˜è®¤å®ç°"><a href="#é»˜è®¤å®ç°" class="headerlink" title="é»˜è®¤å®ç°"></a>é»˜è®¤å®ç°</h5><p>DefaultMQPushConsumerImpl æ˜¯é»˜è®¤æ¶ˆè´¹è€…çš„å®ç°ç±»</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>å®¢æˆ·ç«¯å®ä¾‹ï¼šæ•´ä¸ªè¿›ç¨‹å†…åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯å®ä¾‹å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> MQClientInstance mQClientFactory;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆè´¹è€…å®ä¾‹ï¼šé—¨é¢å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DefaultMQPushConsumer defaultMQPushConsumer;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šåˆ†é…è®¢é˜…ä¸»é¢˜çš„é˜Ÿåˆ—ç»™å½“å‰æ¶ˆè´¹è€…ï¼Œ20 ç§’é’Ÿä¸€ä¸ªå‘¨æœŸæ‰§è¡Œ Rebalance ç®—æ³•ï¼ˆå®¢æˆ·ç«¯å®ä¾‹è§¦å‘ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">RebalanceImpl</span> <span class="variable">rebalanceImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RebalancePushImpl</span>(<span class="built_in">this</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆè´¹è€…ä¿¡æ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> consumerStartTimestamp;	<span class="comment">// æ¶ˆè´¹è€…å¯åŠ¨æ—¶é—´</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ServiceState serviceState;	<span class="comment">// æ¶ˆè´¹è€…çŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">pause</span> <span class="operator">=</span> <span class="literal">false</span>;		<span class="comment">// æ˜¯å¦æš‚åœ</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">consumeOrderly</span> <span class="operator">=</span> <span class="literal">false</span>;		<span class="comment">// æ˜¯å¦é¡ºåºæ¶ˆè´¹</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>æ‹‰å–æ¶ˆæ¯</strong>ï¼šå°è£…æ‹‰æ¶ˆæ¯çš„ APIï¼ŒæœåŠ¡å™¨ Broker è¿”å›ç»“æœä¸­åŒ…å«ä¸‹æ¬¡ Pull æ—¶æ¨èçš„ BrokerIdï¼Œæ ¹æ®æœ¬æ¬¡è¯·æ±‚æ•°æ®çš„å†·çƒ­ç¨‹åº¦è¿›è¡Œæ¨è</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PullAPIWrapper pullAPIWrapper;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>æ¶ˆæ¯æ¶ˆè´¹</strong>æœåŠ¡ï¼šå¹¶å‘æ¶ˆè´¹å’Œé¡ºåºæ¶ˆè´¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ConsumeMessageService consumeMessageService;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æµæ§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="variable">queueFlowControlTimes</span> <span class="operator">=</span> <span class="number">0</span>;			<span class="comment">// é˜Ÿåˆ—æµæ§æ¬¡æ•°ï¼Œé»˜è®¤æ¯1000æ¬¡æµæ§ï¼Œè¿›è¡Œä¸€æ¬¡æ—¥å¿—æ‰“å°</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="variable">queueMaxSpanFlowControlTimes</span> <span class="operator">=</span> <span class="number">0</span>;	<span class="comment">// æµæ§ä½¿ç”¨ï¼Œæ§åˆ¶æ‰“å°æ—¥å¿—</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>HOOKï¼šé’©å­æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿‡æ»¤æ¶ˆæ¯ hook</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;FilterMessageHook&gt; filterMessageHookList;</span><br><span class="line"><span class="comment">// æ¶ˆæ¯æ‰§è¡Œhookï¼Œåœ¨æ¶ˆæ¯å¤„ç†å‰å’Œå¤„ç†ååˆ†åˆ«æ‰§è¡Œ hook.before  hook.after ç³»åˆ—æ–¹æ³•</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ConsumeMessageHook&gt; consumeMessageHookList;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li><p>start()ï¼šåŠ é”ä¿è¯çº¿ç¨‹å®‰å…¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> </span><br></pre></td></tr></table></figure>
<ul>
<li><code>this.checkConfig()</code>ï¼šæ£€æŸ¥é…ç½®ï¼ŒåŒ…æ‹¬ç»„åã€æ¶ˆè´¹æ¨¡å¼ã€è®¢é˜…ä¿¡æ¯ã€æ¶ˆæ¯ç›‘å¬å™¨ç­‰</li>
<li><code>this.copySubscription()</code>ï¼šæ‹·è´è®¢é˜…ä¿¡æ¯åˆ° RebalanceImpl å¯¹è±¡<ul>
<li><code>this.rebalanceImpl.getSubscriptionInner().put(topic, subscriptionData)</code>ï¼šå°†è®¢é˜…ä¿¡æ¯åŠ å…¥ rbl çš„ map ä¸­</li>
<li><code>this.messageListenerInner = ...getMessageListener()</code>ï¼šå°†æ¶ˆæ¯ç›‘å¬å™¨ä¿å­˜åˆ°å®ä¾‹å¯¹è±¡</li>
<li><code>switch (this.defaultMQPushConsumer.getMessageModel())</code>ï¼šåˆ¤æ–­æ¶ˆè´¹æ¨¡å¼ï¼Œå¹¿æ’­æ¨¡å¼ä¸‹ç›´æ¥è¿”å›</li>
<li><code>final String retryTopic</code>ï¼šåˆ›å»ºå½“å‰<strong>æ¶ˆè´¹è€…ç»„é‡è¯•çš„ä¸»é¢˜å</strong>ï¼Œè§„åˆ™ <code>%RETRY%ConsumerGroup</code></li>
<li><code>SubscriptionData subscriptionData = FilterAPI.buildSubscriptionData()</code>ï¼šåˆ›å»ºé‡è¯•ä¸»é¢˜çš„è®¢é˜…æ•°æ®å¯¹è±¡</li>
<li><code>this.rebalanceImpl.getSubscriptionInner().put(retryTopic, subscriptionData)</code>ï¼šå°†åˆ›å»ºçš„é‡è¯•ä¸»é¢˜åŠ å…¥åˆ° rbl å¯¹è±¡çš„ map ä¸­ï¼Œ<strong>æ¶ˆæ¯é‡è¯•æ—¶ä¼šåŠ å…¥åˆ°è¯¥ä¸»é¢˜ï¼Œæ¶ˆè´¹è€…è®¢é˜…è¿™ä¸ªä¸»é¢˜ä¹‹åï¼Œå°±æœ‰æœºä¼šå†æ¬¡æ‹¿åˆ°è¯¥æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹å¤„ç†</strong></li>
</ul>
</li>
<li><code>this.mQClientFactory = ...getOrCreateMQClientInstance()</code>ï¼šè·å–å®¢æˆ·ç«¯å®ä¾‹å¯¹è±¡</li>
<li><code>this.rebalanceImpl.</code>ï¼šåˆå§‹åŒ–è´Ÿè½½å‡è¡¡å¯¹è±¡ï¼Œè®¾ç½®<strong>é˜Ÿåˆ—åˆ†é…ç­–ç•¥å¯¹è±¡</strong>åˆ°å±æ€§ä¸­</li>
<li><code>this.pullAPIWrapper = new PullAPIWrapper()</code>ï¼šåˆ›å»ºæ‹‰æ¶ˆæ¯ API å¯¹è±¡ï¼Œå†…éƒ¨å°è£…äº†æŸ¥è¯¢æ¨èä¸»æœºç®—æ³•</li>
<li><code>this.pullAPIWrapper.registerFilterMessageHook(filterMessageHookList)</code>ï¼šå°†è¿‡æ»¤ Hook åˆ—è¡¨æ³¨å†Œåˆ°è¯¥å¯¹è±¡å†…ï¼Œæ¶ˆæ¯æ‹‰å–ä¸‹æ¥ä¹‹åä¼šæ‰§è¡Œè¯¥ Hookï¼Œ<strong>å†è¿›è¡Œä¸€æ¬¡è‡ªå®šä¹‰çš„æ¶ˆæ¯è¿‡æ»¤</strong></li>
<li><code>this.offsetStore = new RemoteBrokerOffsetStore()</code>ï¼šé»˜è®¤é›†ç¾¤æ¨¡å¼ä¸‹åˆ›å»ºæ¶ˆæ¯è¿›åº¦å­˜å‚¨å™¨</li>
<li><code>this.consumeMessageService = ...</code>ï¼šæ ¹æ®æ¶ˆæ¯ç›‘å¬å™¨çš„ç±»å‹åˆ›å»ºæ¶ˆè´¹æœåŠ¡</li>
<li><code>this.consumeMessageService.start()</code>ï¼šå¯åŠ¨æ¶ˆè´¹æœåŠ¡</li>
<li><code>boolean registerOK = mQClientFactory.registerConsumer()</code>ï¼š<strong>å°†æ¶ˆè´¹è€…æ³¨å†Œåˆ°å®¢æˆ·ç«¯å®ä¾‹ä¸­</strong>ï¼Œå®¢æˆ·ç«¯æä¾›çš„æœåŠ¡ï¼š<ul>
<li>å¿ƒè·³æœåŠ¡ï¼šæŠŠè®¢é˜…æ•°æ®åŒæ­¥åˆ°è®¢é˜…ä¸»é¢˜çš„ Broker</li>
<li>æ‹‰æ¶ˆæ¯æœåŠ¡ï¼šå†…éƒ¨ PullMessageService å¯åŠ¨çº¿ç¨‹ï¼ŒåŸºäº PullRequestQueue å·¥ä½œï¼Œæ¶ˆè´¹è€…è´Ÿè½½å‡è¡¡åˆ†é…åˆ°é˜Ÿåˆ—åä¼šå‘è¯¥é˜Ÿåˆ—æäº¤ PullRequest</li>
<li>é˜Ÿåˆ—è´Ÿè½½æœåŠ¡ï¼šæ¯ 20 ç§’è°ƒç”¨ä¸€æ¬¡ <code>consumer.doRebalance()</code> æ¥å£</li>
<li>æ¶ˆæ¯è¿›åº¦æŒä¹…åŒ–</li>
<li>åŠ¨æ€è°ƒæ•´æ¶ˆè´¹è€…ã€æ¶ˆè´¹æœåŠ¡çº¿ç¨‹æ± </li>
</ul>
</li>
<li><code>mQClientFactory.start()</code>ï¼šå¯åŠ¨å®¢æˆ·ç«¯å®ä¾‹</li>
<li><code>this.updateTopic</code>ï¼šä» nameserver è·å–ä¸»é¢˜è·¯ç”±æ•°æ®ï¼Œç”Ÿæˆä¸»é¢˜é›†åˆæ”¾å…¥ rbl å¯¹è±¡çš„ table</li>
<li><code>this.mQClientFactory.checkClientInBroker()</code>ï¼šæ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ”¯æŒæ¶ˆæ¯è¿‡æ»¤æ¨¡å¼ï¼Œä¸€èˆ¬ä½¿ç”¨ tag è¿‡æ»¤ï¼ŒæœåŠ¡å™¨é»˜è®¤æ”¯æŒ</li>
<li><code>this.mQClientFactory.sendHeartbeatToAllBrokerWithLock()</code>ï¼šå‘æ‰€æœ‰å·²çŸ¥çš„ Broker èŠ‚ç‚¹ï¼Œ<strong>å‘é€å¿ƒè·³æ•°æ®</strong></li>
<li><code>this.mQClientFactory.rebalanceImmediately()</code>ï¼šå”¤é†’ rbl çº¿ç¨‹ï¼Œè§¦å‘è´Ÿè½½å‡è¡¡æ‰§è¡Œ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="è´Ÿè½½å‡è¡¡-1"><a href="#è´Ÿè½½å‡è¡¡-1" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h4><h5 id="å®ç°æ–¹å¼"><a href="#å®ç°æ–¹å¼" class="headerlink" title="å®ç°æ–¹å¼"></a>å®ç°æ–¹å¼</h5><p>MQClientInstance#start ä¸­ä¼šå¯åŠ¨è´Ÿè½½å‡è¡¡æœåŠ¡ RebalanceServiceï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">// æ£€æŸ¥åœæ­¢æ ‡è®°</span></span><br><span class="line">    <span class="keyword">while</span> (!<span class="built_in">this</span>.isStopped()) &#123;</span><br><span class="line">        <span class="comment">// ä¼‘çœ  20 ç§’ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹é¥¥é¥¿ï¼Œæ‰€ä»¥ã€æ¯ 20 ç§’è´Ÿè½½å‡è¡¡ä¸€æ¬¡ã€‘</span></span><br><span class="line">        <span class="built_in">this</span>.waitForRunning(waitInterval);</span><br><span class="line">        <span class="comment">// è°ƒç”¨å®¢æˆ·ç«¯å®ä¾‹çš„è´Ÿè½½å‡è¡¡æ–¹æ³•ï¼Œåº•å±‚ã€ä¼šéå†æ‰€æœ‰æ¶ˆè´¹è€…ï¼Œè°ƒç”¨æ¶ˆè´¹è€…çš„è´Ÿè½½å‡è¡¡ã€‘</span></span><br><span class="line">        <span class="built_in">this</span>.mqClientFactory.doRebalance();</span><br><span class="line">    &#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RebalanceImpl ç±»æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>åˆ†é…ç»™å½“å‰æ¶ˆè´¹è€…çš„å¤„ç†é˜Ÿåˆ—ï¼šå¤„ç†æ¶ˆæ¯é˜Ÿåˆ—é›†åˆï¼Œ<strong>ProcessQueue æ˜¯ MQ é˜Ÿåˆ—åœ¨æ¶ˆè´¹è€…ç«¯çš„å¿«ç…§</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ConcurrentMap&lt;MessageQueue, ProcessQueue&gt; processQueueTable;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆè´¹è€…è®¢é˜…ä¸»é¢˜çš„é˜Ÿåˆ—ä¿¡æ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ConcurrentMap&lt;String<span class="comment">/* topic */</span>, Set&lt;MessageQueue&gt;&gt; topicSubscribeInfoTable;</span><br></pre></td></tr></table></figure>
</li>
<li><p>è®¢é˜…æ•°æ®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ConcurrentMap&lt;String<span class="comment">/* topic */</span>, SubscriptionData&gt; subscriptionInner;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é˜Ÿåˆ—åˆ†é…ç­–ç•¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> AllocateMessageQueueStrategy allocateMessageQueueStrategy;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æˆå‘˜æ–¹æ³•ï¼š</p>
<ul>
<li><p>doRebalance()ï¼šè´Ÿè½½å‡è¡¡æ–¹æ³•ï¼Œä»¥æ¯ä¸ªæ¶ˆè´¹è€…å®ä¾‹ä¸ºç²’åº¦è¿›è¡Œè´Ÿè½½å‡è¡¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doRebalance</span><span class="params">(<span class="keyword">final</span> <span class="type">boolean</span> isOrder)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰æ¶ˆè´¹è€…çš„è®¢é˜…æ•°æ®</span></span><br><span class="line">    Map&lt;String, SubscriptionData&gt; subTable = <span class="built_in">this</span>.getSubscriptionInner();</span><br><span class="line">    <span class="keyword">if</span> (subTable != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// éå†æ‰€æœ‰çš„è®¢é˜…ä¸»é¢˜</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Entry&lt;String, SubscriptionData&gt; entry : subTable.entrySet()) &#123;</span><br><span class="line">            <span class="comment">// è·å–è®¢é˜…çš„ä¸»é¢˜</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            <span class="comment">// æŒ‰ç…§ä¸»é¢˜è¿›è¡Œè´Ÿè½½å‡è¡¡</span></span><br><span class="line">            <span class="built_in">this</span>.rebalanceByTopic(topic, isOrder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†åˆ†é…åˆ°å½“å‰æ¶ˆè´¹è€…çš„é˜Ÿåˆ—è¿›è¡Œè¿‡æ»¤ï¼Œä¸å±äºå½“å‰æ¶ˆè´¹è€…è®¢é˜…ä¸»é¢˜çš„ç›´æ¥ç§»é™¤</span></span><br><span class="line">    <span class="built_in">this</span>.truncateMessageQueueNotMyTopic();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é›†ç¾¤æ¨¡å¼ä¸‹ï¼š</p>
<ul>
<li><p><code>Set&lt;MessageQueue&gt; mqSet = this.topicSubscribeInfoTable.get(topic)</code>ï¼šè®¢é˜…çš„ä¸»é¢˜ä¸‹çš„å…¨éƒ¨é˜Ÿåˆ—ä¿¡æ¯</p>
</li>
<li><p><code>cidAll = this...findConsumerIdList(topic, consumerGroup)</code>ï¼šä»æœåŠ¡å™¨è·å–æ¶ˆè´¹è€…ç»„ä¸‹çš„å…¨éƒ¨æ¶ˆè´¹è€… ID</p>
</li>
<li><p><code>Collections.sort(mqAll)</code>ï¼šä¸»é¢˜ MQ é˜Ÿåˆ—å’Œæ¶ˆè´¹è€… ID éƒ½è¿›è¡Œæ’åºï¼Œ<strong>ä¿è¯æ¯ä¸ªæ¶ˆè´¹è€…çš„è§†å›¾ä¸€è‡´æ€§</strong></p>
</li>
<li><p><code>allocateResult = strategy.allocate()</code>ï¼š <strong>è°ƒç”¨é˜Ÿåˆ—åˆ†é…ç­–ç•¥</strong>ï¼Œç»™å½“å‰æ¶ˆè´¹è€…è¿›è¡Œåˆ†é… MessageQueueï¼ˆä¸‹ä¸€èŠ‚ï¼‰</p>
</li>
<li><p><code>boolean changed = this.updateProcessQueueTableInRebalance(...)</code>ï¼š<strong>æ›´æ–°é˜Ÿåˆ—å¤„ç†é›†åˆ</strong>ï¼ŒmqSet æ˜¯ rbl ç®—æ³•åˆ†é…åˆ°å½“å‰æ¶ˆè´¹è€…çš„ MQ é›†åˆ</p>
<ul>
<li><p><code>while (it.hasNext())</code>ï¼šéå†å½“å‰æ¶ˆè´¹è€…çš„æ‰€æœ‰å¤„ç†é˜Ÿåˆ—</p>
</li>
<li><p><code>if (mq.getTopic().equals(topic))</code>ï¼šè¯¥ MQ æ˜¯ æœ¬æ¬¡ rbl åˆ†é…ç®—æ³•è®¡ç®—çš„ä¸»é¢˜</p>
</li>
<li><p><code>if (!mqSet.contains(mq))</code>ï¼šè¯¥ MQ ç»è¿‡ rbl è®¡ç®—ä¹‹åï¼Œ<strong>è¢«åˆ†é…åˆ°å…¶å®ƒ Consumer èŠ‚ç‚¹</strong></p>
<p><code>pq.setDropped(true)</code>ï¼šå°†åˆ é™¤çŠ¶æ€è®¾ç½®ä¸º true</p>
<p><code>if (this.removeUnnecessaryMessageQueue(mq, pq))</code>ï¼šåˆ é™¤ä¸éœ€è¦çš„ MQ é˜Ÿåˆ—</p>
<ul>
<li><p><code>this...getOffsetStore().persist(mq)</code>ï¼šåœ¨ MQ å½’å±çš„ Broker èŠ‚ç‚¹æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦</p>
</li>
<li><p><code>this...getOffsetStore().removeOffset(mq)</code>ï¼šåˆ é™¤è¯¥ MQ åœ¨æœ¬åœ°çš„æ¶ˆè´¹è¿›åº¦</p>
</li>
<li><p><code>if (this.defaultMQPushConsumerImpl.isConsumeOrderly() &amp;&amp;)</code>ï¼šæ˜¯å¦æ˜¯<strong>é¡ºåºæ¶ˆè´¹</strong>å’Œé›†ç¾¤æ¨¡å¼</p>
<p><code>if (pq.getLockConsume().tryLock(1000, ..))</code>ï¼š è·å–é”æˆåŠŸï¼Œè¯´æ˜é¡ºåºæ¶ˆè´¹ä»»åŠ¡å·²ç»åœæ­¢æ¶ˆè´¹å·¥ä½œ</p>
<p><code>return this.unlockDelay(mq, pq)</code>ï¼š<strong>é‡Šæ”¾é” Broker ç«¯çš„é˜Ÿåˆ—é”ï¼Œå‘æœåŠ¡å™¨å‘èµ· oneway çš„è§£é”è¯·æ±‚</strong></p>
<ul>
<li><code>if (pq.hasTempMessage())</code>ï¼šé˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯ï¼Œå»¶è¿Ÿ 20 ç§’é‡Šæ”¾é˜Ÿåˆ—åˆ†å¸ƒå¼é”ï¼Œç¡®ä¿å…¨å±€èŒƒå›´å†…åªæœ‰ä¸€ä¸ªæ¶ˆè´¹ä»»åŠ¡ è¿è¡Œä¸­</li>
<li><code>else</code>ï¼šå½“å‰æ¶ˆè´¹è€…æœ¬åœ°è¯¥æ¶ˆè´¹ä»»åŠ¡å·²ç»é€€å‡ºï¼Œç›´æ¥é‡Šæ”¾é”</li>
</ul>
<p><code>else</code>ï¼šé¡ºåºæ¶ˆè´¹ä»»åŠ¡æ­£åœ¨æ¶ˆè´¹ä¸€æ‰¹æ¶ˆæ¯ï¼Œä¸å¯æ‰“æ–­ï¼Œå¢åŠ å°è¯•è·å–é”çš„æ¬¡æ•°</p>
</li>
</ul>
<p><code>it.remove()</code>ï¼šä» processQueueTable ç§»é™¤è¯¥ MQ</p>
</li>
<li><p><code>else if (pq.isPullExpired())</code>ï¼šè¯´æ˜å½“å‰ MQ è¿˜æ˜¯è¢«å½“å‰ Consumer æ¶ˆè´¹ï¼Œæ­¤æ—¶åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦è¶…è¿‡ 2 åˆ†é’Ÿæœªåˆ°æœåŠ¡å™¨ æ‹‰æ¶ˆæ¯ï¼Œå¦‚æœæ¡ä»¶æˆç«‹è¿›è¡Œä¸Šè¿°ç›¸åŒçš„é€»è¾‘</p>
</li>
<li><p><code>for (MessageQueue mq : mqSet)</code>ï¼šå¼€å§‹å¤„ç†å½“å‰ä¸»é¢˜<strong>æ–°åˆ†é…åˆ°å½“å‰èŠ‚ç‚¹çš„é˜Ÿåˆ—</strong></p>
<p><code>if (isOrder &amp;&amp; !this.lock(mq))</code>ï¼š<strong>é¡ºåºæ¶ˆæ¯ä¸ºäº†ä¿è¯æœ‰åºæ€§ï¼Œéœ€è¦è·å–é˜Ÿåˆ—é”</strong></p>
<p><code>ProcessQueue pq = new ProcessQueue()</code>ï¼šä¸ºæ¯ä¸ªæ–°åˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—åˆ›å»ºå¿«ç…§é˜Ÿåˆ—</p>
<p><code>long nextOffset = this.computePullFromWhere(mq)</code>ï¼š<strong>ä»æœåŠ¡ç«¯è·å–æ–°åˆ†é…çš„ MQ çš„æ¶ˆè´¹è¿›åº¦</strong></p>
<p><code>ProcessQueue pre = this.processQueueTable.putIfAbsent(mq, pq)</code>ï¼šä¿å­˜åˆ°å¤„ç†é˜Ÿåˆ—é›†åˆ</p>
<p><code>PullRequest pullRequest = new PullRequest()</code>ï¼š<strong>åˆ›å»ºæ‹‰å–è¯·æ±‚å¯¹è±¡</strong></p>
</li>
<li><p><code>this.dispatchPullRequest(pullRequestList)</code>ï¼šæ”¾å…¥ PullMessageService çš„<strong>æœ¬åœ°é˜»å¡é˜Ÿåˆ—</strong>å†…ï¼Œç”¨äºæ‹‰å–æ¶ˆæ¯å·¥ä½œ</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>lockAll()ï¼šç»­çº¦é”ï¼Œå¯¹æ¶ˆè´¹è€…çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œç»­çº¦</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockAll</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>HashMap&lt;String, Set&lt;MessageQueue&gt;&gt; brokerMqs</code>ï¼šå°†åˆ†é…ç»™å½“å‰æ¶ˆè´¹è€…çš„å…¨éƒ¨ MQ æŒ‰ç…§ BrokerName åˆ†ç»„</p>
</li>
<li><p><code>while (it.hasNext())</code>ï¼šéå†æ‰€æœ‰çš„åˆ†ç»„</p>
</li>
<li><p><code>final Set&lt;MessageQueue&gt; mqs</code>ï¼šè·å–è¯¥ Broker ä¸Šåˆ†é…ç»™å½“å‰æ¶ˆè´¹è€…çš„ queue é›†åˆ</p>
</li>
<li><p><code>FindBrokerResult findBrokerResult</code>ï¼šæŸ¥è¯¢ Broker ä¸»èŠ‚ç‚¹ä¿¡æ¯</p>
</li>
<li><p><code>LockBatchRequestBody requestBody</code>ï¼šåˆ›å»ºè¯·æ±‚å¯¹è±¡ï¼Œå¡«å……å±æ€§</p>
</li>
<li><p><code>Set&lt;MessageQueue&gt; lockOKMQSet</code>ï¼š<strong>ä»¥ç»„ä¸ºå•ä½å‘ Broker å‘èµ·æ‰¹é‡ç»­çº¦é”çš„åŒæ­¥è¯·æ±‚</strong>ï¼Œè¿”å›æˆåŠŸçš„é˜Ÿåˆ—é›†åˆ</p>
</li>
<li><p><code>for (MessageQueue mq : lockOKMQSet)</code>ï¼šéå†ç»­çº¦é”æˆåŠŸçš„ MQ</p>
<p><code>processQueue.setLocked(true)</code>ï¼š<strong>åˆ†å¸ƒå¼é”çŠ¶æ€è®¾ç½®ä¸º trueï¼Œè¡¨ç¤ºå…è®¸é¡ºåºæ¶ˆè´¹</strong></p>
<p><code>processQueue.setLastLockTimestamp(System.currentTimeMillis())</code>ï¼šè®¾ç½®ä¸Šæ¬¡è·å–é”çš„æ—¶é—´ä¸ºå½“å‰æ—¶é—´</p>
</li>
<li><p><code>for (MessageQueue mq : mqs)</code>ï¼šéå†å½“å‰ Broker ä¸Šçš„æ‰€æœ‰é˜Ÿåˆ—é›†åˆ</p>
<p><code>if (!lockOKMQSet.contains(mq))</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜ç»­çº¦é”å¤±è´¥</p>
<p><code>processQueue.setLocked(false)</code>ï¼š<strong>åˆ†å¸ƒå¼é”çŠ¶æ€è®¾ç½®ä¸º falseï¼Œè¡¨ç¤ºä¸å…è®¸é¡ºåºæ¶ˆè´¹</strong></p>
</li>
</ul>
</li>
</ul>
<hr>
<h5 id="é˜Ÿåˆ—åˆ†é…"><a href="#é˜Ÿåˆ—åˆ†é…" class="headerlink" title="é˜Ÿåˆ—åˆ†é…"></a>é˜Ÿåˆ—åˆ†é…</h5><p>AllocateMessageQueueStrategy ç±»æ˜¯é˜Ÿåˆ—çš„åˆ†é…ç­–ç•¥</p>
<ul>
<li><p>å¹³å‡åˆ†é…ï¼šAllocateMessageQueueAveragely ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°ä¸€ï¼šæ¶ˆè´¹è€…ç»„       								å‚æ•°äºŒï¼šå½“å‰æ¶ˆè´¹è€…id   </span></span><br><span class="line"><span class="comment">// å‚æ•°ä¸‰ï¼šä¸»é¢˜çš„å…¨éƒ¨é˜Ÿåˆ—ï¼ŒåŒ…æ‹¬æ‰€æœ‰ broker ä¸Šè¯¥ä¸»é¢˜çš„ mq  	å‚æ•°å››ï¼šå…¨éƒ¨æ¶ˆè´¹è€…idé›†åˆ</span></span><br><span class="line"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title function_">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll, List&lt;String&gt; cidAll)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰æ¶ˆè´¹è€…åœ¨å…¨éƒ¨æ¶ˆè´¹è€…ä¸­çš„ä½ç½®ï¼Œã€å…¨éƒ¨æ¶ˆè´¹è€…æ˜¯å·²ç»æ’åºå¥½çš„ï¼Œæ’åœ¨å‰é¢çš„ä¼˜å…ˆåˆ†é…æ›´å¤šçš„é˜Ÿåˆ—ã€‘</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> cidAll.indexOf(currentCID);</span><br><span class="line">    <span class="comment">// å¹³å‡åˆ†é…å®Œä»¥åï¼Œè¿˜å‰©ä½™çš„å¾…åˆ†é…çš„ mq çš„æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">mod</span> <span class="operator">=</span> mqAll.size() % cidAll.size();</span><br><span class="line">    <span class="comment">// é¦–å…ˆåˆ¤æ–­æ•´ä½“çš„ mq çš„æ•°é‡æ˜¯å¦å°äºæ¶ˆè´¹è€…çš„æ•°é‡ï¼Œå°äºæ¶ˆè´¹è€…çš„æ•°é‡å°±è¯´æ˜ä¸å¤Ÿåˆ†çš„ï¼Œå…ˆåˆ†ä¸€ä¸ª</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">averageSize</span> <span class="operator">=</span> mqAll.size() &lt;= cidAll.size() ? <span class="number">1</span> :</span><br><span class="line">    	<span class="comment">// æˆç«‹éœ€è¦å¤šåˆ†é…ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå› ä¸ºæ›´é å‰</span></span><br><span class="line">    	(mod &gt; <span class="number">0</span> &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size() + <span class="number">1</span> : mqAll.size() / cidAll.size());</span><br><span class="line">    <span class="comment">// è·å–èµ·å§‹çš„åˆ†é…ä½ç½®</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">startIndex</span> <span class="operator">=</span> (mod &gt; <span class="number">0</span> &amp;&amp; index &lt; mod) ? index * averageSize : index * averageSize + mod;</span><br><span class="line">    <span class="comment">// é˜²æ­¢ç´¢å¼•è¶Šç•Œ</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">range</span> <span class="operator">=</span> Math.min(averageSize, mqAll.size() - startIndex);</span><br><span class="line">    <span class="comment">// å¼€å§‹åˆ†é…ï¼Œã€æŒ¨ç€åˆ†é…ï¼Œæ˜¯ç›´æ¥å°±æŠŠå½“å‰çš„ æ¶ˆè´¹è€…åˆ†é…å®Œæˆã€‘</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; range; i++) &#123;</span><br><span class="line">        result.add(mqAll.get((startIndex + i) % mqAll.size()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é˜Ÿåˆ—æ’åºåï¼šQ1 â†’ Q2 â†’ Q3ï¼Œæ¶ˆè´¹è€…æ’åºå C1 â†’ C2 â†’ C3</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-å¹³å‡é˜Ÿåˆ—åˆ†é….png" alt=""></p>
</li>
<li><p>è½®æµåˆ†é…ï¼šAllocateMessageQueueAveragelyByCircle</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/RocketMQ-å¹³å‡é˜Ÿåˆ—è½®æµåˆ†é….png" alt=""></p>
</li>
<li><p>æŒ‡å®šæœºæˆ¿å¹³å‡åˆ†é…ï¼šAllocateMessageQueueByMachineRoomï¼Œå‰ææ˜¯ Broker çš„å‘½åè§„åˆ™ä¸º <code>æœºæˆ¿å@BrokerName</code></p>
</li>
</ul>
<hr>
<h4 id="æ‹‰å–æœåŠ¡"><a href="#æ‹‰å–æœåŠ¡" class="headerlink" title="æ‹‰å–æœåŠ¡"></a>æ‹‰å–æœåŠ¡</h4><h5 id="å®ç°æ–¹å¼-1"><a href="#å®ç°æ–¹å¼-1" class="headerlink" title="å®ç°æ–¹å¼"></a>å®ç°æ–¹å¼</h5><p>MQClientInstance#start ä¸­ä¼šå¯åŠ¨æ¶ˆæ¯æ‹‰å–æœåŠ¡ï¼šPullMessageService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥åœæ­¢æ ‡è®°ï¼Œã€å¾ªç¯æ‹‰å–ã€‘</span></span><br><span class="line">    <span class="keyword">while</span> (!<span class="built_in">this</span>.isStopped()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–æ‹‰æ¶ˆæ¯è¯·æ±‚</span></span><br><span class="line">            <span class="type">PullRequest</span> <span class="variable">pullRequest</span> <span class="operator">=</span> <span class="built_in">this</span>.pullRequestQueue.take();</span><br><span class="line">            <span class="comment">// æ‹‰å–æ¶ˆæ¯ï¼Œè·å–è¯·æ±‚å¯¹åº”çš„ä½¿ç”¨å½“å‰æ¶ˆè´¹è€…ç»„ä¸­çš„å“ªä¸ªæ¶ˆè´¹è€…ï¼Œè°ƒç”¨æ¶ˆè´¹è€…çš„ pullMessage æ–¹æ³•</span></span><br><span class="line">            <span class="built_in">this</span>.pullMessage(pullRequest);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Pull Message Service Run Method exception&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DefaultMQPushConsumerImpl#pullMessageï¼š</p>
<ul>
<li><p><code>ProcessQueue processQueue = pullRequest.getProcessQueue()</code>ï¼šè·å–è¯·æ±‚å¯¹åº”çš„å¿«ç…§é˜Ÿåˆ—ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦æ˜¯åˆ é™¤çŠ¶æ€</p>
</li>
<li><p><code>this.executePullRequestLater()</code>ï¼šå¦‚æœå½“å‰æ¶ˆè´¹è€…ä¸æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œåˆ™æ‹‰æ¶ˆæ¯ä»»åŠ¡å»¶è¿Ÿ 3 ç§’åæ‰§è¡Œï¼Œå¦‚æœæ˜¯æš‚åœçŠ¶æ€å»¶è¿Ÿ 1 ç§’</p>
</li>
<li><p><strong>æµæ§çš„é€»è¾‘</strong>ï¼š</p>
<p><code>long cachedMessageCount = processQueue.getMsgCount().get()</code>ï¼šè·å–æ¶ˆè´¹è€…æœ¬åœ°è¯¥ queue å¿«ç…§å†…ç¼“å­˜çš„æ¶ˆæ¯æ•°é‡ï¼Œå¦‚æœå¤§äº 1000 æ¡ï¼Œè¿›è¡Œæµæ§ï¼Œå»¶è¿Ÿ 50 æ¯«ç§’</p>
<p><code>long cachedMessageSizeInMiB</code>ï¼š æ¶ˆè´¹è€…æœ¬åœ°è¯¥ queue å¿«ç…§å†…ç¼“å­˜çš„æ¶ˆæ¯å®¹é‡ sizeï¼Œè¶…è¿‡ 100m æ¶ˆæ¯æœªè¢«æ¶ˆè´¹è¿›è¡Œæµæ§</p>
<p><code>if(processQueue.getMaxSpan() &gt; 2000)</code>ï¼šæ¶ˆè´¹è€…æœ¬åœ°ç¼“å­˜æ¶ˆæ¯ç¬¬ä¸€æ¡æ¶ˆæ¯æœ€åä¸€æ¡æ¶ˆæ¯è·¨åº¦è¶…è¿‡ 2000 è¿›è¡Œæµæ§</p>
</li>
<li><p><code>SubscriptionData subscriptionData</code>ï¼šæœ¬æ¬¡æ‹‰æ¶ˆæ¯è¯·æ±‚è®¢é˜…çš„ä¸»é¢˜æ•°æ®ï¼Œå¦‚æœè°ƒç”¨äº† <code>unsubscribe(ä¸»é¢˜)</code> å°†ä¼šè·å–ä¸º null</p>
</li>
<li><p><code>PullCallback pullCallback = new PullCallback()</code>ï¼š<strong>æ‹‰æ¶ˆæ¯å¤„ç†å›è°ƒå¯¹è±¡</strong></p>
<ul>
<li><p><code>pullResult = ...processPullResult()</code>ï¼šé¢„å¤„ç† PullResult ç»“æœï¼Œå°†æœåŠ¡å™¨ç«¯æŒ‡å®š MQ çš„æ‹‰æ¶ˆæ¯<strong>ä¸‹ä¸€æ¬¡çš„æ¨èèŠ‚ç‚¹</strong>ä¿å­˜åˆ° pullFromWhichNodeTable ä¸­ï¼Œ<strong>å¹¶è¿›è¡Œæ¶ˆæ¯è¿‡æ»¤</strong></p>
</li>
<li><p><code>case FOUND</code>ï¼šæ­£å¸¸æ‹‰å–åˆ°æ¶ˆæ¯</p>
<p><code>pullRequest.setNextOffset(pullResult.getNextBeginOffset())</code>ï¼šæ›´æ–° pullRequest å¯¹è±¡ä¸‹ä¸€æ¬¡æ‹‰å–æ¶ˆæ¯çš„ä½ç‚¹</p>
<p><code>if (pullResult.getMsgFoundList() == null...)</code>ï¼šæ¶ˆæ¯è¿‡æ»¤å¯¼è‡´æ¶ˆæ¯å…¨éƒ¨è¢«è¿‡æ»¤æ‰ï¼Œéœ€è¦ç«‹é©¬å‘èµ·ä¸‹ä¸€æ¬¡æ‹‰æ¶ˆæ¯</p>
<p><code>boolean .. = processQueue.putMessage()</code>ï¼šå°†æœåŠ¡å™¨æ‹‰å–çš„æ¶ˆæ¯é›†åˆ<strong>åŠ å…¥åˆ°æ¶ˆè´¹è€…æœ¬åœ°</strong>çš„ processQueue å†…</p>
<p><code>DefaultMQPushConsumerImpl...submitConsumeRequest()</code>ï¼š<strong>æäº¤æ¶ˆè´¹ä»»åŠ¡ï¼Œåˆ†ä¸ºé¡ºåºæ¶ˆè´¹å’Œå¹¶å‘æ¶ˆè´¹</strong></p>
<p><code>Defaul..executePullRequestImmediately(pullRequest)</code>ï¼šå°†æ›´æ–°è¿‡ nextOffset å­—æ®µçš„ PullRequest å¯¹è±¡ï¼Œå†æ¬¡æ”¾åˆ° pullMessageService çš„é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œ<strong>å½¢æˆé—­ç¯</strong></p>
</li>
<li><p><code>case NO_NEW_MSG ||NO_MATCHED_MSG</code>ï¼š<strong>è¡¨ç¤ºæœ¬æ¬¡ pull æ²¡æœ‰æ–°çš„å¯æ¶ˆè´¹çš„ä¿¡æ¯</strong></p>
<p><code>pullRequest.setNextOffset()</code>ï¼šæ›´æ–°æ›´æ–° pullRequest å¯¹è±¡ä¸‹ä¸€æ¬¡æ‹‰å–æ¶ˆæ¯çš„ä½ç‚¹</p>
<p><code>Defaul..executePullRequestImmediately(pullRequest)</code>ï¼šå†æ¬¡æ‹‰å–è¯·æ±‚</p>
</li>
<li><p><code>case OFFSET_ILLEGAL</code>ï¼š<strong>æœ¬æ¬¡ pull æ—¶ä½¿ç”¨çš„ offset æ˜¯æ— æ•ˆçš„</strong>ï¼Œå³ offset &gt; maxOffset || offset  &lt; minOffset</p>
<p><code>pullRequest.setNextOffset()</code>ï¼šè°ƒæ•´ pullRequest.nextOffset ä¸ºæ­£ç¡®çš„ offset</p>
<p><code>pullRequest.getProcessQueue().setDropped(true)</code>ï¼šè®¾ç½®è¯¥ processQueue ä¸ºåˆ é™¤çŠ¶æ€ï¼Œå¦‚æœæœ‰è¯¥ queue çš„æ¶ˆè´¹ä»»åŠ¡ï¼Œæ¶ˆè´¹ä»»åŠ¡ä¼šé©¬ä¸Šåœæ­¢</p>
<p><code>DefaultMQPushConsumerImpl.this.executeTaskLater()</code>ï¼šæäº¤å¼‚æ­¥ä»»åŠ¡ï¼Œ10 ç§’åå»æ‰§è¡Œ</p>
<ul>
<li><p><code>DefaultMQPushConsumerImpl...updateOffset()</code>ï¼šæ›´æ–° offsetStore è¯¥ MQ çš„ offset ä¸ºæ­£ç¡®å€¼ï¼Œå†…éƒ¨ç›´æ¥æ›¿æ¢</p>
</li>
<li><p><code>DefaultMQPushConsumerImpl...persist()</code>ï¼šæŒä¹…åŒ–è¯¥ messageQueue çš„ offset åˆ° Broker ç«¯</p>
</li>
<li><p><code>DefaultMQPushConsumerImpl...removeProcessQueue()</code>ï¼š åˆ é™¤è¯¥æ¶ˆè´¹è€…è¯¥ messageQueue å¯¹åº”çš„ processQueue</p>
</li>
<li><p>è¿™é‡Œæ²¡æœ‰å†æ¬¡æäº¤ pullRequest åˆ° pullMessageService çš„é˜Ÿåˆ—ï¼Œé‚£è¯¥é˜Ÿåˆ—ä¸å†æ‹‰æ¶ˆæ¯äº†å—ï¼Ÿ</p>
<p>è´Ÿè½½å‡è¡¡ rbl ç¨‹åºä¼šé‡å»ºè¯¥é˜Ÿåˆ—çš„ processQueueï¼Œé‡å»ºå®Œä¹‹åä¼šä¸ºè¯¥é˜Ÿåˆ—åˆ›å»ºæ–°çš„ PullRequest å¯¹è±¡</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>int sysFlag = PullSysFlag.buildSysFlag()</code>ï¼š<strong>æ„å»ºæ ‡å¿—å¯¹è±¡</strong>ï¼ŒsysFlag é«˜ 4 ä½æœªä½¿ç”¨ï¼Œä½ 4 ä½ä½¿ç”¨ï¼Œä»å·¦åˆ°å³ 0000 0011</p>
<ul>
<li>ç¬¬ä¸€ä½ï¼šè¡¨ç¤ºæ˜¯å¦æäº¤æ¶ˆè´¹è€…æœ¬åœ°è¯¥é˜Ÿåˆ—çš„ offsetï¼Œä¸€èˆ¬æ˜¯ 1</li>
<li>ç¬¬äºŒä½ï¼šè¡¨ç¤ºæ˜¯å¦å…è®¸æœåŠ¡å™¨ç«¯è¿›è¡Œé•¿è½®è¯¢ï¼Œä¸€èˆ¬æ˜¯ 1</li>
<li>ç¬¬ä¸‰ä½ï¼šè¡¨ç¤ºæ˜¯å¦æäº¤æ¶ˆè´¹è€…æœ¬åœ°è¯¥ä¸»é¢˜çš„è®¢é˜…æ•°æ®ï¼Œä¸€èˆ¬æ˜¯ 0</li>
<li>ç¬¬å››ä½ï¼šè¡¨ç¤ºæ˜¯å¦ä¸ºç±»è¿‡æ»¤ï¼Œä¸€èˆ¬æ˜¯ 0</li>
</ul>
</li>
<li><p><code>this.pullAPIWrapper.pullKernelImpl()</code>ï¼šæ‹‰å–æ¶ˆæ¯çš„æ ¸å¿ƒæ–¹æ³•</p>
</li>
</ul>
<hr>
<h5 id="å°è£…å¯¹è±¡"><a href="#å°è£…å¯¹è±¡" class="headerlink" title="å°è£…å¯¹è±¡"></a>å°è£…å¯¹è±¡</h5><p>PullAPIWrapper ç±»å°è£…äº†æ‹‰å–æ¶ˆæ¯çš„ API</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>æ¨èæ‹‰æ¶ˆæ¯ä½¿ç”¨çš„ä¸»æœº IDï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ConcurrentMap&lt;MessageQueue, AtomicLong<span class="comment">/* brokerId */</span>&gt; pullFromWhichNodeTable</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æˆå‘˜æ–¹æ³•ï¼š</p>
<ul>
<li><p>pullKernelImpl()ï¼šæ‹‰æ¶ˆæ¯</p>
<ul>
<li><p><code>FindBrokerResult findBrokerResult</code>ï¼š<strong>æœ¬åœ°æŸ¥è¯¢æŒ‡å®š BrokerName çš„åœ°å€ä¿¡æ¯</strong>ï¼Œæ¨èèŠ‚ç‚¹æˆ–è€…ä¸»èŠ‚ç‚¹</p>
</li>
<li><p><code>if (null == findBrokerResult)</code>ï¼šæŸ¥è¯¢ä¸åˆ°ï¼Œå°±åˆ° Namesrv è·å–æŒ‡å®š topic çš„è·¯ç”±æ•°æ®</p>
</li>
<li><p><code>if (findBrokerResult.isSlave())</code>ï¼šæˆç«‹è¯´æ˜ findBrokerResult è¡¨ç¤ºçš„ä¸»æœºä¸º slave èŠ‚ç‚¹ï¼Œ<strong>slave ä¸å­˜å‚¨ offset ä¿¡æ¯</strong></p>
<p><code>sysFlagInner = PullSysFlag.clearCommitOffsetFlag(sysFlagInner)</code>ï¼šå°† sysFlag æ ‡è®°ä½ä¸­ CommitOffset çš„ä½ç½®ä¸º 0</p>
</li>
<li><p><code>PullMessageRequestHeader requestHeader</code>ï¼šåˆ›å»ºè¯·æ±‚å¤´å¯¹è±¡ï¼Œå°è£…æ‰€æœ‰çš„å‚æ•°</p>
</li>
<li><p><code>PullResult pullResult = this.mQClientFactory.getMQClientAPIImpl().pullMessage()</code>ï¼šè°ƒç”¨å®¢æˆ·ç«¯å®ä¾‹çš„æ–¹æ³•ï¼Œæ ¸å¿ƒé€»è¾‘å°±æ˜¯<strong>å°†ä¸šåŠ¡æ•°æ®è½¬åŒ–ä¸º RemotingCommand  é€šè¿‡ NettyRemotingClient çš„ IO è¿›è¡Œé€šä¿¡</strong></p>
<ul>
<li><p><code>RemotingCommand request</code>ï¼šåˆ›å»ºç½‘ç»œå±‚ä¼ è¾“å¯¹è±¡ RemotingCommand å¯¹è±¡ï¼Œ<strong>è¯·æ±‚ ID ä¸º <code>PULL_MESSAGE = 11</code></strong></p>
</li>
<li><p><code>return this.pullMessageSync(...)</code>ï¼šæ­¤å¤„æ˜¯<strong>å¼‚æ­¥è°ƒç”¨ï¼Œå¤„ç†ç»“æœæ”¾å…¥ ResponseFuture ä¸­</strong>ï¼Œå‚è€ƒæœåŠ¡ç«¯å°èŠ‚çš„å¤„ç†å™¨ç±» <code>NettyServerHandler#processMessageReceived</code> æ–¹æ³•</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>RemotingCommand response = responseFuture.getResponseCommand()</code>ï¼šè·å–æœåŠ¡å™¨ç«¯å“åº”æ•°æ® response</p>
<ul>
<li><code>PullResult pullResult</code>ï¼šä» response å†…æå–å‡ºæ¥æ‹‰æ¶ˆæ¯ç»“æœå¯¹è±¡ï¼Œå°†å“åº”å¤´ PullMessageResponseHeader å¯¹è±¡ä¸­ä¿¡æ¯<strong>å¡«å……åˆ° PullResult ä¸­</strong>ï¼Œåˆ—å‡ºä¸¤ä¸ªé‡è¦çš„å­—æ®µï¼š</li>
<li><code>private Long suggestWhichBrokerId</code>ï¼šæœåŠ¡ç«¯å»ºè®®å®¢æˆ·ç«¯ä¸‹æ¬¡ Pull æ—¶é€‰æ‹©çš„ BrokerID</li>
<li><code>private Long nextBeginOffset</code>ï¼šå®¢æˆ·ç«¯ä¸‹æ¬¡ Pull æ—¶ä½¿ç”¨çš„ offset ä¿¡æ¯</li>
</ul>
</li>
<li><p><code>pullCallback.onSuccess(pullResult)</code>ï¼šå°† PullResult äº¤ç»™æ‹‰æ¶ˆæ¯ç»“æœå¤„ç†å›è°ƒå¯¹è±¡ï¼Œè°ƒç”¨ onSuccess æ–¹æ³•</p>
</li>
</ul>
<hr>
<h4 id="æ‹‰å–å¤„ç†"><a href="#æ‹‰å–å¤„ç†" class="headerlink" title="æ‹‰å–å¤„ç†"></a>æ‹‰å–å¤„ç†</h4><h5 id="å¤„ç†å™¨"><a href="#å¤„ç†å™¨" class="headerlink" title="å¤„ç†å™¨"></a>å¤„ç†å™¨</h5><p>BrokerStartup#createBrokerController æ–¹æ³•ä¸­åˆ›å»ºäº† BrokerController å¹¶è¿›è¡Œåˆå§‹åŒ–ï¼Œè°ƒç”¨ <code>registerProcessor()</code> æ–¹æ³•å°†å¤„ç†å™¨ PullMessageProcessor æ³¨å†Œåˆ° NettyRemotingServer ä¸­ï¼Œå¯¹åº”çš„è¯·æ±‚ ID ä¸º <code>PULL_MESSAGE = 11</code>ï¼ŒNettyServerHandler åœ¨å¤„ç†è¯·æ±‚æ—¶é€šè¿‡è¯·æ±‚ ID ä¼šè·å–å¤„ç†å™¨æ‰§è¡Œ processRequest æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°ä¸€ï¼šæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ netty é€šé“ï¼› å‚æ•°äºŒï¼šå®¢æˆ·ç«¯è¯·æ±‚ï¼› å‚æ•°ä¸‰ï¼šæ˜¯å¦å…è®¸æœåŠ¡å™¨ç«¯é•¿è½®è¯¢ï¼Œé»˜è®¤ true</span></span><br><span class="line"><span class="keyword">private</span> RemotingCommand <span class="title function_">processRequest</span><span class="params">(<span class="keyword">final</span> Channel channel, RemotingCommand request, <span class="type">boolean</span> brokerAllowSuspend)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>RemotingCommand response</code>ï¼šåˆ›å»ºå“åº”å¯¹è±¡ï¼Œè®¾ç½®ä¸ºå“åº”ç±»å‹çš„è¯·æ±‚ï¼Œå“åº”å¤´æ˜¯ PullMessageResponseHeader</p>
</li>
<li><p><code>final PullMessageResponseHeader responseHeader</code>ï¼šè·å–å“åº”å¯¹è±¡çš„ header</p>
</li>
<li><p><code>final PullMessageRequestHeader requestHeader</code>ï¼šè§£æå‡ºè¯·æ±‚å¤´ PullMessageRequestHeader</p>
</li>
<li><p><code>response.setOpaque(request.getOpaque())</code>ï¼šè®¾ç½® opaque å±æ€§ï¼Œå®¢æˆ·ç«¯<strong>æ ¹æ®è¯¥å­—æ®µè·å– ResponseFuture</strong> è¿›è¡Œå¤„ç†</p>
</li>
<li><p>è¿›è¡Œä¸€äº›é‰´æƒçš„é€»è¾‘ï¼šæ˜¯å¦å…è®¸é•¿è½®è¯¢ã€æäº¤ offsetã€topicConfig æ˜¯å¦æ˜¯ç©ºã€é˜Ÿåˆ— ID æ˜¯å¦åˆç†</p>
</li>
<li><p><code>ConsumerGroupInfo consumerGroupInfo</code>ï¼šè·å–æ¶ˆè´¹è€…ç»„ä¿¡æ¯ï¼ŒåŒ…å«å…¨éƒ¨çš„æ¶ˆè´¹è€…å’Œè®¢é˜…æ•°æ®</p>
</li>
<li><p><code>subscriptionData = consumerGroupInfo.findSubscriptionData()</code>ï¼š<strong>è·å–æŒ‡å®šä¸»é¢˜çš„è®¢é˜…æ•°æ®</strong></p>
</li>
<li><p><code>if (!ExpressionType.isTagType()</code>ï¼šè¡¨è¾¾å¼åŒ¹é…</p>
</li>
<li><p><code>MessageFilter messageFilter</code>ï¼šåˆ›å»ºæ¶ˆæ¯è¿‡æ»¤å™¨ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡ tagCode è¿›è¡Œè¿‡æ»¤</p>
</li>
<li><p><code>DefaultMessageStore.getMessage()</code>ï¼š<strong>æŸ¥è¯¢æ¶ˆæ¯çš„æ ¸å¿ƒé€»è¾‘ï¼Œåœ¨ Broker ç«¯æŸ¥è¯¢æ¶ˆæ¯</strong>ï¼ˆå­˜å‚¨ç«¯ç¬”è®°è¯¦è§£äº†è¯¥æºç ï¼‰</p>
</li>
<li><p><code>response.setRemark()</code>ï¼šè®¾ç½®æ­¤æ¬¡å“åº”çš„çŠ¶æ€</p>
</li>
<li><p><code>responseHeader.set..</code>ï¼šè®¾ç½®å“åº”å¤´å¯¹è±¡çš„ä¸€äº›å­—æ®µ</p>
</li>
<li><p><code>switch (this.brokerController.getMessageStoreConfig().getBrokerRole())</code>ï¼šå¦‚æœå½“å‰ä¸»æœºèŠ‚ç‚¹è§’è‰²ä¸º slave å¹¶ä¸”<strong>ä»èŠ‚ç‚¹è¯»</strong>å¹¶æœªå¼€å¯çš„è¯ï¼Œç›´æ¥ç»™å®¢æˆ·ç«¯ ä¸€ä¸ªçŠ¶æ€ <code>PULL_RETRY_IMMEDIATELY</code>ï¼Œå¹¶è®¾ç½®ä¸ºä¸‹æ¬¡ä»ä¸»èŠ‚ç‚¹è¯»</p>
</li>
<li><p><code>if (this.brokerController.getBrokerConfig().isSlaveReadEnable())</code>ï¼šæ¶ˆè´¹å¤ªæ…¢ï¼Œ<strong>ä¸‹æ¬¡ä»å¦ä¸€å°æœºå™¨æ‹‰å–</strong></p>
</li>
<li><p><code>switch (getMessageResult.getStatus())</code>ï¼šæ ¹æ® getMessageResult çš„çŠ¶æ€è®¾ç½® response çš„ code</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">GetMessageStatus</span> &#123;</span><br><span class="line">    FOUND,					<span class="comment">// æŸ¥è¯¢æˆåŠŸ</span></span><br><span class="line">    NO_MATCHED_MESSAGE,		<span class="comment">// æœªæŸ¥è¯¢åˆ°åˆ°æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯è¿‡æ»¤ tagCode</span></span><br><span class="line">    MESSAGE_WAS_REMOVING,	<span class="comment">// æŸ¥è¯¢æ—¶èµ¶ä¸Š CommitLog æ¸…ç†è¿‡æœŸæ–‡ä»¶ï¼Œå¯¼è‡´æŸ¥è¯¢å¤±è´¥ï¼Œç«‹åˆ»å°è¯•</span></span><br><span class="line">    OFFSET_FOUND_NULL,		<span class="comment">// æŸ¥è¯¢æ—¶èµ¶ä¸Š ConsumerQueue æ¸…ç†è¿‡æœŸæ–‡ä»¶ï¼Œå¯¼è‡´æŸ¥è¯¢å¤±è´¥ï¼Œã€è¿›è¡Œé•¿è½®è¯¢ã€‘</span></span><br><span class="line">    OFFSET_OVERFLOW_BADLY,	<span class="comment">// pullRequest.offset è¶Šç•Œ maxOffset</span></span><br><span class="line">    OFFSET_OVERFLOW_ONE,	<span class="comment">// pullRequest.offset == CQ.maxOffsetï¼Œã€è¿›è¡Œé•¿è½®è¯¢ã€‘</span></span><br><span class="line">    OFFSET_TOO_SMALL,		<span class="comment">// pullRequest.offset è¶Šç•Œ minOffset</span></span><br><span class="line">    NO_MATCHED_LOGIC_QUEUE,	<span class="comment">// æ²¡æœ‰åŒ¹é…åˆ°é€»è¾‘é˜Ÿåˆ—</span></span><br><span class="line">    NO_MESSAGE_IN_QUEUE,	<span class="comment">// ç©ºé˜Ÿåˆ—ï¼Œåˆ›å»ºé˜Ÿåˆ—ä¹Ÿæ˜¯å› ä¸ºæŸ¥è¯¢å¯¼è‡´ï¼Œã€è¿›è¡Œé•¿è½®è¯¢ã€‘</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>switch (response.getCode())</code>ï¼šæ ¹æ® response çŠ¶æ€åšå¯¹åº”çš„ä¸šåŠ¡å¤„ç†</p>
<p><code>case ResponseCode.SUCCESS</code>ï¼šæŸ¥è¯¢æˆåŠŸ</p>
<ul>
<li><code>final byte[] r = this.readGetMessageResult()</code>ï¼šæœ¬æ¬¡ pull å‡ºæ¥çš„å…¨éƒ¨æ¶ˆæ¯å¯¼å…¥ byte æ•°ç»„</li>
<li><code>response.setBody(r)</code>ï¼šå°†æ¶ˆæ¯çš„ byte æ•°ç»„ä¿å­˜åˆ° response body å­—æ®µ</li>
</ul>
<p><code>case ResponseCode.PULL_NOT_FOUND</code>ï¼šäº§ç”Ÿè¿™ç§æƒ…å†µå¤§éƒ¨åˆ†åŸå› æ˜¯ <code>pullRequest.offset  ==  queue.maxOffset</code>ï¼Œè¯´æ˜å·²ç»æ²¡æœ‰éœ€è¦è·å–çš„æ¶ˆæ¯ï¼Œæ­¤æ—¶å¦‚æœç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¼šç«‹åˆ»é‡æ–°è¯·æ±‚ï¼Œè¿˜æ˜¯ç»§ç»­è¿”å›è¯¥çŠ¶æ€ï¼Œé¢‘ç¹æ‹‰å–æœåŠ¡å™¨å¯¼è‡´æœåŠ¡å™¨å‹åŠ›å¤§ï¼Œæ‰€ä»¥æ­¤å¤„<strong>éœ€è¦é•¿è½®è¯¢</strong></p>
<ul>
<li><code>if (brokerAllowSuspend &amp;&amp; hasSuspendFlag)</code>ï¼šbrokerAllowSuspend = trueï¼Œå½“é•¿è½®è¯¢ç»“æŸå†æ¬¡æ‰§è¡Œ processRequest æ—¶è¯¥å‚æ•°ä¸º falseï¼Œæ‰€ä»¥<strong>æ¯æ¬¡ Pull è¯·æ±‚è‡³å¤šåœ¨æœåŠ¡å™¨ç«¯é•¿è½®è¯¢æ§åˆ¶ä¸€æ¬¡</strong></li>
<li><code>PullRequest pullRequest = new PullRequest()</code>ï¼šåˆ›å»ºé•¿è½®è¯¢ PullRequest å¯¹è±¡</li>
<li><code>this.brokerController...suspendPullRequest(topic, queueId, pullRequest)</code>ï¼šå°†é•¿è½®è¯¢è¯·æ±‚å¯¹è±¡äº¤ç»™é•¿è½®è¯¢æœåŠ¡<ul>
<li><code>String key = this.buildKey(topic, queueId)</code>ï¼šæ„å»ºä¸€ä¸ª <code>topic@queueId</code> çš„ key</li>
<li><code>ManyPullRequest mpr = this.pullRequestTable.get(key)</code>ï¼šä»æ‹‰è¯·æ±‚è¡¨ä¸­è·å–å¯¹è±¡</li>
<li><code>mpr.addPullRequest(pullRequest)</code>ï¼š<strong>å°† PullRequest å¯¹è±¡æ”¾å…¥åˆ°é•¿è½®è¯¢çš„è¯·æ±‚é›†åˆä¸­</strong></li>
</ul>
</li>
<li><code>response = null</code>ï¼šå“åº”è®¾ç½®ä¸º null å†…éƒ¨çš„ callBack å°±ä¸ä¼šç»™å®¢æˆ·ç«¯å‘é€ä»»ä½•æ•°æ®ï¼Œ<strong>ä¸è¿›è¡Œé€šä¿¡</strong>ï¼Œå¦åˆ™å°±åˆå¼€å§‹é‡æ–°è¯·æ±‚</li>
</ul>
</li>
<li><p><code>boolean storeOffsetEnable</code>ï¼šå…è®¸é•¿è½®è¯¢ã€sysFlag è¡¨ç¤ºæäº¤æ¶ˆè´¹è€…æœ¬åœ°è¯¥é˜Ÿåˆ—çš„offsetã€å½“å‰ broker èŠ‚ç‚¹è§’è‰²ä¸º master èŠ‚ç‚¹ä¸‰ä¸ªæ¡ä»¶æˆç«‹ï¼Œæ‰<strong>åœ¨ Broker ç«¯å­˜å‚¨æ¶ˆè´¹è€…ç»„å†…è¯¥ä¸»é¢˜çš„æŒ‡å®š queue çš„æ¶ˆè´¹è¿›åº¦</strong></p>
</li>
<li><p><code>return response</code>ï¼šè¿”å› responseï¼Œä¸ä¸º null æ—¶å¤–å±‚ processRequestCommand çš„ callback ä¼šå°†æ•°æ®å†™ç»™å®¢æˆ·ç«¯</p>
</li>
</ul>
<hr>
<h5 id="é•¿è½®è¯¢"><a href="#é•¿è½®è¯¢" class="headerlink" title="é•¿è½®è¯¢"></a>é•¿è½®è¯¢</h5><p>PullRequestHoldService ç±»è´Ÿè´£é•¿è½®è¯¢ï¼ŒBrokerController#start æ–¹æ³•ä¸­è°ƒç”¨äº† <code>this.pullRequestHoldService.start()</code> å¯åŠ¨è¯¥æœåŠ¡</p>
<p>æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li><p>run()ï¼šæ ¸å¿ƒè¿è¡Œæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">// å¾ªç¯è¿è¡Œ</span></span><br><span class="line">    <span class="keyword">while</span> (!<span class="built_in">this</span>.isStopped()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.brokerController.getBrokerConfig().isLongPollingEnable()) &#123;</span><br><span class="line">            <span class="comment">// æœåŠ¡å™¨å¼€å¯é•¿è½®è¯¢å¼€å…³ï¼šæ¯æ¬¡å¾ªç¯ä¼‘çœ 5ç§’</span></span><br><span class="line">            <span class="built_in">this</span>.waitForRunning(<span class="number">5</span> * <span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æœåŠ¡å™¨å…³é—­é•¿è½®è¯¢å¼€å…³ï¼šæ¯æ¬¡å¾ªç¯ä¼‘çœ 1ç§’</span></span><br><span class="line">            <span class="built_in">this</span>.waitForRunning(...);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥æŒæœ‰çš„è¯·æ±‚</span></span><br><span class="line">        <span class="built_in">this</span>.checkHoldRequest();</span><br><span class="line">        <span class="comment">// .....</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>checkHoldRequest()ï¼šæ£€æŸ¥æ‰€æœ‰çš„è¯·æ±‚</p>
<ul>
<li><code>for (String key : this.pullRequestTable.keySet())</code>ï¼š<strong>å¤„ç†æ‰€æœ‰çš„ topic@queueId çš„é€»è¾‘</strong></li>
<li><code>String[] kArray = key.split(TOPIC_QUEUEID_SEPARATOR)</code>ï¼škey æŒ‰ç…§ @ æ‹†åˆ†ï¼Œå¾—åˆ° topic å’Œ queueId</li>
<li><code>long offset = this...getMaxOffsetInQueue(topic, queueId)</code>ï¼š åˆ°å­˜å‚¨æ¨¡å—æŸ¥è¯¢è¯¥ ConsumeQueue çš„<strong>æœ€å¤§ offset</strong></li>
<li><code>this.notifyMessageArriving(topic, queueId, offset)</code>ï¼šé€šçŸ¥æ¶ˆæ¯åˆ°è¾¾</li>
</ul>
</li>
<li><p>notifyMessageArriving()ï¼š<strong>é€šçŸ¥æ¶ˆæ¯åˆ°è¾¾</strong>çš„é€»è¾‘ï¼ŒReputMessageService æ¶ˆæ¯åˆ†å‘æœåŠ¡ä¹Ÿä¼šè°ƒç”¨è¯¥æ–¹æ³•</p>
<ul>
<li><code>ManyPullRequest mpr = this.pullRequestTable.get(key)</code>ï¼šè·å–å¯¹åº”çš„çš„ manyPullRequest å¯¹è±¡</li>
<li><code>List&lt;PullRequest&gt; requestList</code>ï¼šè·å–è¯¥é˜Ÿåˆ—ä¸‹çš„æ‰€æœ‰ PullRequestï¼Œå¹¶è¿›è¡Œéå†</li>
<li><code>List&lt;PullRequest&gt; replayList</code>ï¼šå½“æŸä¸ª pullRequest ä¸è¶…æ—¶ï¼Œå¹¶ä¸”å¯¹åº”çš„ <code>CQ.maxOffset &lt;= pullRequest.offset</code>ï¼Œå°±å°†è¯¥ PullRequest å†æ”¾å…¥è¯¥åˆ—è¡¨</li>
<li><code>long newestOffset</code>ï¼šè¯¥å€¼ä¸º CQ çš„ maxOffset</li>
<li><code>if (newestOffset &gt; request.getPullFromThisOffset())</code>ï¼š<strong>è¯·æ±‚å¯¹åº”çš„é˜Ÿåˆ—å†…å¯ä»¥ pull æ¶ˆæ¯äº†ï¼Œç»“æŸé•¿è½®è¯¢</strong></li>
<li><code>boolean match</code>ï¼šè¿›è¡Œè¿‡æ»¤åŒ¹é…</li>
<li><code>this.brokerController...executeRequestWhenWakeup()</code>ï¼šå°†æ»¡è¶³æ¡ä»¶çš„ pullRequest å†æ¬¡æäº¤åˆ°çº¿ç¨‹æ± å†…æ‰§è¡Œ<ul>
<li><code>final RemotingCommand response</code>ï¼šæ‰§è¡Œ processRequest æ–¹æ³•ï¼Œå¹¶ä¸”<strong>ä¸ä¼šè§¦å‘é•¿è½®è¯¢</strong></li>
<li><code>channel.writeAndFlush(response).addListene()</code>ï¼š<strong>å°†ç»“æœæ•°æ®å‘é€ç»™å®¢æˆ·ç«¯</strong></li>
</ul>
</li>
<li><code>if (System.currentTimeMillis() &gt;= ...)</code>ï¼šåˆ¤æ–­è¯¥ pullRequest æ˜¯å¦è¶…æ—¶ï¼Œè¶…æ—¶åçš„ä¹Ÿæ˜¯é‡æ–°æäº¤åˆ°çº¿ç¨‹æ± ï¼Œå¹¶ä¸”ä¸è¿›è¡Œé•¿è½®è¯¢</li>
<li><code>mpr.addPullRequest(replayList)</code>ï¼šå°†æœªæ»¡è¶³æ¡ä»¶çš„ PullRequest å¯¹è±¡å†æ¬¡æ·»åŠ åˆ° ManyPullRequest å±æ€§ä¸­</li>
</ul>
</li>
</ul>
<hr>
<h5 id="ç»“æœç±»"><a href="#ç»“æœç±»" class="headerlink" title="ç»“æœç±»"></a>ç»“æœç±»</h5><p>GetMessageResult ç±»æˆå‘˜ä¿¡æ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetMessageResult</span> &#123;</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ¶ˆæ¯æ—¶ï¼Œæœ€åº•å±‚éƒ½æ˜¯ mappedFile æ”¯æŒçš„æŸ¥è¯¢ï¼ŒæŸ¥è¯¢æ—¶è¿”å›ç»™å¤–å±‚ä¸€ä¸ª SelectMappedBufferResultï¼Œ</span></span><br><span class="line">    <span class="comment">// mappedFile æ¯æŸ¥è¯¢ä¸€æ¬¡éƒ½ä¼š refCount++ ï¼Œé€šè¿‡SelectMappedBufferResultæŒæœ‰mappedFileï¼Œå®Œæˆèµ„æºé‡Šæ”¾çš„å¥æŸ„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SelectMappedBufferResult&gt; messageMapedList =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;SelectMappedBufferResult&gt;(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯¥Listå†…å­˜å‚¨æ¶ˆæ¯ï¼Œæ¯ä¸€æ¡æ¶ˆæ¯éƒ½è¢«è½¬æˆ ByteBuffer è¡¨ç¤ºäº†</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ByteBuffer&gt; messageBufferList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ByteBuffer&gt;(<span class="number">100</span>);</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢ç»“æœçŠ¶æ€</span></span><br><span class="line">    <span class="keyword">private</span> GetMessageStatus status;</span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯ä¸‹æ¬¡å†å‘å½“å‰Queueæ‹‰æ¶ˆæ¯æ—¶ï¼Œä½¿ç”¨çš„ offset</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> nextBeginOffset;</span><br><span class="line">    <span class="comment">// å½“å‰queueæœ€å°offset</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> minOffset;</span><br><span class="line">    <span class="comment">// å½“å‰queueæœ€å¤§offset</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> maxOffset;</span><br><span class="line">    <span class="comment">// æ¶ˆæ¯æ€»byteå¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">bufferTotalSize</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨å»ºè®®å®¢æˆ·ç«¯ä¸‹æ¬¡åˆ°è¯¥ queue æ‹‰æ¶ˆæ¯æ—¶æ˜¯å¦ä½¿ç”¨ ã€ä»èŠ‚ç‚¹ã€‘</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">suggestPullingFromSlave</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="é˜Ÿåˆ—å¿«ç…§"><a href="#é˜Ÿåˆ—å¿«ç…§" class="headerlink" title="é˜Ÿåˆ—å¿«ç…§"></a>é˜Ÿåˆ—å¿«ç…§</h4><h5 id="æˆå‘˜å±æ€§-10"><a href="#æˆå‘˜å±æ€§-10" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>ProcessQueue ç±»æ˜¯æ¶ˆè´¹é˜Ÿåˆ—çš„å¿«ç…§</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>å±æ€§å­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">msgCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>();	<span class="comment">// é˜Ÿåˆ—ä¸­æ¶ˆæ¯æ•°é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">msgSize</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>();	<span class="comment">// æ¶ˆæ¯æ€»å¤§å°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">queueOffsetMax</span> <span class="operator">=</span> <span class="number">0L</span>;				<span class="comment">// å¿«ç…§ä¸­æœ€å¤§ offset</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">dropped</span> <span class="operator">=</span> <span class="literal">false</span>;				<span class="comment">// å¿«ç…§æ˜¯å¦ç§»é™¤</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">lastPullTimestamp</span> <span class="operator">=</span> current;		<span class="comment">// ä¸Šä¸€æ¬¡æ‹‰æ¶ˆæ¯çš„æ—¶é—´</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">lastConsumeTimestamp</span> <span class="operator">=</span> current;	<span class="comment">// ä¸Šä¸€æ¬¡æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶é—´</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">lastLockTimestamp</span> <span class="operator">=</span> current;		<span class="comment">// ä¸Šä¸€æ¬¡è·å–é”çš„æ—¶é—´</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>æ¶ˆæ¯å®¹å™¨</strong>ï¼škey æ˜¯æ¶ˆæ¯åç§»é‡ï¼Œval æ˜¯æ¶ˆæ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMap = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;Long, MessageExt&gt;();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>é¡ºåºæ¶ˆè´¹ä¸´æ—¶å®¹å™¨</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, MessageExt&gt; consumingMsgOrderlyTreeMap = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;Long, MessageExt&gt;();</span><br></pre></td></tr></table></figure>
</li>
<li><p>é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock lockTreeMap;		<span class="comment">// è¯»å†™é”</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Lock lockConsume;					<span class="comment">// é‡å…¥é”ï¼Œã€é¡ºåºæ¶ˆè´¹ä½¿ç”¨ã€‘</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>é¡ºåºæ¶ˆè´¹çŠ¶æ€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">locked</span> <span class="operator">=</span> <span class="literal">false</span>;		<span class="comment">// æ˜¯å¦æ˜¯é”å®šçŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">consuming</span> <span class="operator">=</span> <span class="literal">false</span>;		<span class="comment">// æ˜¯å¦æ˜¯æ¶ˆè´¹ä¸­</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æˆå‘˜æ–¹æ³•-9"><a href="#æˆå‘˜æ–¹æ³•-9" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h5><p>æ ¸å¿ƒæˆå‘˜æ–¹æ³•</p>
<ul>
<li><p>putMessage()ï¼šå°† Broker æ‹‰å–ä¸‹æ¥çš„ msgs å­˜å‚¨åˆ°å¿«ç…§é˜Ÿåˆ—å†…ï¼Œè¿”å›ä¸º true è¡¨ç¤ºæäº¤é¡ºåºæ¶ˆè´¹ä»»åŠ¡ï¼Œfalse è¡¨ç¤ºä¸æäº¤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">putMessage</span><span class="params">(<span class="keyword">final</span> List&lt;MessageExt&gt; msgs)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>this.lockTreeMap.writeLock().lockInterruptibly()</code>ï¼šè·å–å†™é”</p>
</li>
<li><p><code>for (MessageExt msg : msgs)</code>ï¼šéå† msgs å…¨éƒ¨åŠ å…¥ msgTreeMapï¼Œkey æ˜¯æ¶ˆæ¯çš„ queueOffset</p>
</li>
<li><p><code>if (!msgTreeMap.isEmpty() &amp;&amp; !this.consuming)</code>ï¼š<strong>æ¶ˆæ¯å®¹å™¨ä¸­å­˜åœ¨æœªå¤„ç†çš„æ¶ˆæ¯ï¼Œå¹¶ä¸”ä¸æ˜¯æ¶ˆè´¹ä¸­çš„çŠ¶æ€</strong></p>
<p><code>dispatchToConsume = true</code>ï¼šä»£è¡¨éœ€è¦æäº¤é¡ºåºæ¶ˆè´¹ä»»åŠ¡</p>
<p><code>this.consuming = true</code>ï¼šè®¾ç½®ä¸ºé¡ºåºæ¶ˆè´¹æ‰§è¡Œä¸­çš„çŠ¶æ€</p>
</li>
<li><p><code>this.lockTreeMap.writeLock().unlock()</code>ï¼šé‡Šæ”¾å†™é”</p>
</li>
</ul>
</li>
<li><p>removeMessage()ï¼šç§»é™¤å·²ç»æ¶ˆè´¹çš„æ¶ˆæ¯ï¼Œå‚æ•°æ˜¯å·²ç»æ¶ˆè´¹çš„æ¶ˆæ¯é›†åˆï¼Œå¹¶å‘æ¶ˆè´¹ä½¿ç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">removeMessage</span><span class="params">(<span class="keyword">final</span> List&lt;MessageExt&gt; msgs)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>long result = -1</code>ï¼šç»“æœåˆå§‹åŒ–ä¸º -1 </li>
<li><code>this.lockTreeMap.writeLock().lockInterruptibly()</code>ï¼šè·å–å†™é”</li>
<li><code>this.lastConsumeTimestamp = now</code>ï¼šæ›´æ–°ä¸Šä¸€æ¬¡æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶é—´ä¸ºç°åœ¨</li>
<li><code>if (!msgTreeMap.isEmpty())</code>ï¼šåˆ¤æ–­æ¶ˆæ¯å®¹å™¨æ˜¯å¦æ˜¯ç©ºï¼Œ<strong>æ˜¯ç©ºç›´æ¥è¿”å› -1</strong></li>
<li><code>result = this.queueOffsetMax + 1</code>ï¼šè®¾ç½®ç»“æœï¼Œ<strong>åˆ é™¤å®Œåæ¶ˆæ¯å®¹å™¨ä¸ºç©ºæ—¶è¿”å›</strong></li>
<li><code>for (MessageExt msg : msgs)</code>ï¼šå°†å·²ç»æ¶ˆè´¹çš„æ¶ˆæ¯å…¨éƒ¨ä» msgTreeMap ç§»é™¤</li>
<li><code>if (!msgTreeMap.isEmpty())</code>ï¼šç§»é™¤åå®¹å™¨å†…è¿˜æœ‰å¾…æ¶ˆè´¹çš„æ¶ˆæ¯ï¼Œ<strong>è·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ offset è¿”å›</strong></li>
<li><code>this.lockTreeMap.writeLock().unlock()</code>ï¼šé‡Šæ”¾å†™é”</li>
</ul>
</li>
<li><p>takeMessages()ï¼šè·å–ä¸€æ‰¹æ¶ˆæ¯ï¼Œé¡ºåºæ¶ˆè´¹ä½¿ç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;MessageExt&gt; <span class="title function_">takeMessages</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> batchSize)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>this.lockTreeMap.writeLock().lockInterruptibly()</code>ï¼šè·å–å†™é”</li>
<li><code>this.lastConsumeTimestamp = now</code>ï¼šæ›´æ–°ä¸Šä¸€æ¬¡æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶é—´ä¸ºç°åœ¨</li>
<li><code>for (int i = 0; i &lt; batchSize; i++)</code>ï¼šä»å¤´èŠ‚ç‚¹å¼€å§‹è·å–æ¶ˆæ¯</li>
<li><code>result.add(entry.getValue())</code>ï¼šå°†æ¶ˆæ¯æ”¾å…¥ç»“æœé›†åˆ</li>
<li><code>consumingMsgOrderlyTreeMap.put()</code>ï¼šå°†æ¶ˆæ¯åŠ å…¥é¡ºåºæ¶ˆè´¹å®¹å™¨ä¸­</li>
<li><code>if (result.isEmpty())</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜é¡ºåºæ¶ˆè´¹å®¹å™¨æœ¬åœ°å¿«ç…§å†…çš„æ¶ˆæ¯å…¨éƒ¨å¤„ç†å®Œäº†ï¼Œ<strong>å½“å‰é¡ºåºæ¶ˆè´¹ä»»åŠ¡éœ€è¦åœæ­¢</strong></li>
<li><code>consuming = false</code>ï¼šæ¶ˆè´¹çŠ¶æ€ç½®ä¸º false</li>
<li><code>this.lockTreeMap.writeLock().unlock()</code>ï¼šé‡Šæ”¾å†™é”</li>
</ul>
</li>
<li><p>commit()ï¼šå¤„ç†å®Œä¸€æ‰¹æ¶ˆæ¯åè°ƒç”¨ï¼Œé¡ºåºæ¶ˆè´¹ä½¿ç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">commit</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>this.lockTreeMap.writeLock().lockInterruptibly()</code>ï¼šè·å–å†™é”</li>
<li><code>Long offset = this.consumingMsgOrderlyTreeMap.lastKey()</code>ï¼šè·å–é¡ºåºæ¶ˆè´¹ä¸´æ—¶å®¹å™¨æœ€åä¸€æ¡æ•°æ®çš„ key</li>
<li><code>msgCount, msgSize</code>ï¼šæ›´æ–°é¡ºåºæ¶ˆè´¹ç›¸å…³çš„å­—æ®µ</li>
<li><code>this.consumingMsgOrderlyTreeMap.clear()</code>ï¼šæ¸…ç©ºé¡ºåºæ¶ˆè´¹å®¹å™¨çš„æ•°æ®</li>
<li><code>return offset + 1</code>ï¼š<strong>æ¶ˆè´¹è€…ä¸‹ä¸€æ¡æ¶ˆè´¹çš„ä½ç‚¹</strong></li>
<li><code>this.lockTreeMap.writeLock().unlock()</code>ï¼šé‡Šæ”¾å†™é”</li>
</ul>
</li>
<li><p>cleanExpiredMsg()ï¼šæ¸…é™¤è¿‡æœŸæ¶ˆæ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanExpiredMsg</span><span class="params">(DefaultMQPushConsumer pushConsumer)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>if (pushConsumer.getDefaultMQPushConsumerImpl().isConsumeOrderly())</code>ï¼šé¡ºåºæ¶ˆè´¹ä¸æ‰§è¡Œè¿‡æœŸæ¸…ç†é€»è¾‘</li>
<li><code>int loop = msgTreeMap.size() &lt; 16 ? msgTreeMap.size() : 16</code>ï¼šæœ€å¤šå¾ªç¯ 16 æ¬¡</li>
<li><code>if (!msgTreeMap.isEmpty() &amp;&amp;)</code>ï¼šå¦‚æœå®¹å™¨ä¸­ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆè´¹å¼€å§‹æ—¶é—´ä¸å½“å‰ç³»ç»Ÿæ—¶é—´å·®å€¼ &gt; 15minï¼Œåˆ™å–å‡ºè¯¥æ¶ˆæ¯</li>
<li><code>else</code>ï¼šç›´æ¥è·³å‡ºå¾ªç¯ï¼Œå› ä¸º<strong>å¿«ç…§é˜Ÿåˆ—å†…çš„æ¶ˆæ¯æ˜¯æœ‰é¡ºåºçš„</strong>ï¼Œç¬¬ä¸€æ¡æ¶ˆæ¯ä¸è¿‡æœŸï¼Œå…¶ä»–æ¶ˆæ¯éƒ½ä¸è¿‡æœŸ</li>
<li><code>pushConsumer.sendMessageBack(msg, 3)</code>ï¼š<strong>æ¶ˆæ¯å›é€€</strong>åˆ°æœåŠ¡å™¨ï¼Œè®¾ç½®è¯¥æ¶ˆæ¯çš„å»¶è¿Ÿçº§åˆ«ä¸º 3</li>
<li><code>if (!msgTreeMap.isEmpty() &amp;&amp; msg.getQueueOffset() == msgTreeMap.firstKey())</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜æ¶ˆæ¯å›é€€æœŸé—´ï¼Œè¯¥ç›®æ ‡æ¶ˆæ¯å¹¶æ²¡æœ‰è¢«æ¶ˆè´¹ä»»åŠ¡æˆåŠŸæ¶ˆè´¹</li>
<li><code>removeMessage(Collections.singletonList(msg))</code>ï¼šä» treeMap å°†è¯¥å›é€€æˆåŠŸçš„ msg åˆ é™¤</li>
</ul>
</li>
</ul>
<hr>
<h4 id="å¹¶å‘æ¶ˆè´¹"><a href="#å¹¶å‘æ¶ˆè´¹" class="headerlink" title="å¹¶å‘æ¶ˆè´¹"></a>å¹¶å‘æ¶ˆè´¹</h4><h5 id="æˆå‘˜å±æ€§-11"><a href="#æˆå‘˜å±æ€§-11" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>ConsumeMessageConcurrentlyService è´Ÿè´£å¹¶å‘æ¶ˆè´¹æœåŠ¡</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>æ¶ˆæ¯ç›‘å¬å™¨ï¼šå°è£…å¤„ç†æ¶ˆæ¯çš„é€»è¾‘ï¼Œè¯¥ç›‘å¬å™¨ç”±å¼€å‘è€…å®ç°ï¼Œå¹¶æ³¨å†Œåˆ° defaultMQPushConsumer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MessageListenerConcurrently messageListener;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆè´¹å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; consumeRequestQueue;	<span class="comment">// æ¶ˆè´¹ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String consumerGroup;							<span class="comment">// æ¶ˆè´¹è€…ç»„</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>çº¿ç¨‹æ± ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor consumeExecutor;				<span class="comment">// æ¶ˆè´¹ä»»åŠ¡çº¿ç¨‹æ± ï¼Œé»˜è®¤ 20</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduledExecutorService;<span class="comment">// è°ƒåº¦çº¿ç¨‹æ± ï¼Œå»¶è¿Ÿæäº¤æ¶ˆè´¹ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService cleanExpireMsgExecutors;	<span class="comment">// æ¸…ç†è¿‡æœŸæ¶ˆæ¯ä»»åŠ¡çº¿ç¨‹æ± ï¼Œ15min ä¸€æ¬¡</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æˆå‘˜æ–¹æ³•-10"><a href="#æˆå‘˜æ–¹æ³•-10" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h5><p>ConsumeMessageConcurrentlyService å¹¶å‘æ¶ˆè´¹æ ¸å¿ƒæ–¹æ³•</p>
<ul>
<li><p>start()ï¼šå¯åŠ¨æ¶ˆè´¹æœåŠ¡ï¼ŒDefaultMQPushConsumerImpl å¯åŠ¨æ—¶ä¼šè°ƒç”¨è¯¥æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// æäº¤â€œæ¸…ç†è¿‡æœŸæ¶ˆæ¯ä»»åŠ¡â€ä»»åŠ¡ï¼Œå»¶è¿Ÿ15minä¹‹åæ‰§è¡Œï¼Œä¹‹åæ¯15minæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">    <span class="built_in">this</span>.cleanExpireMsgExecutors.scheduleAtFixedRate(() -&gt;  cleanExpireMsg()&#125;, </span><br><span class="line">                                                     <span class="number">15</span>, <span class="number">15</span>, TimeUnit.MINUTES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>cleanExpireMsg()ï¼šæ¸…ç†è¿‡æœŸæ¶ˆæ¯ä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cleanExpireMsg</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>Iterator&lt;Map.Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it</code>ï¼šè·å–åˆ†é…ç»™å½“å‰æ¶ˆè´¹è€…çš„é˜Ÿåˆ—</li>
<li><code>while (it.hasNext())</code>ï¼šéå†æ‰€æœ‰çš„é˜Ÿåˆ—</li>
<li><code>pq.cleanExpiredMsg(this.defaultMQPushConsumer)</code>ï¼šè°ƒç”¨é˜Ÿåˆ—å¿«ç…§ ProcessQueue æ¸…ç†è¿‡æœŸæ¶ˆæ¯çš„æ–¹æ³•</li>
</ul>
</li>
<li><p>submitConsumeRequest()ï¼šæäº¤æ¶ˆè´¹è¯·æ±‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°ä¸€ï¼šä»æœåŠ¡å™¨ pull ä¸‹æ¥çš„è¿™æ‰¹æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">// å‚æ•°äºŒï¼šæ¶ˆæ¯å½’å± mq åœ¨æ¶ˆè´¹è€…ç«¯çš„ processQueueï¼Œæäº¤æ¶ˆè´¹ä»»åŠ¡ä¹‹å‰ï¼Œmsgså·²ç»åŠ å…¥åˆ°è¯¥pqå†…äº†</span></span><br><span class="line"><span class="comment">// å‚æ•°ä¸‰ï¼šæ¶ˆæ¯å½’å±é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">// å‚æ•°å››ï¼šå¹¶å‘æ¶ˆæ¯æ­¤å‚æ•°æ— æ•ˆ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">submitConsumeRequest</span><span class="params">(List&lt;MessageExt&gt; msgs, ProcessQueue processQueue, MessageQueue messageQueue, <span class="type">boolean</span> dispatchToConsume)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>final int consumeBatchSize</code>ï¼š<strong>ä¸€ä¸ªæ¶ˆè´¹ä»»åŠ¡å¯æ¶ˆè´¹çš„æ¶ˆæ¯æ•°é‡</strong>ï¼Œé»˜è®¤ä¸º 1</p>
</li>
<li><p><code>if (msgs.size() &lt;= consumeBatchSize)</code>ï¼šåˆ¤æ–­ä¸€ä¸ªæ¶ˆè´¹ä»»åŠ¡æ˜¯å¦å¯ä»¥æäº¤</p>
<p><code>ConsumeRequest consumeRequest</code>ï¼šå°è£…ä¸ºæ¶ˆè´¹è¯·æ±‚</p>
<p><code>this.consumeExecutor.submit(consumeRequest)</code>ï¼šæäº¤æ¶ˆè´¹ä»»åŠ¡ï¼Œå¼‚æ­¥æ‰§è¡Œæ¶ˆæ¯çš„å¤„ç†</p>
</li>
<li><p><code>else</code>ï¼šè¯´æ˜æ¶ˆæ¯è¾ƒå¤šï¼Œéœ€è¦å¤šä¸ªæ¶ˆè´¹ä»»åŠ¡</p>
<p><code>for (int total = 0; total &lt; msgs.size(); )</code>ï¼šå°†æ¶ˆæ¯æ‹†åˆ†æˆå¤šä¸ªæ¶ˆè´¹ä»»åŠ¡</p>
</li>
</ul>
</li>
<li><p>processConsumeResult()ï¼šå¤„ç†æ¶ˆè´¹ç»“æœ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°ä¸€ï¼šæ¶ˆè´¹ç»“æœçŠ¶æ€ï¼›  å‚æ•°äºŒï¼šæ¶ˆè´¹ä¸Šä¸‹æ–‡ï¼›  å‚æ•°ä¸‰ï¼šå½“å‰æ¶ˆè´¹ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processConsumeResult</span><span class="params">(status, context, consumeRequest)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>switch (status)</code>ï¼šæ ¹æ®æ¶ˆè´¹ç»“æœçŠ¶æ€è¿›è¡Œå¤„ç†</p>
</li>
<li><p><code>case CONSUME_SUCCESS</code>ï¼šæ¶ˆè´¹æˆåŠŸ</p>
<p><code>if (ackIndex &gt;= consumeRequest.getMsgs().size())</code>ï¼šæ¶ˆè´¹æˆåŠŸçš„è¯ï¼ŒackIndex è®¾ç½®æˆ <code>æ¶ˆè´¹æ¶ˆæ¯æ•° - 1</code> çš„å€¼ï¼Œæ¯”å¦‚æœ‰ 5 æ¡æ¶ˆæ¯ï¼Œè¿™é‡Œå°±è®¾ç½®ä¸º 4</p>
<p><code>ok, failed</code>ï¼šok è®¾ç½®ä¸ºæ¶ˆæ¯æ•°é‡ï¼Œfailed è®¾ç½®ä¸º 0</p>
</li>
<li><p><code>case RECONSUME_LATER</code>ï¼šæ¶ˆè´¹å¤±è´¥</p>
<p><code>ackIndex = -1</code>ï¼šè®¾ç½®ä¸º -1</p>
</li>
<li><p><code>switch (this.defaultMQPushConsumer.getMessageModel())</code>ï¼šåˆ¤æ–­æ¶ˆè´¹æ¨¡å¼ï¼Œé»˜è®¤æ˜¯<strong>é›†ç¾¤æ¨¡å¼</strong></p>
</li>
<li><p><code>for (int i = ackIndex + 1; i &lt; msgs.size(); i++)</code>ï¼šå½“æ¶ˆè´¹å¤±è´¥æ—¶ ackIndex ä¸º -1ï¼Œi çš„èµ·å§‹å€¼ä¸º 0ï¼Œè¯¥æ¶ˆè´¹ä»»åŠ¡å†…çš„<strong>å…¨éƒ¨æ¶ˆæ¯</strong>éƒ½ä¼šå°è¯•å›é€€ç»™æœåŠ¡å™¨</p>
</li>
<li><p><code>MessageExt msg</code>ï¼šæå–ä¸€æ¡æ¶ˆæ¯</p>
</li>
<li><p><code>boolean result = this.sendMessageBack(msg, context)</code>ï¼š<strong>å‘é€æ¶ˆæ¯å›é€€ï¼ŒåŒæ­¥å‘é€</strong></p>
</li>
<li><p><code>if (!result)</code>ï¼šå›é€€å¤±è´¥çš„æ¶ˆæ¯ï¼Œå°†<strong>æ¶ˆæ¯çš„é‡è¯•å±æ€§åŠ  1</strong>ï¼Œå¹¶åŠ å…¥åˆ°å›é€€å¤±è´¥çš„é›†åˆ</p>
</li>
<li><p><code>if (!msgBackFailed.isEmpty())</code>ï¼šå›é€€å¤±è´¥é›†åˆä¸ä¸ºç©º</p>
</li>
</ul>
<p><code>consumeRequest.getMsgs().removeAll(msgBackFailed)</code>ï¼šå°†å›é€€å¤±è´¥çš„æ¶ˆæ¯ä»å½“å‰æ¶ˆè´¹ä»»åŠ¡çš„ msgs é›†åˆå†…ç§»é™¤</p>
<p><code>this.submitConsumeRequestLater()</code>ï¼š<strong>å›é€€å¤±è´¥çš„æ¶ˆæ¯ä¼šå†æ¬¡æäº¤æ¶ˆè´¹ä»»åŠ¡</strong>ï¼Œå»¶è¿Ÿ 5 ç§’é’Ÿåå†æ¬¡å°è¯•æ¶ˆè´¹</p>
</li>
<li><p><code>long offset = ...removeMessage(msgs)</code>ï¼šä» pq ä¸­åˆ é™¤å·²ç»æ¶ˆè´¹æˆåŠŸçš„æ¶ˆæ¯ï¼Œè¿”å› offset</p>
</li>
<li><p><code>this...getOffsetStore().updateOffset()</code>ï¼šæ›´æ–°æ¶ˆè´¹è€…æœ¬åœ°è¯¥ mq çš„<strong>æ¶ˆè´¹è¿›åº¦</strong></p>
</li>
</ul>
<hr>
<h5 id="æ¶ˆè´¹è¯·æ±‚"><a href="#æ¶ˆè´¹è¯·æ±‚" class="headerlink" title="æ¶ˆè´¹è¯·æ±‚"></a>æ¶ˆè´¹è¯·æ±‚</h5><p>ConsumeRequest æ˜¯ ConsumeMessageConcurrentlyService çš„å†…éƒ¨ç±»ï¼Œæ˜¯ä¸€ä¸ª Runnable ä»»åŠ¡å¯¹è±¡</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>åˆ†é…åˆ°è¯¥æ¶ˆè´¹ä»»åŠ¡çš„æ¶ˆæ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;MessageExt&gt; msgs;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆæ¯é˜Ÿåˆ—ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ProcessQueue processQueue;	<span class="comment">// æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MessageQueue messageQueue;	<span class="comment">// æ¶ˆæ¯é˜Ÿåˆ—</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li><p>run()ï¼šæ‰§è¡Œä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>if (this.processQueue.isDropped())</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜è¯¥ queue ç»è¿‡ rbl ç®—æ³•åˆ†é…åˆ°å…¶ä»–çš„ consumer</li>
<li><code>MessageListenerConcurrently listener</code>ï¼šè·å–æ¶ˆæ¯ç›‘å¬å™¨</li>
<li><code>ConsumeConcurrentlyContext context</code>ï¼šåˆ›å»ºæ¶ˆè´¹ä¸Šä¸‹æ–‡å¯¹è±¡</li>
<li><code>defaultMQPushConsumerImpl.resetRetryAndNamespace()</code>ï¼šé‡ç½®é‡è¯•æ ‡è®°<ul>
<li><code>final String groupTopic</code>ï¼šè·å–å½“å‰æ¶ˆè´¹è€…ç»„çš„é‡è¯•ä¸»é¢˜ <code>%RETRY%GroupName</code></li>
<li><code>for (MessageExt msg : msgs)</code>ï¼šéå†æ‰€æœ‰çš„æ¶ˆæ¯</li>
<li><code>String retryTopic = msg.getProperty(...)</code>ï¼šåŸä¸»é¢˜ï¼Œä¸€èˆ¬æ¶ˆæ¯æ²¡æœ‰è¯¥å±æ€§ï¼Œåªæœ‰è¢«é‡å¤æ¶ˆè´¹çš„æ¶ˆæ¯æ‰æœ‰</li>
<li><code>if (retryTopic != null &amp;&amp; groupTopic.equals(...))</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜è¯¥æ¶ˆæ¯æ˜¯è¢«é‡å¤æ¶ˆè´¹çš„æ¶ˆæ¯</li>
<li><code>msg.setTopic(retryTopic)</code>ï¼šå°†è¢«<strong>é‡å¤æ¶ˆè´¹çš„æ¶ˆæ¯ä¸»é¢˜ä¿®æ”¹å›åŸä¸»é¢˜</strong></li>
</ul>
</li>
<li><code>if (ConsumeMessageConcurrentlyService...hasHook())</code>ï¼šå‰ç½®å¤„ç†</li>
<li><code>boolean hasException = false</code>ï¼šæ¶ˆè´¹è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦å‘å¤–æŠ›å‡ºå¼‚å¸¸</li>
<li><code>MessageAccessor.setConsumeStartTimeStamp()</code>ï¼šç»™æ¯æ¡æ¶ˆæ¯è®¾ç½®æ¶ˆè´¹å¼€å§‹æ—¶é—´</li>
<li><code>status = listener.consumeMessage(Collections.unmodifiableList(msgs), context)</code>ï¼š<strong>æ¶ˆè´¹æ¶ˆæ¯</strong></li>
<li><code>if (ConsumeMessageConcurrentlyService...hasHook())</code>ï¼šåç½®å¤„ç†</li>
<li><code>...processConsumeResult(status, context, this)</code>ï¼š<strong>å¤„ç†æ¶ˆè´¹ç»“æœ</strong></li>
</ul>
</li>
</ul>
<hr>
<h4 id="é¡ºåºæ¶ˆè´¹"><a href="#é¡ºåºæ¶ˆè´¹" class="headerlink" title="é¡ºåºæ¶ˆè´¹"></a>é¡ºåºæ¶ˆè´¹</h4><h5 id="æˆå‘˜å±æ€§-12"><a href="#æˆå‘˜å±æ€§-12" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>ConsumeMessageOrderlyService è´Ÿè´£é¡ºåºæ¶ˆè´¹æœåŠ¡</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p>æ¶ˆæ¯ç›‘å¬å™¨ï¼šå°è£…å¤„ç†æ¶ˆæ¯çš„é€»è¾‘ï¼Œè¯¥ç›‘å¬å™¨ç”±å¼€å‘è€…å®ç°ï¼Œå¹¶æ³¨å†Œåˆ° defaultMQPushConsumer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MessageListenerOrderly messageListener;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¶ˆè´¹å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; consumeRequestQueue;	<span class="comment">// æ¶ˆè´¹ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String consumerGroup;							<span class="comment">// æ¶ˆè´¹è€…ç»„</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">stopped</span> <span class="operator">=</span> <span class="literal">false</span>;					<span class="comment">// æ¶ˆè´¹åœæ­¢çŠ¶æ€</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>çº¿ç¨‹æ± ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor consumeExecutor;				<span class="comment">// æ¶ˆè´¹ä»»åŠ¡çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduledExecutorService;<span class="comment">// è°ƒåº¦çº¿ç¨‹æ± ï¼Œå»¶è¿Ÿæäº¤æ¶ˆè´¹ä»»åŠ¡</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>é˜Ÿåˆ—é”ï¼šæ¶ˆè´¹è€…æœ¬åœ° MQ é”ï¼Œ<strong>ç¡®ä¿æœ¬åœ°å¯¹äºéœ€è¦é¡ºåºæ¶ˆè´¹çš„ MQ åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œ</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">MessageQueueLock</span> <span class="variable">messageQueueLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageQueueLock</span>();</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageQueueLock</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> ConcurrentMap&lt;MessageQueue, Object&gt; mqLockTable = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;MessageQueue, Object&gt;();</span><br><span class="line">    <span class="comment">// è·å–æœ¬åœ°é˜Ÿåˆ—é”å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">fetchLockObject</span><span class="params">(<span class="keyword">final</span> MessageQueue mq)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">objLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mqLockTable.get(mq);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == objLock) &#123;</span><br><span class="line">            objLock = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">            <span class="type">Object</span> <span class="variable">prevLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mqLockTable.putIfAbsent(mq, objLock);</span><br><span class="line">            <span class="keyword">if</span> (prevLock != <span class="literal">null</span>) &#123;</span><br><span class="line">                objLock = prevLock;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> objLock;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å·²ç»è·å–äº† Broker ç«¯è¯¥ Queue çš„ç‹¬å é”ï¼Œä¸ºä»€ä¹ˆè¿˜è¦è·å–æœ¬åœ°é˜Ÿåˆ—é”å¯¹è±¡ï¼Ÿï¼ˆè¿™é‡Œæˆ‘ä¹Ÿæ²¡å¤ªæ‡‚ï¼Œå…ˆè®°å½•ä¸‹æ¥ï¼Œæœ¬åœ°å¤šçº¿ç¨‹ï¼Ÿï¼‰</p>
<ul>
<li>Broker queue å ç”¨é”çš„è§’åº¦æ˜¯ Client å ç”¨ï¼ŒClient ä» Broker çš„æŸä¸ªå ç”¨äº†é”çš„ queue æ‹‰å–ä¸‹æ¥æ¶ˆæ¯ä»¥åï¼Œå°†æ¶ˆæ¯å­˜å‚¨åˆ°æ¶ˆè´¹è€…æœ¬åœ°çš„ ProcessQueue ä¸­ï¼Œå¿«ç…§å¯¹è±¡çš„ consuming å±æ€§ç½®ä¸º trueï¼Œè¡¨ç¤ºæœ¬åœ°çš„é˜Ÿåˆ—æ­£åœ¨æ¶ˆè´¹å¤„ç†ä¸­</li>
<li>ProcessQueue  è°ƒç”¨ takeMessages æ–¹æ³•æ—¶ä¼šè·å–ä¸‹ä¸€æ‰¹å¾…å¤„ç†çš„æ¶ˆæ¯ï¼Œè·å–ä¸åˆ°ä¼šä¿®æ”¹ <code>consuming = false</code>ï¼Œæœ¬æ¶ˆè´¹ä»»åŠ¡é©¬ä¸Šåœæ­¢ã€‚</li>
<li>å¦‚æœæ­¤æ—¶ Pull å†æ¬¡æ‹‰å–ä¸€æ‰¹å½“å‰ ProcessQueue  çš„ msgï¼Œä¼šå†æ¬¡å‘é¡ºåºæ¶ˆè´¹æœåŠ¡æäº¤æ¶ˆè´¹ä»»åŠ¡ï¼Œæ­¤æ—¶éœ€è¦æœ¬åœ°é˜Ÿåˆ—é”å¯¹è±¡åŒæ­¥æœ¬åœ°çº¿ç¨‹</li>
</ul>
</li>
</ul>
<hr>
<h5 id="æˆå‘˜æ–¹æ³•-11"><a href="#æˆå‘˜æ–¹æ³•-11" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h5><ul>
<li><p>start()ï¼šå¯åŠ¨æ¶ˆè´¹æœåŠ¡ï¼ŒDefaultMQPushConsumerImpl å¯åŠ¨æ—¶ä¼šè°ƒç”¨è¯¥æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>this.scheduledExecutorService.scheduleAtFixedRate()</code>ï¼šæäº¤é”ç»­çº¦ä»»åŠ¡ï¼Œå»¶è¿Ÿ 1 ç§’æ‰§è¡Œï¼Œå‘¨æœŸä¸º 20 ç§’é’Ÿ</li>
<li><code>ConsumeMessageOrderlyService.this.lockMQPeriodically()</code>ï¼š<strong>é”ç»­çº¦ä»»åŠ¡</strong><ul>
<li><code>this.defaultMQPushConsumerImpl.getRebalanceImpl().lockAll()</code>ï¼šå¯¹æ¶ˆè´¹è€…çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œç»­çº¦</li>
</ul>
</li>
</ul>
</li>
<li><p>submitConsumeRequest()ï¼š<strong>æäº¤æ¶ˆè´¹ä»»åŠ¡è¯·æ±‚</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°ï¼štrue è¡¨ç¤ºåˆ›å»ºæ¶ˆè´¹ä»»åŠ¡å¹¶æäº¤ï¼Œfalseä¸åˆ›å»ºæ¶ˆè´¹ä»»åŠ¡ï¼Œè¯´æ˜æ¶ˆè´¹è€…æœ¬åœ°å·²ç»æœ‰æ¶ˆè´¹ä»»åŠ¡åœ¨æ‰§è¡Œäº†</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">submitConsumeRequest</span><span class="params">(...., <span class="keyword">final</span> <span class="type">boolean</span> dispathToConsume)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (dispathToConsume) &#123;</span><br><span class="line">        <span class="comment">// å½“å‰è¿›ç¨‹å†…ä¸å­˜åœ¨ é¡ºåºæ¶ˆè´¹ä»»åŠ¡ï¼Œåˆ›å»ºæ–°çš„æ¶ˆè´¹ä»»åŠ¡ï¼Œã€æäº¤åˆ°æ¶ˆè´¹ä»»åŠ¡çº¿ç¨‹æ± ã€‘</span></span><br><span class="line">        <span class="type">ConsumeRequest</span> <span class="variable">consumeRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConsumeRequest</span>(processQueue, messageQueue);</span><br><span class="line">        <span class="built_in">this</span>.consumeExecutor.submit(consumeRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>processConsumeResult()ï¼šæ¶ˆè´¹ç»“æœå¤„ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°1ï¼šmsgs æœ¬è½®å¾ªç¯æ¶ˆè´¹çš„æ¶ˆæ¯é›†åˆ    					å‚æ•°2ï¼šstatus  æ¶ˆè´¹çŠ¶æ€</span></span><br><span class="line"><span class="comment">// å‚æ•°3ï¼šcontext æ¶ˆè´¹ä¸Šä¸‹æ–‡ 							å‚æ•°4ï¼šæ¶ˆè´¹ä»»åŠ¡</span></span><br><span class="line"><span class="comment">// è¿”å›å€¼ï¼šboolean å†³å®šæ˜¯å¦ç»§ç»­å¾ªç¯å¤„ç†pqå†…çš„æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">processConsumeResult</span><span class="params">(<span class="keyword">final</span> List&lt;MessageExt&gt; msgs, <span class="keyword">final</span> ConsumeOrderlyStatus status, <span class="keyword">final</span> ConsumeOrderlyContext context, <span class="keyword">final</span> ConsumeRequest consumeRequest)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>if (context.isAutoCommit())</code>ï¼šé»˜è®¤è‡ªåŠ¨æäº¤</p>
</li>
<li><p><code>switch (status)</code>ï¼šæ ¹æ®æ¶ˆè´¹çŠ¶æ€è¿›è¡Œä¸åŒçš„å¤„ç†</p>
</li>
<li><p><code>case SUCCESS</code>ï¼šæ¶ˆè´¹æˆåŠŸ</p>
<p><code>commitOffset = ...commit()</code>ï¼šè°ƒç”¨ pq æäº¤æ–¹æ³•ï¼Œä¼šå°†æœ¬æ¬¡å¾ªç¯å¤„ç†çš„æ¶ˆæ¯ä»é¡ºåºæ¶ˆè´¹ map åˆ é™¤ï¼Œå¹¶ä¸”è¿”å›æ¶ˆæ¯è¿›åº¦</p>
</li>
<li><p><code>case SUSPEND_CURRENT_QUEUE_A_MOMENT</code>ï¼šæŒ‚èµ·å½“å‰é˜Ÿåˆ—</p>
<p><code>consumeRequest.getProcessQueue().makeMessageToConsumeAgain(msgs)</code>ï¼š<strong>å›æ»šæ¶ˆæ¯</strong></p>
<ul>
<li><code>for (MessageExt msg : msgs)</code>ï¼šéå†æ‰€æœ‰çš„æ¶ˆæ¯</li>
<li><code>this.consumingMsgOrderlyTreeMap.remove(msg.getQueueOffset())</code>ï¼šä»é¡ºåºæ¶ˆè´¹ä¸´æ—¶å®¹å™¨ä¸­ç§»é™¤</li>
<li><code>this.msgTreeMap.put(msg.getQueueOffset(), msg)</code>ï¼šæ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨</li>
</ul>
</li>
<li><p><code>this.submitConsumeRequestLater()</code>ï¼šå†æ¬¡æäº¤æ¶ˆè´¹ä»»åŠ¡ï¼Œ1 ç§’åæ‰§è¡Œ</p>
</li>
<li><p><code>continueConsume = false</code>ï¼šè®¾ç½®ä¸º falseï¼Œ<strong>å¤–å±‚ä¼šé€€å‡ºæœ¬æ¬¡çš„æ¶ˆè´¹ä»»åŠ¡</strong></p>
</li>
<li><p><code>this.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(...)</code>ï¼šæ›´æ–°æœ¬åœ°æ¶ˆè´¹è¿›åº¦</p>
</li>
</ul>
</li>
</ul>
<hr>
<h5 id="æ¶ˆè´¹è¯·æ±‚-1"><a href="#æ¶ˆè´¹è¯·æ±‚-1" class="headerlink" title="æ¶ˆè´¹è¯·æ±‚"></a>æ¶ˆè´¹è¯·æ±‚</h5><p>ConsumeRequest æ˜¯ ConsumeMessageOrderlyService çš„å†…éƒ¨ç±»ï¼Œæ˜¯ä¸€ä¸ª Runnable ä»»åŠ¡å¯¹è±¡</p>
<p>æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<ul>
<li><p>run()ï¼šæ‰§è¡Œä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>final Object objLock</code>ï¼šè·å–æœ¬åœ°é”å¯¹è±¡</p>
</li>
<li><p><code>synchronized (objLock)</code>ï¼šæœ¬åœ°é˜Ÿåˆ—é”ï¼Œç¡®ä¿æ¯ä¸ª MQ çš„æ¶ˆè´¹ä»»åŠ¡åªæœ‰ä¸€ä¸ªåœ¨æ‰§è¡Œï¼Œ<strong>ç¡®ä¿é¡ºåºæ¶ˆè´¹</strong></p>
</li>
<li><p><code>if(.. || (this.processQueue.isLocked() &amp;&amp; !this.processQueue.isLockExpired())))</code>ï¼šå½“å‰é˜Ÿåˆ—æŒæœ‰åˆ†å¸ƒå¼é”ï¼Œå¹¶ä¸”é”æœªè¿‡æœŸï¼ŒæŒé”æ—¶é—´è¶…è¿‡ 30 ç§’ç®—è¿‡æœŸ</p>
</li>
<li><p><code>final long beginTime</code>ï¼šæ¶ˆè´¹å¼€å§‹æ—¶é—´</p>
</li>
<li><p><code>for (boolean continueConsume = true; continueConsume; )</code>ï¼šæ ¹æ®æ˜¯å¦ç»§ç»­æ¶ˆè´¹çš„æ ‡è®°åˆ¤æ–­æ˜¯å¦ç»§ç»­</p>
</li>
<li><p><code>final int consumeBatchSize</code>ï¼šè·å–æ¯æ¬¡å¾ªç¯å¤„ç†çš„æ¶ˆæ¯æ•°é‡ï¼Œä¸€èˆ¬æ˜¯ 1</p>
</li>
<li><p><code>List&lt;MessageExt&gt; msgs = this...takeMessages(consumeBatchSize)</code>ï¼šåˆ°<strong>å¤„ç†é˜Ÿåˆ—è·å–ä¸€æ‰¹æ¶ˆæ¯</strong></p>
</li>
<li><p><code>if (!msgs.isEmpty())</code>ï¼šè·å–åˆ°äº†å¾…æ¶ˆè´¹çš„æ¶ˆæ¯</p>
<p><code>final ConsumeOrderlyContext context</code>ï¼šåˆ›å»ºæ¶ˆè´¹ä¸Šä¸‹æ–‡å¯¹è±¡</p>
<p><code>this.processQueue.getLockConsume().lock()</code>ï¼š<strong>è·å– lockConsume é”</strong>ï¼Œä¸ RBL çº¿ç¨‹åŒæ­¥ä½¿ç”¨</p>
<p><code>status = messageListener.consumeMessage(...)</code>ï¼šç›‘å¬å™¨å¤„ç†æ¶ˆæ¯ </p>
<p><code>this.processQueue.getLockConsume().unlock()</code>ï¼š<strong>é‡Šæ”¾ lockConsume é”</strong></p>
<p><code>if (null == status)</code>ï¼šå¤„ç†æ¶ˆæ¯çŠ¶æ€è¿”å› nullï¼Œè®¾ç½®çŠ¶æ€ä¸ºæŒ‚èµ·å½“å‰é˜Ÿåˆ—</p>
<p><code>continueConsume = ...processConsumeResult()</code>ï¼šæ¶ˆè´¹ç»“æœå¤„ç†</p>
</li>
<li><p><code>else</code>ï¼šè·å–åˆ°çš„æ¶ˆæ¯æ˜¯ç©º</p>
<p><code>continueConsume = false</code>ï¼šç»“æŸä»»åŠ¡å¾ªç¯</p>
</li>
<li><p><code>else</code>ï¼šå½“å‰é˜Ÿåˆ—æœªæŒæœ‰åˆ†å¸ƒå¼é”ï¼Œæˆ–è€…é”è¿‡æœŸ</p>
<p><code>ConsumeMessageOrderlyService.this.tryLockLaterAndReconsume()</code>ï¼šé‡æ–°æäº¤ä»»åŠ¡ï¼Œæ ¹æ®æ˜¯å¦è·å–åˆ°é˜Ÿåˆ—é”ï¼Œé€‰æ‹©å»¶è¿Ÿ 10 æ¯«ç§’æˆ–è€… 300 æ¯«ç§’</p>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="ç”Ÿäº§æ¶ˆè´¹-1"><a href="#ç”Ÿäº§æ¶ˆè´¹-1" class="headerlink" title="ç”Ÿäº§æ¶ˆè´¹"></a>ç”Ÿäº§æ¶ˆè´¹</h3><p>ç”Ÿäº§æµç¨‹ï¼š</p>
<ul>
<li>é¦–å…ˆè·å–å½“å‰æ¶ˆæ¯ä¸»é¢˜çš„å‘å¸ƒä¿¡æ¯ï¼Œè·å–ä¸åˆ°å» Namesrv è·å–ï¼ˆé»˜è®¤æœ‰ TBW102ï¼‰ï¼Œå¹¶å°†è·å–çš„åˆ°çš„è·¯ç”±æ•°æ®è½¬åŒ–ä¸ºå‘å¸ƒæ•°æ®ï¼Œ<strong>åˆ›å»º MQ é˜Ÿåˆ—åœ¨å¤šä¸ª Broker ç»„</strong>ï¼ˆä¸€ç»„ä»£è¡¨ä¸€ä¸»å¤šä»çš„ Broker æ¶æ„ï¼‰ï¼Œå®¢æˆ·ç«¯å®ä¾‹åŒæ ·æ›´æ–°è®¢é˜…æ•°æ®ï¼Œåˆ›å»º MQ é˜Ÿåˆ—ï¼Œæ”¾å…¥è´Ÿè½½å‡è¡¡æœåŠ¡ topicSubscribeInfoTable ä¸­</li>
<li>ç„¶åä»å‘å¸ƒæ•°æ®ä¸­é€‰æ‹©ä¸€ä¸ª MQ é˜Ÿåˆ—å‘é€æ¶ˆæ¯</li>
<li>Broker ç«¯é€šè¿‡ SendMessageProcessor å¯¹å‘é€çš„æ¶ˆæ¯è¿›è¡ŒæŒä¹…åŒ–å¤„ç†ï¼Œå­˜å‚¨åˆ° CommitLogã€‚å°†é‡è¯•æ¬¡æ•°è¿‡å¤šçš„æ¶ˆæ¯åŠ å…¥<strong>æ­»ä¿¡é˜Ÿåˆ—</strong>ï¼Œå°†å»¶è¿Ÿæ¶ˆæ¯çš„ä¸»é¢˜å’Œé˜Ÿåˆ—ä¿®æ”¹ä¸ºè°ƒåº¦ä¸»é¢˜å’Œè°ƒåº¦é˜Ÿåˆ— ID</li>
<li>Broker å¯åŠ¨ ScheduleMessageService æœåŠ¡ä¼šä¸ºæ¯ä¸ªå»¶è¿Ÿçº§åˆ«åˆ›å»ºä¸€ä¸ªå»¶è¿Ÿä»»åŠ¡ï¼Œè®©å»¶è¿Ÿæ¶ˆæ¯å¾—åˆ°æœ‰æ•ˆçš„å¤„ç†ï¼Œå°†åˆ°è¾¾äº¤ä»˜æ—¶é—´çš„æ¶ˆæ¯ä¿®æ”¹ä¸ºåŸå§‹ä¸»é¢˜çš„åŸå§‹ ID å­˜å…¥ CommitLogï¼Œæ¶ˆè´¹è€…å°±å¯ä»¥è¿›è¡Œæ¶ˆè´¹äº†</li>
</ul>
<p>æ¶ˆè´¹æµç¨‹ï¼š</p>
<ul>
<li>æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ— ConsumerQueue å­˜å‚¨æ¶ˆæ¯åœ¨ CommitLog çš„ç´¢å¼•ï¼Œæ¶ˆè´¹è€…é€šè¿‡è¯¥é˜Ÿåˆ—æ¥è¯»å–æ¶ˆæ¯å®ä½“å†…å®¹ï¼Œä¸€ä¸ª MQ å°±å¯¹åº”ä¸€ä¸ª CQ</li>
<li>é¦–å…ˆé€šè¿‡è´Ÿè½½å‡è¡¡æœåŠ¡ï¼Œå°†åˆ†é…åˆ°å½“å‰æ¶ˆè´¹è€…å®ä¾‹çš„ MQ åˆ›å»º PullRequestï¼Œå¹¶æ”¾å…¥ PullMessageService çš„æœ¬åœ°é˜»å¡é˜Ÿåˆ—å†…</li>
<li>PullMessageService å¾ªç¯ä»é˜»å¡é˜Ÿåˆ—è·å–è¯·æ±‚å¯¹è±¡ï¼Œå‘èµ·æ‹‰æ¶ˆæ¯è¯·æ±‚ï¼Œå¹¶åˆ›å»º PullCallback å›è°ƒå¯¹è±¡ï¼Œå°†æ­£å¸¸æ‹‰å–çš„æ¶ˆæ¯<strong>æäº¤åˆ°æ¶ˆè´¹ä»»åŠ¡çº¿ç¨‹æ± </strong>ï¼Œå¹¶è®¾ç½®è¯·æ±‚çš„ä¸‹ä¸€æ¬¡æ‹‰å–ä½ç‚¹ï¼Œé‡æ–°æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå½¢æˆé—­ç¯</li>
<li>æ¶ˆè´¹ä»»åŠ¡æœåŠ¡å¯¹æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯è¿›è¡Œå›é€€ï¼Œé€šè¿‡å†…éƒ¨ç”Ÿäº§è€…å®ä¾‹å‘é€å›é€€æ¶ˆæ¯ï¼Œå›é€€å¤±è´¥çš„æ¶ˆæ¯ä¼šå†æ¬¡æäº¤æ¶ˆè´¹ä»»åŠ¡é‡æ–°æ¶ˆè´¹</li>
<li>Broker ç«¯å¯¹æ‹‰å–æ¶ˆæ¯çš„è¯·æ±‚è¿›è¡Œå¤„ç†ï¼ˆprocessRequestCommandï¼‰ï¼ŒæŸ¥è¯¢æˆåŠŸå°†æ¶ˆæ¯æ”¾å…¥å“åº”ä½“ï¼Œé€šè¿‡ Netty å†™å›å®¢æˆ·ç«¯ï¼Œå½“ <code>pullRequest.offset == queue.maxOffset</code> è¯´æ˜è¯¥é˜Ÿåˆ—å·²ç»æ²¡æœ‰éœ€è¦è·å–çš„æ¶ˆæ¯ï¼Œå°†è¯·æ±‚æ”¾å…¥é•¿è½®è¯¢é›†åˆç­‰å¾…æœ‰æ–°æ¶ˆæ¯</li>
<li>PullRequestHoldService è´Ÿè´£é•¿è½®è¯¢ï¼Œæ¯ 5 ç§’éå†ä¸€æ¬¡é•¿è½®è¯¢é›†åˆï¼Œå°†æ»¡è¶³æ¡ä»¶çš„ PullRequest å†æ¬¡æäº¤åˆ°çº¿ç¨‹æ± å†…å¤„ç†</li>
</ul>
<hr>
<h1 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h1><h2 id="åŸºæœ¬ä»‹ç»-7"><a href="#åŸºæœ¬ä»‹ç»-7" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h2><h3 id="æ¡†æ¶ç‰¹å¾"><a href="#æ¡†æ¶ç‰¹å¾" class="headerlink" title="æ¡†æ¶ç‰¹å¾"></a>æ¡†æ¶ç‰¹å¾</h3><p>Zookeeper æ˜¯ Apache Hadoop é¡¹ç›®å­é¡¹ç›®ï¼Œä¸ºåˆ†å¸ƒå¼æ¡†æ¶æä¾›åè°ƒæœåŠ¡ï¼Œæ˜¯ä¸€ä¸ªæ ‘å½¢ç›®å½•æœåŠ¡</p>
<p>Zookeeper æ˜¯åŸºäºè§‚å¯Ÿè€…æ¨¡å¼è®¾è®¡çš„åˆ†å¸ƒå¼æœåŠ¡ç®¡ç†æ¡†æ¶ï¼Œè´Ÿè´£å­˜å‚¨å’Œç®¡ç†å…±äº«æ•°æ®ï¼Œæ¥å—è§‚å¯Ÿè€…çš„æ³¨å†Œç›‘æ§ï¼Œä¸€æ—¦è¿™äº›æ•°æ®çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼ŒZookeeper ä¼šé€šçŸ¥è§‚å¯Ÿè€…</p>
<ul>
<li>Zookeeper æ˜¯ä¸€ä¸ªé¢†å¯¼è€…ï¼ˆLeaderï¼‰ï¼Œå¤šä¸ªè·Ÿéšè€…ï¼ˆFollowerï¼‰ç»„æˆçš„é›†ç¾¤</li>
<li>é›†ç¾¤ä¸­åªè¦æœ‰åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹å­˜æ´»å°±èƒ½æ­£å¸¸æœåŠ¡ï¼Œæ‰€ä»¥ Zookeeper é€‚åˆéƒ¨ç½²å¥‡æ•°å°æœåŠ¡å™¨</li>
<li><strong>å…¨å±€æ•°æ®ä¸€è‡´</strong>ï¼Œæ¯ä¸ª Server ä¿å­˜ä¸€ä»½ç›¸åŒçš„æ•°æ®å‰¯æœ¬ï¼ŒClient æ— è®ºè¿æ¥åˆ°å“ªä¸ª Serverï¼Œæ•°æ®éƒ½æ˜¯ä¸€è‡´</li>
<li>æ›´æ–°çš„è¯·æ±‚é¡ºåºæ‰§è¡Œï¼Œæ¥è‡ªåŒä¸€ä¸ª Client çš„è¯·æ±‚æŒ‰å…¶å‘é€é¡ºåºä¾æ¬¡æ‰§è¡Œ</li>
<li><strong>æ•°æ®æ›´æ–°åŸå­æ€§</strong>ï¼Œä¸€æ¬¡æ•°æ®æ›´æ–°è¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥</li>
<li>å®æ—¶æ€§ï¼Œåœ¨ä¸€å®šçš„æ—¶é—´èŒƒå›´å†…ï¼ŒClient èƒ½è¯»åˆ°æœ€æ–°æ•°æ®</li>
<li>å¿ƒè·³æ£€æµ‹ï¼Œä¼šå®šæ—¶å‘å„ä¸ªæœåŠ¡æä¾›è€…å‘é€ä¸€ä¸ªè¯·æ±‚ï¼ˆå®é™…ä¸Šå»ºç«‹çš„æ˜¯ä¸€ä¸ª Socket é•¿è¿æ¥ï¼‰</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Zookeeper-æ¡†æ¶ç»“æ„.png" alt=""></p>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1to4y1C7gw">https://www.bilibili.com/video/BV1to4y1C7gw</a></p>
<hr>
<h3 id="åº”ç”¨åœºæ™¯-1"><a href="#åº”ç”¨åœºæ™¯-1" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h3><p>Zookeeper æä¾›çš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼šç»Ÿä¸€å‘½åæœåŠ¡ã€ç»Ÿä¸€é…ç½®ç®¡ç†ã€ç»Ÿä¸€é›†ç¾¤ç®¡ç†ã€æœåŠ¡å™¨èŠ‚ç‚¹åŠ¨æ€ä¸Šä¸‹çº¿ã€è½¯è´Ÿè½½å‡è¡¡ã€åˆ†å¸ƒå¼é”ç­‰</p>
<ul>
<li><p>åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œç»å¸¸å¯¹åº”ç”¨/æœåŠ¡è¿›è¡Œç»Ÿä¸€å‘½åï¼Œä¾¿äºè¯†åˆ«ï¼Œä¾‹å¦‚åŸŸåç›¸å¯¹äº IP åœ°å€æ›´å®¹æ˜“è¢«æ¥æ”¶</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/service/www.baidu.com 		<span class="comment"># èŠ‚ç‚¹è·¯å¾„</span></span><br><span class="line">192.168.1.1  192.168.1.2	<span class="comment"># èŠ‚ç‚¹å€¼</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœåœ¨èŠ‚ç‚¹ä¸­è®°å½•æ¯å°æœåŠ¡å™¨çš„è®¿é—®æ•°ï¼Œè®©è®¿é—®æ•°æœ€å°‘çš„æœåŠ¡å™¨å»å¤„ç†æœ€æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå¯ä»¥å®ç°è´Ÿè½½å‡è¡¡</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.1  10	<span class="comment"># æ¬¡æ•°</span></span><br><span class="line">192.168.1.1  15</span><br></pre></td></tr></table></figure>
</li>
<li><p>é…ç½®æ–‡ä»¶åŒæ­¥å¯ä»¥é€šè¿‡ Zookeeper å®ç°ï¼Œå°†é…ç½®ä¿¡æ¯å†™å…¥æŸä¸ª ZNodeï¼Œå…¶ä»–å®¢æˆ·ç«¯ç›‘è§†è¯¥èŠ‚ç‚¹ï¼Œå½“èŠ‚ç‚¹æ•°æ®è¢«ä¿®æ”¹ï¼Œé€šçŸ¥å„ä¸ªå®¢æˆ·ç«¯æœåŠ¡å™¨</p>
</li>
<li><p>é›†ç¾¤ç¯å¢ƒä¸­ï¼Œéœ€è¦å®æ—¶æŒæ¡æ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå¯ä»¥å°†è¿™äº›ä¿¡æ¯æ”¾å…¥ ZNodeï¼Œé€šè¿‡ç›‘æ§é€šçŸ¥çš„æœºåˆ¶å®ç°</p>
</li>
<li><p>å®ç°å®¢æˆ·ç«¯å®æ—¶è§‚å¯ŸæœåŠ¡å™¨ä¸Šä¸‹çº¿çš„å˜åŒ–ï¼Œé€šè¿‡å¿ƒè·³æ£€æµ‹å®ç°</p>
</li>
</ul>
<hr>
<h2 id="åŸºæœ¬æ“ä½œ"><a href="#åŸºæœ¬æ“ä½œ" class="headerlink" title="åŸºæœ¬æ“ä½œ"></a>åŸºæœ¬æ“ä½œ</h2><h3 id="å®‰è£…æ­å»º"><a href="#å®‰è£…æ­å»º" class="headerlink" title="å®‰è£…æ­å»º"></a>å®‰è£…æ­å»º</h3><p>å®‰è£…æ­¥éª¤ï¼š</p>
<ul>
<li><p>å®‰è£… JDK</p>
</li>
<li><p>æ‹·è´ apache-zookeeper-3.5.7-bin.tar.gz å®‰è£…åŒ…åˆ° Linux ç³»ç»Ÿä¸‹ï¼Œå¹¶è§£å‹åˆ°æŒ‡å®šç›®å½•</p>
</li>
<li><p>conf ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶é‡å‘½åï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> zoo_sample.cfg zoo.cfg</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim zoo.cfg</span><br><span class="line"><span class="comment"># ä¿®æ”¹å†…å®¹</span></span><br><span class="line">dataDir=/home/seazean/SoftWare/zookeeper-3.5.7/zkData </span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨å¯¹åº”ç›®å½•åˆ›å»º zkData æ–‡ä»¶å¤¹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> zkData</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Zookeeper ä¸­çš„é…ç½®æ–‡ä»¶ zoo.cfg ä¸­å‚æ•°å«ä¹‰è§£è¯»ï¼š </p>
<ul>
<li>tickTime = 2000ï¼šé€šä¿¡å¿ƒè·³æ—¶é—´ï¼Œ<strong>Zookeeper æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯å¿ƒè·³</strong>æ—¶é—´ï¼Œå•ä½æ¯«ç§’</li>
<li>initLimit = 10ï¼šLeader ä¸ Follower åˆå§‹é€šä¿¡æ—¶é™ï¼Œåˆå§‹è¿æ¥æ—¶èƒ½å®¹å¿çš„æœ€å¤šå¿ƒè·³æ¬¡æ•°</li>
<li>syncLimit = 5ï¼šLeader ä¸ Follower åŒæ­¥é€šä¿¡æ—¶é™ï¼ŒLF é€šä¿¡æ—¶é—´è¶…è¿‡ <code>syncLimit * tickTime</code>ï¼ŒLeader è®¤ä¸º Follwer ä¸‹çº¿</li>
<li>dataDirï¼šä¿å­˜ Zookeeper ä¸­çš„æ•°æ®ç›®å½•ï¼Œé»˜è®¤æ˜¯ tmpç›®å½•ï¼Œå®¹æ˜“è¢« Linux ç³»ç»Ÿå®šæœŸåˆ é™¤ï¼Œæ‰€ä»¥å»ºè®®ä¿®æ”¹</li>
<li>clientPort = 2181ï¼šå®¢æˆ·ç«¯è¿æ¥ç«¯å£ï¼Œé€šå¸¸ä¸åšä¿®æ”¹</li>
</ul>
<hr>
<h3 id="æ“ä½œå‘½ä»¤"><a href="#æ“ä½œå‘½ä»¤" class="headerlink" title="æ“ä½œå‘½ä»¤"></a>æ“ä½œå‘½ä»¤</h3><h4 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h4><p>Linux å‘½ä»¤ï¼š</p>
<ul>
<li><p>å¯åŠ¨ ZooKeeper æœåŠ¡ï¼š<code>./zkServer.sh start</code></p>
</li>
<li><p>æŸ¥çœ‹ ZooKeeper æœåŠ¡ï¼š<code>./zkServer.sh status</code></p>
</li>
<li><p>åœæ­¢ ZooKeeper æœåŠ¡ï¼š<code>./zkServer.sh stop</code></p>
</li>
<li><p>é‡å¯ ZooKeeper æœåŠ¡ï¼š<code>./zkServer.sh restart</code></p>
</li>
<li><p>æŸ¥çœ‹è¿›ç¨‹æ˜¯å¦å¯åŠ¨ï¼š<code>jps</code></p>
</li>
</ul>
<hr>
<h4 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h4><p>Linux å‘½ä»¤ï¼š</p>
<ul>
<li><p>è¿æ¥ ZooKeeper æœåŠ¡ç«¯ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./zkCli.sh					<span class="comment"># ç›´æ¥å¯åŠ¨</span></span><br><span class="line">./zkCli.sh â€“server ip:port	<span class="comment"># æŒ‡å®š host å¯åŠ¨</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å®¢æˆ·ç«¯å‘½ä»¤ï¼š</p>
<ul>
<li><p>åŸºç¡€æ“ä½œï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">quit						<span class="comment"># åœæ­¢è¿æ¥</span></span><br><span class="line"><span class="built_in">help</span>						<span class="comment"># æŸ¥çœ‹å‘½ä»¤å¸®åŠ©</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»ºå‘½ä»¤ï¼š<strong><code>/</code> ä»£è¡¨æ ¹ç›®å½•</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create /path value			<span class="comment"># åˆ›å»ºèŠ‚ç‚¹ï¼Œvalue å¯é€‰</span></span><br><span class="line">create -e /path value		<span class="comment"># åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹</span></span><br><span class="line">create -s /path value		<span class="comment"># åˆ›å»ºé¡ºåºèŠ‚ç‚¹</span></span><br><span class="line">create -es /path value  	<span class="comment"># åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Œæ¯”å¦‚node10000012 åˆ é™¤12åä¹Ÿä¼šç»§ç»­ä»13å¼€å§‹ï¼Œåªä¼šå¢åŠ </span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æŸ¥è¯¢å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /path					<span class="comment"># æ˜¾ç¤ºæŒ‡å®šç›®å½•ä¸‹å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="built_in">ls</span> â€“s /path					<span class="comment"># æŸ¥è¯¢èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line"><span class="built_in">ls</span> â€“w /path					<span class="comment"># ç›‘å¬å­èŠ‚ç‚¹æ•°é‡çš„å˜åŒ–</span></span><br><span class="line"><span class="built_in">stat</span> /path					<span class="comment"># æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€</span></span><br><span class="line">get â€“s /path				<span class="comment"># æŸ¥è¯¢èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">get â€“w /path				<span class="comment"># ç›‘å¬èŠ‚ç‚¹æ•°æ®çš„å˜åŒ–</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å±æ€§ï¼Œåˆ†ä¸ºå½“å‰èŠ‚ç‚¹çš„å±æ€§å’Œå­èŠ‚ç‚¹å±æ€§</span></span><br><span class="line">czxid: èŠ‚ç‚¹è¢«åˆ›å»ºçš„äº‹åŠ¡ID, æ˜¯ZooKeeperä¸­æ‰€æœ‰ä¿®æ”¹æ€»çš„æ¬¡åºï¼Œæ¯æ¬¡ä¿®æ”¹éƒ½æœ‰å”¯ä¸€çš„ zxidï¼Œè°å°è°å…ˆå‘ç”Ÿ</span><br><span class="line">ctime: è¢«åˆ›å»ºçš„æ—¶é—´æˆ³</span><br><span class="line">mzxid: æœ€åä¸€æ¬¡è¢«æ›´æ–°çš„äº‹åŠ¡ID </span><br><span class="line">mtime: æœ€åä¿®æ”¹çš„æ—¶é—´æˆ³</span><br><span class="line">pzxid: å­èŠ‚ç‚¹åˆ—è¡¨æœ€åä¸€æ¬¡è¢«æ›´æ–°çš„äº‹åŠ¡ID</span><br><span class="line">cversion: å­èŠ‚ç‚¹çš„å˜åŒ–å·ï¼Œä¿®æ”¹æ¬¡æ•°</span><br><span class="line">dataversion: èŠ‚ç‚¹çš„æ•°æ®å˜åŒ–å·ï¼Œæ•°æ®çš„å˜åŒ–æ¬¡æ•°</span><br><span class="line">aclversion: èŠ‚ç‚¹çš„è®¿é—®æ§åˆ¶åˆ—è¡¨å˜åŒ–å·</span><br><span class="line">ephemeralOwner: ç”¨äºä¸´æ—¶èŠ‚ç‚¹ï¼Œä»£è¡¨èŠ‚ç‚¹æ‹¥æœ‰è€…çš„ session <span class="built_in">id</span>ï¼Œå¦‚æœä¸ºæŒä¹…èŠ‚ç‚¹åˆ™ä¸º0 </span><br><span class="line">dataLength: èŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®çš„é•¿åº¦ </span><br><span class="line">numChildren: å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ•°é‡</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ é™¤å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">delete /path				<span class="comment"># åˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line">deleteall /path				<span class="comment"># é€’å½’åˆ é™¤èŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><p>ZooKeeper æ˜¯ä¸€ä¸ªæ ‘å½¢ç›®å½•æœåŠ¡ï¼Œç±»ä¼¼ Unix çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½è¢«ç§°ä¸º ZNodeï¼Œæ¯ä¸ª ZNode é»˜è®¤å­˜å‚¨ 1MB çš„æ•°æ®ï¼ŒèŠ‚ç‚¹ä¸Šä¼šä¿å­˜æ•°æ®å’ŒèŠ‚ç‚¹ä¿¡æ¯ï¼Œæ¯ä¸ª ZNode éƒ½å¯ä»¥é€šè¿‡å…¶è·¯å¾„å”¯ä¸€æ ‡è¯†</p>
<p>èŠ‚ç‚¹å¯ä»¥åˆ†ä¸ºå››å¤§ç±»ï¼š</p>
<ul>
<li>PERSISTENTï¼šæŒä¹…åŒ–èŠ‚ç‚¹ </li>
<li>EPHEMERALï¼šä¸´æ—¶èŠ‚ç‚¹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯<strong>æ–­å¼€è¿æ¥</strong>åï¼Œåˆ›å»ºçš„èŠ‚ç‚¹åˆ é™¤</li>
<li>PERSISTENT_SEQUENTIALï¼šæŒä¹…åŒ–é¡ºåºèŠ‚ç‚¹ï¼Œåˆ›å»º znode æ—¶è®¾ç½®é¡ºåºæ ‡è¯†ï¼ŒèŠ‚ç‚¹åç§°åä¼šé™„åŠ ä¸€ä¸ªå€¼ï¼Œ<strong>é¡ºåºå·æ˜¯ä¸€ä¸ªå•è°ƒé€’å¢çš„è®¡æ•°å™¨</strong>ï¼Œç”±çˆ¶èŠ‚ç‚¹ç»´æŠ¤</li>
<li>EPHEMERAL_SEQUENTIALï¼šä¸´æ—¶é¡ºåºèŠ‚ç‚¹</li>
</ul>
<p>æ³¨æ„ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œé¡ºåºå·å¯ä»¥è¢«ç”¨äºä¸ºæ‰€æœ‰çš„äº‹ä»¶è¿›è¡Œå…¨å±€æ’åºï¼Œè¿™æ ·å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡é¡ºåºå·æ¨æ–­äº‹ä»¶çš„é¡ºåº</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Zookeeper-èŠ‚ç‚¹æ ‘å½¢ç»“æ„.png" alt=""></p>
<hr>
<h3 id="ä»£ç å®ç°-5"><a href="#ä»£ç å®ç°-5" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>æ·»åŠ  Maven ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>å®ç°ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// å‚æ•°ä¸€ï¼šè¿æ¥åœ°å€</span></span><br><span class="line">    <span class="comment">// å‚æ•°äºŒï¼šä¼šè¯è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="comment">// å‚æ•°ä¸‰ï¼šç›‘å¬å™¨</span></span><br><span class="line">    <span class="type">ZooKeeper</span> <span class="variable">zkClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(<span class="string">&quot;192.168.3.128:2181&quot;</span>, <span class="number">20000</span>, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent event)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç›‘å¬å¤„ç†å‡½æ•°&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="é›†ç¾¤ä»‹ç»"><a href="#é›†ç¾¤ä»‹ç»" class="headerlink" title="é›†ç¾¤ä»‹ç»"></a>é›†ç¾¤ä»‹ç»</h2><h3 id="ç›¸å…³æ¦‚å¿µ-1"><a href="#ç›¸å…³æ¦‚å¿µ-1" class="headerlink" title="ç›¸å…³æ¦‚å¿µ"></a>ç›¸å…³æ¦‚å¿µ</h3><p>Zookeepe é›†ç¾¤ä¸‰ä¸ªè§’è‰²ï¼š</p>
<ul>
<li><p>Leader é¢†å¯¼è€…ï¼šå¤„ç†å®¢æˆ·ç«¯<strong>äº‹åŠ¡è¯·æ±‚</strong>ï¼Œè´Ÿè´£é›†ç¾¤å†…éƒ¨å„æœåŠ¡å™¨çš„è°ƒåº¦</p>
</li>
<li><p>Follower è·Ÿéšè€…ï¼šå¤„ç†å®¢æˆ·ç«¯éäº‹åŠ¡è¯·æ±‚ï¼Œè½¬å‘äº‹åŠ¡è¯·æ±‚ç»™ Leader æœåŠ¡å™¨ï¼Œå‚ä¸ Leader é€‰ä¸¾æŠ•ç¥¨</p>
</li>
<li><p>Observer è§‚å¯Ÿè€…ï¼šè§‚å¯Ÿé›†ç¾¤çš„æœ€æ–°çŠ¶æ€çš„å˜åŒ–ï¼Œå¹¶å°†è¿™äº›çŠ¶æ€è¿›è¡ŒåŒæ­¥ï¼›å¤„ç†éäº‹åŠ¡æ€§è¯·æ±‚ï¼Œäº‹åŠ¡æ€§è¯·æ±‚ä¼šè½¬å‘ç»™ Leader æœåŠ¡å™¨è¿›è¡Œå¤„ç†ï¼›ä¸ä¼šå‚ä¸ä»»ä½•å½¢å¼çš„æŠ•ç¥¨ã€‚åªæä¾›éäº‹åŠ¡æ€§çš„æœåŠ¡ï¼Œé€šå¸¸ç”¨äºåœ¨ä¸å½±å“é›†ç¾¤äº‹åŠ¡å¤„ç†èƒ½åŠ›çš„å‰æä¸‹ï¼Œæå‡é›†ç¾¤çš„éäº‹åŠ¡å¤„ç†èƒ½åŠ›ï¼ˆæé«˜é›†ç¾¤è¯»çš„èƒ½åŠ›ï¼Œä½†æ˜¯ä¹Ÿé™ä½äº†é›†ç¾¤é€‰ä¸»çš„å¤æ‚ç¨‹åº¦ï¼‰</p>
</li>
</ul>
<p>ç›¸å…³å±æ€§ï¼š</p>
<ul>
<li>SIDï¼šæœåŠ¡å™¨ IDï¼Œç”¨æ¥å”¯ä¸€æ ‡è¯†ä¸€å°é›†ç¾¤ä¸­çš„æœºå™¨ï¼Œå’Œ myid ä¸€è‡´</li>
<li><p>ZXIDï¼šäº‹åŠ¡ IDï¼Œç”¨æ¥æ ‡è¯†ä¸€æ¬¡æœåŠ¡å™¨çŠ¶æ€çš„å˜æ›´ï¼Œåœ¨æŸä¸€æ—¶åˆ»é›†ç¾¤ä¸­æ¯å°æœºå™¨çš„ ZXID å€¼ä¸ä¸€å®šå®Œå…¨ä¸€è‡´ï¼Œè¿™å’Œ ZooKeeper æœåŠ¡å™¨å¯¹äºå®¢æˆ·ç«¯æ›´æ–°è¯·æ±‚çš„å¤„ç†é€»è¾‘æœ‰å…³</p>
</li>
<li><p>Epochï¼šæ¯ä¸ª Leader ä»»æœŸçš„ä»£å·ï¼ŒåŒä¸€è½®é€‰ä¸¾æŠ•ç¥¨è¿‡ç¨‹ä¸­çš„è¯¥å€¼æ˜¯ç›¸åŒçš„ï¼ŒæŠ•å®Œä¸€æ¬¡ç¥¨å°±å¢åŠ </p>
</li>
</ul>
<p>é€‰ä¸¾æœºåˆ¶ï¼šåŠæ•°æœºåˆ¶ï¼Œè¶…è¿‡åŠæ•°çš„æŠ•ç¥¨å°±é€šè¿‡</p>
<ul>
<li><p>ç¬¬ä¸€æ¬¡å¯åŠ¨é€‰ä¸¾è§„åˆ™ï¼šæŠ•ç¥¨è¿‡åŠæ•°æ—¶ï¼ŒæœåŠ¡å™¨ ID å¤§çš„èƒœå‡º</p>
</li>
<li><p>ç¬¬äºŒæ¬¡å¯åŠ¨é€‰ä¸¾è§„åˆ™ï¼š</p>
<ul>
<li>EPOCH å¤§çš„ç›´æ¥èƒœå‡º</li>
<li>EPOCH ç›¸åŒï¼Œäº‹åŠ¡ ID å¤§çš„èƒœå‡ºï¼ˆäº‹åŠ¡ ID è¶Šå¤§ï¼Œæ•°æ®è¶Šæ–°ï¼‰</li>
<li>äº‹åŠ¡ ID ç›¸åŒï¼ŒæœåŠ¡å™¨ ID å¤§çš„èƒœå‡º</li>
</ul>
</li>
</ul>
<hr>
<h3 id="åˆæ¬¡é€‰ä¸¾"><a href="#åˆæ¬¡é€‰ä¸¾" class="headerlink" title="åˆæ¬¡é€‰ä¸¾"></a>åˆæ¬¡é€‰ä¸¾</h3><p>é€‰ä¸¾è¿‡ç¨‹ï¼š</p>
<ul>
<li>æœåŠ¡å™¨ 1 å¯åŠ¨ï¼Œå‘èµ·ä¸€æ¬¡é€‰ä¸¾ï¼ŒæœåŠ¡å™¨ 1 æŠ•è‡ªå·±ä¸€ç¥¨ï¼Œç¥¨æ•°ä¸è¶…è¿‡åŠæ•°ï¼Œé€‰ä¸¾æ— æ³•å®Œæˆï¼ŒæœåŠ¡å™¨ 1 çŠ¶æ€ä¿æŒä¸º LOOKING</li>
<li>æœåŠ¡å™¨ 2 å¯åŠ¨ï¼Œå†å‘èµ·ä¸€æ¬¡é€‰ä¸¾ï¼ŒæœåŠ¡å™¨ 1 å’Œ 2 åˆ†åˆ«æŠ•è‡ªå·±ä¸€ç¥¨å¹¶<strong>äº¤æ¢é€‰ç¥¨ä¿¡æ¯</strong>ï¼Œæ­¤æ—¶æœåŠ¡å™¨ 1 ä¼šå‘ç°æœåŠ¡å™¨ 2 çš„ SID æ¯”è‡ªå·±æŠ•ç¥¨æ¨ä¸¾çš„ï¼ˆæœåŠ¡å™¨ 1ï¼‰å¤§ï¼Œæ›´æ”¹é€‰ç¥¨ä¸ºæ¨ä¸¾æœåŠ¡å™¨ 2ã€‚æŠ•ç¥¨ç»“æœä¸ºæœåŠ¡å™¨ 1 ç¥¨æ•° 0 ç¥¨ï¼ŒæœåŠ¡å™¨ 2 ç¥¨æ•° 2 ç¥¨ï¼Œç¥¨æ•°ä¸è¶…è¿‡åŠæ•°ï¼Œé€‰ä¸¾æ— æ³•å®Œæˆï¼ŒæœåŠ¡å™¨ 1ã€2 çŠ¶æ€ä¿æŒ LOOKING</li>
<li>æœåŠ¡å™¨ 3 å¯åŠ¨ï¼Œå‘èµ·ä¸€æ¬¡é€‰ä¸¾ï¼Œæ­¤æ—¶æœåŠ¡å™¨ 1 å’Œ 2 éƒ½ä¼šæ›´æ”¹é€‰ç¥¨ä¸ºæœåŠ¡å™¨ 3ï¼ŒæŠ•ç¥¨ç»“æœä¸ºæœåŠ¡å™¨ 3 ç¥¨æ•° 3 ç¥¨ï¼Œæ­¤æ—¶æœåŠ¡å™¨ 3 çš„ç¥¨æ•°å·²ç»è¶…è¿‡åŠæ•°ï¼ŒæœåŠ¡å™¨ 3 å½“é€‰ Leaderï¼ŒæœåŠ¡å™¨ 1ã€2 æ›´æ”¹çŠ¶æ€ä¸º FOLLOWINGï¼ŒæœåŠ¡å™¨ 3 æ›´æ”¹çŠ¶æ€ä¸º LEADING</li>
<li>æœåŠ¡å™¨ 4 å¯åŠ¨ï¼Œå‘èµ·ä¸€æ¬¡é€‰ä¸¾ï¼Œæ­¤æ—¶æœåŠ¡å™¨ 1ã€2ã€3 å·²ç»ä¸æ˜¯ LOOKING çŠ¶æ€ï¼Œä¸ä¼šæ›´æ”¹é€‰ç¥¨ä¿¡æ¯ï¼Œäº¤æ¢é€‰ç¥¨ä¿¡æ¯ç»“æœåæœåŠ¡å™¨ 3 ä¸º 3 ç¥¨ï¼ŒæœåŠ¡å™¨ 4 ä¸º 1 ç¥¨ï¼Œæ­¤æ—¶æœåŠ¡å™¨ 4 æ›´æ”¹é€‰ç¥¨ä¿¡æ¯ä¸ºæœåŠ¡å™¨ 3ï¼Œå¹¶æ›´æ”¹çŠ¶æ€ä¸º FOLLOWING</li>
<li>æœåŠ¡å™¨ 5 å¯åŠ¨ï¼ŒåŒ 4 ä¸€æ ·</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Zookeeper-åˆæ¬¡é€‰ä¸¾æœºåˆ¶.png" alt=""></p>
<hr>
<h3 id="å†æ¬¡é€‰ä¸¾"><a href="#å†æ¬¡é€‰ä¸¾" class="headerlink" title="å†æ¬¡é€‰ä¸¾"></a>å†æ¬¡é€‰ä¸¾</h3><p>ZooKeeper é›†ç¾¤ä¸­çš„ä¸€å°æœåŠ¡å™¨å‡ºç°ä»¥ä¸‹æƒ…å†µä¹‹ä¸€æ—¶ï¼Œå°±ä¼šå¼€å§‹è¿›å…¥ Leader é€‰ä¸¾ï¼š</p>
<ul>
<li>æœåŠ¡å™¨åˆå§‹åŒ–å¯åŠ¨</li>
<li>æœåŠ¡å™¨è¿è¡ŒæœŸé—´æ— æ³•å’Œ Leader ä¿æŒè¿æ¥</li>
</ul>
<p>å½“ä¸€å°æœåŠ¡å™¨è¿›å…¥ Leader é€‰ä¸¾æµç¨‹æ—¶ï¼Œå½“å‰é›†ç¾¤å¯èƒ½ä¼šå¤„äºä»¥ä¸‹ä¸¤ç§çŠ¶æ€ï¼š</p>
<ul>
<li><p>é›†ç¾¤ä¸­æœ¬æ¥å°±å·²ç»å­˜åœ¨ä¸€ä¸ª Leaderï¼ŒæœåŠ¡å™¨è¯•å›¾å»é€‰ä¸¾ Leader æ—¶ä¼šè¢«å‘ŠçŸ¥å½“å‰æœåŠ¡å™¨çš„ Leader ä¿¡æ¯ï¼Œå¯¹äºè¯¥æœåŠ¡å™¨æ¥è¯´ï¼Œåªéœ€è¦å’Œ Leader æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œå¹¶è¿›è¡ŒçŠ¶æ€åŒæ­¥å³å¯</p>
</li>
<li><p>é›†ç¾¤ä¸­ç¡®å®ä¸å­˜åœ¨ Leaderï¼Œå‡è®¾æœåŠ¡å™¨ 3 å’Œ 5 å‡ºç°æ•…éšœï¼Œå¼€å§‹è¿›è¡Œ Leader é€‰ä¸¾ï¼ŒSID ä¸º 1ã€2ã€4 çš„æœºå™¨æŠ•ç¥¨æƒ…å†µ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(EPOCHï¼ŒZXIDï¼ŒSID): (1, 8, 1), (1, 8, 2), (1, 7, 4)</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®é€‰ä¸¾è§„åˆ™ï¼ŒæœåŠ¡å™¨ 2 èƒœå‡º</p>
</li>
</ul>
<hr>
<h3 id="æ•°æ®å†™å…¥"><a href="#æ•°æ®å†™å…¥" class="headerlink" title="æ•°æ®å†™å…¥"></a>æ•°æ®å†™å…¥</h3><p>å†™æ“ä½œå°±æ˜¯äº‹åŠ¡è¯·æ±‚ï¼Œå†™å…¥è¯·æ±‚ç›´æ¥å‘é€ç»™ Leader èŠ‚ç‚¹ï¼šLeader ä¼šå…ˆå°†æ•°æ®å†™å…¥è‡ªèº«ï¼ŒåŒæ—¶é€šçŸ¥å…¶ä»– Follower å†™å…¥ï¼Œ<strong>å½“é›†ç¾¤ä¸­æœ‰åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹å†™å…¥å®Œæˆ</strong>ï¼ŒLeader èŠ‚ç‚¹å°±ä¼šå“åº”å®¢æˆ·ç«¯æ•°æ®å†™å…¥å®Œæˆ</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Zookeeper-å†™å…¥è¯·æ±‚Leader.png" style="zoom: 50%;" /></p>
<p>å†™å…¥è¯·æ±‚ç›´æ¥å‘é€ç»™ Follower èŠ‚ç‚¹ï¼šFollower æ²¡æœ‰å†™å…¥æƒé™ï¼Œä¼šå°†å†™è¯·æ±‚è½¬å‘ç»™ Leaderï¼ŒLeader å°†æ•°æ®å†™å…¥è‡ªèº«ï¼Œé€šçŸ¥å…¶ä»– Follower å†™å…¥ï¼Œå½“é›†ç¾¤ä¸­æœ‰åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹å†™å…¥å®Œæˆï¼ŒLeader ä¼šé€šçŸ¥ Follower å†™å…¥å®Œæˆï¼Œ<strong>ç”± Follower å“åº”å®¢æˆ·ç«¯æ•°æ®å†™å…¥å®Œæˆ</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Zookeeper-å†™å…¥è¯·æ±‚Follower.png" style="zoom:50%;" /></p>
<hr>
<h2 id="åº•å±‚åè®®"><a href="#åº•å±‚åè®®" class="headerlink" title="åº•å±‚åè®®"></a>åº•å±‚åè®®</h2><h3 id="Paxos"><a href="#Paxos" class="headerlink" title="Paxos"></a>Paxos</h3><p>Paxos ç®—æ³•ï¼šåŸºäºæ¶ˆæ¯ä¼ é€’ä¸”å…·æœ‰é«˜åº¦å®¹é”™ç‰¹æ€§çš„ä¸€è‡´æ€§ç®—æ³•</p>
<p>ä¼˜ç‚¹ï¼šå¿«é€Ÿæ­£ç¡®çš„åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¯¹æŸä¸ªæ•°æ®å€¼è¾¾æˆä¸€è‡´ï¼Œå¹¶ä¸”ä¿è¯ä¸è®ºå‘ç”Ÿä»»ä½•å¼‚å¸¸ï¼Œéƒ½ä¸ä¼šç ´åæ•´ä¸ªç³»ç»Ÿçš„ä¸€è‡´æ€§</p>
<p>ç¼ºé™·ï¼šåœ¨ç½‘ç»œå¤æ‚çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½å¾ˆä¹…æ— æ³•æ”¶æ•›ï¼Œç”šè‡³é™·å…¥æ´»é”çš„æƒ…å†µ</p>
<hr>
<h3 id="ZAB"><a href="#ZAB" class="headerlink" title="ZAB"></a>ZAB</h3><h4 id="ç®—æ³•ä»‹ç»"><a href="#ç®—æ³•ä»‹ç»" class="headerlink" title="ç®—æ³•ä»‹ç»"></a>ç®—æ³•ä»‹ç»</h4><p>ZAB åè®®å€Ÿé‰´äº† Paxos ç®—æ³•ï¼Œæ˜¯ä¸º Zookeeper è®¾è®¡çš„æ”¯æŒå´©æºƒæ¢å¤çš„åŸå­å¹¿æ’­åè®®ï¼ŒåŸºäºè¯¥åè®® Zookeeper è®¾è®¡ä¸ºåªæœ‰ä¸€å°å®¢æˆ·ç«¯ï¼ˆLeaderï¼‰è´Ÿè´£å¤„ç†å¤–éƒ¨çš„å†™äº‹åŠ¡è¯·æ±‚ï¼Œç„¶å Leader å°†æ•°æ®åŒæ­¥åˆ°å…¶ä»– Follower èŠ‚ç‚¹</p>
<p>Zab åè®®åŒ…æ‹¬ä¸¤ç§åŸºæœ¬çš„æ¨¡å¼ï¼šæ¶ˆæ¯å¹¿æ’­ã€å´©æºƒæ¢å¤</p>
<hr>
<h4 id="æ¶ˆæ¯å¹¿æ’­"><a href="#æ¶ˆæ¯å¹¿æ’­" class="headerlink" title="æ¶ˆæ¯å¹¿æ’­"></a>æ¶ˆæ¯å¹¿æ’­</h4><p>ZAB åè®®é’ˆå¯¹äº‹åŠ¡è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹ç±»ä¼¼äºä¸€ä¸ª<strong>ä¸¤é˜¶æ®µæäº¤</strong>è¿‡ç¨‹ï¼šå¹¿æ’­äº‹åŠ¡é˜¶æ®µã€å¹¿æ’­æäº¤æ“ä½œ</p>
<ul>
<li>å®¢æˆ·ç«¯å‘èµ·å†™æ“ä½œè¯·æ±‚ï¼ŒLeader æœåŠ¡å™¨å°†è¯·æ±‚è½¬åŒ–ä¸ºäº‹åŠ¡ Proposal ææ¡ˆï¼ŒåŒæ—¶ä¸º Proposal åˆ†é…ä¸€ä¸ªå…¨å±€çš„ IDï¼Œå³ ZXID</li>
<li>Leader æœåŠ¡å™¨ä¸ºæ¯ä¸ª Follower åˆ†é…ä¸€ä¸ªå•ç‹¬çš„é˜Ÿåˆ—ï¼Œå°†å¹¿æ’­çš„ Proposal <strong>ä¾æ¬¡æ”¾åˆ°é˜Ÿåˆ—</strong>ä¸­å»ï¼Œæ ¹æ® FIFO ç­–ç•¥è¿›è¡Œæ¶ˆæ¯å‘é€</li>
<li>Follower æ¥æ”¶åˆ° Proposal åï¼Œå°†å…¶ä»¥äº‹åŠ¡æ—¥å¿—çš„æ–¹å¼å†™å…¥æœ¬åœ°ç£ç›˜ä¸­ï¼Œå†™å…¥æˆåŠŸåå‘ Leader åé¦ˆä¸€ä¸ª ACK å“åº”æ¶ˆæ¯</li>
<li>Leader æ¥æ”¶åˆ°è¶…è¿‡åŠæ•°ä»¥ä¸Š Follower çš„ ACK å“åº”æ¶ˆæ¯åï¼Œå³è®¤ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸï¼Œå¯ä»¥å‘é€ Commit æ¶ˆæ¯</li>
<li>Leader å‘æ‰€æœ‰ Follower å¹¿æ’­ commit æ¶ˆæ¯ï¼ŒåŒæ—¶è‡ªèº«ä¹Ÿä¼šå®Œæˆäº‹åŠ¡æäº¤ï¼ŒFollower æ¥æ”¶åˆ° Commit åï¼Œå°†ä¸Šä¸€æ¡äº‹åŠ¡æäº¤</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Zookeeper-æ¶ˆæ¯å¹¿æ’­.png" style="zoom:67%;" /></p>
<p>ä¸¤é˜¶æ®µæäº¤æ¨¡å‹å¯èƒ½å› ä¸º Leader å®•æœºå¸¦æ¥æ•°æ®ä¸ä¸€è‡´ï¼š</p>
<ul>
<li>Leader å‘èµ·ä¸€ä¸ªäº‹åŠ¡ Proposal åå°±å®•æœºï¼ŒFollower éƒ½æ²¡æœ‰ Proposal</li>
<li>Leader æ”¶åˆ°åŠæ•° ACK å®•æœºï¼Œæ²¡æ¥å¾—åŠå‘ Follower å‘é€ Commit</li>
</ul>
<hr>
<h4 id="å´©æºƒæ¢å¤"><a href="#å´©æºƒæ¢å¤" class="headerlink" title="å´©æºƒæ¢å¤"></a>å´©æºƒæ¢å¤</h4><p>Leader æœåŠ¡å™¨å‡ºç°å´©æºƒæˆ–è€…ç”±äºç½‘ç»œåŸå› å¯¼è‡´ Leader æœåŠ¡å™¨å¤±å»äº†ä¸<strong>è¿‡åŠ Followerçš„è”ç³»</strong>ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥å´©æºƒæ¢å¤æ¨¡å¼ï¼Œå´©æºƒæ¢å¤ä¸»è¦åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šLeader é€‰ä¸¾å’Œæ•°æ®æ¢å¤</p>
<p>Zab åè®®å´©æºƒæ¢å¤è¦æ±‚æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªè¦æ±‚ï¼š</p>
<ul>
<li>å·²ç»è¢« Leader æäº¤çš„ææ¡ˆ Proposalï¼Œå¿…é¡»æœ€ç»ˆè¢«æ‰€æœ‰çš„ Follower æœåŠ¡å™¨æ­£ç¡®æäº¤</li>
<li>ä¸¢å¼ƒå·²ç»è¢« Leader æå‡ºçš„ï¼Œä½†æ˜¯æ²¡æœ‰è¢«æäº¤çš„ Proposal</li>
</ul>
<p>Zab åè®®éœ€è¦ä¿è¯é€‰ä¸¾å‡ºæ¥çš„ Leader éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>
<ul>
<li>æ–°é€‰ä¸¾çš„ Leader ä¸èƒ½åŒ…å«æœªæäº¤çš„ Proposalï¼Œå³æ–° Leader å¿…é¡»éƒ½æ˜¯å·²ç»æäº¤äº† Proposal çš„ Follower èŠ‚ç‚¹</li>
<li>æ–°é€‰ä¸¾çš„ Leader èŠ‚ç‚¹å«æœ‰<strong>æœ€å¤§çš„ ZXID</strong>ï¼Œå¯ä»¥é¿å… Leader æœåŠ¡å™¨æ£€æŸ¥ Proposal çš„æäº¤å’Œä¸¢å¼ƒå·¥ä½œ</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Zookeeper-Leaderé€‰ä¸¾.png" style="zoom: 67%;" /></p>
<p>æ•°æ®æ¢å¤é˜¶æ®µï¼š</p>
<ul>
<li>å®Œæˆ Leader é€‰ä¸¾åï¼Œåœ¨æ­£å¼å¼€å§‹å·¥ä½œä¹‹å‰ï¼ˆæ¥æ”¶äº‹åŠ¡è¯·æ±‚æå‡ºæ–°çš„ Proposalï¼‰ï¼ŒLeader æœåŠ¡å™¨ä¼šé¦–å…ˆç¡®è®¤äº‹åŠ¡æ—¥å¿—ä¸­çš„æ‰€æœ‰ Proposal æ˜¯å¦å·²ç»è¢«é›†ç¾¤ä¸­è¿‡åŠçš„æœåŠ¡å™¨ Commit</li>
<li>Leader æœåŠ¡å™¨éœ€è¦ç¡®ä¿æ‰€æœ‰çš„ Follower æœåŠ¡å™¨èƒ½å¤Ÿæ¥æ”¶åˆ°æ¯ä¸€æ¡äº‹åŠ¡çš„ Proposalï¼Œå¹¶ä¸”èƒ½å°†æ‰€æœ‰å·²ç»æäº¤çš„äº‹åŠ¡ Proposal åº”ç”¨åˆ°å†…å­˜æ•°æ®ä¸­ï¼Œæ‰€ä»¥åªæœ‰å½“ Follower å°†æ‰€æœ‰å°šæœªåŒæ­¥çš„äº‹åŠ¡ Proposal éƒ½<strong>ä» Leader æœåŠ¡å™¨ä¸ŠåŒæ­¥</strong>ï¼Œå¹¶ä¸”åº”ç”¨åˆ°å†…å­˜æ•°æ®åï¼ŒLeader æ‰ä¼šæŠŠè¯¥ Follower åŠ å…¥åˆ°çœŸæ­£å¯ç”¨çš„ Follower åˆ—è¡¨ä¸­</li>
</ul>
<hr>
<h4 id="å¼‚å¸¸å¤„ç†"><a href="#å¼‚å¸¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h4><p>Zab çš„äº‹åŠ¡ç¼–å· zxid è®¾è®¡ï¼š</p>
<ul>
<li>zxid æ˜¯ä¸€ä¸ª 64 ä½çš„æ•°å­—ï¼Œä½ 32 ä½æ˜¯ä¸€ä¸ªç®€å•çš„å•å¢è®¡æ•°å™¨ï¼Œé’ˆå¯¹å®¢æˆ·ç«¯æ¯ä¸€ä¸ªäº‹åŠ¡è¯·æ±‚ï¼ŒLeader åœ¨äº§ç”Ÿæ–°çš„ Proposal äº‹åŠ¡æ—¶ï¼Œéƒ½ä¼šå¯¹è¯¥è®¡æ•°å™¨åŠ  1ï¼Œè€Œé«˜ 32 ä½åˆ™ä»£è¡¨äº† Leader å‘¨æœŸçš„ epoch ç¼–å·</li>
<li>epoch ä¸ºå½“å‰é›†ç¾¤æ‰€å¤„çš„ä»£æˆ–è€…å‘¨æœŸï¼Œæ¯æ¬¡ Leader å˜æ›´åéƒ½ä¼šåœ¨ epoch çš„åŸºç¡€ä¸ŠåŠ  1ï¼ŒFollower åªæœä» epoch æœ€é«˜çš„ Leader å‘½ä»¤ï¼Œæ‰€ä»¥æ—§çš„ Leader å´©æºƒæ¢å¤ä¹‹åï¼Œå…¶ä»– Follower å°±ä¸ä¼šç»§ç»­è¿½éš</li>
<li>æ¯æ¬¡é€‰ä¸¾äº§ç”Ÿä¸€ä¸ªæ–°çš„ Leaderï¼Œå°±ä¼šä»æ–° Leader æœåŠ¡å™¨ä¸Šå–å‡ºæœ¬åœ°äº‹åŠ¡æ—¥å¿—ä¸­æœ€å¤§ç¼–å· Proposal çš„ zxidï¼Œä» zxid ä¸­è§£æå¾—åˆ°å¯¹åº”çš„ epoch ç¼–å·ï¼Œç„¶åå†å¯¹å…¶åŠ  1 åä½œä¸ºæ–°çš„ epoch å€¼ï¼Œå¹¶å°†ä½ 32 ä½æ•°å­—å½’é›¶ï¼Œç”± 0 å¼€å§‹é‡æ–°ç”Ÿæˆ zxid</li>
</ul>
<p>Zab åè®®é€šè¿‡ epoch ç¼–å·æ¥åŒºåˆ† Leader å˜åŒ–å‘¨æœŸï¼Œèƒ½å¤Ÿæœ‰æ•ˆé¿å…ä¸åŒçš„ Leader é”™è¯¯çš„ä½¿ç”¨äº†ç›¸åŒçš„ zxid ç¼–å·æå‡ºäº†ä¸ä¸€æ ·çš„ Proposal çš„å¼‚å¸¸æƒ…å†µ</p>
<p>Zab æ•°æ®åŒæ­¥è¿‡ç¨‹ï¼š<strong>æ•°æ®åŒæ­¥é˜¶æ®µè¦ä»¥ Leader æœåŠ¡å™¨ä¸ºå‡†</strong></p>
<ul>
<li>ä¸€ä¸ªåŒ…å«äº†ä¸Šä¸ª Leader å‘¨æœŸä¸­å°šæœªæäº¤è¿‡çš„äº‹åŠ¡ Proposal çš„æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œè¿™å°æœºå™¨åŠ å…¥é›†ç¾¤ä¸­ä¼šä»¥ Follower è§’è‰²è¿ä¸Š Leader</li>
<li>Leader ä¼šæ ¹æ®è‡ªå·±æœåŠ¡å™¨ä¸Šæœ€åæäº¤çš„ Proposal å’Œ Follower æœåŠ¡å™¨çš„ Proposal è¿›è¡Œæ¯”å¯¹ï¼Œè®© Follower è¿›è¡Œä¸€ä¸ª<strong>å›é€€æˆ–è€…å‰è¿›æ“ä½œ</strong>ï¼Œåˆ°ä¸€ä¸ªå·²ç»è¢«é›†ç¾¤ä¸­è¿‡åŠæœºå™¨ Commit çš„æœ€æ–° Proposalï¼ˆæºç è§£æéƒ¨åˆ†è¯¦è§£ï¼‰</li>
</ul>
<hr>
<h3 id="CAP"><a href="#CAP" class="headerlink" title="CAP"></a>CAP</h3><p>CAP ç†è®ºæŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒConsistencyï¼ˆä¸€è‡´æ€§ï¼‰ã€Availabilityï¼ˆå¯ç”¨æ€§ï¼‰ã€Partition Toleranceï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰ä¸èƒ½åŒæ—¶æˆç«‹ï¼ŒZooKeeper ä¿è¯çš„æ˜¯ CP</p>
<ul>
<li>ZooKeeper ä¸èƒ½ä¿è¯æ¯æ¬¡æœåŠ¡è¯·æ±‚çš„å¯ç”¨æ€§ï¼Œåœ¨æç«¯ç¯å¢ƒä¸‹å¯èƒ½ä¼šä¸¢å¼ƒä¸€äº›è¯·æ±‚ï¼Œæ¶ˆè´¹è€…ç¨‹åºéœ€è¦é‡æ–°è¯·æ±‚æ‰èƒ½è·å¾—ç»“æœ</li>
<li>è¿›è¡Œ Leader é€‰ä¸¾æ—¶<strong>é›†ç¾¤éƒ½æ˜¯ä¸å¯ç”¨</strong></li>
</ul>
<p>CAP ä¸‰ä¸ªåŸºæœ¬éœ€æ±‚ï¼Œå› ä¸º P æ˜¯å¿…é¡»çš„ï¼Œå› æ­¤åˆ†å¸ƒå¼ç³»ç»Ÿé€‰æ‹©å°±åœ¨ CP æˆ–è€… AP ä¸­ï¼š</p>
<ul>
<li>ä¸€è‡´æ€§ï¼šæŒ‡æ•°æ®åœ¨å¤šä¸ªå‰¯æœ¬ä¹‹é—´æ˜¯å¦èƒ½å¤Ÿä¿æŒæ•°æ®ä¸€è‡´çš„ç‰¹æ€§ï¼Œå½“ä¸€ä¸ªç³»ç»Ÿåœ¨æ•°æ®ä¸€è‡´çš„çŠ¶æ€ä¸‹æ‰§è¡Œæ›´æ–°æ“ä½œåï¼Œä¹Ÿèƒ½ä¿è¯ç³»ç»Ÿçš„æ•°æ®ä»ç„¶å¤„äºä¸€è‡´çš„çŠ¶æ€</li>
<li>å¯ç”¨æ€§ï¼šæŒ‡ç³»ç»Ÿæä¾›çš„æœåŠ¡å¿…é¡»ä¸€ç›´å¤„äºå¯ç”¨çš„çŠ¶æ€ï¼Œå¯¹äºç”¨æˆ·çš„æ¯ä¸€ä¸ªæ“ä½œè¯·æ±‚æ€»æ˜¯èƒ½å¤Ÿåœ¨æœ‰é™çš„æ—¶é—´å†…è¿”å›ç»“æœ</li>
<li>åˆ†åŒºå®¹é”™æ€§ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨é‡åˆ°ä»»ä½•ç½‘ç»œåˆ†åŒºæ•…éšœæ—¶ï¼Œä»ç„¶èƒ½å¤Ÿä¿è¯å¯¹å¤–æä¾›æœåŠ¡ï¼Œä¸ä¼šå®•æœºï¼Œé™¤éæ˜¯æ•´ä¸ªç½‘ç»œç¯å¢ƒéƒ½å‘ç”Ÿäº†æ•…éšœ</li>
</ul>
<hr>
<h2 id="ç›‘å¬æœºåˆ¶"><a href="#ç›‘å¬æœºåˆ¶" class="headerlink" title="ç›‘å¬æœºåˆ¶"></a>ç›‘å¬æœºåˆ¶</h2><h3 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h3><p>ZooKeeper ä¸­å¼•å…¥äº† Watcher æœºåˆ¶æ¥å®ç°äº†å‘å¸ƒ/è®¢é˜…åŠŸèƒ½ï¼Œå®¢æˆ·ç«¯æ³¨å†Œç›‘å¬ç›®å½•èŠ‚ç‚¹ï¼Œåœ¨ç‰¹å®šäº‹ä»¶è§¦å‘æ—¶ï¼ŒZooKeeper ä¼šé€šçŸ¥æ‰€æœ‰å…³æ³¨è¯¥äº‹ä»¶çš„å®¢æˆ·ç«¯ï¼Œä¿è¯ ZooKeeper ä¿å­˜çš„ä»»ä½•çš„æ•°æ®çš„ä»»ä½•æ”¹å˜éƒ½èƒ½å¿«é€Ÿçš„å“åº”åˆ°ç›‘å¬åº”ç”¨ç¨‹åº</p>
<p>ç›‘å¬å‘½ä»¤ï¼š<strong>åªèƒ½ç”Ÿæ•ˆä¸€æ¬¡</strong>ï¼Œæ¥æ”¶ä¸€æ¬¡é€šçŸ¥ï¼Œå†æ¬¡ç›‘å¬éœ€è¦é‡æ–°æ³¨å†Œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> â€“w /path					<span class="comment"># ç›‘å¬ã€å­èŠ‚ç‚¹æ•°é‡ã€‘çš„å˜åŒ–</span></span><br><span class="line">get â€“w /path				<span class="comment"># ç›‘å¬ã€èŠ‚ç‚¹æ•°æ®ã€‘çš„å˜åŒ–</span></span><br></pre></td></tr></table></figure>
<p>å·¥ä½œæµç¨‹ï¼š</p>
<ul>
<li>åœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»º Zookeeper å®¢æˆ·ç«¯ï¼Œè¿™æ—¶å°±ä¼šåˆ›å»º<strong>ä¸¤ä¸ªçº¿ç¨‹</strong>ï¼Œä¸€ä¸ªè´Ÿè´£ç½‘ç»œè¿æ¥é€šä¿¡ï¼ˆconnetï¼‰ï¼Œä¸€ä¸ªè´Ÿè´£ç›‘å¬ï¼ˆlistenerï¼‰</li>
<li>é€šè¿‡ connect çº¿ç¨‹å°†æ³¨å†Œçš„ç›‘å¬äº‹ä»¶å‘é€ç»™ Zookeeper</li>
<li>åœ¨ Zookeeper çš„æ³¨å†Œç›‘å¬å™¨åˆ—è¡¨ä¸­å°†æ³¨å†Œçš„<strong>ç›‘å¬äº‹ä»¶æ·»åŠ åˆ°åˆ—è¡¨</strong>ä¸­</li>
<li>Zookeeper ç›‘å¬åˆ°æœ‰æ•°æ®æˆ–è·¯å¾„å˜åŒ–ï¼Œå°†æ¶ˆæ¯å‘é€ç»™ listener çº¿ç¨‹</li>
<li>listener çº¿ç¨‹å†…éƒ¨è°ƒç”¨ process() æ–¹æ³•</li>
</ul>
<p>Curator æ¡†æ¶å¼•å…¥äº† Cache æ¥å®ç°å¯¹ ZooKeeper æœåŠ¡ç«¯äº‹ä»¶çš„ç›‘å¬ï¼Œä¸‰ç§ Watcherï¼š</p>
<ul>
<li>NodeCacheï¼šåªæ˜¯ç›‘å¬æŸä¸€ä¸ªç‰¹å®šçš„èŠ‚ç‚¹</li>
<li>PathChildrenCacheï¼šç›‘æ§ä¸€ä¸ª ZNode çš„å­èŠ‚ç‚¹</li>
<li>TreeCacheï¼šå¯ä»¥ç›‘æ§æ•´ä¸ªæ ‘ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œç±»ä¼¼äº PathChildrenCache å’Œ NodeCache çš„ç»„åˆ</li>
</ul>
<hr>
<h3 id="ç›‘å¬æ¡ˆä¾‹"><a href="#ç›‘å¬æ¡ˆä¾‹" class="headerlink" title="ç›‘å¬æ¡ˆä¾‹"></a>ç›‘å¬æ¡ˆä¾‹</h3><h4 id="æ•´ä½“æ¶æ„"><a href="#æ•´ä½“æ¶æ„" class="headerlink" title="æ•´ä½“æ¶æ„"></a>æ•´ä½“æ¶æ„</h4><p>å®¢æˆ·ç«¯å®æ—¶ç›‘å¬æœåŠ¡å™¨åŠ¨æ€ä¸Šä¸‹çº¿</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Zookeeper-ç›‘å¬æœåŠ¡å™¨çŠ¶æ€.png" style="zoom:50%;" /></p>
<hr>
<h4 id="ä»£ç å®ç°-6"><a href="#ä»£ç å®ç°-6" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h4><p>å®¢æˆ·ç«¯ï¼šå…ˆå¯åŠ¨å®¢æˆ·ç«¯è¿›è¡Œç›‘å¬</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributeClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">connectString</span> <span class="operator">=</span> <span class="string">&quot;192.168.3.128:2181&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">sessionTimeout</span> <span class="operator">=</span> <span class="number">20000</span>;</span><br><span class="line">    <span class="keyword">private</span> ZooKeeper zk;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">DistributeClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DistributeClient</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1 è·å–zkè¿æ¥</span></span><br><span class="line">        client.getConnect();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2 ç›‘å¬/serversä¸‹é¢å­èŠ‚ç‚¹çš„å¢åŠ å’Œåˆ é™¤</span></span><br><span class="line">        client.getServerList();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3 ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">        client.business();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">business</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        Thread.sleep(Long.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getServerList</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException &#123;</span><br><span class="line">        ArrayList&lt;String&gt; servers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// è·å–æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œtrue ä»£è¡¨è§¦å‘ç›‘å¬æ“ä½œ</span></span><br><span class="line">        List&lt;String&gt; children = zk.getChildren(<span class="string">&quot;/servers&quot;</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String child : children) &#123;</span><br><span class="line">            <span class="comment">// è·å–å­èŠ‚ç‚¹çš„æ•°æ®</span></span><br><span class="line">            <span class="type">byte</span>[] data = zk.getData(<span class="string">&quot;/servers/&quot;</span> + child, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            servers.add(<span class="keyword">new</span> <span class="title class_">String</span>(data));</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(servers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getConnect</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        zk = <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(connectString, sessionTimeout, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent event)</span> &#123;</span><br><span class="line">                getServerList();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœåŠ¡ç«¯ï¼šå¯åŠ¨æ—¶éœ€è¦ Program arguments</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributeServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">connectString</span> <span class="operator">=</span> <span class="string">&quot;192.168.3.128:2181&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">sessionTimeout</span> <span class="operator">=</span> <span class="number">20000</span>;</span><br><span class="line">    <span class="keyword">private</span> ZooKeeper zk;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">DistributeServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DistributeServer</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1 è·å– zookeeper è¿æ¥</span></span><br><span class="line">        server.getConnect();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2  æ³¨å†ŒæœåŠ¡å™¨åˆ° zk é›†ç¾¤ï¼Œæ³¨æ„å‚æ•°</span></span><br><span class="line">        server.register(args[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3 å¯åŠ¨ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">        server.business();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">business</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        Thread.sleep(Long.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(String hostname)</span> <span class="keyword">throws</span> KeeperException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// OPEN_ACL_UNSAFE: ACL å¼€æ”¾</span></span><br><span class="line">        <span class="comment">// EPHEMERAL_SEQUENTIAL: ä¸´æ—¶é¡ºåºèŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">create</span> <span class="operator">=</span> zk.create(<span class="string">&quot;/servers/&quot;</span> + hostname, hostname.getBytes(),</span><br><span class="line">                                  ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class="line">        System.out.println(hostname + <span class="string">&quot; is online&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getConnect</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        zk = <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(connectString, sessionTimeout, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent event)</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="åˆ†å¸ƒå¼é”"><a href="#åˆ†å¸ƒå¼é”" class="headerlink" title="åˆ†å¸ƒå¼é”"></a>åˆ†å¸ƒå¼é”</h2><h3 id="å®ç°åŸç†-1"><a href="#å®ç°åŸç†-1" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h3><p>åˆ†å¸ƒå¼é”å¯ä»¥å®ç°åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªè¿›ç¨‹æœ‰åºçš„è®¿é—®è¯¥ä¸´ç•Œèµ„æºï¼Œå¤šä¸ªè¿›ç¨‹ä¹‹é—´ä¸ä¼šç›¸äº’å¹²æ‰°</p>
<p>æ ¸å¿ƒæ€æƒ³ï¼šå½“å®¢æˆ·ç«¯è¦è·å–é”ï¼Œåˆ™åˆ›å»ºèŠ‚ç‚¹ï¼Œä½¿ç”¨å®Œé”ï¼Œåˆ™åˆ é™¤è¯¥èŠ‚ç‚¹</p>
<ol>
<li>å®¢æˆ·ç«¯è·å–é”æ—¶ï¼Œåœ¨ /locks èŠ‚ç‚¹ä¸‹åˆ›å»º<strong>ä¸´æ—¶é¡ºåº</strong>èŠ‚ç‚¹<ul>
<li>ä½¿ç”¨ä¸´æ—¶èŠ‚ç‚¹æ˜¯ä¸ºäº†é˜²æ­¢å½“æœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯å®•æœºä»¥åèŠ‚ç‚¹æ— æ³•åˆ é™¤ï¼ˆæŒä¹…èŠ‚ç‚¹ï¼‰ï¼Œå¯¼è‡´é”æ— æ³•é‡Šæ”¾</li>
<li>ä½¿ç”¨é¡ºåºèŠ‚ç‚¹æ˜¯ä¸ºäº†ç³»ç»Ÿè‡ªåŠ¨ç¼–å·æ’åºï¼Œæ‰¾æœ€å°çš„èŠ‚ç‚¹ï¼Œé˜²æ­¢å®¢æˆ·ç«¯é¥¥é¥¿ç°è±¡ï¼Œä¿è¯å…¬å¹³</li>
</ul>
</li>
<li><p>è·å– /locks ç›®å½•çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±çš„<strong>å­èŠ‚ç‚¹åºå·æ˜¯å¦æœ€å°</strong>ï¼Œæˆç«‹åˆ™å®¢æˆ·ç«¯è·å–åˆ°é”ï¼Œä½¿ç”¨å®Œé”åå°†è¯¥èŠ‚ç‚¹åˆ é™¤</p>
</li>
<li><p>åä¹‹å®¢æˆ·ç«¯éœ€è¦æ‰¾åˆ°æ¯”è‡ªå·±å°çš„èŠ‚ç‚¹ï¼Œ<strong>å¯¹å…¶æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬åˆ é™¤äº‹ä»¶</strong></p>
</li>
<li>å®¢æˆ·ç«¯çš„ Watcher æ”¶åˆ°åˆ é™¤äº‹ä»¶é€šçŸ¥ï¼Œå°±ä¼šé‡æ–°åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯å­èŠ‚ç‚¹ä¸­åºå·æœ€å°ï¼Œå¦‚æœæ˜¯åˆ™è·å–åˆ°äº†é”ï¼Œ å¦‚æœä¸æ˜¯åˆ™é‡å¤ä»¥ä¸Šæ­¥éª¤ç»§ç»­è·å–åˆ°æ¯”è‡ªå·±å°çš„ä¸€ä¸ªèŠ‚ç‚¹å¹¶æ³¨å†Œç›‘å¬</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Zookeeper-åˆ†å¸ƒå¼é”åŸç†.png" alt=""></p>
<hr>
<h3 id="Curator"><a href="#Curator" class="headerlink" title="Curator"></a>Curator</h3><p>Curator å®ç°åˆ†å¸ƒå¼é” APIï¼Œåœ¨ Curator ä¸­æœ‰äº”ç§é”æ–¹æ¡ˆï¼š</p>
<ul>
<li><p>InterProcessSemaphoreMutexï¼šåˆ†å¸ƒå¼æ’å®ƒé”ï¼ˆéå¯é‡å…¥é”ï¼‰</p>
</li>
<li><p>InterProcessMutexï¼šåˆ†å¸ƒå¼å¯é‡å…¥æ’å®ƒé”</p>
</li>
<li><p>InterProcessReadWriteLockï¼šåˆ†å¸ƒå¼è¯»å†™é”</p>
</li>
<li><p>InterProcessMultiLockï¼šå°†å¤šä¸ªé”ä½œä¸ºå•ä¸ªå®ä½“ç®¡ç†çš„å®¹å™¨</p>
</li>
<li><p>InterProcessSemaphoreV2ï¼šå…±äº«ä¿¡å·é‡</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CuratorLock</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CuratorFramework <span class="title function_">getCuratorFramework</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// é‡è¯•ç­–ç•¥å¯¹è±¡</span></span><br><span class="line">        <span class="type">ExponentialBackoffRetry</span> <span class="variable">policy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">3000</span>, <span class="number">3</span>);</span><br><span class="line">        <span class="comment">// æ„å»ºå®¢æˆ·ç«¯</span></span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.builder()</span><br><span class="line">                .connectString(<span class="string">&quot;192.168.3.128:2181&quot;</span>)</span><br><span class="line">                .connectionTimeoutMs(<span class="number">2000</span>)	<span class="comment">// è¿æ¥è¶…æ—¶æ—¶é—´</span></span><br><span class="line">                .sessionTimeoutMs(<span class="number">20000</span>)	<span class="comment">// ä¼šè¯è¶…æ—¶æ—¶é—´ å•ä½ms</span></span><br><span class="line">                .retryPolicy(policy)		<span class="comment">// é‡è¯•ç­–ç•¥</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯åŠ¨å®¢æˆ·ç«¯</span></span><br><span class="line">        client.start();</span><br><span class="line">        System.out.println(<span class="string">&quot;zookeeper å¯åŠ¨æˆåŠŸ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºåˆ†å¸ƒå¼é”1</span></span><br><span class="line">        <span class="type">InterProcessMutex</span> <span class="variable">lock1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessMutex</span>(getCuratorFramework(), <span class="string">&quot;/locks&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºåˆ†å¸ƒå¼é”2</span></span><br><span class="line">        <span class="type">InterProcessMutex</span> <span class="variable">lock2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessMutex</span>(getCuratorFramework(), <span class="string">&quot;/locks&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                lock1.acquire();</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹1 è·å–åˆ°é”&quot;</span>);</span><br><span class="line"></span><br><span class="line">                Thread.sleep(<span class="number">5</span> * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">                lock1.release();</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹1 é‡Šæ”¾é”&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                lock2.acquire();</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹2 è·å–åˆ°é”&quot;</span>);</span><br><span class="line"></span><br><span class="line">                Thread.sleep(<span class="number">5</span> * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">                lock2.release();</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹2 é‡Šæ”¾é”&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h2><h3 id="æœåŠ¡ç«¯-1"><a href="#æœåŠ¡ç«¯-1" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h3><p>æœåŠ¡ç«¯ç¨‹åºçš„å…¥å£ QuorumPeerMain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">QuorumPeerMain</span> <span class="variable">main</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QuorumPeerMain</span>();</span><br><span class="line">    main.initializeAndRun(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>initializeAndRun çš„å·¥ä½œï¼š</p>
<ul>
<li><p>è§£æå¯åŠ¨å‚æ•°</p>
</li>
<li><p>æäº¤å‘¨æœŸä»»åŠ¡ï¼Œå®šæ—¶åˆ é™¤è¿‡æœŸçš„å¿«ç…§</p>
</li>
<li><p>åˆå§‹åŒ–é€šä¿¡æ¨¡å‹ï¼Œé»˜è®¤æ˜¯ NIO é€šä¿¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// QuorumPeerMain#runFromConfig</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">runFromConfig</span><span class="params">(QuorumPeerConfig config)</span> &#123;</span><br><span class="line">    <span class="comment">// é€šä¿¡ä¿¡ç»„ä»¶åˆå§‹åŒ–ï¼Œé»˜è®¤æ˜¯ NIO é€šä¿¡</span></span><br><span class="line">    <span class="type">ServerCnxnFactory</span> <span class="variable">cnxnFactory</span> <span class="operator">=</span> ServerCnxnFactory.createFactory();</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–NIO æœåŠ¡ç«¯socketï¼Œç»‘å®š2181 ç«¯å£ï¼Œå¯ä»¥æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚</span></span><br><span class="line">    cnxnFactory.configure(config.getClientPortAddress(), config.getMaxClientCnxns(), <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// å¯åŠ¨ zk</span></span><br><span class="line">    quorumPeer.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨ zookeeper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// QuorumPeer#start</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!getView().containsKey(myid)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;My id &quot;</span> + myid + <span class="string">&quot; not in the peer list&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å†·å¯åŠ¨æ•°æ®æ¢å¤ï¼Œå°†å¿«ç…§ä¸­æ•°æ®æ¢å¤åˆ° DataTree</span></span><br><span class="line">    loadDataBase();</span><br><span class="line">    <span class="comment">// å¯åŠ¨é€šä¿¡å·¥å‚å®ä¾‹å¯¹è±¡</span></span><br><span class="line">    startServerCnxnFactory();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        adminServer.start();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AdminServerException e) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;Problem starting AdminServer&quot;</span>, e);</span><br><span class="line">        System.out.println(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å‡†å¤‡é€‰ä¸¾ç¯å¢ƒ</span></span><br><span class="line">    startLeaderElection();</span><br><span class="line">    <span class="comment">// æ‰§è¡Œé€‰ä¸¾</span></span><br><span class="line">    <span class="built_in">super</span>.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="é€‰ä¸¾æœºåˆ¶"><a href="#é€‰ä¸¾æœºåˆ¶" class="headerlink" title="é€‰ä¸¾æœºåˆ¶"></a>é€‰ä¸¾æœºåˆ¶</h3><h4 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h4><p>QuorumPeer#startLeaderElection åˆå§‹åŒ–é€‰ä¸¾ç¯å¢ƒï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startLeaderElection</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Looking çŠ¶æ€ï¼Œéœ€è¦é€‰ä¸¾</span></span><br><span class="line">        <span class="keyword">if</span> (getPeerState() == ServerState.LOOKING) &#123;</span><br><span class="line">            <span class="comment">// é€‰ç¥¨ç»„ä»¶: myid (serverid), zxid, epoch</span></span><br><span class="line">            <span class="comment">// å¼€å§‹é€‰ç¥¨æ—¶ï¼Œserverid æ˜¯è‡ªå·±ï¼Œã€å…ˆæŠ•è‡ªå·±ã€‘</span></span><br><span class="line">            currentVote = <span class="keyword">new</span> <span class="title class_">Vote</span>(myid, getLastLoggedZxid(), getCurrentEpoch());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (electionType == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            udpSocket = <span class="keyword">new</span> <span class="title class_">DatagramSocket</span>(getQuorumAddress().getPort());</span><br><span class="line">            <span class="comment">// å“åº”æŠ•ç¥¨ç»“æœçº¿ç¨‹</span></span><br><span class="line">            responder = <span class="keyword">new</span> <span class="title class_">ResponderThread</span>();</span><br><span class="line">            responder.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ›å»ºé€‰ä¸¾ç®—æ³•å®ä¾‹</span></span><br><span class="line">    <span class="built_in">this</span>.electionAlg = createElectionAlgorithm(electionType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// zkæ€»çš„å‘é€å’Œæ¥æ”¶é˜Ÿåˆ—å‡†å¤‡å¥½</span></span><br><span class="line"><span class="keyword">protected</span> Election <span class="title function_">createElectionAlgorithm</span><span class="params">(<span class="type">int</span> electionAlgorithm)</span>&#123;</span><br><span class="line">    <span class="comment">// è´Ÿè´£é€‰ä¸¾è¿‡ç¨‹ä¸­çš„æ‰€æœ‰ç½‘ç»œé€šä¿¡ï¼Œåˆ›å»ºå„ç§é˜Ÿåˆ—å’Œé›†åˆ</span></span><br><span class="line">    <span class="type">QuorumCnxManager</span> <span class="variable">qcm</span> <span class="operator">=</span> createCnxnManager();</span><br><span class="line">    QuorumCnxManager.<span class="type">Listener</span> <span class="variable">listener</span> <span class="operator">=</span> qcm.listener;</span><br><span class="line">    <span class="keyword">if</span>(listener != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">// å¯åŠ¨ç›‘å¬çº¿ç¨‹, è°ƒç”¨ client = ss.accept()é˜»å¡ï¼Œç­‰å¾…å¤„ç†è¯·æ±‚</span></span><br><span class="line">        listener.start();</span><br><span class="line">        <span class="comment">// å‡†å¤‡å¥½å‘é€å’Œæ¥æ”¶é˜Ÿåˆ—å‡†å¤‡</span></span><br><span class="line">        <span class="type">FastLeaderElection</span> <span class="variable">fle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FastLeaderElection</span>(<span class="built_in">this</span>, qcm);</span><br><span class="line">        <span class="comment">// å¯åŠ¨é€‰ä¸¾çº¿ç¨‹ï¼Œã€WorkerSender å’Œ WorkerReceiverã€‘</span></span><br><span class="line">        fle.start();</span><br><span class="line">        le = fle;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="é€‰ä¸¾æºç "><a href="#é€‰ä¸¾æºç " class="headerlink" title="é€‰ä¸¾æºç "></a>é€‰ä¸¾æºç </h4><p>å½“ Zookeeper å¯åŠ¨åï¼Œé¦–å…ˆéƒ½æ˜¯ Looking çŠ¶æ€ï¼Œé€šè¿‡é€‰ä¸¾è®©å…¶ä¸­ä¸€å°æœåŠ¡å™¨æˆä¸º Leader</p>
<p>æ‰§è¡Œ <code>super.start()</code> ç›¸å½“äºæ‰§è¡Œ <code>QuorumPeer#run()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> LOOKING:</span><br><span class="line">        <span class="comment">// è¿›è¡Œé€‰ä¸¾ï¼Œé€‰ä¸¾ç»“æŸè¿”å›æœ€ç»ˆæˆä¸º Leader èƒœé€‰çš„é‚£å¼ é€‰ç¥¨</span></span><br><span class="line">        setCurrentVote(makeLEStrategy().lookForLeader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FastLeaderElection ç±»ï¼š</p>
<ul>
<li><p>lookForLeaderï¼šé€‰ä¸¾</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Vote <span class="title function_">lookForLeader</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// æ­£å¸¸å¯åŠ¨ä¸­å…¶ä»–æœåŠ¡å™¨éƒ½ä¼šå‘æˆ‘å‘é€ä¸€ä¸ªæŠ•ç¥¨ï¼Œä¿å­˜æ¯ä¸ªæœåŠ¡å™¨çš„æœ€æ–°åˆæ³•æœ‰æ•ˆçš„æŠ•ç¥¨</span></span><br><span class="line">    HashMap&lt;Long, Vote&gt; recvset = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Long, Vote&gt;();</span><br><span class="line">	<span class="comment">// å­˜å‚¨åˆæ³•é€‰ä¸¾ä¹‹å¤–çš„æŠ•ç¥¨ç»“æœ</span></span><br><span class="line">    HashMap&lt;Long, Vote&gt; outofelection = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Long, Vote&gt;();</span><br><span class="line">	<span class="comment">// ä¸€æ¬¡é€‰ä¸¾çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œé»˜è®¤å€¼æ˜¯0.2s</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">notTimeout</span> <span class="operator">=</span> finalizeWait;</span><br><span class="line">	<span class="comment">// æ¯å‘èµ·ä¸€è½®é€‰ä¸¾ï¼Œlogicalclock++,åœ¨æ²¡æœ‰åˆæ³•çš„epoch æ•°æ®ä¹‹å‰ï¼Œéƒ½ä½¿ç”¨é€»è¾‘æ—¶é’Ÿä»£æ›¿</span></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>)&#123;</span><br><span class="line">        <span class="comment">// æ›´æ–°é€»è¾‘æ—¶é’Ÿï¼Œæ¯è¿›è¡Œä¸€æ¬¡é€‰ä¸¾ï¼Œéƒ½éœ€è¦æ›´æ–°é€»è¾‘æ—¶é’Ÿ</span></span><br><span class="line">        logicalclock.incrementAndGet();</span><br><span class="line">        <span class="comment">// æ›´æ–°é€‰ç¥¨(serveridï¼Œ zxid, epochï¼‰</span></span><br><span class="line">        updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¹¿æ’­é€‰ç¥¨ï¼ŒæŠŠè‡ªå·±çš„é€‰ç¥¨å‘ç»™å…¶ä»–æœåŠ¡å™¨</span></span><br><span class="line">    sendNotifications();</span><br><span class="line">    <span class="comment">// ä¸€è½®ä¸€è½®çš„é€‰ä¸¾ç›´åˆ°é€‰ä¸¾æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">while</span> ((self.getPeerState() == ServerState.LOOKING) &amp;&amp; (!stop))&#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>sendNotificationsï¼šå¹¿æ’­é€‰ç¥¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendNotifications</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// éå†æŠ•ç¥¨å‚ä¸è€…ï¼Œç»™æ¯å°æœåŠ¡å™¨å‘é€é€‰ç¥¨</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">long</span> sid : self.getCurrentAndNextConfigVoters()) &#123;</span><br><span class="line">		<span class="comment">// åˆ›å»ºå‘é€é€‰ç¥¨</span></span><br><span class="line">        <span class="type">ToSend</span> <span class="variable">notmsg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToSend</span>(...);</span><br><span class="line">        <span class="comment">// æŠŠå‘é€é€‰ç¥¨æ”¾å…¥å‘é€é˜Ÿåˆ—</span></span><br><span class="line">        sendqueue.offer(notmsg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>FastLeaderElection ä¸­æœ‰ WorkerSender çº¿ç¨‹ï¼š</p>
<ul>
<li><p><code>ToSend m = sendqueue.poll(3000, TimeUnit.MILLISECONDS)</code>ï¼š<strong>é˜»å¡è·å–è¦å‘é€çš„é€‰ç¥¨</strong></p>
</li>
<li><p><code>process(m)</code>ï¼šå¤„ç†è¦å‘é€çš„é€‰ç¥¨</p>
<p><code>manager.toSend(m.sid, requestBuffer)</code>ï¼šå‘é€é€‰ç¥¨</p>
<ul>
<li><p><code>if (this.mySid == sid)</code>ï¼šå¦‚æœ<strong>æ¶ˆæ¯çš„æ¥æ”¶è€… sid æ˜¯è‡ªå·±</strong>ï¼Œç›´æ¥è¿›å…¥è‡ªå·±çš„ RecvQueueï¼ˆè‡ªå·±æŠ•è‡ªå·±ï¼‰</p>
</li>
<li><p><code>else</code>ï¼šå¦‚æœæ¥æ”¶è€…æ˜¯å…¶ä»–æœåŠ¡å™¨ï¼Œåˆ›å»ºå¯¹åº”çš„å‘é€é˜Ÿåˆ—æˆ–è€…å¤ç”¨å·²ç»å­˜åœ¨çš„å‘é€é˜Ÿåˆ—ï¼ŒæŠŠæ¶ˆæ¯æ”¾å…¥è¯¥é˜Ÿåˆ—</p>
</li>
<li><p><code>connectOne(sid)</code>ï¼šå»ºç«‹è¿æ¥</p>
<ul>
<li><p><code>sock.connect(electionAddr, cnxTO)</code>ï¼šå»ºç«‹ä¸ sid æœåŠ¡å™¨çš„è¿æ¥</p>
</li>
<li><p><code>initiateConnection(sock, sid)</code>ï¼šåˆå§‹åŒ–è¿æ¥</p>
<p><code>startConnection(sock, sid)</code>ï¼šåˆ›å»ºå¹¶å¯åŠ¨å‘é€å™¨çº¿ç¨‹å’Œæ¥æ”¶å™¨çº¿ç¨‹</p>
<ul>
<li><code>dout = new DataOutputStream(buf)</code>ï¼š<strong>è·å– Socket è¾“å‡ºæµ</strong>ï¼Œå‘æœåŠ¡å™¨å‘é€æ•°æ®</li>
<li><code>din = new DataInputStream(new BIS(sock.getInputStream())))</code>ï¼šé€šè¿‡è¾“å…¥æµè¯»å–å¯¹æ–¹å‘é€è¿‡æ¥çš„é€‰ç¥¨</li>
<li><code>if (sid &gt; self.getId())</code>ï¼šæ¥æ”¶è€… sid æ¯”æˆ‘çš„å¤§ï¼Œæ²¡æœ‰èµ„æ ¼ç»™å¯¹æ–¹å‘é€è¿æ¥è¯·æ±‚çš„ï¼Œç›´æ¥å…³é—­è‡ªå·±çš„å®¢æˆ·ç«¯</li>
<li><code>SendWorker sw</code>ï¼šåˆå§‹åŒ–å‘é€å™¨ï¼Œå¹¶å¯åŠ¨å‘é€å™¨çº¿ç¨‹ï¼Œçº¿ç¨‹ run æ–¹æ³•<ul>
<li><code>while (running &amp;&amp; !shutdown &amp;&amp; sock != null)</code>ï¼šè¿æ¥æ²¡æœ‰æ–­å¼€å°±ä¸€ç›´è¿è¡Œ</li>
<li><code>ByteBuffer b = pollSendQueue()</code>ï¼šä»å‘é€é˜Ÿåˆ— SendQueue ä¸­è·å–å‘é€æ¶ˆæ¯</li>
<li><code>lastMessageSent.put(sid, b)</code>ï¼šæ›´æ–°å¯¹äº sid è¿™å°æœåŠ¡å™¨çš„æœ€è¿‘ä¸€æ¡æ¶ˆæ¯</li>
<li><code>send(b)</code>ï¼š<strong>æ‰§è¡Œå‘é€</strong></li>
</ul>
</li>
<li><code>RecvWorker rw</code>ï¼šåˆå§‹åŒ–æ¥æ”¶å™¨ï¼Œå¹¶å¯åŠ¨æ¥æ”¶å™¨çº¿ç¨‹<ul>
<li><code>din.readFully(msgArray, 0, length)</code>ï¼šè¾“å…¥æµæ¥æ”¶æ¶ˆæ¯</li>
<li><code>addToRecvQueue(new Message(messagg, sid))</code>ï¼šå°†æ¶ˆæ¯æ”¾å…¥æ¥æ”¶æ¶ˆæ¯ recvQueue é˜Ÿåˆ—</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>FastLeaderElection ä¸­æœ‰ WorkerReceiver çº¿ç¨‹</p>
<ul>
<li><code>response = manager.pollRecvQueue()</code>ï¼šä» RecvQueue ä¸­<strong>é˜»å¡è·å–å‡ºé€‰ä¸¾æŠ•ç¥¨æ¶ˆæ¯</strong>ï¼ˆå…¶ä»–æœåŠ¡å™¨å‘é€è¿‡æ¥çš„ï¼‰</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Zookeeper-é€‰ä¸¾æºç .png" style="zoom: 50%;" /></p>
<hr>
<h4 id="çŠ¶æ€åŒæ­¥"><a href="#çŠ¶æ€åŒæ­¥" class="headerlink" title="çŠ¶æ€åŒæ­¥"></a>çŠ¶æ€åŒæ­¥</h4><p>é€‰ä¸¾ç»“æŸåï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ ¹æ®è§’è‰²æ›´æ–°è‡ªå·±çš„çŠ¶æ€ï¼ŒLeader æ›´æ–°çŠ¶æ€ä¸º Leaderï¼Œå…¶ä»–èŠ‚ç‚¹æ›´æ–°çŠ¶æ€ä¸º Followerï¼Œæ•´ä½“æµç¨‹ï¼š</p>
<ul>
<li>Follower éœ€è¦è®© Leader çŸ¥é“è‡ªå·±çš„çŠ¶æ€ (sid, epoch, zxid)</li>
<li>Leader æ¥æ”¶åˆ°ä¿¡æ¯ï¼Œ<strong>æ ¹æ®ä¿¡æ¯æ„å»ºæ–°çš„ epoch</strong>ï¼Œè¦è¿”å›å¯¹åº”çš„ä¿¡æ¯ç»™ Followerï¼ŒFollower æ›´æ–°è‡ªå·±çš„ epoch</li>
<li>Leader éœ€è¦æ ¹æ® Follower çš„çŠ¶æ€ï¼Œç¡®å®šä½•ç§æ–¹å¼çš„æ•°æ®åŒæ­¥ DIFFã€TRUNCã€SNAPï¼Œå°±æ˜¯è¦<strong>ä»¥ Leader æœåŠ¡å™¨æ•°æ®ä¸ºå‡†</strong><ul>
<li>DIFFï¼šLeader æäº¤çš„ zxid æ¯” Follower çš„ zxid å¤§ï¼Œå‘é€ Proposal ç»™ Follower æäº¤æ‰§è¡Œ</li>
<li>TRUNCï¼šFollower çš„ zxid æ¯”leader çš„ zxid å¤§ï¼ŒFollower è¦è¿›è¡Œå›æ»š</li>
<li>SNAPï¼šFollower æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œç›´æ¥å…¨é‡åŒæ­¥</li>
</ul>
</li>
<li>æ‰§è¡Œæ•°æ®åŒæ­¥ï¼Œå½“ Leader æ¥æ”¶åˆ°è¶…è¿‡åŠæ•° Follower çš„ Ack ä¹‹åï¼Œè¿›å…¥æ­£å¸¸å·¥ä½œçŠ¶æ€ï¼Œé›†ç¾¤å¯åŠ¨å®Œæˆ</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Zookeeper-åŒæ­¥æºç .png" style="zoom:50%;" /></p>
<p>æ ¸å¿ƒå‡½æ•°è§£æï¼š</p>
<ul>
<li>Leader æ›´æ–°çŠ¶æ€å…¥å£ï¼š<code>Leader.lead()</code><ul>
<li><code>zk.loadData()</code>ï¼šæ¢å¤æ•°æ®åˆ°å†…å­˜</li>
<li><code>cnxAcceptor = new LearnerCnxAcceptor()</code>ï¼šå¯åŠ¨é€šä¿¡ç»„ä»¶<ul>
<li><code>s = ss.accept()</code>ï¼šç­‰å¾…å…¶ä»– Follower èŠ‚ç‚¹å‘ Leader èŠ‚ç‚¹å‘é€åŒæ­¥çŠ¶æ€</li>
<li><code>LearnerHandler fh</code>ï¼šæ¥æ”¶åˆ° Follower çš„è¯·æ±‚ï¼Œå°±åˆ›å»º LearnerHandler å¯¹è±¡</li>
<li><code>fh.start()</code>ï¼šå¯åŠ¨çº¿ç¨‹ï¼Œé€šè¿‡ switch-case è¯­æ³•åˆ¤æ–­æ¥æ”¶çš„å‘½ä»¤ï¼Œæ‰§è¡Œç›¸åº”çš„æ“ä½œ</li>
</ul>
</li>
</ul>
</li>
<li>Follower æ›´æ–°çŠ¶æ€å…¥å£ï¼š<code>Follower.followerLeader()</code><ul>
<li><code>QuorumServer leaderServer = findLeader()</code>ï¼šæŸ¥æ‰¾ Leader</li>
<li><code>connectToLeader(addr, hostname)</code>ï¼šä¸ Leader å»ºç«‹è¿æ¥</li>
<li><code>long newEpochZxid = registerWithLeader(Leader.FOLLOWERINFO)</code>ï¼šå‘ Leader æ³¨å†Œ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="ä¸»ä»å·¥ä½œ"><a href="#ä¸»ä»å·¥ä½œ" class="headerlink" title="ä¸»ä»å·¥ä½œ"></a>ä¸»ä»å·¥ä½œ</h4><p>Leaderï¼šä¸»æœåŠ¡çš„å·¥ä½œæµç¨‹</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Zookeeper-Leaderå¯åŠ¨.png" alt=""></p>
<p>Followerï¼šä»æœåŠ¡çš„å·¥ä½œæµç¨‹ï¼Œæ ¸å¿ƒå‡½æ•°ä¸º <code>Follower#followLeader()</code></p>
<ul>
<li><p><code>readPacket(qp)</code>ï¼šè¯»å–ä¿¡æ¯</p>
</li>
<li><p><code>processPacket(qp)</code>ï¼šå¤„ç†ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processPacket</span><span class="params">(QuorumPacket qp)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="keyword">switch</span> (qp.getType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> Leader.PING:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Leader.PROPOSAL:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Leader.COMMIT:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Leader.COMMITANDACTIVATE:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Leader.UPTODATE:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Leader.REVALIDATE:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Leader.SYNC:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="å®¢æˆ·ç«¯-1"><a href="#å®¢æˆ·ç«¯-1" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Zookeeper-å®¢æˆ·ç«¯åˆå§‹åŒ–.png" alt=""></p>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>å¸¸ç”¨æ¡†æ¶</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://www.json25.cn/posts/779497dd.html">https://www.json25.cn/posts/779497dd.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>jsonğŸ¥</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2023-03-16</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2023-03-17</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>java</a><a class="post-meta__tags" href="/tags/%E6%A1%86%E6%9E%B6/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>æ¡†æ¶</a><a class="post-meta__tags" href="/tags/maven/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>maven</a><a class="post-meta__tags" href="/tags/zk/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>zk</a><a class="post-meta__tags" href="/tags/netty/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>netty</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">æŠ•å–‚ä½œè€…</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn-eys.pages.dev/img/donate.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/donate.webp" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="https://cdn-eys.pages.dev/img/zfb.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/zfb.webp" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/84cad344.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm9.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">javassmæ¡†æ¶</div></div></a></div><div class="next-post pull-right"><a href="/posts/f0675471.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm9.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">jvm</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/0.html" title="jucå¹¶å‘ç¼–ç¨‹"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm17.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-03-17</div><div class="title">jucå¹¶å‘ç¼–ç¨‹</div></div></a></div><div><a href="/posts/784bec6.html" title="ajaxç¬”è®°"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm15.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-03-07</div><div class="title">ajaxç¬”è®°</div></div></a></div><div><a href="/posts/8de1ec.html" title="javaé¢ç»"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm4.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-03-15</div><div class="title">javaé¢ç»</div></div></a></div><div><a href="/posts/84cad344.html" title="javassmæ¡†æ¶"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm9.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-03-17</div><div class="title">javassmæ¡†æ¶</div></div></a></div><div><a href="/posts/827432d7.html" title="javaseåŸºç¡€çŸ¥è¯†"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm18.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-03-17</div><div class="title">javaseåŸºç¡€çŸ¥è¯†</div></div></a></div><div><a href="/posts/10c11d66.html" title="javaå¸¸ç”¨å·¥å…·"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm13.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-03-17</div><div class="title">javaå¸¸ç”¨å·¥å…·</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Maven"><span class="toc-text">Maven</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Mvn%E4%BB%8B%E7%BB%8D"><span class="toc-text">Mvnä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-text">åŸºç¡€æ¦‚å¿µ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">ç¯å¢ƒæ­å»º</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-text">ç¯å¢ƒé…ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%93%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-text">ä»“åº“é…ç½®</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA"><span class="toc-text">é¡¹ç›®æ­å»º</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BA"><span class="toc-text">æ‰‹åŠ¨æ­å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDEA%E6%90%AD%E5%BB%BA"><span class="toc-text">IDEAæ­å»º</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E7%94%A8%E5%8E%9F%E5%9E%8B"><span class="toc-text">ä¸ç”¨åŸå‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%9E%8B"><span class="toc-text">ä½¿ç”¨åŸå‹</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86"><span class="toc-text">ä¾èµ–ç®¡ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E9%85%8D%E7%BD%AE"><span class="toc-text">ä¾èµ–é…ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E4%BC%A0%E9%80%92"><span class="toc-text">ä¾èµ–ä¼ é€’</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E8%8C%83%E5%9B%B4"><span class="toc-text">ä¾èµ–èŒƒå›´</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">ç”Ÿå‘½å‘¨æœŸ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E4%BA%8B%E4%BB%B6"><span class="toc-text">ç›¸å…³äº‹ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%BA%8B%E4%BB%B6"><span class="toc-text">æ‰§è¡Œäº‹ä»¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91"><span class="toc-text">æ¨¡å—å¼€å‘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%86%E5%88%86"><span class="toc-text">æ‹†åˆ†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88"><span class="toc-text">èšåˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%A7%E6%89%BF"><span class="toc-text">ç»§æ‰¿</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7"><span class="toc-text">å±æ€§</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E7%89%88%E6%9C%AC"><span class="toc-text">å·¥ç¨‹ç‰ˆæœ¬</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE"><span class="toc-text">èµ„æºé…ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-text">å¤šç¯å¢ƒé…ç½®</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%B3%E8%BF%87%E6%B5%8B%E8%AF%95"><span class="toc-text">è·³è¿‡æµ‹è¯•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%81%E6%9C%8D"><span class="toc-text">ç§æœ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nexus"><span class="toc-text">Nexus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E6%93%8D%E4%BD%9C"><span class="toc-text">èµ„æºæ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDEA%E6%93%8D%E4%BD%9C"><span class="toc-text">IDEAæ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD"><span class="toc-text">ä¸Šä¼ ä¸‹è½½</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E7%A7%81%E6%9C%8D"><span class="toc-text">è®¿é—®ç§æœ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E8%AE%BF%E9%97%AE"><span class="toc-text">æœ¬åœ°è®¿é—®</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E8%AE%BF%E9%97%AE"><span class="toc-text">å·¥ç¨‹è®¿é—®</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-text">æ—¥å¿—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Log4j"><span class="toc-text">Log4j</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">é…ç½®æ–‡ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%BA%94%E7%94%A8"><span class="toc-text">æ—¥å¿—åº”ç”¨</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Netty"><span class="toc-text">Netty</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-1"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="toc-text">çº¿ç¨‹æ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E6%A8%A1%E5%9E%8B"><span class="toc-text">é˜»å¡æ¨¡å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reactor"><span class="toc-text">Reactor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3"><span class="toc-text">è®¾è®¡æ€æƒ³</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95R%E5%8D%95%E7%BA%BF%E7%A8%8B"><span class="toc-text">å•Rå•çº¿ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95R%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-text">å•Rå¤šçº¿ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E6%A8%A1%E5%9E%8B"><span class="toc-text">ä¸»ä»æ¨¡å‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Proactor"><span class="toc-text">Proactor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Netty-1"><span class="toc-text">Netty</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0"><span class="toc-text">åŸºæœ¬å®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="toc-text">ç»„ä»¶ä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#EventLoop"><span class="toc-text">EventLoop</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-2"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E4%BC%A0%E9%80%92"><span class="toc-text">ä»»åŠ¡ä¼ é€’</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Channel"><span class="toc-text">Channel</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%93%8D%E4%BD%9C"><span class="toc-text">è¿æ¥æ“ä½œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E6%93%8D%E4%BD%9C"><span class="toc-text">å…³é—­æ“ä½œ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Future"><span class="toc-text">Future</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-3"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E5%AD%90%E7%B1%BB"><span class="toc-text">æ‰©å±•å­ç±»</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pipeline"><span class="toc-text">Pipeline</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ByteBuf"><span class="toc-text">ByteBuf</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-4"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%B9%E6%B3%95"><span class="toc-text">åˆ›å»ºæ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E6%93%8D%E4%BD%9C"><span class="toc-text">è¯»å†™æ“ä½œ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%87%8A%E6%94%BE"><span class="toc-text">å†…å­˜é‡Šæ”¾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%B7%E8%B4%9D%E6%93%8D%E4%BD%9C"><span class="toc-text">æ‹·è´æ“ä½œ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B2%98%E5%8C%85%E5%8D%8A%E5%8C%85"><span class="toc-text">ç²˜åŒ…åŠåŒ…</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%B0%E8%B1%A1%E6%BC%94%E7%A4%BA"><span class="toc-text">ç°è±¡æ¼”ç¤º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">è§£å†³æ–¹æ¡ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9F%AD%E8%BF%9E%E6%8E%A5"><span class="toc-text">çŸ­è¿æ¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%BA%E5%AE%9A%E9%95%BF%E5%BA%A6"><span class="toc-text">å›ºå®šé•¿åº¦</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%9A%94%E7%AC%A6"><span class="toc-text">åˆ†éš”ç¬¦</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E8%AE%BE%E9%95%BF%E5%BA%A6"><span class="toc-text">é¢„è®¾é•¿åº¦</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1"><span class="toc-text">åè®®è®¾è®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP"><span class="toc-text">HTTP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89"><span class="toc-text">è‡ªå®šä¹‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Sharable"><span class="toc-text">Sharable</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E4%BC%98%E5%8C%96"><span class="toc-text">åœºæ™¯ä¼˜åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A9%BA%E9%97%B2%E6%A3%80%E6%B5%8B"><span class="toc-text">ç©ºé—²æ£€æµ‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E5%81%87%E6%AD%BB"><span class="toc-text">è¿æ¥å‡æ­»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BF%83%E8%B7%B3%E6%9C%BA%E5%88%B6"><span class="toc-text">å¿ƒè·³æœºåˆ¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">åºåˆ—åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E6%96%B9%E5%BC%8F"><span class="toc-text">æ™®é€šæ–¹å¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ProtoBuf"><span class="toc-text">ProtoBuf</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-5"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">ä»£ç å®ç°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%BF%E8%BF%9E%E6%8E%A5"><span class="toc-text">é•¿è¿æ¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%B0%83%E4%BC%98"><span class="toc-text">å‚æ•°è°ƒä¼˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CONNECT"><span class="toc-text">CONNECT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SO-BACKLOG"><span class="toc-text">SO_BACKLOG</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%8F%82%E6%95%B0"><span class="toc-text">å…¶ä»–å‚æ•°</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RocketMQ"><span class="toc-text">RocketMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-6"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">æ¶ˆæ¯é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">åº”ç”¨åœºæ™¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="toc-text">æŠ€æœ¯é€‰å‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%B5%8B%E8%AF%95"><span class="toc-text">å®‰è£…æµ‹è¯•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-text">ç›¸å…³æ¦‚å¿µ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%93%8D%E4%BD%9C"><span class="toc-text">æ¶ˆæ¯æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A0%B7%E4%BE%8B"><span class="toc-text">åŸºæœ¬æ ·ä¾‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A2%E9%98%85%E5%8F%91%E5%B8%83"><span class="toc-text">è®¢é˜…å‘å¸ƒ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-text">å‘é€æ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%8F%91%E9%80%81"><span class="toc-text">åŒæ­¥å‘é€</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%8F%91%E9%80%81"><span class="toc-text">å¼‚æ­¥å‘é€</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E5%90%91%E5%8F%91%E9%80%81"><span class="toc-text">å•å‘å‘é€</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF"><span class="toc-text">æ¶ˆè´¹æ¶ˆæ¯</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF"><span class="toc-text">é¡ºåºæ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90"><span class="toc-text">åŸç†è§£æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-1"><span class="toc-text">ä»£ç å®ç°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%B6%E6%97%B6%E6%B6%88%E6%81%AF"><span class="toc-text">å»¶æ—¶æ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-1"><span class="toc-text">åŸç†è§£æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-2"><span class="toc-text">ä»£ç å®ç°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%B6%88%E6%81%AF"><span class="toc-text">æ‰¹é‡æ¶ˆæ¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E6%B6%88%E6%81%AF"><span class="toc-text">è¿‡æ»¤æ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-text">åŸºæœ¬è¯­æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-2"><span class="toc-text">åŸç†è§£æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-3"><span class="toc-text">ä»£ç å®ç°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="toc-text">äº‹åŠ¡æ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-text">å·¥ä½œæµç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%A4%E9%98%B6%E6%AE%B5"><span class="toc-text">ä¸¤é˜¶æ®µ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E9%98%B6%E6%AE%B5"><span class="toc-text">ä¸€é˜¶æ®µ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8C%E9%98%B6%E6%AE%B5"><span class="toc-text">äºŒé˜¶æ®µ</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">ä½¿ç”¨æ–¹å¼</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-4"><span class="toc-text">ä»£ç å®ç°</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%89%B9%E6%80%A7"><span class="toc-text">ç³»ç»Ÿç‰¹æ€§</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B-1"><span class="toc-text">å·¥ä½œæµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="toc-text">æ¨¡å—ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="toc-text">æ€»ä½“æµç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E6%B6%88%E8%B4%B9"><span class="toc-text">ç”Ÿäº§æ¶ˆè´¹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6"><span class="toc-text">å­˜å‚¨æœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="toc-text">å­˜å‚¨ç»“æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84"><span class="toc-text">å†…å­˜æ˜ å°„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B5%E9%9D%A2%E7%BC%93%E5%AD%98"><span class="toc-text">é¡µé¢ç¼“å­˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%B7%E7%9B%98%E6%9C%BA%E5%88%B6"><span class="toc-text">åˆ·ç›˜æœºåˆ¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%AE%BE%E8%AE%A1"><span class="toc-text">é›†ç¾¤è®¾è®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F"><span class="toc-text">é›†ç¾¤æ¨¡å¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="toc-text">é›†ç¾¤æ¶æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="toc-text">é«˜å¯ç”¨æ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-text">ä¸»ä»å¤åˆ¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">è´Ÿè½½å‡è¡¡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E7%AB%AF"><span class="toc-text">ç”Ÿäº§ç«¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E7%AB%AF"><span class="toc-text">æ¶ˆè´¹ç«¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-3"><span class="toc-text">åŸç†è§£æ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%9F%A5%E8%AF%A2"><span class="toc-text">æ¶ˆæ¯æŸ¥è¯¢</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%B9%E5%BC%8F"><span class="toc-text">æŸ¥è¯¢æ–¹å¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%9C%BA%E5%88%B6"><span class="toc-text">ç´¢å¼•æœºåˆ¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%87%8D%E8%AF%95"><span class="toc-text">æ¶ˆæ¯é‡è¯•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%87%8D%E6%8A%95"><span class="toc-text">æ¶ˆæ¯é‡æŠ•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%87%8D%E8%AF%95-1"><span class="toc-text">æ¶ˆæ¯é‡è¯•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E8%AF%95%E6%93%8D%E4%BD%9C"><span class="toc-text">é‡è¯•æ“ä½œ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-text">æ­»ä¿¡é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-text">é«˜å¯é æ€§</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E6%B6%88%E8%B4%B9"><span class="toc-text">å¹‚ç­‰æ¶ˆè´¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="toc-text">æµé‡æ§åˆ¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-4"><span class="toc-text">åŸç†è§£æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Namesrv"><span class="toc-text">Namesrv</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8"><span class="toc-text">æœåŠ¡å¯åŠ¨</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%96%B9%E6%B3%95"><span class="toc-text">å¯åŠ¨æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8%E7%B1%BB"><span class="toc-text">æ§åˆ¶å™¨ç±»</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1"><span class="toc-text">ç½‘ç»œé€šä¿¡</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86"><span class="toc-text">é€šä¿¡åŸç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%96%B9%E6%B3%95-1"><span class="toc-text">å¯åŠ¨æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95"><span class="toc-text">è¯·æ±‚æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%99%A8%E7%B1%BB"><span class="toc-text">å¤„ç†å™¨ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1-1"><span class="toc-text">åè®®è®¾è®¡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95"><span class="toc-text">å¤„ç†æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF"><span class="toc-text">è·¯ç”±ä¿¡æ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E7%AE%A1%E7%90%86"><span class="toc-text">ä¿¡æ¯ç®¡ç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E6%B3%A8%E5%86%8C"><span class="toc-text">è·¯ç”±æ³¨å†Œ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Broker"><span class="toc-text">Broker</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MappedFile"><span class="toc-text">MappedFile</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-1"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MapQueue"><span class="toc-text">MapQueue</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-2"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-1"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CommitLog"><span class="toc-text">CommitLog</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-3"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-2"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%BA%BF%E7%A8%8B"><span class="toc-text">æœåŠ¡çº¿ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ConsQueue"><span class="toc-text">ConsQueue</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-4"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-3"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IndexFile"><span class="toc-text">IndexFile</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-5"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-4"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IndexServ"><span class="toc-text">IndexServ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-6"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-5"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HAService"><span class="toc-text">HAService</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#HAService-1"><span class="toc-text">HAService</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Service"><span class="toc-text">Service</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Accept"><span class="toc-text">Accept</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Group"><span class="toc-text">Group</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#HAClient"><span class="toc-text">HAClient</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-7"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-6"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#HAConn"><span class="toc-text">HAConn</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Connection"><span class="toc-text">Connection</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#ReadSocket"><span class="toc-text">ReadSocket</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#WriteSocket"><span class="toc-text">WriteSocket</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MesStore"><span class="toc-text">MesStore</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F-1"><span class="toc-text">ç”Ÿå‘½å‘¨æœŸ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%BA%BF%E7%A8%8B-1"><span class="toc-text">æœåŠ¡çº¿ç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E6%9C%8D%E5%8A%A1"><span class="toc-text">æ„å»ºæœåŠ¡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%B7%E7%9B%98%E6%9C%8D%E5%8A%A1"><span class="toc-text">åˆ·ç›˜æœåŠ¡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B8%85%E7%90%86%E6%9C%8D%E5%8A%A1"><span class="toc-text">æ¸…ç†æœåŠ¡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%B6%88%E6%81%AF"><span class="toc-text">è·å–æ¶ˆæ¯</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Broker-1"><span class="toc-text">Broker</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Producer"><span class="toc-text">Producer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E7%B1%BB"><span class="toc-text">ç”Ÿäº§è€…ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E7%B1%BB-1"><span class="toc-text">ç”Ÿäº§è€…ç±»</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%80%85%E7%B1%BB"><span class="toc-text">å®ç°è€…ç±»</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95"><span class="toc-text">å®ç°æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF-1"><span class="toc-text">è·¯ç”±ä¿¡æ¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE"><span class="toc-text">å…¬å…±é…ç½®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%B1%BB"><span class="toc-text">å®¢æˆ·ç«¯ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-8"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-7"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1-1"><span class="toc-text">ç½‘ç»œé€šä¿¡</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-9"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-8"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-text">å»¶è¿Ÿæ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86"><span class="toc-text">æ¶ˆæ¯å¤„ç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E6%9C%8D%E5%8A%A1"><span class="toc-text">è°ƒåº¦æœåŠ¡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E4%BB%BB%E5%8A%A1"><span class="toc-text">è°ƒåº¦ä»»åŠ¡</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF-1"><span class="toc-text">äº‹åŠ¡æ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E7%B1%BB-2"><span class="toc-text">ç”Ÿäº§è€…ç±»</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A5%E5%8F%97%E6%B6%88%E6%81%AF"><span class="toc-text">æ¥å—æ¶ˆæ¯</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9B%9E%E6%9F%A5%E5%A4%84%E7%90%86"><span class="toc-text">å›æŸ¥å¤„ç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A4"><span class="toc-text">äº‹åŠ¡æäº¤</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Consumer"><span class="toc-text">Consumer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E7%B1%BB"><span class="toc-text">æ¶ˆè´¹è€…ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E6%B6%88%E8%B4%B9"><span class="toc-text">é»˜è®¤æ¶ˆè´¹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E5%AE%9E%E7%8E%B0"><span class="toc-text">é»˜è®¤å®ç°</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-1"><span class="toc-text">è´Ÿè½½å‡è¡¡</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-text">å®ç°æ–¹å¼</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%98%9F%E5%88%97%E5%88%86%E9%85%8D"><span class="toc-text">é˜Ÿåˆ—åˆ†é…</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E6%9C%8D%E5%8A%A1"><span class="toc-text">æ‹‰å–æœåŠ¡</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-1"><span class="toc-text">å®ç°æ–¹å¼</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E5%AF%B9%E8%B1%A1"><span class="toc-text">å°è£…å¯¹è±¡</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E5%A4%84%E7%90%86"><span class="toc-text">æ‹‰å–å¤„ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">å¤„ç†å™¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%95%BF%E8%BD%AE%E8%AF%A2"><span class="toc-text">é•¿è½®è¯¢</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E7%B1%BB"><span class="toc-text">ç»“æœç±»</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%9F%E5%88%97%E5%BF%AB%E7%85%A7"><span class="toc-text">é˜Ÿåˆ—å¿«ç…§</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-10"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-9"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E6%B6%88%E8%B4%B9"><span class="toc-text">å¹¶å‘æ¶ˆè´¹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-11"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-10"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%AF%B7%E6%B1%82"><span class="toc-text">æ¶ˆè´¹è¯·æ±‚</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%BA%E5%BA%8F%E6%B6%88%E8%B4%B9"><span class="toc-text">é¡ºåºæ¶ˆè´¹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-12"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-11"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%AF%B7%E6%B1%82-1"><span class="toc-text">æ¶ˆè´¹è¯·æ±‚</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E6%B6%88%E8%B4%B9-1"><span class="toc-text">ç”Ÿäº§æ¶ˆè´¹</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Zookeeper"><span class="toc-text">Zookeeper</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-7"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E7%89%B9%E5%BE%81"><span class="toc-text">æ¡†æ¶ç‰¹å¾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-1"><span class="toc-text">åº”ç”¨åœºæ™¯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-text">åŸºæœ¬æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%90%AD%E5%BB%BA"><span class="toc-text">å®‰è£…æ­å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4"><span class="toc-text">æ“ä½œå‘½ä»¤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-text">æœåŠ¡ç«¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">å®¢æˆ·ç«¯</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">æ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-5"><span class="toc-text">ä»£ç å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E4%BB%8B%E7%BB%8D"><span class="toc-text">é›†ç¾¤ä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5-1"><span class="toc-text">ç›¸å…³æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E6%AC%A1%E9%80%89%E4%B8%BE"><span class="toc-text">åˆæ¬¡é€‰ä¸¾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E9%80%89%E4%B8%BE"><span class="toc-text">å†æ¬¡é€‰ä¸¾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5"><span class="toc-text">æ•°æ®å†™å…¥</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%95%E5%B1%82%E5%8D%8F%E8%AE%AE"><span class="toc-text">åº•å±‚åè®®</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Paxos"><span class="toc-text">Paxos</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZAB"><span class="toc-text">ZAB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%97%E6%B3%95%E4%BB%8B%E7%BB%8D"><span class="toc-text">ç®—æ³•ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%B9%BF%E6%92%AD"><span class="toc-text">æ¶ˆæ¯å¹¿æ’­</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B4%A9%E6%BA%83%E6%81%A2%E5%A4%8D"><span class="toc-text">å´©æºƒæ¢å¤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-text">å¼‚å¸¸å¤„ç†</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CAP"><span class="toc-text">CAP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E6%9C%BA%E5%88%B6"><span class="toc-text">ç›‘å¬æœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">å®ç°åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E6%A1%88%E4%BE%8B"><span class="toc-text">ç›‘å¬æ¡ˆä¾‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-text">æ•´ä½“æ¶æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-6"><span class="toc-text">ä»£ç å®ç°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">åˆ†å¸ƒå¼é”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-1"><span class="toc-text">å®ç°åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Curator"><span class="toc-text">Curator</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-text">æºç è§£æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF-1"><span class="toc-text">æœåŠ¡ç«¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6"><span class="toc-text">é€‰ä¸¾æœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">ç¯å¢ƒå‡†å¤‡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E4%B8%BE%E6%BA%90%E7%A0%81"><span class="toc-text">é€‰ä¸¾æºç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E5%90%8C%E6%AD%A5"><span class="toc-text">çŠ¶æ€åŒæ­¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%B7%A5%E4%BD%9C"><span class="toc-text">ä¸»ä»å·¥ä½œ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF-1"><span class="toc-text">å®¢æˆ·ç«¯</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">æ ¼è¨€ğŸ§¬</p><div class="bg-ad"><div>å†çœ‹çœ‹é‚£ä¸ªå…‰ç‚¹ï¼Œå®ƒå°±åœ¨è¿™é‡Œï¼Œè¿™æ˜¯å®¶å›­ï¼Œè¿™æ˜¯æˆ‘ä»¬ â€”â€” ä½ æ‰€çˆ±çš„æ¯ä¸€ä¸ªäººï¼Œä½ è®¤è¯†çš„ä¸€ä¸ªäººï¼Œä½ å¬è¯´è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œæ›¾ç»æœ‰è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œéƒ½åœ¨å®ƒä¸Šé¢åº¦è¿‡ä»–ä»¬çš„ä¸€ç”Ÿâœ¨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">ç‚¹å‡»å¼€å¯æ˜Ÿè¾°ä¹‹æ—…</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">çŒœä½ æƒ³çœ‹ğŸ’¡</p><ul class="ft-links"><li><a href="/posts/eec9786.html">é­”æ”¹æŒ‡å—</a><a href="/box/Gallery/">æˆ‘çš„ç”»å»Š</a></li><li><a href="/social/link/">æˆ‘çš„æœ‹å‹</a><a href="/comments/">ç•™ç‚¹ä»€ä¹ˆ</a></li><li><a href="/personal/about/">å…³äºä½œè€…</a><a href="/archives/">æ–‡ç« å½’æ¡£</a></li><li><a href="/categories/">æ–‡ç« åˆ†ç±»</a><a href="/tags/">æ–‡ç« æ ‡ç­¾</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">æ¨èå‹é“¾âŒ›</p><div class="ft-img-group"><div class="img-group-item"><a target="_blank" rel="noopener" href="https://www.fomal.cc/" title="FomalhautğŸ¥"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/60e5d4e39da7c077.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div></div></div></div><div class="copyright"><span><b>&copy;2022-2023</b></span><span><b>&nbsp;&nbsp;By jsonğŸ¥</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="åšå®¢æ¡†æ¶ä¸ºHexo_v6.3.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Frame-Hexo-blue.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="ä¸»é¢˜ç‰ˆæœ¬Butterfly_v4.3.1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Theme-Butterfly-6513df.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" title="æœ¬ç«™é‡‡ç”¨å¤šçº¿éƒ¨ç½²ï¼Œä¸»çº¿è·¯æ‰˜ç®¡äºVercel"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Hosted-Vercel-brightgreen.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://user.51.la/" style="margin-inline:5px" title="æœ¬ç«™æ•°æ®åˆ†æå¾—ç›Šäº51laæŠ€æœ¯æ”¯æŒ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Analytics-51la-3db1eb.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://cdn-eys.pages.dev/html/beian.html" style="margin-inline:5px" title="æœ¬ç«™å·²åŠ å…¥èŒICPè±ªåå¥—é¤ï¼ŒèŒICPå¤‡20226665å·"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/%E8%90%8Cicp%E5%A4%87-2023001927-pink.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://bitiful.dogecast.com/buckets" style="margin-inline:5px" title="æœ¬ç½‘ç«™ç»Service Workeråˆ†æµè‡³ç¼¤çº·äº‘å¯¹è±¡å­˜å‚¨"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Bucket-ç¼¤çº·äº‘-9c62da.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.netdun.net/" style="margin-inline:5px" title="æœ¬ç«™ä½¿ç”¨ç½‘ç›¾æ˜Ÿçƒæä¾›CDNåŠ é€Ÿä¸é˜²æŠ¤"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/CDN-ç½‘ç›¾æ˜Ÿçƒ-fff2cc.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="æœ¬ç½‘ç«™æºç ç”±Githubæä¾›å­˜å‚¨ä»“åº“"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Source-Github-d021d6.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="å³é”®æ¨¡å¼" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>å¤åˆ¶</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>ç™¾åº¦æœç´¢</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>ç²˜è´´</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>ç©ºé™è¯„è®º</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>å¤åˆ¶æœ¬æ–‡åœ°å€</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>ä¿å­˜å›¾ç‰‡</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>åœ¨æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶å›¾ç‰‡é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>æ˜¼å¤œåˆ‡æ¢</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>å…³äºåšå®¢</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>ç¾åŒ–è®¾ç½®</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>åˆ‡æ¢å…¨å±</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>æ‰“å°é¡µé¢</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://www.json1234.xyz/',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://www.json1234.xyz/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://www.json25.cn/categories/è®¡ç®—æœºåŸºç¡€/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¼ jsonã®è®¡ç®—æœºåŸºç¡€ç¬”è®° (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.json25.cn/categories/é­”æ”¹æ•™ç¨‹/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ‰ jsonã®åšå®¢é­”æ”¹æ•™ç¨‹ (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.json25.cn/categories/JavaåŸºç¡€/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸŸ jsonã®JavaåŸºç¡€ç¬”è®° (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.json25.cn/categories/æ•°æ®åº“/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¨ jsonã®æ•°æ®åº“ç¬”è®° (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.json25.cn/categories/å‰ç«¯/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥ jsonã®å‰ç«¯ç¬”è®° (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://www.json25.cn/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';
    console.log('å·²æŒ‚è½½magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/10c11d66.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm13.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-03-17</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/10c11d66.html&quot;);" href="javascript:void(0);" alt="">javaå¸¸ç”¨å·¥å…·</a><div class="blog-slider__text">è¿™æ˜¯ä¸€ç¯‡å…³äºjavaå·¥å…·çš„ä»‹ç»</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/10c11d66.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/440e822d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm5.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-17</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/440e822d.html&quot;);" href="javascript:void(0);" alt="">æ•°æ®ç»“æ„ç®—æ³•</a><div class="blog-slider__text">è¿™æ˜¯è€ƒç ”æ•°æ®ç»“æ„ç®—æ³•æ€»ç»“</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/440e822d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/84cad344.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm9.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-16</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/84cad344.html&quot;);" href="javascript:void(0);" alt="">javassmæ¡†æ¶</a><div class="blog-slider__text">è¿™æ˜¯ssmæ¡†æ¶çš„ç¬”è®°</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/84cad344.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/827432d7.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm18.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-03-16</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/827432d7.html&quot;);" href="javascript:void(0);" alt="">javaseåŸºç¡€çŸ¥è¯†</a><div class="blog-slider__text">è¿™æ˜¯ä¸€ç¯‡å…³äºjavaseçš„ç¬”è®°</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/827432d7.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/779497dd.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm13.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-16</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/779497dd.html&quot;);" href="javascript:void(0);" alt="">å¸¸ç”¨æ¡†æ¶</a><div class="blog-slider__text">è¿™æ˜¯ä¸€ç¯‡å…³äºjavaå¸¸ç”¨æ¡†æ¶çš„ç¬”è®°</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/779497dd.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2636df6a.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm11.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-03-16</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2636df6a.html&quot;);" href="javascript:void(0);" alt="">redisæ•°æ®åº“</a><div class="blog-slider__text">è¿™æ˜¯ä¸€ç¯‡å…³äºredisæ•°æ®åº“çš„ç¬”è®°</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2636df6a.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/b7e144d1.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm0.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/b7e144d1.html&quot;);" href="javascript:void(0);" alt="">ç®—æ³•</a><div class="blog-slider__text">æœ¬æ–‡ä¸»è¦è®°å½•leetcodeåˆ·é¢˜è®°å½•</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/b7e144d1.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/8de1ec.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm4.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/8de1ec.html&quot;);" href="javascript:void(0);" alt="">javaé¢ç»</a><div class="blog-slider__text">æœ¬æ–‡ä¸»è¦è®°å½•Javaé¢è¯•åŸºæœ¬å…«è‚¡æ–‡ï¼ŒåŒæ—¶ä¸ºäº†å·©å›ºjavaåŸºç¡€å’Œå¤ä¹ å­¦è¿‡çš„å†…å®¹</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/8de1ec.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/784bec6.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm15.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/784bec6.html&quot;);" href="javascript:void(0);" alt="">ajaxç¬”è®°</a><div class="blog-slider__text">æœ¬æ–‡ä¸»è¦è®°å½•äº†javaåŸºç¡€ä¸­ajaxæŠ€æœ¯çš„ä½¿ç”¨ä¸ç›¸å…³æŠ€æœ¯</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/784bec6.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/13fb5dc7.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm20.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/13fb5dc7.html&quot;);" href="javascript:void(0);" alt="">mysqlæ•°æ®åº“ç¬”è®°</a><div class="blog-slider__text">æœ¬æ–‡è®°å½•äº†mysqlçš„ä¸€äº›åŸºç¡€æ“ä½œå’Œå¸¸ç”¨çš„crudè¯­å¥çš„ä½¿ç”¨</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/13fb5dc7.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn-eys.pages.dev/img/dm6.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-08-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">Markdownè¯­æ³•ä¸å¤–æŒ‚æ ‡ç­¾å†™æ³•æ±‡æ€»</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡æ±‡æ€»Markdownæ ¼å¼ä»¥åŠå¤–æŒ‚æ ‡ç­¾åœ¨ç½‘é¡µç«¯çš„æ¸²æŸ“æ•ˆæœï¼Œå¯ä½œä¸ºæ–‡æ¡£è¿›è¡ŒæŸ¥è¯¢</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('å·²æŒ‚è½½gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><!-- hexo injector body_end end --></body></html>